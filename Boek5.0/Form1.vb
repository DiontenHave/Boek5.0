Imports System
Imports System.Data
Imports System.Data.Odbc
Imports C1.Win.C1FlexGrid
Imports C1.Win.C1FlexGrid.MultiColumnDictionary
Imports System.Threading
Imports System.Globalization

Imports System.Drawing.Imaging
Imports System.Drawing
Imports C1.C1Preview
Imports OfficeOpenXml
Imports System.IO

Public Class Form1

#Region "remarks"
    'collapse all   edit->outlining->toggle all outlining
    'comments on   Control K + U   en Control K + C
#End Region

#Region "Load and init form"

    'form load/main
    Private Sub Form1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        '
        'Dim separatorFormat As New System.Globalization.NumberFormatInfo()
        'If Globalization.NumberFormatInfo.CurrentInfo.NumberDecimalSeparator = "," Then
        ' Thread.CurrentThread.CurrentCulture = New CultureInfo("en-US")
        Thread.CurrentThread.CurrentCulture = New CultureInfo("nl-NL")
        ' separatorFormat.NumberDecimalSeparator = "."
        ' End If

        PanelKarindelingOnder.Enabled = False
        PanelKarindelingMidden.Enabled = False
        PanelKarIndelingBoven.Enabled = False
        '
        Tree_Datum_lbl.Text = Now.ToString("dddd, dd MMMM yyyy")
        C1NavPanelOrders2.Enabled = False
        'init form
        If My.Settings.LoginName1 = "" Then
            My.Settings.LoginName1 = "Demo"
        End If
        Me.LoginNaam1_but.Text = My.Settings.LoginName1
        Me.LoginNaam2_but.Text = My.Settings.LoginName2
        Me.LoginNaam3_but.Text = My.Settings.LoginName3
        Me.LoginNaam4_but.Text = My.Settings.LoginName4
        Me.LoginNaam5_but.Text = My.Settings.LoginName5
        Me.LoginNaam6_but.Text = My.Settings.LoginName6
        Me.LoginNaam7_but.Text = My.Settings.LoginName7
        Me.LoginNaam8_but.Text = My.Settings.LoginName8

        Me.Inst_Login1_v1_chk.Checked = My.Settings.Inlog1Vestiging1
        Me.Inst_Login2_v1_chk.Checked = My.Settings.Inlog2Vestiging1
        Me.Inst_Login3_v1_chk.Checked = My.Settings.Inlog3Vestiging1
        Me.Inst_Login4_v1_chk.Checked = My.Settings.Inlog4Vestiging1
        Me.Inst_Login5_v1_chk.Checked = My.Settings.Inlog5Vestiging1
        Me.Inst_Login6_v1_chk.Checked = My.Settings.Inlog6Vestiging1
        Me.Inst_Login7_v1_chk.Checked = My.Settings.Inlog7Vestiging1
        Me.Inst_Login8_v1_chk.Checked = My.Settings.Inlog8Vestiging1

        Me.Inst_Login1_v2_chk.Checked = My.Settings.Inlog1Vestiging2
        Me.Inst_Login2_v2_chk.Checked = My.Settings.Inlog2Vestiging2
        Me.Inst_Login3_v2_chk.Checked = My.Settings.Inlog3Vestiging2
        Me.Inst_Login4_v2_chk.Checked = My.Settings.Inlog4Vestiging2
        Me.Inst_Login5_v2_chk.Checked = My.Settings.Inlog5Vestiging2
        Me.Inst_Login6_v2_chk.Checked = My.Settings.Inlog6Vestiging2
        Me.Inst_Login7_v2_chk.Checked = My.Settings.Inlog7Vestiging2
        Me.Inst_Login8_v2_chk.Checked = My.Settings.Inlog8Vestiging2

        Me.Inst_Login1_T_chk.Checked = My.Settings.Inlog1VestigingTot
        Me.Inst_Login2_T_chk.Checked = My.Settings.Inlog2VestigingTot
        Me.Inst_Login3_T_chk.Checked = My.Settings.Inlog3VestigingTot
        Me.Inst_Login4_T_chk.Checked = My.Settings.Inlog4VestigingTot
        Me.Inst_Login5_T_chk.Checked = My.Settings.Inlog5VestigingTot
        Me.Inst_Login6_T_chk.Checked = My.Settings.Inlog6VestigingTot
        Me.Inst_Login7_T_chk.Checked = My.Settings.Inlog7VestigingTot
        Me.Inst_Login8_T_chk.Checked = My.Settings.Inlog8VestigingTot

        Me.Inst_printerip_txt.Text = My.Settings.labelprinterip
        Me.Inst_printerselect_chk.Checked = My.Settings.printselect
        Me.Inst_barcodeserver.Checked = My.Settings.BarCodeServer

        Me.Inst_MySQLServer_Txt.Text = My.Settings.MySQL_Server
        Me.Inst_MySQLUser_Txt.Text = My.Settings.MySQL_User
        Me.Inst_MySQLPass_Txt.Text = My.Settings.MySQL_Pass
        Me.Inst_MySQLODBC_Txt.Text = My.Settings.MySQL_ODBC
        Me.inst_database_boekjenp.Checked = My.Settings.testserver
        Me.inst_dfdkleinprint.Checked = My.Settings.dfdkleinprint

        'resize for adjusting variable month-calendars  xp/vista/windows7
        C1SizerMainWindow.Grid.Columns(1).Size = Order_MonthCalendar.Size.Width + 40
        Login_name = ""

        'start timers
        Timer_Activity.Start()


        'set tabs
        C1TabOrderInvoer.Enabled = True
        C1TabKarindeling.Enabled = True
        C1TabFloriday.Enabled = False
        C1TabFlorecom.Enabled = False
        C1TabVervoer.Enabled = False
        C1TabOverzichten.Enabled = False

        C1TabDatabase.Enabled = False
        C1TabInstellingen.Enabled = False
        C1TabVoorraad.Enabled = True
        C1TabPrijzen.Enabled = False
        C1TabInloggen.Enabled = True
        'C1Tab.SelectedTab = C1Tab.TabPages(8)
        SetTabPage("Inloggen")
        C1NavBar1.Enabled = False
        C1TabWPS.Enabled = False

        InlogAgendaDatum.Value = Now

        Database_reload_counter = 0
        Inst_weekdag_cmb.SelectedIndex = 0

        Tree_BBKlok_cmb.Tag = "system"
        Tree_BBKlok_cmb.SelectedIndex = 0
        Tree_BBKlok_cmb.Tag = ""
        '
        ' tabellen voor rijpheid,diameter,hoogte opstellen
        If dt_rijpheid.Columns.Count = 0 Then
            dt_rijpheid.Columns.Add("ID", GetType(String))
            dt_rijpheid.Columns.Add("desc", GetType(String))
        Else
            dt_rijpheid.Clear()
        End If
        dt_rijpheid.Rows.Add(New String() {Tstr(0), "N.V.T"})
        dt_rijpheid.Rows.Add(New String() {Tstr(11), "11"})
        dt_rijpheid.Rows.Add(New String() {Tstr(22), "22"})
        dt_rijpheid.Rows.Add(New String() {Tstr(33), "33"})
        dt_rijpheid.Rows.Add(New String() {Tstr(44), "44"})
        dt_rijpheid.Rows.Add(New String() {Tstr(55), "55"})

        dt_rijpheid.Rows.Add(New String() {Tstr(12), "12"})
        dt_rijpheid.Rows.Add(New String() {Tstr(23), "23"})
        dt_rijpheid.Rows.Add(New String() {Tstr(34), "34"})
        dt_rijpheid.Rows.Add(New String() {Tstr(45), "45"})

        dt_rijpheid.Rows.Add(New String() {Tstr(13), "13"})
        dt_rijpheid.Rows.Add(New String() {Tstr(14), "14"})
        dt_rijpheid.Rows.Add(New String() {Tstr(24), "24"})


        dt_rijpheid.Rows.Add(New String() {Tstr(1), "11"})
        dt_rijpheid.Rows.Add(New String() {Tstr(2), "22"})
        dt_rijpheid.Rows.Add(New String() {Tstr(3), "33"})
        dt_rijpheid.Rows.Add(New String() {Tstr(4), "44"})
        dt_rijpheid.Rows.Add(New String() {Tstr(5), "55"})
        '
        If dt_hoogte.Columns.Count = 0 Then
            dt_hoogte.Columns.Add("ID", GetType(String))
            dt_hoogte.Columns.Add("desc", GetType(String))
        Else
            dt_hoogte.Clear()
        End If
        dt_hoogte.Rows.Add(New String() {Tstr(0), "N.V.T."})
        dt_hoogte.Rows.Add(New String() {Tstr(15), "15"})
        dt_hoogte.Rows.Add(New String() {Tstr(17), "17"})
        dt_hoogte.Rows.Add(New String() {Tstr(20), "20"})
        dt_hoogte.Rows.Add(New String() {Tstr(22), "22"})
        dt_hoogte.Rows.Add(New String() {Tstr(25), "25"})
        dt_hoogte.Rows.Add(New String() {Tstr(27), "27"})
        dt_hoogte.Rows.Add(New String() {Tstr(30), "30"})
        dt_hoogte.Rows.Add(New String() {Tstr(32), "32"})
        dt_hoogte.Rows.Add(New String() {Tstr(35), "35"})
        dt_hoogte.Rows.Add(New String() {Tstr(40), "40"})
        dt_hoogte.Rows.Add(New String() {Tstr(45), "45"})

        '
        If dt_diameter.Columns.Count = 0 Then
            dt_diameter.Columns.Add("ID", GetType(String))
            dt_diameter.Columns.Add("desc", GetType(String))
        Else
            dt_diameter.Clear()
        End If
        dt_diameter.Rows.Add(New String() {Tstr(0), "N.V.T."})
        dt_diameter.Rows.Add(New String() {Tstr(1), "1"})
        dt_diameter.Rows.Add(New String() {Tstr(2), "2"})
        dt_diameter.Rows.Add(New String() {Tstr(3), "3"})
        dt_diameter.Rows.Add(New String() {Tstr(4), "4"})
        dt_diameter.Rows.Add(New String() {Tstr(15), "15"})
        dt_diameter.Rows.Add(New String() {Tstr(17), "17"})
        dt_diameter.Rows.Add(New String() {Tstr(20), "20"})
        dt_diameter.Rows.Add(New String() {Tstr(22), "22"})
        dt_diameter.Rows.Add(New String() {Tstr(25), "25"})
        dt_diameter.Rows.Add(New String() {Tstr(30), "30"})
        dt_diameter.Rows.Add(New String() {Tstr(35), "35"})


        If dt_kwaliteit.Columns.Count = 0 Then
            dt_kwaliteit.Columns.Add("ID", GetType(String))
            dt_kwaliteit.Columns.Add("desc", GetType(String))
        Else
            dt_kwaliteit.Clear()
        End If
        dt_kwaliteit.Rows.Add(New String() {Tstr(1), "A1"})
        dt_kwaliteit.Rows.Add(New String() {Tstr(2), "A2"})
        dt_kwaliteit.Rows.Add(New String() {Tstr(3), "B"})

        If dt_schermen.Columns.Count = 0 Then
            dt_schermen.Columns.Add("ID", GetType(String))
            dt_schermen.Columns.Add("desc", GetType(String))
        Else
            dt_schermen.Clear()
        End If
        dt_schermen.Rows.Add(New String() {Tstr(0), "N.V.T."})
        dt_schermen.Rows.Add(New String() {Tstr(1), "1"})
        dt_schermen.Rows.Add(New String() {Tstr(2), "2"})
        dt_schermen.Rows.Add(New String() {Tstr(3), "3"})
        dt_schermen.Rows.Add(New String() {Tstr(4), "4"})


        If TestSQL() = True Then
            Me.Cursor = Cursors.WaitCursor

            FormProgressBar.StartPosition = FormStartPosition.CenterScreen
            FormProgressBar.Show()

            SetupDatabase()

            Load_Database_fotoFilters()

            ShowAgenda(Now)
            FormProgressBar.DataProgressBar.Value = 5
            Load_Database_kopers()

            FormProgressBar.DataProgressBar.Value = 10

            'load fust,karren etc from database 
            Load_Database_fusten()
            FormProgressBar.DataProgressBar.Value = 15

            Load_Database_karren()
            FormProgressBar.DataProgressBar.Value = 20

            Load_Database_orderinfo()
            FormProgressBar.DataProgressBar.Value = 25

            Load_Database_vervoerder()
            FormProgressBar.DataProgressBar.Value = 30

            Load_Database_soorten()
            FormProgressBar.DataProgressBar.Value = 35

            Load_Database_accessoires()
            FormProgressBar.DataProgressBar.Value = 40

            Load_Database_mixen()
            FormProgressBar.DataProgressBar.Value = 45

            Load_Database_prijzen()
            Load_Database_soortvolgorde()
            FormProgressBar.DataProgressBar.Value = 50

            Load_Database_klantgroepen()
            FormProgressBar.DataProgressBar.Value = 65

            Load_Database_keurcodes()
            FormProgressBar.DataProgressBar.Value = 70

            Load_Florecom_Data()
            FormProgressBar.DataProgressBar.Value = 70

            Load_Database_WpsFilters()
            FormProgressBar.DataProgressBar.Value = 75

            Create_SoortMixTable()

            FormProgressBar.DataProgressBar.Value = 80

            Load_Database_lijsten()

            Load_Database_TradeItems()

            FormProgressBar.DataProgressBar.Value = 85
            'Setup_Karindeling()
            ' Show boek
            Set_BoekInstellingen(1, 1, 6)
            Update_Boek()
            FormProgressBar.DataProgressBar.Value = 90
            Setup_Order_Grid()
            FormProgressBar.Close()

            Me.Cursor = Cursors.Default


            'save and remove opmerking tabs kopers
            For i = 0 To 7
                kopertab(i) = Order_OpmTab.TabPages(3 + i)
            Next i
            For j = 0 To 8  '10 scans
                For i = 0 To Order_OpmTab.TabPages.Count - 1   'remove koper tab
                    If Order_OpmTab.TabPages(i).Tag = "koper" Then
                        Order_OpmTab.TabPages.RemoveAt(i)
                        Exit For
                    End If
                Next i
            Next j

            icon1_pbox.Image = IconList.Images.Item(30)
            icon2_pbox.Image = IconList.Images.Item(11)
            icon3_pbox.Image = IconList.Images.Item(13)
            icon4_pbox.Image = IconList.Images.Item(18)


            icon1_chk.Tag = "System"
            icon2_chk.Tag = "System"
            icon3_chk.Tag = "System"
            icon4_chk.Tag = "System"

            icon1_chk.Checked = True
            icon2_chk.Checked = True
            icon3_chk.Checked = True
            icon4_chk.Checked = True

        End If
    End Sub
    Private Sub SetupDatabase()

        If dt_db_tables.Columns.Count = 0 Then
            dt_db_tables.Columns.Add("ID", GetType(String))
            dt_db_tables.Columns.Add("desc", GetType(String))
            dt_db_tables.Columns.Add("type", GetType(Integer))
        Else
            dt_db_tables.Clear()
        End If

        dt_db_tables.Rows.Add(New String() {"0", "N.V.T.", 0})

        Try

            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM db_dt_tables ORDER BY label", Conn)
                Dim Reader As OdbcDataReader = Cmd.ExecuteReader()
                Do While Reader.Read
                    Dim id As Integer = CHint(Reader("id"))
                    Dim label As String = CHstr(Reader("label"))
                    Dim type As Integer = CHint(Reader("oldtypedatabase"))
                    dt_db_tables.Rows.Add(New String() {Trim(Str(id)), label, type})
                Loop
                Reader.Close()
                Conn.Close()
            End Using
        Catch ex As Exception
            MessageBox.Show("Database fout: laad datatabel: database -> " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        LoadCombo(Database_Combo, dt_db_tables, False)

        'add editcolor to style 
        Dim stylefound As Boolean = False
        For i = 0 To DatabaseFlexGridShow.Styles.Count - 1
            If DatabaseFlexGridShow.Styles.Item(i).Name = "EDIT" Then
                stylefound = True
                Exit For
            End If
        Next
        If stylefound = False Then
            Dim rs As C1.Win.C1FlexGrid.CellStyle
            rs = DatabaseFlexGridShow.Styles.Add("EDIT")
            rs.BackColor = Color.LightBlue
            Dim rs2 As C1.Win.C1FlexGrid.CellStyle
            rs2 = DatabaseFlexGridShow.Styles.Add("WHITE")
            rs2.BackColor = Color.White
            Dim rs3 As C1.Win.C1FlexGrid.CellStyle
            rs3 = DatabaseFlexGridShow.Styles.Add("TOTAL")
            rs3.BackColor = Color.Beige
            Dim rs4 As C1.Win.C1FlexGrid.CellStyle
            rs4 = DatabaseFlexGridShow.Styles.Add("RED")
            rs4.BackColor = Color.LightCoral
        End If


    End Sub
    Private Function GetMaximumColumnSize(tablename As String, columnname As String) As Integer
        Dim maxvalue As Integer = 0
        Dim infodriver As String = "Driver={" + My.Settings.MySQL_ODBC + "};"
        infodriver = infodriver + "Server=" + My.Settings.MySQL_Server + ";"
        infodriver = infodriver + "Database=information_schema;"
        infodriver = infodriver + "User=" + My.Settings.MySQL_User + ";"
        infodriver = infodriver + "Password=" + My.Settings.MySQL_Pass + ";"
        Try
            Using Conn As New OdbcConnection(infodriver)
                Conn.Open()
                Dim query As String = "SELECT CHARACTER_MAXIMUM_LENGTH FROM COLUMNS WHERE TABLE_SCHEMA = 'boek' AND TABLE_NAME = '" + tablename + "' AND COLUMN_NAME ='" + columnname + "'"
                Dim Cmd6 As New OdbcCommand(query, Conn)
                maxvalue = Convert.ToInt32(Cmd6.ExecuteScalar())
            End Using
        Catch ex As Exception
        End Try

        Return maxvalue
    End Function
    Private Sub SetTabPage(pagetitle As String)
        For i = 0 To C1Tab.TabCount - 1
            If C1Tab.TabPages(i).Text = Trim(pagetitle) Then
                C1Tab.SelectedTab = C1Tab.TabPages(i)
            End If
        Next
    End Sub
    Private Function TestSQL() As Boolean


        'Driver={PostgreSQL ANSI};Server=localhost;Port=5432;Database=decorum;Uid=decorum;Pwd=deco5000;


        My.Settings.MySQL_Server = Me.Inst_MySQLServer_Txt.Text
        My.Settings.MySQL_User = Me.Inst_MySQLUser_Txt.Text
        My.Settings.MySQL_Pass = Me.Inst_MySQLPass_Txt.Text
        My.Settings.MySQL_ODBC = Me.Inst_MySQLODBC_Txt.Text
        My.Settings.Save()

        'My.Settings.MySQL_Server = "localhost"
        'My.Settings.MySQL_User = "watergever"
        'My.Settings.MySQL_Pass = "water"
        'My.Settings.MySQL_ODBC = "MySQL ODBC 5.1 Driver"


        'MySQL
        ConnString = "Driver={" + My.Settings.MySQL_ODBC + "};"
        ConnString = ConnString + "Server=" + My.Settings.MySQL_Server + ";"
        If inst_database_boekjenp.Checked = True Then
            ConnString = ConnString + "Database=boekjenp;"
        Else
            ConnString = ConnString + "Database=boek;"
        End If
        ConnString = ConnString + "User=" + My.Settings.MySQL_User + ";"
        ConnString = ConnString + "Password=" + My.Settings.MySQL_Pass + ";"

        If postgress = True Then
            'Driver={PostgreSQL ANSI};Server=localhost;Port=5432;Database=decorum;Uid=decorum;Pwd=deco5000;
            My.Settings.MySQL_Server = "localhost"
            My.Settings.MySQL_User = "postgres"
            My.Settings.MySQL_Pass = "jahoor9580"
            My.Settings.MySQL_ODBC = "PostgreSQL ANSI"

            ConnString = "Driver={" + My.Settings.MySQL_ODBC + "};"
            ConnString = ConnString + "Server=" + My.Settings.MySQL_Server + ";Port=5432;"
            ConnString = ConnString + "Database=boek;"
            ConnString = ConnString + "Uid=" + My.Settings.MySQL_User + ";"
            ConnString = ConnString + "Pwd=" + My.Settings.MySQL_Pass + ";"
        End If


        ' Test sql connection, if connected exit sub, else enter setup page 


        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM veiling", Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    TestSQL = True
                    SQLRUN = True
                    'C1Tab.SelectedTab = C1Tab.TabPages(10)
                    SetTabPage("Inloggen")
                    Return True
                End If

            End Using
        Catch ex As Exception
            'ErrorLog("Database niet gevonden")
            MessageBox.Show("Database niet gevonden", "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            'set tabs
            C1TabOrderInvoer.Enabled = False
            C1TabKarindeling.Enabled = False
            C1TabFlorecom.Enabled = False
            C1TabVervoer.Enabled = False
            C1TabOverzichten.Enabled = False
            C1TabDatabase.Enabled = False
            C1TabInstellingen.Enabled = True
            C1TabVoorraad.Enabled = False
            C1TabPrijzen.Enabled = False
            C1TabInloggen.Enabled = True
            'C1Tab.SelectedTab = C1Tab.TabPages(6)
            SetTabPage("Instellingen")
            C1NavBar1.Enabled = True
        End Try
        TestSQL = False
        Return False
    End Function
    Private Sub C1NavBar1_ButtonClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles C1NavBar1.ButtonClick

        If Login_name = "" Then Exit Sub

        Application.DoEvents()

        Check_Database_reload()

        Select Case Me.C1NavBar1.SelectedButtonIndex
            Case 0
                C1TabOrderInvoer.Enabled = True
                C1TabKarindeling.Enabled = True
                C1TabFloriday.Enabled = False
                C1TabFlorecom.Enabled = False
                C1TabVervoer.Enabled = True
                C1TabOverzichten.Enabled = True
                C1TabInloggen.Enabled = True
                C1TabDatabase.Enabled = False
                C1TabInstellingen.Enabled = False
                C1TabVoorraad.Enabled = True
                C1TabPrijzen.Enabled = False
                C1TabWPS.Enabled = True
                'C1Tab.SelectedTab = C1Tab.TabPages(0)
                SetTabPage("Order invoer")

            Case 1
                C1TabOrderInvoer.Enabled = False
                C1TabKarindeling.Enabled = True
                C1TabFloriday.Enabled = True
                C1TabFlorecom.Enabled = False
                C1TabVervoer.Enabled = False
                C1TabOverzichten.Enabled = False
                C1TabInloggen.Enabled = False
                C1TabDatabase.Enabled = False
                C1TabInstellingen.Enabled = False
                C1TabVoorraad.Enabled = False
                C1TabPrijzen.Enabled = False
                C1TabWPS.Enabled = False
                SetupFloridayGrid()
                Floriday_Calendar.SelectionStart = Now.Date
                Floriday_Calendar.SelectionEnd = Now.Date
                Fd_nieuweOrders_rb.Checked = True
                FloridayOrdersShow()


            Case 2
                C1TabOrderInvoer.Enabled = False
                C1TabKarindeling.Enabled = True
                C1TabFloriday.Enabled = False
                C1TabFlorecom.Enabled = True
                C1TabVervoer.Enabled = False
                C1TabOverzichten.Enabled = True
                C1TabInloggen.Enabled = False
                C1TabDatabase.Enabled = False
                C1TabInstellingen.Enabled = False
                C1TabVoorraad.Enabled = False
                C1TabPrijzen.Enabled = False
                C1TabWPS.Enabled = False
                Setup_Florecom_Grid()
                'C1Tab.SelectedTab = C1Tab.TabPages(2)
                SetTabPage("Florecom")

            Case 3
                C1TabOrderInvoer.Enabled = False
                C1TabKarindeling.Enabled = False
                C1TabFloriday.Enabled = False
                C1TabFlorecom.Enabled = False
                C1TabVervoer.Enabled = False
                C1TabOverzichten.Enabled = False
                C1TabDatabase.Enabled = True
                C1TabInloggen.Enabled = False
                C1TabInstellingen.Enabled = False
                C1TabVoorraad.Enabled = False
                C1TabPrijzen.Enabled = False
                C1TabWPS.Enabled = False
                'C1Tab.SelectedTab = C1Tab.TabPages(5)
                SetTabPage("Database")
            Case 4
                C1TabOrderInvoer.Enabled = False
                C1TabKarindeling.Enabled = False
                C1TabFloriday.Enabled = False
                C1TabFlorecom.Enabled = False
                C1TabVervoer.Enabled = False
                C1TabOverzichten.Enabled = False
                C1TabDatabase.Enabled = False
                C1TabInloggen.Enabled = False
                C1TabInstellingen.Enabled = True
                C1TabVoorraad.Enabled = False
                C1TabPrijzen.Enabled = False
                C1TabWPS.Enabled = False

                Me.Inst_Login1_Txt.Text = My.Settings.LoginName1
                Me.Inst_Login2_Txt.Text = My.Settings.LoginName2
                Me.Inst_Login3_Txt.Text = My.Settings.LoginName3
                Me.Inst_Login4_Txt.Text = My.Settings.LoginName4
                Me.Inst_Login5_Txt.Text = My.Settings.LoginName5
                Me.Inst_Login6_Txt.Text = My.Settings.LoginName6
                Me.Inst_Login7_Txt.Text = My.Settings.LoginName7
                Me.Inst_Login8_Txt.Text = My.Settings.LoginName8
                Me.Inst_Login1_v2_chk.Checked = My.Settings.Inlog1Vestiging2
                Me.Inst_Login2_v2_chk.Checked = My.Settings.Inlog2Vestiging2
                Me.Inst_Login3_v2_chk.Checked = My.Settings.Inlog3Vestiging2
                Me.Inst_Login4_v2_chk.Checked = My.Settings.Inlog4Vestiging2
                Me.Inst_Login5_v2_chk.Checked = My.Settings.Inlog5Vestiging2
                Me.Inst_Login6_v2_chk.Checked = My.Settings.Inlog6Vestiging2
                Me.Inst_Login7_v2_chk.Checked = My.Settings.Inlog7Vestiging2
                Me.Inst_Login8_v2_chk.Checked = My.Settings.Inlog8Vestiging2

                Me.Inst_Login1_T_chk.Checked = My.Settings.Inlog1VestigingTot
                Me.Inst_Login2_T_chk.Checked = My.Settings.Inlog2VestigingTot
                Me.Inst_Login3_T_chk.Checked = My.Settings.Inlog3VestigingTot
                Me.Inst_Login4_T_chk.Checked = My.Settings.Inlog4VestigingTot
                Me.Inst_Login5_T_chk.Checked = My.Settings.Inlog5VestigingTot
                Me.Inst_Login6_T_chk.Checked = My.Settings.Inlog6VestigingTot
                Me.Inst_Login7_T_chk.Checked = My.Settings.Inlog7VestigingTot
                Me.Inst_Login8_T_chk.Checked = My.Settings.Inlog8VestigingTot


                Me.Inst_MySQLServer_Txt.Text = My.Settings.MySQL_Server
                Me.Inst_MySQLUser_Txt.Text = My.Settings.MySQL_User
                Me.Inst_MySQLPass_Txt.Text = My.Settings.MySQL_Pass
                Me.Inst_MySQLODBC_Txt.Text = My.Settings.MySQL_ODBC


                SetTabPage("Instellingen")

            Case 5
                C1TabOrderInvoer.Enabled = False
                C1TabKarindeling.Enabled = False
                C1TabFloriday.Enabled = False
                C1TabFlorecom.Enabled = False
                C1TabVervoer.Enabled = False
                C1TabOverzichten.Enabled = False
                C1TabDatabase.Enabled = False
                C1TabInloggen.Enabled = True
                C1TabInstellingen.Enabled = False
                C1TabVoorraad.Enabled = False
                C1TabPrijzen.Enabled = True
                C1TabWPS.Enabled = False
                'C1Tab.SelectedTab = C1Tab.TabPages(7)
                SetTabPage("Prijzen")


                SetupPrijzenGrid()
                Load_prijzen_lijst()

        End Select

    End Sub
    Private Sub SetupPrijzenGrid()
        C1TabOrderInvoer.Enabled = False
        C1TabKarindeling.Enabled = False
        C1TabFloriday.Enabled = False
        C1TabFlorecom.Enabled = False
        C1TabVervoer.Enabled = False
        C1TabOverzichten.Enabled = False
        C1TabDatabase.Enabled = False
        C1TabInloggen.Enabled = False
        C1TabInstellingen.Enabled = False
        C1TabPrijzen.Enabled = True
        C1TabVoorraad.Enabled = False
        C1TabWPS.Enabled = False
        'C1Tab.SelectedTab = C1Tab.TabPages(7)
        SetTabPage("Prijzen")

        prijzen_koper_combo.AutoCompleteMode = AutoCompleteMode.SuggestAppend
        prijzen_koper_combo.AutoCompleteSource = AutoCompleteSource.CustomSource
        ' prijzen_koper_combo.Sorted = True
        prijzen_koper_combo.DataSource = dt_kopers
        prijzen_koper_combo.DisplayMember = "desc"
        prijzen_koper_combo.ValueMember = "ID"
        prijzen_koper_combo.DropDownStyle = ComboBoxStyle.DropDown
        prijzen_koper_combo.MaxDropDownItems = 12

        prijzen_kopergroep_combo.DataSource = dt_kopersgroepen
        prijzen_kopergroep_combo.DisplayMember = "desc"
        prijzen_kopergroep_combo.ValueMember = "ID"
        prijzen_kopergroep_combo.DropDownStyle = ComboBoxStyle.DropDownList
        prijzen_kopergroep_combo.MaxDropDownItems = 12

        'prijzen_type_cb.DataSource = dtt_prijsactie
        'prijzen_type_cb.DisplayMember = "desc"
        'prijzen_type_cb.ValueMember = "ID"
        'prijzen_type_cb.DropDownStyle = ComboBoxStyle.DropDownList
        'prijzen_type_cb.MaxDropDownItems = 12

        prijzen_soort_combo.DataSource = dt_soortmixprijzen
        prijzen_soort_combo.DisplayMember = "desc"
        prijzen_soort_combo.ValueMember = "ID"
        prijzen_soort_combo.DropDownStyle = ComboBoxStyle.DropDownList
        prijzen_soort_combo.MaxDropDownItems = 12

        prijzen_jaar_updown.Value = Year(Now)
    End Sub
    Private Sub Load_Database_TradeItems()

        ' initialize datastructure for dropdown menu's fusten
        If dt_tradeitem.Columns.Count = 0 Then
            dt_tradeitem.Columns.Add("ID", GetType(String))
            dt_tradeitem.Columns.Add("desc", GetType(String))
        Else
            dt_tradeitem.Clear()
        End If

        If dt_tradeitemklok.Columns.Count = 0 Then
            dt_tradeitemklok.Columns.Add("ID", GetType(String))
            dt_tradeitemklok.Columns.Add("desc", GetType(String))
        Else
            dt_tradeitemklok.Clear()
        End If


        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM floriday_tradeitem WHERE length(parentId)<1 AND isDeleted=0 ORDER BY tradeItemName_nl", Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read
                    Dim naam As String = CHstr(Reader("tradeItemName_nl"))
                    Dim id As Integer = CHint(Reader("id"))
                    dt_tradeitem.Rows.Add(New String() {Tstr(id), naam})
                Loop
                Reader.Close()

                'Execute Query
                Dim Cmd2 As New OdbcCommand("SELECT * FROM floriday_tradeitem as ft LEFT JOIN floriday_tradeitem_boek as tb ON ft.tradeItemId=tb.tradeItemId WHERE klok=1 AND length(parentId)<1 AND isDeleted=0 ORDER BY tradeItemName_nl", Conn)
                Dim Reader2 As OdbcDataReader
                Reader2 = Cmd2.ExecuteReader()
                Do While Reader2.Read
                    Dim naam As String = CHstr(Reader2("tradeItemName_nl"))
                    Dim id As Integer = CHint(Reader2("id"))
                    dt_tradeitemklok.Rows.Add(New String() {Tstr(id), naam})
                Loop
                Reader.Close()




            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (tradeitems)" + ex.Message)
            MessageBox.Show("Database fout: (tradeitems)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try





    End Sub
    Private Sub Load_Database_WpsFilters()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("wps_filters")
        ReDim wpsfilter(count + 1)
        Dim CmdString = "SELECT * FROM wps_filters ORDER BY filternummer"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        wpsfilter(i).filternummer = CHint(Reader("filternummer"))
                        wpsfilter(i).filternaam = CHstr(Reader("filternaam"))
                        wpsfilter(i).wps_soortnummer = CHint(Reader("wps_soortnummer"))
                        wpsfilter(i).potmaat = CHint(Reader("potmaat"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (wps filters)" + ex.Message)
            MessageBox.Show("Database fout: (wps filters)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Load_Database_fusten()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("fusten2")
        ReDim fust(count + 1)
        Dim CmdString = "SELECT * FROM fusten2 ORDER BY volgorde ASC"

        ' initialize datastructure for dropdown menu's fusten
        If dt_fust.Columns.Count = 0 Then
            dt_fust.Columns.Add("ID", GetType(String))
            dt_fust.Columns.Add("desc", GetType(String))
        Else
            dt_fust.Clear()
        End If
        If dtt_fust.Columns.Count = 0 Then
            dtt_fust.Columns.Add("ID", GetType(String))
            dtt_fust.Columns.Add("desc", GetType(String))
        Else
            dtt_fust.Clear()
        End If

        'voor accessoires een tabel met id 0 = "-"
        If dt_fusta.Columns.Count = 0 Then
            dt_fusta.Columns.Add("ID", GetType(String))
            dt_fusta.Columns.Add("desc", GetType(String))
        Else
            dt_fusta.Clear()
        End If
        dt_fusta.Rows.Add(New String() {Tstr(0), "-"})

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()

                        fust(i).fustnaam = CHstr(Reader("fustnaam"))
                        fust(i).fustcode = CHstr(Reader("fustcode"))
                        fust(i).plaats_string = CHstr(Reader("plaats_string"))
                        fust(i).decorum = CHbool(Reader("decorum"))
                        fust(i).aantal_per_fust = CHint(Reader("aantal_per_fust"))
                        fust(i).fustcode_florecom = CHint(Reader("fustcode_florecom"))
                        fust(i).fustcode_wps = CHint(Reader("fustcode_wps"))
                        fust(i).fustcode_sdf = CHint(Reader("fustcode_sdf"))
                        fust(i).fpl_deen = CHint(Reader("fpl_deen"))
                        fust(i).fpl_veilingkar = CHint(Reader("fpl_veilingkar"))
                        fust(i).fpl_overig = CHint(Reader("fpl_overig"))
                        fust(i).fpl_reserve1 = CHint(Reader("fpl_reserve1"))
                        fust(i).fpl_reserve2 = CHint(Reader("fpl_reserve2"))
                        fust(i).kleur = CHstr(Reader("kleur"))
                        fust(i).id = CHint(Reader("id"))
                        fust(i).actief = CHbool(Reader("actief"))
                        'fill datatable combos
                        dtt_fust.Rows.Add(New String() {Tstr(fust(i).id), fust(i).fustnaam})
                        If fust(i).actief = True Then
                            dt_fust.Rows.Add(New String() {Tstr(fust(i).id), fust(i).fustnaam})
                            dt_fusta.Rows.Add(New String() {Tstr(fust(i).id), fust(i).fustnaam})
                        End If
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (fusten)" + ex.Message)
            MessageBox.Show("Database fout: (fusten)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Public Function Tstr(ByVal i As Integer) As String
        Dim ret As String = Trim(Str(i))
        Return ret
    End Function
    Private Sub Load_Database_orderinfo()
        Dim i As Integer
        Dim count As Integer
        Dim query As String = ""

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd As New OdbcCommand(query, Conn)
                Dim Reader As OdbcDataReader

                ' initialize datastructure for dropdown menu's brieven
                count = GetRowCount("brieven")
                ReDim brief(count + 1)
                If dt_brief.Columns.Count = 0 Then
                    dt_brief.Columns.Add("ID", GetType(String))
                    dt_brief.Columns.Add("desc", GetType(String))
                Else
                    dt_brief.Clear()
                End If
                If dtt_brief.Columns.Count = 0 Then
                    dtt_brief.Columns.Add("ID", GetType(String))
                    dtt_brief.Columns.Add("desc", GetType(String))
                Else
                    dtt_brief.Clear()
                End If
                'Execute Query
                query = "SELECT * FROM brieven"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        brief(i).id = CHint(Reader("id"))
                        brief(i).naam = CHstr(Reader("naam"))
                        brief(i).actief = CHbool(Reader("aktief"))
                        'fill datatable combos
                        dtt_brief.Rows.Add(New String() {Tstr(brief(i).id), brief(i).naam})
                        If brief(i).actief = True Then
                            dt_brief.Rows.Add(New String() {Tstr(brief(i).id), brief(i).naam})
                        End If
                    Next i
                End If
                Reader.Close()

                ' initialize datastructure for dropdown menu's veilingen
                count = GetRowCount("veiling")
                ReDim veiling(count + 1)
                If dt_veilingen.Columns.Count = 0 Then
                    dt_veilingen.Columns.Add("ID", GetType(String))
                    dt_veilingen.Columns.Add("desc", GetType(String))
                Else
                    dt_veilingen.Clear()
                End If
                'Execute Query
                query = "SELECT * FROM veiling"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count

                        Reader.Read()
                        veiling(i).id = CHint(Reader("id"))
                        veiling(i).naam = CHstr(Reader("veilingnaam"))
                        'fill datatable combos
                        dt_veilingen.Rows.Add(New String() {Tstr(veiling(i).id), veiling(i).naam})
                    Next i
                End If
                Reader.Close()


                ' initialize datastructure for dropdown menu's afleverlocaties

                count = GetRowCount("afleverlocaties")
                ReDim afleverloc(count + 1)

                If dt_afleverloc.Columns.Count = 0 Then
                    dt_afleverloc.Columns.Add("ID", GetType(String))
                    dt_afleverloc.Columns.Add("desc", GetType(String))
                Else
                    dt_afleverloc.Clear()
                End If
                If dtt_afleverloc.Columns.Count = 0 Then
                    dtt_afleverloc.Columns.Add("ID", GetType(String))
                    dtt_afleverloc.Columns.Add("desc", GetType(String))
                Else
                    dtt_afleverloc.Clear()
                End If
                If dtt_vervoerderloc.Columns.Count = 0 Then
                    dtt_vervoerderloc.Columns.Add("ID", GetType(String))
                    dtt_vervoerderloc.Columns.Add("desc", GetType(String))
                Else
                    dtt_vervoerderloc.Clear()
                End If
                'Execute Query
                query = "SELECT * FROM afleverlocaties"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        afleverloc(i).id = CHint(Reader("id"))
                        afleverloc(i).naam = CHstr(Reader("naam"))
                        afleverloc(i).actief = CHbool(Reader("aktief"))
                        afleverloc(i).ean = CHstr(Reader("ean"))
                        afleverloc(i).vervoer = CHstr(Reader("vervoer"))

                        'fill datatable combos
                        dtt_afleverloc.Rows.Add(New String() {Tstr(afleverloc(i).id), afleverloc(i).naam})
                        dtt_vervoerderloc.Rows.Add(New String() {Tstr(afleverloc(i).id), afleverloc(i).vervoer})
                        If afleverloc(i).actief = True Then
                            dt_afleverloc.Rows.Add(New String() {Tstr(afleverloc(i).id), afleverloc(i).naam})
                        End If
                    Next i
                End If
                Reader.Close()



                ' initialize datastructure for dropdown menu's GP

                If dtt_gp.Columns.Count = 0 Then
                    dtt_gp.Columns.Add("ID", GetType(String))
                    dtt_gp.Columns.Add("desc", GetType(String))
                Else
                    dtt_gp.Clear()
                End If

                'dtt_gp.Rows.Add(New String() {"0", "DV"})
                For i = 1 To 40
                    dtt_gp.Rows.Add(New String() {Tstr(i), Str(i)})
                Next


                query = "select * from instellingen"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    MailHost = CHstr(Reader("SmtpHost"))
                    MailRecipient = CHstr(Reader("Recipient"))
                    ExternalMailHost = CHstr(Reader("ExternalSmtpHost"))
                    onze_ean = CHstr(Reader("ean_tuinder"))
                End If
                Reader.Close()



                ' initialize datastructure for dropdown menu's prijzenacties

                If dtt_prijsactie.Columns.Count = 0 Then
                    dtt_prijsactie.Columns.Add("ID", GetType(String))
                    dtt_prijsactie.Columns.Add("desc", GetType(String))
                Else
                    dtt_prijsactie.Clear()
                End If
                query = "select id,actienummer from prijzen where actienummer<>''"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader
                Do While Reader.Read
                    Dim id As Integer = CHint(Reader("id"))
                    Dim actienummer As String = CHstr(Reader("actienummer"))
                    If Len(Trim(actienummer)) > 0 Then
                        dtt_prijsactie.Rows.Add(New String() {Tstr(id), actienummer})
                    End If
                Loop
                Reader.Close()


                '
                'Friend dt_floridayveiling As New DataTable
                If dt_floridayveiling.Columns.Count = 0 Then
                    dt_floridayveiling.Columns.Add("ID", GetType(String))
                    dt_floridayveiling.Columns.Add("desc", GetType(String))
                Else
                    dt_floridayveiling.Clear()
                End If
                query = "select * from floriday_warehouses_services AS fws LEFT JOIN floriday_warehouses AS fw ON fws.parent_id=fw.id WHERE value='AUCTION'"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader
                Do While Reader.Read
                    Dim id As String = CHstr(Reader("warehouseId"))
                    Dim naam As String = CHstr(Reader("name"))
                    dt_floridayveiling.Rows.Add(New String() {id, naam})
                Loop
                Reader.Close()

                'Friend dt_floridaywarehouses As New DataTable
                If dt_floridaywarehouses.Columns.Count = 0 Then
                    dt_floridaywarehouses.Columns.Add("ID", GetType(String))
                    dt_floridaywarehouses.Columns.Add("desc", GetType(String))
                Else
                    dt_floridaywarehouses.Clear()
                End If
                query = "select * from floriday_warehouses"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader
                Do While Reader.Read
                    Dim id As String = CHstr(Reader("warehouseId"))
                    Dim naam As String = CHstr(Reader("name"))
                    dt_floridaywarehouses.Rows.Add(New String() {id, naam})
                Loop
                Reader.Close()




                'Friend dt_soortgroepveilgroep As New DataTable
                If dt_soortgroepveilgroep.Columns.Count = 0 Then
                    dt_soortgroepveilgroep.Columns.Add("ID", GetType(String))
                    dt_soortgroepveilgroep.Columns.Add("desc", GetType(String))
                Else
                    dt_soortgroepveilgroep.Clear()
                End If
                query = "select * from soortgroepen WHERE veilgroep=1"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader
                Do While Reader.Read
                    Dim id As Integer = CHint(Reader("id"))
                    Dim naam As String = CHstr(Reader("groepnaam"))
                    dt_soortgroepveilgroep.Rows.Add(New String() {Tstr(id), naam})
                Loop
                Reader.Close()


            End Using
        Catch ex As Exception
            ErrorLog("Database actie_type " + query + " " + ex.Message)
            MessageBox.Show("Database fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        LoadDataTable(dt_labelstatus, "label_status", "labelstatus", False)



    End Sub
    Private Sub Load_Database_karren()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("karren")
        ReDim kar(count + 1)
        Dim CmdString As String = "SELECT * FROM karren ORDER BY volgorde ASC"

        ' initialize datastructure for dropdown menu's 
        If dt_kar.Columns.Count = 0 Then
            dt_kar.Columns.Add("ID", GetType(String))
            dt_kar.Columns.Add("desc", GetType(String))
        Else
            dt_kar.Clear()
        End If
        If dtt_kar.Columns.Count = 0 Then
            dtt_kar.Columns.Add("ID", GetType(String))
            dtt_kar.Columns.Add("desc", GetType(String))
        Else
            dtt_kar.Clear()
        End If
        If dtt_karvervoer.Columns.Count = 0 Then
            dtt_karvervoer.Columns.Add("ID", GetType(String))
            dtt_karvervoer.Columns.Add("desc", GetType(String))
        Else
            dtt_karvervoer.Clear()
        End If


        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        kar(i).id = CHint(Reader("id"))
                        kar(i).karnaam = CHstr(Reader("karnaam"))
                        kar(i).aantal_lagen = CHint(Reader("aantal_lagen"))
                        kar(i).fust_per_laag_code = CHint(Reader("fust_per_laag_code"))
                        kar(i).vervoer = CHstr(Reader("vervoer"))
                        kar(i).actief = CHbool(Reader("actief"))
                        'fill datatable combos
                        dtt_kar.Rows.Add(New String() {Tstr(kar(i).id), kar(i).karnaam})
                        dtt_karvervoer.Rows.Add(New String() {Tstr(kar(i).id), kar(i).vervoer})
                        If kar(i).actief = True Then
                            dt_kar.Rows.Add(New String() {Tstr(kar(i).id), kar(i).karnaam})
                        End If
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (karren)" + ex.Message)
            MessageBox.Show("Database fout: (karren)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub Load_Database_vervoerder()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("vervoerders2")
        ReDim vervoerder(count + 1)
        Dim CmdString As String = "SELECT * FROM vervoerders2"

        ' initialize datastructure for dropdown menu's
        If dt_vervoerder.Columns.Count = 0 Then
            dt_vervoerder.Columns.Add("ID", GetType(String))
            dt_vervoerder.Columns.Add("desc", GetType(String))
        Else
            dt_vervoerder.Clear()
        End If
        If dtt_vervoerder.Columns.Count = 0 Then
            dtt_vervoerder.Columns.Add("ID", GetType(String))
            dtt_vervoerder.Columns.Add("desc", GetType(String))
        Else
            dtt_vervoerder.Clear()
        End If

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        vervoerder(i).id = CHint(Reader("id"))
                        vervoerder(i).vervoerder_naam = CStr(Reader("vervoerder_naam"))
                        vervoerder(i).EAN = CHstr(Reader("EAN"))
                        vervoerder(i).actief = CHbool(Reader("actief"))
                        vervoerder(i).email = CHstr(Reader("email"))
                        'fill datatable combos
                        dtt_vervoerder.Rows.Add(New String() {Tstr(vervoerder(i).id), vervoerder(i).vervoerder_naam})
                        If vervoerder(i).actief = True Then
                            dt_vervoerder.Rows.Add(New String() {Tstr(vervoerder(i).id), vervoerder(i).vervoerder_naam})
                        End If
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (vervoerder)" + ex.Message)
            MessageBox.Show("Database fout: (vervoerder)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub Load_Database_soorten()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("soorten3")
        ReDim soorten(count + 1)
        Dim CmdString As String = "SELECT * FROM soorten3"

        ' initialize datastructure for dropdown menu's veiling
        If dt_soorten.Columns.Count = 0 Then
            dt_soorten.Columns.Add("ID", GetType(String))
            dt_soorten.Columns.Add("desc", GetType(String))
        Else
            dt_soorten.Clear()
        End If
        If dtt_soorten.Columns.Count = 0 Then
            dtt_soorten.Columns.Add("ID", GetType(String))
            dtt_soorten.Columns.Add("desc", GetType(String))
        Else
            dtt_soorten.Clear()
        End If

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        soorten(i).id = CHint(Reader("id"))
                        soorten(i).soortnaam = CHstr(Reader("soortnaam"))
                        soorten(i).vbn_code = CHint(Reader("vbn_code"))
                        soorten(i).wps_code = CHstr(Reader("wps_code"))
                        soorten(i).sdf_code = CHstr(Reader("sdf_code"))
                        soorten(i).interne_code = CHstr(Reader("interne_code"))
                        soorten(i).potmaat = CHint(Reader("potmaat"))
                        soorten(i).actief = CHbool(Reader("actief"))
                        soorten(i).klokrijpheid = CHint(Reader("klokrijpheid"))
                        soorten(i).klokdiameter = CHint(Reader("klokdiameter"))
                        soorten(i).klokhoogte = CHint(Reader("klokhoogte"))
                        soorten(i).bbrijpheid = CHint(Reader("bbrijpheid"))
                        soorten(i).bbhoogte = CHint(Reader("bbhoogte"))
                        soorten(i).bbdiameter = CHint(Reader("bbdiameter"))
                        soorten(i).transporthoogte = CHint(Reader("transporthoogte"))
                        soorten(i).vastefustcode = CHint(Reader("vastefustcode"))
                        soorten(i).logiqs_code = CHstr(Reader("logiqs_code"))
                        soorten(i).labelnaam = CHstr(Reader("labelnaam"))
                        soorten(i).vestiging = CHstr(Reader("vestiging"))
                        soorten(i).tradeitemklok = CHint(Reader("tradeitem_klok"))
                        'fill datatable combos
                        dtt_soorten.Rows.Add(New String() {Tstr(soorten(i).id), soorten(i).soortnaam})
                        If soorten(i).actief = True Then
                            dt_soorten.Rows.Add(New String() {Tstr(soorten(i).id), soorten(i).soortnaam})
                        End If
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soorten)" + ex.Message)
            MessageBox.Show("Database fout: (soorten)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub Load_Database_accessoires()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("accessoire")
        ReDim accessoire(count + 1)
        Dim CmdString As String = "SELECT * FROM accessoire ORDER BY volgorde ASC"

        ' initialize datastructure for dropdown menu's 
        If dt_accessoire.Columns.Count = 0 Then
            dt_accessoire.Columns.Add("ID", GetType(String))
            dt_accessoire.Columns.Add("desc", GetType(String))
        Else
            dt_accessoire.Clear()
        End If
        If dtt_accessoire.Columns.Count = 0 Then
            dtt_accessoire.Columns.Add("ID", GetType(String))
            dtt_accessoire.Columns.Add("desc", GetType(String))
        Else
            dtt_accessoire.Clear()
        End If

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        accessoire(i).id = CHint(Reader("id"))
                        accessoire(i).naam = CHstr(Reader("naam"))
                        accessoire(i).code = CHstr(Reader("code"))
                        accessoire(i).prijslijst = CHint(Reader("prijslijst"))
                        accessoire(i).actief = CHbool(Reader("actief"))
                        accessoire(i).fust = CHint(Reader("fust"))
                        accessoire(i).potmaat = CHint(Reader("potmaat"))
                        accessoire(i).sdf_code = CHint(Reader("sdf_code"))
                        accessoire(i).decorum = CHbool(Reader("decorum"))
                        accessoire(i).keten_ean = CHstr(Reader("keten_ean"))
                        accessoire(i).hoes = CHstr(Reader("hoes"))
                        accessoire(i).bakstikker = CHbool(Reader("bakstikker"))
                        'fill datatable combos
                        dtt_accessoire.Rows.Add(New String() {Tstr(accessoire(i).id), accessoire(i).naam})
                        If accessoire(i).actief = True Then
                            dt_accessoire.Rows.Add(New String() {Tstr(accessoire(i).id), accessoire(i).naam})
                        End If
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (accessoire)" + ex.Message)
            MessageBox.Show("Database fout: (accessoire)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub Load_Database_mixen()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("mixen")
        ReDim mixen(count + 1)
        Dim CmdString As String = "SELECT * FROM mixen ORDER BY naam"

        ' initialize datastructure for dropdown menu's
        If dt_mixen.Columns.Count = 0 Then
            dt_mixen.Columns.Add("ID", GetType(String))
            dt_mixen.Columns.Add("desc", GetType(String))
        Else
            dt_mixen.Clear()
        End If
        ' initialize datastructure for dropdown menu's
        If dtt_mixen.Columns.Count = 0 Then
            dtt_mixen.Columns.Add("ID", GetType(String))
            dtt_mixen.Columns.Add("desc", GetType(String))
        Else
            dtt_mixen.Clear()
        End If
        ' initialize datastructure for dropdown menu's
        If dt_mixbakken.Columns.Count = 0 Then
            dt_mixbakken.Columns.Add("ID", GetType(String))
            dt_mixbakken.Columns.Add("desc", GetType(String))
        Else
            dt_mixbakken.Clear()
        End If
        ' initialize datastructure for dropdown menu's
        If dt_mixlagen.Columns.Count = 0 Then
            dt_mixlagen.Columns.Add("ID", GetType(String))
            dt_mixlagen.Columns.Add("desc", GetType(String))
        Else
            dt_mixlagen.Clear()
        End If


        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        mixen(i).id = CHint(Reader("id"))
                        mixen(i).naam = CHstr(Reader("naam"))
                        mixen(i).fust = CHstr(Reader("fust"))
                        mixen(i).koperean = CHstr(Reader("koperean"))
                        mixen(i).kopergroep = CHint(Reader("kopergroepid"))
                        mixen(i).actief = CHbool(Reader("actief"))
                        mixen(i).rijpheid = CHint(Reader("rijpheid"))
                        mixen(i).hoogte = CHint(Reader("hoogte"))
                        mixen(i).diameter = CHint(Reader("diameter"))
                        mixen(i).transporthoogte = CHint(Reader("transporthoogte"))
                        mixen(i).potmaat = CHint(Reader("potmaat"))
                        mixen(i).vbn_code = CHint(Reader("vbn_code"))
                        mixen(i).sdf_code = CHint(Reader("sdf_code"))
                        mixen(i).interne_code = CHstr(Reader("interne_code"))
                        mixen(i).labelnaam = CHstr(Reader("labelnaam"))
                        mixen(i).mixlagen = CHbool(Reader("mixlaag"))
                        mixen(i).accessoire = CHint(Reader("accessoire"))
                        mixen(i).vestiging = CHint(Reader("vestiging"))
                        mixen(i).sdf_artcode = CHstr(Reader("sdf_artcode"))
                        mixen(i).tradeitemklok = CHint(Reader("tradeitem_klok"))
                        'fill datatable combos
                        dtt_mixen.Rows.Add(New String() {Tstr(mixen(i).id), mixen(i).naam})
                        If mixen(i).mixlagen = False Then
                            dt_mixbakken.Rows.Add(New String() {Tstr(mixen(i).id), mixen(i).naam})
                        Else
                            dt_mixlagen.Rows.Add(New String() {Tstr(mixen(i).id), mixen(i).naam})
                        End If
                        If mixen(i).actief = True Then
                            dt_mixen.Rows.Add(New String() {Tstr(mixen(i).id), mixen(i).naam})
                        End If
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (mixen)" + ex.Message)
            MessageBox.Show("Database fout: (mixen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub Load_Database_prijzen()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("prijzen")
        ReDim prijzen(count + 1)
        Dim CmdString As String = "SELECT * FROM prijzen"

        ' initialize datastructure for dropdown menu's
        If dt_prijzen.Columns.Count = 0 Then
            dt_prijzen.Columns.Add("ID", GetType(String))
            dt_prijzen.Columns.Add("desc", GetType(String))
        Else
            dt_prijzen.Clear()
        End If
        If dtt_prijzen.Columns.Count = 0 Then
            dtt_prijzen.Columns.Add("ID", GetType(String))
            dtt_prijzen.Columns.Add("desc", GetType(String))
        Else
            dtt_prijzen.Clear()
        End If

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                prijzen(0).id = 0
                prijzen(0).naam = "N.V.T."
                dt_prijzen.Rows.Add(New String() {Tstr(prijzen(0).id), prijzen(0).naam})

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()

                        prijzen(i).id = CHint(Reader("id"))
                        prijzen(i).naam = CHstr(Reader("naam"))
                        prijzen(i).soort = CHstr(Reader("soort"))
                        prijzen(i).accessoire = CHbool(Reader("accessoire"))
                        prijzen(i).algemeen = CHbool(Reader("algemeen"))
                        prijzen(i).klant = CHstr(Reader("klant"))
                        prijzen(i).klantgroep = CHint(Reader("klantgroep"))
                        prijzen(i).actief = CHbool(Reader("actief"))
                        prijzen(i).actie_type = CHint(Reader("actie_type"))
                        prijzen(i).actienummer = CHstr(Reader("actienummer"))
                        'fill datatable combos
                        dtt_prijzen.Rows.Add(New String() {Tstr(prijzen(i).id), prijzen(i).naam})
                        If prijzen(i).actief = True Then
                            dt_prijzen.Rows.Add(New String() {Tstr(prijzen(i).id), prijzen(i).naam})
                        End If
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijzen)" + ex.Message)
            MessageBox.Show("Database fout: (prijzen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub Load_Database_soortvolgorde()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("soortvolgorde")
        ReDim soortvolgorde(count + 1)
        Dim CmdString As String = "SELECT * FROM soortvolgorde"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()

                        soortvolgorde(i).soortid = CHint(Reader("soortid"))
                        soortvolgorde(i).volgorde = CHint(Reader("volgorde"))
                       
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortvolgorde)" + ex.Message)
            MessageBox.Show("Database fout: (soortvolgorde)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub Load_Database_klantgroepen()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("kopersgroepen2")
        ReDim kopersgroepen(count + 1)
        Dim CmdString As String = "SELECT * FROM kopersgroepen2"

        ' initialize datastructure for dropdown menu's veiling
        If dt_kopersgroepen.Columns.Count = 0 Then
            dt_kopersgroepen.Columns.Add("ID", GetType(String))
            dt_kopersgroepen.Columns.Add("desc", GetType(String))
        Else
            dt_kopersgroepen.Clear()
        End If

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                kopersgroepen(0).id = 0
                kopersgroepen(0).groepnaam = "N.V.T."
                'kopersgroepen(0).eans = 0
                dt_kopersgroepen.Rows.Add(New String() {Tstr(kopersgroepen(0).id), kopersgroepen(0).groepnaam})
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        kopersgroepen(i).id = CHint(Reader("id"))
                        kopersgroepen(i).groepnaam = CHstr(Reader("groepnaam"))
                        'kopersgroepen(i).eans = Reader("ean")
                        'fill datatable combos
                        dt_kopersgroepen.Rows.Add(New String() {Tstr(kopersgroepen(i).id), kopersgroepen(i).groepnaam})
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopersgroepen)")
            MessageBox.Show("Database fout: (kopersgroepen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Load_Database_kopers()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("klanten")
        Dim CmdString As String = "SELECT ean,klantnaam,actief FROM klanten ORDER BY klantnaam"

        ' initialize datastructure for dropdown menu's
        If dt_kopers.Columns.Count = 0 Then
            dt_kopers.Columns.Add("ID", GetType(String))
            dt_kopers.Columns.Add("desc", GetType(String))
        Else
            dt_kopers.Clear()
        End If
        If dtt_kopers.Columns.Count = 0 Then
            dtt_kopers.Columns.Add("ID", GetType(String))
            dtt_kopers.Columns.Add("desc", GetType(String))
        Else
            dtt_kopers.Clear()
        End If
        If dtt_kopersXA.Columns.Count = 0 Then
            dtt_kopersXA.Columns.Add("ID", GetType(String))
            dtt_kopersXA.Columns.Add("desc", GetType(String))
        Else
            dtt_kopersXA.Clear()
        End If

        Overzicht_klantspecifiek_cmb.DataSource = Nothing
        Order_koper_combo.DataSource = Nothing

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim id As String
                Dim naam As String
                Dim actief As Boolean
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()

                dt_kopers.Rows.Add(New String() {"0000000000000", "_N.V.T."})
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        id = CHstr(Reader("ean"))
                        naam = CHstr(Reader("klantnaam"))
                        actief = CHbool(Reader("actief"))
                        'fill datatable combos
                        dtt_kopers.Rows.Add(New String() {id, naam})
                        dtt_kopersXA.Rows.Add(New String() {id, naam})
                        If actief = True Then
                            dt_kopers.Rows.Add(New String() {id, naam})
                        End If
                    Next i
                End If
                Reader.Close()

                Dim reader2 As OdbcDataReader
                Dim CmdString2 As String = "SELECT * FROM klant_alias"
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                reader2 = Cmd2.ExecuteReader()
                Do While reader2.Read
                    id = CType(reader2("ean"), String)
                    naam = CType(CheckDBNull(reader2("klantnaam")), String)
                    'fill datatable combos
                    dtt_kopers.Rows.Add(New String() {id, naam})
                    dt_kopers.Rows.Add(New String() {id, naam})
                Loop

                dtt_kopers.DefaultView.Sort = String.Format("desc")
                dt_kopers.DefaultView.Sort = String.Format("desc")
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopers)" + ex.Message)
            MessageBox.Show("Database fout: (kopers)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        'setup overzicht combo 
        Overzicht_klantspecifiek_cmb.AutoCompleteMode = AutoCompleteMode.SuggestAppend
        Overzicht_klantspecifiek_cmb.AutoCompleteSource = AutoCompleteSource.CustomSource
        Overzicht_klantspecifiek_cmb.DisplayMember = "desc"
        Overzicht_klantspecifiek_cmb.ValueMember = "ID"
        Overzicht_klantspecifiek_cmb.DropDownStyle = ComboBoxStyle.DropDown
        Overzicht_klantspecifiek_cmb.MaxDropDownItems = 12

        Overzicht_klantspecifiek_cmb.DataSource = dt_kopers
        Order_koper_combo.DataSource = dt_kopers
    End Sub
    Private Sub Load_Database_keurcodes()
        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("keurcodes")
        Dim CmdString As String = "SELECT * FROM keurcodes"

        ' initialize datastructure for dropdown menu's veiling
        If dtt_keurcode.Columns.Count = 0 Then
            dtt_keurcode.Columns.Add("ID", GetType(String))
            dtt_keurcode.Columns.Add("desc", GetType(String))
        Else
            dtt_keurcode.Clear()
        End If

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()

                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        Dim code As Integer = CHint(Reader("code"))
                        Dim codenaam As String = CHstr(Reader("codetekst"))
                        dtt_keurcode.Rows.Add(New String() {Tstr(code), codenaam})
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (keurcode)" + ex.Message)
            MessageBox.Show("Database fout: (keurcode)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Load_Database_lijsten()
        'Friend kopergroepEANs() As kopersgroepEAN_data
        'Friend soortgroepids() As soortgroep_data
        'Friend prijzendatumlijst() As prijzendatumlijst_data

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim wCmd As New OdbcCommand("select * from instellingen", Conn)
                Dim wReader As OdbcDataReader
                wReader = wCmd.ExecuteReader
                If wReader.HasRows Then
                    wReader.Read()
                    Inst_paspoort1_txt.Text = CHstr(wReader("paspoort1"))
                    Inst_paspoort2_txt.Text = CHstr(wReader("paspoort2"))
                    Inst_paspoortb1_txt.Text = CHstr(wReader("paspoortb1"))
                    Inst_paspoortb2_txt.Text = CHstr(wReader("paspoortb2"))
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Fout paspoort: " + ex.Message)
            MessageBox.Show("Fout paspoort:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try




        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("kopersgroepen2_eans")
        ReDim kopergroepEANs(count + 1)
        Dim CmdString = "SELECT * FROM kopersgroepen2_eans"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        kopergroepEANs(i).id = CHint(Reader("id"))
                        kopergroepEANs(i).ean = CHstr(Reader("ean"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopersgroepeans)" + ex.Message)
            MessageBox.Show("Database fout: (kopersgroepeans)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        count = GetRowCount("soortgroepen_ids")
        ReDim soortgroepids(count + 1)
        CmdString = "SELECT * FROM soortgroepen_ids"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        soortgroepids(i).id = CHint(Reader("id"))
                        soortgroepids(i).soortmixid = CHint(Reader("soortmixid"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortgroepenids)" + ex.Message)
            MessageBox.Show("Database fout: (soortgroepenids)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try



        count = GetRowCount("prijzen_datumlijst")
        ReDim prijzendatumlijst(count + 1)
        CmdString = "SELECT * FROM prijzen_datumlijst"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        prijzendatumlijst(i).id = CHint(Reader("id"))
                        prijzendatumlijst(i).datum = CType(Reader("datum"), Date)
                        prijzendatumlijst(i).prijs = CHdouble(Reader("prijs"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijzendatumlijst)" + ex.Message)
            MessageBox.Show("Database fout: (prijzendatumlijst)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                count = GetRowCount("data_elementen")
                ReDim dataelementen(count + 1)
                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM data_elementen", Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        dataelementen(i).code = CHstr(Reader("date_element_code"))
                        dataelementen(i).value = CHstr(Reader("date_element_value"))
                        dataelementen(i).description = CHstr(Reader("date_element_value_description"))
                    Next i
                End If
                Reader.Close()

                count = GetRowCount("sort_elementen")
                ReDim sortelementen(count + 1)
                'Execute Query
                Dim Cmd2 As New OdbcCommand("SELECT * FROM sort_elementen", Conn)
                Reader = Cmd2.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        sortelementen(i).code = CHstr(Reader("sort_element_code"))
                        sortelementen(i).value = CHstr(Reader("sort_element_value"))
                        sortelementen(i).description = CHstr(Reader("sort_element_value_description"))
                    Next i
                End If
                Reader.Close()

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (data sort elementen)" + ex.Message)
            MessageBox.Show("Database fout: (data sort elementen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        ' initialize datastructure for dropdown menu's fustcategorie
        count = GetRowCount("fustcategorie")
        ReDim fustcategorie(count)
        If dt_fustcategorie.Columns.Count = 0 Then
            dt_fustcategorie.Columns.Add("ID", GetType(String))
            dt_fustcategorie.Columns.Add("desc", GetType(String))
        Else
            dt_fustcategorie.Clear()
        End If


        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM fustcategorie", Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        fustcategorie(i).id = CHint(Reader("id"))
                        fustcategorie(i).naam = CHstr(Reader("naam"))
                        dt_fustcategorie.Rows.Add(New String() {Tstr(fustcategorie(i).id), fustcategorie(i).naam})
                    Next
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (fust categorie)" + ex.Message)
            MessageBox.Show("Database fout: (fust categorie)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        count = GetRowCount("fustcategorie_ids")
        ReDim fustcategorieids(count + 1)
        CmdString = "SELECT * FROM fustcategorie_ids"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        fustcategorieids(i).fustcatid = CHint(Reader("fustcategorie_id"))
                        fustcategorieids(i).soortgroepid = CHint(Reader("soortgroep_id"))
                        fustcategorieids(i).fustid = CHint(Reader("fust_id"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (fustcategorieids)" + ex.Message)
            MessageBox.Show("Database fout: (fustcategorieids)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        ' initialize datastructure for dropdown menu's hoescategorie
        count = GetRowCount("hoescategorie")
        ReDim hoescategorie(count)
        If dt_hoescategorie.Columns.Count = 0 Then
            dt_hoescategorie.Columns.Add("ID", GetType(String))
            dt_hoescategorie.Columns.Add("desc", GetType(String))
        Else
            dt_hoescategorie.Clear()
        End If


        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM hoescategorie", Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        hoescategorie(i).id = CHint(Reader("id"))
                        hoescategorie(i).naam = CHstr(Reader("naam"))
                        dt_hoescategorie.Rows.Add(New String() {Tstr(hoescategorie(i).id), hoescategorie(i).naam})
                    Next i
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (hoes categorie)" + ex.Message)
            MessageBox.Show("Database fout: (hoes categorie)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        count = GetRowCount("hoescategorie_ids")
        ReDim hoescategorieids(count + 1)
        CmdString = "SELECT * FROM hoescategorie_ids"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        hoescategorieids(i).hoescatid = CHint(Reader("hoescategorie_id"))
                        hoescategorieids(i).soortgroepid = CHint(Reader("soortgroep_id"))
                        hoescategorieids(i).accessoireid = CHint(Reader("accessoire_id"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (hoescategorieids)" + ex.Message)
            MessageBox.Show("Database fout: (hoescategorieids)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        count = GetRowCount("vestigingen")

        ' initialize datastructure for dropdown menu's vestiging
        If dt_vestiging.Columns.Count = 0 Then
            dt_vestiging.Columns.Add("ID", GetType(String))
            dt_vestiging.Columns.Add("desc", GetType(String))
        Else
            dt_vestiging.Clear()
        End If

        ReDim vestiging(count)
        CmdString = "SELECT * FROM vestigingen"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        vestiging(i).id = CHint(Reader("id"))
                        vestiging(i).naam = CHstr(Reader("naam"))
                        vestiging(i).adres = CHstr(Reader("adres"))
                        dt_vestiging.Rows.Add(New String() {Tstr(vestiging(i).id), vestiging(i).naam})
                    Next i
                End If

            End Using


        Catch ex As Exception
            ErrorLog("Database fout: (locaties)" + ex.Message)
            MessageBox.Show("Database fout: (locaties)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        If count = 1 Then
            '1 locatie, geen buttons laten zien
            jenptenhave = False
        Else
            jenptenhave = True
            TreeVest1_but.Text = vestiging(1).naam
            TreeVest2_but.Text = vestiging(2).naam
            TreeVest1_but.Visible = True
            TreeVest2_but.Visible = True
            TreeVestTotaal_but.Visible = True
        End If




        'kortingsgroepen()
        count = GetRowCount("prijslijstkortingen")
        ReDim kortingsgroepen(count + 1)
        CmdString = "SELECT * FROM prijslijstkortingen order by volgorde"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        kortingsgroepen(i).kopergroep = CHint(Reader("kopersgroep"))
                        kortingsgroepen(i).korting = CHint(Reader("korting"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijslijstkortingen)" + ex.Message)
            MessageBox.Show("Database fout: (prijslijstkortingen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        'prijslijst()
        count = GetRowCount("prijslijst")
        ReDim prijslijst(count + 1)
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM prijslijst", Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        prijslijst(i).kwekerscode = CHstr(Reader("kwekerscode"))
                        prijslijst(i).soort = CHint(Reader("soort"))
                        prijslijst(i).accessoire1 = CHint(Reader("accessoire1"))
                        prijslijst(i).accessoire2 = CHint(Reader("accessoire2"))
                        prijslijst(i).fust = CHint(Reader("fust"))
                        prijslijst(i).hoes = CHint(Reader("hoes"))
                        prijslijst(i).prijs = CHint(Reader("prijs"))
                        prijslijst(i).korting = CHint(Reader("korting"))
                        prijslijst(i).kopersgroep = CHint(Reader("kopersgroep"))
                        prijslijst(i).omschrijving = CHstr(Reader("omschrijving"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijslijst)" + ex.Message)
            MessageBox.Show("Database fout: (prijslijst)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        'prijskoppelingen()

        ReDim prijskoppelingen(5000)
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim count2 As Integer = 0
                Dim Cmd As New OdbcCommand("SELECT * FROM prijslijstkoppelingen", Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read
                    Dim soortgroep_id As Integer = Reader("soortgroep_id")
                    Dim soortmix_id As Integer = Reader("soortmix_id")
                    For i = 0 To UBound(soortgroepids) - 1
                        If soortgroep_id = soortgroepids(i).id Then
                            prijskoppelingen(count2).soort_id = soortgroepids(i).soortmixid
                            prijskoppelingen(count2).koppel_id = soortmix_id
                            count2 = count2 + 1
                        End If
                    Next i

                Loop
                ReDim Preserve prijskoppelingen(count2)

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijslijstkoppelingen)" + ex.Message)
            MessageBox.Show("Database fout: (prijslijstkoppelingen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try



    End Sub
    Private Sub Create_SoortMixTable()
        If dt_soortmix.Columns.Count = 0 Then
            dt_soortmix.Columns.Add("ID", GetType(String))
            dt_soortmix.Columns.Add("desc", GetType(String))
            dt_soortmix.Columns.Add("volgorde", GetType(String))
        Else
            dt_soortmix.Clear()
        End If
        If dtt_soortmix.Columns.Count = 0 Then
            dtt_soortmix.Columns.Add("ID", GetType(String))
            dtt_soortmix.Columns.Add("desc", GetType(String))
            dtt_soortmix.Columns.Add("volgorde", GetType(String))
        Else
            dtt_soortmix.Clear()
        End If
        If dt_soortmixlagen.Columns.Count = 0 Then
            dt_soortmixlagen.Columns.Add("ID", GetType(String))
            dt_soortmixlagen.Columns.Add("desc", GetType(String))
            dt_soortmixlagen.Columns.Add("volgorde", GetType(String))
        Else
            dt_soortmixlagen.Clear()
        End If

        If dt_soortgroepen.Columns.Count = 0 Then
            dt_soortgroepen.Columns.Add("ID", GetType(String))
            dt_soortgroepen.Columns.Add("desc", GetType(String))
        Else
            dt_soortgroepen.Clear()
        End If

        dt_soortmixlagen.Rows.Add(New String() {Tstr(0), "N.V.T."})

        Dim i As Integer
        For i = 1 To UBound(soorten) - 1
            dtt_soortmix.Rows.Add(New String() {Tstr(soorten(i).id), soorten(i).soortnaam, Str(get_volgorde(soorten(i).id))})
            dt_soortmixlagen.Rows.Add(New String() {Tstr(soorten(i).id), soorten(i).soortnaam, Str(get_volgorde(soorten(i).id))})
            If soorten(i).actief = True Then
                dt_soortmix.Rows.Add(New String() {Tstr(soorten(i).id), soorten(i).soortnaam, Str(get_volgorde(soorten(i).id))})
            End If
        Next i
        For i = 1 To UBound(mixen) - 1
            dtt_soortmix.Rows.Add(New String() {Tstr(10000 + mixen(i).id), mixen(i).naam, Str(get_volgorde(10000 + mixen(i).id))})
            If mixen(i).mixlagen = False Then
                dt_soortmixlagen.Rows.Add(New String() {Tstr(10000 + mixen(i).id), mixen(i).naam, Str(get_volgorde(10000 + mixen(i).id))})
            End If
            If mixen(i).actief = True Then
                dt_soortmix.Rows.Add(New String() {Tstr(10000 + mixen(i).id), mixen(i).naam, Str(get_volgorde(10000 + mixen(i).id))})
            End If
        Next i
        'sort datatable 

        dt_soortmix.DefaultView.Sort = String.Format("volgorde", "desc")
        dtt_soortmix.DefaultView.Sort = String.Format("volgorde", "desc")
        dt_soortmixlagen.DefaultView.Sort = String.Format("volgorde", "desc")

        ' SOORTMIX PRIJZEN

        If dt_soortmixprijzen.Columns.Count = 0 Then
            dt_soortmixprijzen.Columns.Add("ID", GetType(String))
            dt_soortmixprijzen.Columns.Add("desc", GetType(String))
        Else
            dt_soortmixprijzen.Clear()
        End If
        If dtt_soortmixprijzen.Columns.Count = 0 Then
            dtt_soortmixprijzen.Columns.Add("ID", GetType(String))
            dtt_soortmixprijzen.Columns.Add("desc", GetType(String))
        Else
            dtt_soortmixprijzen.Clear()
        End If

        'dt_soortmixprijzen.Rows.Add(New String() {Str(0), "Algemeen"})
        'dtt_soortmixprijzen.Rows.Add(New String() {Str(0), "Algemeen"})
        For i = 1 To UBound(soorten) - 1
            dtt_soortmixprijzen.Rows.Add(New String() {Tstr(soorten(i).id), soorten(i).soortnaam})
            If soorten(i).actief = True Then
                dt_soortmixprijzen.Rows.Add(New String() {Tstr(soorten(i).id), soorten(i).soortnaam})
            End If
        Next i
        For i = 1 To UBound(mixen) - 1
            dtt_soortmixprijzen.Rows.Add(New String() {Tstr(10000 + mixen(i).id), mixen(i).naam})
            If mixen(i).actief = True Then
                dt_soortmixprijzen.Rows.Add(New String() {Tstr(10000 + mixen(i).id), mixen(i).naam})
            End If
        Next i

        'soortmix ids
        If dt_soortmixids.Columns.Count = 0 Then
            dt_soortmixids.Columns.Add("ID", GetType(String))
            dt_soortmixids.Columns.Add("desc", GetType(String))
            dt_soortmixids.Columns.Add("volgorde", GetType(Int32))
        Else
            dt_soortmixids.Clear()
        End If

        dt_soortmixids.Rows.Add(New Object() {Tstr(0), "Onbekend", 0})

        Dim count2 As Integer = 1
        For j = 0 To 999
            For i = 1 To UBound(soorten) - 1
                If CInt(Val(soorten(i).interne_code)) = j Then
                    dt_soortmixids.Rows.Add(New Object() {Tstr(soorten(i).id), soorten(i).interne_code + " " + soorten(i).soortnaam, count2})
                    count2 = count2 + 1
                End If
            Next i
        Next j
        For j = 0 To 999
            For i = 1 To UBound(mixen) - 1
                If CInt(Val(mixen(i).interne_code)) = j Then
                    dt_soortmixids.Rows.Add(New Object() {Tstr(10000 + mixen(i).id), mixen(i).interne_code + " " + mixen(i).naam, count2})
                    count2 = count2 + 1
                End If
            Next i
        Next j
        dt_soortmixids.DefaultView.Sort = "volgorde"


        Dim Reader As OdbcDataReader

        Dim Count As Integer = GetRowCount("soortgroepen")
        ReDim soortgroep(Count)
        Dim CmdString As String = "SELECT * FROM soortgroepen"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To Count
                        Reader.Read()
                        soortgroep(i).id = CHint(Reader("id"))
                        soortgroep(i).naam = CHstr(Reader("groepnaam"))
                        soortgroep(i).fusten = CHbool(Reader("fusten"))
                        soortgroep(i).hoezen = CHbool(Reader("hoezen"))
                        soortgroep(i).prijzen = CHbool(Reader("prijzen"))
                        dt_soortmixprijzen.Rows.Add(New String() {Tstr(20000 + soortgroep(i).id), soortgroep(i).naam})
                        dtt_soortmixprijzen.Rows.Add(New String() {Tstr(20000 + soortgroep(i).id), soortgroep(i).naam})
                        dt_soortgroepen.Rows.Add(New String() {Tstr(soortgroep(i).id), soortgroep(i).naam})
                    Next i
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortgroep)")
            MessageBox.Show("Database fout: (soortgroep)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try




    End Sub
    Private Function GetRowCount(ByVal tablename As String) As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer
        Dim CmdString As String = "SELECT COUNT(*) as ""COUNT"" FROM " + tablename
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    count = CHint(Reader.Item("COUNT"))
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: " + tablename + " : " + ex.Message)
            MessageBox.Show("Database fout: " + tablename + " : " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return count
    End Function
    Private Sub Check_Database_reload()
        Dim Reader As OdbcDataReader
        Dim checkcounter As Integer = 0
        Dim koper_reload As Boolean = False
        Dim CmdString As String = "SELECT * from instellingen"
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    checkcounter = CHint(Reader("Database_reload"))
                    koper_reload = CHbool(Reader("koper_reload"))
                    Reader.Close()
                    If checkcounter > 10000 Then
                        Cmd.CommandText = "UPDATE instellingen SET Database_reload = 0"
                        Cmd.ExecuteNonQuery()
                    End If
                    If koper_reload = True Then
                        Cmd.CommandText = "UPDATE instellingen SET Koper_Reload = 0"
                        Cmd.ExecuteNonQuery()
                    End If
                End If
                Reader.Close()
            End Using
        Catch ex As Exception
            ErrorLog("Database fout:Instellingen/Reload")
            MessageBox.Show("Database fout:Instellingen/Reload", "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        If Database_reload_counter <> checkcounter Then


            FormProgressBar.StartPosition = FormStartPosition.CenterScreen
            FormProgressBar.Show()

            FormProgressBar.DataProgressBar.Value = 5

            If koper_reload = True Then
                Load_Database_kopers()
            End If
            FormProgressBar.DataProgressBar.Value = 10

            Load_Database_fusten()
            FormProgressBar.DataProgressBar.Value = 15

            Load_Database_karren()
            FormProgressBar.DataProgressBar.Value = 20

            Load_Database_orderinfo()
            FormProgressBar.DataProgressBar.Value = 25

            Load_Database_vervoerder()
            FormProgressBar.DataProgressBar.Value = 30

            Load_Database_soorten()
            FormProgressBar.DataProgressBar.Value = 35

            Load_Database_accessoires()
            FormProgressBar.DataProgressBar.Value = 40

            Load_Database_mixen()
            FormProgressBar.DataProgressBar.Value = 50

            Load_Database_prijzen()
            Load_Database_soortvolgorde()
            FormProgressBar.DataProgressBar.Value = 60

            Load_Database_keurcodes()
            FormProgressBar.DataProgressBar.Value = 70

            Load_Florecom_Data()
            FormProgressBar.DataProgressBar.Value = 70

            Load_Database_WpsFilters()
            FormProgressBar.DataProgressBar.Value = 75

            Load_Database_klantgroepen()
            FormProgressBar.DataProgressBar.Value = 80

            Load_Database_lijsten()
            FormProgressBar.DataProgressBar.Value = 85

            Load_Database_keurcodes()
            FormProgressBar.DataProgressBar.Value = 99

            Create_SoortMixTable()

            Setup_Order_Grid()

            Setup_Vervoer_Tab()

            FormProgressBar.Close()


        End If
        Database_reload_counter = checkcounter
    End Sub
    Private Sub Set_Database_reload()
        Dim CmdString As String = "SELECT * FROM instellingen WHERE 1=0"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                With Cmd
                    .CommandText = "UPDATE instellingen SET Database_reload = Database_reload + 1"
                    .ExecuteNonQuery()
                End With
            End Using
        Catch ex As Exception
            ErrorLog("Database reload: " + ex.Message)
            MsgBox("Database reload: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub
    Private Sub SetIndex(combo1 As ComboBox)
        Try
            If combo1.Items.Count > 0 Then
                combo1.SelectedIndex = 0
            End If
        Catch ex As Exception

        End Try
    End Sub
    Private Sub LoadDataTable(ByVal DataTable1 As DataTable, ByVal tablename As String, ByVal columnname As String, ByVal NVT As Boolean, Optional ByVal actief As Boolean = False)

        If DataTable1.Columns.Count = 0 Then
            DataTable1.Columns.Add("ID", GetType(String))
            DataTable1.Columns.Add("desc", GetType(String))
        Else
            DataTable1.Clear()
        End If

        If NVT = True Then
            DataTable1.Rows.Add(New String() {"0", "N.V.T."})
        End If

        Try

            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim cmdstring As String = "SELECT * FROM " + Trim(tablename) + " ORDER BY " + Trim(columnname)
                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                Dim Reader As OdbcDataReader = Cmd.ExecuteReader()

                Do While Reader.Read

                    Dim actiefflag As Boolean = True
                    If actief = True Then
                        actiefflag = CHbool(Reader("actief"))
                    End If
                    If actiefflag = True Then
                        Dim id As Integer = CHint(Reader("id"))
                        Dim displaystring As String = CHstr(Reader(columnname))
                        DataTable1.Rows.Add(New String() {Trim(Str(id)), displaystring})
                    End If
                Loop
                Reader.Close()
                Conn.Close()
            End Using
        Catch ex As Exception
            MessageBox.Show("Database fout: laad datatabel:" + tablename + " -> " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try



    End Sub
    Private Sub LoadCombo(ByVal Combobox1 As ComboBox, ByVal datasource1 As DataTable, ByVal autocomplete As Boolean, Optional ByVal maxdropdown As Integer = 12)
        If autocomplete = True Then
            Combobox1.AutoCompleteMode = AutoCompleteMode.SuggestAppend
            Combobox1.AutoCompleteSource = AutoCompleteSource.CustomSource
            Combobox1.DisplayMember = "desc"
            Combobox1.ValueMember = "ID"
            Combobox1.DropDownStyle = ComboBoxStyle.DropDown
            Combobox1.MaxDropDownItems = maxdropdown
            Combobox1.DataSource = New DataView(datasource1)
            Combobox1.SelectedValue = "0000000000000"
        Else
            Combobox1.DisplayMember = "desc"
            Combobox1.ValueMember = "ID"
            Combobox1.DropDownStyle = ComboBoxStyle.DropDownList
            Combobox1.MaxDropDownItems = maxdropdown
            Combobox1.DataSource = New DataView(datasource1)
        End If
    End Sub
    Private Function WeeknumberToDate(ByVal weeknumber As Integer, ByVal thisyear As Integer) As DateTime

        Dim jan1 As DateTime = New DateTime(thisyear, 1, 1, 0, 0, 0)
        Dim offset As Integer = DayOfWeek.Monday - jan1.DayOfWeek
        Dim firstmonday As DateTime = DateAdd("d", offset, jan1)

        Dim WeekNumberjan1 As Integer = DatePart(DateInterval.WeekOfYear, firstmonday, FirstDayOfWeek.Monday, FirstWeekOfYear.FirstFourDays)
        Dim nextweekjan1 As Integer = DatePart(DateInterval.WeekOfYear, DateAdd("d", 7, firstmonday), FirstDayOfWeek.Monday, FirstWeekOfYear.FirstFourDays)
        If WeekNumberjan1 = 53 And nextweekjan1 = 2 Then WeekNumberjan1 = 1 ' repair week 53 bug
        If WeekNumberjan1 = 53 Then firstmonday = DateAdd("d", 7, firstmonday)

        Dim monday As DateTime = DateAdd("d", (weeknumber - 1) * 7, firstmonday)

        'Debug_txt.Text = Debug_txt.Text + "week" + Str(weeknumber) + "    monday:" + Format(monday, "dd-MM-yyyy HH:mm") + vbCrLf

        Return monday
    End Function
    Private Function WeeknumberFromDate(ByVal datum As Date) As Integer

        Dim CurrentWeekNumber As Integer = DatePart(DateInterval.WeekOfYear, datum, FirstDayOfWeek.Monday, FirstWeekOfYear.FirstFourDays)
        Dim nextweek As Integer = DatePart(DateInterval.WeekOfYear, DateAdd("d", 7, datum), FirstDayOfWeek.Monday, FirstWeekOfYear.FirstFourDays)
        If CurrentWeekNumber = 53 And nextweek = 2 Then CurrentWeekNumber = 1 ' repair week 53 bug

        Return CurrentWeekNumber
    End Function
    Private Function YearFromDate(ByVal datum As Date) As Integer
        Dim currentyear = Year(datum)
        Dim CurrentWeekNumber As Integer = DatePart(DateInterval.WeekOfYear, datum, FirstDayOfWeek.Monday, FirstWeekOfYear.FirstFourDays)
        Dim nextweek As Integer = DatePart(DateInterval.WeekOfYear, DateAdd("d", 7, datum), FirstDayOfWeek.Monday, FirstWeekOfYear.FirstFourDays)
        If CurrentWeekNumber = 53 And nextweek = 2 Then
            CurrentWeekNumber = 1 ' repair week 53 bug
            currentyear = currentyear + 1
        End If


        Return currentyear
    End Function
    Private Sub Load_Database_fotoFilters()

        ' Structure FotoFilters
        '    Dim tradeItemId As integer
        '    Dim rijpheid As Integer
        '    Dim diameter As Integer
        '    Dim hoogte As Integer
        '    Dim schermen As Integer
        '    Dim fust As Integer
        '    Dim keurcode As Integer
        '    Dim fotopath As Integer
        '    Dim hoes As Integer
        'End Structure

        Dim Count As Integer = GetRowCount("fotos_standaard")
        ReDim fotofilters(Count + 1)

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM fotos_standaard", Conn)
                Dim Reader As OdbcDataReader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    For i = 1 To Count
                        Reader.Read()
                        fotofilters(i).tradeItemId = CHint(Reader("tradeItemDBId"))
                        fotofilters(i).rijpheid = CHint(Reader("rijpheid"))
                        fotofilters(i).diameter = CHint(Reader("diameter"))
                        fotofilters(i).hoogte = CHint(Reader("hoogte"))
                        fotofilters(i).schermen = CHint(Reader("schermen"))
                        fotofilters(i).fust = CHint(Reader("fust"))
                        fotofilters(i).keurcode = CHint(Reader("keurcode"))
                        fotofilters(i).fotopath = CHstr(Reader("fotopath"))
                        fotofilters(i).hoes = CHint(Reader("hoes"))
                    Next i
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (fotofilters)" + ex.Message)
            MessageBox.Show("Database fout: (fotofilters)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub

#End Region

#Region "Flexgrid"
    Dim user As Integer = 1
    Dim debug_headers As Boolean = False
    '**************** DATA TABELLEN HIERIN TOEVOEGEN
    Private Function BuildTable(ByVal tablename As String, ByVal flexgrid As C1FlexGrid) As tablelayout()
        Dim query As String = ""

        flexgrid.BeginUpdate()

        flexgrid.KeyActionTab = KeyActionEnum.MoveAcrossOut

        'add editcolor to style 
        Dim stylefound As Boolean = False
        For i = 0 To flexgrid.Styles.Count - 1
            If flexgrid.Styles.Item(i).Name = "EDIT" Then
                stylefound = True
                Exit For
            End If
        Next
        If stylefound = False Then
            Dim rs As C1.Win.C1FlexGrid.CellStyle
            rs = flexgrid.Styles.Add("EDIT")
            rs.BackColor = Color.LightBlue
            Dim rs2 As C1.Win.C1FlexGrid.CellStyle
            rs2 = flexgrid.Styles.Add("WHITE")
            rs2.BackColor = Color.White
            Dim rs3 As C1.Win.C1FlexGrid.CellStyle
            rs3 = flexgrid.Styles.Add("TOTAL")
            rs3.BackColor = Color.Beige
            Dim rs4 As C1.Win.C1FlexGrid.CellStyle
            rs4 = flexgrid.Styles.Add("RED")
            rs4.BackColor = Color.LightCoral
        End If

        Dim table() As tablelayout = Nothing
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand("", Conn)
                Dim Reader As OdbcDataReader

                Dim Cmd2 As New OdbcCommand("", Conn)
                Dim Reader2 As OdbcDataReader

                query = "SELECT COUNT(*) as ""COUNT"" FROM db_" + tablename + "_build"
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Dim count As Integer = CType(Reader.Item("COUNT"), Integer)
                    ReDim table(count - 1)

                    query = "SELECT * FROM db_" + tablename + "_build"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    Dim cnt As Integer = 0
                    Do While Reader2.Read
                        table(cnt).id = CHint(Reader2("id"))
                        table(cnt).label = CHstr(Reader2("label"))
                        table(cnt).columnname = CHstr(Reader2("columnname"))
                        table(cnt).type = CStr(Reader2("type"))
                        table(cnt).sort = CHint(Reader2("sort"))
                        table(cnt).columnwidth = CHint(Reader2("columnwidth"))
                        table(cnt).edit = CHbool(Reader2("editable"))
                        table(cnt).visible = CHbool(Reader2("visible"))
                        table(cnt).datatable = CHstr(Reader2("datatable"))
                        table(cnt).defaultvalue = CHstr(Reader2("defaultvalue"))
                        table(cnt).order = CHint(Reader2("sqlorder"))
                        table(cnt).leftjoin = CHstr(Reader2("leftjoin"))
                        table(cnt).info = CHbool(Reader2("info"))

                        If table(cnt).type = "System.String" And table(cnt).edit = True And table(cnt).datatable = "" Then
                            table(cnt).maxcharlength = GetMaximumColumnSize(tablename, table(cnt).columnname)
                        Else
                            table(cnt).maxcharlength = 0
                        End If


                        cnt = cnt + 1
                    Loop
                    Reader.Close()
                End If

                'Sort array on 'sort'
                Dim tabletemp As tablelayout
                For sortlp = 0 To UBound(table) - 1
                    For i = 0 To UBound(table) - 1
                        If table(i).sort > table(i + 1).sort Then
                            tabletemp = table(i)
                            table(i) = table(i + 1)
                            table(i + 1) = tabletemp
                        End If
                    Next
                Next

                'Setup flexgrid

                flexgrid.Cols.Count = UBound(table) + 3
                flexgrid.Rows.Count = 2
                flexgrid.Rows.Fixed = 2

                flexgrid.Cols(0).Caption = "Id"   'first col = id
                flexgrid.Cols(0).AllowEditing = False
                flexgrid.Cols(0).DataType = System.Type.GetType("System.Int32")
                flexgrid.Cols(0).Width = 40
                flexgrid.Cols(0).AllowDragging = False

                flexgrid.Cols(1).Caption = "Edited"   '2nd col = edit
                flexgrid.Cols(1).AllowEditing = True
                flexgrid.Cols(1).DataType = System.Type.GetType("System.Boolean")
                flexgrid.Cols(1).Width = 40
                flexgrid.Cols(1).AllowDragging = False

                Dim cn() As String = New String() {"desc"}

                For i = 0 To UBound(table)

                    flexgrid.Cols(i + 2).Caption = table(i).label  'caption in row 0
                    Dim id As String = Trim(Str(table(i).id))
                    If table(i).order > 0 Then
                        id = id + ":" + Trim(Str(table(i).order))
                    End If
                    flexgrid.Item(1, i + 2) = id          'id:order in row 1
                    flexgrid.Cols(i + 2).AllowEditing = table(i).edit
                    If user = 0 Then
                        flexgrid.Cols(i + 2).Visible = True
                    Else
                        flexgrid.Cols(i + 2).Visible = table(i).visible
                    End If
                    flexgrid.Cols(i + 2).Width = table(i).columnwidth

                    If table(i).type = "System.Decimal;C2" And table(i).edit = True Then
                        flexgrid.Cols(i + 2).EditMask = "#0.00"
                    Else
                        flexgrid.Cols(i + 2).EditMask = ""
                    End If

                    Dim celformat() = table(i).type.Split(New Char() {";"c})
                    If Trim(celformat(0)) <> "" Then
                        flexgrid.Cols(i + 2).DataType = System.Type.GetType(celformat(0))
                    End If
                    If UBound(celformat) = 1 Then
                        If Trim(celformat(1)) = "..." Then
                            flexgrid.Cols(i + 2).ComboList = "..."
                            flexgrid.Cols(i + 2).Format = ""
                        Else
                            flexgrid.Cols(i + 2).ComboList = ""
                            flexgrid.Cols(i + 2).Format = Trim(celformat(1))
                        End If
                    Else
                        flexgrid.Cols(i + 2).ComboList = ""
                        flexgrid.Cols(i + 2).Format = ""
                    End If

                    If Trim(table(i).datatable) <> "" Then
                        Dim dtable As DataTable = dt_empty
                        Select Case table(i).datatable
                            '                                                                 **************** DATA TABELLEN HIER TOEVOEGEN                   
                            Case "dt_kar" : dtable = dt_kar
                            Case "dt_veilingen" : dtable = dt_veilingen
                            Case "dt_fust" : dtable = dtt_fust
                            Case "dt_fusta" : dtable = dt_fusta
                            Case "dt_vervoerder" : dtable = dtt_vervoerder
                            Case "dt_afleverloc" : dtable = dtt_afleverloc
                            Case "dt_accessoire" : dtable = dtt_accessoire
                            Case "dt_fustcategorie" : dtable = dt_fustcategorie
                            Case "dt_hoescategorie" : dtable = dt_hoescategorie
                            Case "dt_prijzen" : dtable = dtt_prijzen
                            Case "dt_soortmixprijzen" : dtable = dtt_soortmixprijzen
                            Case "dtt_kopersXA" : dtable = dtt_kopersXA
                            Case "dt_vestiging" : dtable = dt_vestiging
                            Case "dtt_soortmix" : dtable = dtt_soortmix
                            Case "dt_kopers" : dtable = dt_kopers
                            Case "dt_soortgroepveilgroep" : dtable = dt_soortgroepveilgroep
                            Case "dt_floridayveiling" : dtable = dt_floridayveiling
                            Case "dt_kwaliteit" : dtable = dt_kwaliteit
                            Case "dt_soortmixids" : dtable = dt_soortmixids
                            Case "dtt_keurcode" : dtable = dtt_keurcode
                            Case "dtt_gp" : dtable = dtt_gp
                            Case "dt_labelstatus" : dtable = dt_labelstatus
                            Case "dt_tradeitem" : dtable = dt_tradeitem
                            Case "dt_tradeitemklok" : dtable = dt_tradeitemklok
                            Case "dt_floridaywarehouses" : dtable = dt_floridaywarehouses

                            Case "dt_rijpheid" : dtable = dt_rijpheid
                            Case "dt_hoogte" : dtable = dt_hoogte
                            Case "dt_diameter" : dtable = dt_diameter
                            Case "dt_schermen" : dtable = dt_schermen


                        End Select
                        Dim mcd As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtable, "ID", cn, 0)
                        flexgrid.Cols(i + 2).DataMap = mcd
                    Else
                        flexgrid.Cols(i + 2).DataMap = Nothing
                    End If



                    'setup filter

                    Dim filter = New C1.Win.C1FlexGrid.ConditionFilter()
                    filter.Condition1.Operator = C1.Win.C1FlexGrid.ConditionOperator.Contains
                    filter.AndConditions = True
                    filter.Condition2.Operator = C1.Win.C1FlexGrid.ConditionOperator.None

                    flexgrid.Cols(i + 2).Filter = filter
                    '    flexgrid.Cols(i + 2).AllowFiltering = C1.Win.C1FlexGrid.AllowFiltering.ByCondition
                Next

                'lock row 1 (id row)
                flexgrid.Rows(1).AllowEditing = False
                If user = 0 And debug_headers = True Then  'only admin sees id row/edit+id col
                    flexgrid.Rows(1).Visible = True
                    flexgrid.Cols(0).Visible = True
                    flexgrid.Cols(1).Visible = True
                Else
                    flexgrid.Rows(1).Visible = False
                    flexgrid.Cols(0).Visible = False
                    flexgrid.Cols(1).Visible = False
                End If

                Conn.Close()
            End Using

        Catch ex As Exception

            LogSQLErrors(System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + ex.ToString, query)
            MessageBox.Show("Database fout: Build Table:" + tablename + " " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        flexgrid.EndUpdate()

        flexgrid.Cols(0).Filter = Nothing

        Return table

    End Function

    Private Sub ClearStyles(flexgrid As C1FlexGrid)
        For i = 0 To flexgrid.Styles.Count - 1
            Dim stylelabel As String = flexgrid.Styles.Item(i).Name
            If stylelabel = "EDIT" Or stylelabel = "TOTAL" Or stylelabel = "WHITE" Or stylelabel = "RED" Then
                ' skip defaults
            Else
                flexgrid.Styles.Item(i).Clear()
            End If
        Next
    End Sub

    Private Sub FlexgridAdd(flexgrid As C1FlexGrid, dbtable() As tablelayout, ByRef flexfill As Dictionary(Of String, Object), Optional flexwarning As Dictionary(Of String, Object) = Nothing)

        'add empty row
        flexgrid.Rows.Count = flexgrid.Rows.Count + 1
        Dim lastrow As Integer = flexgrid.Rows.Count - 1
        'fill row
        Dim value As Object = Nothing
        If (flexfill.TryGetValue("Id", value)) Then 'save id column
            flexgrid.Item(lastrow, 0) = value
        End If
        For i = 0 To dbtable.Count - 1  'save other columns
            Dim col As String = dbtable(i).columnname
            If col <> "" Then
                If (flexfill.TryGetValue(col, value)) Then
                    flexgrid.Item(lastrow, i + 2) = value
                End If
            End If
        Next

        If Not IsNothing(flexwarning) Then
            For i = 0 To dbtable.Count - 1
                Dim col As String = dbtable(i).columnname
                If col <> "" Then
                    If (flexwarning.TryGetValue(col, value)) Then
                        If value > 0 Then

                            Dim rs As C1.Win.C1FlexGrid.CellStyle
                            Dim stylename As String = "STYLE" + Tstr(i)
                            rs = flexgrid.Styles.Add(stylename)
                            If value = 1 Then rs.BackColor = Color.LightCoral
                            If value > 1 Then rs.BackColor = Color.Orange

                            Dim celformat() = dbtable(i).type.Split(New Char() {";"c})
                            If Trim(celformat(0)) <> "" Then
                                rs.DataType = System.Type.GetType(celformat(0))
                            End If
                            If UBound(celformat) = 1 Then
                                If Trim(celformat(1)) = "..." Then
                                    rs.ComboList = "..."
                                    rs.Format = ""
                                Else
                                    rs.Format = Trim(celformat(1))
                                End If
                            Else
                                rs.Format = ""
                            End If
                            flexgrid.SetCellStyle(lastrow, i + 2, stylename)

                        End If
                    End If
                End If
            Next
        End If

        flexfill.Clear()


    End Sub

    Private Sub FillTable(ByVal tablename As String, ByVal table() As tablelayout, ByVal flexgrid As C1FlexGrid, ByVal SQLQuery As String, Optional ByVal SQLWhere As String = "", Optional ByVal ClearGrid As Boolean = True)
        Dim query As String = ""
        flexgrid.BeginUpdate()
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' Left join
                Dim SQLLeftjoin As String = ""
                For i = 0 To UBound(table)
                    If table(i).leftjoin <> "" Then
                        Dim leftjoin() As String = table(i).leftjoin.Split(New Char() {":"c})
                        If leftjoin.Length = 3 Then
                            Dim leftcolumn As String = table(i).columnname
                            Dim jointable As String = leftjoin(0)
                            Dim joincolumn As String = leftjoin(1)
                            SQLLeftjoin = SQLLeftjoin + " LEFT JOIN " + jointable + " ON " + leftcolumn + "=" + jointable + "." + joincolumn + " "
                        End If
                        If leftjoin.Length = 4 Then
                            Dim leftcolumn As String = leftjoin(1)
                            Dim jointable As String = leftjoin(0)
                            Dim joincolumn As String = leftjoin(2)
                            SQLLeftjoin = SQLLeftjoin + " LEFT JOIN " + jointable + " ON " + leftcolumn + "=" + jointable + "." + joincolumn + " "
                        End If

                    End If
                Next


                ' Order by
                Dim SQLOrderBy As String = ""
                Dim firstrun As Boolean = True
                For j = 1 To 3
                    For i = 0 To UBound(table)
                        If table(i).order = j Then
                            If firstrun = False Then
                                SQLOrderBy = SQLOrderBy + ", "
                            Else
                                SQLOrderBy = " ORDER BY "
                            End If

                            Dim sortcolumnname = tablename + "." + table(i).columnname

                            'left join sorting 
                            If table(i).leftjoin <> "" Then
                                Dim leftjoin() As String = table(i).leftjoin.Split(New Char() {":"c})
                                If leftjoin.Length = 3 Then
                                    Dim jointable As String = leftjoin(0)
                                    Dim sortcolumn As String = leftjoin(2)
                                    sortcolumnname = jointable + "." + sortcolumn
                                End If
                                If leftjoin.Length = 4 Then
                                    Dim jointable As String = leftjoin(0)
                                    Dim sortcolumn As String = leftjoin(3)
                                    sortcolumnname = jointable + "." + sortcolumn
                                End If
                            End If

                            SQLOrderBy = SQLOrderBy + sortcolumnname
                            firstrun = False
                        End If
                    Next
                Next
                'Execute Query
                SQLWhere = " " + Trim(SQLWhere) + " "
                query = SQLQuery + SQLLeftjoin + SQLWhere + SQLOrderBy
                Dim Cmd As New OdbcCommand(query, Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmd.ExecuteReader()

                If ClearGrid = True Then
                    flexgrid.Rows.Count = 2
                End If

                Do While Reader.Read
                    Dim gridfill(UBound(table) + 2) As Object
                    gridfill(0) = CHint(Reader("id"))  'line id
                    gridfill(1) = False                'edit flag

                    Dim colcount As Integer = 2
                    For i = 0 To UBound(table)


                        Dim column As String = table(i).columnname
                        Dim type As String = table(i).type
                        Dim defaultvalue As String = table(i).defaultvalue

                        Dim celformat() = table(i).type.Split(New Char() {";"c})
                        celformat(0) = Trim(celformat(0))
                        If UBound(celformat) > 1 Then
                            celformat(1) = Trim(celformat(1))
                        End If

                        If celformat(0) = "System.Int32" Then
                            If column = "EMPTY" Then
                                gridfill(colcount) = 0
                            Else
                                gridfill(colcount) = CHint(Reader(column))
                            End If
                        ElseIf celformat(0) = "System.String" Then
                            If column = "EMPTY" Then
                                gridfill(colcount) = ""
                            Else
                                gridfill(colcount) = CHstr(Reader(column))
                            End If
                        ElseIf celformat(0) = "System.Boolean" Then
                            If column = "SELECT" Or column = "DELETE" Then 'reserved columname for selection/delete (no read,false)
                                gridfill(colcount) = False
                            Else
                                gridfill(colcount) = CHbool(Reader(column))
                            End If
                        ElseIf celformat(0) = "System.DateTime" Then

                            If celformat(1) = "t" Then
                                gridfill(colcount) = CHstr(Reader(column))
                            Else
                                Dim defaultdate As Date
                                If defaultvalue = "Now" Then
                                    defaultdate = CDate(Now.ToShortDateString)
                                ElseIf defaultvalue = "Now+1" Then
                                    Dim nextyear As Date = DateAdd("yyyy", 1, Now)
                                    defaultdate = CDate(nextyear.ToShortDateString)
                                Else
                                    Dim splitdate() As String = defaultvalue.Split(New Char() {"-"c})
                                    defaultdate = New Date(CInt(splitdate(2)), CInt(splitdate(1)), CInt(splitdate(0)))
                                End If
                                gridfill(colcount) = CHDate2(Reader(column), defaultdate)
                            End If

                        ElseIf celformat(0) = "System.Decimal" Then
                            If column = "EMPTY" Then
                                gridfill(colcount) = 0
                            Else
                                gridfill(colcount) = CHdouble(Reader(column))
                            End If
                        Else
                            MsgBox("Type not found for table :" + column)
                        End If

                        colcount = colcount + 1


                    Next


                    flexgrid.AddItem(gridfill)

                Loop


                'add hide filter?
                For i = 0 To UBound(table)
                    Dim column As String = table(i).columnname
                    If column = "hide" Then
                        Dim filter = New C1.Win.C1FlexGrid.ConditionFilter()
                        filter.Condition1.Operator = C1.Win.C1FlexGrid.ConditionOperator.Equals
                        filter.Condition1.Parameter = False
                        filter.AndConditions = True
                        filter.Condition2.Operator = C1.Win.C1FlexGrid.ConditionOperator.None
                        flexgrid.Cols(2 + i).Filter = filter


                    End If
                Next

                Conn.Close()
            End Using
        Catch ex As Exception
            LogSQLErrors(System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + ex.ToString, query)
            MessageBox.Show("Database fout: fill table " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        flexgrid.EndUpdate()

    End Sub

    Private Sub NewItem(ByVal table() As tablelayout, ByVal flexgrid As C1FlexGrid, Optional ByVal idcolumn As String = "", Optional ByVal idvalue As Integer = 0)

        If IsNothing(table) Then
            MsgBox("Table not build")
            Exit Sub
        End If

        Dim gridfill(UBound(table) + 2) As Object
        gridfill(0) = -1     'id
        gridfill(1) = True   'edit flag

        Dim colcount As Integer = 2

        For i = 0 To UBound(table)

            Dim column As String = table(i).columnname
            Dim type As String = table(i).type
            Dim defaultvalue As String = table(i).defaultvalue

            Dim celformat() = table(i).type.Split(New Char() {";"c})
            celformat(0) = Trim(celformat(0))
            If UBound(celformat) > 1 Then
                celformat(1) = Trim(celformat(1))
            End If

            If celformat(0) = "System.Int32" Then
                If idcolumn = column Then
                    gridfill(colcount) = idvalue
                Else
                    gridfill(colcount) = defaultvalue
                End If
            ElseIf celformat(0) = "System.String" Then
                gridfill(colcount) = defaultvalue
                If defaultvalue = "Now" Then
                    If column.Contains("jaar") Then
                        gridfill(colcount) = Trim(Str(Year(Now)))
                    End If
                    If column.Contains("week") Then
                        gridfill(colcount) = Trim(Str(WeeknumberFromDate(Now)))
                    End If
                End If
            ElseIf celformat(0) = "System.Boolean" Then
                gridfill(colcount) = defaultvalue
            ElseIf celformat(0) = "System.DateTime" Then

                If celformat(1) = "t" Then 'time
                    gridfill(colcount) = defaultvalue
                Else
                    Dim defaultdate As Date
                    If defaultvalue = "Now" Then
                        defaultdate = CDate(Now.ToShortDateString)
                    ElseIf defaultvalue = "Now+1" Then
                        Dim nextyear As Date = DateAdd("yyyy", 1, Now)
                        defaultdate = CDate(nextyear.ToShortDateString)
                    Else
                        Dim splitdate() As String = defaultvalue.Split(New Char() {"-"c})
                        defaultdate = New Date(CInt(splitdate(2)), CInt(splitdate(1)), CInt(splitdate(0)))
                    End If
                    gridfill(colcount) = defaultdate
                End If
            ElseIf celformat(0) = "System.Decimal" Then
                gridfill(colcount) = defaultvalue
            Else
                MsgBox("Type not found for table :" + column)
            End If

            colcount = colcount + 1

        Next

        Dim selectedrow As Integer = flexgrid.RowSel
        If selectedrow >= 2 Then
            flexgrid.AddItem(gridfill)
            flexgrid.Rows(flexgrid.Rows.Count - 1).Move(selectedrow + 1)
            flexgrid.Rows(selectedrow + 1).Style = flexgrid.Styles("EDIT")
            flexgrid.Select(selectedrow + 1, 2)
        Else
            flexgrid.AddItem(gridfill)
            flexgrid.Rows(flexgrid.Rows.Count - 1).Move(2)
            flexgrid.Rows(2).Style = flexgrid.Styles("EDIT")
            flexgrid.Select(2, 2)
        End If


    End Sub

    Private Sub CopyItem(ByVal tablename As String, ByVal table() As tablelayout, ByVal flexgrid As C1FlexGrid, Optional ByVal Name_column As String = "")
        Dim query As String = ""
        If IsNothing(table) Then
            MsgBox("Table not build")
            Exit Sub
        End If

        Dim selectedrow As Integer = flexgrid.RowSel
        If selectedrow >= 2 Then
            Dim id As Integer = CType(flexgrid.GetData(selectedrow, 0), Integer)

            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'Execute Query
                    query = "SELECT * FROM " + tablename + " WHERE id = " + Str(id)
                    Dim Cmd As New OdbcCommand(query, Conn)
                    Dim Reader As OdbcDataReader
                    Reader = Cmd.ExecuteReader()

                    If Reader.HasRows Then
                        Dim gridfill(UBound(table) + 2) As Object

                        gridfill(0) = -1     'edit flag
                        gridfill(1) = True   'edit flag

                        Dim colcount As Integer = 2
                        For i = 0 To UBound(table)

                            Dim column As String = table(i).columnname
                            Dim type As String = table(i).type
                            Dim defaultvalue As String = table(i).defaultvalue

                            Dim celformat() = table(i).type.Split(New Char() {";"c})
                            celformat(0) = Trim(celformat(0))
                            If UBound(celformat) > 1 Then
                                celformat(1) = Trim(celformat(1))
                            End If

                            If celformat(0) = "System.Int32" Then
                                If column = "EMPTY" Then
                                    gridfill(colcount) = 0
                                Else
                                    gridfill(colcount) = CHint(Reader(column))
                                End If
                            ElseIf celformat(0) = "System.String" Then
                                If column = "EMPTY" Then
                                    gridfill(colcount) = ""
                                Else
                                    gridfill(colcount) = CHstr(Reader(column))
                                    If column = Name_column Then
                                        gridfill(colcount) = CHstr(Reader(column)) + " (kopie)"
                                    End If
                                End If
                            ElseIf celformat(0) = "System.Boolean" Then
                                If column = "SELECT" Or column = "DELETE" Then 'reserved columname for selections (no read,false)
                                    gridfill(colcount) = False
                                Else
                                    gridfill(colcount) = CHbool(Reader(column))
                                End If
                            ElseIf celformat(0) = "System.DateTime" Then
                                If celformat(1) = "t" Then 'time
                                    gridfill(colcount) = CHstr(Reader(column))
                                Else
                                    Dim defaultdate As Date
                                    If defaultvalue = "Now" Then
                                        defaultdate = CDate(Now.ToShortDateString)
                                    ElseIf defaultvalue = "Now+1" Then
                                        Dim nextyear As Date = DateAdd("yyyy", 1, Now)
                                        defaultdate = CDate(nextyear.ToShortDateString)
                                    Else
                                        Dim splitdate() As String = defaultvalue.Split(New Char() {"-"c})
                                        defaultdate = New Date(CInt(splitdate(2)), CInt(splitdate(1)), CInt(splitdate(0)))
                                    End If
                                    gridfill(colcount) = CHDate2(Reader(column), defaultdate)
                                End If
                            ElseIf celformat(0) = "System.Decimal" Then
                                If column = "EMPTY" Then
                                    gridfill(colcount) = 0
                                Else
                                    gridfill(colcount) = CHdouble(Reader(column))
                                End If
                            Else
                                MsgBox("Type not found for table :" + column)
                            End If

                            colcount = colcount + 1

                        Next
                        flexgrid.AddItem(gridfill)
                        flexgrid.Rows(flexgrid.Rows.Count - 1).Move(selectedrow + 1)
                        flexgrid.Rows(selectedrow + 1).Style = flexgrid.Styles("EDIT")
                        flexgrid.Select(selectedrow + 1, 2)
                    End If

                    Conn.Close()
                End Using
            Catch ex As Exception
                LogSQLErrors(System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + ex.ToString, query)
                MessageBox.Show("Database fout: copy artikelen " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try


        End If


    End Sub

    Private Function SaveItem(ByVal tablename As String, ByVal table() As tablelayout, ByVal flexgrid As C1FlexGrid, Optional ByRef silent As Boolean = False) As Integer

        Dim return_id As Integer = -1
        Dim query As String = ""

        If IsNothing(table) Then
            MsgBox("Table not build")
            Return return_id
        End If

        Try

            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For row = 2 To flexgrid.Rows.Count - 1
                    If CType(flexgrid.Item(row, 1), Boolean) = True Then   'Row edited? 

                        Dim row_id As Integer = CType(flexgrid.Item(row, 0), Integer)

                        If row_id < 0 Then

                            'new
                            Dim sql As String = ""
                            Dim cmd As New OdbcCommand(sql, Conn)
                            cmd.Parameters.Clear()


                            Dim command1 As String = "INSERT INTO " + tablename + " ("
                            Dim command2 As String = ") VALUES("

                            Dim firstrun As Boolean = True
                            Dim delete_entry As Boolean = False

                            For col = 2 To flexgrid.Cols.Count - 1

                                Dim columnidstr As String = CType(flexgrid.Item(1, col), String)   'column id en order id in een regel  id:order
                                Dim columnids() As String = columnidstr.Split(New Char() {":"c})

                                Dim columnid As Integer = CType(columnids(0), Integer)
                                'Dim columnid As Integer = CType(flexgrid.Item(1, col), Integer)

                                For i = 0 To UBound(table)

                                    If table(i).id = columnid Then

                                        Dim column As String = table(i).columnname

                                        If column = "DELETE" Then
                                            If CType(flexgrid.Item(row, col), Boolean) = True Then
                                                delete_entry = True
                                            End If
                                        End If
                                        Dim info As Boolean = table(i).info  'don't save info columns
                                        If info = True Then
                                            Exit For
                                        End If

                                        If firstrun = True Then
                                            firstrun = False
                                            command2 = command2 + "?"
                                        Else
                                            command1 = command1 + ", "
                                            command2 = command2 + ",?"
                                        End If

                                        Dim type As String = table(i).type
                                        Dim defaultvalue As String = table(i).defaultvalue

                                        Dim celformat() = table(i).type.Split(New Char() {";"c})
                                        celformat(0) = Trim(celformat(0))
                                        If UBound(celformat) > 1 Then
                                            celformat(1) = Trim(celformat(1))
                                        End If

                                        If celformat(0) = "System.Int32" Then
                                            command1 = command1 + column
                                            cmd.Parameters.AddWithValue("", CType(flexgrid.Item(row, col), Integer))
                                        ElseIf celformat(0) = "System.String" Then
                                            command1 = command1 + column
                                            Dim savestring As String = Trim(CType(flexgrid.Item(row, col), String))
                                            If table(i).maxcharlength > 0 Then
                                                savestring = Mid(savestring, 1, table(i).maxcharlength)
                                            End If
                                            cmd.Parameters.AddWithValue("", savestring)
                                        ElseIf celformat(0) = "System.Boolean" Then
                                            command1 = command1 + column
                                            cmd.Parameters.AddWithValue("", CType(flexgrid.Item(row, col), Boolean))
                                        ElseIf celformat(0) = "System.DateTime" Then
                                            If celformat(1) = "t" Then 'time
                                                command1 = command1 + column
                                                Dim timestr As String = Trim(CType(flexgrid.Item(row, col), String))
                                                timestr = Mid(timestr, Len(timestr) - 7)
                                                cmd.Parameters.AddWithValue("", timestr)
                                            Else
                                                Dim flexdate As String = Trim(CType(flexgrid.Item(row, col), String))
                                                Dim splitdate = flexdate.Split(New Char() {"-"c})
                                                Dim hour As Integer = 0
                                                Dim minutes As Integer = 0
                                                Dim year As String = splitdate(2)
                                                If Len(year) > 4 Then
                                                    Dim splityear = year.Split(New Char() {" "c})
                                                    Dim splittime = splityear(1).Split(New Char() {":"c})
                                                    year = splityear(0)
                                                    hour = CInt(splittime(0))
                                                    minutes = CInt(splittime(1))
                                                End If
                                                Dim newdate As DateTime = New DateTime(CInt(year), CInt(splitdate(1)), CInt(splitdate(0)), hour, minutes, 0)
                                                command1 = command1 + column
                                                cmd.Parameters.AddWithValue("", newdate)
                                            End If
                                        ElseIf celformat(0) = "System.Decimal" Then
                                            command1 = command1 + column
                                            cmd.Parameters.AddWithValue("", CType(flexgrid.Item(row, col), Double))
                                        Else
                                            MsgBox("Type not found for table :" + column)
                                        End If

                                        'End If
                                        Exit For
                                    End If


                                Next

                            Next
                            '  .CommandText = "INSERT INTO table(x1,y1) VALUES(?,?)"
                            If delete_entry = False Then
                                ' new entry
                                query = command1 + command2 + ")"
                                cmd.CommandText = query
                                cmd.ExecuteNonQuery()

                                'LogSQLErrors("Save Insert Into", query)

                                If postgress = True Then
                                    Dim Cmd6 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('" + tablename + "','id'))", Conn)
                                    return_id = Convert.ToInt32(Cmd6.ExecuteScalar())
                                Else
                                    Dim Cmd6 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                    return_id = Convert.ToInt32(Cmd6.ExecuteScalar())
                                End If
                            Else
                                'don't save (delete set)
                                return_id = -1
                            End If

                        Else
                            'edit

                            Dim sql As String = ""
                            Dim cmd As New OdbcCommand(sql, Conn)
                            cmd.Parameters.Clear()

                            Dim command As String = "UPDATE " + tablename + " SET "
                            Dim firstrun As Boolean = True
                            Dim delete_entry As Boolean = False

                            For col = 2 To flexgrid.Cols.Count - 1

                                Dim columnidstr As String = CType(flexgrid.Item(1, col), String)   'column id en order id in een regel  id:order
                                Dim columnids() As String = columnidstr.Split(New Char() {":"c})

                                Dim columnid As Integer = CType(columnids(0), Integer)

                                For i = 0 To UBound(table)

                                    If table(i).id = columnid Then

                                        If (table(i).visible = True And table(i).edit = True) Or (user = 0 And table(i).edit = True) Then

                                            Dim column As String = table(i).columnname
                                            'If column = "SELECT" Then 'don't save select column
                                            'Exit For
                                            'End If
                                            If column = "DELETE" Then
                                                If CType(flexgrid.Item(row, col), Boolean) = True Then
                                                    delete_entry = True
                                                End If
                                                'Exit For
                                            End If
                                            Dim info As Boolean = table(i).info  'don't save info columns
                                            If info = True Then
                                                Exit For
                                            End If

                                            If firstrun = True Then
                                                firstrun = False
                                            Else
                                                command = command + ", "
                                            End If

                                            Dim type As String = table(i).type
                                            Dim defaultvalue As String = table(i).defaultvalue

                                            Dim celformat() = table(i).type.Split(New Char() {";"c})
                                            celformat(0) = Trim(celformat(0))
                                            If UBound(celformat) > 1 Then
                                                celformat(1) = Trim(celformat(1))
                                            End If

                                            If celformat(0) = "System.Int32" Then
                                                command = command + column + "=?"
                                                cmd.Parameters.AddWithValue("", CType(flexgrid.Item(row, col), Integer))
                                            ElseIf celformat(0) = "System.String" Then
                                                command = command + column + "=?"
                                                Dim savestring As String = Trim(CType(flexgrid.Item(row, col), String))
                                                If table(i).maxcharlength > 0 Then
                                                    savestring = Mid(savestring, 1, table(i).maxcharlength)
                                                End If
                                                cmd.Parameters.AddWithValue("", savestring)
                                            ElseIf celformat(0) = "System.Boolean" Then
                                                command = command + column + "=?"
                                                cmd.Parameters.AddWithValue("", CType(flexgrid.Item(row, col), Boolean))
                                            ElseIf celformat(0) = "System.DateTime" Then
                                                If celformat(1) = "t" Then 'time
                                                    command = command + column + "=?"
                                                    Dim timestr As String = Trim(CType(flexgrid.Item(row, col), String))
                                                    timestr = Mid(timestr, Len(timestr) - 7)
                                                    cmd.Parameters.AddWithValue("", timestr)
                                                Else
                                                    Dim flexdate As String = Trim(CType(flexgrid.Item(row, col), String))
                                                    Dim splitdate = flexdate.Split(New Char() {"-"c})
                                                    Dim hour As Integer = 0
                                                    Dim minutes As Integer = 0
                                                    Dim year As String = splitdate(2)
                                                    If Len(year) > 4 Then
                                                        Dim splityear = year.Split(New Char() {" "c})
                                                        Dim splittime = splityear(1).Split(New Char() {":"c})
                                                        year = splityear(0)
                                                        hour = CInt(splittime(0))
                                                        minutes = CInt(splittime(1))
                                                    End If
                                                    Dim newdate As DateTime = New DateTime(CInt(year), CInt(splitdate(1)), CInt(splitdate(0)), hour, minutes, 0)
                                                    command = command + column + "=?"
                                                    cmd.Parameters.AddWithValue("", newdate)
                                                End If
                                            ElseIf celformat(0) = "System.Decimal" Then
                                                command = command + column + "=?"
                                                cmd.Parameters.AddWithValue("", CType(flexgrid.Item(row, col), Double))
                                            Else
                                                MsgBox("Type not found for table :" + column)
                                            End If

                                        End If
                                        Exit For
                                    End If


                                Next

                            Next
                            If delete_entry = False Then
                                command = command + " WHERE id=?"
                                cmd.Parameters.AddWithValue("", row_id)
                                cmd.CommandText = command
                                query = command
                                cmd.ExecuteNonQuery()

                                'LogSQLErrors("Save UPDATE", query)

                                return_id = row_id

                                'erase edit flag & set id
                                flexgrid.Item(row, 1) = False
                                flexgrid.Item(row, 0) = return_id
                            Else
                                If row_id > 0 Then
                                    command = "DELETE FROM " + tablename + " WHERE id=?"
                                    cmd.Parameters.Clear()
                                    cmd.Parameters.AddWithValue("", row_id)
                                    cmd.CommandText = command
                                    query = command
                                    cmd.ExecuteNonQuery()
                                    flexgrid.Item(row, 0) = -2 'delete flag
                                    return_id = -1
                                End If
                            End If

                        End If

                        'reset color
                        For i = 1 To flexgrid.Rows.Count - 1
                            flexgrid.Rows(i).Style = flexgrid.Styles("WHITE")
                        Next


                    End If

                Next

                'remove rows that are deleted
                Dim delete_done As Boolean = False
                Dim totalrow As Integer = flexgrid.Rows.Count
                Dim rowcount As Integer = 2
                Do While rowcount < totalrow
                    If CType(flexgrid.Item(rowcount, 0), Integer) = -2 Then
                        flexgrid.RemoveItem(rowcount)
                        totalrow = totalrow - 1
                    Else
                        rowcount = rowcount + 1
                    End If
                Loop

                Conn.Close()
                If silent = False Then
                    MsgBox("Tabel bijgewerkt.")
                End If
            End Using
        Catch ex As Exception
            LogSQLErrors(System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + ex.ToString, query)
            MsgBox("Database error ->Tabel bijwerken:" + tablename + "- " + ex.Message)
        End Try

        Return return_id

    End Function

    Private Sub AfterEdit(ByVal flexgrid As C1FlexGrid)
        Dim selectedrow As Integer = flexgrid.RowSel
        If selectedrow >= 2 Then
            flexgrid.Item(selectedrow, 1) = True
            flexgrid.Rows(selectedrow).Style = flexgrid.Styles("EDIT")
        End If
    End Sub

    Private Sub CopyChildTable(ByVal tablename As String, ByVal table() As tablelayout, ByVal tablecolumn As String, ByVal source_id As Integer, ByVal target_id As Integer)

        Dim query As String = ""
        Try

            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'INSERT INTO web_book( 
                '     page_count, year_published, File, Image,
                '     display_on_hp, Name, description, name_cs,
                '     name_en, description_cs, description_en
                '     )
                'SELECT page_count,year_published, File, Image,
                '       display_on_hp, Name, description, name_cs,
                '       name_en, description_cs, description_en
                'FROM web_book WHERE id=3;

                Dim Sql As String = "INSERT INTO " + tablename + "("
                Dim firstrun As Boolean = True
                For i = 0 To UBound(table) - 1

                    If table(i).info = True Then 'don't copy info column
                        'skip
                    Else
                        If table(i).columnname = "id" Or table(i).columnname = tablecolumn Then
                            'skip
                        Else
                            If firstrun = False Then
                                Sql = Sql + ", "
                            Else
                                firstrun = False
                            End If
                            Sql = Sql + table(i).columnname
                        End If
                    End If
                Next
                Sql = Sql + ") SELECT "
                firstrun = True
                For i = 0 To UBound(table) - 1

                    If table(i).info = True Then 'don't copy info column
                        'skip
                    Else
                        If table(i).columnname = "id" Or table(i).columnname = tablecolumn Then
                            'skip
                        Else
                            If firstrun = False Then
                                Sql = Sql + ", "
                            Else
                                firstrun = False
                            End If
                            Sql = Sql + table(i).columnname
                        End If
                    End If
                Next

                Sql = Sql + " FROM " + tablename + " WHERE " + tablecolumn + "=" + Str(source_id)

                Dim cmd As New OdbcCommand(Sql, Conn)
                query = Sql
                cmd.ExecuteNonQuery()

                ' change parent id on copied lines (default parent id=0 -> change 0 to targetid)
                Dim sql2 As String = "UPDATE " + tablename + " SET " + tablecolumn + "=" + Str(target_id) + " WHERE " + tablecolumn + "=0"
                Dim cmd2 As New OdbcCommand(sql2, Conn)
                query = sql2
                cmd2.ExecuteNonQuery()


                Conn.Close()

            End Using
        Catch ex As Exception
            LogSQLErrors(System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + ex.ToString, query)
            MsgBox("Database error ->Child Tabel kopieren:" + tablename + "- " + ex.Message)
        End Try



    End Sub

    Private Sub LogSQLErrors(ByVal errorstr As String, ByVal sqlquery As String)
        Try

            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'save errors

                Dim Cmd2 As New OdbcCommand("INSERT INTO sqlerrors(datum,error,query) VALUES(?,?,?)", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                Cmd2.Parameters.AddWithValue("", Mid(errorstr, 1, 499))
                Cmd2.Parameters.AddWithValue("", Mid(sqlquery, 1, 499))
                Cmd2.ExecuteNonQuery()

                Conn.Close()
            End Using
        Catch ex As Exception
            MessageBox.Show("Database fout: log errors:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Private Function FindCol(flexgrid As C1FlexGrid, colname As String) As Integer
        Dim returncol As Integer = 2
        For i = 2 To flexgrid.Cols.Count - 1
            If CStr(flexgrid.Item(0, i)).ToLower = colname.ToLower Then
                returncol = i
                Return returncol
            End If
            If colname = "Aantal" Then
                Dim totlabel = Mid(CStr(flexgrid.Item(0, i)).ToLower, 1, 2)
                If totlabel = "a#" Then
                    returncol = i
                    Return returncol
                End If
            End If
        Next
        MsgBox("Column not found: " + colname)
        Return returncol
    End Function

#End Region

#Region "Treeview"
    ' BoekTree

    Public Sub Set_Boek_reload()
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "SELECT * FROM instellingen"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                With Cmd
                    .CommandText = "UPDATE instellingen SET Boek_reload = Boek_reload + 1"
                    .ExecuteNonQuery()

                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        Boek_reload_counter = CHint(Reader("Boek_reload"))
                    End If

                End With
            End Using
        Catch ex As Exception
            ErrorLog("Boek-Tree reload error" + ex.Message)
            MsgBox("Boek-Tree reload error" + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub
    Private Function Check_Boek_reload() As Boolean
        Dim Reader As OdbcDataReader
        Dim checkcounter As Integer
        Dim CmdString As String = "SELECT * from instellingen"
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    checkcounter = CHint(Reader("Boek_reload"))
                    Reader.Close()
                    If checkcounter > 10000 Then
                        With Cmd
                            .CommandText = "UPDATE instellingen SET Boek_reload = 0"
                            .ExecuteNonQuery()
                        End With
                    End If
                End If
                Reader.Close()
            End Using
        Catch ex As Exception
            ErrorLog("Boek-Tree fout:Instellingen/Reload" + ex.Message)
            MessageBox.Show("Boek-Tree fout:Instellingen/Reload" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Dim reload = False
        If checkcounter <> Boek_reload_counter Then
            inst_boekreload_lbl.Text = "Reload : True"
            reload = True
            Update_Boek()
        Else
            inst_boekreload_lbl.Text = "Reload : False"
        End If
        Boek_reload_counter = checkcounter
        Return reload
    End Function
    Private Sub TreeView1_MouseDown(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles TreeView1.MouseDown
        If e.Button = MouseButtons.Right Then
            Me.Tree_MenuStrip.Show(Me.TreeView1, e.Location)
        End If
    End Sub
    Private Sub Set_BoekInstellingen(ByVal b_sortering As Integer, ByVal b_tijddisplay As Integer, ByVal b_status As Integer)
        If b_sortering > 0 Then BoekSortering = b_sortering 'global vars
        If b_tijddisplay > 0 Then BoekDisplayTijd = b_tijddisplay
        If b_status > 0 Then BoekStatus = b_status
        If b_sortering = 1 Then
            TreeMenu_SortInvoer.Text = "Sorteren op invoer *"
            TreeMenu_SortStatus.Text = "Sorteren op status"
            TreeMenu_SortAlfabet.Text = "Sorteren op alfabet"
            TreeMenu_SortLoc.Text = "Sorteren op afleverlocatie"
        End If
        If b_sortering = 2 Then
            TreeMenu_SortInvoer.Text = "Sorteren op invoer"
            TreeMenu_SortStatus.Text = "Sorteren op status"
            TreeMenu_SortAlfabet.Text = "Sorteren op alfabet *"
            TreeMenu_SortLoc.Text = "Sorteren op afleverlocatie"
        End If
        If b_sortering = 3 Then
            TreeMenu_SortInvoer.Text = "Sorteren op invoer"
            TreeMenu_SortStatus.Text = "Sorteren op status"
            TreeMenu_SortAlfabet.Text = "Sorteren op alfabet"
            TreeMenu_SortLoc.Text = "Sorteren op afleverlocatie *"
        End If
        If b_sortering = 4 Then
            TreeMenu_SortInvoer.Text = "Sorteren op invoer"
            TreeMenu_SortStatus.Text = "Sorteren op status *"
            TreeMenu_SortAlfabet.Text = "Sorteren op alfabet"
            TreeMenu_SortLoc.Text = "Sorteren op afleverlocatie"
        End If
        Select Case b_tijddisplay
            Case 1
                TreeMenu_TijdAlles.Text = "Tijd : Alles tonen *"
                TreeMenu_Tijd10.Text = "Tijd : Vanaf 10 uur"
                TreeMenu_Tijd13.Text = "Tijd : Vanaf 13 uur"
                Tree_Tijd_lbl.Text = "Tijd: Alles tonen"
            Case 2
                TreeMenu_TijdAlles.Text = "Tijd : Alles tonen"
                TreeMenu_Tijd10.Text = "Tijd : Vanaf 10 uur *"
                TreeMenu_Tijd13.Text = "Tijd : Vanaf 13 uur"
                Tree_Tijd_lbl.Text = "Tijd: Vanaf 10:00 uur"
            Case 3
                TreeMenu_TijdAlles.Text = "Tijd : Alles tonen"
                TreeMenu_Tijd10.Text = "Tijd : Vanaf 10 uur"
                TreeMenu_Tijd13.Text = "Tijd : Vanaf 13 uur *"
                Tree_Tijd_lbl.Text = "Tijd: Vanaf 13:00 uur"
        End Select
        Select Case b_status
            Case 1
                TreeMenu_StatusAlles.Text = "Status : Alles *"
                TreeMenu_StatusNieuw.Text = "Status : Nieuw"
                TreeMenu_StatusIngepakt.Text = "Status : Sdf verstuurd"
                TreeMenu_StatusNenI.Text = "Status : Nieuw & WPS"
                TreeMenu_StatusVerkort.Text = "Status : Verkort"
                TreeMenu_StatusVracht.Text = "Status : Vracht bepalen"
                TreeMenu_StatusGeannuleerd.Text = "Status : Geannuleerd"
                Tree_Status_lbl.Text = "Status : Alles"
            Case 2
                TreeMenu_StatusAlles.Text = "Status : Alles"
                TreeMenu_StatusNieuw.Text = "Status : Nieuw *"
                TreeMenu_StatusIngepakt.Text = "Status : Sdf verstuurd"
                TreeMenu_StatusNenI.Text = "Status : Nieuw & WPS"
                TreeMenu_StatusVerkort.Text = "Status : Verkort"
                TreeMenu_StatusVracht.Text = "Status : Vracht bepalen"
                TreeMenu_StatusGeannuleerd.Text = "Status : Geannuleerd"
                Tree_Status_lbl.Text = "Status : Nieuw"
            Case 3
                TreeMenu_StatusAlles.Text = "Status : Alles"
                TreeMenu_StatusNieuw.Text = "Status : Nieuw"
                TreeMenu_StatusIngepakt.Text = "Status : Sdf verstuurd *"
                TreeMenu_StatusNenI.Text = "Status : Nieuw & WPS"
                TreeMenu_StatusVerkort.Text = "Status : Verkort"
                TreeMenu_StatusVracht.Text = "Status : Vracht bepalen"
                TreeMenu_StatusGeannuleerd.Text = "Status : Geannuleerd"
                Tree_Status_lbl.Text = "Status : SDF verstuurd"
            Case 4
                TreeMenu_StatusAlles.Text = "Status : Alles"
                TreeMenu_StatusNieuw.Text = "Status : Nieuw"
                TreeMenu_StatusIngepakt.Text = "Status : Sdf verstuurd"
                TreeMenu_StatusNenI.Text = "Status : Nieuw & WPS"
                TreeMenu_StatusVerkort.Text = "Status : Verkort"
                TreeMenu_StatusVracht.Text = "Status : Vracht bepalen"
                TreeMenu_StatusGeannuleerd.Text = "Status : Geannuleerd *"
                Tree_Status_lbl.Text = "Status : Geannuleerd"
            Case 5
                TreeMenu_StatusAlles.Text = "Status : Alles"
                TreeMenu_StatusNieuw.Text = "Status : Nieuw"
                TreeMenu_StatusIngepakt.Text = "Status : Sdf verstuurd"
                TreeMenu_StatusNenI.Text = "Status : Nieuw & WPS *"
                TreeMenu_StatusVerkort.Text = "Status : Verkort"
                TreeMenu_StatusVracht.Text = "Status : Vracht bepalen"
                TreeMenu_StatusGeannuleerd.Text = "Status : Geannuleerd"
                Tree_Status_lbl.Text = "Status : Nieuw & WPS"
            Case 6
                TreeMenu_StatusAlles.Text = "Status : Alles"
                TreeMenu_StatusNieuw.Text = "Status : Nieuw"
                TreeMenu_StatusIngepakt.Text = "Status : Sdf verstuurd"
                TreeMenu_StatusNenI.Text = "Status : Nieuw & WPS"
                TreeMenu_StatusVerkort.Text = "Status : Verkort *"
                TreeMenu_StatusVracht.Text = "Status : Vracht bepalen"
                TreeMenu_StatusGeannuleerd.Text = "Status : Geannuleerd"
                Tree_Status_lbl.Text = "Status : Verkort"
            Case 6
                TreeMenu_StatusAlles.Text = "Status : Alles"
                TreeMenu_StatusNieuw.Text = "Status : Nieuw"
                TreeMenu_StatusIngepakt.Text = "Status : Sdf verstuurd"
                TreeMenu_StatusNenI.Text = "Status : Nieuw & WPS"
                TreeMenu_StatusVerkort.Text = "Status : Verkort *"
                TreeMenu_StatusVracht.Text = "Status : Vracht bepalen*"
                TreeMenu_StatusGeannuleerd.Text = "Status : Geannuleerd"
                Tree_Status_lbl.Text = "Status : Vracht"
        End Select
    End Sub
    Private Sub TreeMenu_SortInvoer_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_SortInvoer.Click
        Set_BoekInstellingen(1, 0, 0)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_SortAlfabet_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_SortAlfabet.Click
        Set_BoekInstellingen(2, 0, 0)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_SortStatus_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_SortStatus.Click
        Set_BoekInstellingen(4, 0, 0)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_TijdAlles_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_TijdAlles.Click
        Set_BoekInstellingen(0, 1, 0)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_Tijd10_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_Tijd10.Click
        Set_BoekInstellingen(0, 2, 0)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_Tijd13_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_Tijd13.Click
        Set_BoekInstellingen(0, 3, 0)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_StatusAlles_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_StatusAlles.Click
        Set_BoekInstellingen(0, 0, 1)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_StatusNieuw_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_StatusNieuw.Click
        Set_BoekInstellingen(0, 0, 2)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_StatusNenI_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_StatusNenI.Click
        Set_BoekInstellingen(0, 0, 5)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_StatusVerkort_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_StatusVerkort.Click
        Set_BoekInstellingen(0, 0, 6)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_StatusIngepakt_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_StatusIngepakt.Click
        Set_BoekInstellingen(0, 0, 3)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_StatusVracht_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_StatusVracht.Click
        Set_BoekInstellingen(0, 0, 7)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_SortLoc_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_SortLoc.Click
        Set_BoekInstellingen(3, 0, 0)
        Update_Boek()
    End Sub
    Private Sub Order_MonthCalendar_DateChanged(ByVal sender As System.Object, ByVal e As System.Windows.Forms.DateRangeEventArgs) Handles Order_MonthCalendar.DateChanged
        Tree_Datum_lbl.Text = Order_MonthCalendar.SelectionStart.ToString("dddd, dd MMMM yyyy")

        If Not Order_zoeken_chk.Checked And user_date_change = True Then

            Order_MonthCalendar.SelectionEnd = Order_MonthCalendar.SelectionStart

            If Weekday(Order_MonthCalendar.SelectionStart, FirstDayOfWeek.Monday) = 5 Then  'vrijdag
                    user_date_change = False
                    Order_MonthCalendar.SelectionEnd = DateAdd("d", 2, Order_MonthCalendar.SelectionStart)
                    user_date_change = True
                End If

                'Tree_Datum_lbl.Text = Order_MonthCalendar.SelectionStart.ToString("dddd, dd MMMM yyyy")
                Update_Boek()
            End If
    End Sub

    Public Sub Update_Boek(Optional ByVal expand_header As Integer = 0, Optional ByVal koper_ean As String = "", Optional ByVal new_order_header As Integer = 0)
        TreeView1.CheckBoxes = True
        '***************************************************
        ' Laad boek tree
        '***************************************************
        Dim sdf_statuscounter As Integer = 1  ' sdf statuscounter voor scrollen
        Dim sdf_statusflag As Boolean = True

        Dim aantal_denen As Integer = 0
        Dim aantal_deenseplaten As Integer = 0
        Dim aantal_vkar As Integer = 0

        ' ******* fetch start/end datum *****
        Dim Start_datum As Date
        Dim End_datum As Date
        Start_datum = Order_MonthCalendar.SelectionStart
        End_datum = Order_MonthCalendar.SelectionEnd
        If End_datum < Start_datum Then
            End_datum = Start_datum
        End If

        If jenptenhave = True And Start_datum.DayOfWeek = 5 Then  'op vrijdag ook zaterdag en zondag laten zien
            If End_datum.Date = Start_datum.Date Then
                End_datum = DateAdd("d", 2, End_datum)
            End If
        End If

        Dim Start_DatumStr As String = Start_datum.ToString("yyyy/MM/dd")
        Dim End_DatumStr As String = End_datum.ToString("yyyy/MM/dd")

        ' ********** create sql **************

        Dim orderyear As String = Trim(Str(Year(Start_datum)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear

        Dim Reader As OdbcDataReader
        Dim cmdstring As String = ""

        '** Datum range
        cmdstring = "SELECT * FROM " + orderheader_db + " where DATE(afleverdatum) >= '" + Start_DatumStr + "' AND DATE(afleverdatum) <= '" + End_DatumStr + "' "

        '** status
        ' Friend BoekStatus As Integer
        If TreeviewVestiging = 1 Then
            cmdstring = cmdstring + "AND (vestiging = 1 or vestiging = 0 or aanvulling>0 ) "
        End If
        If TreeviewVestiging = 2 Then
            cmdstring = cmdstring + "AND (vestiging = 2 or vestiging = 0 or aanvulling>0 ) "
        End If
        If BoekStatus = 1 Then
            cmdstring = cmdstring + "AND status < 99 "
        End If
        If BoekStatus = 2 Then
            cmdstring = cmdstring + "AND status < 27 "
        End If
        If BoekStatus = 3 Then
            cmdstring = cmdstring + "AND status > 40 AND status < 99 "
        End If
        If BoekStatus = 4 Then
            cmdstring = cmdstring + "AND status >= 99 "
        End If
        If BoekStatus = 5 Then
            cmdstring = cmdstring + "AND status < 50 AND status <> 41 "
        End If
        If BoekStatus = 6 Then
            cmdstring = cmdstring + "AND status < 99 "
        End If
        If BoekStatus = 7 Then
            cmdstring = cmdstring + "AND status < 99 "
        End If
        If BoekStatus = 8 Then
            cmdstring = cmdstring + "AND status < 99 "
        End If
        '** tijd
        ' Friend BoekDisplayTijd As Integer
        If Tree_BBKlok_cmb.SelectedIndex = 0 Or Tree_BBKlok_cmb.SelectedIndex = 1 Then  'totaal of BB
            If BoekDisplayTijd = 2 Then
                cmdstring = cmdstring + "AND TIME(afleverdatum) >= '10:00' "
            End If
            If BoekDisplayTijd = 3 Then
                cmdstring = cmdstring + "AND TIME(afleverdatum) >= '13:00' "
            End If
        End If

        If Tree_BBKlok_cmb.SelectedIndex = 1 Then  'Alleen BB
            cmdstring = cmdstring + "AND TIME(afleverdatum) <= '17:30' "
        End If

        If Tree_BBKlok_cmb.SelectedIndex = 2 Then  'Alleen Klok
            cmdstring = cmdstring + "AND TIME(afleverdatum) > '17:30' "
        End If


        If koper_ean <> "" And BoekStatus = 8 Then
            cmdstring = cmdstring + " And koper_ean ='" + koper_ean + "' AND status <49 AND NOT(status=41) "
        Else
            '** Zoeken
            If Order_zoeken_chk.Checked = True Then
                cmdstring = cmdstring + "AND koper_naam LIKE '%" + Order_zoek_txt.Text + "%' "

            End If
        End If

        '** sortering
        ' Friend BoekStatus As Integer
        If BoekSortering = 1 Then
            cmdstring = cmdstring + "ORDER BY afleverdatum,aanvulling,header_id,invoerdatumtijd ASC"
        End If
        If BoekSortering = 2 Then
            cmdstring = cmdstring + "ORDER BY afleverdatum,aanvulling,koper_naam ASC"
        End If
        If BoekSortering = 3 Then
            cmdstring = cmdstring + "ORDER BY afleverdatum,aanvulling,afleverloc,vervoerder_id ASC"
        End If
        If BoekSortering = 4 Then
            cmdstring = cmdstring + "ORDER BY afleverdatum ASC,aanvulling,status DESC"
        End If
        ' ************ build tree ************
        TreeView1.BeginUpdate()
        TreeView1.Nodes.Clear()


        '  Dim titelnode_datum As DateTime = Date.Parse("2010/01/01").ToShortDateString
        Dim titelnode_datum As String = Date.Parse("2010/01/01").ToShortDateString

        Dim titlenode_tijd As String = "00:00"

        Dim s_horline As String = "----------------------------------- "
        Dim e_horline As String = " ------------------------------------------------------------------------------------------------------------------"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'recalc statusen  (wps & vervoerscan re-read)?

                Dim cmdrecalc As New OdbcCommand("select header_id from orderheaders where recalc_status=-1", Conn)
                Dim recalcReader As OdbcDataReader = cmdrecalc.ExecuteReader
                Do While recalcReader.Read
                    Dim header_id As Integer = CHint(recalcReader("header_id"))
                    SetNewStatusFlag(Now, header_id, False)
                    Dim cmdrecalcset As New OdbcCommand("update orderheaders set recalc_status=0 WHERE header_id=" + Str(header_id), Conn)
                    cmdrecalcset.ExecuteNonQuery()
                Loop

                'Execute Query


                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()

                Dim old_datum As String = Date.Parse("01/01/2000").ToShortDateString
                Dim old_tijd As String = Date.Parse("00:00").ToShortTimeString
                Dim old_afleverloc As Integer = -1

                Dim deen_count As Integer = 0
                Dim vkar_count As Integer = 0

                Do While Reader.Read()
                    Dim floridayflag As Integer = CHint(Reader("floridayflag"))
                    Dim afleverlocatie As Integer = CHint(Reader("afleverloc"))
                    Dim gpflags As String = CHstr(Reader("gpflags"))
                    Dim EAN As String = CHstr(Reader("koper_ean"))
                    Dim vestiging As Integer = CHint(Reader("vestiging"))
                    Dim header_id As Integer = CHint(Reader("header_id"))
                    Dim id_tag As String = "ID:" + Trim(Str(header_id))
                    Dim status = CHint(Reader("status"))
                    Dim vervoerder_id As Integer = CHint(Reader("vervoerder_id"))
                    Dim pakbonopmerking As String = CHstr(Reader("pakbon_opmerking"))
                    If Mid(EAN, 1, 12) = "900000000000" Then  'verzamelkar
                        id_tag = "IDv" + Trim(Str(header_id))
                    Else

                        '** status    
                        ' 0-19 florecom nieuw
                        ' 20-39 nieuw
                        ' 30-39 wps
                        ' 40-49 sdf
                        ' 50-59 vervoer

                        If Order_zoeken_chk.Checked = False Then

                            If icon1_chk.Checked = False Then  'geen nieuwe orders
                                If status < 30 Then
                                    GoTo nexttreeline
                                End If
                            End If

                            If icon2_chk.Checked = False Then  'geen wps
                                If status = 32 Then
                                    GoTo nexttreeline
                                End If
                            End If

                            If icon3_chk.Checked = False Then  'geen sdf
                                If (status = 41) Or (status >= 45 And status <= 49) Then
                                    GoTo nexttreeline
                                End If
                            End If

                            If icon4_chk.Checked = False Then  'geen vervoer
                                If status = 51 Then
                                    GoTo nexttreeline
                                Else

                                    Dim st As Integer = 0
                                End If
                            End If
                        End If
                    End If


                    Dim reservering As Integer = CHint(Reader("agenda_mark"))
                    Dim sticker As Integer = CHint(Reader("sticker"))
                    '** titles

                    Dim sqldatum As Date = CType(Reader("afleverdatum"), Date)
                    Dim datum As String = sqldatum.ToShortDateString
                    Dim tijd As String = sqldatum.ToShortTimeString
                    Dim xnode As TreeNode

                    If datum <> old_datum And Order_zoeken_chk.Checked = True Then
                        'If Start_datum.Date < End_datum.Date Then
                        'If datum <> old_datum Then    'bij orders zoeken datums in tree
                        ' old_datum = datum
                        Dim dag As String = Format(sqldatum, "dddd")
                        xnode = New TreeNode(s_horline + dag + " " + datum + e_horline)
                        xnode.ImageIndex = 2          'letter D
                        xnode.SelectedImageIndex = 2  'letter D
                        TreeView1.Nodes.Add(xnode)
                        'End If
                    End If

                    '** klok order?

                    Dim klok As Boolean = False
                    If Val(EAN) >= 1000 And Val(EAN) < 2000 Then
                        klok = True
                    End If

                    '** koper
                    Dim kopernaam = CHstr(Reader("koper_naam"))
                    Dim opmerking = CHstr(Reader("opmerking"))


                    '*afleverlocatie sorteren
                    If BoekSortering = 3 Then
                        If old_afleverloc <> afleverlocatie Or tijd <> old_tijd Then
                            old_afleverloc = afleverlocatie
                            old_tijd = tijd
                            If reservering = 2 Then
                                TreeView1.Nodes.Add(New TreeNode(s_horline + "Reserveringen" + e_horline))
                            ElseIf klok = True Then
                                ' setup klok tijd 
                                Dim morgen As String
                                Dim day As Integer
                                day = sqldatum.DayOfWeek + 1
                                Select Case day
                                    Case 2
                                        morgen = "Dinsdag"
                                    Case 3
                                        morgen = "Woensdag"
                                    Case 4
                                        morgen = "Donderdag"
                                    Case 5
                                        morgen = "Vrijdag"
                                    Case 6
                                        morgen = "Maandag"
                                    Case 7
                                        morgen = "Maandag"
                                    Case Else
                                        morgen = "Maandag"
                                End Select
                                TreeView1.Nodes.Add(New TreeNode(s_horline + kopernaam + " voor " + morgen + " " + afleverloc(GID(afleverloc, afleverlocatie)).naam + e_horline))
                            Else
                                Dim tijdnode As TreeNode = New TreeNode(s_horline + tijd + " " + afleverloc(GID(afleverloc, afleverlocatie)).naam + e_horline)
                                tijdnode.Tag = "Tijd"
                                TreeView1.Nodes.Add(tijdnode)
                            End If


                        End If
                    Else
                        '*tijdslijn & kloklijn
                        If tijd <> old_tijd Or datum <> old_datum Then            ' tijds lijn
                            old_datum = datum
                            old_tijd = tijd
                            If reservering = 2 Then
                                TreeView1.Nodes.Add(New TreeNode(s_horline + "Reserveringen" + e_horline))
                            ElseIf klok = True Then
                                ' setup klok tijd 
                                Dim morgen As String
                                Dim day As Integer
                                day = sqldatum.DayOfWeek + 1
                                Select Case day
                                    Case 2
                                        morgen = "Dinsdag"
                                    Case 3
                                        morgen = "Woensdag"
                                    Case 4
                                        morgen = "Donderdag"
                                    Case 5
                                        morgen = "Vrijdag"
                                    Case 6
                                        morgen = "Maandag"
                                    Case 7
                                        morgen = "Maandag"
                                    Case Else
                                        morgen = "Maandag"
                                End Select
                                TreeView1.Nodes.Add(New TreeNode(s_horline + kopernaam + " voor " + morgen + e_horline))
                            Else
                                Dim day As Integer = sqldatum.DayOfWeek
                                Dim dag As String
                                Select Case day
                                    Case 0
                                        dag = "Zondag"
                                    Case 1
                                        dag = "Maandag"
                                    Case 2
                                        dag = "Dinsdag"
                                    Case 3
                                        dag = "Woensdag"
                                    Case 4
                                        dag = "Donderdag"
                                    Case 5
                                        dag = "Vrijdag"
                                    Case 6
                                        dag = "Zaterdag"
                                    Case 7
                                        dag = "Zondag"
                                    Case Else
                                        dag = "Maandag"
                                End Select

                                Dim tijdnode As TreeNode = New TreeNode(s_horline + " " + dag + " " + tijd + " " + e_horline)
                                tijdnode.Tag = "Tijd"
                                TreeView1.Nodes.Add(tijdnode)
                            End If

                        End If

                    End If



                    If sdf_statusflag = True And status = 41 And expand_header = 0 Then
                        sdf_statuscounter = sdf_statuscounter + 1
                    Else
                        sdf_statusflag = False
                        sdf_statuscounter = sdf_statuscounter + 40
                        If sdf_statuscounter > TreeView1.Nodes.Count Then
                            sdf_statuscounter = TreeView1.Nodes.Count
                        End If
                    End If

                    Dim icon_index = 0
                    Select Case status

                        'nieuwe invoer
                        Case 20 : icon_index = 30  'nieuw
                        Case 21 : icon_index = 31  'nieuw met label
                        Case 22 : icon_index = 32  'nieuw met verwerkings label
                        Case 23 : icon_index = 33  'nieuw met verwerking klaar
                        Case 24 : icon_index = 34   'rood label, wacht op labels
                        Case 25 : icon_index = 53   'stikker op hoes
                        Case 26 : icon_index = 30


                            'wps

                        Case 27 : icon_index = 30
                        Case 28 : icon_index = 50
                        Case 29 : icon_index = 36   ' wps klaar + scan ready

                        Case 30 : icon_index = 12   ' wps in uitvoer
                        Case 31 : icon_index = 26   ' wps gedeeltelijk gedaan
                        Case 32 : icon_index = 11   ' wps klaar 

                        Case 33 : icon_index = 20   ' wps order klaar
                        Case 34
                            icon_index = 21         ' wps order geaccepteerd
                            If sticker = 8 Then
                                icon_index = 24     ' blauw pijltje wordt rood pijltje als sticker nog niet binnen is
                            End If


                        Case 35 : icon_index = 23   ' wps order wordt afgestuurd
                        Case 36 : icon_index = 24   ' wps gestuurt,rood icoontje, wacht op labels

                        Case 37 : icon_index = 27    'wps gedeelte klaar + order geaccepteerd
                        Case 38 : icon_index = 28    'wps gedeelte klaar + order wordt afgestuurd
                        Case 39 : icon_index = 25   ' fout
                            'sdf
                        Case 40 : icon_index = 14   ' sdf gedeeltelijk gedaan
                        Case 41 : icon_index = 13   ' sdf klaar 13
                        Case 42 : icon_index = 15   ' wps niet/gedeeltelijk klaar - sdf klaar/gedeeltelijk klaar 
                        Case 43 : icon_index = 49   ' agenda mark
                        Case 44 : icon_index = 35   ' sdf klaar + attachment
                        Case 45 : icon_index = 37   ' sdf gedeeltelijk + scan klaar

                        Case 46 : icon_index = 36    ' floriday print yellow
                        Case 47 : icon_index = 37    ' floriday print blue
                        Case 48 : icon_index = 55    ' floriday print red

                            'vervoer

                        Case 49 : icon_index = 19   'temp vervoer
                        Case 50 : icon_index = 17   'deel vervoer
                        Case 51 : icon_index = 18   'totaal vervoer

                        Case 55 : icon_index = 38  ' verzamelkar

                        Case 98 : icon_index = 6   ' reservering
                            'geannuleerd
                        Case 99 : icon_index = 9
                        Case 100 : icon_index = 32
                    End Select

                    'mark overwrites all
                    If reservering = 1 Then
                        icon_index = 49   ' agenda mark
                    End If

                    If vestiging = 2 Then
                        Select Case status

                            'nieuwe invoer
                            Case 20 : icon_index = 3  'nieuw
                            Case 21 : icon_index = 39  'nieuw met label
                            Case 22 : icon_index = 40  'nieuw met verwerkings label
                            Case 23 : icon_index = 41  'nieuw met verwerking klaar
                            Case 24 : icon_index = 34   'rood label, wacht op labels
                            Case 25 : icon_index = 54
                            Case 26 : icon_index = 3

                                'wps

                            Case 27 : icon_index = 3
                            Case 28 : icon_index = 51
                            Case 42 : icon_index = 15
                            Case 29 : icon_index = 43   ' wps klaar + scan ready

                            Case 30 : icon_index = 43   ' wps in uitvoer
                            Case 31 : icon_index = 42   ' wps gedeeltelijk gedaan
                            Case 32 : icon_index = 43   ' wps klaar 


                        End Select

                        If reservering = 1 Then
                            icon_index = 48   ' agenda mark
                        End If

                    End If


                    Dim invoertijd As Date = CType(Reader("invoerdatumtijd"), Date)
                    Dim verkoper As String = CHstr(Reader("inlog_naam"))
                    Dim afleverloc_id As Integer = CHint(Reader("afleverloc"))
                    Dim kar_id As Integer = CHint(Reader("kar_id"))
                    Dim aanvulling As Integer = CHint(Reader("aanvulling"))
                    Dim aantal_karren_order As Integer = CHint(Reader("aantal_karren"))
                    Dim bakverdeling As String = CHstr(Reader("bakverdeling"))
                    Dim koper_node As TreeNode = New TreeNode("init")


                    Dim aanvulling_found As Boolean = False
                    If aanvulling > 0 Then   ' deze order is een aanvulling, in tree zoeken naar order_id en het daar aan toevoegen i.p.v. een nieuwe node

                        'zoek naar vestiging van 'parent' header om te kijken of zowel parent als child dezelde vestiging hebben
                        Dim parentvestiging As Integer = vestiging
                        Dim reader5 As OdbcDataReader
                        Dim Cmd5 As New OdbcCommand("SELECT vestiging FROM orderheaders WHERE header_id = ?", Conn)
                        Cmd5.Parameters.AddWithValue("", aanvulling)
                        reader5 = Cmd5.ExecuteReader()
                        If reader5.HasRows Then
                            reader5.Read()
                            parentvestiging = CHint(reader5("vestiging"))
                        End If
                        'If parentvestiging > 0 And TreeviewVestiging > 0 Then
                        ' If Not (TreeviewVestiging = parentvestiging) And Not (TreeviewVestiging = vestiging) Then
                        ' Continue Do
                        'End If
                        'End If

                        ' If TreeviewVestiging > 0 Then
                        ' If (parentvestiging = 0) And Not (TreeviewVestiging = vestiging) Then
                        ' Continue Do
                        'End If
                        'End If

                        If TreeviewVestiging > 0 Then
                            If Not (TreeviewVestiging = vestiging) Then
                                Continue Do
                            End If
                        End If


                        For i = 0 To TreeView1.Nodes.Count - 1
                            If Mid(TreeView1.Nodes(i).Tag, 1, 2) = "ID" Then
                                Dim search_header_id As Integer = Val(Mid(TreeView1.Nodes(i).Tag, 4))



                                Dim headertype As String = Mid(TreeView1.Nodes(i).Tag, 1, 3)
                                If search_header_id = aanvulling Then
                                    If headertype = "ID:" Then
                                        koper_node = New TreeNode("Toevoeging: " + kopernaam)
                                    Else
                                        koper_node = New TreeNode("Verzamel : " + kopernaam)
                                    End If

                                    koper_node.ImageIndex = icon_index
                                    koper_node.SelectedImageIndex = icon_index
                                    koper_node.Tag = id_tag
                                    TreeView1.Nodes(i).Nodes.Add(koper_node)
                                    aanvulling_found = True
                                    Exit For
                                End If
                            End If
                        Next i
                    End If

                    If aanvulling_found = False Then
                        If reservering = 2 Then
                            koper_node = New TreeNode(kopernaam)
                            koper_node.ImageIndex = icon_index
                            koper_node.SelectedImageIndex = icon_index
                            koper_node.Tag = id_tag
                            TreeView1.Nodes.Add(koper_node)
                        ElseIf klok = True Then
                            Dim klokheader As String = CreateKlokHeader(kopernaam, orderlines_db, header_id)
                            koper_node = New TreeNode(klokheader)
                            koper_node.ImageIndex = icon_index
                            koper_node.SelectedImageIndex = icon_index
                            koper_node.Tag = id_tag
                            TreeView1.Nodes.Add(koper_node)

                            'Add gp 
                            If Len(gpflags) > 1 Then
                                For i = 1 To Len(gpflags)
                                    Dim karflag As Integer = Val(Mid(gpflags, i, 1))
                                    Dim kar_Node As TreeNode = New TreeNode("Kar " + Trim(Str(i)))
                                    Dim icon1 As Integer = 30
                                    Select Case karflag
                                        Case 0 : icon1 = 30
                                        Case 1 : icon1 = 21
                                        Case 2 : icon1 = 21
                                        Case 3 : icon1 = 21
                                        Case 4 : icon1 = 21
                                        Case 5 : icon1 = 23
                                        Case 6 : icon1 = 11
                                    End Select
                                    kar_Node.ImageIndex = icon1
                                    kar_Node.SelectedImageIndex = icon1
                                    koper_node.Nodes.Add(kar_Node)
                                Next

                            End If


                        ElseIf Mid(EAN, 1, 12) = "900000000000" Then  'verzamelkar then
                            'kopersnode verzamelkar
                            Dim aantal_bakken As Integer = Bereken_Aantal_Bakken_Verzamelkar(header_id)
                            koper_node = New TreeNode(tijd + " " + kopernaam + "    Totaal " + Trim(Str(aantal_bakken) + " bakken"))
                            koper_node.ImageIndex = icon_index
                            koper_node.SelectedImageIndex = icon_index
                            koper_node.Tag = id_tag
                            TreeView1.Nodes.Add(koper_node)
                        Else
                            'normale kopersnode
                            Dim karren As String = ""
                            Dim vervoerderstr As String = ""

                            If jenptenhave = True Then
                                karren = Str(aantal_karren_order) + "x "
                            End If

                            If BoekSortering = 3 Then
                                vervoerderstr = vervoerder(GID(vervoerder, vervoerder_id)).vervoerder_naam + "  "
                            End If
                            Dim nodestring As String = tijd + " " + karren + vervoerderstr + kopernaam
                            Dim capitals As Integer = NumberOfUppercaseCharacters(nodestring)
                            Dim non_capitals As Integer = Len(nodestring) - capitals

                            Dim vpos As Double = 0
                            Dim tabs As Double = 70 - vpos
                            If jenptenhave = True Then
                                vpos = vpos + non_capitals * 1.3
                                vpos = vpos + capitals * 1.9
                                tabs = 70 - vpos
                                If tabs < 0 Then tabs = 0
                            Else
                                bakverdeling = ""
                                tabs = 0
                            End If

                            koper_node = New TreeNode(nodestring + " " + Space(Int(tabs)) + bakverdeling)

                            If floridayflag = 0 And icon_index = 11 Then icon_index = 56    'sdf V flags
                            If floridayflag = 0 And icon_index = 43 Then icon_index = 56

                            koper_node.ImageIndex = icon_index
                            koper_node.SelectedImageIndex = icon_index

                            If header_id = new_order_header Then  'huidige kopersnode in oranje bij nieuwe order
                                koper_node.ImageIndex = 52
                                koper_node.SelectedImageIndex = 52
                            End If


                            koper_node.Tag = id_tag
                            TreeView1.Nodes.Add(koper_node)

                            If Len(gpflags) > 1 Then
                                For i = 1 To Len(gpflags)
                                    Dim karflag As Integer = Val(Mid(gpflags, i, 1))
                                    Dim kar_Node As TreeNode = New TreeNode("Kar " + Trim(Str(i)))
                                    Dim icon1 As Integer = 30
                                    Select Case karflag
                                        Case 0 : icon1 = 30
                                        Case 1 : icon1 = 21
                                        Case 2 : icon1 = 21
                                        Case 3 : icon1 = 21
                                        Case 4 : icon1 = 21
                                        Case 5 : icon1 = 23
                                        Case 6 : icon1 = 11
                                    End Select
                                    kar_Node.ImageIndex = icon1
                                    kar_Node.SelectedImageIndex = icon1
                                    koper_node.Nodes.Add(kar_Node)
                                Next

                            End If

                        End If

                    End If

                    ' ** specifieke kopers lijst laten zien voor aanvullingen e.d.
                    If koper_ean <> "" Or Order_zoeken_chk.Checked = True Then
                        add_kar_nodes(header_id, koper_node, new_order_header)
                    End If



                    '** karren berekenen
                    If BoekStatus = 7 Then
                        ' Dim CmdString5 As String = "SELECT COUNT(*) as 'COUNT' FROM " + orderkarren_db + " WHERE header_id =" + header_id
                        If Not afleverloc_id = 7 Then  ' thuis haagkamp
                            Dim aantal_karren As Integer = 0
                            Dim aantal_platen As Integer = 0
                            GetKarCount2(orderyear, header_id, aantal_karren, aantal_platen)
                            If kar_id = 1 Or kar_id = 2 Or kar_id = 4 Or kar_id = 5 Or kar_id = 10 Or kar_id = 11 Then
                                deen_count = deen_count + aantal_karren
                                aantal_denen = aantal_denen + aantal_karren
                                aantal_deenseplaten = aantal_deenseplaten + aantal_platen
                            End If
                            If kar_id = 3 Or kar_id = 9 Then
                                vkar_count = vkar_count + aantal_karren
                                aantal_vkar = aantal_vkar + aantal_karren
                            End If

                            If jenptenhave = False Then
                                Dim vrachtvol As Boolean = False
                                Dim deenlimit As Integer = 0
                                Select Case vkar_count
                                    Case 0 : deenlimit = 27
                                    Case 1 : deenlimit = 25
                                    Case 2 : deenlimit = 23
                                    Case 3 : deenlimit = 21
                                    Case 4 : deenlimit = 19
                                    Case 5 : deenlimit = 17
                                    Case 6 : deenlimit = 15
                                    Case 7 : deenlimit = 13
                                    Case 8 : deenlimit = 12
                                    Case 9 : deenlimit = 10
                                    Case 10 : deenlimit = 8
                                    Case 11 : deenlimit = 6
                                    Case 12 : deenlimit = 4
                                    Case 13 : deenlimit = 2
                                    Case Else : deenlimit = 0

                                End Select
                                If deen_count >= deenlimit Then
                                    deen_count = deen_count - deenlimit
                                    vkar_count = 0
                                    Dim deen_node As TreeNode
                                    deen_node = New TreeNode("---------------- Vracht vol ----------------")
                                    deen_node.ImageIndex = 17
                                    deen_node.SelectedImageIndex = 17
                                    deen_node.Tag = ""
                                    TreeView1.Nodes.Add(deen_node)

                                End If
                            End If

                        End If
                    End If

                    ' ** add soort lines
                    If Not (BoekStatus = 6 Or BoekStatus = 7 Or BoekStatus = 8) Or header_id = expand_header Or klok = True Then
                        Add_Soort_Nodes(orderlines_db, header_id, koper_node)


                        '* info toevoegen infoblad/kar/afleverloc/verkoper/invoertijd
                        '*infoblad
                        Const icon_blad = 7
                        Dim info_Node As TreeNode = New TreeNode("Info")
                        info_Node.ImageIndex = icon_blad
                        info_Node.SelectedImageIndex = icon_blad
                        koper_node.Nodes.Add(info_Node)
                        '*kar
                        Const icon_globe = 5
                        Dim kar_Nodetext As String = "kar: " + kar(GID(kar, kar_id)).karnaam
                        Dim kar_Node As TreeNode = New TreeNode(kar_Nodetext)
                        kar_Node.ImageIndex = icon_globe
                        kar_Node.SelectedImageIndex = icon_globe
                        info_Node.Nodes.Add(kar_Node)
                        '*afleverloc
                        'Const icon_globe = 5
                        Dim afleverloctext_node As String = "afleverlocatie: " + afleverloc(GID(afleverloc, afleverloc_id)).naam
                        Dim afleverloc_Node As TreeNode = New TreeNode(afleverloctext_node)
                        afleverloc_Node.ImageIndex = icon_globe
                        afleverloc_Node.SelectedImageIndex = icon_globe
                        info_Node.Nodes.Add(afleverloc_Node)
                        '*invoertijd
                        Const icon_time = 6
                        Dim invoertijd_Node As TreeNode = New TreeNode("Invoertijd: " + invoertijd.ToString("F"))
                        invoertijd_Node.ImageIndex = icon_time
                        invoertijd_Node.SelectedImageIndex = icon_time
                        info_Node.Nodes.Add(invoertijd_Node)
                        '*verkoper
                        Const icon_person = 8
                        Dim verkoper_Node As TreeNode = New TreeNode("Invoer: " + verkoper)
                        verkoper_Node.ImageIndex = icon_person
                        verkoper_Node.SelectedImageIndex = icon_person
                        info_Node.Nodes.Add(verkoper_Node)
                        '*opmerking
                        If opmerking <> "" Then
                            Dim opmerking_Node As TreeNode = New TreeNode("Opm: " + opmerking)
                            opmerking_Node.ImageIndex = icon_blad
                            opmerking_Node.SelectedImageIndex = icon_blad
                            info_Node.Nodes.Add(opmerking_Node)
                        End If
                        '* labelstatus toevoegen 
                        If sticker > 0 Then
                            If sticker = 1 Or sticker = 3 Or sticker = 7 Then
                                Dim sticker_Node As TreeNode = New TreeNode("Stickers plakken")
                                sticker_Node.ImageIndex = 31
                                sticker_Node.SelectedImageIndex = 31
                                koper_node.Nodes.Add(sticker_Node)
                            End If
                            If sticker = 2 Or sticker = 4 Or sticker = 6 Or sticker = 11 Then
                                Dim sticker_Node As TreeNode = New TreeNode("Stickers voorbereiden")
                                sticker_Node.ImageIndex = 32
                                sticker_Node.SelectedImageIndex = 32
                                koper_node.Nodes.Add(sticker_Node)
                            End If
                            If sticker = 8 Then
                                Dim sticker_Node As TreeNode = New TreeNode("Wacht op labelbericht")
                                sticker_Node.ImageIndex = 34
                                sticker_Node.SelectedImageIndex = 34
                                koper_node.Nodes.Add(sticker_Node)
                            End If
                            If sticker = 9 Then
                                Dim sticker_Node As TreeNode = New TreeNode("Document toevoegen")
                                sticker_Node.ImageIndex = 35
                                sticker_Node.SelectedImageIndex = 35
                                koper_node.Nodes.Add(sticker_Node)
                            End If
                            If sticker = 10 Then
                                Dim sticker_Node As TreeNode = New TreeNode("Stikkers + Document")
                                sticker_Node.ImageIndex = 35
                                sticker_Node.SelectedImageIndex = 35
                                koper_node.Nodes.Add(sticker_Node)
                            End If

                        End If
                    End If
                    If pakbonopmerking <> "" And jenptenhave = True Then
                        Const icon_blad = 7
                        Dim opm_Node As TreeNode = New TreeNode("Opm: " + pakbonopmerking)

                        If Not Mid(pakbonopmerking, 1, 10) = "AANVULLING" Then

                            opm_Node.ImageIndex = icon_blad
                            opm_Node.SelectedImageIndex = icon_blad
                            koper_node.Nodes.Add(opm_Node)
                        End If

                    End If
nexttreeline:

                Loop


            End Using
        Catch ex As Exception
            ErrorLog("Boek-Tree fout:" + ex.Message)
            MessageBox.Show("Boek-Tree fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        ' kar totalen 

        If BoekStatus = 7 Then
            Dim deen_node As TreeNode
            deen_node = New TreeNode("Totaal Denen : " + Str(aantal_denen))
            deen_node.ImageIndex = 17
            deen_node.SelectedImageIndex = 17
            deen_node.Tag = ""
            TreeView1.Nodes.Add(deen_node)

            deen_node = New TreeNode("Totaal Deense platen : " + Str(aantal_deenseplaten))
            deen_node.ImageIndex = 17
            deen_node.SelectedImageIndex = 17
            deen_node.Tag = ""
            TreeView1.Nodes.Add(deen_node)

            deen_node = New TreeNode("Totaal Veiling karren : " + Str(aantal_vkar))
            deen_node.ImageIndex = 17
            deen_node.SelectedImageIndex = 17
            deen_node.Tag = ""
            TreeView1.Nodes.Add(deen_node)
        End If




        'expand aanvullingen
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode

        For Each Node In Nodes
            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 2) = "ID" Then
                        user_click = False

                        TreeView1.SelectedNode = node2
                        TreeView1.SelectedNode.Expand()

                        user_click = True
                        Exit For
                    End If

                Next node2
            End If
        Next Node


        'expand selected node

        If expand_header > 0 Then

            For Each Node In Nodes
                If Mid(Node.Tag, 1, 2) = "ID" Then
                    Dim find_header As Integer = Val(Mid(Node.Tag, 4))
                    If find_header = expand_header Then
                        user_click = False

                        TreeView1.SelectedNode = Node
                        TreeView1.SelectedNode.Expand()

                        user_click = True
                        Exit For
                    End If
                End If
            Next
        End If

        If Order_zoeken_chk.Checked = True Then  'expand when searching

            For Each Node In Nodes
                If Mid(Node.Tag, 1, 2) = "ID" Then
                    Dim find_header As Integer = Val(Mid(Node.Tag, 4))

                    user_click = False
                    TreeView1.SelectedNode = Node
                    TreeView1.SelectedNode.Expand()
                    user_click = True

                End If
            Next
        End If


        TreeView1.EndUpdate()
        ' scrollen

        If expand_header = 0 Then
            Dim Nodes2 As TreeNodeCollection = TreeView1.Nodes
            Dim Node2 As TreeNode
            Dim node_count As Integer = 0
            For Each Node2 In Nodes2
                node_count = node_count + 1
                If node_count = sdf_statuscounter Then
                    user_click = False
                    ' TreeView1.SelectedNode = Node2
                    user_click = True
                    Exit For
                End If
            Next

        End If

    End Sub


    Private Function NumberOfUppercaseCharacters(ByVal text As String) As Integer
        Dim c() As Char = text.ToCharArray
        Dim count As Integer

        For Each c2 As Char In c
            If Char.IsUpper(c2) Then
                count += 1
            End If
        Next
        Return count
    End Function

    Private Function Bereken_Aantal_Bakken_Verzamelkar(ByVal header_id) As Integer
        Dim sumaantal As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'read time 
                Dim cmdstring2 As String = "SELECT SUM(aantal) as tot_aantal FROM orderlines as ol LEFT JOIN orderheaders as oh ON (OrderHeader_id=oh.header_id) WHERE oh.aanvulling = " + Str(header_id)

                Dim Cmd2 As New OdbcCommand(cmdstring2, Conn)
                Dim Reader2 As OdbcDataReader
                Reader2 = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    Reader2.Read()
                    sumaantal = CHint(Reader2("tot_aantal"))
                End If
                Reader2.Close()
            End Using
        Catch ex As Exception
            ErrorLog("Fout bereken aantal bakken: " + ex.Message)
            MsgBox("Fout bereken aantal bakken: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        Return sumaantal
    End Function

    Private Function GetBakCount(ByVal header_id As Integer, ByVal potmaat As Integer, ByVal maxpotmaat As Integer) As Integer
        Dim return_aantal As Integer = 0
        'potmaat = 110 etc.
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Reader2 As OdbcDataReader
                Dim Cmd2 As New OdbcCommand("SELECT SUM(aantal) as tot_aantal FROM orderlines where OrderHeader_id = ? and potmaat >= ? and potmaat <= ?", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", header_id)
                Cmd2.Parameters.AddWithValue("", potmaat)
                Cmd2.Parameters.AddWithValue("", maxpotmaat)
                Reader2 = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    return_aantal = CHint(Reader2("tot_aantal"))
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Karcount fout: " + ex.Message)
            MessageBox.Show("soortcount fout:  : " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Return return_aantal
    End Function

    Private Function GetKarCount(ByVal orderyear As String, ByVal header_id As Integer) As Integer

        Dim count As Integer = 0
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader
                Dim CmdString As String = "SELECT COUNT(*) as ""COUNT"" FROM " + orderkarren_db + " WHERE header_id =" + Str(header_id) + " AND LENGTH(overgooien_naar)<3"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    count = CHint(Reader.Item("COUNT"))
                End If
                Reader.Close()

                Dim GP As Integer = 0
                Dim Reader2 As OdbcDataReader
                Dim CmdString2 As String = "SELECT * FROM " + orderlines_db + " where OrderHeader_id = " + Str(header_id)
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Reader2 = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    GP = CHint(Reader2("GP"))
                    If GP > 1 Then
                        count = GP
                    End If
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Karcount fout: " + ex.Message)
            MessageBox.Show("Karcount fout:  : " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return count
    End Function


    Private Sub GetKarCount2(ByVal orderyear As String, ByVal header_id As Integer, ByRef karren As Integer, ByRef platen As Integer)

        Dim count As Integer = 0
        Dim plaatcount As Integer = 0
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader
                Dim CmdString As String = "SELECT COUNT(*) as ""COUNT"" FROM " + orderkarren_db + " WHERE header_id =" + Str(header_id) + " AND LENGTH(overgooien_naar)<3"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    count = CHint(Reader.Item("COUNT"))
                End If
                Reader.Close()

                Dim GP As Integer = 0
                Dim Reader2 As OdbcDataReader
                Dim CmdString2 As String = "SELECT * FROM " + orderlines_db + " where OrderHeader_id = " + Str(header_id)
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Reader2 = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    Reader2.Read()
                    GP = CHint(Reader2("GP"))
                    If GP > 1 Then
                        count = GP
                    End If
                End If

                If GP < 2 Then 'normaal platen tellen
                    CmdString = "SELECT aantal_lagen FROM " + orderkarren_db + " WHERE header_id =" + Str(header_id) + " AND LENGTH(overgooien_naar)<3"
                    Cmd.CommandText = CmdString
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read
                        Dim aantal_lagen As Integer = CHint(Reader("aantal_lagen"))
                        If aantal_lagen > 1 Then
                            aantal_lagen = aantal_lagen - 1  'platen
                        End If
                        plaatcount = plaatcount + aantal_lagen
                    Loop
                    Reader.Close()
                Else
                    'gp platen tellen
                    CmdString = "SELECT aantal_lagen FROM " + orderkarren_db + " WHERE header_id =" + Str(header_id) + " AND LENGTH(overgooien_naar)<3"
                    Cmd.CommandText = CmdString
                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        Dim aantal_lagen As Integer = CHint(Reader("aantal_lagen"))
                        If aantal_lagen > 1 Then
                            aantal_lagen = aantal_lagen - 1  'platen
                        End If
                        plaatcount = plaatcount + aantal_lagen
                        plaatcount = GP * plaatcount
                    End If
                    Reader.Close()
                End If



            End Using
        Catch ex As Exception
            ErrorLog("Karcount fout: " + ex.Message)
            MessageBox.Show("Karcount fout:  : " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        karren = count
        platen = plaatcount
    End Sub



    Private Function CreateKlokHeader(ByVal kopernaam As String, ByVal orderlines_db As String, ByVal header_id As Integer) As String
        Dim headerstr As String = kopernaam + " "
        Dim Reader As OdbcDataReader
        Dim cmdstring As String = ""

        '** Datum range
        cmdstring = "SELECT * FROM " + orderlines_db + " where OrderHeader_id = " + Trim(Str(header_id))

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query

                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd.ExecuteReader()

                If Reader.HasRows Then
                    Reader.Read()

                    Dim aantal As Integer = CHint(Reader("Aantal"))
                    Dim soort_id As Integer = CHint(Reader("Soort_id"))
                    Dim fust_id As Integer = CHint(Reader("Fust_id"))
                    Dim prijs As Double = CHdouble(Reader("Prijs"))
                    Dim GP As Integer = CHint(Reader("GP"))

                    '*gp
                    If GP > 1 Then
                        headerstr = headerstr + Trim(Str(GP)) + " x "
                    End If
                    '* aantal
                    headerstr = headerstr + Trim(Str(aantal)) + " x "
                    '* x fust
                    Dim fust_list As Integer = GID(fust, fust_id)
                    headerstr = headerstr + Trim(Str(fust(fust_list).aantal_per_fust)) + " "
                    '* soort
                    If soort_id < 10000 Then
                        'soort
                        headerstr = headerstr + soorten(GID(soorten, soort_id)).soortnaam
                    Else
                        'mix
                        headerstr = headerstr + mixen(GID(mixen, soort_id - 10000)).naam
                    End If

                End If

                If Reader.Read() Then
                    headerstr = headerstr + " + ..."
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Boek-Tree klokheaderfout:" + ex.Message)
            MessageBox.Show("Boek-Tree klokheaderfout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Return headerstr
    End Function

    Private Sub add_kar_nodes(ByVal header_id As Integer, ByVal koper_node As TreeNode, ByVal new_order_header As Integer)

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()


                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand("SELECT * FROM orderkarren where header_id=?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", header_id)

                Dim karcount As Integer = 1
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()

                    Dim aantal_lagen As Integer = CHint(Reader("Aantal_lagen"))
                    Dim overgooien_hierop As String = CHstr(Reader("Overgooien_hierop"))
                    Dim overgooien_naar As String = CHstr(Reader("Overgooien_naar"))
                    Dim kar_id As Integer = CHint(Reader("Kar_id"))
                    Dim overgooi_kar_id As Integer = 0

                    Dim aantal_lagen_overgooier As Integer = 0
                    Dim aantalbakken_overgooier As Integer = 0
                    If Val(overgooien_hierop) > 0 Then
                        Dim Reader2 As OdbcDataReader
                        Dim overgooierKarId As Integer = 0
                        Dim Cmd2 As New OdbcCommand("SELECT kar_id FROM orderkarren where barcode=?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", overgooien_hierop)
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()
                            overgooierKarId = CHint(Reader2("kar_id"))
                        End If
                        Reader2.Close()

                        If overgooierKarId > 0 Then
                            Cmd2.CommandText = "SELECT SUM(aantal) as aantalbakken FROM orderkarlines where kar_id=?"
                            Cmd2.Parameters.Clear()
                            Cmd2.Parameters.AddWithValue("", overgooierKarId)
                            Reader2 = Cmd2.ExecuteReader()
                            If Reader2.HasRows Then
                                Reader2.Read()
                                aantalbakken_overgooier = CHint(Reader2("aantalbakken"))
                            End If
                            Reader2.Close()
                        End If

                    End If

                    Dim karstring As String = "Kar-" + Trim(Str(karcount)) + "  " '   ' + Trim(Str(aantal_lagen)) + " lagen"
                    'If aantal_lagen_overgooier > 0 Then
                    'karstring = karstring + " + " + Trim(Str(aantal_lagen_overgooier)) + " lagen overgooier/aanvulling"
                    'End If
                    If aantalbakken_overgooier > 0 Then
                        karstring = karstring + " + " + Trim(Str(aantalbakken_overgooier)) + " fusten overgooier/aanvulling"
                    End If
                    If Val(overgooien_naar) > 0 Then
                        Dim Cmd2 As New OdbcCommand("SELECT SUM(aantal) as aantalbakken FROM orderkarlines where kar_id=?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", kar_id)
                        Dim Reader2 As OdbcDataReader
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()
                            aantalbakken_overgooier = CHint(Reader2("aantalbakken"))
                        End If
                        Reader2.Close()
                        karstring = karstring + Trim(Str(aantalbakken_overgooier)) + " fusten overgooier naar andere order"
                    End If

                    '*kar node toevoegen
                    Dim kar_Node As TreeNode = New TreeNode(karstring)
                    Dim kar_tag As String = "KARID:" + Trim(Str(kar_id))
                    If header_id = new_order_header Then
                        kar_Node.ImageIndex = 52
                        kar_Node.SelectedImageIndex = 52
                    Else
                        kar_Node.ImageIndex = 44
                        kar_Node.SelectedImageIndex = 44
                    End If
                    kar_Node.Tag = kar_tag
                    koper_node.Nodes.Add(kar_Node)

                    user_click = False
                    TreeView1.SelectedNode = koper_node
                    TreeView1.SelectedNode.Expand()
                    user_click = True

                    '* extra nodes soort info
                    '* node toevoegen
                    If Val(overgooien_naar) > 0 Then
                        Add_extra_karnode("Overgooier/aanvuller:", kar_Node, kar_id, Conn)
                    Else
                        Add_extra_karnode("Order:", kar_Node, kar_id, Conn)
                    End If

                    If overgooi_kar_id > 0 Then
                        Add_extra_karnode("Toevoeging:", kar_Node, overgooi_kar_id, Conn)
                    End If
                    karcount = karcount + 1
                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Boek-Tree linefout:" + ex.Message)
            MessageBox.Show("Boek-Tree linefout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Private Sub Add_extra_karnode(ByVal Titel As String, ByVal kar_Node As TreeNode, ByVal kar_id As Integer, ByVal conn As OdbcConnection)
        '* extra nodes soort info
        '* node toevoegen
        Dim order_Node As TreeNode = New TreeNode(Titel)
        order_Node.ImageIndex = 44
        order_Node.SelectedImageIndex = 44
        kar_Node.Nodes.Add(order_Node)

        Dim Reader4 As OdbcDataReader
        Dim Cmd4 As New OdbcCommand("SELECT * FROM orderkarlines where kar_id=?", conn)
        Cmd4.Parameters.Clear()
        Cmd4.Parameters.AddWithValue("", kar_id)
        Reader4 = Cmd4.ExecuteReader()
        Dim totaal_bakken As Integer = 0
        Do While Reader4.Read
            Dim aantal As Integer = CHint(Reader4("Aantal"))
            totaal_bakken = totaal_bakken + aantal
            Dim orderline_id As Integer = CHint(Reader4("Orderline_id"))

            Dim Reader3 As OdbcDataReader
            Dim Cmd3 As New OdbcCommand("SELECT * FROM orderlines where orderline_id=?", conn)
            Cmd3.Parameters.Clear()
            Cmd3.Parameters.AddWithValue("", orderline_id)
            Reader3 = Cmd3.ExecuteReader()
            If Reader3.HasRows Then
                Reader3.Read()
                Dim soort_id As Integer = CHint(Reader3("Soort_id"))
                Dim fust_id As Integer = CHint(Reader3("Fust_id"))
                Dim accessoire1_id As Integer = CHint(Reader3("Accessoire1"))
                Dim accessoire2_id As Integer = CHint(Reader3("Accessoire2"))
                Dim GP As Integer = CHint(Reader3("GP"))

                ' 18 x 6 Napoli - 206 Deco - Keramiek rood - Stikker
                Dim SoortText As String = "  "
                '*gp
                If GP > 1 Then
                    SoortText = SoortText + Trim(Str(GP)) + " x "
                End If
                '* aantal
                SoortText = SoortText + Trim(Str(aantal)) + " x "
                '* x fust
                Dim fust_list As Integer = GID(fust, fust_id)
                SoortText = SoortText + Trim(Str(fust(fust_list).aantal_per_fust)) + " "
                '* soort
                If soort_id < 10000 Then
                    'soort
                    SoortText = SoortText + soorten(GID(soorten, soort_id)).soortnaam
                Else
                    'mix
                    SoortText = SoortText + mixen(GID(mixen, soort_id - 10000)).naam
                End If
                '* accessoires
                If accessoire1_id > 0 Then
                    Dim acclist_id As Integer = GID(accessoire, accessoire1_id)
                    If accessoire(acclist_id).prijslijst > 0 Or accessoire(acclist_id).potmaat > 0 Then
                        SoortText = SoortText + " - " + accessoire(acclist_id).naam
                    End If
                End If
                '* node toevoegen
                Dim Soort_Node As TreeNode = New TreeNode(SoortText)
                Soort_Node.ImageIndex = 44
                Soort_Node.SelectedImageIndex = 44
                kar_Node.Nodes.Add(Soort_Node)
            End If
        Loop
        '* totaal count bakken node toevoegen
        Dim Tot_Node As TreeNode = New TreeNode("  Totaal " + Trim(Str(totaal_bakken)) + " bakken")
        Tot_Node.ImageIndex = 44
        Tot_Node.SelectedImageIndex = 44
        kar_Node.Nodes.Add(Tot_Node)

    End Sub

    Private Sub Add_Soort_Nodes(ByVal orderlines_db As String, ByVal header_id As Integer, ByVal Koper_Node As TreeNode)
        Dim Reader As OdbcDataReader
        Dim cmdstring As String = ""

        '** Datum range
        cmdstring = "SELECT * FROM " + orderlines_db + " where OrderHeader_id = " + Trim(Str(header_id))

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query

                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd.ExecuteReader()

                Do While Reader.Read()

                    Dim aantal As Integer = CHint(Reader("Aantal"))
                    Dim soort_id As Integer = CHint(Reader("Soort_id"))
                    Dim fust_id As Integer = CHint(Reader("Fust_id"))
                    Dim prijs As Double = CHdouble(Reader("Prijs"))
                    Dim GP As Integer = CHint(Reader("GP"))
                    Dim Rijpheid As Integer = CHint(Reader("Rijpheid"))
                    Dim Hoogte As Integer = CHint(Reader("Hoogte"))
                    Dim Diameter As Integer = CHint(Reader("Diameter"))
                    Dim accessoire1_id As Integer = CHint(Reader("Accessoire1"))
                    Dim accessoire2_id As Integer = CHint(Reader("Accessoire2"))
                    Dim accessoire3_id As Integer = CHint(Reader("Accessoire3"))
                    Dim accessoire4_id As Integer = CHint(Reader("Accessoire4"))
                    Dim accessoire5_id As Integer = CHint(Reader("Accessoire5"))
                    Dim florecomnr As String = CHstr(Reader("Florecom_nr"))
                    Dim koperscode As String = CHstr(Reader("kopercode"))
                    Dim labelcode As Integer = CHint(Reader("labelbericht_code"))
                    Dim labelstatus As Integer = CHint(Reader("label_status"))
                    Dim SoortText As String = ""
                    ' 18 x 6 Napoli - 206 Deco - Keramiek rood - Stikker

                    '*gp
                    If GP > 1 Then
                        SoortText = SoortText + Trim(Str(GP)) + " x "
                    End If
                    '* aantal
                    SoortText = SoortText + Trim(Str(aantal)) + " x "
                    '* x fust
                    Dim fust_list As Integer = GID(fust, fust_id)
                    SoortText = SoortText + Trim(Str(fust(fust_list).aantal_per_fust)) + " "
                    '* soort
                    If soort_id < 10000 Then
                        'soort
                        SoortText = SoortText + soorten(GID(soorten, soort_id)).soortnaam
                    Else
                        'mix
                        SoortText = SoortText + mixen(GID(mixen, soort_id - 10000)).naam
                    End If
                    '* accessoires
                    If accessoire1_id > 0 Then
                        Dim acclist_id As Integer = GID(accessoire, accessoire1_id)
                        If accessoire(acclist_id).prijslijst > 0 Or accessoire(acclist_id).potmaat > 0 Then
                            SoortText = SoortText + " - " + accessoire(acclist_id).naam
                        End If
                    End If
                    '* node toevoegen
                    Const icon_bluedot2 = 44
                    Dim Soort_Node As TreeNode = New TreeNode(SoortText)
                    Soort_Node.ImageIndex = icon_bluedot2
                    Soort_Node.SelectedImageIndex = icon_bluedot2
                    Koper_Node.Nodes.Add(Soort_Node)

                    '* extra's toevoegen prijs/fust/accessoires/rijpheid/hoogte/diameter/florecomnr
                    Const icon_bluedot = 4

                    '*prijs
                    Dim prijstext_node As String = "prijs : € " + Format(prijs, "0.00")
                    Dim prijs_Node As TreeNode = New TreeNode(prijstext_node)
                    prijs_Node.ImageIndex = icon_bluedot
                    prijs_Node.SelectedImageIndex = icon_bluedot
                    Soort_Node.Nodes.Add(prijs_Node)
                    '*fust
                    Dim fusttext_node As String = "fust : " + fust(fust_list).fustnaam
                    Dim fust_Node As TreeNode = New TreeNode(fusttext_node)
                    fust_Node.ImageIndex = icon_bluedot
                    fust_Node.SelectedImageIndex = icon_bluedot
                    Soort_Node.Nodes.Add(fust_Node)
                    '*accessoires
                    Dim accessoiretext_node As String
                    Dim accessoire_Node As TreeNode
                    If accessoire1_id > 0 Then
                        accessoiretext_node = accessoire(GID(accessoire, accessoire1_id)).naam
                        accessoire_Node = New TreeNode(accessoiretext_node)
                        accessoire_Node.ImageIndex = icon_bluedot
                        accessoire_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(accessoire_Node)
                    End If
                    If accessoire2_id > 0 Then
                        accessoiretext_node = accessoire(GID(accessoire, accessoire2_id)).naam
                        accessoire_Node = New TreeNode(accessoiretext_node)
                        accessoire_Node.ImageIndex = icon_bluedot
                        accessoire_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(accessoire_Node)
                    End If
                    If accessoire3_id > 0 Then
                        accessoiretext_node = accessoire(GID(accessoire, accessoire3_id)).naam
                        accessoire_Node = New TreeNode(accessoiretext_node)
                        accessoire_Node.ImageIndex = icon_bluedot
                        accessoire_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(accessoire_Node)
                    End If
                    If accessoire4_id > 0 Then
                        accessoiretext_node = accessoire(GID(accessoire, accessoire4_id)).naam
                        accessoire_Node = New TreeNode(accessoiretext_node)
                        accessoire_Node.ImageIndex = icon_bluedot
                        accessoire_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(accessoire_Node)
                    End If
                    If accessoire5_id > 0 Then
                        accessoiretext_node = accessoire(GID(accessoire, accessoire5_id)).naam
                        accessoire_Node = New TreeNode(accessoiretext_node)
                        accessoire_Node.ImageIndex = icon_bluedot
                        accessoire_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(accessoire_Node)
                    End If
                    '*rijpheid
                    Dim rijpheidtext_node As String = "Rijpheid : " + Trim(Str(Rijpheid))
                    Dim rijpheid_Node As TreeNode = New TreeNode(rijpheidtext_node)
                    rijpheid_Node.ImageIndex = icon_bluedot
                    rijpheid_Node.SelectedImageIndex = icon_bluedot
                    Soort_Node.Nodes.Add(rijpheid_Node)
                    '*hoogte
                    If Hoogte > 0 Then
                        Dim hoogtetext_node As String = "Hoogte: " + Trim(Str(Hoogte))
                        Dim hoogte_Node As TreeNode = New TreeNode(hoogtetext_node)
                        hoogte_Node.ImageIndex = icon_bluedot
                        hoogte_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(hoogte_Node)
                    End If
                    '*diameter
                    If Diameter > 0 Then
                        Dim diametertext_node As String = "Diameter " + Trim(Str(Diameter))
                        Dim diameter_Node As TreeNode = New TreeNode(diametertext_node)
                        diameter_Node.ImageIndex = icon_bluedot
                        diameter_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(diameter_Node)
                    End If
                    '*florecomnr
                    If florecomnr <> "" Then
                        Dim florecomnrtext_node As String = "Florecom nr. : " + florecomnr
                        Dim florecomnr_Node As TreeNode = New TreeNode(florecomnrtext_node)
                        florecomnr_Node.ImageIndex = icon_bluedot
                        florecomnr_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(florecomnr_Node)
                    End If
                    '*koperscode
                    If koperscode <> "" Then
                        Dim kopercode_Node As TreeNode = New TreeNode("Kopercode: " + koperscode)
                        kopercode_Node.ImageIndex = icon_bluedot
                        kopercode_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(kopercode_Node)
                    End If
                    '*infoblad

                    If labelcode > 0 Then
                        Dim label_Node As TreeNode = New TreeNode("Labelcode: " + Str(labelcode))
                        label_Node.ImageIndex = icon_bluedot
                        label_Node.SelectedImageIndex = icon_bluedot
                        Soort_Node.Nodes.Add(label_Node)
                    ElseIf labelstatus = 1 Then
                        Dim label_Node As TreeNode = New TreeNode("Wacht op labelbericht")
                        label_Node.ImageIndex = 34
                        label_Node.SelectedImageIndex = 34
                        Soort_Node.Nodes.Add(label_Node)
                    End If

                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Boek-Tree linefout:" + ex.Message)
            MessageBox.Show("Boek-Tree linefout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Public Function GID(ByVal table As Array, ByVal id As Integer) As Integer
        Dim Search_id As Integer = 0
        'get ID 
        For i = 1 To UBound(table)
            If table(i).id = id Then
                Search_id = i
                Exit For
            End If
        Next i
        Return Search_id
    End Function
    Private Sub TreeMenu_Selectie_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_Selectie.Click

        If TreeView1.SelectedNode.Tag = "Tijd" Then
            Dim selectnode As Boolean = False
            Dim Nodes As TreeNodeCollection = TreeView1.Nodes
            Dim Node As TreeNode
            For Each Node In Nodes

                If Node.Tag = "Tijd" And selectnode = True Then
                    selectnode = False
                End If

                If Node.Text = TreeView1.SelectedNode.Text Then
                    'timenode found
                    selectnode = True
                End If

                If selectnode = True Then
                    If Mid(Node.Tag, 1, 3) = "ID:" Or Mid(Node.Tag, 1, 3) = "IDv" Then
                        Node.Checked = True

                        If Node.Nodes.Count > 0 Then
                            Dim node2 As TreeNode
                            For Each node2 In Node.Nodes
                                If Mid(node2.Tag, 1, 3) = "ID:" Then
                                    node2.Checked = True
                                End If
                            Next node2
                        End If
                    End If



                End If

            Next Node
        End If


    End Sub
    Private Sub TreeMenu_StatusGeannuleerd_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_StatusGeannuleerd.Click
        Set_BoekInstellingen(0, 0, 4)
        Update_Boek()
    End Sub
    Private Sub TreeMenu_OrderAanpassen_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_OrderAanpassen.Click
        Dim aanpassen As Boolean
        aanpassen = OrderAanpassen()
        If aanpassen = True Then
            Load_Favorites(1, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
        End If
    End Sub
    Private Sub WpsVersturenToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsVersturenToolStripMenuItem.Click
        Orders_WpsVersturen_Click(sender, e)
    End Sub
    Private Sub TreeMenu_Karindeling_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeMenu_Karindeling.Click

        PanelKarindelingOnder.Enabled = True
        PanelKarindelingMidden.Enabled = True
        PanelKarIndelingBoven.Enabled = True

        karindeling_date = Order_MonthCalendar.SelectionStart
        'find selected treeview item
        Dim header_id As Integer = -1
        'For i = 0 To TreeView1.Nodes.Count - 1
        ' If TreeView1.Nodes(i).Checked = True And Mid(TreeView1.Nodes(i).Tag, 1, 3) = "ID:" Then
        ' header_id = Val(Mid(TreeView1.Nodes(i).Tag, 4))
        ' End If
        ' Next i
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(Node.Tag, 4))
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        header_id = Val(Mid(node2.Tag, 4))
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If

        If header_id = -1 Then Exit Sub
        Show_Karindeling(header_id)
    End Sub
    Private Sub TreeView1_AfterSelect(ByVal sender As System.Object, ByVal e As System.Windows.Forms.TreeViewEventArgs) Handles TreeView1.AfterSelect
        If (BoekStatus = 6 Or BoekStatus = 7) Then
            If user_click = True Then 'global var.. set to false if select is called from code 
                Dim header_id As Integer = 0
                If Mid(TreeView1.SelectedNode.Tag, 1, 2) = "ID" Then
                    header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                    Update_Boek(header_id)
                End If
            End If
        End If
    End Sub
    Private Sub Tree_Update_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Tree_Update_but.Click


        overgooier = ""
        Set_BoekInstellingen(0, 0, 6)
        Update_Boek()

    End Sub
    Private Sub TreeVestTotaal_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeVestTotaal_but.Click
        TreeviewVestiging = 0
        SetButtonsKreekrug(False)
        Update_Boek()

    End Sub

    Private Sub TreeVest1_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeVest1_but.Click
        TreeviewVestiging = 1
        SetButtonsKreekrug(True)
        Update_Boek()

    End Sub

    Private Sub TreeVest2_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TreeVest2_but.Click
        TreeviewVestiging = 2
        SetButtonsKreekrug(False)
        Update_Boek()

    End Sub
    Private Sub LabelberichtStatusToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LabelberichtStatusToolStripMenuItem.Click
        Dim header_id As Integer = -1

        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(Node.Tag, 4))
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        header_id = Val(Mid(node2.Tag, 4))
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If


        If header_id >= 0 Then

            LabelberichtInfo.InitLB(header_id)
            LabelberichtInfo.StartPosition = FormStartPosition.CenterScreen
            LabelberichtInfo.Show()
            Application.DoEvents()

        End If
    End Sub

    Private Sub icon1_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles icon1_chk.CheckedChanged
        If icon1_chk.Tag = "System" Then
            icon1_chk.Tag = ""
        Else
            Update_Boek()
        End If
    End Sub

    Private Sub icon2_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles icon2_chk.CheckedChanged
        If icon1_chk.Tag = "System" Then
            icon1_chk.Tag = ""
        Else
            Update_Boek()
        End If
    End Sub

    Private Sub icon3_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles icon3_chk.CheckedChanged
        If icon1_chk.Tag = "System" Then
            icon1_chk.Tag = ""
        Else
            Update_Boek()
        End If
    End Sub

    Private Sub icon4_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles icon4_chk.CheckedChanged
        If icon1_chk.Tag = "System" Then
            icon1_chk.Tag = ""
        Else
            Update_Boek()
        End If
    End Sub

    Private Sub PakbonSamenvatting_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PakbonSamenvatting.Click
        Dim header_id As Integer = 0

        If Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If

        If header_id = 0 Then Exit Sub


        Dim id As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Print pakbonnen van order
                Dim reader As OdbcDataReader
                Dim Cmd2 As New OdbcCommand("select kar_id from OrderKarren WHERE header_id = ?", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", header_id)
                reader = Cmd2.ExecuteReader()
                Do While reader.Read()
                    'read kar-id
                    Dim kar_id As Integer = CHint(reader("kar_id"))

                    'welke printer

                    Dim printernr As Integer = 1
                    Dim reader6 As OdbcDataReader
                    Dim Cmd6 As New OdbcCommand("select vestiging from Orderlines WHERE OrderHeader_id = ?", Conn)
                    Cmd6.Parameters.Clear()
                    Cmd6.Parameters.AddWithValue("", header_id)
                    reader6 = Cmd6.ExecuteReader()
                    If reader6.HasRows Then
                        Dim vestiging As Integer = CHint(reader6("vestiging"))
                        If vestiging = 2 Then printernr = 2
                    End If

                    'insert into printerspooler

                    Dim Cmd4 As New OdbcCommand("INSERT INTO printer_spooler SET kar_id=?, datum=?, printer=?, wpsdeelorder=?", Conn)
                    Cmd4.Parameters.Clear()
                    Cmd4.Parameters.AddWithValue("", kar_id)
                    Cmd4.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                    Cmd4.Parameters.AddWithValue("", printernr)
                    Cmd4.Parameters.AddWithValue("", 3)            ' ! Deelorder 3 = samenvatting 
                    Cmd4.ExecuteNonQuery()

                Loop

            End Using
        Catch ex As Exception
            MsgBox("Fout print samenvatting: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


    End Sub

    Private Sub Tree_BBKlok_cmb_SelectedIndexChanged(sender As Object, e As EventArgs) Handles Tree_BBKlok_cmb.SelectedIndexChanged
        If Not Tree_BBKlok_cmb.Tag = "system" Then
            overgooier = ""
            Set_BoekInstellingen(0, 0, 6)
            Update_Boek()
        End If
    End Sub


#End Region

#Region "Login & Login-timer"

    Private Sub LoginNaam1_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LoginNaam1_but.Click
        Login_name = My.Settings.LoginName1
        TreeVestTotaal_but.Enabled = False
        TreeVest1_but.Enabled = False
        TreeVest2_but.Enabled = False
        If Inst_Login1_v2_chk.Checked = True Then
            TreeVest2_but.Enabled = True
        End If
        If Inst_Login1_v1_chk.Checked = True Then
            TreeVest1_but.Enabled = True
        End If
        If Inst_Login1_T_chk.Checked = True Then
            TreeVestTotaal_but.Enabled = True
        End If
        SetLoginSettings(1)

    End Sub
    Private Sub LoginNaam2_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LoginNaam2_but.Click
        Login_name = My.Settings.LoginName2
        TreeVestTotaal_but.Enabled = False
        TreeVest1_but.Enabled = False
        TreeVest2_but.Enabled = False
        If Inst_Login2_v2_chk.Checked = True Then
            TreeVest2_but.Enabled = True
            TreeviewVestiging = 2
        End If
        If Inst_Login2_v1_chk.Checked = True Then
            TreeVest1_but.Enabled = True
            TreeviewVestiging = 1
        End If
        If Inst_Login2_T_chk.Checked = True Then
            TreeVestTotaal_but.Enabled = True
            TreeviewVestiging = 0
        End If
        SetLoginSettings(2)
    End Sub
    Private Sub LoginNaam3_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LoginNaam3_but.Click
        Login_name = My.Settings.LoginName3
        TreeVestTotaal_but.Enabled = False
        TreeVest1_but.Enabled = False
        TreeVest2_but.Enabled = False
        If Inst_Login3_v2_chk.Checked = True Then
            TreeVest2_but.Enabled = True
            TreeviewVestiging = 2
        End If
        If Inst_Login3_v1_chk.Checked = True Then
            TreeVest1_but.Enabled = True
            TreeviewVestiging = 1
        End If
        If Inst_Login3_T_chk.Checked = True Then
            TreeVestTotaal_but.Enabled = True
            TreeviewVestiging = 0
        End If
        SetLoginSettings(3)
    End Sub
    Private Sub LoginNaam4_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LoginNaam4_but.Click
        Login_name = My.Settings.LoginName4
        TreeVestTotaal_but.Enabled = False
        TreeVest1_but.Enabled = False
        TreeVest2_but.Enabled = False
        If Inst_Login4_v2_chk.Checked = True Then
            TreeVest2_but.Enabled = True
            TreeviewVestiging = 2
        End If
        If Inst_Login4_v1_chk.Checked = True Then
            TreeVest1_but.Enabled = True
            TreeviewVestiging = 1
        End If
        If Inst_Login4_T_chk.Checked = True Then
            TreeVestTotaal_but.Enabled = True
            TreeviewVestiging = 0
        End If
        SetLoginSettings(4)
    End Sub
    Private Sub LoginNaam5_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LoginNaam5_but.Click
        Login_name = My.Settings.LoginName5
        TreeVestTotaal_but.Enabled = False
        TreeVest1_but.Enabled = False
        TreeVest2_but.Enabled = False
        If Inst_Login5_v2_chk.Checked = True Then
            TreeVest2_but.Enabled = True
            TreeviewVestiging = 2
        End If
        If Inst_Login5_v1_chk.Checked = True Then
            TreeVest1_but.Enabled = True
            TreeviewVestiging = 1
        End If
        If Inst_Login5_T_chk.Checked = True Then
            TreeVestTotaal_but.Enabled = True
            TreeviewVestiging = 0
        End If
        SetLoginSettings(5)
    End Sub
    Private Sub LoginNaam6_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LoginNaam6_but.Click
        Login_name = My.Settings.LoginName6
        TreeVestTotaal_but.Enabled = False
        TreeVest1_but.Enabled = False
        TreeVest2_but.Enabled = False
        If Inst_Login6_v2_chk.Checked = True Then
            TreeVest2_but.Enabled = True
            TreeviewVestiging = 2
        End If
        If Inst_Login6_v1_chk.Checked = True Then
            TreeVest1_but.Enabled = True
            TreeviewVestiging = 1
        End If
        If Inst_Login6_T_chk.Checked = True Then
            TreeVestTotaal_but.Enabled = True
            TreeviewVestiging = 0
        End If
        SetLoginSettings(6)
    End Sub
    Private Sub LoginNaam7_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LoginNaam7_but.Click
        Login_name = My.Settings.LoginName7
        TreeVestTotaal_but.Enabled = False
        TreeVest1_but.Enabled = False
        TreeVest2_but.Enabled = False
        If Inst_Login7_v2_chk.Checked = True Then
            TreeVest2_but.Enabled = True
            TreeviewVestiging = 2
        End If
        If Inst_Login7_v1_chk.Checked = True Then
            TreeVest1_but.Enabled = True
            TreeviewVestiging = 1
        End If
        If Inst_Login7_T_chk.Checked = True Then
            TreeVestTotaal_but.Enabled = True
            TreeviewVestiging = 0
        End If
        SetLoginSettings(7)
    End Sub
    Private Sub LoginNaam8_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles LoginNaam8_but.Click
        Login_name = My.Settings.LoginName8
        TreeVestTotaal_but.Enabled = False
        TreeVest1_but.Enabled = False
        TreeVest2_but.Enabled = False
        If Inst_Login8_v2_chk.Checked = True Then
            TreeVest2_but.Enabled = True
            TreeviewVestiging = 2
        End If
        If Inst_Login8_v1_chk.Checked = True Then
            TreeVest1_but.Enabled = True
            TreeviewVestiging = 1
        End If
        If Inst_Login8_T_chk.Checked = True Then
            TreeVestTotaal_but.Enabled = True
            TreeviewVestiging = 0
        End If
        SetLoginSettings(8)
    End Sub
    Private Sub SetButtonsKreekrug(ByVal kreekrug As Boolean)

        If kreekrug = False Then
            Orders_WpsXML_but.Enabled = False
            Orders_WpsVersturen.Enabled = False
            Orders_WpsKlaar.Text = "Order klaar"
        Else
            Orders_WpsXML_but.Enabled = True
            Orders_WpsVersturen.Enabled = True
            Orders_WpsKlaar.Text = "Wps klaar"
        End If

        kar_wissel_vestiging_but.Visible = True
        kar_overgooien1_hierop_but.Visible = True
        kar_overgooien2_hierop_but.Visible = True
        kar_overgooien3_hierop_but.Visible = True
        kar_overgooien4_hierop_but.Visible = True
        kar_overgooien1_naar_but.Visible = True
        kar_overgooien2_naar_but.Visible = True
        kar_overgooien3_naar_but.Visible = True
        kar_overgooien4_naar_but.Visible = True
        kar_overgooien1_wis_but.Visible = True
        kar_overgooien2_wis_but.Visible = True
        kar_overgooien3_wis_but.Visible = True
        kar_overgooien4_wis_but.Visible = True


    End Sub
    Private Sub SetLoginSettings(ByVal loginnr As Integer)

        CheckForUpdate()


        If jenptenhave = True Then
            If TreeVestTotaal_but.Enabled = True Then
                TreeviewVestiging = 0
            ElseIf TreeVest1_but.Enabled = True Then
                TreeviewVestiging = 1
            ElseIf TreeVest2_but.Enabled = True Then
                TreeviewVestiging = 2
            End If
        End If


        If UBound(vestiging) > 1 Then
            If TreeVest1_but.Enabled = True And TreeVest2_but.Enabled = False And TreeVestTotaal_but.Enabled = False Then
                SetButtonsKreekrug(True)
            Else
                SetButtonsKreekrug(False)
            End If
            If TreeVestTotaal_but.Enabled = True Then
                TimerFlorecom.Enabled = True
            Else
                TimerFlorecom.Enabled = False
            End If
        Else
            TimerFlorecom.Enabled = True
        End If
        C1NavBar1.Enabled = True
        C1NavPanelOrders2.Enabled = True
        InlogAgendaDatum.Value = Now
        C1NavBar1.Enabled = True
        C1NavBar1.SelectedButtonIndex = 0
        C1TabOrderInvoer.Enabled = True
        C1TabKarindeling.Enabled = True
        C1TabFlorecom.Enabled = False
        C1TabVervoer.Enabled = True
        C1TabOverzichten.Enabled = True
        C1TabInloggen.Enabled = True
        C1TabDatabase.Enabled = False
        C1TabInstellingen.Enabled = False
        C1TabVoorraad.Enabled = True
        C1TabPrijzen.Enabled = False
        C1TabWPS.Enabled = True
        'C1Tab.SelectedTab = C1Tab.TabPages(0)
        SetTabPage("Order invoer")
        OrdersMenuNieuw.Focus()
        Check_Database_reload()
        user_date_change = False
        'Set_BoekInstellingen(1, 1, 1)
        Order_MonthCalendar.SelectionStart = Now
        Order_MonthCalendar.SelectionEnd = Now
        Vervoer_MonthCalendar.SelectionStart = Now

        ' Order_MonthCalendar.SelectionEnd = OrderDateTimePicker.Value
        user_date_change = True
        Dim yesterday As Date = DateAdd("d", -1, Now)

        ' openstaande orders van gisteren?

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim searchdate As String = Format(yesterday, "yyyy/MM/dd")
                Dim CmdString As String = "select * from OrderHeaders WHERE DATE(afleverdatum) = '" + searchdate + "' and status < 30"
                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    MsgBox("Er zijn nog openstaande orders van gisteren!", vbOKOnly)
                End If
                Reader.Close()

                Dim Reader2 As OdbcDataReader
                Dim Cmd2 As New OdbcCommand("select * from loginlijst where computer_name=?", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", Trim(My.Computer.Name))
                Reader2 = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    Dim Cmd3 As New OdbcCommand("UPDATE loginlijst SET login_name=?, tijd=? WHERE computer_name = ?", Conn)
                    Cmd3.Parameters.Clear()
                    Cmd3.Parameters.AddWithValue("", Login_name)
                    Cmd3.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                    Cmd3.Parameters.AddWithValue("", Trim(My.Computer.Name))
                    Cmd3.ExecuteNonQuery()
                Else
                    Dim Cmd3 As New OdbcCommand("INSERT INTO loginlijst(computer_name,login_name,tijd) VALUES(?,?,?)", Conn)
                    Cmd3.Parameters.AddWithValue("", Trim(My.Computer.Name))
                    Cmd3.Parameters.AddWithValue("", Trim(Login_name))
                    Cmd3.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                    Cmd3.ExecuteNonQuery()
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (inlog-check )" + ex.Message)
            MessageBox.Show("Database fout: (inlog-check )" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        'reload ordergrid start of each day
        Static thisday As Integer
        Static oldday As Integer
        thisday = Now.DayOfWeek
        If thisday <> oldday Then
            Setup_Order_Grid()
            oldday = thisday
            Set_BoekInstellingen(1, 1, 6)
        End If


        icon1_chk.Tag = "System"
        icon2_chk.Tag = "System"
        icon1_chk.Checked = True
        icon2_chk.Checked = True

        Update_Boek()
    End Sub

    Private Sub CheckForUpdate()
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd2 As New OdbcCommand("SELECT * FROM instellingen", Conn)
                Dim Reader2 As OdbcDataReader = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    Reader2.Read()
                    Dim new_version As String = CHstr(Reader2("version"))
                    Dim update_mandatory As Boolean = CHbool(Reader2("update_mandatory"))

                    Dim current_version As String = My.Settings.Versie
                    If current_version <> new_version Then
                        My.Settings.Versie = new_version
                        My.Settings.Save()
                        If update_mandatory = True Then
                            Dim answer As Integer = MsgBox("Nieuwe versie van Boek gevonden!", vbOKOnly)
                            If answer = vbOK Then
                                Try
                                    If Debugger.IsAttached Then
                                        ' Since there is a debugger attached, assume we are running from the IDE
                                    Else
                                        ' Assume we aren't running from the IDE
                                        System.Diagnostics.Process.Start("C:\Boek\Update.appref-ms", "app1")
                                        Application.Exit()
                                    End If
                                Catch ex As Exception
                                    MsgBox("Updater Not found")
                                End Try
                            End If
                        Else
                            Dim answer As Integer = MsgBox("Nieuwe versie van Boek gevonden! Update?", vbYesNo)
                            If answer = vbYes Then
                                Try
                                    If Debugger.IsAttached Then
                                        ' Since there is a debugger attached, assume we are running from the IDE
                                    Else
                                        ' Assume we aren't running from the IDE
                                        System.Diagnostics.Process.Start("C:\Boek\Update.appref-ms", "app1")
                                        Application.Exit()
                                    End If
                                Catch ex As Exception
                                    MsgBox("Updater Not found")
                                End Try
                            End If
                        End If

                    End If


                End If
                Reader2.Close()



            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (update boek )" + ex.Message)
            MessageBox.Show("Database fout: (update boek)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub ActivityTimer_lbl_Click(sender As System.Object, e As System.EventArgs) Handles ActivityTimer_lbl.Click
        Set_Boek_reload()
    End Sub

    Private Sub TestSQLConnection()
        'test SQL 


        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM veiling", Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    SQLRUN2 = True
                End If

            End Using
        Catch ex As Exception

            FormConnectionLost.StartPosition = FormStartPosition.CenterScreen
            FormConnectionLost.Show()
            SQLRUN2 = False
        End Try
    End Sub

    Private Sub Timer_Activity_Tick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Timer_Activity.Tick

        '30 seconden timer -> maar activity is per seconden

        If SQLRUN = True Then
            TestSQLConnection()

            If SQLRUN2 = True Then

                Activity_Timer = DateDiff(DateInterval.Second, LastActivity, Now)

                ActivityTimer_lbl.Text = "Activity Timer : " + Str(Activity_Timer)

                If Activity_Timer > 120 Then   'check boek na 120 seconden elke 30 sec if not active
                    If Check_Boek_reload() = True Then
                        Update_Boek()
                    End If

                End If

                If Activity_Timer > 3600 And C1Tab.SelectedIndex <> 10 Then   'na 30 minuten opnieuw inloggen

                    GC.Collect()  'garbage collector
                    Application.DoEvents()

                    'set inlog tab/disable rest 
                    PanelKarindelingMidden.Enabled = False
                    PanelKarIndelingBoven.Enabled = False

                    C1NavPanelOrders2.Enabled = False
                    C1TabOrderInvoer.Enabled = False
                    C1TabKarindeling.Enabled = False
                    C1TabFlorecom.Enabled = False
                    C1TabVervoer.Enabled = False
                    C1TabOverzichten.Enabled = False
                    C1TabDatabase.Enabled = False
                    C1TabInstellingen.Enabled = False
                    C1TabVoorraad.Enabled = False
                    C1TabPrijzen.Enabled = False
                    C1TabInloggen.Enabled = True
                    'C1Tab.SelectedTab = C1Tab.TabPages(10)
                    SetTabPage("Inloggen")
                    C1NavBar1.Enabled = False
                    ShowAgenda(Now)

                    Set_BoekInstellingen(1, 1, 6)

                End If
            End If
        End If
    End Sub
    Private Sub ShowAgenda(ByVal datum As Date)

        Dim jaar As Integer
        Dim i As Integer
        Dim daypair As Tuple(Of DateTime, DateTime)

        Dim rs As C1.Win.C1FlexGrid.CellStyle
        rs = AgendaFlexGrid.Styles.Add("DayColor")
        rs.BackColor = Color.LightCyan
        Dim ws As C1.Win.C1FlexGrid.CellStyle
        ws = AgendaFlexGrid.Styles.Add("WeekSplitColor")
        ws.BackColor = Color.LightGray


        'Dim wdate As Date = DateTime.Parse("08-03-2010")
        jaar = Year(datum)
        Dim culture As System.Globalization.CultureInfo = System.Globalization.CultureInfo.CurrentCulture
        'week = culture.Calendar.GetWeekOfYear(datum, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday)

        daypair = getFirstAndLastDayOfWeek(datum)
        Dim startdate As Date = daypair.Item1
        Dim enddate As Date = daypair.Item2


        For i = 1 To 97 Step 8
            AgendaFlexGrid.Rows(i).Style = AgendaFlexGrid.Styles("WeekSplitColor")
        Next i

        Dim weekloop As Integer
        Dim dayloop As Integer
        Dim rundatum As Date

        For weekloop = 0 To 11
            For dayloop = 0 To 6
                rundatum = DateAdd("d", (weekloop * 7) + dayloop, startdate)
                If rundatum = datum Then
                    AgendaFlexGrid.Rows(weekloop * 8 + dayloop + 2).Style = AgendaFlexGrid.Styles("DayColor")
                Else
                    AgendaFlexGrid.Rows(weekloop * 8 + dayloop + 2).Style = AgendaFlexGrid.Styles("Normal")
                End If
                If dayloop = 0 Then AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 0) = culture.Calendar.GetWeekOfYear(rundatum, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday)
                AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 1) = rundatum
                AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 2) = ""
                AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 3) = ""
                AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 4) = ""

            Next dayloop
        Next weekloop

        'fill
        Dim Reader As OdbcDataReader
        For weekloop = 0 To 11
            For dayloop = 0 To 6

                rundatum = DateAdd("d", (weekloop * 7) + dayloop, startdate)

                Dim searchdate As String = Format(rundatum, "yyyy/MM/dd")
                'Dim searchdate As String = Format(rundatum, "dd/MM/yyyy")
                Dim CmdString As String = "select * from agenda WHERE start_datum <= '" + searchdate + "' and eind_datum >= '" + searchdate + "'"
                Try
                    Using Conn As New OdbcConnection(ConnString)
                        Conn.Open()

                        'Execute Query
                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                        Reader = Cmd.ExecuteReader()
                        Do While Reader.Read()
                            'flexgridfill(0) = Reader("start_datum")
                            'flexgridfill(1) = Reader("eind_datum")
                            Dim vakantieflag As Boolean = CHbool(Reader("vakantie"))
                            Dim aktieflag As Boolean = CHbool(Reader("aktie"))
                            Dim opmerkingflag As Boolean = CHbool(Reader("opmerking"))
                            Dim tekst As String = CHstr(Reader("tekst"))
                            'flexgridfill(6) = Reader("id")
                            'flexgridfill(7) = Str(0)
                            If vakantieflag = True Then
                                AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 2) = AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 2) + tekst + "   "
                            End If
                            If aktieflag = True Then
                                AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 3) = AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 3) + tekst + "   "
                            End If
                            If opmerkingflag = True Then
                                AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 4) = AgendaFlexGrid.Item(weekloop * 8 + dayloop + 2, 4) + tekst + "   "
                            End If
                        Loop
                    End Using
                Catch ex As Exception
                    ErrorLog("Database fout: (agenda vullen)" + ex.Message)
                    MessageBox.Show("Database fout: (agenda vullen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                End Try



            Next dayloop
        Next weekloop

    End Sub
    Private Function getFirstAndLastDayOfWeek(ByVal startdate As Date) As Tuple(Of DateTime, DateTime)

        Dim firstDay = startdate
        While firstDay.DayOfWeek <> DayOfWeek.Monday
            firstDay = firstDay.AddDays(-1)
        End While

        Dim lastDay = startdate
        While lastDay.DayOfWeek <> DayOfWeek.Sunday
            lastDay = lastDay.AddDays(1)
        End While

        Return Tuple.Create(firstDay, lastDay)

    End Function
    Private Sub Inlog_Datum_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Inlog_Datum_but.Click
        ShowAgenda(InlogAgendaDatum.Value)
    End Sub


    Private Sub Inlog_opslaan_agenda_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Inlog_opslaan_agenda_but.Click

        Dim invultext As String = Inlog_agenda_invullen_txt.Text
        'AgendaFlexGrid
        Dim startfound As Boolean = False
        Dim start_datum As Date = Now
        Dim eind_datum As Date = Now
        For j = 2 To 4                     'cols
            For i = 1 To AgendaFlexGrid.Rows.Count - 2   'rows

                If AgendaFlexGrid.IsCellSelected(i, j) = True And startfound = False Then
                    startfound = True
                    start_datum = AgendaFlexGrid.Item(i, 1)
                    eind_datum = start_datum
                End If

                If AgendaFlexGrid.IsCellSelected(i + 1, j) = False And startfound = True Then
                    eind_datum = AgendaFlexGrid.Item(i, 1)


                    Try
                        'Open Connection
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()
                            'Execute Query
                            Dim Cmd As New OdbcCommand("INSERT INTO agenda(start_datum,eind_datum,vakantie,aktie,opmerking,tekst) VALUES(?,?,?,?,?,?)", Conn)
                            Cmd.Parameters.AddWithValue("", Format(start_datum, "yy-MM-dd"))
                            Cmd.Parameters.AddWithValue("", Format(eind_datum, "yy-MM-dd"))
                            If j = 2 Then
                                Cmd.Parameters.AddWithValue("", True)
                                Cmd.Parameters.AddWithValue("", False)
                                Cmd.Parameters.AddWithValue("", False)
                            ElseIf j = 3 Then
                                Cmd.Parameters.AddWithValue("", False)
                                Cmd.Parameters.AddWithValue("", True)
                                Cmd.Parameters.AddWithValue("", False)
                            ElseIf j = 4 Then
                                Cmd.Parameters.AddWithValue("", False)
                                Cmd.Parameters.AddWithValue("", False)
                                Cmd.Parameters.AddWithValue("", True)
                            End If
                            Cmd.Parameters.AddWithValue("", invultext)
                            Cmd.ExecuteNonQuery()

                        End Using
                    Catch ex As Exception
                        ErrorLog("Agenda opslaan: " + ex.Message)
                        MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                    End Try


                    Exit For
                End If


            Next i
            If startfound = True Then
                Exit For
            End If
        Next j


        ShowAgenda(InlogAgendaDatum.Value)
    End Sub
    Private Sub InlogTimer_Tick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles InlogTimer.Tick
        If SQLRUN = True Then
            TestSQLConnection()

            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Inloglijst_lst.Items.Clear()
                    Dim Reader2 As OdbcDataReader
                    Dim Cmd2 As New OdbcCommand("SELECT * FROM loginlijst ORDER BY tijd DESC", Conn)
                    Reader2 = Cmd2.ExecuteReader()
                    Dim lijstnaam As String = ""
                    Do While Reader2.Read
                        Dim inlognaam As String = Reader2("login_name")
                        Dim tijd As Date = Reader2("tijd")
                        lijstnaam = inlognaam + "       " + Format(tijd, "dddd HH:mm")

                        Inloglijst_lst.Items.Add(lijstnaam)
                    Loop


                End Using


            Catch ex As Exception
                MessageBox.Show("Fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                SQLRUN = False
            End Try
        End If
    End Sub
#End Region

#Region "Instellingen menu"

    Private Sub Inst_run_update_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Inst_run_update_but.Click
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd2 As New OdbcCommand("SELECT * FROM instellingen", Conn)
                Dim Reader2 As OdbcDataReader = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    Reader2.Read()
                    Dim new_version As String = CHstr(Reader2("version"))
                    Dim update_mandatory As Boolean = CHbool(Reader2("update_mandatory"))

                    Dim current_version As String = My.Settings.Versie
                    If current_version <> new_version Then
                        My.Settings.Versie = new_version
                        My.Settings.Save()
                    End If
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (update boek )" + ex.Message)
            MessageBox.Show("Database fout: (update boek)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        Try
            Process.Start("c:\boek\update.appref-ms", "app1")
            Application.Exit()
        Catch ex As Exception
            MsgBox("Updater not found")
        End Try




    End Sub

    Private Sub Settings_Save_But_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Settings_Save_But.Click
        My.Settings.MySQL_Server = Me.Inst_MySQLServer_Txt.Text
        My.Settings.MySQL_User = Me.Inst_MySQLUser_Txt.Text
        My.Settings.MySQL_Pass = Me.Inst_MySQLPass_Txt.Text
        My.Settings.MySQL_ODBC = Me.Inst_MySQLODBC_Txt.Text

        My.Settings.LoginName1 = Me.Inst_Login1_Txt.Text
        My.Settings.LoginName2 = Me.Inst_Login2_Txt.Text
        My.Settings.LoginName3 = Me.Inst_Login3_Txt.Text
        My.Settings.LoginName4 = Me.Inst_Login4_Txt.Text
        My.Settings.LoginName5 = Me.Inst_Login5_Txt.Text
        My.Settings.LoginName6 = Me.Inst_Login6_Txt.Text
        My.Settings.LoginName7 = Me.Inst_Login7_Txt.Text
        My.Settings.LoginName8 = Me.Inst_Login8_Txt.Text

        My.Settings.Inlog1Vestiging1 = Me.Inst_Login1_v1_chk.Checked
        My.Settings.Inlog2Vestiging1 = Me.Inst_Login2_v1_chk.Checked
        My.Settings.Inlog3Vestiging1 = Me.Inst_Login3_v1_chk.Checked
        My.Settings.Inlog4Vestiging1 = Me.Inst_Login4_v1_chk.Checked
        My.Settings.Inlog5Vestiging1 = Me.Inst_Login5_v1_chk.Checked
        My.Settings.Inlog6Vestiging1 = Me.Inst_Login6_v1_chk.Checked
        My.Settings.Inlog7Vestiging1 = Me.Inst_Login7_v1_chk.Checked
        My.Settings.Inlog8Vestiging1 = Me.Inst_Login8_v1_chk.Checked
        My.Settings.BarCodeServer = Me.Inst_barcodeserver.Checked
        My.Settings.Inlog1Vestiging2 = Me.Inst_Login1_v2_chk.Checked
        My.Settings.Inlog2Vestiging2 = Me.Inst_Login2_v2_chk.Checked
        My.Settings.Inlog3Vestiging2 = Me.Inst_Login3_v2_chk.Checked
        My.Settings.Inlog4Vestiging2 = Me.Inst_Login4_v2_chk.Checked
        My.Settings.Inlog5Vestiging2 = Me.Inst_Login5_v2_chk.Checked
        My.Settings.Inlog6Vestiging2 = Me.Inst_Login6_v2_chk.Checked
        My.Settings.Inlog7Vestiging2 = Me.Inst_Login7_v2_chk.Checked
        My.Settings.Inlog8Vestiging2 = Me.Inst_Login8_v2_chk.Checked
        '
        My.Settings.Inlog1VestigingTot = Me.Inst_Login1_T_chk.Checked
        My.Settings.Inlog2VestigingTot = Me.Inst_Login2_T_chk.Checked
        My.Settings.Inlog3VestigingTot = Me.Inst_Login3_T_chk.Checked
        My.Settings.Inlog4VestigingTot = Me.Inst_Login4_T_chk.Checked
        My.Settings.Inlog5VestigingTot = Me.Inst_Login5_T_chk.Checked
        My.Settings.Inlog6VestigingTot = Me.Inst_Login6_T_chk.Checked
        My.Settings.Inlog7VestigingTot = Me.Inst_Login7_T_chk.Checked
        My.Settings.Inlog8VestigingTot = Me.Inst_Login8_T_chk.Checked
        'Login page 
        Me.LoginNaam1_but.Text = My.Settings.LoginName1
        Me.LoginNaam2_but.Text = My.Settings.LoginName2
        Me.LoginNaam3_but.Text = My.Settings.LoginName3
        Me.LoginNaam4_but.Text = My.Settings.LoginName4
        Me.LoginNaam5_but.Text = My.Settings.LoginName5
        Me.LoginNaam6_but.Text = My.Settings.LoginName6
        Me.LoginNaam7_but.Text = My.Settings.LoginName7
        Me.LoginNaam8_but.Text = My.Settings.LoginName8

        My.Settings.labelprinterip = Me.Inst_printerip_txt.Text
        My.Settings.printselect = Me.Inst_printerselect_chk.Checked
        My.Settings.testserver = Me.inst_database_boekjenp.Checked
        My.Settings.dfdkleinprint = Me.inst_dfdkleinprint.Checked

        My.Settings.Save()

        'MySQL
        ConnString = "Driver={" + My.Settings.MySQL_ODBC + "};"
        ConnString = ConnString + "Server=" + My.Settings.MySQL_Server + ";"
        If inst_database_boekjenp.Checked = True Then
            ConnString = ConnString + "Database=boekjenp;"
        Else
            ConnString = ConnString + "Database=boek;"
        End If
        ConnString = ConnString + "User=" + My.Settings.MySQL_User + ";"
        ConnString = ConnString + "Password=" + My.Settings.MySQL_Pass + ";"

        If SQLRUN = True Then
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Dim Cmd As New OdbcCommand("", Conn)
                    Cmd.CommandText = "UPDATE instellingen SET paspoort1=?,paspoort2=?,paspoortb1=?,paspoortb2=?"
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", Val(Inst_paspoort1_txt.Text))
                    Cmd.Parameters.AddWithValue("", Val(Inst_paspoort2_txt.Text))
                    Cmd.Parameters.AddWithValue("", Val(Inst_paspoortb1_txt.Text))
                    Cmd.Parameters.AddWithValue("", Val(Inst_paspoortb2_txt.Text))
                    Cmd.ExecuteNonQuery()

                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (vervoertijden opslaan)" + ex.Message)
                MsgBox("Database fout: (vervoertijden opslaan)" + ex.Message, MsgBoxStyle.OkOnly)
            End Try
        End If

    End Sub
    Private Sub Settings_Cancel_But_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Settings_Cancel_But.Click
        Me.Inst_Login1_Txt.Text = My.Settings.LoginName1
        Me.Inst_Login2_Txt.Text = My.Settings.LoginName2
        Me.Inst_Login3_Txt.Text = My.Settings.LoginName3
        Me.Inst_Login4_Txt.Text = My.Settings.LoginName4
        Me.Inst_Login5_Txt.Text = My.Settings.LoginName5
        Me.Inst_Login6_Txt.Text = My.Settings.LoginName6
        Me.Inst_Login7_Txt.Text = My.Settings.LoginName7
        Me.Inst_Login8_Txt.Text = My.Settings.LoginName8

        Me.Inst_MySQLServer_Txt.Text = My.Settings.MySQL_Server
        Me.Inst_MySQLUser_Txt.Text = My.Settings.MySQL_User
        Me.Inst_MySQLPass_Txt.Text = My.Settings.MySQL_Pass
        Me.Inst_MySQLODBC_Txt.Text = My.Settings.MySQL_ODBC

        Me.Inst_Login1_v1_chk.Checked = My.Settings.Inlog1Vestiging1
        Me.Inst_Login2_v1_chk.Checked = My.Settings.Inlog2Vestiging1
        Me.Inst_Login3_v1_chk.Checked = My.Settings.Inlog3Vestiging1
        Me.Inst_Login4_v1_chk.Checked = My.Settings.Inlog4Vestiging1
        Me.Inst_Login5_v1_chk.Checked = My.Settings.Inlog5Vestiging1
        Me.Inst_Login6_v1_chk.Checked = My.Settings.Inlog6Vestiging1
        Me.Inst_Login7_v1_chk.Checked = My.Settings.Inlog7Vestiging1
        Me.Inst_Login8_v1_chk.Checked = My.Settings.Inlog8Vestiging1
        Me.Inst_barcodeserver.Checked = My.Settings.BarCodeServer
    End Sub
    Private Sub Inst_test_server_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Inst_test_server.Click
        My.Settings.MySQL_Server = Me.Inst_MySQLServer_Txt.Text
        My.Settings.MySQL_User = Me.Inst_MySQLUser_Txt.Text
        My.Settings.MySQL_Pass = Me.Inst_MySQLPass_Txt.Text
        My.Settings.MySQL_ODBC = Me.Inst_MySQLODBC_Txt.Text

        My.Settings.LoginName1 = Me.Inst_Login1_Txt.Text
        My.Settings.LoginName2 = Me.Inst_Login2_Txt.Text
        My.Settings.LoginName3 = Me.Inst_Login3_Txt.Text
        My.Settings.LoginName4 = Me.Inst_Login4_Txt.Text
        My.Settings.LoginName5 = Me.Inst_Login5_Txt.Text
        My.Settings.LoginName6 = Me.Inst_Login6_Txt.Text
        My.Settings.LoginName7 = Me.Inst_Login7_Txt.Text
        My.Settings.LoginName8 = Me.Inst_Login8_Txt.Text

        My.Settings.Inlog1Vestiging1 = Me.Inst_Login1_v1_chk.Checked
        My.Settings.Inlog2Vestiging1 = Me.Inst_Login2_v1_chk.Checked
        My.Settings.Inlog3Vestiging1 = Me.Inst_Login3_v1_chk.Checked
        My.Settings.Inlog4Vestiging1 = Me.Inst_Login4_v1_chk.Checked
        My.Settings.Inlog5Vestiging1 = Me.Inst_Login5_v1_chk.Checked
        My.Settings.Inlog6Vestiging1 = Me.Inst_Login6_v1_chk.Checked
        My.Settings.Inlog7Vestiging1 = Me.Inst_Login7_v1_chk.Checked
        My.Settings.Inlog8Vestiging1 = Me.Inst_Login8_v1_chk.Checked
        My.Settings.BarCodeServer = Me.Inst_barcodeserver.Checked

        My.Settings.Inlog1Vestiging2 = Me.Inst_Login1_v2_chk.Checked
        My.Settings.Inlog2Vestiging2 = Me.Inst_Login2_v2_chk.Checked
        My.Settings.Inlog3Vestiging2 = Me.Inst_Login3_v2_chk.Checked
        My.Settings.Inlog4Vestiging2 = Me.Inst_Login4_v2_chk.Checked
        My.Settings.Inlog5Vestiging2 = Me.Inst_Login5_v2_chk.Checked
        My.Settings.Inlog6Vestiging2 = Me.Inst_Login6_v2_chk.Checked
        My.Settings.Inlog7Vestiging2 = Me.Inst_Login7_v2_chk.Checked
        My.Settings.Inlog8Vestiging2 = Me.Inst_Login8_v2_chk.Checked
        '
        My.Settings.Inlog1VestigingTot = Me.Inst_Login1_T_chk.Checked
        My.Settings.Inlog2VestigingTot = Me.Inst_Login2_T_chk.Checked
        My.Settings.Inlog3VestigingTot = Me.Inst_Login3_T_chk.Checked
        My.Settings.Inlog4VestigingTot = Me.Inst_Login4_T_chk.Checked
        My.Settings.Inlog5VestigingTot = Me.Inst_Login5_T_chk.Checked
        My.Settings.Inlog6VestigingTot = Me.Inst_Login6_T_chk.Checked
        My.Settings.Inlog7VestigingTot = Me.Inst_Login7_T_chk.Checked
        My.Settings.Inlog8VestigingTot = Me.Inst_Login8_T_chk.Checked

        My.Settings.Save()

        'MySQL
        ConnString = "Driver={MySQL ODBC 3.51 Driver};"
        ConnString = ConnString + "Server=" + My.Settings.MySQL_Server + ";"
        ConnString = ConnString + "Database=boek;"
        ConnString = ConnString + "User=" + My.Settings.MySQL_User + ";"
        ConnString = ConnString + "Password=" + My.Settings.MySQL_Pass + ";"

        If TestSQL() = True Then
            MsgBox("Verbinding in orde, programma restart", vbOK)

            End

            Setup_Order_Grid()
            ShowAgenda(Now)
            'load fust,karren etc from database 
            Load_Database_fusten()
            Load_Database_karren()
            Load_Database_orderinfo()
            Load_Database_vervoerder()
            Load_Database_soorten()
            Load_Database_accessoires()
            Load_Database_mixen()
            Load_Database_prijzen()
            Load_Database_kopers()
            Load_Database_klantgroepen()
            Load_Database_keurcodes()
            Create_SoortMixTable()
            Setup_Order_Grid()

        End If


    End Sub

    Private Sub Inst_Vervoer_opslaan_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Inst_Vervoer_opslaan_but.Click
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim weekdag As Integer = 0
                Dim dag As String = Inst_weekdag_cmb.SelectedItem
                Select Case dag
                    Case "Maandag" : Weekdag = 1
                    Case "Dinsdag" : weekdag = 2
                    Case "Woensdag" : weekdag = 3
                    Case "Donderdag" : weekdag = 4
                    Case "Vrijdag" : weekdag = 5
                    Case "Zaterdag" : weekdag = 6
                    Case "Zondag" : weekdag = 7
                End Select
                If weekdag = 0 Then Exit Sub

                Dim newentry As Boolean = True
                Dim reader As OdbcDataReader
                Dim Cmd2 As New OdbcCommand("SELECT * FROM vervoerstijden WHERE weekdag=?", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", weekdag)
                reader = Cmd2.ExecuteReader()
                If reader.HasRows Then newentry = False
                reader.Close()

                Dim veiling As Integer = 1
                Dim checked As Boolean = False
                Dim checktijd As Integer = "12"
                Dim subdag As Integer = 0
                Dim boektijd As String = "12:00"

                For positie = 1 To 7

                    veiling = 1
                    Select Case positie
                        Case 1
                            checked = Inst_w1_chk.Checked
                            checktijd = Val(Inst_wchktijd1_txt.Text)
                            subdag = Inst_wdag1_ud.Value
                            boektijd = Trim(Inst_wboektijd1_txt.Text)
                        Case 2
                            checked = Inst_w2_chk.Checked
                            checktijd = Val(Inst_wchktijd2_txt.Text)
                            subdag = Inst_wdag2_ud.Value
                            boektijd = Trim(Inst_wboektijd2_txt.Text)
                        Case 3
                            checked = Inst_w3_chk.Checked
                            checktijd = Val(Inst_wchktijd3_txt.Text)
                            subdag = Inst_wdag3_ud.Value
                            boektijd = Trim(Inst_wboektijd3_txt.Text)
                        Case 4
                            checked = Inst_w4_chk.Checked
                            checktijd = Val(Inst_wchktijd4_txt.Text)
                            subdag = Inst_wdag4_ud.Value
                            boektijd = Trim(Inst_wboektijd4_txt.Text)
                        Case 5
                            checked = Inst_w5_chk.Checked
                            checktijd = Val(Inst_wchktijd5_txt.Text)
                            subdag = Inst_wdag5_ud.Value
                            boektijd = Trim(Inst_wboektijd5_txt.Text)
                        Case 6
                            checked = Inst_w6_chk.Checked
                            checktijd = Val(Inst_wchktijd6_txt.Text)
                            subdag = Inst_wdag6_ud.Value
                            boektijd = Trim(Inst_wboektijd6_txt.Text)
                        Case 7
                            checked = Inst_w7_chk.Checked
                            checktijd = Val(Inst_wchktijd7_txt.Text)
                            subdag = Inst_wdag7_ud.Value
                            boektijd = Trim(Inst_wboektijd7_txt.Text)
                    End Select
                    Dim Cmd As New OdbcCommand("", Conn)
                    If newentry = True Then
                        Cmd.CommandText = "INSERT INTO vervoerstijden(weekdag,veiling,positie,checked,checktijd,subdag,boektijd) VALUES(?,?,?,?,?,?,?)"
                    Else
                        Cmd.CommandText = "UPDATE vervoerstijden SET weekdag=?,veiling=?,positie=?,checked=?,checktijd=?,subdag=?,boektijd=? WHERE weekdag = ? AND positie=? AND veiling=1"
                    End If
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", weekdag)
                    Cmd.Parameters.AddWithValue("", veiling)
                    Cmd.Parameters.AddWithValue("", positie)
                    Cmd.Parameters.AddWithValue("", checked)
                    Cmd.Parameters.AddWithValue("", checktijd)
                    Cmd.Parameters.AddWithValue("", subdag)
                    Cmd.Parameters.AddWithValue("", boektijd)
                    If newentry = False Then
                        Cmd.Parameters.AddWithValue("", weekdag)
                        Cmd.Parameters.AddWithValue("", positie)
                    End If
                    Cmd.ExecuteNonQuery()
                Next positie

                For positie = 1 To 7
                    veiling = 2
                    Select Case positie
                        Case 1
                            checked = Inst_o1_chk.Checked
                            checktijd = Val(Inst_ochktijd1_txt.Text)
                            subdag = Inst_odag1_ud.Value
                            boektijd = Trim(Inst_oboektijd1_txt.Text)
                        Case 2
                            checked = Inst_o2_chk.Checked
                            checktijd = Val(Inst_ochktijd2_txt.Text)
                            subdag = Inst_odag2_ud.Value
                            boektijd = Trim(Inst_oboektijd2_txt.Text)
                        Case 3
                            checked = Inst_o3_chk.Checked
                            checktijd = Val(Inst_ochktijd3_txt.Text)
                            subdag = Inst_odag3_ud.Value
                            boektijd = Trim(Inst_oboektijd3_txt.Text)
                        Case 4
                            checked = Inst_o4_chk.Checked
                            checktijd = Val(Inst_ochktijd4_txt.Text)
                            subdag = Inst_odag4_ud.Value
                            boektijd = Trim(Inst_oboektijd4_txt.Text)
                        Case 5
                            checked = Inst_o5_chk.Checked
                            checktijd = Val(Inst_ochktijd5_txt.Text)
                            subdag = Inst_odag5_ud.Value
                            boektijd = Trim(Inst_oboektijd5_txt.Text)
                        Case 6
                            checked = Inst_o6_chk.Checked
                            checktijd = Val(Inst_ochktijd6_txt.Text)
                            subdag = Inst_odag6_ud.Value
                            boektijd = Trim(Inst_oboektijd6_txt.Text)
                        Case 7
                            checked = Inst_o7_chk.Checked
                            checktijd = Val(Inst_ochktijd7_txt.Text)
                            subdag = Inst_odag7_ud.Value
                            boektijd = Trim(Inst_oboektijd7_txt.Text)
                    End Select

                    Dim Cmd As New OdbcCommand("", Conn)
                    If newentry = True Then
                        Cmd.CommandText = "INSERT INTO vervoerstijden(weekdag,veiling,positie,checked,checktijd,subdag,boektijd) VALUES(?,?,?,?,?,?,?)"
                    Else
                        Cmd.CommandText = "UPDATE vervoerstijden SET weekdag=?,veiling=?,positie=?,checked=?,checktijd=?,subdag=?,boektijd=? WHERE weekdag = ? AND positie=? AND veiling=2"
                    End If
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", weekdag)
                    Cmd.Parameters.AddWithValue("", veiling)
                    Cmd.Parameters.AddWithValue("", positie)
                    Cmd.Parameters.AddWithValue("", checked)
                    Cmd.Parameters.AddWithValue("", checktijd)
                    Cmd.Parameters.AddWithValue("", subdag)
                    Cmd.Parameters.AddWithValue("", boektijd)
                    If newentry = False Then
                        Cmd.Parameters.AddWithValue("", weekdag)
                        Cmd.Parameters.AddWithValue("", positie)
                    End If

                    Cmd.ExecuteNonQuery()

                Next positie

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (vervoertijden opslaan)" + ex.Message)
            MsgBox("Database fout: (vervoertijden opslaan)" + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        Inst_Vervoer_opslaan_but.Enabled = False
        Inst_Vervoer_annuleren_but.Enabled = False
        Inst_Vervoer_aanpassen_but.Enabled = True
        Inst_weekdag_cmb.Enabled = True
        Inst_Westland_GB.Enabled = False
        Inst_Overig_GB.Enabled = False
    End Sub

    Private Sub Inst_Vervoer_aanpassen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Inst_Vervoer_aanpassen_but.Click
        Dim dag As String = Inst_weekdag_cmb.SelectedItem
        If dag <> "Selecteer dag" Then
            Inst_Vervoer_aanpassen_but.Enabled = False
            Inst_weekdag_cmb.Enabled = False
            Inst_Westland_GB.Enabled = True
            Inst_Overig_GB.Enabled = True

            Dim weekdag As Integer = 1
            Select Case dag
                Case "Maandag" : Weekdag = 1
                Case "Dinsdag" : weekdag = 2
                Case "Woensdag" : weekdag = 3
                Case "Donderdag" : weekdag = 4
                Case "Vrijdag" : weekdag = 5
                Case "Zaterdag" : weekdag = 6
                Case "Zondag" : weekdag = 7
            End Select
            laad_aanvoertijden(weekdag)

            Inst_Vervoer_opslaan_but.Enabled = True
            Inst_Vervoer_annuleren_but.Enabled = True
        End If
    End Sub

    Private Sub Inst_Vervoer_annuleren_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Inst_Vervoer_annuleren_but.Click
        Inst_Vervoer_opslaan_but.Enabled = False
        Inst_Vervoer_annuleren_but.Enabled = False
        Inst_Vervoer_aanpassen_but.Enabled = True
        Inst_weekdag_cmb.Enabled = True
        Inst_Westland_GB.Enabled = False
        Inst_Overig_GB.Enabled = False

        Dim weekdag As Integer = 0
        Dim dag As String = Inst_weekdag_cmb.SelectedItem
        Select Case dag
            Case "Maandag" : weekdag = 1
            Case "Dinsdag" : weekdag = 2
            Case "Woensdag" : weekdag = 3
            Case "Donderdag" : weekdag = 4
            Case "Vrijdag" : weekdag = 5
            Case "Zaterdag" : weekdag = 6
            Case "Zondag" : weekdag = 7
        End Select
        If weekdag > 0 Then laad_aanvoertijden(weekdag)

    End Sub


    Private Sub laad_aanvoertijden(ByVal weekdag As Integer)
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim newentry As Boolean = True
                Dim reader As OdbcDataReader
                Dim Cmd2 As New OdbcCommand("SELECT * FROM vervoerstijden WHERE weekdag=?", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", weekdag)
                reader = Cmd2.ExecuteReader()
                Do While reader.Read

                    Dim veiling As Integer = CHint(reader("veiling"))
                    Dim positie As Integer = CHint(reader("positie"))
                    Dim checked As Boolean = CHbool(reader("checked"))
                    Dim checktijd As String = CHstr(reader("checktijd"))
                    Dim subdag As Integer = CHint(reader("subdag"))
                    Dim boektijd As String = CHstr(reader("boektijd"))

                    If veiling = 1 Then
                        Select Case positie
                            Case 1
                                Inst_w1_chk.Checked = checked
                                Inst_wchktijd1_txt.Text = checktijd
                                Inst_wdag1_ud.Value = subdag
                                Inst_wboektijd1_txt.Text = boektijd
                            Case 2
                                Inst_w2_chk.Checked = checked
                                Inst_wchktijd2_txt.Text = checktijd
                                Inst_wdag2_ud.Value = subdag
                                Inst_wboektijd2_txt.Text = boektijd
                            Case 3
                                Inst_w3_chk.Checked = checked
                                Inst_wchktijd3_txt.Text = checktijd
                                Inst_wdag3_ud.Value = subdag
                                Inst_wboektijd3_txt.Text = boektijd
                            Case 4
                                Inst_w4_chk.Checked = checked
                                Inst_wchktijd4_txt.Text = checktijd
                                Inst_wdag4_ud.Value = subdag
                                Inst_wboektijd4_txt.Text = boektijd
                            Case 5
                                Inst_w5_chk.Checked = checked
                                Inst_wchktijd5_txt.Text = checktijd
                                Inst_wdag5_ud.Value = subdag
                                Inst_wboektijd5_txt.Text = boektijd
                            Case 6
                                Inst_w6_chk.Checked = checked
                                Inst_wchktijd6_txt.Text = checktijd
                                Inst_wdag6_ud.Value = subdag
                                Inst_wboektijd6_txt.Text = boektijd
                            Case 7
                                Inst_w7_chk.Checked = checked
                                Inst_wchktijd7_txt.Text = checktijd
                                Inst_wdag7_ud.Value = subdag
                                Inst_wboektijd7_txt.Text = boektijd
                        End Select
                    End If
                    If veiling = 2 Then
                        Select Case positie
                            Case 1
                                Inst_o1_chk.Checked = checked
                                Inst_ochktijd1_txt.Text = checktijd
                                Inst_odag1_ud.Value = subdag
                                Inst_oboektijd1_txt.Text = boektijd
                            Case 2
                                Inst_o2_chk.Checked = checked
                                Inst_ochktijd2_txt.Text = checktijd
                                Inst_odag2_ud.Value = subdag
                                Inst_oboektijd2_txt.Text = boektijd
                            Case 3
                                Inst_o3_chk.Checked = checked
                                Inst_ochktijd3_txt.Text = checktijd
                                Inst_odag3_ud.Value = subdag
                                Inst_oboektijd3_txt.Text = boektijd
                            Case 4
                                Inst_o4_chk.Checked = checked
                                Inst_ochktijd4_txt.Text = checktijd
                                Inst_odag4_ud.Value = subdag
                                Inst_oboektijd4_txt.Text = boektijd
                            Case 5
                                Inst_o5_chk.Checked = checked
                                Inst_ochktijd5_txt.Text = checktijd
                                Inst_odag5_ud.Value = subdag
                                Inst_oboektijd5_txt.Text = boektijd
                            Case 6
                                Inst_o6_chk.Checked = checked
                                Inst_ochktijd6_txt.Text = checktijd
                                Inst_odag6_ud.Value = subdag
                                Inst_oboektijd6_txt.Text = boektijd
                            Case 7
                                Inst_o7_chk.Checked = checked
                                Inst_ochktijd7_txt.Text = checktijd
                                Inst_odag7_ud.Value = subdag
                                Inst_oboektijd7_txt.Text = boektijd
                        End Select

                    End If

                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (vervoertijden opslaan)" + ex.Message)
            MsgBox("Database fout: (vervoertijden opslaan)" + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub

    Private Sub Inst_weekdag_cmb_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Inst_weekdag_cmb.SelectedIndexChanged
        Dim weekdag As Integer = 0
        Dim dag As String = Inst_weekdag_cmb.SelectedItem
        Select Case dag
            Case "Maandag" : weekdag = 1
            Case "Dinsdag" : weekdag = 2
            Case "Woensdag" : weekdag = 3
            Case "Donderdag" : weekdag = 4
            Case "Vrijdag" : weekdag = 5
            Case "Zaterdag" : weekdag = 6
            Case "Zondag" : weekdag = 7
        End Select
        If weekdag > 0 Then laad_aanvoertijden(weekdag)
    End Sub

#End Region

#Region "Database"

    Dim current_dbtable As String = ""
    Dim current_dbtype As Integer = 0
    Dim current_dbselection As String = ""
    Dim current_dbid As Integer = 0
    Dim dbtable() As tablelayout
    Dim current_dbbuild As tablelayout()

    Private Sub SetupNewDatabase(table_id As Integer)
        Try

            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                If table_id = 13 Then  'update floriday_tradeitem_boek tabel -> insert new ids uit tradeitem
                    Dim query As String = ""
                    Dim Cmd2 As New OdbcCommand(query, Conn)
                    Dim Reader2 As OdbcDataReader
                    Dim Cmd3 As New OdbcCommand(query, Conn)
                    Dim Reader3 As OdbcDataReader
                    Dim Cmd4 As New OdbcCommand(query, Conn)
                    '2 tabellen vergelijken, en daarna synchoriseren
                    query = "SELECT tradeItemId FROM (SELECT tradeItemId FROM floriday_tradeitem UNION ALL SELECT tradeItemId FROM floriday_tradeitem_boek)utable GROUP BY tradeItemId HAVING COUNT(*) = 1"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    Do While Reader2.Read
                        Dim tradeItemId As String = CHstr(Reader2("tradeItemId"))
                        query = "SELECT tradeItemId,tradeItemName_nl,supplierArticleCode FROM floriday_tradeitem WHERE isDeleted=0 AND parentId='' AND tradeItemId='" + tradeItemId + "'"
                        Cmd3.CommandText = query
                        Reader3 = Cmd3.ExecuteReader()
                        If Reader3.HasRows Then
                            Dim tradeItemName As String = CHstr(Reader3("tradeItemName_nl"))
                            Dim supplierArticleCode As String = CHstr(Reader3("supplierArticleCode"))
                            query = "INSERT INTO floriday_tradeitem_boek SET tradeItemId=?,tradeItemName=?,kwekerscode=?,boek_soortcode=0,boek_hoes=0,boek_accessoire1=0,boek_accessoire2=0,boek_accessoire3=0,boek_accessoire4=0"
                            Cmd4.CommandText = query
                            Cmd4.Parameters.Clear()
                            Cmd4.Parameters.AddWithValue("", tradeItemId)
                            Cmd4.Parameters.AddWithValue("", tradeItemName)
                            Cmd4.Parameters.AddWithValue("", supplierArticleCode)
                            Cmd4.ExecuteNonQuery()
                        End If
                        Reader3.Close()
                    Loop
                    Reader2.Close()
                End If

                If table_id = 14 Then  'update floriday_addservices_boek tabel -> insert new ids 
                    Dim query As String = ""
                    Dim Cmd2 As New OdbcCommand(query, Conn)
                    Dim Reader2 As OdbcDataReader
                    Dim Cmd3 As New OdbcCommand(query, Conn)
                    Dim Reader3 As OdbcDataReader
                    Dim Cmd4 As New OdbcCommand(query, Conn)
                    '2 tabellen vergelijken, en daarna synchoriseren
                    query = "SELECT additionalServiceId FROM (SELECT additionalServiceId FROM floriday_additionalservices UNION ALL SELECT additionalServiceId FROM floriday_additionalservices_boek)utable GROUP BY additionalServiceId HAVING COUNT(*) = 1"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    Do While Reader2.Read
                        Dim additionalServiceId As String = CHstr(Reader2("additionalServiceId"))
                        query = "SELECT additionalServiceId,name FROM floriday_additionalservices WHERE additionalServiceId='" + additionalServiceId + "'"
                        Cmd3.CommandText = query
                        Reader3 = Cmd3.ExecuteReader()
                        If Reader3.HasRows Then
                            Dim name As String = CHstr(Reader3("name"))
                            query = "INSERT INTO floriday_additionalservices_boek SET additionalServiceId=?,name=?,boek_accessoire1=0,boek_accessoire2=0,ordernietverwerken=0"
                            Cmd4.CommandText = query
                            Cmd4.Parameters.Clear()
                            Cmd4.Parameters.AddWithValue("", additionalServiceId)
                            Cmd4.Parameters.AddWithValue("", name)
                            Cmd4.ExecuteNonQuery()
                        End If
                        Reader3.Close()
                    Loop
                    Reader2.Close()
                End If



                If table_id = 11 Then
                    'show selection
                    'LoadCombo(Database_preselect_cmb, dt_favorieten_naam, False)
                    'Database_preselect_cmb.Visible = True
                Else
                    'hide selection
                    Database_preselect_cmb.Visible = False
                End If

                Dim Cmd As New OdbcCommand("SELECT * FROM db_dt_tables WHERE id=?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", table_id)
                Dim Reader As OdbcDataReader = Cmd.ExecuteReader()

                If Reader.HasRows Then
                    Reader.Read()
                    Dim tablename As String = CHstr(Reader("tablename"))
                    Dim admin As Boolean = CHbool(Reader("admin"))

                    If admin = True Then
                        If user = 0 Then
                            current_dbtable = tablename
                            LoadNewDatabase()
                        Else
                            MsgBox("Access to this table is restricted")
                        End If
                    End If
                    If admin = False Then
                        current_dbtable = tablename
                        LoadNewDatabase()
                    End If
                End If

                Conn.Close()
            End Using
        Catch ex As Exception
            MessageBox.Show("Database fout: laad databases " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        '
    End Sub

    Private Sub LoadNewDatabase()

        Dim table As String = current_dbtable
        If table <> "N.V.T." Then
            DatabaseFlexGridShow.AllowEditing = True
            dbtable = BuildTable(table, DatabaseFlexGridShow)
            current_dbbuild = dbtable
            Dim sql As String = "SELECT * FROM " + table

            FillTable(table, dbtable, DatabaseFlexGridShow, sql)

        End If
    End Sub

    Private Sub CheckForDoubleEAN()
        For row = 2 To DatabaseFlexGridShow.Rows.Count - 1
            If CType(DatabaseFlexGridShow.Item(row, 1), Boolean) = True Then   'Row edited? 

                Dim EAN As String = CType(DatabaseFlexGridShow.Item(row, 3), String)

                For rowloop = 2 To DatabaseFlexGridShow.Rows.Count - 1
                    Dim CheckEAN As String = CType(DatabaseFlexGridShow.Item(rowloop, 3), String)
                    If EAN = CheckEAN And Not (row = rowloop) Then
                        DatabaseFlexGridShow.Item(row, 1) = False 'remove edit check so its not saved
                        MsgBox("De kweker " + CType(DatabaseFlexGridShow.Item(row, 2), String) + " bestaat al onder naam '" + CType(DatabaseFlexGridShow.Item(rowloop, 2), String) + "' en is niet opgeslagen")
                    End If
                Next

            End If
        Next
    End Sub
    Private Sub DatabaseFlexGridEdit_SetupEditor(ByVal sender As System.Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles DatabaseFlexGridEdit.SetupEditor
        If TypeOf DatabaseFlexGridEdit.Editor Is ComboBox Then
            DirectCast(DatabaseFlexGridEdit.Editor, ComboBox).MaxDropDownItems = 30
        End If
    End Sub
    Private Sub DatabaseFlexGridShow_SetupEditor(ByVal sender As System.Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles DatabaseFlexGridShow.SetupEditor
        If TypeOf DatabaseFlexGridShow.Editor Is ComboBox Then
            DirectCast(DatabaseFlexGridShow.Editor, ComboBox).MaxDropDownItems = 20
        End If
    End Sub
    Private Sub Database_Combo_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Database_Combo.SelectedIndexChanged

        Dim table_id As Integer = -1
        Dim dbtype As Integer = -1
        current_dbtable = "N.V.T."
        Dim selecteditem As String = ""
        DatabaseFlexGridShow.Rows.Count = 1
        DatabaseFlexGridEdit.Visible = False

        Try
            table_id = CInt(DirectCast(DirectCast(Database_Combo.SelectedItem, System.Object), System.Data.DataRowView).Item(0))
            selecteditem = CStr(DirectCast(DirectCast(Database_Combo.SelectedItem, System.Object), System.Data.DataRowView).Item(1))
            dbtype = CInt(DirectCast(DirectCast(Database_Combo.SelectedItem, System.Object), System.Data.DataRowView).Item(2))
            current_dbselection = selecteditem
            current_dbtype = dbtype
            current_dbtable = table_id
        Catch ex As Exception
            table_id = -1
            dbtype = -1
            current_dbselection = ""
            current_dbtype = -1
            current_dbtable = -1
        End Try
        If table_id > 0 And dbtype >= 0 Then

            current_dbid = table_id

            If dbtype = 0 Then  'nieuw type database
                DatabaseMenuHerladen_but.Visible = True
                DatabaseMenuNieuw.Visible = True
                DatabaseMenuAanpassen.Visible = False
                DatabaseMenuCopy_but.Visible = True
                DatabaseMenuOpslaan.Visible = True
                DatabaseFlexGridShow.AllowFiltering = True

            End If

            If dbtype = 1 Then  'oud type database

                DatabaseFlexGridShow.AllowFiltering = False

                DatabaseFlexGridEdit.Visible = True
                DatabaseMenuHerladen_but.Visible = False
                DatabaseMenuNieuw.Visible = True
                DatabaseMenuAanpassen.Visible = True
                DatabaseMenuCopy_but.Visible = False
                DatabaseMenuOpslaan.Visible = True
            End If

        End If

        DatabaseFlexGridShow.AllowEditing = False
        DatabaseFlexGridShow.SelectionMode = SelectionModeEnum.ListBox
        DatabaseFlexGridShow.Cols.Fixed = 0
        DatabaseFlexGridShow.AllowSorting = AllowSortingEnum.SingleColumn
        DatabaseFlexGridShow.AllowDragging = AllowDraggingEnum.None
        DatabaseMenuNieuw.Enabled = True
        DatabaseMenuAanpassen.Enabled = True
        DatabaseMenuOpslaan.Enabled = True
        DatabaseMenuSDFPL_but.Visible = False

        If dbtype = 0 Then
            database_lbl.Text = current_dbselection
            SetupNewDatabase(table_id)
        End If

        If dbtype = 1 Then


            Select Case selecteditem
                Case "Kopers"
                    Set_FlexIndeling_kopers()
                    LoadDB_FlexIndeling_kopers()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Kopers"
                Case "Koper alias"
                    Set_Flexindeling_koper_alias()
                    LoadDB_FlexIndeling_koper_alias()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Koper alias"
                Case "Fusten"
                    Set_Flexindeling_fusten()
                    LoadDB_Flexindeling_fusten()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Fusten"
                Case "Soorten"
                    Set_Flexindeling_soorten()
                    LoadDB_Flexindeling_soorten()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Soorten"
                Case "Soortgroepen"
                    Set_Flexindeling_soortgroep()
                    LoadDB_Flexindeling_soortgroepen()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Soortgroepen"
                Case "Accessoires"
                    Set_Flexindeling_accessoires()
                    LoadDB_Flexindeling_accessoires()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Accessoires"
                Case "Accessoire prijzen"
                    Set_Flexindeling_accessoire_prijzen()
                    LoadDB_Flexindeling_accessoire_prijzen()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Accessoire prijzen"
                Case "Mixen naam"
                    Set_Flexindeling_mixen()
                    LoadDB_Flexindeling_mixen()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Mixen naam"
                Case "Mixen vullen"
                    Set_Flexindeling_mixenvullen()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Mixen vullen"
                Case "Kopersgroepen"
                    Set_Flexindeling_kopersgroep()
                    LoadDB_Flexindeling_kopersgroepen()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Kopersgroepen"
                Case "Eindklanten"
                    Set_flexindeling_eindklanten()
                    ' LoadDB_Flexindeling_eindklanten()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Eindklanten"

                Case "Agenda"
                    Set_Flexindeling_agenda()
                    LoadDB_Flexindeling_agenda()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Agenda"
                Case "Soort volgorde"
                    DatabaseMenuNieuw.Enabled = False
                    DatabaseMenuAanpassen.Enabled = False
                    LoadDB_Flexindeling_soortvolgorde()
                    DatabaseFlexGridShow.Focus()
                    database_lbl.Text = "Soort volgorde"
                Case "Favorieten"
                    DatabaseMenuNieuw.Enabled = False
                    DatabaseMenuAanpassen.Enabled = False
                    Set_Flexindeling_favorieten()
                    LoadDB_Flexindeling_favorieten()
                    DatabaseFlexGridShow.Focus()
                    database_lbl.Text = "Favorieten"
                Case "Mix lagen"
                    Set_Flexindeling_mixlagenvullen()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Mix lagen"
                Case "Florecom soortmatch opm"
                    Set_FlexIndeling_soortmatch1()
                    loadDB_FlexIndeling_soortmatch1()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Florecom soortmatch opm"
                Case "Florecom soortmatch -"
                    Set_FlexIndeling_soortmatch2()
                    loadDB_FlexIndeling_soortmatch2()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Florecom soortmatch -"
                Case "Kwekerscode"
                    Set_FlexIndeling_kwekerscode()
                    loadDB_FlexIndeling_kwekerscode()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Kwekerscode"
                Case "Fust categorie vullen"
                    Set_Flexindeling_fustcategorie()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Fust categorie vullen"
                Case "Hoes categorie vullen"
                    Set_Flexindeling_hoescategorie()
                    DatabaseFlexGridEdit.Focus()
                    database_lbl.Text = "Hoes categorie vullen"
                Case "Prijslijst J&P importeren"
                    If jenptenhave = True Then
                        Set_Flexindeling_prijslijstJenPimport()
                        DatabaseFlexGridEdit.Focus()
                        database_lbl.Text = "Prijslijst J en P importeren"
                        DatabaseMenuSDFPL_but.Visible = True
                    End If
                Case "Prijslijst kortingtabel"
                    If jenptenhave = True Then
                        Set_Flexindeling_prijslijstkortingtabel()
                        DatabaseFlexGridEdit.Focus()
                        loadDB_FlexIndeling_prijslijstkortingtabel()
                        database_lbl.Text = "Prijslijst kortingtabel"
                    End If

                Case "Prijslijst koppelingen"
                    If jenptenhave = True Then
                        Set_Flexindeling_prijslijstkoppelingen()
                        DatabaseFlexGridEdit.Focus()
                        loadDB_FlexIndeling_prijslijstkoppelingen()
                        database_lbl.Text = "Prijslijst koppelingen"
                    End If
            End Select

        End If
    End Sub
    Private Sub DatabaseFlexGridEdit_BeforeEdit(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles DatabaseFlexGridEdit.BeforeEdit
        If current_dbtype = 1 Then
            If DatabaseFlexGridEdit.Cols(e.Col).DataType = System.Type.GetType("System.int32") Then
                DatabaseFlexGridEdit.Item(e.Row, e.Col) = Int(Val(DatabaseFlexGridEdit.Item(e.Row, e.Col)))
            End If

            If database_lbl.Text = "Mixen vullen" Then   'load mixen vullen on combo_change
                Static old_selected_mix As Integer
                If DatabaseFlexGridEdit.GetData(1, 0) <> old_selected_mix Then
                    old_selected_mix = DatabaseFlexGridEdit.GetData(1, 0)
                    Set_Flexindeling_mixenvullengrid2()
                    LoadDB_Flexindeling_mixenvullen()
                End If

            End If

            If database_lbl.Text = "Mix lagen" Then   'load mix lagen on combo_change
                Static old_selected_mixlaag As Integer
                If DatabaseFlexGridEdit.GetData(1, 0) <> old_selected_mixlaag Then
                    old_selected_mixlaag = DatabaseFlexGridEdit.GetData(1, 0)
                    Set_Flexindeling_mixlagenvullenGrid2()
                    LoadDB_Flexindeling_mixlagenvullen()
                End If

            End If

            '   If database_lbl.Text = "Hoes categorie vullen" Then   'load hoescategorie on combo_change
            ' Static old_selected_hoescat As Integer
            ' If DatabaseFlexGridEdit.GetData(1, 0) <> old_selected_hoescat Then
            ' old_selected_hoescat = DatabaseFlexGridEdit.GetData(1, 0)
            ' Set_Flexindeling_hoescategorievullengrid2()
            ' LoadDB_Flexindeling_hoescategorievullen()
            ' End If

            'End If
        End If
    End Sub
    Private Sub DatabaseFlexGridShow_AfterEdit(sender As Object, e As RowColEventArgs) Handles DatabaseFlexGridShow.AfterEdit
        If current_dbtype = 0 Then
            Dim table As String = current_dbtable
            dbtable = current_dbbuild
            If table <> "N.V.T." Then
                AfterEdit(DatabaseFlexGridShow)
            End If

            If current_dbtable = "fusten2" Then
                Dim col1 As Integer = FindCol(DatabaseFlexGridShow, "Aantal per fust")
                Dim col2 As Integer = FindCol(DatabaseFlexGridShow, "plaats_string")
                Dim onestring As String = ""
                Dim aantalperfust As Integer = DatabaseFlexGridShow.Item(e.Row, col1)
                If aantalperfust > 99 Then aantalperfust = 99
                For i = 1 To aantalperfust
                    onestring = onestring + "1"
                Next
                DatabaseFlexGridShow.Item(e.Row, col2) = onestring
            End If
        End If
    End Sub
    Private Sub Set_Flexindeling_agenda()
        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 8
            .Rows.Count = 1

            .Cols(0).Caption = "Start Datum"
            .Cols(0).DataType = System.Type.GetType("System.DateTime")
            .Cols(0).Width = 100
            .Cols(0).Format = "d"
            .Cols(0).AllowEditing = True

            .Cols(1).Caption = "Eind Datum"
            .Cols(1).DataType = System.Type.GetType("System.DateTime")
            .Cols(1).Width = 100
            .Cols(1).Format = "d"
            .Cols(1).AllowEditing = True

            .Cols(2).Caption = "Vakantie"
            .Cols(2).DataType = System.Type.GetType("System.Boolean")
            .Cols(2).Width = 60
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "Aktie"
            .Cols(3).DataType = System.Type.GetType("System.Boolean")
            .Cols(3).Width = 60
            .Cols(3).AllowEditing = True

            .Cols(4).Caption = "Opmerking"
            .Cols(4).DataType = System.Type.GetType("System.Boolean")
            .Cols(4).Width = 60
            .Cols(4).AllowEditing = True

            .Cols(5).Caption = "Tekst"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 200
            .Cols(5).AllowEditing = True

            .Cols(6).Caption = "id"
            .Cols(6).DataType = System.Type.GetType("System.int32")
            .Cols(6).Width = 50
            .Cols(6).AllowEditing = False

            .Cols(7).Caption = "Verwijder"
            .Cols(7).DataType = System.Type.GetType("System.Boolean")
            .Cols(7).Width = 60
            .Cols(7).AllowEditing = True
        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 7
            .Rows.Count = 1

            .Cols(0).Caption = "Start Datum"
            .Cols(0).DataType = System.Type.GetType("System.DateTime")
            .Cols(0).Width = 100

            .Cols(1).Caption = "Eind Datum"
            .Cols(1).DataType = System.Type.GetType("System.DateTime")
            .Cols(1).Width = 100

            .Cols(2).Caption = "Vakantie"
            .Cols(2).DataType = System.Type.GetType("System.Boolean")
            .Cols(2).Width = 60

            .Cols(3).Caption = "Aktie"
            .Cols(3).DataType = System.Type.GetType("System.Boolean")
            .Cols(3).Width = 60

            .Cols(4).Caption = "Opmerking"
            .Cols(4).DataType = System.Type.GetType("System.Boolean")
            .Cols(4).Width = 60

            .Cols(5).Caption = "Tekst"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 200

            .Cols(6).Caption = "id"
            .Cols(6).DataType = System.Type.GetType("System.int32")
            .Cols(6).Width = 50
        End With

    End Sub
    Private Sub LoadDB_Flexindeling_agenda()
        Dim flexgridfill(8) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from agenda ORDER BY id DESC"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("start_datum"))
                    flexgridfill(1) = CHstr(Reader("eind_datum"))
                    flexgridfill(2) = CHstr(Reader("vakantie"))
                    flexgridfill(3) = CHstr(Reader("aktie"))
                    flexgridfill(4) = CHstr(Reader("opmerking"))
                    flexgridfill(5) = CHstr(Reader("tekst"))
                    flexgridfill(6) = Format(CHint(Reader("id")), "000")
                    flexgridfill(7) = Str(0)
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (agenda)" + ex.Message)
            MessageBox.Show("Database fout: (agenda)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Set_Flexindeling_kopersgroep()


        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 2
            .Rows.Count = 1

            .Cols(0).Caption = "id"
            .Cols(0).DataType = System.Type.GetType("System.Int32")
            .Cols(0).Width = 80
            .Cols(0).AllowEditing = False

            .Cols(1).Caption = "Groepnaam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 150
            .Cols(1).AllowEditing = True

        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 2
            .Rows.Count = 1

            .Cols(0).Caption = "id"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 80

            .Cols(1).Caption = "Groepnaam"
            .Cols(1).DataType = System.Type.GetType("System.string")
            .Cols(1).Width = 150

        End With

    End Sub
    Private Sub Set_flexindeling_eindklanten()
        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 3
            .Rows.Count = 1

            .Cols(0).Caption = "Eindklant naam"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 200
            .Cols(0).AllowEditing = True

            .Cols(1).Caption = "Interne klantcode"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100
            .Cols(1).AllowEditing = True

            .Cols(2).Caption = "Id"
            .Cols(2).DataType = System.Type.GetType("System.int32")
            .Cols(2).Width = 80
            .Cols(2).AllowEditing = True
            '.Cols(2).Visible = False

        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 3
            .Rows.Count = 1

            .Cols(0).Caption = "Eindklant naam"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 200
            .Cols(0).AllowEditing = False

            .Cols(1).Caption = "Interne klantcode"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Id"
            .Cols(2).DataType = System.Type.GetType("System.int32")
            .Cols(2).Width = 80
            .Cols(2).AllowEditing = True
            '.Cols(2).Visible = False
        End With

    End Sub
    Private Sub Set_Flexindeling_koper_alias()
        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 2
            .Rows.Count = 1

            .Cols(0).Caption = "Alias-Naam"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 150
            .Cols(0).AllowEditing = True

            .Cols(1).Caption = "Koper"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 150
            Dim mcd_kopers As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_kopersXA, "ID", cn, 0)
            .Cols(1).DataMap = mcd_kopers

        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 2
            .Rows.Count = 1

            .Cols(0).Caption = "Alias-Naam"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 150
            .Cols(0).AllowEditing = False

            .Cols(1).Caption = "Koper"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 150
            Dim mcd_kopers As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_kopersXA, "ID", cn, 0)
            .Cols(1).DataMap = mcd_kopers
            .Cols(1).AllowEditing = False

        End With

    End Sub
    Private Sub LoadDB_FlexIndeling_koper_alias()
        Dim flexgridfill(3) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from klant_alias"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("klantnaam"))
                    flexgridfill(1) = CHstr(Reader("ean"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (koper_alias)" + ex.Message)
            MessageBox.Show("Database fout: (koper_alias)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub LoadDB_Flexindeling_kopersgroepenlist2()
        Dim id As Integer
        Dim i As Integer
        Dim ean As String
        Dim groepnaam As String
        Dim CmdString As String
        Dim Reader As OdbcDataReader

        If DatabaseFlexGridShow.Cols.Count = 2 Then
            id = 0
            groepnaam = ""
            For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                If DatabaseFlexGridShow.Rows(i).Selected = True Then
                    id = DatabaseFlexGridShow.Item(i, 0)

                    CmdString = "select * from kopersgroepen2 where id =" + Str(id)
                    Try
                        'Open Connection
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()
                            Dim Cmd As New OdbcCommand(CmdString, Conn)
                            Reader = Cmd.ExecuteReader()
                            If Reader.HasRows Then
                                groepnaam = CHstr(Reader("groepnaam"))
                                Exit For
                            End If
                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: (kopersgroepenlist2)" + ex.Message)
                        MessageBox.Show("Database fout: (kopersgroepenlist2)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try
                End If
            Next i

            LoadDB_Flexindeling_kopersgroeplist()

            Dim flexgridfill(2) As String
            flexgridfill(0) = id
            flexgridfill(1) = groepnaam
            DatabaseFlexGridEdit.Rows.Count = 1
            DatabaseFlexGridEdit.AddItem(flexgridfill)
            DatabaseFlexGridEdit.Rows(1).AllowEditing = True

            CmdString = "select * from kopersgroepen2_eans where id =" + Str(id)
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read()
                        ean = CHstr(Reader("ean"))
                        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                            If DatabaseFlexGridShow.Item(i, 2) = ean Then
                                DatabaseFlexGridShow.SetData(i, 0, True)
                            End If
                        Next i
                    Loop
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (kopersgroepenlist2)" + ex.Message)
                MessageBox.Show("Database fout: (kopersgroepenlist2)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

        End If

    End Sub
    Private Sub LoadDB_Flexindeling_kopersgroepen()
        Dim flexgridfill(3) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from kopersgroepen2"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("id"))
                    flexgridfill(1) = CHstr(Reader("groepnaam"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopersgroepen)" + ex.Message)
            MessageBox.Show("Database fout: (kopersgroepen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub LoadDB_Flexindeling_kopersgroeplist()
        Dim flexgridfill(4) As String
        Dim Reader As OdbcDataReader
        DatabaseFlexGridShow.AllowEditing = True
        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 3
            .Rows.Count = 1

            .Cols(0).Caption = "Selectie"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 50
            .Cols(0).AllowEditing = True

            .Cols(1).Caption = "Kopernaam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "EAN"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            .Cols(2).AllowEditing = False
        End With

        Dim CmdString As String = "select * from klanten"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = Str(0)
                    flexgridfill(1) = CHstr(Reader("klantnaam"))
                    flexgridfill(2) = CHstr(Reader("ean"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopersgroepenlist)" + ex.Message)
            MessageBox.Show("Database fout: (kopersgroepenlist)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Public Function getkopernaam(ByVal ean As String) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from klanten where ean ='" + Str(ean) + "'"
        Dim kopersnaam As String = "Fout! ean niet gevonden"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    kopersnaam = CHstr(Reader("klantnaam"))
                Else
                    kopersnaam = "Fout! ean niet gevonden"
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopersnaam)" + ex.Message)
            MessageBox.Show("Database fout: (kopersnaam)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        getkopernaam = kopersnaam
    End Function
    Public Function getkoperfromorder(ByVal header_id As String) As String
        Dim koper_ean As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand("select koper_ean from orderheaders where header_id =?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", header_id)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    koper_ean = CHstr(Reader("koper_ean"))
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (koperean)" + ex.Message)
            MessageBox.Show("Database fout: (koperean)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Return koper_ean
    End Function
    Private Sub Set_Flexindeling_soortgroep()


        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 6
            .Rows.Count = 1

            .Cols(0).Caption = "id"
            .Cols(0).DataType = System.Type.GetType("System.Int32")
            .Cols(0).Width = 80
            .Cols(0).AllowEditing = False

            .Cols(1).Caption = "Groepnaam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 150
            .Cols(1).AllowEditing = True


            .Cols(2).Caption = "Fusten"
            .Cols(2).DataType = System.Type.GetType("System.Boolean")
            .Cols(2).Width = 80
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "Hoezen"
            .Cols(3).DataType = System.Type.GetType("System.Boolean")
            .Cols(3).Width = 80
            .Cols(3).AllowEditing = True

            .Cols(4).Caption = "Prijzen"
            .Cols(4).DataType = System.Type.GetType("System.Boolean")
            .Cols(4).Width = 80
            .Cols(4).AllowEditing = True

            .Cols(5).Caption = "Veilgroepen"
            .Cols(5).DataType = System.Type.GetType("System.Boolean")
            .Cols(5).Width = 80
            .Cols(5).AllowEditing = True

        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 6
            .Rows.Count = 1

            .Cols(0).Caption = "id"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 80

            .Cols(1).Caption = "Groepnaam"
            .Cols(1).DataType = System.Type.GetType("System.string")
            .Cols(1).Width = 150


            .Cols(2).Caption = "Fusten"
            .Cols(2).DataType = System.Type.GetType("System.Boolean")
            .Cols(2).Width = 80
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "Hoezen"
            .Cols(3).DataType = System.Type.GetType("System.Boolean")
            .Cols(3).Width = 80
            .Cols(3).AllowEditing = True

            .Cols(4).Caption = "Prijzen"
            .Cols(4).DataType = System.Type.GetType("System.Boolean")
            .Cols(4).Width = 80
            .Cols(4).AllowEditing = True

            .Cols(5).Caption = "Veilgroepen"
            .Cols(5).DataType = System.Type.GetType("System.Boolean")
            .Cols(5).Width = 80
            .Cols(5).AllowEditing = True

        End With

    End Sub
    Private Sub LoadDB_Flexindeling_soortgroepen()
        Dim flexgridfill(6) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from soortgroepen"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("id"))
                    flexgridfill(1) = CHstr(Reader("groepnaam"))
                    flexgridfill(2) = CHbool(Reader("fusten"))
                    flexgridfill(3) = CHbool(Reader("hoezen"))
                    flexgridfill(4) = CHbool(Reader("prijzen"))
                    flexgridfill(5) = CHbool(Reader("veilgroep"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortgroepen)" + ex.Message)
            MessageBox.Show("Database fout: (soortgroepen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub LoadDB_Flexindeling_soortgroepenlist2()
        Dim id As Integer
        Dim i As Integer
        Dim soortmixid As String
        Dim groepnaam As String
        Dim CmdString As String
        Dim Reader As OdbcDataReader

        If DatabaseFlexGridShow.Cols.Count = 6 Then
            id = 0
            groepnaam = ""
            Dim fusten As Boolean = False
            Dim hoezen As Boolean = False
            Dim prijzen As Boolean = False
            For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                If DatabaseFlexGridShow.Rows(i).Selected = True Then
                    id = DatabaseFlexGridShow.Item(i, 0)

                    CmdString = "select * from soortgroepen where id =" + Str(id)
                    Try
                        'Open Connection
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()
                            Dim Cmd As New OdbcCommand(CmdString, Conn)
                            Reader = Cmd.ExecuteReader()
                            If Reader.HasRows Then
                                groepnaam = CHstr(Reader("groepnaam"))
                                fusten = CHbool(Reader("fusten"))
                                hoezen = CHbool(Reader("hoezen"))
                                prijzen = CHbool(Reader("prijzen"))
                                Exit For
                            End If
                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: (soortgroepenlist2)" + ex.Message)
                        MessageBox.Show("Database fout: (soortgroepenlist2)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try
                End If
            Next i

            LoadDB_Flexindeling_soortgroeplist()

            Dim flexgridfill(5) As String
            flexgridfill(0) = id
            flexgridfill(1) = groepnaam
            flexgridfill(2) = fusten
            flexgridfill(3) = hoezen
            flexgridfill(4) = prijzen
            DatabaseFlexGridEdit.Rows.Count = 1
            DatabaseFlexGridEdit.AddItem(flexgridfill)
            DatabaseFlexGridEdit.Rows(1).AllowEditing = True

            CmdString = "select * from soortgroepen_ids where id =" + Str(id)
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read()
                        soortmixid = CHstr(Reader("soortmixid"))
                        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                            If DatabaseFlexGridShow.Item(i, 2) = soortmixid Then
                                DatabaseFlexGridShow.SetData(i, 0, True)
                            End If
                        Next i
                    Loop
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (soortgroepenlist2)" + ex.Message)
                MessageBox.Show("Database fout: (soortgroepenlist2)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

        End If

    End Sub
    Private Sub LoadDB_Flexindeling_soortgroeplist()
        Dim flexgridfill(4) As String
        Dim Reader As OdbcDataReader
        DatabaseFlexGridShow.AllowEditing = True
        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 3
            .Rows.Count = 1

            .Cols(0).Caption = "Selectie"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 50
            .Cols(0).AllowEditing = True

            .Cols(1).Caption = "Soortnaam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Id"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            .Cols(2).AllowEditing = False
        End With

        Dim CmdString As String = "select * from soorten3"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = Str(0)
                    flexgridfill(1) = CHstr(Reader("soortnaam"))
                    flexgridfill(2) = CHstr(Reader("id"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortgroepenlist)" + ex.Message)
            MessageBox.Show("Database fout: (soortgroepenlist)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        CmdString = "select * from mixen"
        Dim idstore As Integer
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = Str(0)
                    flexgridfill(1) = CHstr(Reader("naam"))
                    idstore = CHstr(Reader("id"))
                    flexgridfill(2) = Trim(Str(idstore + 10000))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortgroepenlist)" + ex.Message)
            MessageBox.Show("Database fout: (soortgroepenlist)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Set_Flexindeling_mixenvullen()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 1
            .Rows.Count = 1

            .Cols(0).Caption = "Selecteer mix"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 120
            Dim mcd_mixen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_mixbakken, "ID", cn, 0)
            .Cols(0).DataMap = mcd_mixen

        End With

        Dim flexgridfill(1) As String
        flexgridfill(0) = Str(0)
        DatabaseFlexGridEdit.Rows.Count = 1
        DatabaseFlexGridEdit.AddItem(flexgridfill)
        DatabaseFlexGridEdit.Rows(1).AllowEditing = True

        With DatabaseFlexGridShow
            .Clear()
        End With

    End Sub
    Private Sub Set_Flexindeling_mixlagenvullen()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 1
            .Rows.Count = 1

            .Cols(0).Caption = "Selecteer mixlaag"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 120
            Dim mcd_mixen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_mixlagen, "ID", cn, 0)
            .Cols(0).DataMap = mcd_mixen

        End With

        Dim flexgridfill(1) As String
        flexgridfill(0) = Str(0)
        DatabaseFlexGridEdit.Rows.Count = 1
        DatabaseFlexGridEdit.AddItem(flexgridfill)
        DatabaseFlexGridEdit.Rows(1).AllowEditing = True

        With DatabaseFlexGridShow
            .Cols.Count = 3
            .Clear()
        End With

    End Sub
    Private Sub Set_Flexindeling_mixlagenvullenGrid2()

        Dim flexgridfill(1) As String
        Dim selected_mixlaag As Integer


        Dim cn() As String = New String() {"desc"}

        'fetch selected mix
        selected_mixlaag = DatabaseFlexGridEdit.GetData(1, 0)
        If selected_mixlaag > 0 Then

            DatabaseFlexGridShow.AllowEditing = True
            DatabaseFlexGridShow.SelectionMode = SelectionModeEnum.Cell
            DatabaseFlexGridShow.Cols.Fixed = 1

            With DatabaseFlexGridShow
                .Clear()
                .Cols.Count = 2
                .Rows.Count = 1
                .Cols(0).Width = 40
                .Cols(1).Width = 200
                '.Cols(2).Width = 200

                .Cols(1).Caption = "Soort of mix"
                .Cols(1).DataType = System.Type.GetType("System.String")
                Dim mcd_soorten As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmixlagen, "ID", cn, 0)
                .Cols(1).DataMap = mcd_soorten

                '    .Cols(2).Caption = "Wps Filter"
                '    .Cols(2).DataType = System.Type.GetType("System.String")

                '   .Cols(3).Caption = "Wps Filter id"
                '   .Cols(3).DataType = System.Type.GetType("System.Int32")
                '.Cols(3).Visible = False


            End With
        End If
    End Sub
    Private Sub LoadDB_Flexindeling_mixlagenvullen()

        Dim mixlaag_id = DatabaseFlexGridEdit.GetData(1, 0)

        Dim flexgridfill(2) As String
        Dim Reader As OdbcDataReader
        Dim linecount As Integer = 1
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim CmdString As String = "select * from mixlagen where mixlaag_id = " + Str(mixlaag_id)
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = linecount
                    flexgridfill(1) = CHstr(Reader("soort_id"))

                    DatabaseFlexGridShow.AddItem(flexgridfill)
                    linecount = linecount + 1
                Loop
                For i = linecount To 100
                    flexgridfill(0) = i
                    flexgridfill(1) = Str(0)

                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Next
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (mixlagen)" + ex.Message)
            MessageBox.Show("Database fout: (mixlagen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Set_Flexindeling_accessoire_prijzen()
        Dim cn() As String = New String() {"desc"}
        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 7
            .Rows.Count = 1

            .Cols(0).Caption = "Accessoire"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 120
            Dim mcd_accessoire As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(0).DataMap = mcd_accessoire

            .Cols(1).Caption = "Soort"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 120
            Dim mcd_soort As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmixprijzen, "ID", cn, 0)
            .Cols(1).DataMap = mcd_soort

            .Cols(2).Caption = "Prijslijst"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 120
            Dim mcd_prijzen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_prijzen, "ID", cn, 0)
            .Cols(2).DataMap = mcd_prijzen
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "Plus prijs"
            .Cols(3).DataType = System.Type.GetType("System.Double")
            .Cols(3).Width = 70
            .Cols(3).AllowEditing = True

            .Cols(4).Caption = "WPS Filtergroep"
            .Cols(4).DataType = System.Type.GetType("System.int32")
            .Cols(4).Width = 90
            .Cols(4).AllowEditing = True

            .Cols(5).Caption = "id"
            .Cols(5).DataType = System.Type.GetType("System.int32")
            .Cols(5).Width = 50
            .Cols(5).AllowEditing = False

            .Cols(6).Caption = "Verwijder"
            .Cols(6).DataType = System.Type.GetType("System.Boolean")
            .Cols(6).Width = 60
            .Cols(6).AllowEditing = True
        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 6
            .Rows.Count = 1

            .Cols(0).Caption = "Accessoire"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 120
            Dim mcd_accessoire As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(0).DataMap = mcd_accessoire

            .Cols(1).Caption = "Soort"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 120
            Dim mcd_soort As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_soortmixprijzen, "ID", cn, 0)
            .Cols(1).DataMap = mcd_soort

            .Cols(2).Caption = "Prijslijst"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 120
            Dim mcd_prijzen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_prijzen, "ID", cn, 0)
            .Cols(2).DataMap = mcd_prijzen

            .Cols(3).Caption = "Plus prijs"
            .Cols(3).DataType = System.Type.GetType("System.Double")
            .Cols(3).Width = 70

            .Cols(4).Caption = "WPS Filtergroep"
            .Cols(4).DataType = System.Type.GetType("System.int32")
            .Cols(4).Width = 90

            .Cols(5).Caption = "id"
            .Cols(5).DataType = System.Type.GetType("System.int32")
            .Cols(5).Width = 50

        End With


    End Sub
    Private Sub LoadDB_Flexindeling_accessoire_prijzen()
        Dim flexgridfill(6) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from accessoire_prijzen ORDER BY accessoire,soort"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("accessoire"))
                    flexgridfill(1) = Trim(CHstr(Reader("soort")))
                    flexgridfill(2) = CHstr(Reader("prijslijst"))
                    flexgridfill(3) = Format(CHdouble(Reader("plus_prijs")), "##0.00")
                    flexgridfill(4) = CHstr(Reader("wps_filtergroep"))
                    flexgridfill(5) = CHstr(Reader("id"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (accessoire prijs)" + ex.Message)
            MessageBox.Show("Database fout: (accessoire prijs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Set_Flexindeling_mixenvullengrid2()

        Dim flexgridfill(4) As String
        Dim selected_mix As Integer
        Dim fusttype As Integer
        Dim fustposities As String

        Dim cn() As String = New String() {"desc"}

        'fetch selected mix
        selected_mix = DatabaseFlexGridEdit.GetData(1, 0)
        If selected_mix > 0 Then
            fusttype = mixen(GID(mixen, selected_mix)).fust
            fustposities = fust(GID(fust, fusttype)).plaats_string

            DatabaseFlexGridShow.AllowEditing = True
            DatabaseFlexGridShow.SelectionMode = SelectionModeEnum.Cell
            DatabaseFlexGridShow.Cols.Fixed = 1

            With DatabaseFlexGridShow
                .Clear()
                .Cols.Count = Len(fustposities) + 1
                .Rows.Count = 10
                .Cols(0).Width = 120

                Dim i As Integer
                For i = 1 To Len(fustposities)
                    If Mid(fustposities, i, 1) = "1" Then
                        .Cols(i).Caption = "Positie " + Str(i)
                        .Cols(i).Width = 150
                        .Cols(i).AllowEditing = True
                    Else
                        .Cols(i).AllowEditing = False
                    End If
                Next i

                .Rows(1).Caption = "Soort"
                .Rows(1).DataType = System.Type.GetType("System.String")
                Dim mcd_soorten As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soorten, "ID", cn, 0)
                .Rows(1).DataMap = mcd_soorten

                .Rows(2).Caption = "Wps Filter"
                .Rows(2).DataType = System.Type.GetType("System.String")

                Dim mcd_accessoire As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
                For i = 3 To 8
                    .Rows(i).Caption = "Accessoire " + Str(i - 2)
                    .Rows(i).DataType = System.Type.GetType("System.String")
                    .Rows(i).DataMap = mcd_accessoire
                Next i

                .Rows(9).Caption = "Wps Filter id"
                .Rows(9).DataType = System.Type.GetType("System.Int32")
                .Rows(9).Visible = False

            End With
        End If
    End Sub
    Private Sub LoadDB_Flexindeling_mixenvullen()
        Dim flexgridfill(4) As String
        Dim cn() As String = New String() {"desc"}

        Dim i As Integer
        Dim mix_id = DatabaseFlexGridEdit.GetData(1, 0)
        Dim cmdstring As String
        Dim Reader As OdbcDataReader
        For i = 1 To DatabaseFlexGridShow.Cols.Count() - 1
            cmdstring = "select * from mixen_vulling where mix_id = " + Str(mix_id) + " and plaats = " + Str(i)

            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'Execute(Query)
                    Dim Cmd As New OdbcCommand(cmdstring, Conn)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read()
                        DatabaseFlexGridShow.SetData(1, i, CHstr(Reader("soort_id")))
                        Dim filternaam As String = ""
                        Dim wps_filternr As Integer = CHint(Reader("wps_filternr"))

                        For j = 0 To UBound(wpsfilter) - 1
                            If wps_filternr = wpsfilter(j).filternummer Then
                                filternaam = wpsfilter(j).filternaam
                                Exit For
                            End If
                        Next
                        DatabaseFlexGridShow.SetData(2, i, filternaam)
                        DatabaseFlexGridShow.SetData(3, i, CHstr(Reader("accessoire_id1")))
                        DatabaseFlexGridShow.SetData(4, i, CHstr(Reader("accessoire_id2")))
                        DatabaseFlexGridShow.SetData(5, i, CHstr(Reader("accessoire_id3")))
                        DatabaseFlexGridShow.SetData(6, i, CHstr(Reader("accessoire_id4")))
                        DatabaseFlexGridShow.SetData(7, i, CHstr(Reader("accessoire_id5")))
                        DatabaseFlexGridShow.SetData(8, i, CHstr(Reader("accessoire_id6")))
                        DatabaseFlexGridShow.SetData(9, i, wps_filternr)
                    Loop
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (mixen vullen)" + ex.Message)
                MessageBox.Show("Database fout: (mixen vullen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        Next i
    End Sub
    Private Sub Set_Flexindeling_mixen()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 20
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40
            .Cols(0).AllowEditing = True

            .Cols(1).Caption = "Mix naam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 120
            .Cols(1).AllowEditing = True

            .Cols(2).Caption = "Fust"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(2).DataMap = mcd_fust
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "Koper"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 100
            Dim mcd_kopers As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopers, "ID", cn, 0)
            .Cols(3).DataMap = mcd_kopers
            .Cols(3).AllowEditing = True

            .Cols(4).Caption = "Kopersgroep"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 100
            Dim mcd_kopersgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopersgroepen, "ID", cn, 0)
            .Cols(4).DataMap = mcd_kopersgroepen
            .Cols(4).AllowEditing = True

            .Cols(5).Caption = "Rijpheid"
            .Cols(5).DataType = System.Type.GetType("System.int32")
            .Cols(5).Width = 60
            .Cols(5).AllowEditing = True

            .Cols(6).Caption = "Hoogte"
            .Cols(6).DataType = System.Type.GetType("System.int32")
            .Cols(6).Width = 60
            .Cols(6).AllowEditing = True

            .Cols(7).Caption = "Diameter"
            .Cols(7).DataType = System.Type.GetType("System.int32")
            .Cols(7).Width = 60
            .Cols(7).AllowEditing = True

            .Cols(8).Caption = "Transporthoogte"
            .Cols(8).DataType = System.Type.GetType("System.int32")
            .Cols(8).Width = 60
            .Cols(8).AllowEditing = True

            .Cols(9).Caption = "Potmaat"
            .Cols(9).DataType = System.Type.GetType("System.Double")
            .Cols(9).Width = 60
            .Cols(9).AllowEditing = True

            .Cols(10).Caption = "VBN Code"
            .Cols(10).DataType = System.Type.GetType("System.int32")
            .Cols(10).Width = 60
            .Cols(10).AllowEditing = True

            .Cols(11).Caption = "Sdf KleurCode"
            .Cols(11).DataType = System.Type.GetType("System.int32")
            .Cols(11).Width = 60
            .Cols(11).AllowEditing = True

            .Cols(12).Caption = "Interne Code"
            .Cols(12).DataType = System.Type.GetType("System.String")
            .Cols(12).Width = 70
            .Cols(12).AllowEditing = True

            .Cols(13).Caption = "Mix laag"
            .Cols(13).DataType = System.Type.GetType("System.Boolean")
            .Cols(13).Width = 50
            .Cols(13).AllowEditing = True

            .Cols(14).Caption = "Pakbon info"
            .Cols(14).DataType = System.Type.GetType("System.String")
            .Cols(14).Width = 200
            .Cols(14).AllowEditing = True

            .Cols(15).Caption = "Accessoire"
            .Cols(15).DataType = System.Type.GetType("System.String")
            .Cols(15).Width = 120
            Dim mcd_accessoire As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(15).DataMap = mcd_accessoire

            .Cols(16).Caption = "Vestiging"
            .Cols(16).DataType = System.Type.GetType("System.String")
            Dim mcd_vestiging As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_vestiging, "ID", cn, 0)
            .Cols(16).DataMap = mcd_vestiging

            .Cols(17).Caption = "Labelnaam"
            .Cols(17).DataType = System.Type.GetType("System.String")
            .Cols(17).Width = 80
            .Cols(17).AllowEditing = True

            .Cols(18).Caption = "Sdf Art.Code"
            .Cols(18).DataType = System.Type.GetType("System.String")
            .Cols(18).Width = 80
            .Cols(18).AllowEditing = True

            .Cols(19).Caption = "id"
            .Cols(19).DataType = System.Type.GetType("System.int32")
            .Cols(19).Width = 40
            .Cols(19).AllowEditing = False

        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 20
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40

            .Cols(1).Caption = "Mix naam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 120

            .Cols(2).Caption = "Fust"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_fust, "ID", cn, 0)
            .Cols(2).DataMap = mcd_fust

            .Cols(3).Caption = "Koper"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 100
            Dim mcd_kopers As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_kopers, "ID", cn, 0)
            .Cols(3).DataMap = mcd_kopers

            .Cols(4).Caption = "Kopersgroep"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 100
            Dim mcd_kopersgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopersgroepen, "ID", cn, 0)
            .Cols(4).DataMap = mcd_kopersgroepen

            .Cols(5).Caption = "Rijpheid"
            .Cols(5).DataType = System.Type.GetType("System.int32")
            .Cols(5).Width = 60

            .Cols(6).Caption = "Hoogte"
            .Cols(6).DataType = System.Type.GetType("System.int32")
            .Cols(6).Width = 60

            .Cols(7).Caption = "Diameter"
            .Cols(7).DataType = System.Type.GetType("System.int32")
            .Cols(7).Width = 60

            .Cols(8).Caption = "Transporthoogte"
            .Cols(8).DataType = System.Type.GetType("System.int32")
            .Cols(8).Width = 60

            .Cols(9).Caption = "Potmaat"
            .Cols(9).DataType = System.Type.GetType("System.Double")
            .Cols(9).Width = 60

            .Cols(10).Caption = "VBN Code"
            .Cols(10).DataType = System.Type.GetType("System.int32")
            .Cols(10).Width = 60

            .Cols(11).Caption = "Sdf KleurCode"
            .Cols(11).DataType = System.Type.GetType("System.int32")
            .Cols(11).Width = 60

            .Cols(12).Caption = "Interne Code"
            .Cols(12).DataType = System.Type.GetType("System.String")
            .Cols(12).Width = 70

            .Cols(13).Caption = "Mix laag"
            .Cols(13).DataType = System.Type.GetType("System.Boolean")
            .Cols(13).Width = 50
            .Cols(13).AllowEditing = True

            .Cols(14).Caption = "Pakbon info"
            .Cols(14).DataType = System.Type.GetType("System.String")
            .Cols(14).Width = 200
            .Cols(14).AllowEditing = True

            .Cols(15).Caption = "Accessoire"
            .Cols(15).DataType = System.Type.GetType("System.String")
            .Cols(15).Width = 120
            Dim mcd_accessoire As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(15).DataMap = mcd_accessoire

            .Cols(16).Caption = "Vestiging"
            .Cols(16).DataType = System.Type.GetType("System.String")
            Dim mcd_vestiging As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_vestiging, "ID", cn, 0)
            .Cols(16).DataMap = mcd_vestiging
            .Cols(16).AllowEditing = True

            .Cols(17).Caption = "Labelnaam"
            .Cols(17).DataType = System.Type.GetType("System.String")
            .Cols(17).Width = 80
            .Cols(17).AllowEditing = True

            .Cols(18).Caption = "Sdf Art.Code"
            .Cols(18).DataType = System.Type.GetType("System.String")
            .Cols(18).Width = 80
            .Cols(18).AllowEditing = True

            .Cols(19).Caption = "id"
            .Cols(19).DataType = System.Type.GetType("System.int32")
            .Cols(19).Width = 40
            .Cols(19).AllowEditing = False

        End With

    End Sub
    Private Sub LoadDB_Flexindeling_mixen()
        Dim flexgridfill(19) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from mixen"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("actief"))
                    flexgridfill(1) = CHstr(Reader("naam"))
                    flexgridfill(2) = CHstr(Reader("fust"))
                    flexgridfill(3) = CHstr(Reader("koperean"))
                    flexgridfill(4) = CHstr(Reader("kopergroepid"))
                    flexgridfill(5) = CHstr(Reader("rijpheid"))
                    flexgridfill(6) = CHstr(Reader("hoogte"))
                    flexgridfill(7) = CHstr(Reader("diameter"))
                    flexgridfill(8) = CHstr(Reader("transporthoogte"))
                    flexgridfill(9) = CHstr(Reader("potmaat")) / 10
                    flexgridfill(10) = CHstr(Reader("vbn_code"))
                    flexgridfill(11) = CHstr(Reader("sdf_code"))
                    flexgridfill(12) = CHstr(Reader("interne_code"))
                    flexgridfill(13) = CHstr(Reader("mixlaag"))
                    flexgridfill(14) = CHstr(Reader("mix_pakboninfo"))
                    flexgridfill(15) = CHstr(Reader("accessoire"))
                    flexgridfill(16) = CHstr(Reader("vestiging"))
                    flexgridfill(17) = CHstr(Reader("labelnaam"))
                    flexgridfill(18) = CHstr(Reader("sdf_artcode"))
                    flexgridfill(19) = CHstr(Reader("id"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (mixen)" + ex.Message)
            MessageBox.Show("Database fout: (mixen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Set_Flexindeling_accessoires()

        Dim cn() As String = New String() {"desc"}
        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 15
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40
            .Cols(0).AllowEditing = True

            .Cols(1).Caption = "Accessoire"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 120
            .Cols(1).AllowEditing = True

            .Cols(2).Caption = "Boek Code"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 80
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "Prijslijst"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 80
            Dim mcd_prijzen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_prijzen, "ID", cn, 0)
            .Cols(3).DataMap = mcd_prijzen
            .Cols(3).AllowEditing = True
            .Cols(3).Visible = False

            .Cols(4).Caption = "Fust"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 80
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fusta, "ID", cn, 0)
            .Cols(4).DataMap = mcd_fust
            .Cols(4).AllowEditing = True

            .Cols(5).Caption = "Potmaat"
            .Cols(5).DataType = System.Type.GetType("System.Int32")
            .Cols(5).Width = 60
            .Cols(5).AllowEditing = True

            .Cols(6).Caption = "Volgorde"
            .Cols(6).DataType = System.Type.GetType("System.Int32")
            .Cols(6).Width = 80
            .Cols(6).AllowEditing = True

            .Cols(7).Caption = "Sdf code"
            .Cols(7).DataType = System.Type.GetType("System.Int32")
            .Cols(7).Width = 80
            .Cols(7).AllowEditing = True

            .Cols(8).Caption = "Decorum"
            .Cols(8).DataType = System.Type.GetType("System.Boolean")
            .Cols(8).Width = 40
            .Cols(8).AllowEditing = True

            .Cols(9).Caption = "Keten EAN"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 100
            .Cols(9).AllowEditing = True

            .Cols(10).Caption = "Hoes"
            .Cols(10).DataType = System.Type.GetType("System.String")
            .Cols(10).Width = 80
            Dim mcd_accessoire As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_accessoire, "ID", cn, 0)
            .Cols(10).DataMap = mcd_accessoire

            .Cols(11).Caption = "Stikkercode"
            .Cols(11).DataType = System.Type.GetType("System.Int32")
            .Cols(11).Width = 100
            .Cols(11).AllowEditing = True

            .Cols(12).Caption = "Min-prijs"
            .Cols(12).DataType = System.Type.GetType("System.Double")
            .Cols(12).Width = 100
            .Cols(12).AllowEditing = True

            .Cols(13).Caption = "Bakstikker"
            .Cols(13).DataType = System.Type.GetType("System.Boolean")
            .Cols(13).Width = 40
            .Cols(13).AllowEditing = True

            .Cols(14).Caption = "id"
            .Cols(14).DataType = System.Type.GetType("System.Int32")
            .Cols(14).Width = 80
            .Cols(14).AllowEditing = False

        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 15
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40

            .Cols(1).Caption = "Accessoire"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 120

            .Cols(2).Caption = "Code"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 80

            .Cols(3).Caption = "Prijslijst"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 80
            Dim mcd_prijzen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_prijzen, "ID", cn, 0)
            .Cols(3).DataMap = mcd_prijzen
            .Cols(3).Visible = False

            .Cols(4).Caption = "Fust"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 80
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_fust, "ID", cn, 0)
            .Cols(4).DataMap = mcd_fust

            .Cols(5).Caption = "Potmaat"
            .Cols(5).DataType = System.Type.GetType("System.Int32")
            .Cols(5).Width = 60

            .Cols(6).Caption = "Volgorde"
            .Cols(6).DataType = System.Type.GetType("System.Int32")
            .Cols(6).Width = 80

            .Cols(7).Caption = "Sdf code"
            .Cols(7).DataType = System.Type.GetType("System.Int32")
            .Cols(7).Width = 80

            .Cols(8).Caption = "Decorum"
            .Cols(8).DataType = System.Type.GetType("System.Boolean")
            .Cols(8).Width = 40

            .Cols(9).Caption = "Keten EAN"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 100

            .Cols(10).Caption = "Hoes"
            .Cols(10).DataType = System.Type.GetType("System.String")
            .Cols(10).Width = 80
            Dim mcd_accessoire As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_accessoire, "ID", cn, 0)
            .Cols(10).DataMap = mcd_accessoire

            .Cols(11).Caption = "Stikkercode"
            .Cols(11).DataType = System.Type.GetType("System.Int32")
            .Cols(11).Width = 80

            .Cols(12).Caption = "Min-prijs"
            .Cols(12).DataType = System.Type.GetType("System.Double")
            .Cols(12).Width = 80

            .Cols(13).Caption = "Bakstikker"
            .Cols(13).DataType = System.Type.GetType("System.Boolean")
            .Cols(13).Width = 40
            .Cols(13).AllowEditing = True

            .Cols(14).Caption = "id"
            .Cols(14).DataType = System.Type.GetType("System.Int32")
            .Cols(14).Width = 80
            .Cols(14).AllowEditing = False


        End With

    End Sub
    Private Sub LoadDB_Flexindeling_accessoires()
        Dim flexgridfill(15) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from accessoire ORDER BY volgorde ASC"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("actief"))
                    flexgridfill(1) = CHstr(Reader("naam"))
                    flexgridfill(2) = CHstr(Reader("code"))
                    flexgridfill(3) = CHstr(Reader("prijslijst"))
                    flexgridfill(4) = CHstr(Reader("fust"))
                    flexgridfill(5) = CHstr(Reader("potmaat")) / 10
                    flexgridfill(6) = CHstr(Reader("volgorde"))
                    flexgridfill(7) = CHstr(Reader("sdf_code"))
                    flexgridfill(8) = CHstr(Reader("decorum"))
                    flexgridfill(9) = CHstr(Reader("keten_ean"))
                    flexgridfill(10) = CHstr(Reader("hoes"))
                    flexgridfill(11) = CHstr(Reader("stikkercode"))
                    flexgridfill(12) = CHstr(Reader("minprijs"))
                    flexgridfill(13) = CHstr(Reader("bakstikker"))
                    flexgridfill(14) = CHstr(Reader("id"))

                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (accessoires)" + ex.Message)
            MessageBox.Show("Database fout: (accessoires)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Set_Flexindeling_soorten()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 19
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40
            .Cols(0).AllowEditing = True

            .Cols(1).Caption = "Soort naam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 120
            .Cols(1).AllowEditing = True

            .Cols(2).Caption = "Vaste Fustcode"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fusta, "ID", cn, 0)
            .Cols(2).DataMap = mcd_fust
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "VBN code"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 80
            .Cols(3).AllowEditing = True

            .Cols(4).Caption = "WPS code"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 80
            .Cols(4).AllowEditing = True

            .Cols(5).Caption = "SDF code"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 80
            .Cols(5).AllowEditing = True

            .Cols(6).Caption = "Interne code"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 80
            .Cols(6).AllowEditing = True

            .Cols(7).Caption = "BB rijpheid"
            .Cols(7).DataType = System.Type.GetType("System.Int32")
            .Cols(7).Width = 80
            .Cols(7).AllowEditing = True

            .Cols(8).Caption = "BB hoogte"
            .Cols(8).DataType = System.Type.GetType("System.Int32")
            .Cols(8).Width = 80
            .Cols(8).AllowEditing = True

            .Cols(9).Caption = "BB diameter"
            .Cols(9).DataType = System.Type.GetType("System.Int32")
            .Cols(9).Width = 80
            .Cols(9).AllowEditing = True

            .Cols(10).Caption = "Klok rijpheid"
            .Cols(10).DataType = System.Type.GetType("System.Int32")
            .Cols(10).Width = 80
            .Cols(10).AllowEditing = True

            .Cols(11).Caption = "Klok hoogte"
            .Cols(11).DataType = System.Type.GetType("System.Int32")
            .Cols(11).Width = 80
            .Cols(11).AllowEditing = True

            .Cols(12).Caption = "Klok diameter"
            .Cols(12).DataType = System.Type.GetType("System.Int32")
            .Cols(12).Width = 80
            .Cols(12).AllowEditing = True

            .Cols(13).Caption = "Transport hoogte"
            .Cols(13).DataType = System.Type.GetType("System.Int32")
            .Cols(13).Width = 80
            .Cols(13).AllowEditing = True

            .Cols(14).Caption = "Potmaat"
            .Cols(14).DataType = System.Type.GetType("System.Double")
            .Cols(14).Width = 80
            .Cols(14).AllowEditing = True

            .Cols(15).Caption = "Vestiging"
            .Cols(15).DataType = System.Type.GetType("System.String")
            Dim mcd_vestiging As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_vestiging, "ID", cn, 0)
            .Cols(15).DataMap = mcd_vestiging
            .Cols(15).AllowEditing = True

            .Cols(16).Caption = "Logiqs code"
            .Cols(16).DataType = System.Type.GetType("System.String")
            .Cols(16).Width = 80
            .Cols(16).AllowEditing = True

            .Cols(17).Caption = "labelnaam"
            .Cols(17).DataType = System.Type.GetType("System.String")
            .Cols(17).Width = 80
            .Cols(17).AllowEditing = True

            .Cols(18).Caption = "id"
            .Cols(18).DataType = System.Type.GetType("System.int32")
            .Cols(18).Width = 50
            .Cols(18).AllowEditing = False
        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 19
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40

            .Cols(1).Caption = "Soort naam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 120

            .Cols(2).Caption = "Vaste Fustcode"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fusta, "ID", cn, 0)
            .Cols(2).DataMap = mcd_fust

            .Cols(3).Caption = "VBN code"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 80

            .Cols(4).Caption = "WPS code"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 80

            .Cols(5).Caption = "SDF code"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 80

            .Cols(6).Caption = "Interne code"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 80

            .Cols(7).Caption = "BB rijpheid"
            .Cols(7).DataType = System.Type.GetType("System.Int32")
            .Cols(7).Width = 80

            .Cols(8).Caption = "BB hoogte"
            .Cols(8).DataType = System.Type.GetType("System.Int32")
            .Cols(8).Width = 80

            .Cols(9).Caption = "BB diameter"
            .Cols(9).DataType = System.Type.GetType("System.Int32")
            .Cols(9).Width = 80

            .Cols(10).Caption = "Klok rijpheid"
            .Cols(10).DataType = System.Type.GetType("System.Int32")
            .Cols(10).Width = 80

            .Cols(11).Caption = "Klok hoogte"
            .Cols(11).DataType = System.Type.GetType("System.Int32")
            .Cols(11).Width = 80

            .Cols(12).Caption = "Klok diameter"
            .Cols(12).DataType = System.Type.GetType("System.Int32")
            .Cols(12).Width = 80

            .Cols(13).Caption = "Transport hoogte"
            .Cols(13).DataType = System.Type.GetType("System.Int32")
            .Cols(13).Width = 80

            .Cols(14).Caption = "Potmaat"
            .Cols(14).DataType = System.Type.GetType("System.Double")
            .Cols(14).Width = 80

            .Cols(15).Caption = "Vestiging"
            .Cols(15).DataType = System.Type.GetType("System.String")
            Dim mcd_vestiging As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_vestiging, "ID", cn, 0)
            .Cols(15).DataMap = mcd_vestiging
            .Cols(15).AllowEditing = True

            .Cols(16).Caption = "Logiqs code"
            .Cols(16).DataType = System.Type.GetType("System.String")
            .Cols(16).Width = 80

            .Cols(17).Caption = "labelnaam"
            .Cols(17).DataType = System.Type.GetType("System.String")
            .Cols(17).Width = 80
            .Cols(17).AllowEditing = True

            .Cols(18).Caption = "id"
            .Cols(18).DataType = System.Type.GetType("System.int32")
            .Cols(18).Width = 50
            .Cols(18).AllowEditing = False
        End With

    End Sub
    Private Sub LoadDB_Flexindeling_soorten()
        Dim flexgridfill(19) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from soorten3"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("actief"))
                    flexgridfill(1) = CHstr(Reader("soortnaam"))
                    flexgridfill(2) = CHstr(Reader("vastefustcode"))
                    flexgridfill(3) = CHstr(Reader("vbn_code"))
                    flexgridfill(4) = CHstr(Reader("wps_code"))
                    flexgridfill(5) = CHstr(Reader("sdf_code"))
                    flexgridfill(6) = CHstr(Reader("interne_code"))
                    flexgridfill(7) = CHstr(Reader("bbrijpheid"))
                    flexgridfill(8) = CHstr(Reader("bbhoogte"))
                    flexgridfill(9) = CHstr(Reader("bbdiameter"))
                    flexgridfill(10) = CHstr(Reader("klokrijpheid"))
                    flexgridfill(11) = CHstr(Reader("klokhoogte"))
                    flexgridfill(12) = CHstr(Reader("klokdiameter"))
                    flexgridfill(13) = CHstr(Reader("transporthoogte"))
                    flexgridfill(14) = CHstr(Reader("potmaat")) / 10
                    flexgridfill(15) = CHstr(Reader("vestiging"))
                    flexgridfill(16) = CHstr(Reader("logiqs_code"))
                    flexgridfill(17) = CHstr(Reader("labelnaam"))
                    flexgridfill(18) = CHstr(Reader("id"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soorten)" + ex.Message)
            MessageBox.Show("Database fout: (soorten)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Set_Flexindeling_fusten()
        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 17
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40

            .Cols(1).Caption = "Fustnaam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100
            .Cols(1).AllowEditing = True

            .Cols(2).Caption = "Fustcode"
            .Cols(2).DataType = System.Type.GetType("System.int32")
            .Cols(2).Width = 80
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "plaatsing"
            .Cols(3).DataType = System.Type.GetType("System.int32")
            .Cols(3).Width = 80
            .Cols(3).AllowEditing = True

            .Cols(4).Caption = "Decorum"
            .Cols(4).DataType = System.Type.GetType("System.Boolean")
            .Cols(4).Width = 60
            .Cols(4).AllowEditing = True

            .Cols(5).Caption = "Aantal per fust"
            .Cols(5).DataType = System.Type.GetType("System.int32")
            .Cols(5).Width = 80
            .Cols(5).AllowEditing = True

            .Cols(6).Caption = "fustcode Florecom"
            .Cols(6).DataType = System.Type.GetType("System.int32")
            .Cols(6).Width = 80
            .Cols(6).AllowEditing = True

            .Cols(7).Caption = "fustcode WPS"
            .Cols(7).DataType = System.Type.GetType("System.int32")
            .Cols(7).Width = 80
            .Cols(7).AllowEditing = True

            .Cols(8).Caption = "fustcode SDF"
            .Cols(8).DataType = System.Type.GetType("System.int32")
            .Cols(8).Width = 80
            .Cols(8).AllowEditing = True

            .Cols(9).Caption = "fust/laag: Deen"
            .Cols(9).DataType = System.Type.GetType("System.int32")
            .Cols(9).Width = 80
            .Cols(9).AllowEditing = True

            .Cols(10).Caption = "fust/laag: Veilingkar"
            .Cols(10).DataType = System.Type.GetType("System.int32")
            .Cols(10).Width = 80
            .Cols(10).AllowEditing = True

            .Cols(11).Caption = "fust/laag: Overig"
            .Cols(11).DataType = System.Type.GetType("System.int32")
            .Cols(11).Width = 80
            .Cols(11).AllowEditing = True

            .Cols(12).Caption = "fust/laag: Reserve1"
            .Cols(12).DataType = System.Type.GetType("System.int32")
            .Cols(12).Width = 80
            .Cols(12).AllowEditing = True

            .Cols(13).Caption = "fust/laag: Reserve2"
            .Cols(13).DataType = System.Type.GetType("System.int32")
            .Cols(13).Width = 80
            .Cols(13).AllowEditing = True

            .Cols(14).Caption = "volgorde"
            .Cols(14).DataType = System.Type.GetType("System.int32")
            .Cols(14).Width = 50
            .Cols(14).AllowEditing = True

            .Cols(15).Caption = "kleur"
            .Cols(15).Width = 80
            .Cols(15).DataType = System.Type.GetType("System.String")
            .Cols(15).AllowEditing = True
            ' Set up color column.
            Dim c As C1.Win.C1FlexGrid.Column = .Cols(15)
            c.ComboList = "..."

            .Cols(16).Caption = "id"
            .Cols(16).DataType = System.Type.GetType("System.int32")
            .Cols(16).Width = 50
            .Cols(16).AllowEditing = False
        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 17
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40

            .Cols(1).Caption = "Fustnaam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100

            .Cols(2).Caption = "Fustcode"
            .Cols(2).DataType = System.Type.GetType("System.string")
            .Cols(2).Format = "N0"
            .Cols(2).Width = 80

            .Cols(3).Caption = "plaatsing"
            .Cols(3).DataType = System.Type.GetType("System.int32")
            .Cols(3).Width = 80

            .Cols(4).Caption = "Decorum"
            .Cols(4).DataType = System.Type.GetType("System.Boolean")
            .Cols(4).Width = 60

            .Cols(5).Caption = "Aantal per fust"
            .Cols(5).DataType = System.Type.GetType("System.int32")
            .Cols(5).Width = 80

            .Cols(6).Caption = "fustcode Florecom"
            .Cols(6).DataType = System.Type.GetType("System.int32")
            .Cols(6).Width = 80

            .Cols(7).Caption = "fustcode WPS"
            .Cols(7).DataType = System.Type.GetType("System.int32")
            .Cols(7).Width = 80

            .Cols(8).Caption = "fustcode SDF"
            .Cols(8).DataType = System.Type.GetType("System.int32")
            .Cols(8).Width = 80

            .Cols(9).Caption = "fust/laag: Deen"
            .Cols(9).DataType = System.Type.GetType("System.int32")
            .Cols(9).Width = 80

            .Cols(10).Caption = "fust/laag: Veilingkar"
            .Cols(10).DataType = System.Type.GetType("System.int32")
            .Cols(10).Width = 80

            .Cols(11).Caption = "fust/laag: Overig"
            .Cols(11).DataType = System.Type.GetType("System.int32")
            .Cols(11).Width = 80

            .Cols(12).Caption = "fust/laag: Reserve1"
            .Cols(12).DataType = System.Type.GetType("System.int32")
            .Cols(12).Width = 80

            .Cols(13).Caption = "fust/laag: Reserve2"
            .Cols(13).DataType = System.Type.GetType("System.int32")
            .Cols(13).Width = 80

            .Cols(14).Caption = "volgorde"
            .Cols(14).DataType = System.Type.GetType("System.int32")
            .Cols(14).Width = 50

            .Cols(15).Caption = "kleur"
            .Cols(15).Width = 80
            .Cols(15).DataType = System.Type.GetType("System.String")
            ' Set up color column.
            Dim c As C1.Win.C1FlexGrid.Column = .Cols(15)

            c.ComboList = "..."

            .Cols(16).Caption = "id"
            .Cols(16).DataType = System.Type.GetType("System.int32")
            .Cols(16).Width = 50
        End With

    End Sub
    Private Sub LoadDB_Flexindeling_fusten()
        Dim flexgridfill(16) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from fusten2 ORDER BY volgorde ASC"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("actief"))
                    flexgridfill(1) = CHstr(Reader("fustnaam"))
                    flexgridfill(2) = CHstr(Reader("fustcode"))
                    flexgridfill(3) = CHstr(Reader("plaats_string"))
                    flexgridfill(4) = CHstr(Reader("decorum"))
                    flexgridfill(5) = CHstr(Reader("aantal_per_fust"))
                    flexgridfill(6) = CHstr(Reader("fustcode_florecom"))
                    flexgridfill(7) = CHstr(Reader("fustcode_wps"))
                    flexgridfill(8) = CHstr(Reader("fustcode_sdf"))
                    flexgridfill(9) = CHstr(Reader("fpl_deen"))
                    flexgridfill(10) = CHstr(Reader("fpl_veilingkar"))
                    flexgridfill(11) = CHstr(Reader("fpl_overig"))
                    flexgridfill(12) = CHstr(Reader("fpl_reserve1"))
                    flexgridfill(13) = CHstr(Reader("fpl_reserve2"))
                    flexgridfill(14) = CHstr(Reader("volgorde"))
                    flexgridfill(15) = CHstr(Reader("kleur"))
                    flexgridfill(16) = CHstr(Reader("id"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (fusten)" + ex.Message)
            MessageBox.Show("Database fout: (fusten)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Set_FlexIndeling_kopers()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 20
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40

            .Cols(1).Caption = "EAN"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100

            .Cols(2).Caption = "Bedrijfsnaam"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 150

            .Cols(3).Caption = "FH nr."
            .Cols(3).DataType = System.Type.GetType("System.int32")
            .Cols(3).Width = 60

            .Cols(4).Caption = "vba nr."
            .Cols(4).DataType = System.Type.GetType("System.int32")
            .Cols(4).Width = 60

            .Cols(5).Caption = "Brief"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 80
            Dim mcd_brief As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_brief, "ID", cn, 0)
            .Cols(5).DataMap = mcd_brief

            .Cols(6).Caption = "Kar"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 140
            Dim mcd_kar As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kar, "ID", cn, 0)
            .Cols(6).DataMap = mcd_kar

            .Cols(7).Caption = "Fust"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(7).DataMap = mcd_fust
            .Cols(7).Visible = False

            .Cols(8).Caption = "Vervoerder"
            .Cols(8).DataType = System.Type.GetType("System.String")
            .Cols(8).Width = 100
            Dim mcd_vervoerder As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_vervoerder, "ID", cn, 0)
            .Cols(8).DataMap = mcd_vervoerder

            .Cols(9).Caption = "Afleverloc"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 100
            Dim mcd_bdo As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_afleverloc, "ID", cn, 0)
            .Cols(9).DataMap = mcd_bdo

            .Cols(10).Caption = "Stand.Acce1."
            .Cols(10).DataType = System.Type.GetType("System.String")
            .Cols(10).Width = 80
            Dim mcd_deco As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_accessoire, "ID", cn, 0)
            .Cols(10).DataMap = mcd_deco

            .Cols(11).Caption = "Stikker"
            .Cols(11).DataType = System.Type.GetType("System.Boolean")
            .Cols(11).Width = 40

            .Cols(12).Caption = "Opslag"
            .Cols(12).DataType = System.Type.GetType("System.Double")
            '.Cols(11).EditMask = "#0.00"
            .Cols(12).Width = 60

            .Cols(13).Caption = "Opmerking"
            .Cols(13).DataType = System.Type.GetType("System.String")
            .Cols(13).Width = 150

            .Cols(14).Caption = "Contact"
            .Cols(14).DataType = System.Type.GetType("System.String")
            .Cols(14).Width = 100

            .Cols(15).Caption = "Min aantal negeren"
            .Cols(15).DataType = System.Type.GetType("System.Boolean")
            .Cols(15).Width = 100
            .Cols(15).Visible = False

            .Cols(16).Caption = "Foto"
            .Cols(16).DataType = System.Type.GetType("System.Boolean")
            .Cols(16).Width = 40

            .Cols(17).Caption = "Fust Categorie"
            .Cols(17).DataType = System.Type.GetType("System.String")
            Dim mcd_fustcat As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fustcategorie, "ID", cn, 0)
            .Cols(17).DataMap = mcd_fustcat
            .Cols(17).Width = 120

            .Cols(18).Caption = "Hoes Categorie"
            .Cols(18).DataType = System.Type.GetType("System.String")
            .Cols(18).Width = 120
            Dim mcd_hoes As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_hoescategorie, "ID", cn, 0)
            .Cols(18).DataMap = mcd_hoes
            ' .Rows(1).AllowEditing = True

            .Cols(19).Caption = "Bakstikker"
            .Cols(19).DataType = System.Type.GetType("System.Boolean")
            .Cols(19).Width = 40

        End With
        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 20
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40

            .Cols(1).Caption = "EAN"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100

            .Cols(2).Caption = "Bedrijfsnaam"
            .Cols(2).DataType = System.Type.GetType("System.string")
            .Cols(2).Width = 150

            .Cols(3).Caption = "FH nr."
            .Cols(3).DataType = System.Type.GetType("System.int32")
            .Cols(3).Width = 60

            .Cols(4).Caption = "VBA nr."
            .Cols(4).DataType = System.Type.GetType("System.int32")
            .Cols(4).Width = 60

            .Cols(5).Caption = "Brief"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 80
            Dim mcd_brief As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_brief, "ID", cn, 0)
            .Cols(5).DataMap = mcd_brief

            .Cols(6).Caption = "Kar"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 140
            Dim mcd_kar As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_kar, "ID", cn, 0)
            .Cols(6).DataMap = mcd_kar

            .Cols(7).Caption = "Fust"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_fust, "ID", cn, 0)
            .Cols(7).DataMap = mcd_fust
            .Cols(7).Visible = False

            .Cols(8).Caption = "Vervoerder"
            .Cols(8).DataType = System.Type.GetType("System.String")
            .Cols(8).Width = 100
            Dim mcd_vervoerder As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_vervoerder, "ID", cn, 0)
            .Cols(8).DataMap = mcd_vervoerder

            .Cols(9).Caption = "Afleverloc"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 100
            Dim mcd_bdo As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_afleverloc, "ID", cn, 0)
            .Cols(9).DataMap = mcd_bdo

            .Cols(10).Caption = "Stand.Acce1."
            .Cols(10).DataType = System.Type.GetType("System.String")
            .Cols(10).Width = 80
            Dim mcd_deco As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_accessoire, "ID", cn, 0)
            .Cols(10).DataMap = mcd_deco

            .Cols(11).Caption = "Stikker"
            .Cols(11).DataType = System.Type.GetType("System.Boolean")
            .Cols(11).Width = 40

            .Cols(12).Caption = "Opslag"
            .Cols(12).DataType = System.Type.GetType("System.Double")
            '.Cols(11).EditMask = "#0.00"
            .Cols(12).Width = 60

            .Cols(13).Caption = "Opmerking"
            .Cols(13).DataType = System.Type.GetType("System.String")
            .Cols(13).Width = 150

            .Cols(14).Caption = "Contact"
            .Cols(14).DataType = System.Type.GetType("System.String")
            .Cols(14).Width = 100

            .Cols(15).Caption = "Min aantal negeren"
            .Cols(15).DataType = System.Type.GetType("System.Boolean")
            .Cols(15).Width = 100
            .Cols(15).Visible = False

            .Cols(16).Caption = "Foto"
            .Cols(16).DataType = System.Type.GetType("System.Boolean")
            .Cols(16).Width = 40

            .Cols(17).Caption = "Fust Categorie"
            .Cols(17).DataType = System.Type.GetType("System.String")
            Dim mcd_fustcat As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fustcategorie, "ID", cn, 0)
            .Cols(17).DataMap = mcd_fustcat
            .Cols(17).Width = 120

            .Cols(18).Caption = "Hoes Categorie"
            .Cols(18).DataType = System.Type.GetType("System.String")
            .Cols(18).Width = 120
            Dim mcd_hoes As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_hoescategorie, "ID", cn, 0)
            .Cols(18).DataMap = mcd_hoes

            .Cols(19).Caption = "Bakstikker"
            .Cols(19).DataType = System.Type.GetType("System.Boolean")
            .Cols(19).Width = 40

        End With
    End Sub
    Private Sub LoadDB_FlexIndeling_kopers()
        Dim flexgridfill(20) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from klanten"

        Me.Cursor = Cursors.WaitCursor

        DatabaseFlexGridShow.BeginUpdate()
        DatabaseFlexGridShow.Rows.Count = 1
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("actief"))
                    flexgridfill(1) = CHstr(Reader("ean"))
                    flexgridfill(2) = CHstr(Reader("klantnaam"))
                    flexgridfill(3) = CHstr(Reader("veilingnr_westland"))
                    flexgridfill(4) = CHstr(Reader("veilingnr_von"))
                    flexgridfill(5) = CHstr(Reader("veiling_voorkeur"))
                    flexgridfill(6) = CHstr(Reader("kar_voorkeur"))
                    flexgridfill(7) = CHstr(Reader("fust_voorkeur"))
                    flexgridfill(8) = CHstr(Reader("vervoerder"))
                    flexgridfill(9) = CHstr(Reader("bdo"))
                    flexgridfill(10) = CHstr(Reader("decorum"))
                    flexgridfill(11) = CHstr(Reader("stikker"))
                    flexgridfill(12) = CHstr(Reader("stikkeropslag"))
                    flexgridfill(13) = CHstr(Reader("opmerking"))
                    flexgridfill(14) = CHstr(Reader("contact"))
                    flexgridfill(15) = CHstr(Reader("prijsopslag"))
                    flexgridfill(16) = CHstr(Reader("foto"))
                    flexgridfill(17) = CHstr(Reader("fustcategorie"))
                    flexgridfill(18) = CHstr(Reader("hoescategorie"))
                    flexgridfill(19) = CHstr(Reader("bakstikker"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopers)" + ex.Message)
            MessageBox.Show("Database fout: (kopers)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        DatabaseFlexGridShow.EndUpdate()
        Me.Cursor = Cursors.Default
    End Sub
    Private Sub LoadDB_Flexindeling_soortvolgorde()

        Load_Database_soortvolgorde()

        Dim flexgridfill(5) As String
        Dim Reader As OdbcDataReader
        DatabaseFlexGridShow.AllowEditing = True
        DatabaseFlexGridShow.AllowSorting = AllowSortingEnum.None

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 0
            .Rows.Count = 2
        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 5
            .Rows.Count = 1

            .Cols(0).Caption = "Soort"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 200
            .Cols(0).AllowEditing = False

            .Cols(1).Caption = "Id"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Volgorde"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = " ^ "
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).ComboList = "..."
            .Cols(3).Width = 20
            .Cols(3).AllowEditing = True

            .Cols(4).Caption = " v "
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).ComboList = "..."
            .Cols(4).Width = 20
            .Cols(4).AllowEditing = True

        End With
        Dim id As Integer
        Dim CmdString As String = "select * from soorten3"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("soortnaam"))
                    id = CHint(Reader("id"))
                    flexgridfill(1) = Trim(Str(id))
                    flexgridfill(2) = get_volgorde(id)
                    flexgridfill(3) = " ^"
                    flexgridfill(4) = " v"
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortvolgorde)" + ex.Message)
            MessageBox.Show("Database fout: (soortvolgorde)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        CmdString = "select * from mixen"
        Dim idstore As Integer
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("naam"))
                    idstore = CHint(Reader("id"))
                    flexgridfill(1) = Trim(Str(idstore + 10000))
                    flexgridfill(2) = get_volgorde(idstore + 10000)
                    flexgridfill(3) = " ^"
                    flexgridfill(4) = " v"
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortvolgorde)" + ex.Message)
            MessageBox.Show("Database fout: (soortvolgorde)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Dim order As C1.Win.C1FlexGrid.SortFlags = C1.Win.C1FlexGrid.SortFlags.Ascending
        DatabaseFlexGridShow.Sort(order, 2)
    End Sub
    Private Function get_volgorde_oud(ByVal searchid As Integer) As Integer
        Dim volgorde As Integer = 9999
        Dim CmdString As String = "select * from soortvolgorde where soortid=" + Str(searchid)
        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    volgorde = CHint(Reader("volgorde"))
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (get volgorde)" + ex.Message)
            MessageBox.Show("Database fout: (get volgorde)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return volgorde
    End Function
    Private Function get_volgorde(ByVal searchid As Integer) As Integer
        Dim volgorde As Integer = 9999
        For i = 0 To UBound(soortvolgorde) - 1
            If searchid = soortvolgorde(i).soortid Then
                volgorde = soortvolgorde(i).volgorde
                Exit For
            End If
        Next
        Return volgorde
    End Function
    Private Sub Set_Flexindeling_favorieten()
        Dim flexgridfill(10) As String

        DatabaseFlexGridShow.AllowEditing = True
        Dim i As Integer
        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 5
            .Rows.Count = 2

            For i = 0 To 4
                .Cols(i).Caption = "Naam " + Trim(Str(i + 1))
                .Cols(i).DataType = System.Type.GetType("System.String")
                .Cols(i).Width = 170
                .Cols(i).AllowEditing = True
            Next i
        End With

        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 11
            .Rows.Count = 2


            For i = 0 To 4
                .Cols(i * 2).Caption = "F" + Trim(Str(i + 1))
                .Cols(i * 2).DataType = System.Type.GetType("System.Boolean")
                .Cols(i * 2).Width = 20
                .Cols(i * 2).AllowEditing = True

                .Cols(i * 2 + 1).Caption = "Favoriet " + Trim(Str(i + 1))
                .Cols(i * 2 + 1).DataType = System.Type.GetType("System.String")
                .Cols(i * 2 + 1).Width = 150
                .Cols(i * 2 + 1).AllowEditing = False
            Next i
            .Cols(10).Caption = "Id"
            .Cols(10).DataType = System.Type.GetType("System.Int32")
            .Cols(10).Width = 60
            .Cols(10).AllowEditing = False


        End With

        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from soorten3"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = Str(0)
                    flexgridfill(1) = CHstr(Reader("soortnaam"))
                    flexgridfill(2) = Str(0)
                    flexgridfill(3) = CHstr(Reader("soortnaam"))
                    flexgridfill(4) = Str(0)
                    flexgridfill(5) = CHstr(Reader("soortnaam"))
                    flexgridfill(6) = Str(0)
                    flexgridfill(7) = CHstr(Reader("soortnaam"))
                    flexgridfill(8) = Str(0)
                    flexgridfill(9) = CHstr(Reader("soortnaam"))
                    flexgridfill(10) = CHstr(Reader("id"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (favorieten soorten)" + ex.Message)
            MessageBox.Show("Database fout: (favorieten soorten)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        CmdString = "select * from mixen"
        Dim idstore As Integer
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = Str(0)
                    flexgridfill(1) = CHstr(Reader("naam"))
                    flexgridfill(2) = Str(0)
                    flexgridfill(3) = CHstr(Reader("naam"))
                    flexgridfill(4) = Str(0)
                    flexgridfill(5) = CHstr(Reader("naam"))
                    flexgridfill(6) = Str(0)
                    flexgridfill(7) = CHstr(Reader("naam"))
                    flexgridfill(8) = Str(0)
                    flexgridfill(9) = CHstr(Reader("naam"))
                    idstore = CHint(Reader("id"))
                    flexgridfill(10) = Trim(Str(idstore + 10000))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (favorieten mix)" + ex.Message)
            MessageBox.Show("Database fout: (favorieten mix)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub LoadDB_Flexindeling_favorieten()
        Dim flexgridfill(12) As String
        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            DatabaseFlexGridEdit.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim CmdString As String = "select * from favorieten_naam"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Dim i = 0
                Do While Reader.Read()
                    flexgridfill(i) = CHstr(Reader("naam"))
                    i = i + 1
                Loop
                DatabaseFlexGridEdit.AddItem(flexgridfill)

                Dim j As Integer
                Dim soortid As Integer
                For j = 0 To 4
                    CmdString = "select * from favorieten_lijst where nummer =" + Str(j + 1)
                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd2.ExecuteReader()
                    Do While Reader.Read()
                        soortid = CHint(Reader("soortid"))
                        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                            If DatabaseFlexGridShow.Item(i, 10) = soortid Then
                                DatabaseFlexGridShow.SetData(i, j * 2, True)
                            End If
                        Next i
                    Loop
                Next j


            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (favoriet)" + ex.Message)
            MessageBox.Show("Database fout: (favoriet)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub DatabaseFlexGridShow_CellButtonClick(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles DatabaseFlexGridShow.CellButtonClick
        If current_dbid = 20 Then
            If e.Col = 3 And e.Row > 1 Then
                DatabaseFlexGridShow.Rows.Move(e.Row, e.Row - 1)

                Dim saveval3 As Integer = DatabaseFlexGridShow.GetData(e.Row, 2)   ' swap volgorde
                DatabaseFlexGridShow.SetData(e.Row, 2, DatabaseFlexGridShow.GetData(e.Row - 1, 2))
                DatabaseFlexGridShow.SetData(e.Row - 1, 2, saveval3)

            End If
            If e.Col = 4 And e.Row < DatabaseFlexGridShow.Rows.Count - 1 Then
                DatabaseFlexGridShow.Rows.Move(e.Row, e.Row + 1)

                Dim saveval3 As Integer = DatabaseFlexGridShow.GetData(e.Row, 2)   ' swap volgorde
                DatabaseFlexGridShow.SetData(e.Row, 2, DatabaseFlexGridShow.GetData(e.Row + 1, 2))
                DatabaseFlexGridShow.SetData(e.Row + 1, 2, saveval3)

            End If
        End If

        If current_dbid = 30 Then

            Dim FotoTradeItemId As String = DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Trade item"))
            If FotoTradeItemId <> "" Then
                Dim FotoTradeItemDBId As Integer = CInt(Val(FotoTradeItemId))
                If FotoTradeItemDBId > 0 Then
                    Form15.FotoTradeItemDBId = FotoTradeItemDBId

                    Dim rijpheid As Integer = 0
                    Dim fustid As Integer = 0
                    Dim Hoes As Integer = 0
                    Dim Hoogte As Integer = 0
                    Dim Diameter As Integer = 0
                    Dim Schermen As Integer = 0
                    Dim Keurcode As Integer = 0
                    Dim fotopath As String = ""
                    Try
                        rijpheid = CInt(DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Rijpheid")))
                        fustid = CInt(DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Fust")))
                        Hoes = CInt(DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Hoes")))
                        Hoogte = CInt(DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Hoogte")))
                        Diameter = CInt(DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Diameter")))
                        Schermen = CInt(DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Schermen")))
                        Keurcode = CInt(DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Keurcode")))
                        fotopath = CStr(DatabaseFlexGridShow.GetData(e.Row, FindCol(DatabaseFlexGridShow, "Path")))
                    Catch ex As Exception

                    End Try

                    Form15.rijpheid = rijpheid
                    Form15.fustcode = fust(GID(fust, fustid)).fustcode
                    Form15.hoogte = Hoogte
                    Form15.diameter = Diameter
                    Form15.schermen = Schermen
                    Form15.keurcode = Keurcode
                    Form15.flexgridrow = e.Row
                    Form15.flexgridcol = FindCol(DatabaseFlexGridShow, "Path")
                    Form15.exportgrid = 1
                    Form15.fotopath = fotopath

                    Form15.StartPosition = FormStartPosition.CenterScreen
                    Form15.Show()
                End If
            Else
                MsgBox("Selecteer eerst een trade-item")
            End If
        End If


    End Sub

    Private Sub DatabaseMenuCopy_but_Click(sender As Object, e As EventArgs) Handles DatabaseMenuCopy_but.Click
        If current_dbtype = 0 Then
            Dim table As String = current_dbtable
            dbtable = current_dbbuild
            If table <> "N.V.T." Then
                CopyItem(table, dbtable, DatabaseFlexGridShow)
            End If
        End If
    End Sub

    Private Sub DatabaseMenuHerladen_but_Click(sender As Object, e As EventArgs) Handles DatabaseMenuHerladen_but.Click

        If current_dbid = 13 Or current_dbid = 14 Then
            SetupNewDatabase(current_dbid)
        End If

        If current_dbtype = 0 Then
            LoadNewDatabase()
        End If
    End Sub

    Private Sub Database_preselect_cmb_SelectedIndexChanged(sender As Object, e As EventArgs) Handles Database_preselect_cmb.SelectedIndexChanged
        LoadNewDatabase()
    End Sub

    Private Sub DatabaseMenuNieuw_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles DatabaseMenuNieuw.Click

        If current_dbtype = 0 Then
            Dim table As String = current_dbtable
            dbtable = current_dbbuild
            If table <> "N.V.T." Then

                If table = "db_plantverdeling" Or table = "db_omzetcijfers" Then
                    'Dim retailgroep As Integer = 1
                    'Try
                    ' retailgroep = CInt(DirectCast(DirectCast(db_databasepreselect_cmb.SelectedItem, System.Object), System.Data.DataRowView).Item(0))
                    'Catch ex As Exception
                    ' End Try
                    ' NewItem(dbtable,DatabaseFlexGridShow, "retailhoofdgroep_id", retailgroep)
                Else
                    NewItem(dbtable, DatabaseFlexGridShow)
                End If

            End If
        Else

            Select Case current_dbselection
                Case "Kopers"
                    Dim flexgridfill(20) As String
                    flexgridfill(0) = 1
                    flexgridfill(1) = ""
                    flexgridfill(2) = ""
                    flexgridfill(3) = 0
                    flexgridfill(4) = 0
                    flexgridfill(5) = Tstr(1)
                    flexgridfill(6) = Tstr(1)
                    flexgridfill(7) = Tstr(1)
                    flexgridfill(8) = Tstr(0)
                    flexgridfill(9) = 0
                    flexgridfill(10) = 0
                    flexgridfill(11) = 0
                    flexgridfill(12) = "0,00"
                    flexgridfill(13) = ""
                    flexgridfill(14) = ""
                    flexgridfill(15) = 0
                    flexgridfill(16) = 0
                    flexgridfill(17) = 0
                    flexgridfill(18) = 0
                    flexgridfill(19) = 0


                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Fusten"
                    Dim flexgridfill(16) As String
                    flexgridfill(0) = 1
                    flexgridfill(1) = ""
                    flexgridfill(2) = 0
                    flexgridfill(3) = "111111"
                    flexgridfill(4) = 1
                    flexgridfill(5) = 1
                    flexgridfill(6) = 0
                    flexgridfill(7) = 0
                    flexgridfill(8) = 0
                    flexgridfill(9) = 1
                    flexgridfill(10) = 1
                    flexgridfill(11) = 1
                    flexgridfill(12) = 1
                    flexgridfill(13) = 1
                    flexgridfill(14) = 999
                    flexgridfill(15) = 0 'id 
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Soorten"
                    Dim flexgridfill(18) As String
                    flexgridfill(0) = 1
                    flexgridfill(1) = ""
                    flexgridfill(2) = Tstr(0)
                    flexgridfill(3) = 1
                    flexgridfill(4) = ""
                    flexgridfill(5) = ""
                    flexgridfill(6) = ""
                    flexgridfill(7) = 1
                    flexgridfill(8) = 17
                    flexgridfill(9) = 0
                    flexgridfill(10) = 1
                    flexgridfill(11) = 17
                    flexgridfill(12) = 0
                    flexgridfill(13) = 30
                    flexgridfill(14) = 11
                    flexgridfill(15) = 1
                    flexgridfill(16) = ""
                    flexgridfill(17) = ""
                    flexgridfill(18) = 0
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Accessoires"
                    Dim flexgridfill(15) As String
                    flexgridfill(0) = 1
                    flexgridfill(1) = ""
                    flexgridfill(2) = ""
                    flexgridfill(3) = 0
                    flexgridfill(4) = 0
                    flexgridfill(5) = 0
                    flexgridfill(6) = 999
                    flexgridfill(7) = 0
                    flexgridfill(8) = 0
                    flexgridfill(9) = ""
                    flexgridfill(10) = ""
                    flexgridfill(11) = 0
                    flexgridfill(12) = 0
                    flexgridfill(13) = 0
                    flexgridfill(14) = 0
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Accessoire prijzen"
                    Dim flexgridfill(7) As String
                    flexgridfill(0) = Tstr(0)
                    flexgridfill(1) = Tstr(0)
                    flexgridfill(2) = Tstr(0)
                    flexgridfill(3) = 0
                    flexgridfill(4) = 0
                    flexgridfill(5) = 0
                    flexgridfill(6) = Tstr(0)
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Koper alias"
                    Dim flexgridfill(2) As String
                    flexgridfill(0) = ""
                    flexgridfill(1) = "0000000000000"
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Mixen naam"
                    Dim flexgridfill(19) As String
                    flexgridfill(0) = 1
                    flexgridfill(1) = ""
                    flexgridfill(2) = 1
                    flexgridfill(3) = "0000000000000"
                    flexgridfill(4) = Tstr(0)
                    flexgridfill(5) = 1
                    flexgridfill(6) = 20
                    flexgridfill(7) = 0
                    flexgridfill(8) = 30
                    flexgridfill(9) = 11
                    flexgridfill(10) = 0
                    flexgridfill(11) = 0
                    flexgridfill(12) = ""
                    flexgridfill(13) = 0
                    flexgridfill(14) = ""
                    flexgridfill(15) = 0
                    flexgridfill(16) = 1
                    flexgridfill(17) = ""
                    flexgridfill(18) = ""
                    flexgridfill(19) = 0

                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Mixen vullen"
                    Dim answer As Integer
                    answer = MessageBox.Show("Wilt u deze mix wissen en opnieuw invullen?", "Mix wissen?", MessageBoxButtons.YesNo, MessageBoxIcon.Question)
                    If answer = vbYes Then
                        Set_Flexindeling_mixenvullengrid2()
                    End If

                Case "Kopersgroepen"
                    LoadDB_Flexindeling_kopersgroeplist()
                    Dim flexgridfill(2) As String
                    flexgridfill(0) = 0
                    flexgridfill(1) = ""
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Soortgroepen"
                    LoadDB_Flexindeling_soortgroeplist()
                    Dim flexgridfill(2) As String
                    flexgridfill(0) = 0
                    flexgridfill(1) = ""
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Fust categorie vullen"
                    Set_Flexindeling_fustcategorie_vullen2(True)

                Case "Hoes categorie vullen"
                    Set_Flexindeling_hoescategorie_vullen2(True)

                Case "Agenda"
                    Dim flexgridfill(8) As String
                    flexgridfill(0) = Format(Now, "dd-MM-yyyy")
                    flexgridfill(1) = Format(Now, "dd-MM-yyyy")
                    flexgridfill(2) = Tstr(0)
                    flexgridfill(3) = Tstr(0)
                    flexgridfill(4) = Tstr(0)
                    flexgridfill(5) = ""
                    flexgridfill(6) = 0
                    flexgridfill(7) = Str(0)
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Kwekerscode"
                    Dim flexgridfill(12) As String
                    flexgridfill(0) = 0
                    flexgridfill(1) = ""
                    flexgridfill(2) = ""
                    flexgridfill(3) = Tstr(1)
                    flexgridfill(4) = Tstr(0)
                    flexgridfill(5) = Tstr(0)
                    flexgridfill(6) = Tstr(1)
                    flexgridfill(7) = Tstr(0)
                    flexgridfill(8) = "0,00"
                    flexgridfill(9) = Tstr(0)
                    flexgridfill(10) = Tstr(0)
                    flexgridfill(11) = Tstr(0)
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True

                Case "Prijslijst kortingtabel"
                    Dim flexgridfill(4) As String
                    flexgridfill(0) = 0
                    flexgridfill(1) = Tstr(0)
                    flexgridfill(2) = "0,05"
                    flexgridfill(3) = 99
                    flexgridfill(4) = 0
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True


                Case "Prijslijst koppelingen"
                    Dim flexgridfill(3) As String
                    flexgridfill(0) = 0
                    flexgridfill(1) = Tstr(0)
                    flexgridfill(2) = Tstr(0)
                    flexgridfill(3) = 0
                    DatabaseFlexGridEdit.Rows.Count = 1
                    DatabaseFlexGridEdit.AddItem(flexgridfill)
                    DatabaseFlexGridEdit.Rows(1).AllowEditing = True
            End Select
        End If
    End Sub
    Private Sub DatabaseMenuOpslaan_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles DatabaseMenuOpslaan.Click

        If current_dbtype = 0 Then

            Dim table As String = current_dbtable
            dbtable = current_dbbuild
            If table <> "N.V.T." Then

                'prechecks

                Select Case table
                    'Case "db_kwekers" : CheckForDoubleEAN()   ' dubbele ean check
                End Select

                SaveItem(table, dbtable, DatabaseFlexGridShow)

                Select Case table
                    Case "klanten"
                        Load_Database_kopers()
                    Case "Fotos_standaard"
                        Load_Database_fotoFilters()
                    Case "floriday_tradeitem_boek"
                        Load_Database_TradeItems()

                End Select

                LoadNewDatabase()

            End If

        End If

        If current_dbtype = 1 Then
            If DatabaseFlexGridEdit.Rows.Count = 2 Then    'save only in edit mode

                Dim selecteditem As String = database_lbl.Text
                Select Case selecteditem
                    Case "Kopers"
                        Dim ean As String
                        Dim nieuwe_koper As Boolean
                        Dim antwoord As Integer


                        'check voor nieuwe of bestaande koper
                        ean = DatabaseFlexGridEdit.GetData(1, 1)
                        Dim Reader As OdbcDataReader
                        Dim CmdString As String = "select * from klanten where ean='" + ean + "'"
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                Reader = Cmd.ExecuteReader()
                                If Reader.HasRows Then
                                    antwoord = MsgBox("Deze koper bestaat al, instellingen veranderen?", MsgBoxStyle.YesNo)
                                    If antwoord = vbNo Then Exit Sub
                                    nieuwe_koper = False
                                Else
                                    nieuwe_koper = True
                                End If
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (kopers/menuopslaan)" + ex.Message)
                            MessageBox.Show("Database fout: (kopers/menuopslaan)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try

                        CmdString = ""
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()

                                'Execute Query
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                With Cmd

                                    If nieuwe_koper = True Then   'nieuw koper
                                        .CommandText = "INSERT INTO klanten(actief,ean,klantnaam,veilingnr_westland,veilingnr_von,veiling_voorkeur,kar_voorkeur,fust_voorkeur," _
                                                    & "vervoerder,bdo,decorum,stikker,stikkeropslag,opmerking,contact,prijsopslag,foto,fustcategorie,hoescategorie,bakstikker,veilingnr_vba, mixen ) " _
                                                    & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                                    Else   'veranderde koper 
                                        .CommandText = "UPDATE klanten SET actief=?,ean=?,klantnaam=?,veilingnr_westland=?,veilingnr_von=?, veiling_voorkeur=?,kar_voorkeur=?,fust_voorkeur=?," _
                                                    & "vervoerder=?,bdo=?,decorum=?,stikker=?,stikkeropslag=?,opmerking=?,contact=?,prijsopslag=?,foto=?,fustcategorie=?,hoescategorie=?,bakstikker=?,veilingnr_vba=?,mixen=? " _
                                                    & "WHERE ean = '" + ean + "'"
                                    End If
                                    .Parameters.Clear()
                                    Dim label As String
                                    Dim test As Object
                                    Dim i As Integer
                                    For i = 0 To 19
                                        label = DatabaseFlexGridEdit.GetData(0, i)
                                        test = DatabaseFlexGridEdit.GetData(1, i)
                                        If test = Nothing Then
                                            If DatabaseFlexGridEdit.Cols(i).DataType = System.Type.GetType("System.String") Then
                                                test = ""
                                            Else
                                                test = 0
                                            End If
                                        End If

                                        .Parameters.AddWithValue("", test)
                                    Next i
                                    .Parameters.AddWithValue("", 0) ' vbanr(oud)
                                    .Parameters.AddWithValue("", "") 'mixen(oud)


                                    .ExecuteNonQuery()
                                End With
                                DatabaseFlexGridEdit.Rows.Count = 1
                                LoadDB_FlexIndeling_kopers()
                                Load_Database_kopers()
                                MsgBox("Koper opgeslagen!", MsgBoxStyle.OkOnly)

                                Dim CmdString8 As String = "SELECT koper_reload from instellingen"
                                Dim Cmd8 As New OdbcCommand(CmdString, Conn)
                                Cmd8.CommandText = "UPDATE instellingen SET koper_reload = TRUE"
                                Cmd8.ExecuteNonQuery()

                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (menu opslaan)" + ex.Message)
                            MsgBox("Database fout: (menu opslaan)" + ex.Message, MsgBoxStyle.OkOnly)
                        End Try


                    Case "Fusten"
                        Dim CmdString As String = "SELECT * FROM fusten2 WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                With Cmd

                                    If DatabaseFlexGridEdit.Item(1, 16) = 0 Then   'nieuw fust
                                        .CommandText = "INSERT INTO fusten2(actief,fustnaam,fustcode,plaats_string,decorum, aantal_per_fust," _
                                                    & "fustcode_florecom,fustcode_wps,fustcode_sdf,fpl_deen,fpl_veilingkar,fpl_overig,fpl_reserve1, fpl_reserve2,volgorde,kleur) " _
                                                    & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                                    Else   'veranderd fust 
                                        .CommandText = "UPDATE fusten2 SET actief=?,fustnaam=?,fustcode=?,plaats_string=?,decorum=?, aantal_per_fust=?," _
                                                    & "fustcode_florecom=?,fustcode_wps=?,fustcode_sdf=?,fpl_deen=?,fpl_veilingkar=?,fpl_overig=?,fpl_reserve1=?, fpl_reserve2=?, volgorde=?, kleur=? " _
                                                    & "WHERE id = " + Str$(DatabaseFlexGridEdit.Item(1, 16))
                                    End If

                                    Dim i As Integer
                                    For i = 0 To 15
                                        .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i))
                                    Next i

                                    .ExecuteNonQuery()
                                End With
                                LoadDB_Flexindeling_fusten()
                                Load_Database_fusten()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Fust opgeslagen!", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (fust)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Soorten"
                        Dim CmdString As String = "SELECT * FROM soorten3 WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                With Cmd

                                    If DatabaseFlexGridEdit.Item(1, 18) = 0 Then   'nieuwe soort
                                        .CommandText = "INSERT INTO soorten3(actief,soortnaam,vastefustcode,vbn_code,wps_code,sdf_code,interne_code," _
                                                    & "bbrijpheid,bbhoogte,bbdiameter,klokrijpheid,klokhoogte,klokdiameter,transporthoogte,potmaat,vestiging,logiqs_code,labelnaam)" _
                                                    & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                                    Else   'veranderd soort
                                        .CommandText = "UPDATE soorten3 SET actief=?,soortnaam=?,vastefustcode=?,vbn_code=?,wps_code=?,sdf_code=?, interne_code=?," _
                                                    & "bbrijpheid=?,bbhoogte=?,bbdiameter=?,klokrijpheid=?,klokhoogte=?,klokdiameter=?,transporthoogte=?,potmaat=?,vestiging=?,logiqs_code=?,labelnaam=? " _
                                                    & "WHERE id = " + Str$(DatabaseFlexGridEdit.Item(1, 18))
                                    End If

                                    Dim i As Integer
                                    .Parameters.Clear()
                                    For i = 0 To 13
                                        .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i))
                                    Next i
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 14) * 10)
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 15))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 16))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 17))
                                    .ExecuteNonQuery()
                                End With

                                If DatabaseFlexGridEdit.Item(1, 18) = 0 Then
                                    If postgress = True Then
                                        Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('soorten3','id'))", Conn)
                                        Dim soort_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        SetSoortVolgorde(soort_id)
                                    Else
                                        Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                        Dim soort_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        SetSoortVolgorde(soort_id)
                                    End If

                                End If

                                Load_Database_soorten()
                                LoadDB_Flexindeling_soorten()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Soort opgeslagen!", MsgBoxStyle.OkOnly)
                                Create_SoortMixTable()
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (soorten)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Koper alias"
                        Dim nieuw_alias As Boolean = True
                        Dim ean As String = DatabaseFlexGridEdit.GetData(1, 1)
                        Dim Reader As OdbcDataReader
                        Dim CmdString As String = "select * from klant_alias where ean='" + ean + "'"
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                Reader = Cmd.ExecuteReader()
                                If Reader.HasRows Then
                                    Dim antwoord As Integer = MsgBox("Deze alias bestaat al, 2de alias maken?", MsgBoxStyle.YesNo)
                                    If antwoord = vbNo Then
                                        nieuw_alias = False
                                    Else
                                        nieuw_alias = True
                                    End If
                                End If
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (alias/menuopslaan)" + ex.Message)
                            MessageBox.Show("Database fout: (alias/menuopslaan)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try

                        Dim CmdString2 As String = "SELECT * FROM klant_alias WHERE 1=0"
                        Try

                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                                With Cmd2

                                    If nieuw_alias = True Then   'nieuw asse
                                        .CommandText = "INSERT INTO klant_alias(klantnaam,ean) VALUES(?,?)"
                                    Else   'veranderd asse
                                        .CommandText = "UPDATE klant_alias SET klantnaam=?,ean=? WHERE ean = '" + ean + "'"
                                    End If
                                    .Parameters.Clear()
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 0))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 1))

                                    .ExecuteNonQuery()
                                End With
                                LoadDB_FlexIndeling_koper_alias()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Alias opgeslagen!", MsgBoxStyle.OkOnly)

                                Dim CmdString8 As String = "SELECT koper_reload from instellingen"
                                Dim Cmd8 As New OdbcCommand(CmdString, Conn)
                                Cmd8.CommandText = "UPDATE instellingen SET koper_reload = TRUE"
                                Cmd8.ExecuteNonQuery()


                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (alias)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try



                    Case "Accessoires"

                        Dim CmdString As String = "SELECT * FROM accessoire WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                With Cmd

                                    If DatabaseFlexGridEdit.Item(1, 14) = 0 Then   'nieuw asse
                                        .CommandText = "INSERT INTO accessoire(actief,naam,code,prijslijst,fust,potmaat,volgorde,sdf_code,decorum,keten_ean,hoes,stikkercode,minprijs,bakstikker)" _
                                                    & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                                    Else   'veranderd asse
                                        .CommandText = "UPDATE accessoire SET actief=?,naam=?,code=?,prijslijst=?,fust=?,potmaat=?,volgorde=?,sdf_code=?,decorum=?,keten_ean=?,hoes=?,stikkercode=?,minprijs=?,bakstikker=? " _
                                                    & "WHERE id = " + Str$(DatabaseFlexGridEdit.Item(1, 14))
                                    End If

                                    Dim i As Integer
                                    .Parameters.Clear()
                                    For i = 0 To 4
                                        .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i))
                                    Next i
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i) * 10)
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 1))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 2))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 3))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 4))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 5))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 6))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 7))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 8))
                                    .ExecuteNonQuery()
                                End With
                                Load_Database_accessoires()
                                LoadDB_Flexindeling_accessoires()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Accessoire opgeslagen!", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (accessoires)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Accessoire prijzen"

                        Dim CmdString As String = "SELECT * FROM accessoire_prijzen WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                With Cmd

                                    Dim id = DatabaseFlexGridEdit.Item(1, 5)

                                    If id > 0 And DatabaseFlexGridEdit.Item(1, 6) = True Then
                                        CmdString = "DELETE FROM accessoire_prijzen WHERE id = " + Str(id)
                                        Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                        Cmd2.ExecuteNonQuery()
                                    Else

                                        If DatabaseFlexGridEdit.Item(1, 5) = 0 Then   'nieuwe prijs
                                            .CommandText = "INSERT INTO accessoire_prijzen(accessoire,soort,prijslijst,plus_prijs,wps_filtergroep)" _
                                                        & "VALUES(?,?,?,?,?)"
                                        Else   'veranderd asse
                                            .CommandText = "UPDATE accessoire_prijzen SET accessoire=?,soort=?,prijslijst=?,plus_prijs=?,wps_filtergroep=? " _
                                                        & "WHERE id = " + Str$(DatabaseFlexGridEdit.Item(1, 5))
                                        End If

                                        Dim i As Integer
                                        .Parameters.Clear()
                                        For i = 0 To 4
                                            .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i))
                                        Next i

                                        .ExecuteNonQuery()
                                    End If
                                End With
                                LoadDB_Flexindeling_accessoire_prijzen()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Accessoire prijzen opgeslagen!", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (accessoire prijzen)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try


                    Case "Mixen naam"

                        Dim CmdString As String = "SELECT * FROM mixen WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()

                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                With Cmd

                                    If DatabaseFlexGridEdit.Item(1, 19) = 0 Then   'nieuwe mix
                                        .CommandText = "INSERT INTO mixen(actief,naam,fust,koperean,kopergroepid,rijpheid,hoogte,diameter,transporthoogte,potmaat,vbn_code,sdf_code,interne_code,mixlaag,mix_pakboninfo,accessoire,vestiging,labelnaam,sdf_artcode)" _
                                                    & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                                    Else   'veranderd mix 
                                        .CommandText = "UPDATE mixen SET actief=?,naam=?,fust=?,koperean=?,kopergroepid=?,rijpheid=?,hoogte=?,diameter=?,transporthoogte=?,potmaat=?,vbn_code=?,sdf_code=?,interne_code=?,mixlaag=?,mix_pakboninfo=?,accessoire=?,vestiging=?,labelnaam=?,sdf_artcode=? " _
                                                    & "WHERE id = " + Str(DatabaseFlexGridEdit.Item(1, 19))
                                    End If


                                    Dim i As Integer
                                    .Parameters.Clear()
                                    For i = 0 To 3
                                        .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i))
                                    Next i
                                    If DatabaseFlexGridEdit.Item(1, 4) = "" Then
                                        .Parameters.AddWithValue("", 0)
                                    Else
                                        .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 4))
                                    End If
                                    For i = 5 To 8
                                        .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i))
                                    Next i
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i) * 10)
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 1))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 2))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 3))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 4))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 5))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 6))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 7))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 8))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i + 9))
                                    .ExecuteNonQuery()
                                End With
                                If DatabaseFlexGridEdit.Item(1, 19) = 0 Then
                                    'soort in volgorde database plaatsen
                                    If postgress = True Then
                                        Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('mixen','id'))", Conn)
                                        Dim soort_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        SetSoortVolgorde(10000 + soort_id)
                                    Else
                                        Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                        Dim soort_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        SetSoortVolgorde(10000 + soort_id)
                                    End If
                                End If
                                LoadDB_Flexindeling_mixen()
                                Load_Database_mixen()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Mixen opgeslagen!", MsgBoxStyle.OkOnly)
                                Create_SoortMixTable()
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (mixen)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Mixen vullen"

                        Dim cmdstring As String
                        Dim mix_id As Integer
                        mix_id = DatabaseFlexGridEdit.GetData(1, 0)

                        Dim Reader As OdbcDataReader
                        Try

                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()

                                'ivm wisselen van fust 8 naar 6 gaats -> altijd eerst mix wissen en dan toevoegen (update hieronder is dus niet nodig)
                                Dim Cmd2String As String = "DELETE FROM mixen_vulling where mix_id = " + Str(mix_id)
                                Dim Cmd2 As New OdbcCommand(Cmd2String, Conn)
                                Cmd2.ExecuteNonQuery()

                                For i = 1 To DatabaseFlexGridShow.Cols.Count() - 1
                                    cmdstring = "select * from mixen_vulling where mix_id = " + Str(mix_id) + " and plaats = " + Str(i)

                                    'Execute Query
                                    Dim Cmd As New OdbcCommand(cmdstring, Conn)
                                    With Cmd

                                        Reader = Cmd.ExecuteReader()
                                        If Not Reader.HasRows Then   'nieuwe mixvulling
                                            .CommandText = "INSERT INTO mixen_vulling(mix_id,plaats,soort_id,accessoire_id1,accessoire_id2,accessoire_id3,accessoire_id4,accessoire_id5,accessoire_id6,wps_filternr)" _
                                                        & "VALUES(?,?,?,?,?,?,?,?,?,?)"
                                        Else   'veranderd mixvulling (outdated door delete in begin)
                                            .CommandText = "UPDATE mixen_vulling SET mix_id=?,plaats=?,soort_id=?,accessoire_id1=?,accessoire_id2=?,accessoire_id3=?,accessoire_id4=?,accessoire_id5=?,accessoire_id6=?,wps_filternr=? " _
                                                        & "where mix_id = " + Str(mix_id) + " and plaats = " + Str(i)
                                        End If
                                        Reader.Close()
                                        Dim j As Integer
                                        .Parameters.Clear()
                                        .Parameters.AddWithValue("", mix_id)
                                        .Parameters.AddWithValue("", i) 'plaats
                                        .Parameters.AddWithValue("", Val(DatabaseFlexGridShow.Item(1, i))) 'soort
                                        For j = 3 To 8
                                            .Parameters.AddWithValue("", Val(DatabaseFlexGridShow.Item(j, i))) 'accessoires
                                        Next j
                                        .Parameters.AddWithValue("", Val(DatabaseFlexGridShow.Item(9, i))) ' filternr

                                        .ExecuteNonQuery()

                                    End With
                                Next i
                                MsgBox("Mix opgeslagen!", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (mixen vullen)" + ex.Message)
                            MessageBox.Show("Database fout: (mixen vullen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try

                    Case "Fust categorie vullen"

                        If DatabaseFlexGridShow.Cols.Count = 3 Then

                            Dim fust_cat_id As Integer = DatabaseFlexGridEdit(1, 0)
                            Dim naam As String = DatabaseFlexGridEdit(1, 1)

                            Dim CmdString As String
                            Try
                                'Open Connection
                                Using Conn As New OdbcConnection(ConnString)
                                    Conn.Open()
                                    'Execute Query

                                    CmdString = "SELECT * FROM fustcategorie WHERE 1=0"
                                    Dim Cmd15 As New OdbcCommand(CmdString, Conn)
                                    With Cmd15
                                        If fust_cat_id = 0 Then   'nieuwe groep
                                            .CommandText = "INSERT INTO fustcategorie(naam) VALUES(?)"
                                        Else   'veranderd groep 
                                            .CommandText = "UPDATE fustcategorie SET naam=? WHERE id = " + Str(fust_cat_id)
                                        End If
                                        .Parameters.Clear()
                                        .Parameters.AddWithValue("", naam)
                                        .ExecuteNonQuery()

                                    End With


                                    If fust_cat_id = 0 Then  'fetch new id if needed
                                        If postgress = True Then
                                            Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('fustcategorie','id'))", Conn)
                                            fust_cat_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        Else
                                            Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                            fust_cat_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        End If
                                    Else
                                        Dim Cmd2String As String = "DELETE FROM fustcategorie_ids where fustcategorie_id = " + Str(fust_cat_id)
                                        Dim Cmd2 As New OdbcCommand(Cmd2String, Conn)
                                        Cmd2.ExecuteNonQuery()
                                    End If


                                    For i = 1 To DatabaseFlexGridShow.Rows.Count() - 1

                                        Dim Cmd As New OdbcCommand("INSERT INTO fustcategorie_ids(fustcategorie_id,soortgroep_id,fust_id) VALUES(?,?,?)", Conn)
                                        Cmd.Parameters.Clear()
                                        Cmd.Parameters.AddWithValue("", fust_cat_id)
                                        Cmd.Parameters.AddWithValue("", Val(DatabaseFlexGridShow.Item(i, 0))) 'soortgroep id
                                        Cmd.Parameters.AddWithValue("", Val(DatabaseFlexGridShow.Item(i, 2))) 'fust id

                                        Cmd.ExecuteNonQuery()


                                    Next i
                                    Set_Flexindeling_fustcategorie()
                                    MsgBox("Fust categorie opgeslagen!", MsgBoxStyle.OkOnly)
                                End Using
                            Catch ex As Exception
                                ErrorLog("Database opslaan: (Fust categorie vullen)" + ex.Message)
                                MessageBox.Show("Database fout: (Fust categorie vullen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                            End Try
                        End If

                    Case "Hoes categorie vullen"

                        If DatabaseFlexGridShow.Cols.Count = 3 Then

                            Dim hoes_cat_id As Integer = DatabaseFlexGridEdit(1, 0)
                            Dim naam As String = DatabaseFlexGridEdit(1, 1)

                            Dim CmdString As String
                            Try
                                'Open Connection
                                Using Conn As New OdbcConnection(ConnString)
                                    Conn.Open()
                                    'Execute Query

                                    CmdString = "SELECT * FROM hoescategorie WHERE 1=0"
                                    Dim Cmd15 As New OdbcCommand(CmdString, Conn)
                                    With Cmd15
                                        If hoes_cat_id = 0 Then   'nieuwe groep
                                            .CommandText = "INSERT INTO hoescategorie(naam) VALUES(?)"
                                        Else   'veranderd groep 
                                            .CommandText = "UPDATE hoescategorie SET naam=? WHERE id = " + Str(hoes_cat_id)
                                        End If
                                        .Parameters.Clear()
                                        .Parameters.AddWithValue("", naam)
                                        .ExecuteNonQuery()

                                    End With


                                    If hoes_cat_id = 0 Then  'fetch new id if needed
                                        If postgress = True Then
                                            Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('hoescategorie','id'))", Conn)
                                            hoes_cat_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        Else
                                            Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                            hoes_cat_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        End If
                                    Else
                                        Dim Cmd2String As String = "DELETE FROM hoescategorie_ids where hoescategorie_id = " + Str(hoes_cat_id)
                                        Dim Cmd2 As New OdbcCommand(Cmd2String, Conn)
                                        Cmd2.ExecuteNonQuery()
                                    End If


                                    For i = 1 To DatabaseFlexGridShow.Rows.Count() - 1

                                        Dim Cmd As New OdbcCommand("INSERT INTO hoescategorie_ids(hoescategorie_id,soortgroep_id,accessoire_id) VALUES(?,?,?)", Conn)
                                        Cmd.Parameters.Clear()
                                        Cmd.Parameters.AddWithValue("", hoes_cat_id)
                                        Cmd.Parameters.AddWithValue("", Val(DatabaseFlexGridShow.Item(i, 0))) 'soortgroep id
                                        Cmd.Parameters.AddWithValue("", Val(DatabaseFlexGridShow.Item(i, 2))) 'hoes id

                                        Cmd.ExecuteNonQuery()


                                    Next i
                                    Set_Flexindeling_hoescategorie()
                                    MsgBox("hoes categorie opgeslagen!", MsgBoxStyle.OkOnly)
                                End Using
                            Catch ex As Exception
                                ErrorLog("Database opslaan: (hoes categorie vullen)" + ex.Message)
                                MessageBox.Show("Database fout: (hoes categorie vullen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                            End Try
                        End If



                    Case "Mix lagen"

                        Dim cmdstring As String
                        Dim mix_id As Integer
                        mix_id = DatabaseFlexGridEdit.GetData(1, 0)

                        Try

                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()

                                ' eerst mixlagen wissen en dan toevoegen
                                Dim Cmd2String As String = "DELETE FROM mixlagen where mixlaag_id = " + Str(mix_id)
                                Dim Cmd2 As New OdbcCommand(Cmd2String, Conn)
                                Cmd2.ExecuteNonQuery()

                                For i = 1 To DatabaseFlexGridShow.Rows.Count() - 1
                                    cmdstring = ""
                                    If Val(DatabaseFlexGridShow.Item(i, 1)) > 0 Then
                                        'Execute Query
                                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                                        With Cmd

                                            .CommandText = "INSERT INTO mixlagen(mixlaag_id,soort_id) VALUES(?,?)"
                                            .Parameters.Clear()
                                            .Parameters.AddWithValue("", mix_id)
                                            .Parameters.AddWithValue("", Val(DatabaseFlexGridShow.Item(i, 1))) 'soortid
                                            .ExecuteNonQuery()

                                        End With
                                    End If
                                Next i

                                LoadDB_Flexindeling_mixlagenvullen()

                                MsgBox("Mixlagen opgeslagen!", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (mixlagen vullen)" + ex.Message)
                            MessageBox.Show("Database fout: (mixlagen vullen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try



                    Case "Kopersgroepen"

                        Dim eanlist As String = ""
                        Dim id As Integer
                        Dim naam As String

                        If DatabaseFlexGridShow.Cols.Count = 3 Then

                            id = DatabaseFlexGridEdit(1, 0)
                            naam = DatabaseFlexGridEdit(1, 1)

                            Dim CmdString As String
                            Try
                                'Open Connection
                                Using Conn As New OdbcConnection(ConnString)
                                    Conn.Open()
                                    'Execute Query

                                    CmdString = "SELECT * FROM kopersgroepen2 WHERE 1=0"
                                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                                    With Cmd

                                        If id = 0 Then   'nieuwe groep
                                            .CommandText = "INSERT INTO kopersgroepen2(groepnaam) VALUES(?)"
                                        Else   'veranderd groep 
                                            .CommandText = "UPDATE kopersgroepen2 SET groepnaam=? WHERE id = " + Str(id)
                                        End If
                                        .Parameters.Clear()
                                        .Parameters.AddWithValue("", naam)
                                        .ExecuteNonQuery()

                                    End With


                                    If id = 0 Then  'fetch new id if needed

                                        If postgress = True Then
                                            Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('kopersgroepen2','id'))", Conn)
                                            id = Convert.ToInt32(Cmd5.ExecuteScalar())

                                        Else
                                            Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                            id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        End If

                                    Else
                                        CmdString = "DELETE FROM kopersgroepen2_eans WHERE id = " + Str(id)
                                        Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                        Cmd2.ExecuteNonQuery()
                                    End If

                                    CmdString = "SELECT * FROM kopersgroepen2_eans WHERE 1=0"
                                    Dim Cmd3 As New OdbcCommand(CmdString, Conn)
                                    With Cmd3
                                        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                                            If DatabaseFlexGridShow.Item(i, 0) = True Then
                                                .CommandText = "INSERT INTO kopersgroepen2_eans(id,ean) VALUES(?,?)"
                                                .Parameters.Clear()
                                                .Parameters.AddWithValue("", id)
                                                .Parameters.AddWithValue("", DatabaseFlexGridShow.GetData(i, 2))
                                                .ExecuteNonQuery()
                                                .Parameters.Clear()
                                            End If
                                        Next i
                                    End With

                                    Set_Flexindeling_kopersgroep()
                                    LoadDB_Flexindeling_kopersgroepen()
                                    DatabaseFlexGridEdit.Focus()
                                    DatabaseFlexGridEdit.Rows.Count = 1
                                    MsgBox("Kopersgroep opgeslagen!", MsgBoxStyle.OkOnly)
                                End Using
                            Catch ex As Exception
                                ErrorLog("Database opslaan: (kopersgroepen)" + ex.Message)
                                MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                            End Try
                        End If

                    Case "Soortgroepen"

                        Dim idlist As String = ""
                        Dim id As Integer
                        Dim naam As String
                        Dim fusten As Boolean = False
                        Dim hoezen As Boolean = False
                        Dim prijzen As Boolean = False
                        Dim veilgroepen As Boolean = False
                        If DatabaseFlexGridShow.Cols.Count = 3 Then

                            id = DatabaseFlexGridEdit(1, 0)
                            naam = DatabaseFlexGridEdit(1, 1)
                            fusten = CHbool(DatabaseFlexGridEdit(1, 2))
                            hoezen = CHbool(DatabaseFlexGridEdit(1, 3))
                            prijzen = CHbool(DatabaseFlexGridEdit(1, 4))
                            veilgroepen = CHbool(DatabaseFlexGridEdit(1, 5))
                            Dim CmdString As String
                            Try
                                'Open Connection
                                Using Conn As New OdbcConnection(ConnString)
                                    Conn.Open()
                                    'Execute Query

                                    CmdString = "SELECT * FROM soortgroepen WHERE 1=0"
                                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                                    With Cmd

                                        If id = 0 Then   'nieuwe groep
                                            .CommandText = "INSERT INTO soortgroepen(groepnaam,fusten,hoezen,prijzen,veilgroep) VALUES(?,?,?,?,?)"
                                        Else   'veranderd groep 
                                            .CommandText = "UPDATE soortgroepen SET groepnaam=?, fusten=?, hoezen=?, prijzen=?,veilgroep=? WHERE id = " + Str(id)
                                        End If
                                        .Parameters.Clear()
                                        .Parameters.AddWithValue("", naam)
                                        .Parameters.AddWithValue("", fusten)
                                        .Parameters.AddWithValue("", hoezen)
                                        .Parameters.AddWithValue("", prijzen)
                                        .Parameters.AddWithValue("", veilgroepen)
                                        .ExecuteNonQuery()

                                    End With


                                    If id = 0 Then  'fetch new id if needed
                                        If postgress = True Then
                                            Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('soortgroepen','id'))", Conn)
                                            id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        Else
                                            Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                            id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                        End If
                                    Else
                                        CmdString = "DELETE FROM soortgroepen_ids WHERE id = " + Str(id)
                                        Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                        Cmd2.ExecuteNonQuery()
                                    End If

                                    CmdString = "SELECT * FROM soortgroepen_ids WHERE 1=0"
                                    Dim Cmd3 As New OdbcCommand(CmdString, Conn)
                                    With Cmd3
                                        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                                            If DatabaseFlexGridShow.Item(i, 0) = True Then
                                                .CommandText = "INSERT INTO soortgroepen_ids(id,soortmixid) VALUES(?,?)"
                                                .Parameters.Clear()
                                                .Parameters.AddWithValue("", id)
                                                .Parameters.AddWithValue("", DatabaseFlexGridShow.GetData(i, 2))
                                                .ExecuteNonQuery()
                                                .Parameters.Clear()
                                            End If
                                        Next i
                                    End With

                                    Set_Flexindeling_soortgroep()
                                    LoadDB_Flexindeling_soortgroepen()
                                    DatabaseFlexGridEdit.Focus()
                                    DatabaseFlexGridEdit.Rows.Count = 1
                                    MsgBox("Soortgroep opgeslagen!", MsgBoxStyle.OkOnly)
                                End Using
                            Catch ex As Exception
                                ErrorLog("Database opslaan: (soortgroepen)" + ex.Message)
                                MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                            End Try
                        End If



                    Case "Agenda"

                        Dim CmdString As String = "SELECT * FROM agenda WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                With Cmd

                                    Dim id = DatabaseFlexGridEdit.Item(1, 6)

                                    If id > 0 And DatabaseFlexGridEdit.Item(1, 7) = True Then
                                        CmdString = "DELETE FROM agenda WHERE id = " + Str(id)
                                        Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                        Cmd2.ExecuteNonQuery()
                                    Else

                                        If DatabaseFlexGridEdit.Item(1, 6) = 0 Then   'nieuwe invoer
                                            .CommandText = "INSERT INTO agenda(start_datum,eind_datum,vakantie,aktie,opmerking,tekst)" _
                                                        & "VALUES(?,?,?,?,?,?)"
                                        Else   'verander
                                            .CommandText = "UPDATE agenda SET start_datum=?,eind_datum=?,vakantie=?,aktie=?,opmerking=?, tekst=?" _
                                                        & "WHERE id = " + Str$(id)
                                        End If

                                        Dim i As Integer
                                        .Parameters.Clear()
                                        For i = 0 To 5
                                            .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, i))
                                        Next i

                                        .ExecuteNonQuery()

                                    End If
                                End With
                                LoadDB_Flexindeling_agenda()
                                ShowAgenda(Now)
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Agenda invoer opgeslagen!", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (agenda)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try


                    Case "Favorieten"

                        Dim cmdstring As String
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                cmdstring = "TRUNCATE favorieten_naam"
                                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                                Cmd2.ExecuteNonQuery()

                                cmdstring = "SELECT * FROM favorieten_naam WHERE 1=0"
                                Dim Cmd3 As New OdbcCommand(cmdstring, Conn)
                                With Cmd3
                                    For i = 0 To 4

                                        .CommandText = "INSERT INTO favorieten_naam(naam) VALUES(?)"
                                        .Parameters.Clear()
                                        .Parameters.AddWithValue("", DatabaseFlexGridEdit.GetData(1, i))
                                        .ExecuteNonQuery()
                                        .Parameters.Clear()
                                    Next i
                                End With

                                'Execute Query
                                cmdstring = "TRUNCATE favorieten_lijst"
                                Dim Cmd4 As New OdbcCommand(cmdstring, Conn)
                                Cmd4.ExecuteNonQuery()

                                cmdstring = "SELECT * FROM favorieten_lijst WHERE 1=0"
                                Dim Cmd5 As New OdbcCommand(cmdstring, Conn)
                                With Cmd5
                                    For j = 0 To 4
                                        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                                            If DatabaseFlexGridShow.Item(i, j * 2) = True Then
                                                .CommandText = "INSERT INTO favorieten_lijst(nummer,soortid) VALUES(?,?)"
                                                .Parameters.Clear()
                                                .Parameters.AddWithValue("", j + 1)
                                                .Parameters.AddWithValue("", DatabaseFlexGridShow.GetData(i, 10))
                                                .ExecuteNonQuery()
                                                .Parameters.Clear()
                                            End If
                                        Next i
                                    Next j
                                End With

                                MsgBox("Favorieten opgeslagen!", MsgBoxStyle.OkOnly)
                            End Using

                        Catch ex As Exception
                            ErrorLog("Database opslaan: (favorieten)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Soort volgorde"

                        'resort table 
                        For j = 1 To DatabaseFlexGridShow.Rows.Count - 2
                            For i = 1 To DatabaseFlexGridShow.Rows.Count - 2
                                Dim line1 As Integer = DatabaseFlexGridShow.GetData(i, 2)
                                Dim line2 As Integer = DatabaseFlexGridShow.GetData(i + 1, 2)
                                If line1 > line2 Then
                                    Dim saveval1 As String = DatabaseFlexGridShow.GetData(i, 0)  'naam
                                    Dim saveval2 As Integer = DatabaseFlexGridShow.GetData(i, 1)  'id
                                    Dim saveval3 As Integer = DatabaseFlexGridShow.GetData(i, 2)   'volgorde
                                    DatabaseFlexGridShow.SetData(i, 0, DatabaseFlexGridShow.GetData(i + 1, 0))
                                    DatabaseFlexGridShow.SetData(i, 1, DatabaseFlexGridShow.GetData(i + 1, 1))
                                    DatabaseFlexGridShow.SetData(i, 2, DatabaseFlexGridShow.GetData(i + 1, 2))
                                    DatabaseFlexGridShow.SetData(i + 1, 0, saveval1 + "x")
                                    DatabaseFlexGridShow.SetData(i + 1, 1, saveval2)
                                    DatabaseFlexGridShow.SetData(i + 1, 2, saveval3)
                                End If
                            Next i
                        Next j

                        Dim cmdstring As String = "SELECT * FROM soortvolgorde WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                cmdstring = "update soortvolgorde set soortid = 99999, volgorde = 99999"
                                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                                Cmd2.ExecuteNonQuery()

                                cmdstring = "SELECT * FROM soortvolgorde WHERE 1=0"
                                Dim Cmd3 As New OdbcCommand(cmdstring, Conn)
                                With Cmd3
                                    For i = 1 To DatabaseFlexGridShow.Rows.Count - 1

                                        .CommandText = "INSERT INTO soortvolgorde(volgorde,soortid) VALUES(?,?)"
                                        .Parameters.Clear()
                                        .Parameters.AddWithValue("", 1000 + i)
                                        .Parameters.AddWithValue("", DatabaseFlexGridShow.GetData(i, 1))
                                        .ExecuteNonQuery()
                                        .Parameters.Clear()
                                    Next i
                                End With

                                cmdstring = "delete from soortvolgorde where soortid = 99999 and volgorde =99999"
                                Dim Cmd4 As New OdbcCommand(cmdstring, Conn)
                                Cmd4.ExecuteNonQuery()


                                LoadDB_Flexindeling_soortvolgorde()
                                Create_SoortMixTable()
                                MsgBox("Soort volgorde opgeslagen!", MsgBoxStyle.OkOnly)
                            End Using

                        Catch ex As Exception
                            ErrorLog("Database opslaan: (soortvolgorde)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Florecom soortmatch opm"

                        Dim CmdString As String = "SELECT * FROM soortmatch3 WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query


                                Dim koper_ean As String = DatabaseFlexGridEdit.Item(1, 0)
                                Dim vbn_string As String = DatabaseFlexGridEdit.Item(1, 1)
                                Dim vbn_string2() As String = Microsoft.VisualBasic.Strings.Split(vbn_string, ":")
                                Dim vbn_code = vbn_string2(0)
                                Dim kwekercode = DatabaseFlexGridEdit.Item(1, 2)
                                Dim soortomschrijving As String = DatabaseFlexGridEdit.Item(1, 3)
                                Dim opmerking As String = DatabaseFlexGridEdit.Item(1, 4)
                                Dim soort As Integer = DatabaseFlexGridEdit.Item(1, 5)
                                Dim acc1 As Integer = DatabaseFlexGridEdit.Item(1, 6)
                                Dim acc2 As Integer = DatabaseFlexGridEdit.Item(1, 7)
                                Dim fust As Integer = DatabaseFlexGridEdit.Item(1, 8)
                                Dim potmaat As Integer = DatabaseFlexGridEdit.Item(1, 9)
                                Dim delete As Boolean = DatabaseFlexGridEdit.Item(1, 10)

                                If delete = True Then
                                    CmdString = "DELETE FROM soortmatch3 WHERE koper_ean = ? and vbn_code = ? and PIA_SA_EAN = ? and IMD_Full_name = ? and opmerking3 =? and potmaat =?"
                                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", koper_ean)
                                    Cmd2.Parameters.AddWithValue("", vbn_code)
                                    Cmd2.Parameters.AddWithValue("", kwekercode)
                                    Cmd2.Parameters.AddWithValue("", soortomschrijving)
                                    Cmd2.Parameters.AddWithValue("", opmerking)
                                    Cmd2.Parameters.AddWithValue("", potmaat)
                                    Cmd2.ExecuteNonQuery()
                                Else

                                    CmdString = "UPDATE soortmatch3 SET soortid=?,accessoire1=?,accessoire2=?,fustcode=? WHERE koper_ean = ? and vbn_code = ? and PIA_SA_EAN = ? and IMD_Full_name = ? and opmerking3 = ? and potmaat = ?"
                                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", soort)
                                    Cmd2.Parameters.AddWithValue("", acc1)
                                    Cmd2.Parameters.AddWithValue("", acc2)
                                    Cmd2.Parameters.AddWithValue("", fust)
                                    '
                                    Cmd2.Parameters.AddWithValue("", koper_ean)
                                    Cmd2.Parameters.AddWithValue("", vbn_code)
                                    Cmd2.Parameters.AddWithValue("", kwekercode)
                                    Cmd2.Parameters.AddWithValue("", soortomschrijving)
                                    Cmd2.Parameters.AddWithValue("", opmerking)
                                    Cmd2.Parameters.AddWithValue("", potmaat)
                                    Cmd2.ExecuteNonQuery()
                                End If

                                loadDB_FlexIndeling_soortmatch1()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Soortmatch aangepast", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("soortmatch opslaan: " + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Florecom soortmatch -"

                        Dim CmdString As String = "SELECT * FROM soortmatch2 WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query


                                Dim koper_ean As String = DatabaseFlexGridEdit.Item(1, 0)
                                Dim vbn_string As String = DatabaseFlexGridEdit.Item(1, 1)
                                Dim vbn_string2() As String = Microsoft.VisualBasic.Strings.Split(vbn_string, ":")
                                Dim vbn_code = vbn_string2(0)
                                Dim kwekercode = DatabaseFlexGridEdit.Item(1, 2)
                                Dim soortomschrijving As String = DatabaseFlexGridEdit.Item(1, 3)
                                'Dim opmerking As String = DatabaseFlexGridEdit.Item(1, 4)
                                Dim soort As Integer = DatabaseFlexGridEdit.Item(1, 5)
                                Dim acc1 As Integer = DatabaseFlexGridEdit.Item(1, 6)
                                Dim acc2 As Integer = DatabaseFlexGridEdit.Item(1, 7)
                                Dim fust As Integer = DatabaseFlexGridEdit.Item(1, 8)
                                Dim potmaat As Integer = DatabaseFlexGridEdit.Item(1, 9)
                                Dim delete As Boolean = DatabaseFlexGridEdit.Item(1, 10)

                                If delete = True Then
                                    CmdString = "DELETE FROM soortmatch2 WHERE koper_ean = ? and vbn_code = ? and PIA_SA_EAN = ? and IMD_Full_name = ? and potmaat = ? "
                                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", koper_ean)
                                    Cmd2.Parameters.AddWithValue("", vbn_code)
                                    Cmd2.Parameters.AddWithValue("", kwekercode)
                                    Cmd2.Parameters.AddWithValue("", soortomschrijving)
                                    Cmd2.Parameters.AddWithValue("", potmaat)
                                    Cmd2.ExecuteNonQuery()
                                Else

                                    CmdString = "UPDATE soortmatch2 SET soortid=?,accessoire1=?,accessoire2=?,fustcode=? WHERE koper_ean = ? and vbn_code = ? and PIA_SA_EAN = ? and IMD_Full_name = ? and potmaat = ?"
                                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", soort)
                                    Cmd2.Parameters.AddWithValue("", acc1)
                                    Cmd2.Parameters.AddWithValue("", acc2)
                                    Cmd2.Parameters.AddWithValue("", fust)
                                    '
                                    Cmd2.Parameters.AddWithValue("", koper_ean)
                                    Cmd2.Parameters.AddWithValue("", vbn_code)
                                    Cmd2.Parameters.AddWithValue("", kwekercode)
                                    Cmd2.Parameters.AddWithValue("", soortomschrijving)
                                    Cmd2.Parameters.AddWithValue("", potmaat)
                                    Cmd2.ExecuteNonQuery()
                                End If

                                loadDB_FlexIndeling_soortmatch2()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Soortmatch aangepast", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("soortmatch opslaan: " + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Kwekerscode"

                        Dim CmdString As String = "SELECT * FROM prijslijst WHERE 1=0"
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim id As Integer = DatabaseFlexGridEdit.Item(1, 0)
                                Dim kwekerscode As String = DatabaseFlexGridEdit.Item(1, 1)
                                Dim omschrijving As String = DatabaseFlexGridEdit.Item(1, 2)
                                Dim soort As Integer = DatabaseFlexGridEdit.Item(1, 3)
                                Dim acc1 As Integer = DatabaseFlexGridEdit.Item(1, 4)
                                Dim acc2 As Integer = DatabaseFlexGridEdit.Item(1, 5)
                                Dim fust As Integer = DatabaseFlexGridEdit.Item(1, 6)
                                Dim hoes As Integer = DatabaseFlexGridEdit.Item(1, 7)
                                Dim prijs As Integer = DatabaseFlexGridEdit.Item(1, 8) * 100
                                Dim korting As Integer = DatabaseFlexGridEdit.Item(1, 9)
                                Dim kopersgroep As Integer = DatabaseFlexGridEdit.Item(1, 10)

                                Dim delete As Boolean = DatabaseFlexGridEdit.Item(1, 11)

                                If delete = True Then
                                    Dim Cmd2 As New OdbcCommand("DELETE FROM prijslijst WHERE kwekerscode = ? and omschrijving = ? ", Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", kwekerscode)
                                    Cmd2.Parameters.AddWithValue("", omschrijving)
                                    Cmd2.ExecuteNonQuery()
                                Else

                                    CmdString = ""
                                    If id = 0 Then
                                        CmdString = "INSERT INTO prijslijst (soort, accessoire1, accessoire2, fust, hoes, prijs, korting, kopersgroep, kwekerscode, omschrijving) VALUES(?,?,?,?,?,?,?,?,?,?)"
                                    Else
                                        CmdString = "UPDATE prijslijst SET soort=?, accessoire1=?, accessoire2=?, fust=?, hoes=?, prijs=?, korting=?, kopersgroep=? WHERE kwekerscode = ? and omschrijving = ?"
                                    End If

                                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", soort)
                                    Cmd2.Parameters.AddWithValue("", acc1)
                                    Cmd2.Parameters.AddWithValue("", acc2)
                                    Cmd2.Parameters.AddWithValue("", fust)
                                    Cmd2.Parameters.AddWithValue("", hoes)
                                    Cmd2.Parameters.AddWithValue("", prijs)
                                    Cmd2.Parameters.AddWithValue("", korting)
                                    Cmd2.Parameters.AddWithValue("", kopersgroep)
                                    Cmd2.Parameters.AddWithValue("", kwekerscode.ToUpper())
                                    Cmd2.Parameters.AddWithValue("", omschrijving)
                                    Cmd2.ExecuteNonQuery()
                                End If

                                loadDB_FlexIndeling_kwekerscode()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Kwekerscode opgeslagen", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Kwekerscode opslaan: " + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try


                    Case "Prijslijst J en P importeren"

                        Dim nieuwe_code As Boolean = True
                        Dim kwekerscode As String = DatabaseFlexGridEdit.GetData(1, 1)
                        Dim omschrijving As String = DatabaseFlexGridEdit.GetData(1, 2)
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Reader As OdbcDataReader
                                Dim Cmd As New OdbcCommand("SELECT * FROM prijslijst WHERE kwekerscode=? and omschrijving=?", Conn)
                                Cmd.Parameters.Clear()
                                Cmd.Parameters.AddWithValue("", kwekerscode)
                                Cmd.Parameters.AddWithValue("", omschrijving)
                                Reader = Cmd.ExecuteReader()
                                If Reader.HasRows Then
                                    nieuwe_code = False
                                End If
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (prijslijst/menuopslaan)" + ex.Message)
                            MessageBox.Show("Database fout: (prijslijst/menuopslaan)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try

                        Try

                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim Cmd2 As New OdbcCommand("", Conn)
                                With Cmd2

                                    If nieuwe_code = True Then   'nieuwe line 
                                        .CommandText = "INSERT INTO prijslijst(soort,accessoire1,accessoire2,fust,hoes,prijs,korting,kopersgroep,kwekerscode,omschrijving) VALUES(?,?,?,?,?,?,?,?,?,?)"
                                    Else
                                        .CommandText = "UPDATE prijslijst SET soort=?, accessoire1=?, accessoire2=?, fust=?, hoes=? ,prijs=?, korting=?, kopersgroep=? WHERE kwekerscode = ? and omschrijving = ?"
                                    End If
                                    .Parameters.Clear()
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 3))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 4))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 5))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 6))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 7))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 8) * 100)
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 9))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 10))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 1))
                                    .Parameters.AddWithValue("", DatabaseFlexGridEdit.Item(1, 2))
                                    .ExecuteNonQuery()
                                End With

                                DatabaseFlexGridEdit.Rows(1).Style = DatabaseFlexGridShow.Styles("blue")
                                Dim row As Integer = DatabaseFlexGridEdit.Item(1, 0)
                                DatabaseFlexGridShow.Rows(row).Style = DatabaseFlexGridShow.Styles("blue")

                            End Using
                        Catch ex As Exception
                            ErrorLog("Database opslaan: (alias)" + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Prijslijst kortingtabel"

                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim id As Integer = DatabaseFlexGridEdit.Item(1, 0)
                                Dim kopersgroep As String = DatabaseFlexGridEdit.Item(1, 1)
                                Dim korting As Integer = DatabaseFlexGridEdit.Item(1, 2) * 100
                                Dim volgorde As Integer = DatabaseFlexGridEdit.Item(1, 3)
                                Dim delete As Integer = DatabaseFlexGridEdit.Item(1, 4)

                                If delete = -1 Then
                                    Dim Cmd2 As New OdbcCommand("DELETE FROM prijslijstkortingen WHERE id = ? ", Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", id)
                                    Cmd2.ExecuteNonQuery()
                                Else

                                    Dim CmdString As String = ""
                                    If id = 0 Then
                                        CmdString = "INSERT INTO prijslijstkortingen (kopersgroep,korting,volgorde) VALUES(?,?,?)"
                                    Else
                                        CmdString = "UPDATE prijslijstkortingen SET kopersgroep=?, korting=?, volgorde=? WHERE id = ?"
                                    End If

                                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", kopersgroep)
                                    Cmd2.Parameters.AddWithValue("", korting)
                                    Cmd2.Parameters.AddWithValue("", volgorde)
                                    If id > 0 Then
                                        Cmd2.Parameters.AddWithValue("", id)
                                    End If
                                    Cmd2.ExecuteNonQuery()
                                End If

                                loadDB_FlexIndeling_prijslijstkortingtabel()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Kortingstabel opgeslagen", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Kortingtabel opslaan: " + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                    Case "Prijslijst koppelingen"

                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                'Execute Query
                                Dim id As Integer = DatabaseFlexGridEdit.Item(1, 0)
                                Dim soortgroep_id As Integer = DatabaseFlexGridEdit.Item(1, 1)
                                Dim soortmix_id As Integer = DatabaseFlexGridEdit.Item(1, 2)
                                Dim delete As Integer = DatabaseFlexGridEdit.Item(1, 3)

                                If delete = -1 Then
                                    Dim Cmd2 As New OdbcCommand("DELETE FROM prijslijstkoppelingen WHERE id = ? ", Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", id)
                                    Cmd2.ExecuteNonQuery()
                                Else

                                    Dim CmdString As String = ""
                                    If id = 0 Then
                                        CmdString = "INSERT INTO prijslijstkoppelingen (soortgroep_id,soortmix_id) VALUES(?,?)"
                                    Else
                                        CmdString = "UPDATE prijslijstkoppelingen SET soortgroep_id=?, soortmix_id=? WHERE id = ?"
                                    End If

                                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", soortgroep_id)
                                    Cmd2.Parameters.AddWithValue("", soortmix_id)
                                    If id > 0 Then
                                        Cmd2.Parameters.AddWithValue("", id)
                                    End If
                                    Cmd2.ExecuteNonQuery()
                                End If

                                loadDB_FlexIndeling_prijslijstkoppelingen()
                                DatabaseFlexGridEdit.Rows.Count = 1
                                MsgBox("Koppelingstabel opgeslagen", MsgBoxStyle.OkOnly)
                            End Using
                        Catch ex As Exception
                            ErrorLog("Koppelingstabel opslaan: " + ex.Message)
                            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
                        End Try

                End Select
            End If
        End If
        Set_Database_reload()
    End Sub
    Private Sub SetSoortVolgorde(ByVal soort_id)
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim cmdstring As String = "SELECT * FROM soortvolgorde WHERE 1=0"
                Dim Cmd3 As New OdbcCommand(cmdstring, Conn)
                With Cmd3
                    .CommandText = "INSERT INTO soortvolgorde(volgorde,soortid) VALUES(?,?)"
                    .Parameters.Clear()
                    .Parameters.AddWithValue("", 9999)
                    .Parameters.AddWithValue("", soort_id)
                    .ExecuteNonQuery()
                    .Parameters.Clear()
                End With
            End Using

        Catch ex As Exception
            ErrorLog("Setvolgorde: (soortvolgorde)" + ex.Message)
            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub
    Private Sub DatabaseMenuAanpassen_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles DatabaseMenuAanpassen.Click
        If current_dbtype = 1 Then
            Dim selecteditem As String = current_dbselection
            Select Case selecteditem

                Case "Kopers"
                    DatabaseLoadFromGrid(19)

                Case "Koper alias"
                    DatabaseLoadFromGrid(1)

                Case "Fusten"
                    DatabaseLoadFromGrid(16)

                Case "Soorten"
                    DatabaseLoadFromGrid(18)

                Case "Accessoires"
                    DatabaseLoadFromGrid(14)

                Case "Accessoire prijzen"
                    DatabaseLoadFromGrid(5)

                Case "Mixen naam"
                    DatabaseLoadFromGrid(19)

                Case "Mixen vullen"
                    LoadDB_Flexindeling_mixenvullen()

                Case "Kopersgroepen"
                    LoadDB_Flexindeling_kopersgroepenlist2()

                Case "Soortgroepen"
                    LoadDB_Flexindeling_soortgroepenlist2()

                Case "Fust categorie vullen"
                    Set_Flexindeling_fustcategorie_vullen2(False)

                Case "Hoes categorie vullen"
                    Set_Flexindeling_hoescategorie_vullen2(False)

                Case "Agenda"
                    DatabaseLoadFromGrid(6)

                Case "Florecom soortmatch opm"
                    DatabaseLoadFromGrid(9)

                Case "Florecom soortmatch -"
                    DatabaseLoadFromGrid(9)

                Case "Kwekerscode"
                    DatabaseLoadFromGrid(10)

                Case "Prijslijst kortingtabel"
                    DatabaseLoadFromGrid(3)

                Case "Prijslijst koppelingen"
                    DatabaseLoadFromGrid(2)

            End Select
        End If
    End Sub

    Private Sub DatabaseLoadFromGrid(ByVal gridlength As Integer)
        Dim i As Integer
        Dim j As Integer

        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
            If DatabaseFlexGridShow.Rows(i).Selected = True Then
                Dim flexgridfill(gridlength + 1) As Object
                For j = 0 To gridlength
                    flexgridfill(j) = DatabaseFlexGridShow.Item(i, j)
                Next
                'DatabaseFlexGridShow.
                DatabaseFlexGridEdit.Rows.Count = 1
                DatabaseFlexGridEdit.AddItem(flexgridfill)
                DatabaseFlexGridEdit.Rows(1).AllowEditing = True
                Exit For
            End If
        Next i
    End Sub
    Private Sub Color_CellButtonClick(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles DatabaseFlexGridEdit.CellButtonClick

        Dim clrDlg As New ColorDialog()

        'If DatabaseFlexGridEdit(e.Row, e.Col) Is GetType(Color) Then
        clrDlg.Color = GetColorValue(DatabaseFlexGridEdit(e.Row, e.Col))
        'End If

        ' Get new color from dialog and assign it to the cell.

        If clrDlg.ShowDialog() = System.Windows.Forms.DialogResult.OK Then
            DatabaseFlexGridEdit(e.Row, e.Col) = GetColorString(clrDlg.Color)
        End If

    End Sub
    Private Sub DatabaseFlexGridShow_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles DatabaseFlexGridShow.Click
        If database_lbl.Text = "Mixen vullen" Then   'mixen vullen filter combo
            If DatabaseFlexGridShow.Row = 2 Then

                '***************************************************
                ' COMBO invullen als er op geclicked wordt
                ' Create the custom editor.
                '***************************************************
                Dim style As C1.Win.C1FlexGrid.CellStyle = DatabaseFlexGridShow.Styles.Add("newGridStyle")
                DatabaseComboWpsFilter.DataMode = C1.Win.C1List.DataModeEnum.Normal

                Dim dt_filter As New DataTable
                dt_filter.Columns.Add("Code", GetType(Integer))
                dt_filter.Columns.Add("Naam", GetType(String))

                ' Dim cn() As String = New String() {"Naam", "Code"}
                dt_filter.Clear()

                '*********** LIJST GENEREREN **************************
                Dim soort_id = DatabaseFlexGridShow.Item(1, DatabaseFlexGridShow.Col)
                Dim wps_soort_id = soorten(GID(soorten, soort_id)).wps_code
                Dim potmaat = soorten(GID(soorten, soort_id)).potmaat
                Dim filterfound As Boolean = False
                For i = 0 To UBound(wpsfilter)
                    If potmaat = 190 Then potmaat = 170
                    If wps_soort_id = wpsfilter(i).wps_soortnummer And potmaat = wpsfilter(i).potmaat Then
                        dt_filter.Rows.Add(New String() {wpsfilter(i).filternummer, wpsfilter(i).filternaam})
                        filterfound = True
                    End If
                Next i
                If filterfound = False And soort_id < 10000 Then
                    dt_filter.Rows.Add(New String() {999999, "Niet via WPS"})
                End If
                'dt_soortmix.DefaultView.Sort = String.Format("volgorde", "DESC")
                DatabaseComboWpsFilter.DataSource = dt_filter
                DatabaseComboWpsFilter.DisplayMember = "Naam"
                DatabaseComboWpsFilter.ValueMember = "Code"
                DatabaseComboWpsFilter.Splits(0).DisplayColumns(0).Visible = False  ' id
                DatabaseComboWpsFilter.ComboStyle = 2  'combo style list

                DatabaseComboWpsFilter.MaxDropDownItems = 15

                DatabaseComboWpsFilter.DropDownWidth = 200
                DatabaseComboWpsFilter.ColumnWidth = 195
                DatabaseComboWpsFilter.MaxDropDownItems = 15

                style.Editor = DatabaseComboWpsFilter
                DatabaseFlexGridShow.SetCellStyle(2, DatabaseFlexGridShow.Col, style)
                DatabaseFlexGridShow.StartEditing(2, DatabaseFlexGridShow.Col)

                DatabaseComboWpsFilter.DroppedDown = True


            End If

        End If
        If database_lbl.Text = "Prijslijst J en P importeren" Then   'Prijslijst J&P IMPORT
            If DatabaseFlexGridShow.Row >= 1 Then
                Dim row As Integer = 0
                Dim kwekerscode As String = ""  'fetch kwekerscode from show
                Dim prijs As String = "0"
                Dim hoes As String = ""
                Dim omschrijving As String = ""
                For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                    If DatabaseFlexGridShow.Rows(i).Selected = True Then
                        kwekerscode = DatabaseFlexGridShow.Item(i, 1)
                        prijs = DatabaseFlexGridShow.Item(i, 7)
                        hoes = DatabaseFlexGridShow.Item(i, 6)
                        omschrijving = DatabaseFlexGridShow.Item(i, 2)
                        row = i
                        Exit For
                    End If
                Next
                If kwekerscode <> "" Then
                    Dim flexgridfill(11) As String
                    Dim Reader As OdbcDataReader
                    DatabaseFlexGridEdit.Rows.Count = 1
                    Try
                        'Open Connection

                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()

                            'Execute Query
                            Dim Cmd As New OdbcCommand("select * from prijslijst where kwekerscode=? and omschrijving=?", Conn)
                            Cmd.Parameters.Clear()
                            Cmd.Parameters.AddWithValue("", Trim(kwekerscode))
                            Cmd.Parameters.AddWithValue("", Trim(omschrijving))
                            Reader = Cmd.ExecuteReader()
                            If Reader.HasRows Then
                                Reader.Read()
                                flexgridfill(0) = row
                                flexgridfill(1) = CHstr(Reader("kwekerscode"))
                                flexgridfill(2) = CHstr(Reader("omschrijving"))
                                flexgridfill(3) = Tstr(CHint(Reader("soort")))
                                flexgridfill(4) = Tstr(CHint(Reader("accessoire1")))
                                flexgridfill(5) = Tstr(CHint(Reader("accessoire2")))
                                flexgridfill(6) = Tstr(CHint(Reader("fust")))
                                flexgridfill(7) = Tstr(CHint(Reader("hoes")))
                                flexgridfill(8) = CHint(Reader("prijs")) / 100
                                flexgridfill(9) = Tstr(CHint(Reader("korting")))
                                flexgridfill(10) = Tstr(CHint(Reader("kopersgroep")))

                                DatabaseFlexGridEdit.AddItem(flexgridfill)
                            Else
                                flexgridfill(0) = row
                                flexgridfill(1) = Trim(kwekerscode)
                                flexgridfill(2) = Trim(omschrijving)
                                flexgridfill(3) = Tstr(1)
                                flexgridfill(4) = Tstr(0)
                                flexgridfill(5) = Tstr(0)
                                flexgridfill(6) = Tstr(1)

                                If hoes = "Decorum" Then
                                    flexgridfill(7) = Tstr(1)
                                ElseIf hoes = "Blanco" Then
                                    flexgridfill(7) = Tstr(2)
                                ElseIf hoes = "Bedrukt" Then
                                    flexgridfill(7) = Tstr(3)
                                Else
                                    flexgridfill(7) = Tstr(0)
                                End If

                                flexgridfill(8) = prijs
                                flexgridfill(9) = 1
                                flexgridfill(10) = Tstr(0)

                                DatabaseFlexGridEdit.AddItem(flexgridfill)
                                DatabaseFlexGridEdit.Focus()
                            End If
                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: (prijslijstedit)" + ex.Message)
                        MessageBox.Show("Database fout: (prijslijstedit)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try

                End If



            End If
        End If
    End Sub
    Private Sub DatabaseComboWpsFilter_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles DatabaseComboWpsFilter.Validated
        'mixen vullen combo validated, soortid naar row 9
        If DatabaseComboWpsFilter.SelectedValue = Nothing Then
            DatabaseFlexGridShow.Item(9, DatabaseFlexGridShow.Col) = 0
        Else
            DatabaseFlexGridShow.Item(9, DatabaseFlexGridShow.Col) = DatabaseComboWpsFilter.SelectedValue
        End If


    End Sub
    Private Sub Set_FlexIndeling_soortmatch2()
        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 11
            .Rows.Count = 1

            .Cols(0).Caption = "Koper"
            .Cols(0).DataType = System.Type.GetType("System.String")
            Dim mcd_koper As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopers, "ID", cn, 0)
            .Cols(0).DataMap = mcd_koper
            .Cols(0).Width = 100
            .Cols(0).AllowEditing = False

            .Cols(1).Caption = "VBN-Code"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Kwekerscode"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 80
            .Cols(2).AllowEditing = False

            .Cols(3).Caption = "Soortomschrijving"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 150
            .Cols(3).AllowEditing = False

            .Cols(4).Caption = "Opmerking"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 150
            .Cols(4).AllowEditing = False
            .Cols(4).Visible = False

            .Cols(5).Caption = "Boek soort"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 80
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(5).DataMap = mcd_soortmix

            .Cols(6).Caption = "Accessoire 1"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 80
            Dim mcd_acce1 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(6).DataMap = mcd_acce1

            .Cols(7).Caption = "Accessoire 2"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 80
            Dim mcd_acce2 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(7).DataMap = mcd_acce2

            .Cols(8).Caption = "Fust"
            .Cols(8).DataType = System.Type.GetType("System.String")
            .Cols(8).Width = 80
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(8).DataMap = mcd_fust

            .Cols(9).Caption = "Potmaat"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 80
            .Cols(9).AllowEditing = False

            .Cols(10).Caption = "Wissen"
            .Cols(10).DataType = System.Type.GetType("System.Boolean")
            .Cols(10).Width = 40

        End With
        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 10
            .Rows.Count = 1

            .Cols(0).Caption = "Koper"
            .Cols(0).DataType = System.Type.GetType("System.String")
            Dim mcd_koper As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopers, "ID", cn, 0)
            .Cols(0).DataMap = mcd_koper
            .Cols(0).Width = 100

            .Cols(1).Caption = "VBN-Code"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200

            .Cols(2).Caption = "Kwekerscode"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 80

            .Cols(3).Caption = "Soortomschrijving"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 150

            .Cols(4).Caption = "Opmerking"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 150
            .Cols(4).Visible = False

            .Cols(5).Caption = "Boek soort"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 80
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(5).DataMap = mcd_soortmix

            .Cols(6).Caption = "Accessoire 1"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 80
            Dim mcd_acce1 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(6).DataMap = mcd_acce1

            .Cols(7).Caption = "Accessoire 2"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 80
            Dim mcd_acce2 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(7).DataMap = mcd_acce2

            .Cols(8).Caption = "Fust"
            .Cols(8).DataType = System.Type.GetType("System.String")
            .Cols(8).Width = 80
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(8).DataMap = mcd_fust

            .Cols(9).Caption = "Potmaat"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 80

        End With
    End Sub
    Private Sub Set_FlexIndeling_soortmatch1()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 11
            .Rows.Count = 1

            .Cols(0).Caption = "Koper"
            .Cols(0).DataType = System.Type.GetType("System.String")
            Dim mcd_koper As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopers, "ID", cn, 0)
            .Cols(0).DataMap = mcd_koper
            .Cols(0).Width = 100
            .Cols(0).AllowEditing = False

            .Cols(1).Caption = "VBN-Code"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Kwekerscode"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 80
            .Cols(2).AllowEditing = False

            .Cols(3).Caption = "Soortomschrijving"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 150
            .Cols(3).AllowEditing = False

            .Cols(4).Caption = "Opmerking"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 150
            .Cols(4).AllowEditing = False

            .Cols(5).Caption = "Boek soort"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 80
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(5).DataMap = mcd_soortmix

            .Cols(6).Caption = "Accessoire 1"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 80
            Dim mcd_acce1 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(6).DataMap = mcd_acce1

            .Cols(7).Caption = "Accessoire 2"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 80
            Dim mcd_acce2 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(7).DataMap = mcd_acce2

            .Cols(8).Caption = "Fust"
            .Cols(8).DataType = System.Type.GetType("System.String")
            .Cols(8).Width = 80
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(8).DataMap = mcd_fust

            .Cols(9).Caption = "Potmaat"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 80
            .Cols(9).AllowEditing = False

            .Cols(10).Caption = "Wissen"
            .Cols(10).DataType = System.Type.GetType("System.Boolean")
            .Cols(10).Width = 40

        End With
        With DatabaseFlexGridShow
            .Clear()
            .Cols.Count = 10
            .Rows.Count = 1

            .Cols(0).Caption = "Koper"
            .Cols(0).DataType = System.Type.GetType("System.String")
            Dim mcd_koper As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopers, "ID", cn, 0)
            .Cols(0).DataMap = mcd_koper
            .Cols(0).Width = 100

            .Cols(1).Caption = "VBN-Code"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200

            .Cols(2).Caption = "Kwekerscode"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 80

            .Cols(3).Caption = "Soortomschrijving"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 150

            .Cols(4).Caption = "Opmerking"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 150

            .Cols(5).Caption = "Boek soort"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 80
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(5).DataMap = mcd_soortmix

            .Cols(6).Caption = "Accessoire 1"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 80
            Dim mcd_acce1 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(6).DataMap = mcd_acce1

            .Cols(7).Caption = "Accessoire 2"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 80
            Dim mcd_acce2 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(7).DataMap = mcd_acce2

            .Cols(8).Caption = "Fust"
            .Cols(8).DataType = System.Type.GetType("System.String")
            .Cols(8).Width = 80
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(8).DataMap = mcd_fust

            .Cols(9).Caption = "Potmaat"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 80
        End With

    End Sub
    Private Sub loadDB_FlexIndeling_soortmatch1()
        Dim flexgridfill(10) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from soortmatch3"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("koper_ean"))
                    Dim vbncode As Integer = CHint(Reader("vbn_code"))
                    flexgridfill(1) = Trim(Str(vbncode)) + ":" + ReadSQLString("soortenlijst", "product_id", vbncode, "VBN_product_name")
                    flexgridfill(2) = CHstr(Reader("PIA_SA_EAN"))
                    flexgridfill(3) = CHstr(Reader("IMD_Full_Name"))
                    flexgridfill(4) = CHstr(Reader("opmerking3"))
                    flexgridfill(5) = CHstr(Reader("soortid"))
                    flexgridfill(6) = CHstr(Reader("accessoire1"))
                    flexgridfill(7) = CHstr(Reader("accessoire2"))
                    flexgridfill(8) = CHstr(Reader("fustcode"))
                    flexgridfill(9) = CHstr(Reader("potmaat"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortmatch1)" + ex.Message)
            MessageBox.Show("Database fout: (soortmatch1)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub loadDB_FlexIndeling_soortmatch2()
        Dim flexgridfill(10) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from soortmatch2"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("koper_ean"))
                    Dim vbncode As Integer = CHint(Reader("vbn_code"))
                    flexgridfill(1) = Trim(Str(vbncode)) + ":" + ReadSQLString("soortenlijst", "product_id", vbncode, "VBN_product_name")
                    flexgridfill(2) = CHstr(Reader("PIA_SA_EAN"))
                    flexgridfill(3) = CHstr(Reader("IMD_Full_Name"))
                    'flexgridfill(4) = Reader("opmerking3")
                    flexgridfill(5) = CHstr(Reader("soortid"))
                    flexgridfill(6) = CHstr(Reader("accessoire1"))
                    flexgridfill(7) = CHstr(Reader("accessoire2"))
                    flexgridfill(8) = CHstr(Reader("fustcode"))
                    flexgridfill(9) = CHstr(Reader("potmaat"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortmatch2)" + ex.Message)
            MessageBox.Show("Database fout: (soortmatch2)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Private Sub Set_FlexIndeling_kwekerscode()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit

            .Clear()
            .Cols.Count = 12
            .Rows.Count = 1

            .Cols(0).Caption = "ID"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 40
            .Cols(0).Visible = False

            .Cols(1).Caption = "Kwekerscode"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100
            .Cols(1).AllowEditing = True

            .Cols(2).Caption = "Omschrijving"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            .Cols(2).AllowEditing = True

            .Cols(3).Caption = "Soort"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 120
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(3).DataMap = mcd_soortmix

            .Cols(4).Caption = "Accessoire 1"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 110
            Dim mcd_acce1 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(4).DataMap = mcd_acce1

            .Cols(5).Caption = "Accessoire 2"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 110
            Dim mcd_acce3 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(5).DataMap = mcd_acce3

            .Cols(6).Caption = "Fust"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(6).DataMap = mcd_fust

            .Cols(7).Caption = "Hoes"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 100
            Dim mcd_acce2 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(7).DataMap = mcd_acce2

            .Cols(8).Caption = "Prijs"
            .Cols(8).DataType = System.Type.GetType("System.Double")
            .Cols(8).Width = 60
            .Cols(8).Format = "N2"

            .Cols(9).Caption = "Korting"
            .Cols(9).DataType = System.Type.GetType("System.Boolean")
            .Cols(9).Width = 50

            .Cols(10).Caption = "Kopersgroep"
            .Cols(10).DataType = System.Type.GetType("System.String")
            .Cols(10).Width = 100
            Dim mcd_kopersgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopersgroepen, "ID", cn, 0)
            .Cols(10).DataMap = mcd_kopersgroepen

            .Cols(11).Caption = "Wissen"
            .Cols(11).DataType = System.Type.GetType("System.Boolean")
            .Cols(11).Width = 50



        End With
        With DatabaseFlexGridShow
            .AllowEditing = False
            .Cols.Count = 11
            .Rows.Count = 1

            .Cols(0).Caption = "ID"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 40
            .Cols(0).Visible = False

            .Cols(1).Caption = "Kwekerscode"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Omschrijving"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            .Cols(2).AllowEditing = False

            .Cols(3).Caption = "Soort"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 120
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(3).DataMap = mcd_soortmix

            .Cols(4).Caption = "Accessoire 1"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 110
            Dim mcd_acce1 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(4).DataMap = mcd_acce1

            .Cols(5).Caption = "Accessoire 2"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 110
            Dim mcd_acce3 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(5).DataMap = mcd_acce3

            .Cols(6).Caption = "Fust"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(6).DataMap = mcd_fust

            .Cols(7).Caption = "Hoes"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 100
            Dim mcd_acce2 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(7).DataMap = mcd_acce2

            .Cols(8).Caption = "Prijs"
            .Cols(8).DataType = System.Type.GetType("System.Double")
            .Cols(8).Width = 60
            .Cols(8).Format = "N2"

            .Cols(9).Caption = "Korting"
            .Cols(9).DataType = System.Type.GetType("System.Boolean")
            .Cols(9).Width = 50

            .Cols(10).Caption = "Kopersgroep"
            .Cols(10).DataType = System.Type.GetType("System.String")
            .Cols(10).Width = 100
            Dim mcd_kopersgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopersgroepen, "ID", cn, 0)
            .Cols(10).DataMap = mcd_kopersgroepen


        End With
    End Sub
    Private Sub loadDB_FlexIndeling_kwekerscode()
        Dim flexgridfill(11) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from prijslijst order by soort,omschrijving"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Dim count As Integer = 1
                Do While Reader.Read()
                    flexgridfill(0) = count
                    flexgridfill(1) = CHstr(Reader("kwekerscode"))
                    flexgridfill(2) = CHstr(Reader("omschrijving"))
                    flexgridfill(3) = CHstr(Reader("soort"))
                    flexgridfill(4) = CHstr(Reader("accessoire1"))
                    flexgridfill(5) = CHstr(Reader("accessoire2"))
                    flexgridfill(6) = CHstr(Reader("fust"))
                    flexgridfill(7) = Tstr(CHint(Reader("hoes")))
                    flexgridfill(8) = Reader("prijs") / 100
                    flexgridfill(9) = CHstr(Reader("korting"))
                    flexgridfill(10) = CHstr(Reader("kopersgroep"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                    count = count + 1
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijslijst kwekerscode)" + ex.Message)
            MessageBox.Show("Database fout: (prijslijst kwekerscode)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Private Sub Set_Flexindeling_fustcategorie()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 2
            .Rows.Count = 1

            .Cols(0).Caption = "id"
            .Cols(0).DataType = System.Type.GetType("System.Int32")
            .Cols(0).Width = 80
            .Cols(0).AllowEditing = False
            .Cols(0).Visible = False

            .Cols(1).Caption = "Fust categorie naam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200
            .Cols(1).AllowEditing = True

        End With


        With DatabaseFlexGridShow
            .AllowEditing = True
            .SelectionMode = SelectionModeEnum.ListBox
            .Clear()
            .Cols.Fixed = 0
            .Rows.Fixed = 1
            .Rows.Count = 1
            .Cols.Count = 2

            .Cols(0).Caption = "Id"
            .Cols(0).Width = 120
            .Cols(0).AllowEditing = True
            .Cols(0).Visible = False
            .Cols(0).AllowEditing = False
            .Cols(0).Width = 30

            .Cols(1).Caption = "Fustcategorie"
            .Cols(1).Width = 120
            .Cols(1).AllowEditing = False
            .Cols(1).Width = 120


        End With



        Dim flexgridfill(2) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from fustcategorie"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("id"))
                    flexgridfill(1) = CHstr(Reader("naam"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (fustcatgroepen)" + ex.Message)
            MessageBox.Show("Database fout: (fustcatgroepen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub Set_Flexindeling_fustcategorie_vullen2(ByVal newcat As Boolean)

        Dim cn() As String = New String() {"desc"}

        Dim id As Integer = 0
        Dim naam As String = ""
        If newcat = False Then
            If DatabaseFlexGridShow.Cols.Count = 2 Then
                For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                    If DatabaseFlexGridShow.Rows(i).Selected = True Then
                        id = DatabaseFlexGridShow.Item(i, 0)
                        naam = DatabaseFlexGridShow.Item(i, 1)
                    End If
                Next i
            End If
        End If
        If id = 0 Then
            Dim flexgridfill2(2) As String
            flexgridfill2(0) = 0
            flexgridfill2(1) = "Fustcategorie naam?"
            DatabaseFlexGridEdit.Rows.Count = 1
            DatabaseFlexGridEdit.AddItem(flexgridfill2)
            DatabaseFlexGridEdit.Rows(1).AllowEditing = True
        Else
            Dim flexgridfill2(2) As String
            flexgridfill2(0) = id
            flexgridfill2(1) = naam
            DatabaseFlexGridEdit.Rows.Count = 1
            DatabaseFlexGridEdit.AddItem(flexgridfill2)
            DatabaseFlexGridEdit.Rows(1).AllowEditing = True
        End If

        Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)

        With DatabaseFlexGridShow
            .AllowEditing = True
            .SelectionMode = SelectionModeEnum.Cell
            .Clear()
            .Cols.Fixed = 0
            .Rows.Fixed = 1
            .Rows.Count = 1
            .Cols.Count = 3

            .Cols(0).Caption = "SG ID"
            .Cols(0).Width = 120
            .Cols(0).AllowEditing = True
            .Cols(0).Visible = False
            .Cols(0).AllowEditing = False
            .Cols(0).Width = 30

            .Cols(1).Caption = "Soortgroep"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).AllowEditing = False
            .Cols(1).Width = 200

            .Cols(2).Caption = "Fust"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).DataMap = mcd_fust
            .Cols(2).AllowEditing = True
            .Cols(2).Width = 200
        End With


        Dim selected_fustcat As Integer
        selected_fustcat = id

        Dim flexgridfill(3)
        DatabaseFlexGridShow.Rows.Count = 1
        DatabaseFlexGridShow.Cols.Count = 3
        For i = 1 To UBound(soortgroep)
            If soortgroep(i).fusten = True Then
                flexgridfill(0) = soortgroep(i).id
                flexgridfill(1) = soortgroep(i).naam
                flexgridfill(2) = "0"
                DatabaseFlexGridShow.AddItem(flexgridfill)
            End If
        Next
        If selected_fustcat > 0 Then
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim reader As OdbcDataReader
                    Dim Cmd As New OdbcCommand("select * from fustcategorie_ids where fustcategorie_id = ? order by soortgroep_id", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", selected_fustcat)
                    reader = Cmd.ExecuteReader()
                    Do While reader.Read()
                        Dim sgid As Integer = CHint(reader("soortgroep_id"))
                        Dim fustid As Integer = CHint(reader("fust_id"))
                        For Row = 1 To DatabaseFlexGridShow.Rows.Count - 1
                            If DatabaseFlexGridShow.GetData(Row, 0) = sgid Then
                                DatabaseFlexGridShow.SetData(Row, 2, fustid)
                            End If
                        Next Row
                    Loop
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (fustcat)" + ex.Message)
                MessageBox.Show("Database fout: (fustcat)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        End If
    End Sub

    Private Sub Set_Flexindeling_hoescategorie()

        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit
            .Clear()
            .Cols.Count = 2
            .Rows.Count = 1

            .Cols(0).Caption = "id"
            .Cols(0).DataType = System.Type.GetType("System.Int32")
            .Cols(0).Width = 80
            .Cols(0).AllowEditing = False
            .Cols(0).Visible = False

            .Cols(1).Caption = "Hoes categorie naam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200
            .Cols(1).AllowEditing = True

        End With


        With DatabaseFlexGridShow
            .AllowEditing = True
            .SelectionMode = SelectionModeEnum.ListBox
            .Clear()
            .Cols.Fixed = 0
            .Rows.Fixed = 1
            .Rows.Count = 1
            .Cols.Count = 2

            .Cols(0).Caption = "Id"
            .Cols(0).Width = 120
            .Cols(0).AllowEditing = True
            .Cols(0).Visible = False
            .Cols(0).AllowEditing = False
            .Cols(0).Width = 30

            .Cols(1).Caption = "Hoescategorie"
            .Cols(1).Width = 120
            .Cols(1).AllowEditing = False
            .Cols(1).Width = 120


        End With



        Dim flexgridfill(2) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from hoescategorie"
        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("id"))
                    flexgridfill(1) = CHstr(Reader("naam"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (hoescatgroepen)" + ex.Message)
            MessageBox.Show("Database fout: (hoescatgroepen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub Set_Flexindeling_hoescategorie_vullen2(ByVal newcat As Boolean)

        Dim cn() As String = New String() {"desc"}

        Dim id As Integer = 0
        Dim naam As String = ""
        If newcat = False Then
            If DatabaseFlexGridShow.Cols.Count = 2 Then
                For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                    If DatabaseFlexGridShow.Rows(i).Selected = True Then
                        id = DatabaseFlexGridShow.Item(i, 0)
                        naam = DatabaseFlexGridShow.Item(i, 1)
                    End If
                Next i
            End If
        End If
        If id = 0 Then
            Dim flexgridfill2(2) As String
            flexgridfill2(0) = 0
            flexgridfill2(1) = "Hoescategorie naam?"
            DatabaseFlexGridEdit.Rows.Count = 1
            DatabaseFlexGridEdit.AddItem(flexgridfill2)
            DatabaseFlexGridEdit.Rows(1).AllowEditing = True
        Else
            Dim flexgridfill2(2) As String
            flexgridfill2(0) = id
            flexgridfill2(1) = naam
            DatabaseFlexGridEdit.Rows.Count = 1
            DatabaseFlexGridEdit.AddItem(flexgridfill2)
            DatabaseFlexGridEdit.Rows(1).AllowEditing = True
        End If

        Dim mcd_hoes As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)

        With DatabaseFlexGridShow
            .AllowEditing = True
            .SelectionMode = SelectionModeEnum.Cell
            .Clear()
            .Cols.Fixed = 0
            .Rows.Fixed = 1
            .Rows.Count = 1
            .Cols.Count = 3

            .Cols(0).Caption = "SG ID"
            .Cols(0).Width = 120
            .Cols(0).AllowEditing = True
            .Cols(0).Visible = False
            .Cols(0).AllowEditing = False
            .Cols(0).Width = 30

            .Cols(1).Caption = "Soortgroep"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).AllowEditing = False
            .Cols(1).Width = 200

            .Cols(2).Caption = "Hoes"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).DataMap = mcd_hoes
            .Cols(2).AllowEditing = True
            .Cols(2).Width = 200
        End With


        Dim selected_hoescat As Integer
        selected_hoescat = id

        Dim flexgridfill(3)
        DatabaseFlexGridShow.Rows.Count = 1
        DatabaseFlexGridShow.Cols.Count = 3
        For i = 1 To UBound(soortgroep)
            If soortgroep(i).fusten = True Then
                flexgridfill(0) = soortgroep(i).id
                flexgridfill(1) = soortgroep(i).naam
                flexgridfill(2) = "0"
                DatabaseFlexGridShow.AddItem(flexgridfill)
            End If
        Next
        If selected_hoescat > 0 Then
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim reader As OdbcDataReader
                    Dim Cmd As New OdbcCommand("select * from hoescategorie_ids where hoescategorie_id = ? order by soortgroep_id", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", selected_hoescat)
                    reader = Cmd.ExecuteReader()
                    Do While reader.Read()
                        Dim sgid As Integer = CHint(reader("soortgroep_id"))
                        Dim hoesid As Integer = CHint(reader("accessoire_id"))
                        For Row = 1 To DatabaseFlexGridShow.Rows.Count - 1
                            If DatabaseFlexGridShow.GetData(Row, 0) = sgid Then
                                DatabaseFlexGridShow.SetData(Row, 2, hoesid)
                            End If
                        Next Row
                    Loop
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (hoescat)" + ex.Message)
                MessageBox.Show("Database fout: (hoescat)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        End If
    End Sub

    Private Sub Set_Flexindeling_prijslijstJenPimport()

        Dim rs As C1.Win.C1FlexGrid.CellStyle
        DatabaseFlexGridShow.Styles.Clear()
        rs = DatabaseFlexGridShow.Styles.Add("blue")
        rs.BackColor = Color.PowderBlue


        Dim rs2 As C1.Win.C1FlexGrid.CellStyle
        rs2 = DatabaseFlexGridShow.Styles.Add("salmon")
        rs2.BackColor = Color.Salmon



        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit

            .Clear()
            .Cols.Count = 11
            .Rows.Count = 1

            .Cols(0).Caption = "ID"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 40
            .Cols(0).Visible = False

            .Cols(1).Caption = "Kwekerscode"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Omschrijving"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            .Cols(2).AllowEditing = False

            .Cols(3).Caption = "Soort"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 120
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(3).DataMap = mcd_soortmix

            .Cols(4).Caption = "Accessoire 1"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 110
            Dim mcd_acce1 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(4).DataMap = mcd_acce1

            .Cols(5).Caption = "Accessoire 2"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 110
            Dim mcd_acce3 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(5).DataMap = mcd_acce3

            .Cols(6).Caption = "Fust"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 100
            Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_fust, "ID", cn, 0)
            .Cols(6).DataMap = mcd_fust

            .Cols(7).Caption = "Hoes"
            .Cols(7).DataType = System.Type.GetType("System.String")
            .Cols(7).Width = 100
            Dim mcd_acce2 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
            .Cols(7).DataMap = mcd_acce2

            .Cols(8).Caption = "Prijs"
            .Cols(8).DataType = System.Type.GetType("System.Double")
            .Cols(8).Width = 60
            .Cols(8).Format = "N2"

            .Cols(9).Caption = "Korting"
            .Cols(9).DataType = System.Type.GetType("System.Boolean")
            .Cols(9).Width = 50

            .Cols(10).Caption = "Kopersgroep"
            .Cols(10).DataType = System.Type.GetType("System.String")
            .Cols(10).Width = 100
            Dim mcd_kopersgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopersgroepen, "ID", cn, 0)
            .Cols(10).DataMap = mcd_kopersgroepen

        End With
        With DatabaseFlexGridShow
            .AllowEditing = False
            .Clear()
            .Cols.Count = 9
            .Rows.Count = 1

            .Cols(0).Caption = "ID"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 40
            .Cols(0).Visible = False

            .Cols(1).Caption = "Kwekerscode"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Omschrijving"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100

            .Cols(3).Caption = "Artikel Omschrijving"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 220

            .Cols(4).Caption = "Keten"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 110

            .Cols(5).Caption = "Fust"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 100

            .Cols(6).Caption = "Hoes"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 100

            .Cols(7).Caption = "Prijs"
            .Cols(7).DataType = System.Type.GetType("System.Double")
            .Cols(7).Width = 60
            .Cols(7).Format = "N2"

            .Cols(8).Caption = "MP Klantgroep"
            .Cols(8).DataType = System.Type.GetType("System.String")
            .Cols(8).Width = 170

        End With

    End Sub

    Private Sub Set_Flexindeling_prijslijstkortingtabel()
        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit

            .Clear()
            .Cols.Count = 5
            .Rows.Count = 1

            .Cols(0).Caption = "ID"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 40
            .Cols(0).Visible = False

            .Cols(1).Caption = "Kopersgroep"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 160
            Dim mcd_kopersgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopersgroepen, "ID", cn, 0)
            .Cols(1).DataMap = mcd_kopersgroepen

            .Cols(2).Caption = "Korting"
            .Cols(2).DataType = System.Type.GetType("System.Double")
            .Cols(2).Width = 60
            .Cols(2).Format = "N2"

            .Cols(3).Caption = "Volgorde"
            .Cols(3).DataType = System.Type.GetType("System.int32")
            .Cols(3).Width = 60

            .Cols(4).Caption = "Wis"
            .Cols(4).DataType = System.Type.GetType("System.Boolean")
            .Cols(4).Width = 60


        End With
        With DatabaseFlexGridShow
            .AllowEditing = False
            .Clear()
            .Cols.Count = 4
            .Rows.Count = 1

            .Cols(0).Caption = "ID"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 40
            .Cols(0).Visible = False
           
            .Cols(1).Caption = "Kopersgroep"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 160
            Dim mcd_kopersgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopersgroepen, "ID", cn, 0)
            .Cols(1).DataMap = mcd_kopersgroepen

            .Cols(2).Caption = "Korting"
            .Cols(2).DataType = System.Type.GetType("System.Double")
            .Cols(2).Width = 60
            .Cols(2).Format = "N2"

            .Cols(3).Caption = "Volgorde"
            .Cols(3).DataType = System.Type.GetType("System.int32")
            .Cols(3).Width = 60

        End With

    End Sub
    Private Sub loadDB_FlexIndeling_prijslijstkortingtabel()
        Dim flexgridfill(10) As String

        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand("select * from prijslijstkortingen order by volgorde", Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("id"))
                    flexgridfill(1) = CHstr(Reader("kopersgroep"))
                    flexgridfill(2) = CHstr(Reader("korting") / 100)
                    flexgridfill(3) = CHstr(Reader("volgorde"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijslijst kortingtabel)" + ex.Message)
            MessageBox.Show("Database fout: (prijslijst kortingtabel)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Private Sub Set_Flexindeling_prijslijstkoppelingen()
        Dim cn() As String = New String() {"desc"}

        With DatabaseFlexGridEdit

            .Clear()
            .Cols.Count = 4
            .Rows.Count = 1

            .Cols(0).Caption = "ID"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 40
            .Cols(0).Visible = False

            .Cols(1).Caption = "Soortgroep"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 160
            Dim mcd_soortgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortgroepen, "ID", cn, 0)
            .Cols(1).DataMap = mcd_soortgroepen

            .Cols(2).Caption = "Soort/mix prijskoppeling"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 160
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(2).DataMap = mcd_soortmix

            .Cols(3).Caption = "Wis"
            .Cols(3).DataType = System.Type.GetType("System.Boolean")
            .Cols(3).Width = 60


        End With
        With DatabaseFlexGridShow
            .AllowEditing = False
            .Clear()
            .Cols.Count = 3
            .Rows.Count = 1

            .Cols(0).Caption = "ID"
            .Cols(0).DataType = System.Type.GetType("System.int32")
            .Cols(0).Width = 40
            .Cols(0).Visible = False

            .Cols(1).Caption = "Soortgroep"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 160
            Dim mcd_soortgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortgroepen, "ID", cn, 0)
            .Cols(1).DataMap = mcd_soortgroepen

            .Cols(2).Caption = "Soort/mix prijskoppeling"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 160
            Dim mcd_soortmix As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_soortmix, "ID", cn, 0)
            .Cols(2).DataMap = mcd_soortmix

        End With

    End Sub
    Private Sub loadDB_FlexIndeling_prijslijstkoppelingen()

        Dim flexgridfill(4) As String

        Try
            'Open Connection
            DatabaseFlexGridShow.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand("select * from prijslijstkoppelingen", Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("id"))
                    flexgridfill(1) = CHstr(Reader("soortgroep_id"))
                    flexgridfill(2) = CHstr(Reader("soortmix_id"))
                    DatabaseFlexGridShow.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijslijst koppelingtabel)" + ex.Message)
            MessageBox.Show("Database fout: (prijslijst koppelingtabel)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Private Sub DatabaseMenuSDFPL_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles DatabaseMenuSDFPL_but.Click
        Dim openFileDialog1 As New OpenFileDialog()
        openFileDialog1.Filter = "Excel File (*.xlsx)|*.xlsx"
        openFileDialog1.FilterIndex = 1
        openFileDialog1.InitialDirectory = "c:\boek\sdf\"
        If openFileDialog1.ShowDialog() = DialogResult.OK Then
            Try
                Using pck = New ExcelPackage()
                    Using stream = File.OpenRead(openFileDialog1.FileName)
                        pck.Load(stream)
                    End Using
                    Dim sheetnr As Integer = 1
                    Dim ws As ExcelWorksheet = pck.Workbook.Worksheets(sheetnr)
                    CopyWorksheetToFlexgrid(ws)
                End Using
            Catch ex As Exception
                MsgBox("Import failed. Original error: " & ex.Message)
            End Try
        End If
    End Sub
    Private Sub CopyWorksheetToFlexgrid(ByVal ws As ExcelWorksheet)
        Dim totalCols As Integer = ws.Dimension.[End].Column
        Dim totalRows As Integer = ws.Dimension.[End].Row

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'find columns/test sheet

                Dim Col_Omschrijving As Integer = 0
                Dim Col_Prijs As Integer = 0
                Dim Col_ArtikelCode As Integer = 0
                Dim Col_MPKlantgroep As Integer = 0
                Dim Col_Hoes As Integer = 0
                Dim Col_ArtikelOmschrijving As Integer = 0
                Dim Col_Fust As Integer = 0
                Dim Col_Keten As Integer = 0
                Dim Col_Teelt As Integer = 0
                Dim Col_Kleur As Integer = 0

                For colnum = 1 To totalCols
                    Dim colname As String = Trim(ws.Cells(1, colnum).Text)
                    Select Case colname
                        Case "Omschrijving" : Col_Omschrijving = colnum
                        Case "Prijs" : Col_Prijs = colnum
                        Case "Artikelcode" : Col_ArtikelCode = colnum
                        Case "Marktplaats klantgroep" : Col_MPKlantgroep = colnum
                        Case "Hoes" : Col_Hoes = colnum
                        Case "Artikelomschrijving" : Col_ArtikelOmschrijving = colnum
                        Case "Fust" : Col_Fust = colnum
                        Case "Keten" : Col_Keten = colnum
                        Case "Teelt" : Col_Teelt = colnum
                        Case "Kleur" : Col_Kleur = colnum
                    End Select
                Next

                'is dit een code lijst?
                Dim codelijst As Boolean = False
                If Col_ArtikelOmschrijving = 0 And Col_MPKlantgroep = 0 And Col_Omschrijving = 0 Then
                    If Col_ArtikelCode > 0 And Col_Fust > 0 And Col_Keten > 0 And Col_Hoes > 0 And Col_Teelt > 0 And Col_Kleur > 0 Then
                        codelijst = True
                    End If
                End If

                'nee.. dan prijslijst controle
                If codelijst = False Then
                    If Col_ArtikelCode = 0 Or Col_ArtikelOmschrijving = 0 Or Col_Fust = 0 Or Col_Keten = 0 Or Col_Hoes = 0 Or Col_MPKlantgroep = 0 Or Col_Omschrijving = 0 Then
                        MsgBox("Definitie van sheet is foutief, import niet mogelijk")
                        Exit Sub
                    End If
                End If

                If codelijst = False Then

                    DatabaseFlexGridShow.Rows.Count = 1
                    Dim flexgridfill(9) As String
                    Dim idcounter = 1
                    For rowNum As Integer = 2 To totalRows
                        flexgridfill(0) = Tstr(idcounter)
                        flexgridfill(1) = Trim(ws.Cells(rowNum, Col_ArtikelCode).Text)
                        flexgridfill(2) = Trim(ws.Cells(rowNum, Col_Omschrijving).Text)
                        flexgridfill(3) = Trim(ws.Cells(rowNum, Col_ArtikelOmschrijving).Text)
                        flexgridfill(4) = Trim(ws.Cells(rowNum, Col_Keten).Text)
                        flexgridfill(5) = Trim(ws.Cells(rowNum, Col_Fust).Text)
                        flexgridfill(6) = Trim(ws.Cells(rowNum, Col_Hoes).Text)
                        flexgridfill(7) = Trim(ws.Cells(rowNum, Col_Prijs).Text)
                        flexgridfill(8) = Trim(ws.Cells(rowNum, Col_MPKlantgroep).Text)
                        DatabaseFlexGridShow.AddItem(flexgridfill)

                        UpdateApplication()
                        idcounter = idcounter + 1
                    Next

                    ' kleuren bijwerken & prijzen aanpassen als dat nodig is

                    Dim Reader As OdbcDataReader
                    Dim Cmd As New OdbcCommand("SELECT kwekerscode,prijs,omschrijving FROM prijslijst", Conn)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read
                        Dim code As String = CHstr(Reader("kwekerscode"))
                        Dim prijs As Double = CHint(Reader("prijs"))
                        Dim omschrijving As String = CHstr(Reader("omschrijving"))
                        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1

                            If DatabaseFlexGridShow.Item(i, 1) = code And DatabaseFlexGridShow.Item(i, 2) = omschrijving Then
                                Dim lijstprijs As Integer = DatabaseFlexGridShow.Item(i, 7) * 100
                                If lijstprijs = prijs Then
                                    DatabaseFlexGridShow.Rows(i).Style = DatabaseFlexGridShow.Styles("blue")
                                Else
                                    DatabaseFlexGridShow.Rows(i).Style = DatabaseFlexGridShow.Styles("salmon")
                                    'update prijs
                                    Dim Cmd2 As New OdbcCommand("UPDATE prijslijst SET prijs = ? WHERE kwekerscode=? and omschrijving = ?", Conn)
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", lijstprijs)
                                    Cmd2.Parameters.AddWithValue("", code)
                                    Cmd2.Parameters.AddWithValue("", omschrijving)
                                    Cmd2.ExecuteNonQuery()
                                End If
                            End If

                        Next
                        UpdateApplication()
                    Loop
                Else

                    'alleen lijst laten zien
                    DatabaseFlexGridShow.Rows.Count = 1
                    Dim flexgridfill(9) As String
                    Dim idcounter = 1
                    For rowNum As Integer = 2 To totalRows
                        flexgridfill(0) = Tstr(idcounter)
                        flexgridfill(1) = Trim(ws.Cells(rowNum, Col_ArtikelCode).Text)
                        flexgridfill(2) = Trim("Code-lijst")
                        flexgridfill(3) = Trim(ws.Cells(rowNum, Col_Teelt).Text + " " + ws.Cells(rowNum, Col_Kleur).Text)
                        flexgridfill(4) = Trim(ws.Cells(rowNum, Col_Keten).Text)
                        flexgridfill(5) = Trim(ws.Cells(rowNum, Col_Fust).Text)
                        flexgridfill(6) = Trim(ws.Cells(rowNum, Col_Hoes).Text)
                        flexgridfill(7) = "0.00"
                        flexgridfill(8) = Trim(ws.Cells(rowNum, Col_Keten).Text)
                        DatabaseFlexGridShow.AddItem(flexgridfill)

                        UpdateApplication()
                        idcounter = idcounter + 1
                    Next


                    ' kleuren bijwerken als de line al bestaat

                    Dim Reader As OdbcDataReader
                    Dim Cmd As New OdbcCommand("SELECT kwekerscode,omschrijving FROM prijslijst", Conn)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read
                        Dim code As String = CHstr(Reader("kwekerscode"))
                        Dim omschrijving As String = CHstr(Reader("omschrijving"))
                        For i = 1 To DatabaseFlexGridShow.Rows.Count - 1
                            If DatabaseFlexGridShow.Item(i, 1) = code And DatabaseFlexGridShow.Item(i, 2) = omschrijving Then
                                DatabaseFlexGridShow.Rows(i).Style = DatabaseFlexGridShow.Styles("blue")
                            End If
                        Next
                        UpdateApplication()
                    Loop



                End If



            End Using

        Catch ex As Exception
            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
        End Try

    End Sub

    Private Sub UpdateApplication()
        Static counter
        counter = counter + 1
        If counter >= 10 Then
            counter = 1
            Application.DoEvents()
        End If
    End Sub


#End Region

#Region "Orders"

    Private Sub Order_idtxt_lbl_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_idtxt_lbl.Click
        'debug and search purposes
        Order_invoer_FlexGrid.Cols(0).Visible = True
        Order_invoer_FlexGrid.Cols(0).Width = 30
        Order_invoer_FlexGrid.Cols(0).AllowEditing = False
    End Sub
    Private Sub Order_groep1_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_groep1_but.Click
        If Order_ean_lbl.Text <> "0000000000000" Then
            Load_Favorites(1, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
            Order_invoer_FlexGrid.Focus()
        End If
    End Sub
    Private Sub Order_groep2_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_groep2_but.Click
        If Order_ean_lbl.Text <> "0000000000000" Then
            Load_Favorites(2, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
            Order_invoer_FlexGrid.Focus()
        End If
    End Sub
    Private Sub Order_groep3_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_groep3_but.Click
        If Order_ean_lbl.Text <> "0000000000000" Then
            Load_Favorites(3, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
            Order_invoer_FlexGrid.Focus()
        End If
    End Sub
    Private Sub Order_groep4_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_groep4_but.Click
        If Order_ean_lbl.Text <> "0000000000000" Then
            Load_Favorites(4, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
            Order_invoer_FlexGrid.Focus()
        End If
    End Sub
    Private Sub Order_groep5_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_groep5_but.Click
        If Order_ean_lbl.Text <> "0000000000000" Then
            Load_Favorites(5, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
            Order_invoer_FlexGrid.Focus()
        End If
    End Sub

    Private Sub Load_Favorites(ByVal favnummer As Integer, ByVal fustcatid As Integer, ByVal hoescatid As Integer, ByVal koper_ean As String)

        order_date = OrderDateTimePicker.Value
        'condense grid
        Dim irow As Integer = 1
        With Order_invoer_FlexGrid


            Dim flexrows As Integer = .Rows.Count - 1
            Do While irow < flexrows + 1
                If .Item(irow, aantalcol) = 0 Then  ' aantal > 0 ?
                    .Rows.Remove(irow)
                    flexrows = flexrows - 1
                Else
                    .Rows(irow).Style = .Styles("RowColor")
                    irow = irow + 1
                End If
            Loop
        End With
        '
        'fill grid 
        Application.DoEvents()
        '' timeperparse = Stopwatch.StartNew()
        'Vervoer_Listbox.Items.Clear()
        ' TimePassed("Start")

        Dim Reader As OdbcDataReader
        Dim gridfill1(60) As String

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim soortid As Integer
                Dim prijs As Double
                '                Dim CmdString As String = "select * from favorieten_lijst where nummer =" + Str(favnummer)
                Dim CmdString As String = "select * from favorieten_lijst as fav LEFT JOIN soortvolgorde as sv ON fav.soortid=sv.soortid WHERE nummer =" + Str(favnummer) + " ORDER BY sv.volgorde"

                Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                Reader = Cmd2.ExecuteReader()
                Dim prijskleur As Integer
                Do While Reader.Read()
                    soortid = CHint(Reader("soortid"))
                    Dim newfustid As Integer = 0
                    'TimePassed("Start loop")

                    'bij mixen check of het koper/kopersgroep specifiek is
                    If soortid > 10000 Then
                        'koper specifiek
                        Dim mix_id As Integer = soortid - 10000
                        If Val(mixen(GID(mixen, mix_id)).koperean) > 0 Then
                            If Not mixen(GID(mixen, mix_id)).koperean = koper_ean Then
                                GoTo next_fav
                            End If
                        End If
                        'kopersgroep specifiek is
                        Dim kopergroep_id As Integer = mixen(GID(mixen, mix_id)).kopergroep
                        If kopergroep_id > 0 Then
                            Dim Reader2 As OdbcDataReader
                            Dim CmdString2 As String
                            CmdString2 = "SELECT * FROM kopersgroepen2_eans where id=" + Str(kopergroep_id) + " AND ean ='" + koper_ean + "'"
                            'Execute Query
                            Dim Cmd As New OdbcCommand(CmdString2, Conn)
                            Reader2 = Cmd.ExecuteReader()
                            If Reader2.HasRows Then
                                'koper in kopergroep, doorgaan met verwerking
                            Else
                                GoTo next_fav
                            End If
                        End If
                        'mix heeft vast fust
                        newfustid = mixen(GID(mixen, mix_id)).fust
                    Else
                        'bij gewoone soorten fust opzoeken uit fustcat
                        newfustid = FindFustFromFustCat(fustcatid, soortid)
                    End If


                    'TimePassed("Koperspecifiek")

                    'zoek standaard fust
                    '
                    'Dim newfustid As Integer = ZoekFust(fustid, soortid)  ' zoek of deze soort/mix standaart fust heeft of dat het normal fustid gebruikt kan worden
                    'Dim newfustid As Integer = FindFustFromFustCat(fustcatid, soortid)
                    Dim newhoesid As Integer = FindHoesFromHoesCat(hoescatid, soortid)
                    ' fill list
                    gridfill1(0) = 0               'id
                    gridfill1(pluscol) = "+"              'plus
                    gridfill1(aantalcol) = ""               '
                    gridfill1(xcol) = "x " + Tstr(fust(GID(fust, newfustid)).aantal_per_fust)
                    'gridfill1(3) = "x" + Str(fust(newfustid).aantal_per_fust)

                    'TimePassed("Zoek Fust")

                    gridfill1(soortcol) = Tstr(soortid)
                    prijskleur = 0
                    Dim actie_type As Integer = 0
                    prijs = ZoekPrijs(soortid, koper_ean, order_date, prijskleur, actie_type)
                    If prijs = 0 Then prijskleur = 2
                    'TimePassed("Zoek prijs")

                    gridfill1(prijscol) = prijs
                    gridfill1(fustcol) = Tstr(newfustid)
                    gridfill1(hoescol) = Tstr(newhoesid)


                    If Val(koper_ean) < 2000 Then 'klok
                        Dim rijpheid As Integer = ZoekSoortCode("klokrijpheid", soortid)
                        Dim hoogte As Integer = Tstr(ZoekSoortCode("klokhoogte", soortid))
                        Dim diameter As Integer = Tstr(ZoekSoortCode("klokdiameter", soortid))

                        gridfill1(rijpheidcol) = Tstr(rijpheid)
                        gridfill1(hoogtecol) = Tstr(hoogte)
                        gridfill1(diametercol) = Tstr(diameter)
                        gridfill1(fotocol) = FindFotoMatch(soortid, newfustid, rijpheid, hoogte, diameter)

                    Else                          'bb 
                        gridfill1(rijpheidcol) = Tstr(ZoekSoortCode("bbrijpheid", soortid))
                        gridfill1(hoogtecol) = Tstr(ZoekSoortCode("bbhoogte", soortid))
                        gridfill1(diametercol) = Tstr(ZoekSoortCode("bbdiameter", soortid))
                        gridfill1(fotocol) = ""
                    End If



                    Dim accessoire_id As Integer = 0

                    If jenptenhave = False Then
                        If IsDecorum(koper_ean) > 0 Then
                            'cyclamen groep -> label , anders potcover
                            Dim cyclaamfound As Boolean = False
                            For i = 0 To UBound(soortgroepids)
                                If soortgroepids(i).id = 2 And soortgroepids(i).soortmixid = soortid Then
                                    cyclaamfound = True
                                    Exit For
                                End If
                            Next
                            If cyclaamfound = True Then
                                accessoire_id = 1
                            Else
                                accessoire_id = 2

                                If koper_ean = "8713782686677" Then 'metz
                                    ' accessoire_id = 46
                                ElseIf koper_ean = "8718288022011" Then 'xl flor (metz)
                                    ' accessoire_id = 46
                                ElseIf koper_ean = "8714231200215" Then 'donck
                                    accessoire_id = 46
                                End If


                            End If

                        End If
                    End If

                    If soortid > 10000 Then
                        'mix specifieke accessoire?
                        Dim mix_id As Integer = soortid - 10000
                        If mixen(GID(mixen, mix_id)).accessoire > 0 Then
                            accessoire_id = mixen(GID(mixen, mix_id)).accessoire
                        End If
                    End If

                    gridfill1(acce1col) = Tstr(accessoire_id)
                    gridfill1(acce2col) = Tstr(0)
                    gridfill1(kopercodecol) = ""
                    gridfill1(opmerkingcol) = ""
                    gridfill1(labelcol) = ""   'labelcode

                    Dim wpsfilternaam As String = ""
                    Dim wpsfilterid As Integer = 0
                    Dim wpsfilterid2 As Integer = 0
                    GetWPSFilterNr(koper_ean, soortid, accessoire_id, wpsfilterid, wpsfilterid2)
                    For j = 0 To UBound(wpsfilter)
                        If wpsfilterid = wpsfilter(j).filternummer Then
                            wpsfilternaam = wpsfilter(j).filternaam
                            Exit For
                        End If
                    Next j

                    'TimePassed("GetFilternr")

                    gridfill1(wpsfilter1col) = wpsfilternaam
                    gridfill1(vestigingcol) = Tstr(ZoekSoortCode("vestiging", soortid))
                    gridfill1(keurcodecol) = Tstr(0)
                    gridfill1(potmaatcol) = Tstr(ZoekSoortCode("potmaat", soortid) / 10)
                    gridfill1(transporthoogtecol) = Tstr(ZoekSoortCode("transporthoogte", soortid))
                    gridfill1(schermencol) = 5
                    gridfill1(GPcol) = Tstr(1)
                    gridfill1(acce4col) = Tstr(0)
                    gridfill1(acce5col) = Tstr(0)
                    gridfill1(florecomnrcol) = ""
                    gridfill1(actiecol) = Tstr(actie_type)
                    If wpsfilterid = 999999 Then
                        gridfill1(wpsfilter2col) = 999999
                    Else
                        gridfill1(wpsfilter2col) = 0
                    End If
                    gridfill1(wpsfilter3col) = 0
                    gridfill1(oldheadercol) = 0

                    If soortid > 10000 Then
                        'mix specifieke accessoire?
                        Dim mix_id As Integer = soortid - 10000
                        If mixen(GID(mixen, mix_id)).accessoire > 0 Then
                            accessoire_id = mixen(GID(mixen, mix_id)).accessoire
                            gridfill1(acce1col) = Tstr(accessoire_id)
                            Dim aID As Integer = GID(accessoire, accessoire_id)

                            Dim huidige_prijs As Double = prijs
                            Dim nieuwe_prijs As Double = FindAccessoirePrijs(koper_ean, huidige_prijs, accessoire_id, soortid, order_date, actie_type)
                            If nieuwe_prijs <> huidige_prijs Then
                                gridfill1(prijscol) = nieuwe_prijs
                            End If

                            If accessoire(aID).fust > 0 Then
                                gridfill1(fustcol) = Tstr(fust(GID(fust, accessoire(aID).fust)).id)
                                Dim apf As Integer
                                apf = fust(GID(fust, accessoire(aID).fust)).aantal_per_fust
                                gridfill1(xcol) = "x " + Trim(Str(apf))
                            End If
                            If accessoire(aID).potmaat > 0 Then
                                gridfill1(potmaatcol) = Tstr(accessoire(aID).potmaat / 10)
                            End If

                        End If
                    End If

                    ' TimePassed("Mix accessoire")

                    Order_invoer_FlexGrid.AddItem(gridfill1)

                    If prijskleur = 1 Then
                        Order_invoer_FlexGrid.SetCellStyle(irow, prijscol, "ErrorColor")
                    End If
                    If prijskleur = 2 Then
                        Order_invoer_FlexGrid.SetCellStyle(irow, prijscol, "WarningColor")
                    End If

                    irow = irow + 1
next_fav:
                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (laad favoriet)" + ex.Message)
            MessageBox.Show("Database fout: (laad favoriet)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        SetOrderGrid()


        'TimePassed("End")

        'timeperparse.Stop()
    End Sub
    Private Function FindFustFromFustCat(ByVal fustcatid As Integer, ByVal soortid As Integer) As Integer
        Dim fustid As Integer = 0
        'soortgroep(i).id = CHint(Reader("id"))
        'soortgroep(i).naam = CHstr(Reader("groepnaam"))
        'soortgroep(i).fusten = CHbool(Reader("fusten"))
        'soortgroep(i).hoezen = CHbool(Reader("hoezen"))
        'soortgroep(i).prijzen = CHbool(Reader("prijzen"))

        'soortgroepids(i).id = CHint(Reader("id"))
        'soortgroepids(i).soortmixid = CHint(Reader("soortmixid"))
        For k = 1 To UBound(fustcategorieids)
            If fustcategorieids(k).fustcatid = fustcatid Then
                Dim soortgroep_search_id As Integer = fustcategorieids(k).soortgroepid
                fustid = fustcategorieids(k).fustid
                For i = 1 To UBound(soortgroep)
                    If soortgroep(i).fusten = True And soortgroep_search_id = soortgroep(i).id Then
                        Dim id As Integer = soortgroep(i).id
                        For j = 1 To UBound(soortgroepids)
                            If soortgroepids(j).id = id And soortgroepids(j).soortmixid = soortid Then

                                Return fustid
                            End If
                        Next
                    End If
                Next

            End If
        Next

        Return 1

    End Function
    Private Function FindHoesFromHoesCat(ByVal hoescatid As Integer, ByVal soortid As Integer) As Integer
        Dim hoesid As Integer = 0

        For k = 1 To UBound(hoescategorieids)
            If hoescategorieids(k).hoescatid = hoescatid Then
                Dim soortgroep_search_id As Integer = hoescategorieids(k).soortgroepid
                hoesid = hoescategorieids(k).accessoireid
                For i = 1 To UBound(soortgroep)
                    If soortgroep(i).hoezen = True And soortgroep_search_id = soortgroep(i).id Then
                        Dim id As Integer = soortgroep(i).id
                        For j = 1 To UBound(soortgroepids)
                            If soortgroepids(j).id = id And soortgroepids(j).soortmixid = soortid Then

                                Return hoesid
                            End If
                        Next
                    End If
                Next

            End If
        Next
        If jenptenhave = True Then
            hoesid = 1
        Else
            hoesid = 0
        End If
        Return hoesid

    End Function

    Private Sub SetOrderGrid()



        If jenptenhave = True Then
            Order_invoer_FlexGrid.Cols(hoescol).Visible = True
        Else
            Order_invoer_FlexGrid.Cols(hoescol).Visible = False
        End If

        Dim koper_ean As String = DirectCast(DirectCast(Order_koper_combo.SelectedItem, System.Object), System.Data.DataRowView).Item(0)
        If Val(koper_ean) >= 1000 And Val(koper_ean) < 2000 Then
            'KLOK
            Order_invoer_FlexGrid.Cols(rijpheidcol).Visible = True
            Order_invoer_FlexGrid.Cols(diametercol).Visible = True
            Order_invoer_FlexGrid.Cols(hoogtecol).Visible = True
            If jenptenhave = True Then Order_invoer_FlexGrid.Cols(schermencol).Visible = True
            Order_invoer_FlexGrid.Cols(keurcodecol).Visible = True
        Else
            Order_invoer_FlexGrid.Cols(rijpheidcol).Visible = False
            Order_invoer_FlexGrid.Cols(diametercol).Visible = False
            Order_invoer_FlexGrid.Cols(hoogtecol).Visible = False
            Order_invoer_FlexGrid.Cols(schermencol).Visible = False
            Order_invoer_FlexGrid.Cols(keurcodecol).Visible = False
        End If
        Order_invoer_FlexGrid.Cols(acce1col).Visible = True
        Order_invoer_FlexGrid.Cols(acce2col).Visible = True
        Order_invoer_FlexGrid.Cols(acce4col).Visible = False
        Order_invoer_FlexGrid.Cols(acce5col).Visible = False
        Order_invoer_FlexGrid.Cols(acce6col).Visible = False
        Order_invoer_FlexGrid.Cols(acce7col).Visible = False
        Order_invoer_FlexGrid.Cols(acce8col).Visible = False
        For i = 1 To Order_invoer_FlexGrid.Rows.Count - 1
            If Order_invoer_FlexGrid.Item(i, acce4col) > 0 Then Order_invoer_FlexGrid.Cols(acce4col).Visible = True
            If Order_invoer_FlexGrid.Item(i, acce5col) > 0 Then Order_invoer_FlexGrid.Cols(acce5col).Visible = True
            If Order_invoer_FlexGrid.Item(i, acce6col) > 0 Then Order_invoer_FlexGrid.Cols(acce6col).Visible = True
            If Order_invoer_FlexGrid.Item(i, acce7col) > 0 Then Order_invoer_FlexGrid.Cols(acce7col).Visible = True
            If Order_invoer_FlexGrid.Item(i, acce8col) > 0 Then Order_invoer_FlexGrid.Cols(acce8col).Visible = True
        Next

    End Sub
    Private Sub Load_AccessoireList(ByVal soortid As Integer, ByVal fustid As Integer, ByVal koper_ean As String)

        If soortid >= 10000 Then  'mixen geen lijst
            Exit Sub
        End If

        'condense grid
        Dim irow As Integer = 1
        With Order_invoer_FlexGrid


            Dim flexrows As Integer = .Rows.Count - 1
            Do While irow < flexrows + 1
                If .Item(irow, aantalcol) = 0 Then  ' aantal > 0 ?
                    .Rows.Remove(irow)
                    flexrows = flexrows - 1
                Else
                    .Rows(irow).Style = .Styles("RowColor")
                    irow = irow + 1
                End If
            Loop
        End With
        '
        'fill grid 

        Dim Reader As OdbcDataReader
        Dim gridfill1(60) As String

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim prijs As Double
                '                Dim CmdString As String = "select * from favorieten_lijst where nummer =" + Str(favnummer)
                '   Dim CmdString As String = "select * from favorieten_lijst as fav LEFT JOIN soortvolgorde as sv ON fav.soortid=sv.soortid WHERE nummer =" + Str(favnummer) + " ORDER BY sv.volgorde"
                Dim cmdstring As String = "select * from accessoire"
                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()
                Dim prijskleur As Integer
                Do While Reader.Read()
                    Dim accessoireID As Integer = CHint(Reader("id"))
                    Dim actie_type As Integer = 0
                    Dim huidige_prijs As Double = ZoekPrijs(soortid, koper_ean, order_date, prijskleur, actie_type)
                    Dim newfustid As Integer = CHint(Reader("fust"))
                    prijs = FindAccessoirePrijs(koper_ean, huidige_prijs, accessoireID, soortid, order_date, actie_type)

                    If prijs > huidige_prijs And newfustid > 0 Then


                        ' fill list
                        gridfill1(0) = 0               'id
                        gridfill1(pluscol) = "+"              'plus
                        gridfill1(aantalcol) = ""               '
                        gridfill1(xcol) = "x" + Str(fust(GID(fust, newfustid)).aantal_per_fust)
                        gridfill1(soortcol) = Tstr(soortid)
                        prijskleur = 0
                        gridfill1(prijscol) = prijs
                        gridfill1(fustcol) = Tstr(newfustid)
                        gridfill1(hoescol) = Tstr(0)
                        If Val(koper_ean) < 2000 Then 'klok 
                            gridfill1(rijpheidcol) = Tstr(ZoekSoortCode("klokrijpheid", soortid))
                            gridfill1(hoogtecol) = Tstr(ZoekSoortCode("klokhoogte", soortid))
                            gridfill1(diametercol) = Tstr(ZoekSoortCode("klokdiameter", soortid))
                        Else                          'bb 
                            gridfill1(rijpheidcol) = Tstr(ZoekSoortCode("bbrijpheid", soortid))
                            gridfill1(hoogtecol) = Tstr(ZoekSoortCode("bbhoogte", soortid))
                            gridfill1(diametercol) = Tstr(ZoekSoortCode("bbdiameter", soortid))
                        End If

                        gridfill1(acce1col) = Tstr(accessoireID)

                        gridfill1(acce2col) = Tstr(0)
                        gridfill1(kopercodecol) = ""
                        gridfill1(opmerkingcol) = ""

                        gridfill1(labelcol) = 0 'labelcode

                        Dim wpsfilternaam As String = ""
                        Dim wpsfilterid As Integer = 0
                        Dim wpsfilterid2 As Integer = 0
                        GetWPSFilterNr(koper_ean, soortid, accessoireID, wpsfilterid, wpsfilterid2)

                        For j = 0 To UBound(wpsfilter)
                            If wpsfilterid = wpsfilter(j).filternummer Then
                                wpsfilternaam = wpsfilter(j).filternaam
                                Exit For
                            End If
                        Next j

                        gridfill1(wpsfilter1col) = wpsfilternaam
                        gridfill1(vestigingcol) = Tstr(ZoekSoortCode("vestiging", soortid))
                        gridfill1(keurcodecol) = Tstr(0)
                        Dim potmaat As Integer = CHint(Reader("potmaat"))
                        If potmaat > 0 Then
                            gridfill1(potmaatcol) = Tstr(potmaat / 10)
                        Else
                            gridfill1(potmaatcol) = Tstr(ZoekSoortCode("potmaat", soortid) / 10)
                        End If
                        gridfill1(transporthoogtecol) = Tstr(ZoekSoortCode("transporthoogte", soortid))
                        gridfill1(GPcol) = Tstr(1)
                        gridfill1(acce4col) = Tstr(0)
                        gridfill1(acce4col) = Tstr(0)
                        gridfill1(florecomnrcol) = ""
                        gridfill1(actiecol) = Tstr(actie_type)
                        gridfill1(wpsfilter2col) = wpsfilterid
                        gridfill1(wpsfilter3col) = wpsfilterid2
                        gridfill1(oldheadercol) = 0
                        Order_invoer_FlexGrid.AddItem(gridfill1)
                        If prijskleur = 1 Then
                            Order_invoer_FlexGrid.SetCellStyle(irow, prijscol, "ErrorColor")
                        End If
                        If prijskleur = 2 Then
                            Order_invoer_FlexGrid.SetCellStyle(irow, prijscol, "WarningColor")
                        End If
                        irow = irow + 1
                    End If
                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (laad accessoire)" + ex.Message)
            MessageBox.Show("Database fout: (laad accessoire)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Public Sub Load_CodeLine(ByVal interne_code As String, ByVal accessoire1_code As String, ByVal accessoire2_code As String, ByVal aantal As Integer)


        'soortid opzoeken 
        Dim koper_ean = Order_ean_lbl.Text

        Dim soortid As Integer = -1

        If interne_code >= 100 Then  'mixen
            For i = 0 To UBound(mixen) - 1
                If interne_code = mixen(i).interne_code Then
                    soortid = 10000 + mixen(i).id
                    Exit For
                End If
            Next
        Else

            For i = 0 To UBound(soorten) - 1
                If interne_code = soorten(i).interne_code Then
                    soortid = soorten(i).id
                    Exit For
                End If
            Next
        End If

        If soortid = -1 Then Exit Sub

        'accessoire1 id opzoeken
        Dim acce1_id As Integer = -1
        For i = 0 To UBound(accessoire)
            If accessoire1_code = accessoire(i).code Then
                acce1_id = accessoire(i).id
                Exit For
            End If
        Next
        Dim acce2_id As Integer = -1
        For i = 0 To UBound(accessoire)
            If accessoire2_code = accessoire(i).code Then
                acce2_id = accessoire(i).id
                Exit For
            End If
        Next

        If jenptenhave = False And IsDecorum(koper_ean) > 0 And acce1_id = 0 Then
            acce1_id = 2
        End If

        'condense grid
        Dim irow As Integer = 1
        With Order_invoer_FlexGrid


            Dim flexrows As Integer = .Rows.Count - 1
            Do While irow < flexrows + 1
                If .Item(irow, aantal) = 0 Then  ' aantal > 0 ?
                    .Rows.Remove(irow)
                    flexrows = flexrows - 1
                Else
                    .Rows(irow).Style = .Styles("RowColor")
                    irow = irow + 1
                End If
            Loop
        End With
        '
        'fill grid 

        Dim gridfill1(60) As String

        'fust 
        'Dim newfustid = Order_fust_combo.SelectedValue
        Dim newfustid = 1
        If soortid > 10000 Then
            'mix heeft vast fust
            newfustid = mixen(GID(mixen, soortid - 10000)).fust
        Else
            'bij gewoone soorten fust opzoeken uit fustcat
            newfustid = FindFustFromFustCat(Order_fustcat_cmb.SelectedValue, soortid)
        End If

        Dim accessoirefust As Integer = accessoire(GID(accessoire, acce1_id)).fust
        If accessoirefust > 0 Then
            newfustid = accessoirefust
        End If

        Dim prijskleur As Integer
        Dim actie_type As Integer = 0
        Dim prijs As Double = ZoekPrijs(soortid, koper_ean, order_date, prijskleur, actie_type)
        Dim accessoire_prijs As Double = FindAccessoirePrijs(koper_ean, prijs, acce1_id, soortid, order_date, actie_type)
        If accessoire_prijs > prijs Then
            prijs = accessoire_prijs
        End If


        ' fill list
        gridfill1(0) = 0               'id
        gridfill1(pluscol) = "+"              'plus
        gridfill1(aantalcol) = Tstr(aantal)              '
        gridfill1(xcol) = "x" + Tstr(fust(GID(fust, newfustid)).aantal_per_fust)
        gridfill1(soortcol) = Tstr(soortid)
        prijskleur = 0
        gridfill1(prijscol) = prijs
        gridfill1(fustcol) = Tstr(newfustid)
        gridfill1(hoescol) = Tstr(0)
        If Val(koper_ean) < 2000 Then 'klok 
            gridfill1(rijpheidcol) = Tstr(ZoekSoortCode("klokrijpheid", soortid))
            gridfill1(hoogtecol) = Tstr(ZoekSoortCode("klokhoogte", soortid))
            gridfill1(diametercol) = Tstr(ZoekSoortCode("klokdiameter", soortid))
        Else                          'bb 
            gridfill1(rijpheidcol) = Tstr(ZoekSoortCode("bbrijpheid", soortid))
            gridfill1(hoogtecol) = Tstr(ZoekSoortCode("bbhoogte", soortid))
            gridfill1(diametercol) = Tstr(ZoekSoortCode("bbdiameter", soortid))
        End If

        gridfill1(acce1col) = Tstr(acce1_id)
        gridfill1(acce2col) = Tstr(acce2_id)
        gridfill1(kopercodecol) = ""
        gridfill1(opmerkingcol) = ""

        gridfill1(labelcol) = 0

        Dim wpsfilternaam As String = ""
        Dim wpsfilterid As Integer = 0
        Dim wpsfilterid2 As Integer = 0
        GetWPSFilterNr(koper_ean, soortid, acce1_id, wpsfilterid, wpsfilterid2)

        For j = 0 To UBound(wpsfilter)
            If wpsfilterid = wpsfilter(j).filternummer Then
                wpsfilternaam = wpsfilter(j).filternaam
                Exit For
            End If
        Next j

        gridfill1(wpsfilter1col) = wpsfilternaam
        gridfill1(vestigingcol) = Tstr(ZoekSoortCode("vestiging", soortid))
        gridfill1(keurcodecol) = Tstr(0)
        Dim potmaat As Integer = accessoire(GID(accessoire, acce1_id)).potmaat
        If potmaat > 0 Then
            gridfill1(potmaatcol) = potmaat / 10
        Else
            gridfill1(potmaatcol) = Tstr(ZoekSoortCode("potmaat", soortid) / 10)
        End If
        gridfill1(transporthoogtecol) = Tstr(ZoekSoortCode("transporthoogte", soortid))
        gridfill1(GPcol) = Tstr(1)  'GP
        gridfill1(acce4col) = Tstr(0)
        gridfill1(acce5col) = Tstr(0)
        gridfill1(florecomnrcol) = ""
        gridfill1(actiecol) = Tstr(actie_type)
        gridfill1(wpsfilter2col) = wpsfilterid
        gridfill1(wpsfilter3col) = wpsfilterid2
        gridfill1(oldheadercol) = 0
        Order_invoer_FlexGrid.AddItem(gridfill1)
        If prijskleur = 1 Then
            Order_invoer_FlexGrid.SetCellStyle(irow, prijscol, "ErrorColor")
        End If
        If prijskleur = 2 Then
            Order_invoer_FlexGrid.SetCellStyle(irow, prijscol, "WarningColor")
        End If




    End Sub
    Public Sub Load_CodeLine2(ByVal kwekerscode As String, ByVal aantal As Integer)


        'soortid opzoeken 
        Dim koper_ean As String = Order_ean_lbl.Text
        Dim acce1_id As Integer = 0
        Dim acce2_id As Integer = 0
        Dim hoes_id As Integer = 0
        Dim soortid As Integer = -1
        Dim newfustid As Integer = 1

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("SELECT * FROM prijslijst WHERE kwekerscode = ?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", kwekerscode)
                Dim reader As OdbcDataReader
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    acce1_id = CHint(reader("accessoire1"))
                    acce2_id = CHint(reader("accessoire2"))
                    hoes_id = CHint(reader("hoes"))
                    soortid = CHint(reader("soort"))
                    newfustid = CHint(reader("fust"))
                Else
                    Exit Sub
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kwekerscode invoer)" + ex.Message)
            MessageBox.Show("Database fout: (kwekerscode invoer)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        'condense grid
        Dim irow As Integer = 1
        With Order_invoer_FlexGrid

            Dim flexrows As Integer = .Rows.Count - 1
            Do While irow < flexrows + 1
                If .Item(irow, 2) = 0 Then  ' aantal > 0 ?
                    .Rows.Remove(irow)
                    flexrows = flexrows - 1
                Else
                    .Rows(irow).Style = .Styles("RowColor")
                    irow = irow + 1
                End If
            Loop
        End With
        '
        'fill grid 

        Dim gridfill1(60) As String

        Dim prijskleur As Integer
        Dim actie_type As Integer = 0

        Dim prijs As Double = ZoekPrijs(soortid, koper_ean, order_date, prijskleur, actie_type)
        Dim accessoire_prijs As Double = FindAccessoirePrijs(koper_ean, prijs, acce1_id, soortid, order_date, actie_type)
        If accessoire_prijs > prijs Then
            prijs = accessoire_prijs
        End If

        ' fill list

        ' fill list
        gridfill1(0) = 0               'id
        gridfill1(pluscol) = "+"              'plus
        gridfill1(aantalcol) = Tstr(aantal)              '
        gridfill1(xcol) = "x" + Tstr(fust(GID(fust, newfustid)).aantal_per_fust)
        gridfill1(soortcol) = Tstr(soortid)
        prijskleur = 0
        gridfill1(prijscol) = prijs
        gridfill1(fustcol) = Tstr(newfustid)
        gridfill1(hoescol) = Tstr(0)
        If Val(koper_ean) < 2000 Then 'klok
            Dim rijpheid As Integer = ZoekSoortCode("klokrijpheid", soortid)
            Dim hoogte As Integer = Tstr(ZoekSoortCode("klokhoogte", soortid))
            Dim diameter As Integer = Tstr(ZoekSoortCode("klokdiameter", soortid))

            gridfill1(rijpheidcol) = Tstr(rijpheid)
            gridfill1(hoogtecol) = Tstr(hoogte)
            gridfill1(diametercol) = Tstr(diameter)
            gridfill1(fotocol) = FindFotoMatch(newfustid, soortid, rijpheid, hoogte, diameter)

        Else                          'bb 
            gridfill1(rijpheidcol) = Tstr(ZoekSoortCode("bbrijpheid", soortid))
            gridfill1(hoogtecol) = Tstr(ZoekSoortCode("bbhoogte", soortid))
            gridfill1(diametercol) = Tstr(ZoekSoortCode("bbdiameter", soortid))
            gridfill1(fotocol) = ""
        End If

        gridfill1(acce1col) = Tstr(acce1_id)
        gridfill1(acce2col) = Tstr(acce2_id)
        gridfill1(kopercodecol) = ""
        gridfill1(opmerkingcol) = ""

        gridfill1(labelcol) = 0

        Dim wpsfilternaam As String = ""
        Dim wpsfilterid As Integer = 0
        Dim wpsfilterid2 As Integer = 0
        GetWPSFilterNr(koper_ean, soortid, acce1_id, wpsfilterid, wpsfilterid2)

        For j = 0 To UBound(wpsfilter)
            If wpsfilterid = wpsfilter(j).filternummer Then
                wpsfilternaam = wpsfilter(j).filternaam
                Exit For
            End If
        Next j

        gridfill1(wpsfilter1col) = wpsfilternaam
        gridfill1(vestigingcol) = Tstr(ZoekSoortCode("vestiging", soortid))
        gridfill1(keurcodecol) = Tstr(0)
        Dim potmaat As Integer = accessoire(GID(accessoire, acce1_id)).potmaat
        If potmaat > 0 Then
            gridfill1(potmaatcol) = potmaat / 10
        Else
            gridfill1(potmaatcol) = Tstr(ZoekSoortCode("potmaat", soortid) / 10)
        End If
        gridfill1(transporthoogtecol) = Tstr(ZoekSoortCode("transporthoogte", soortid))
        gridfill1(GPcol) = Tstr(1)  'GP
        gridfill1(acce4col) = Tstr(0)
        gridfill1(acce5col) = Tstr(0)
        gridfill1(florecomnrcol) = ""
        gridfill1(actiecol) = Tstr(actie_type)
        gridfill1(wpsfilter2col) = wpsfilterid
        gridfill1(wpsfilter3col) = wpsfilterid2
        gridfill1(oldheadercol) = 0
        Order_invoer_FlexGrid.AddItem(gridfill1)
        If prijskleur = 1 Then
            Order_invoer_FlexGrid.SetCellStyle(irow, prijscol, "ErrorColor")
        End If
        If prijskleur = 2 Then
            Order_invoer_FlexGrid.SetCellStyle(irow, prijscol, "WarningColor")
        End If

    End Sub

    Private Function FindFotoMatch(soortmixid As Integer, fustid As Integer, rijpheid As Integer, hoogte As Integer, diameter As Integer) As String
        Dim returnpath As String = ""

        Dim FotoTradeItemDBId As Integer = 0
        If soortmixid < 10000 Then
            For i = 0 To UBound(soorten) - 1
                If soorten(i).id = soortmixid Then
                    FotoTradeItemDBId = soorten(i).tradeitemklok
                    Exit For
                End If
            Next
        Else
            For i = 0 To UBound(mixen) - 1
                If mixen(i).id = soortmixid - 10000 Then
                    FotoTradeItemDBId = mixen(i).tradeitemklok
                    Exit For
                End If
            Next
        End If

        If FotoTradeItemDBId > 0 Then
            'test all
            For i = 1 To UBound(fotofilters)
                If FotoTradeItemDBId = fotofilters(i).tradeItemId Then
                    If fustid = fotofilters(i).fust And rijpheid = fotofilters(i).rijpheid And hoogte = fotofilters(i).hoogte And diameter = fotofilters(i).diameter Then
                        Return fotofilters(i).fotopath
                    End If
                End If
            Next
            For i = 1 To UBound(fotofilters)
                If FotoTradeItemDBId = fotofilters(i).tradeItemId Then
                    If fustid = fotofilters(i).fust And rijpheid = fotofilters(i).rijpheid And hoogte = fotofilters(i).hoogte Then
                        Return fotofilters(i).fotopath
                    End If
                End If
            Next

            For i = 1 To UBound(fotofilters)
                If FotoTradeItemDBId = fotofilters(i).tradeItemId Then
                    If fustid = fotofilters(i).fust And rijpheid = fotofilters(i).rijpheid And diameter = fotofilters(i).diameter Then
                        Return fotofilters(i).fotopath
                    End If
                End If
            Next
        End If


        Return returnpath
    End Function
    Private Sub Order_invoer_FlexGrid_SetupEditor(ByVal sender As System.Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Order_invoer_FlexGrid.SetupEditor
        If TypeOf Order_invoer_FlexGrid.Editor Is ComboBox Then
            DirectCast(Order_invoer_FlexGrid.Editor, ComboBox).MaxDropDownItems = 20
        End If
    End Sub
    Private Sub Order_invoer_FlexGrid_BeforeEdit(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Order_invoer_FlexGrid.BeforeEdit
        If Order_Slot_Chk.Checked = True Then
            Try


                If Order_invoer_FlexGrid.Item(e.Row, 0) > 0 Then   'als lock actief en line heeft een id.. dan soms edit verhinderen

                    'If e.Col = 2 Or e.Col = 4 Or e.Col = 6 Or e.Col = 21 Or e.Col = 11 Or e.Col = 17 Then
                    '    e.Cancel = True
                    'End If

                    If e.Col = aantalcol Or e.Col = soortcol Or e.Col = fustcol Or e.Col = gpcol Or e.Col = acce1col Or e.Col = vestigingcol Then
                        e.Cancel = True
                    End If

                End If
            Catch ex As Exception

            End Try
        End If
    End Sub
    Private Sub Order_invoer_FlexGrid_AfterEdit(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Order_invoer_FlexGrid.AfterEdit


        '***************************************************
        ' DIVERSE GRID FUNCTIES AFTER EDIT
        '***************************************************
        If e.Col = aantalcol Then
            'totaal aantal laten zien

            Dim tot_aantal As Integer = 0
            For i = 1 To Order_invoer_FlexGrid.Rows.Count - 1
                tot_aantal = tot_aantal + Order_invoer_FlexGrid.Item(i, aantalcol)
            Next
            Order_invoer_FlexGrid.Item(0, aantalcol) = "A#" + Str(tot_aantal)

        End If

        '*************** Achtergrond kleur blauw ********************
        If e.Col = aantalcol Then  'kleur rij naar blauw zetten als er iets wordt ingevuld bij aantallen
            If Order_invoer_FlexGrid.Item(e.Row, e.Col) > 0 Then
                Order_invoer_FlexGrid.Rows(e.Row).Style = Order_invoer_FlexGrid.Styles("RowColor")
            End If
        End If



        '*************** Fust verandered, X aanpassen ********************

        If e.Col = fustcol Then   'fustrow
            Dim fustid As Integer
            fustid = Order_invoer_FlexGrid.Item(e.Row, fustcol)
            Dim apf As Integer
            apf = fust(GID(fust, fustid)).aantal_per_fust
            Order_invoer_FlexGrid.Item(e.Row, xcol) = "x " + Trim(Str(apf))
        End If

        '****************** keurcode ************************

        If e.Col = keurcodecol Then
            Order_invoer_FlexGrid.Item(e.Row, fotocol) = ""
        End If


        '*************** Soort verandered, prijs aanpassen & hoogte/diameter/rijpheid/foto? ********************

        If e.Col = soortcol Then  'soortrow

            '
            Dim prijskleur = 0
            Dim actie_type As Integer
            Dim koper_ean As String = Order_ean_lbl.Text
            Dim accessoire_id As Integer = Order_invoer_FlexGrid.Item(e.Row, acce1col)
            Dim soortid As Integer = Order_invoer_FlexGrid.Item(e.Row, soortcol)
            Dim aID As Integer = GID(accessoire, accessoire_id)
            ' If accessoire(aID).prijslijst > 0 Then
            'Order_invoer_FlexGrid.Item(e.Row, 5) = fetchprijs(accessoire(aID).prijslijst, order_date)
            Dim huidige_prijs As Double = ZoekPrijs(soortid, koper_ean, order_date, prijskleur, actie_type)
            Dim nieuwe_prijs As Double = FindAccessoirePrijs(koper_ean, huidige_prijs, accessoire_id, soortid, order_date, actie_type)
            If nieuwe_prijs <> huidige_prijs Then
                Order_invoer_FlexGrid.Item(e.Row, prijscol) = nieuwe_prijs
                Order_invoer_FlexGrid.Item(e.Row, aanbodcol) = Tstr(actie_type)
                Order_invoer_FlexGrid.SetCellStyle(e.Row, prijscol, "WarningColor")
            End If

            If Val(koper_ean) < 2000 Then 'klok 
                Order_invoer_FlexGrid.Item(e.Row, rijpheidcol) = Tstr(ZoekSoortCode("klokrijpheid", soortid))
                Order_invoer_FlexGrid.Item(e.Row, hoogtecol) = Tstr(ZoekSoortCode("klokhoogte", soortid))
                Order_invoer_FlexGrid.Item(e.Row, diametercol) = Tstr(ZoekSoortCode("klokdiameter", soortid))
                Order_invoer_FlexGrid.Item(e.Row, fotocol) = ""
            Else                          'bb 
                Order_invoer_FlexGrid.Item(e.Row, rijpheidcol) = Tstr(ZoekSoortCode("bbrijpheid", soortid))
                Order_invoer_FlexGrid.Item(e.Row, hoogtecol) = Tstr(ZoekSoortCode("bbhoogte", soortid))
                Order_invoer_FlexGrid.Item(e.Row, diametercol) = Tstr(ZoekSoortCode("bbdiameter", soortid))
            End If

            'filternr herberekene
            Dim wpsfilternaam As String = ""
            Dim wpsfilterid As Integer = 0
            Dim wpsfilterid2 As Integer = 0
            GetWPSFilterNr(koper_ean, soortid, accessoire_id, wpsfilterid, wpsfilterid2)
            For j = 0 To UBound(wpsfilter)
                If wpsfilterid = wpsfilter(j).filternummer Then
                    wpsfilternaam = wpsfilter(j).filternaam
                    Exit For
                End If
            Next j

            Order_invoer_FlexGrid.Item(e.Row, wpsfilter1col) = wpsfilternaam
            Order_invoer_FlexGrid.Item(e.Row, wpsfilter2col) = wpsfilterid
            Order_invoer_FlexGrid.Item(e.Row, wpsfilter3col) = wpsfilterid2
        End If

        '*************** Accessoire verandered, prijs/fust/hoes aanpassen? ********************

        If e.Col = acce1col Then

            Dim koper_ean As String = Order_ean_lbl.Text
            Dim accessoire_id As Integer = Order_invoer_FlexGrid.Item(e.Row, acce1col)
            Dim soortid As Integer = Order_invoer_FlexGrid.Item(e.Row, soortcol)
            Dim aID As Integer = GID(accessoire, accessoire_id)

            If accessoire(aID).naam.IndexOf("Stik") >= 0 Then   'stikker accessoire? 
                StickerType_cmb.SelectedIndex = 1
            End If
            If accessoire(aID).naam = "Stik hoes" Then   'stikker op hoes accessoire? 
                StickerType_cmb.SelectedIndex = 11
            End If


            Dim huidige_prijs As Double = Order_invoer_FlexGrid.Item(e.Row, prijscol)
            Dim actie_type As Integer = 0
            Dim nieuwe_prijs As Double = FindAccessoirePrijs(koper_ean, huidige_prijs, accessoire_id, soortid, order_date, actie_type)

            If nieuwe_prijs <> huidige_prijs Then
                Order_invoer_FlexGrid.Item(e.Row, prijscol) = nieuwe_prijs
                Order_invoer_FlexGrid.Item(e.Row, aanbodcol) = Tstr(actie_type)
                Order_invoer_FlexGrid.SetCellStyle(e.Row, prijscol, "WarningColor")
            End If


            If accessoire(aID).hoes > 0 Then
                Order_invoer_FlexGrid.Item(e.Row, hoescol) = Tstr(accessoire(GID(accessoire, accessoire(aID).hoes)).id)
                Order_invoer_FlexGrid.SetCellStyle(e.Row, hoescol, "WarningColor")
            End If

            If accessoire(aID).fust > 0 Then
                Order_invoer_FlexGrid.Item(e.Row, fustcol) = Tstr(fust(GID(fust, accessoire(aID).fust)).id)
                Order_invoer_FlexGrid.SetCellStyle(e.Row, fustcol, "WarningColor")
                Dim fustid As Integer
                fustid = Order_invoer_FlexGrid.Item(e.Row, fustcol)
                Dim apf As Integer
                apf = fust(GID(fust, fustid)).aantal_per_fust
                Order_invoer_FlexGrid.Item(e.Row, xcol) = "x " + Trim(Str(apf))
            End If
            If accessoire(aID).potmaat > 0 Then
                Order_invoer_FlexGrid.Item(e.Row, potmaatcol) = Tstr(accessoire(aID).potmaat / 10)
                Order_invoer_FlexGrid.SetCellStyle(e.Row, potmaatcol, "WarningColor")
            End If

            'filternr herbereken voor meerwaardes 
            Dim wpsfilternaam As String = ""
            Dim wpsfilterid As Integer = 0
            Dim wpsfilterid2 As Integer = 0
            GetWPSFilterNr(koper_ean, soortid, accessoire_id, wpsfilterid, wpsfilterid2)
            For j = 0 To UBound(wpsfilter)
                If wpsfilterid = wpsfilter(j).filternummer Then
                    wpsfilternaam = wpsfilter(j).filternaam
                    Exit For
                End If
            Next j

            Order_invoer_FlexGrid.Item(e.Row, wpsfilter1col) = wpsfilternaam
            Order_invoer_FlexGrid.Item(e.Row, wpsfilter2col) = wpsfilterid
            Order_invoer_FlexGrid.Item(e.Row, wpsfilter3col) = wpsfilterid2

        End If

        If e.Col = acce2col Then 'accessoire2


            Dim accessoire_id As Integer = Order_invoer_FlexGrid.Item(e.Row, acce2col)
            Dim soortid As Integer = Order_invoer_FlexGrid.Item(e.Row, soortcol)
            Dim aID As Integer = GID(accessoire, accessoire_id)

            Dim huidige_prijs As Double = Order_invoer_FlexGrid.Item(e.Row, prijscol)
            Dim nieuwe_prijs As Double = FindAccessoirePlusPrijs(huidige_prijs, accessoire_id, soortid, order_date)
            If nieuwe_prijs <> huidige_prijs Then
                Order_invoer_FlexGrid.Item(e.Row, prijscol) = nieuwe_prijs
                Order_invoer_FlexGrid.SetCellStyle(e.Row, prijscol, "WarningColor")
            End If

            If accessoire(aID).naam.IndexOf("Stik") >= 0 Then   'stikker accessoire? 
                StickerType_cmb.SelectedIndex = 1
            End If
            If accessoire(aID).naam = "Stik hoes" Then   'stikker op hoes accessoire? 
                StickerType_cmb.SelectedIndex = 11
            End If



            '' End If

        End If


    End Sub
    Private Function FindAccessoirePrijs(ByVal koper_ean As String, ByVal huidige_prijs As Double, ByVal AccessoireID As Integer, ByVal soortid As Integer, ByVal order_date As Date, ByRef actie_prijs As Integer) As Double
        Dim prijs As Double = huidige_prijs

        Dim Reader As OdbcDataReader


        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim cmdstring As String
                cmdstring = "SELECT * FROM accessoire_prijzen where accessoire = " + Str(AccessoireID) + " And soort = " + Str(soortid)

                'Execute Query
                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Dim prijslijst As Integer = CHint(Reader("prijslijst"))
                    actie_prijs = prijzen(GID(prijzen, prijslijst)).actie_type
                    Dim plus_prijs As Double = CHdouble(Reader("plus_prijs"))
                    If prijslijst > 0 Then
                        prijs = fetchprijs(prijslijst, order_date)
                    Else
                        prijs = huidige_prijs + plus_prijs
                    End If
                    Reader.Close()
                Else

                    'test 2 : accessoire en soortgroep specifiek 
                    Dim cmdstring2 As String = "SELECT * FROM accessoire_prijzen where accessoire = " + Str(AccessoireID) + " And soort >= 20000"
                    Dim reader2 As OdbcDataReader
                    Dim Cmd2 As New OdbcCommand(cmdstring2, Conn)
                    reader2 = Cmd2.ExecuteReader()
                    Dim reader3 As OdbcDataReader
                    Do While reader2.Read()
                        Dim soortgroep As Integer = CHint(reader2("soort"))
                        Dim CmdString3 As String = "SELECT * FROM soortgroepen_ids where id = " + Str(soortgroep - 20000) + " And soortmixid = " + Str(soortid)
                        Dim Cmd3 As New OdbcCommand(CmdString3, Conn)
                        reader3 = Cmd3.ExecuteReader()
                        If reader3.HasRows Then
                            Dim prijslijst As Integer = CHint(reader2("prijslijst"))
                            actie_prijs = prijzen(GID(prijzen, prijslijst)).actie_type
                            Dim plus_prijs As Double = CHdouble(reader2("plus_prijs"))
                            If prijslijst > 0 Then
                                prijs = fetchprijs(prijslijst, order_date)
                                Dim extraprijs As Double = GetExtraPrijs(koper_ean)
                                prijs = prijs + extraprijs
                                If prijs < 0 Then prijs = 0
                            Else
                                prijs = huidige_prijs + plus_prijs
                            End If

                            reader3.Close()
                            Exit Do
                        End If
                    Loop
                    reader2.Close()
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout:  (FindAccessoirePrijs)" + ex.Message)
            MessageBox.Show("Database fout: (FindAccessoirePrijs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        Return prijs
    End Function
    Private Function FindAccessoirePlusPrijs(ByVal huidige_prijs As Double, ByVal AccessoireID As Integer, ByVal soortid As Integer, ByVal order_date As Date) As Double
        Dim prijs As Double = huidige_prijs

        Dim Reader As OdbcDataReader


        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim cmdstring As String
                cmdstring = "SELECT * FROM accessoire_prijzen where accessoire = " + Str(AccessoireID) + " AND soort = " + Str(soortid)

                'Execute Query
                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Dim plus_prijs As Double = CHdouble(Reader("plus_prijs"))
                    prijs = huidige_prijs + plus_prijs
                    Reader.Close()
                Else

                    'test 2 : accessoire en soortgroep specifiek 
                    Dim cmdstring2 As String = "SELECT * FROM accessoire_prijzen where accessoire = " + Str(AccessoireID) + " AND soort >= 20000"
                    Dim reader2 As OdbcDataReader
                    Dim Cmd2 As New OdbcCommand(cmdstring2, Conn)
                    reader2 = Cmd2.ExecuteReader()
                    Dim reader3 As OdbcDataReader
                    Do While reader2.Read()
                        Dim soortgroep = CHstr(reader2("soort"))
                        Dim CmdString3 As String = "SELECT * FROM soortgroepen_ids where id = " + Str(soortgroep - 20000) + " AND soortmixid = " + Str(soortid)
                        Dim Cmd3 As New OdbcCommand(CmdString3, Conn)
                        reader3 = Cmd3.ExecuteReader()
                        If reader3.HasRows Then
                            Dim plus_prijs As Double = CHdouble(reader2("plus_prijs"))
                            prijs = huidige_prijs + plus_prijs
                            reader3.Close()
                            Exit Do
                        End If
                    Loop
                    reader2.Close()
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (FindAccessoirePlusPrijs)" + ex.Message)
            MessageBox.Show("Database fout: (FindAccessoirePlusPrijs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        Return prijs
    End Function
    Private Sub GetWPSFilterNr(ByVal koper_ean As String, ByVal soort_id As Integer, ByVal accessoire_id As Integer, ByRef filter1 As Integer, ByRef filter2 As Integer)
        filter1 = 0
        filter2 = 0

        Dim groep As Integer = 0

        'stap 1 is het een mix? -> skip
        If soort_id >= 10000 Then
            'skip
        Else

            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'stap 2 -> zoek groep bij accessoire
                    If accessoire_id > 0 Then

                        Dim Reader As OdbcDataReader
                        Dim cmdstring As String
                        cmdstring = "SELECT * FROM accessoire_prijzen where accessoire = " + Str(accessoire_id) + " AND soort = " + Str(soort_id)

                        'Execute Query
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        Reader = Cmd.ExecuteReader()
                        If Reader.HasRows Then
                            groep = CHint(Reader("wps_filtergroep"))
                            Reader.Close()
                        Else

                            'test 2 : accessoire en soortgroep specifiek 
                            Dim cmdstring2 As String = "SELECT * FROM accessoire_prijzen where accessoire = " + Str(accessoire_id) + " AND soort >= 20000"
                            Dim reader2 As OdbcDataReader
                            Dim Cmd2 As New OdbcCommand(cmdstring2, Conn)
                            reader2 = Cmd2.ExecuteReader()
                            Dim reader3 As OdbcDataReader
                            Do While reader2.Read()
                                Dim soortgroep = CHint(reader2("soort"))
                                Dim CmdString3 As String = "SELECT * FROM soortgroepen_ids where id = " + Str(soortgroep - 20000) + " AND soortmixid = " + Str(soort_id)
                                Dim Cmd3 As New OdbcCommand(CmdString3, Conn)
                                reader3 = Cmd3.ExecuteReader()
                                If reader3.HasRows Then
                                    groep = CHint(reader2("wps_filtergroep"))
                                    reader3.Close()
                                    Exit Do
                                End If
                            Loop
                            reader2.Close()
                        End If

                    End If

                    'stap 3 zoek groep bij koper

                    If groep = 0 Then
                        Dim Reader As OdbcDataReader
                        Dim CmdString As String = "select wps_indeling from klanten where ean ='" + Str(koper_ean) + "'"

                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                        Reader = Cmd.ExecuteReader()
                        If Reader.HasRows Then
                            groep = CHint(Reader("wps_indeling"))
                        End If

                    End If

                    'stap 4 zoek filter bij gevonden groep
                    If groep > 0 Then
                        Dim Reader As OdbcDataReader
                        Dim CmdString As String = "select filter1,filter2 from wps_groepfilters where  groep =" + Str(groep) + " and soort_id =" + Str(soort_id)

                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                        Reader = Cmd.ExecuteReader()
                        If Reader.HasRows Then
                            filter1 = CHint(Reader("filter1"))
                            filter2 = CHint(Reader("filter2"))
                        End If
                    End If

                End Using

            Catch ex As Exception
                ErrorLog("Database fout: (GetWPSFilternr)" + ex.Message)
                MessageBox.Show("Database fout: (GetWPSFilternr)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        End If

    End Sub
    Private Sub Order_ToolStripMenuItem1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_ToolStripMenuItem1.Click
        If Order_invoer_FlexGrid.Rows.Count > 1 Then
            Dim row As Integer = Order_invoer_FlexGrid.Row
            If row < 1 Then row = 1
            Dim soortid As Integer = Order_invoer_FlexGrid.Item(row, 4)
            If Order_ean_lbl.Text <> "0000000000000" Then
                Dim fustid = FindFustFromFustCat(Order_fustcat_cmb.SelectedValue, soortid)
                Load_AccessoireList(soortid, fustid, Order_ean_lbl.Text)
                Order_invoer_FlexGrid.Focus()
            End If
        End If
    End Sub
    Private Sub Order_ToolStripMenuItem2_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_ToolStripMenuItem2.Click
        Order_groep1_but_Click(sender, e)
    End Sub
    Private Sub Order_ToolStripMenuItem3_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_ToolStripMenuItem3.Click
        Order_groep2_but_Click(sender, e)
    End Sub
    Private Sub Order_ToolStripMenuItem4_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_ToolStripMenuItem4.Click
        Order_groep3_but_Click(sender, e)
    End Sub
    Private Sub Order_ToolStripMenuItem5_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_ToolStripMenuItem5.Click
        Order_groep4_but_Click(sender, e)
    End Sub
    Private Sub Order_ToolStripMenuItem6_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_ToolStripMenuItem6.Click
        Order_groep5_but_Click(sender, e)
    End Sub
    Private Sub CodeInvoerToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CodeInvoerToolStripMenuItem.Click
        If Order_invoer_FlexGrid.Rows.Count > 1 Then
            Code_invoer.StartPosition = FormStartPosition.CenterScreen
            Code_invoer.Show()
            Application.DoEvents()
            Code_invoer.Code_deel1_txt.Text = ""
            Code_invoer.Code_deel2_txt.Text = ""
            Code_invoer.Code_aantal_txt.Text = ""
            Code_invoer.Code_aantal2_txt.Text = ""
            Code_invoer.Code_lang_txt.Text = ""
            If jenptenhave = False Then
                Code_invoer.Code_deel1_txt.Focus()
            Else
                Code_invoer.Code_lang_txt.Focus()
            End If

        End If
    End Sub
    Private Sub Order_invoer_FlexGrid_MouseDown(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles Order_invoer_FlexGrid.MouseDown
        If Order_invoer_FlexGrid.Rows.Count > 0 Then
            If e.Button = MouseButtons.Right Then
                Me.Order_MenuStrip.Show(Me.Order_invoer_FlexGrid, e.Location)
            End If
        End If
    End Sub
    Private Sub Order_invoer_FlexGrid_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles Order_invoer_FlexGrid.Click


        '***************************************************
        ' WPS Filter combo invullen als er op geclicked wordt
        ' Create the custom editor.
        '***************************************************
        If Order_invoer_FlexGrid.Col = wpsfilter1col Then
            If Order_invoer_FlexGrid.Rows.Count > 1 Then

                Dim style As C1.Win.C1FlexGrid.CellStyle = Order_invoer_FlexGrid.Styles.Add("newGridStyle")
                Invoer_WpsFilterCombo.DataMode = C1.Win.C1List.DataModeEnum.Normal

                Dim dt_filter As New DataTable
                dt_filter.Columns.Add("Code", GetType(Integer))
                dt_filter.Columns.Add("Naam", GetType(String))

                ' Dim cn() As String = New String() {"Naam", "Code"}
                dt_filter.Clear()

                '*********** LIJST GENEREREN **************************
                Dim soort_id = Order_invoer_FlexGrid.Item(Order_invoer_FlexGrid.Row, soortcol) '??  soortid kolom
                Dim wps_soort_id = soorten(GID(soorten, soort_id)).wps_code
                Dim potmaat = soorten(GID(soorten, soort_id)).potmaat
                Dim filterfound As Boolean = False
                For i = 0 To UBound(wpsfilter)
                    If potmaat = 190 Then potmaat = 170
                    If wps_soort_id = wpsfilter(i).wps_soortnummer And potmaat = wpsfilter(i).potmaat Then
                        dt_filter.Rows.Add(New String() {wpsfilter(i).filternummer, wpsfilter(i).filternaam})
                        filterfound = True
                    End If
                Next i
                If filterfound = False And soort_id < 10000 Then
                    dt_filter.Rows.Add(New String() {999999, "Niet via WPS"})
                End If
                'dt_soortmix.DefaultView.Sort = String.Format("volgorde", "DESC")
                Invoer_WpsFilterCombo.DataSource = dt_filter
                Invoer_WpsFilterCombo.DisplayMember = "Naam"
                Invoer_WpsFilterCombo.ValueMember = "Code"
                Invoer_WpsFilterCombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                Invoer_WpsFilterCombo.ComboStyle = 2  'combo style list

                Invoer_WpsFilterCombo.DropDownWidth = 150
                Invoer_WpsFilterCombo.ColumnWidth = 145
                Invoer_WpsFilterCombo.MaxDropDownItems = 15

                style.Editor = Invoer_WpsFilterCombo
                Order_invoer_FlexGrid.SetCellStyle(Order_invoer_FlexGrid.Row, wpsfilter1col, style)
                Order_invoer_FlexGrid.StartEditing(Order_invoer_FlexGrid.Row, wpsfilter1col)

                Invoer_WpsFilterCombo.DroppedDown = True


            End If

        End If


        If Order_invoer_FlexGrid.Col = prijscol Then

            '***************************************************
            ' PRIJS COMBO invullen als er op geclicked wordt
            ' Create the custom editor.
            '***************************************************
            Dim style As C1.Win.C1FlexGrid.CellStyle = Order_invoer_FlexGrid.Styles.Add("newGridStyle")

            Dim mycombo = New C1.Win.C1List.C1Combo()
            Me.Controls.Add(mycombo)
            mycombo.Visible = False
            mycombo.DataMode = C1.Win.C1List.DataModeEnum.Normal

            Dim dt_celprijzen As New DataTable
            dt_celprijzen.Columns.Add("Prijs", GetType(String))
            dt_celprijzen.Columns.Add("Naam", GetType(String))

            Dim cn() As String = New String() {"Prijs", "Naam"}
            dt_celprijzen.Clear()

            '*********** LIJST GENEREREN **************************

            Dim soortprijs As Double = 0
            Dim titel As String = ""

            Dim Reader As OdbcDataReader
            Dim rang As Integer = 10
            Dim count As Integer = 0
            Dim CmdString As String
            Dim koper_ean As String
            Dim soortid As Integer

            koper_ean = Order_ean_lbl.Text
            soortid = Order_invoer_FlexGrid.Item(Order_invoer_FlexGrid.Row, soortcol)
            Dim datum As Date
            datum = order_date
            'prijzen(i).id = Reader("id")
            'prijzen(i).naam = Reader("naam")
            'prijzen(i).soort = Reader("soort")
            'prijzen(i).standaard = Reader("standaard")
            'prijzen(i).algemeen = Reader("algemeen")
            'prijzen(i).klant = Reader("klant")
            'prijzen(i).klantgroep = Reader("klantgroep")
            If jenptenhave = False Then


                For i = 0 To UBound(prijzen)


                    'test 1 : soort en klant specifiek .. rang 1 
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then

                        If prijzen(i).klant = koper_ean Then
                            If prijzen(i).soort = soortid And check_actie_datum(prijzen(i).id, datum) = True Then
                                soortprijs = fetchprijs(prijzen(i).id, datum)
                                dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), prijzen(i).naam})
                            End If
                        End If
                    End If


                    'test 2 : soort en klantgroep specifiek .. rang 2
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).soort = soortid And check_actie_datum(prijzen(i).id, datum) = True Then
                            If prijzen(i).klantgroep > 0 Then

                                CmdString = "SELECT * FROM kopersgroepen2_eans where id = " + Str(prijzen(i).klantgroep) + " AND ean = '" + Str(koper_ean) + "'"
                                Try
                                    Using Conn As New OdbcConnection(ConnString)
                                        Conn.Open()

                                        'Execute Query
                                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                                        Reader = Cmd.ExecuteReader()
                                        If Reader.HasRows Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), prijzen(i).naam})
                                        End If

                                    End Using
                                Catch ex As Exception
                                    ErrorLog("Database fout: (prijzen calc)" + ex.Message)
                                    MessageBox.Show("Database fout: (prijzen calc)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                                End Try
                            End If
                        End If
                    End If

                    'test 3 : soortgroep en klant specifiek rang 3
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).klant = koper_ean And check_actie_datum(prijzen(i).id, datum) = True Then
                            If prijzen(i).soort >= 20000 Then
                                CmdString = "SELECT * FROM soortgroepen_ids where id = " + Str(prijzen(i).soort - 20000) + " AND soortmixid = " + Str(soortid)
                                Try
                                    Using Conn As New OdbcConnection(ConnString)
                                        Conn.Open()

                                        'Execute Query
                                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                                        Reader = Cmd.ExecuteReader()
                                        If Reader.HasRows Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), prijzen(i).naam})
                                        End If
                                    End Using
                                Catch ex As Exception
                                    ErrorLog("Database fout: (prijzencalc2)" + ex.Message)
                                    MessageBox.Show("Database fout: (prijzen calc)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                                End Try

                            End If
                        End If
                    End If

                    'test 4 : soortgroep en klantgroep specifiek rang 4
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        Dim koperfound As Boolean = False
                        If prijzen(i).klantgroep > 0 And check_actie_datum(prijzen(i).id, datum) = True Then

                            CmdString = "SELECT * FROM kopersgroepen2_eans where id = " + Str(prijzen(i).klantgroep) + " AND ean = '" + Str(koper_ean) + "'"
                            Try
                                Using Conn As New OdbcConnection(ConnString)
                                    Conn.Open()

                                    'Execute Query
                                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                                    Reader = Cmd.ExecuteReader()
                                    If Reader.HasRows Then
                                        koperfound = True
                                    End If

                                End Using
                            Catch ex As Exception
                                ErrorLog("Database fout: (prijzencalc3)" + ex.Message)
                                MessageBox.Show("Database fout: (prijzen calc)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                            End Try

                            If prijzen(i).soort >= 20000 And koperfound = True Then
                                CmdString = "SELECT * FROM soortgroepen_ids where id = " + Str(prijzen(i).soort - 20000) + " AND soortmixid = '" + Str(soortid) + "'"
                                Try
                                    Using Conn As New OdbcConnection(ConnString)
                                        Conn.Open()

                                        'Execute Query
                                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                                        Reader = Cmd.ExecuteReader()
                                        If Reader.HasRows Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), prijzen(i).naam})
                                        End If
                                    End Using
                                Catch ex As Exception
                                    MessageBox.Show("Database fout: (prijzen calc)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                                End Try

                            End If
                        End If
                    End If

                    'test 5 : soort specifiek .. rang 5
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).soort = soortid And prijzen(i).klantgroep = 0 And prijzen(i).klant = "0000000000000" Then
                            soortprijs = fetchprijs(prijzen(i).id, datum)
                            dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), prijzen(i).naam})
                        End If
                    End If



                    'test 6 : soortgroep rang 6
                    If prijzen(i).actief = True And prijzen(i).accessoire = False And prijzen(i).algemeen = True Then
                        If prijzen(i).soort >= 20000 Then
                            CmdString = "SELECT * FROM soortgroepen_ids where id = " + Str(prijzen(i).soort - 20000) + " AND soortmixid = '" + Str(soortid) + "'"
                            Try
                                Using Conn As New OdbcConnection(ConnString)
                                    Conn.Open()

                                    'Execute Query
                                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                                    Reader = Cmd.ExecuteReader()
                                    If Reader.HasRows Then
                                        soortprijs = fetchprijs(prijzen(i).id, datum)
                                        dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), prijzen(i).naam})
                                    End If

                                End Using
                            Catch ex As Exception
                                ErrorLog("Database fout: (prijzencalc4)" + ex.Message)
                                MessageBox.Show("Database fout: (prijzen calc)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                            End Try
                        End If
                    End If


                Next i
            Else

                'prijslijst J&P doorspitten

                Dim jpsoort As Integer = 0
                Dim jpaccessoire1 As Integer = 0
                Dim jpaccessoire2 As Integer = 0
                Dim jpfust As Integer = 0
                Dim jpprijs As Integer = 0
                Dim jphoes As Integer = 0
                Dim jpkorting As Integer = 0
                Dim jpomschrijving As String = ""
                'zoeken in klantgroepen groter als decorum (1)
                Dim kortingfound As Boolean = False
                For i = 1 To UBound(prijslijst)
                    If prijslijst(i).kopersgroep > 1 And soortid = prijslijst(i).soort Then
                        Dim kopersgroepid As Integer = prijslijst(i).kopersgroep
                        For k = 1 To UBound(kopergroepEANs)
                            If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                                'koper gevonden in kopersgroep 
                                Dim findid As Integer = i
                                jpsoort = prijslijst(findid).soort
                                jpaccessoire1 = prijslijst(findid).accessoire1
                                jpaccessoire2 = prijslijst(findid).accessoire2
                                jpfust = prijslijst(findid).fust
                                jphoes = prijslijst(findid).hoes
                                jpprijs = prijslijst(findid).prijs
                                jpomschrijving = prijslijst(findid).omschrijving
                                If prijslijst(findid).korting <> 0 Then
                                    For j = 1 To UBound(kortingsgroepen)
                                        Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                                        For m = 1 To UBound(kopergroepEANs)
                                            If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                                'korting found
                                                jpkorting = kortingsgroepen(j).korting
                                                soortprijs = (jpprijs - jpkorting) / 100
                                                dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})
                                                kortingfound = True
                                            End If
                                        Next
                                    Next
                                End If
                                If kortingfound = False Then
                                    soortprijs = (jpprijs - jpkorting) / 100
                                    dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})
                                End If
                            End If
                        Next
                    End If
                Next

                'zoeken in klantgroepen decorum (1)
                kortingfound = False
                For i = 1 To UBound(prijslijst)
                    If prijslijst(i).kopersgroep = 1 And soortid = prijslijst(i).soort Then
                        Dim kopersgroepid As Integer = 1
                        For k = 1 To UBound(kopergroepEANs)
                            If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                                'koper gevonden in kopersgroep 
                                Dim findid As Integer = i
                                jpsoort = prijslijst(findid).soort
                                jpaccessoire1 = prijslijst(findid).accessoire1
                                jpaccessoire2 = prijslijst(findid).accessoire2
                                jpfust = prijslijst(findid).fust
                                jphoes = prijslijst(findid).hoes
                                jpprijs = prijslijst(findid).prijs
                                jpomschrijving = prijslijst(findid).omschrijving
                                If prijslijst(findid).korting <> 0 Then
                                    For j = 1 To UBound(kortingsgroepen)
                                        Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                                        For m = 1 To UBound(kopergroepEANs)
                                            If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                                'korting found
                                                jpkorting = kortingsgroepen(j).korting
                                                soortprijs = (jpprijs - jpkorting) / 100
                                                dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})
                                                kortingfound = True
                                            End If
                                        Next
                                    Next
                                End If
                                If kortingfound = False Then
                                    soortprijs = (jpprijs - jpkorting) / 100
                                    dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})
                                End If
                            End If
                        Next
                    End If
                Next

                'zoeken in totaal aanbod
                kortingfound = False
                For i = 1 To UBound(prijslijst)
                    If soortid = prijslijst(i).soort Then

                        If prijslijst(i).kopersgroep = 0 Then
                            '(kopersgroep = 0 : Algemeen aanbod)
                            Dim findid As Integer = i
                            jpsoort = prijslijst(findid).soort
                            jpaccessoire1 = prijslijst(findid).accessoire1
                            jpaccessoire2 = prijslijst(findid).accessoire2
                            jpfust = prijslijst(findid).fust
                            jphoes = prijslijst(findid).hoes
                            jpprijs = prijslijst(findid).prijs
                            jpomschrijving = prijslijst(findid).omschrijving
                            If prijslijst(findid).korting <> 0 Then
                                For j = 1 To UBound(kortingsgroepen)
                                    Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                                    For m = 1 To UBound(kopergroepEANs)
                                        If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                            'korting found
                                            jpkorting = kortingsgroepen(j).korting
                                            soortprijs = (jpprijs - jpkorting) / 100
                                            dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})
                                            kortingfound = True
                                        End If
                                    Next
                                Next
                            End If
                            If kortingfound = False Then
                                soortprijs = (jpprijs - jpkorting) / 100
                                dt_celprijzen.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})
                            End If

                        End If
                    End If

                Next


            End If

            '
            mycombo.DataSource = dt_celprijzen
            mycombo.ValueMember = "Prijs"
            mycombo.DropDownWidth = 256
            mycombo.ColumnWidth = 125
            mycombo.MaxDropDownItems = 10

            style.Editor = mycombo
            Order_invoer_FlexGrid.SetCellStyle(Order_invoer_FlexGrid.Row, prijscol, style)
            Order_invoer_FlexGrid.StartEditing(Order_invoer_FlexGrid.Row, prijscol)
            mycombo.DroppedDown = True
        End If
    End Sub
    Private Sub Invoer_WpsFilterCombo_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles Invoer_WpsFilterCombo.Validated

        'wps filter combobox naar filter1
        If Order_invoer_FlexGrid.Col = wpsfilter1col Then
            If Invoer_WpsFilterCombo.SelectedValue = Nothing Then
                Order_invoer_FlexGrid.Item(Order_invoer_FlexGrid.Row, wpsfilter2col) = 0
            Else
                Order_invoer_FlexGrid.Item(Order_invoer_FlexGrid.Row, wpsfilter2col) = Invoer_WpsFilterCombo.SelectedValue
            End If

        End If
    End Sub

    Private Function fetchprijs(ByVal prijs_id As Integer, ByVal datum As Date) As Double

        '***************************************************
        ' PRIJS bepalen uit datum tabel
        ' gebruikt door 'zoekprijs'
        '***************************************************
        Dim prijs As Double = 0

        Dim Reader As OdbcDataReader
        Dim cmdstring As String
        Dim yyyyMMdd As String = datum.ToString("yyyy/MM/dd")
        cmdstring = "SELECT * FROM prijzen_datumlijst where id = " + Str(prijs_id) + " AND datum <= '" + yyyyMMdd + "' ORDER BY datum DESC"
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    prijs = CHdouble(Reader("prijs"))
                Else
                    prijs = 0
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (fetchprijs)" + ex.Message)
            MessageBox.Show("Database fout: (fetchprijs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        'For i = 1 To UBound(prijzendatumlijst)

        '    If prijs_id = prijzendatumlijst(i).id Then
        '        If prijzendatumlijst(i).datum.Date <= datum.Date Then
        '            prijs = prijzendatumlijst(i).prijs
        '            Exit For
        '        Else
        '            prijs = 0
        '        End If
        '    End If
        'Next


        Return prijs
    End Function
    Private Function ZoekPrijsJenP(ByVal soortid As Integer, ByVal koper_ean As String, ByVal datum As Date, ByRef prijskleur As Integer, ByRef actie_type As Integer) As Double
        Dim soortprijs As Double = 0
        Dim jpsoort As Integer = 0
        Dim jpaccessoire1 As Integer = 0
        Dim jpaccessoire2 As Integer = 0
        Dim jpfust As Integer = 0
        Dim jpprijs As Integer = 0
        Dim jphoes As Integer = 0
        Dim jpkorting As Integer = 0
        'zoeken in klantgroepen groter als decorum (1)
        For i = 1 To UBound(prijslijst)
            If prijslijst(i).kopersgroep > 1 And soortid = prijslijst(i).soort Then
                Dim kopersgroepid As Integer = prijslijst(i).kopersgroep
                For k = 1 To UBound(kopergroepEANs)
                    If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                        'koper gevonden in kopersgroep 
                        Dim findid As Integer = i
                        jpsoort = prijslijst(findid).soort
                        jpaccessoire1 = prijslijst(findid).accessoire1
                        jpaccessoire2 = prijslijst(findid).accessoire2
                        Dim accessoire1_naam As String = accessoire(GID(accessoire, jpaccessoire1)).naam
                        Dim accessoire2_naam As String = accessoire(GID(accessoire, jpaccessoire2)).naam

                        Dim keten As Boolean = False

                        Dim prijslijstomschrijving As String = prijslijst(findid).omschrijving
                        If prijslijstomschrijving = "Code-lijst" Then
                            keten = True  'ignore codelijsten voor prijsbepaling
                        End If

                        If Mid(accessoire1_naam, 1, 2) = "K:" Then  'ignore keten prijslijsten
                            keten = True
                        End If
                        If Mid(accessoire2_naam, 1, 2) = "K:" Then
                            keten = True
                        End If

                        If keten = False Then
                            jpfust = prijslijst(findid).fust
                            jphoes = prijslijst(findid).hoes
                            jpprijs = prijslijst(findid).prijs

                            If prijslijst(findid).korting <> 0 Then
                                For j = 1 To UBound(kortingsgroepen)
                                    Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                                    For m = 1 To UBound(kopergroepEANs)
                                        If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                            'korting found
                                            jpkorting = kortingsgroepen(j).korting
                                            Return (jpprijs - jpkorting) / 100
                                        End If
                                    Next
                                Next
                            End If
                            Return (jpprijs - jpkorting) / 100
                        End If
                    End If
                Next
            End If
        Next

        'zoeken in klantgroepen decorum (1)
        For i = 1 To UBound(prijslijst)
            If prijslijst(i).kopersgroep = 1 And soortid = prijslijst(i).soort Then
                Dim kopersgroepid As Integer = 1
                For k = 1 To UBound(kopergroepEANs)
                    If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                        'koper gevonden in kopersgroep 
                        Dim findid As Integer = i
                        jpsoort = prijslijst(findid).soort
                        jpaccessoire1 = prijslijst(findid).accessoire1
                        jpaccessoire2 = prijslijst(findid).accessoire2

                        Dim accessoire1_naam As String = accessoire(GID(accessoire, jpaccessoire1)).naam
                        Dim accessoire2_naam As String = accessoire(GID(accessoire, jpaccessoire2)).naam
                        Dim keten As Boolean = False
                        If Mid(accessoire1_naam, 1, 2) = "K:" Then
                            keten = True
                        End If
                        If Mid(accessoire2_naam, 1, 2) = "K:" Then
                            keten = True
                        End If

                        If keten = False Then

                            jpfust = prijslijst(findid).fust
                            jphoes = prijslijst(findid).hoes
                            jpprijs = prijslijst(findid).prijs
                            If prijslijst(findid).korting <> 0 Then
                                For j = 1 To UBound(kortingsgroepen)
                                    Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                                    For m = 1 To UBound(kopergroepEANs)
                                        If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                            'korting found
                                            jpkorting = kortingsgroepen(j).korting
                                            Return (jpprijs - jpkorting) / 100
                                        End If
                                    Next
                                Next
                            End If
                            Return (jpprijs - jpkorting) / 100
                        End If
                    End If
                Next
            End If
        Next

        'zoeken in totaal aanbod
        Dim laagsteprijs As Double = 10000
        Dim prijs As Integer = 0
        For i = 1 To UBound(prijslijst)
            If soortid = prijslijst(i).soort Then
                Dim kopersgroepid As Integer = 0
                If prijslijst(i).kopersgroep = 0 Then
                    '(kopersgroep = 0 : Algemeen aanbod)
                    Dim findid As Integer = i
                    jpsoort = prijslijst(findid).soort
                    jpaccessoire1 = prijslijst(findid).accessoire1
                    jpaccessoire2 = prijslijst(findid).accessoire2

                    Dim accessoire1_naam As String = accessoire(GID(accessoire, jpaccessoire1)).naam
                    Dim accessoire2_naam As String = accessoire(GID(accessoire, jpaccessoire2)).naam
                    Dim keten As Boolean = False
                    If Mid(accessoire1_naam, 1, 2) = "K:" Then
                        keten = True
                    End If
                    If Mid(accessoire2_naam, 1, 2) = "K:" Then
                        keten = True
                    End If

                    If keten = False Then


                        jpfust = prijslijst(findid).fust
                        jphoes = prijslijst(findid).hoes

                        If prijslijst(findid).prijs > 0 Then

                            jpprijs = prijslijst(findid).prijs
                            If prijslijst(findid).korting <> 0 Then
                                For j = 1 To UBound(kortingsgroepen)
                                    Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                                    For m = 1 To UBound(kopergroepEANs)
                                        If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                            'korting found
                                            jpkorting = kortingsgroepen(j).korting
                                            prijs = jpprijs - jpkorting
                                            If prijs < laagsteprijs Then
                                                laagsteprijs = prijs
                                            End If
                                        End If
                                    Next
                                Next
                            End If
                            prijs = jpprijs - jpkorting
                            If prijs < laagsteprijs Then
                                laagsteprijs = prijs
                            End If
                        End If
                    End If
                End If
            End If

        Next
        If laagsteprijs = 10000 Then 'geen prijs gevonden
            For i = 0 To UBound(prijskoppelingen)
                If prijskoppelingen(i).soort_id = soortid Then
                    Dim soortmix_id As Integer = prijskoppelingen(i).koppel_id
                    laagsteprijs = ZoekPrijsJenP(soortmix_id, koper_ean, datum, prijskleur, actie_type)
                    If laagsteprijs > 0 Then
                        Return laagsteprijs
                    Else
                        Return 0
                    End If
                End If
            Next i
            Return 0
        End If
        Return laagsteprijs / 100
    End Function
    Private Function ZoekPrijs(ByVal soortid As Integer, ByVal koper_ean As String, ByVal datum As Date, ByRef prijskleur As Integer, ByRef actie_type As Integer, Optional geen_jenp As Boolean = False, Optional actienummer As String = "") As Double

        '***************************************************
        ' PRIJS bepalen uit lijst
        '***************************************************
        Dim soortprijs As Double = 0
        Dim rang As Integer = 10
        Dim count As Integer = 0

        Dim actiegevonden As Boolean = False

        If Not (actienummer = "" Or actienummer = "L000") Then   'acties doorzoeken
            'doorzoek lijst naar betrefende actie

            For i = 0 To UBound(prijzen)

                If actienummer = prijzen(i).actienummer Then
                    'test 1 : soort en klant specifiek .. rang 1 
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then

                        If prijzen(i).klant = koper_ean Then
                            If prijzen(i).soort = soortid Then
                                If rang > 1 And check_actie_datum(prijzen(i).id, datum) = True Then
                                    soortprijs = fetchprijs(prijzen(i).id, datum)
                                    actie_type = prijzen(i).actie_type
                                    count = count + 1
                                    rang = 1

                                End If
                            End If
                        End If
                    End If


                    'test 2 : soort en klantgroep specifiek .. rang 2
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).soort = soortid Then
                            If prijzen(i).klantgroep > 0 Then
                                If soortid = 15 Then
                                    Dim dum As Integer = 0
                                End If
                                For j = 1 To UBound(kopergroepEANs)
                                    If prijzen(i).klantgroep = kopergroepEANs(j).id And koper_ean = kopergroepEANs(j).ean Then
                                        If rang > 2 And check_actie_datum(prijzen(i).id, datum) = True Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            actie_type = prijzen(i).actie_type
                                            count = count + 1
                                            rang = 2
                                            Exit For
                                        End If
                                    End If
                                Next



                            End If
                        End If
                    End If

                    'TimePassed("Zoek prijs Test 2")

                    'test 3 : soortgroep en klant specifiek rang 3
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).klant = koper_ean Then
                            If prijzen(i).soort >= 20000 Then
                                For j = 1 To UBound(soortgroepids)
                                    If ((prijzen(i).soort - 20000) = soortgroepids(j).id) And (soortid = soortgroepids(j).soortmixid) Then
                                        If rang > 3 And check_actie_datum(prijzen(i).id, datum) = True Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            actie_type = prijzen(i).actie_type
                                            count = count + 1
                                            rang = 3
                                            Exit For
                                        End If
                                    End If
                                Next

                            End If
                        End If
                    End If

                    'TimePassed("Zoek prijs Test 3")

                    'test 4 : soortgroep en klantgroep specifiek rang 4
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        Dim koperfound As Boolean = False
                        If prijzen(i).klantgroep > 0 Then
                            For j = 1 To UBound(kopergroepEANs)
                                If prijzen(i).klantgroep = kopergroepEANs(j).id And koper_ean = kopergroepEANs(j).ean Then
                                    koperfound = True
                                    Exit For
                                End If
                            Next


                            If prijzen(i).soort >= 20000 And koperfound = True Then
                                For j = 1 To UBound(soortgroepids)
                                    If ((prijzen(i).soort - 20000) = soortgroepids(j).id) And (soortid = soortgroepids(j).soortmixid) Then
                                        If rang > 4 And check_actie_datum(prijzen(i).id, datum) = True Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            actie_type = prijzen(i).actie_type
                                            count = count + 1
                                            rang = 4
                                            Exit For
                                        End If
                                    End If
                                Next

                            End If
                        End If
                    End If

                    'TimePassed("Zoek prijs Test 4")

                    'test 5 : soort specifiek .. rang 5
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).soort = soortid And prijzen(i).klantgroep = 0 And prijzen(i).klant = "0000000000000" Then

                            If rang > 5 Then
                                soortprijs = fetchprijs(prijzen(i).id, datum)
                                actie_type = prijzen(i).actie_type
                                count = count + 1
                                rang = 5
                            End If
                        End If
                    End If

                    'TimePassed("Zoek prijs Test 5")

                    'test 6 : soortgroep rang 6
                    If prijzen(i).actief = True And prijzen(i).accessoire = False And prijzen(i).algemeen = True Then
                        If prijzen(i).soort >= 20000 And prijzen(i).klantgroep = 0 And prijzen(i).klant = "0000000000000" Then
                            For j = 1 To UBound(soortgroepids)
                                If ((prijzen(i).soort - 20000) = soortgroepids(j).id) And (soortid = soortgroepids(j).soortmixid) Then
                                    If rang > 6 Then
                                        soortprijs = fetchprijs(prijzen(i).id, datum)
                                        count = count + 1
                                        actie_type = prijzen(i).actie_type
                                        rang = 6
                                    End If
                                End If
                            Next


                        End If
                    End If

                End If


            Next i



        End If

        If soortprijs <= 0 Then   'gewone lijst doorzoeken, skip acties


            For i = 0 To UBound(prijzen)

                If prijzen(i).actienummer = "" Or prijzen(i).actienummer = "L000" Then ' skip acties

                    'test 1 : soort en klant specifiek .. rang 1 
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then

                        If prijzen(i).klant = koper_ean Then
                            If prijzen(i).soort = soortid Then
                                If rang > 1 And check_actie_datum(prijzen(i).id, datum) = True Then
                                    soortprijs = fetchprijs(prijzen(i).id, datum)
                                    actie_type = prijzen(i).actie_type
                                    count = count + 1
                                    rang = 1

                                End If
                            End If
                        End If
                    End If


                    'test 2 : soort en klantgroep specifiek .. rang 2
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).soort = soortid Then
                            If prijzen(i).klantgroep > 0 Then
                                If soortid = 15 Then
                                    Dim dum As Integer = 0
                                End If
                                For j = 1 To UBound(kopergroepEANs)
                                    If prijzen(i).klantgroep = kopergroepEANs(j).id And koper_ean = kopergroepEANs(j).ean Then
                                        If rang > 2 And check_actie_datum(prijzen(i).id, datum) = True Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            actie_type = prijzen(i).actie_type
                                            count = count + 1
                                            rang = 2
                                            Exit For
                                        End If
                                    End If
                                Next



                            End If
                        End If
                    End If

                    'TimePassed("Zoek prijs Test 2")

                    'test 3 : soortgroep en klant specifiek rang 3
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).klant = koper_ean Then
                            If prijzen(i).soort >= 20000 Then
                                For j = 1 To UBound(soortgroepids)
                                    If ((prijzen(i).soort - 20000) = soortgroepids(j).id) And (soortid = soortgroepids(j).soortmixid) Then
                                        If rang > 3 And check_actie_datum(prijzen(i).id, datum) = True Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            actie_type = prijzen(i).actie_type
                                            count = count + 1
                                            rang = 3
                                            Exit For
                                        End If
                                    End If
                                Next

                            End If
                        End If
                    End If

                    'TimePassed("Zoek prijs Test 3")

                    'test 4 : soortgroep en klantgroep specifiek rang 4
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        Dim koperfound As Boolean = False
                        If prijzen(i).klantgroep > 0 Then
                            For j = 1 To UBound(kopergroepEANs)
                                If prijzen(i).klantgroep = kopergroepEANs(j).id And koper_ean = kopergroepEANs(j).ean Then
                                    koperfound = True
                                    Exit For
                                End If
                            Next


                            If prijzen(i).soort >= 20000 And koperfound = True Then
                                For j = 1 To UBound(soortgroepids)
                                    If ((prijzen(i).soort - 20000) = soortgroepids(j).id) And (soortid = soortgroepids(j).soortmixid) Then
                                        If rang > 4 And check_actie_datum(prijzen(i).id, datum) = True Then
                                            soortprijs = fetchprijs(prijzen(i).id, datum)
                                            actie_type = prijzen(i).actie_type
                                            count = count + 1
                                            rang = 4
                                            Exit For
                                        End If
                                    End If
                                Next

                            End If
                        End If
                    End If

                    'TimePassed("Zoek prijs Test 4")

                    'test 5 : soort specifiek .. rang 5
                    If prijzen(i).actief = True And prijzen(i).accessoire = False Then
                        If prijzen(i).soort = soortid And prijzen(i).klantgroep = 0 And prijzen(i).klant = "0000000000000" Then

                            If rang > 5 Then
                                soortprijs = fetchprijs(prijzen(i).id, datum)
                                actie_type = prijzen(i).actie_type
                                count = count + 1
                                rang = 5
                            End If
                        End If
                    End If

                    'TimePassed("Zoek prijs Test 5")

                    'test 6 : soortgroep rang 6
                    If prijzen(i).actief = True And prijzen(i).accessoire = False And prijzen(i).algemeen = True Then
                        If prijzen(i).soort >= 20000 And prijzen(i).klantgroep = 0 And prijzen(i).klant = "0000000000000" Then
                            For j = 1 To UBound(soortgroepids)
                                If ((prijzen(i).soort - 20000) = soortgroepids(j).id) And (soortid = soortgroepids(j).soortmixid) Then
                                    If rang > 6 Then
                                        soortprijs = fetchprijs(prijzen(i).id, datum)
                                        count = count + 1
                                        actie_type = prijzen(i).actie_type
                                        rang = 6
                                    End If
                                End If
                            Next


                        End If
                    End If

                End If


            Next i

        End If

        If soortprijs > 0 Then
            Dim extraprijs As Double = GetExtraPrijs(koper_ean)
            soortprijs = soortprijs + extraprijs
        End If

        If soortprijs < 0 Then soortprijs = 0
        If Val(koper_ean) < 1010 Then 'klok 
            prijskleur = 0
            If count > 1 Then
                prijskleur = 2
            End If
        Else
            If soortprijs = 0 Then
                prijskleur = 1
            End If
            If count > 1 Then
                prijskleur = 2
            End If
        End If

        If geen_jenp = False Then
            If soortprijs = 0 And jenptenhave = True Then
                prijskleur = 0
                soortprijs = ZoekPrijsJenP(soortid, koper_ean, datum, prijskleur, actie_type)
                'Return soortprijs
            End If
        End If

        Return soortprijs
    End Function
    Private Function GetExtraPrijs(ByVal koper_ean As String) As Double
        Dim extra_prijs As Double = 0

        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select stikkeropslag from klanten where ean ='" + koper_ean + "'"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    extra_prijs = CHdouble(Reader("stikkeropslag"))
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (extra prijs)" + ex.Message)
            MessageBox.Show("Database fout: (extra prijs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Return extra_prijs

    End Function
    Private Function check_actie_datum(ByVal prijs_id As Integer, ByVal datum As Date) As Boolean
        '***************************************************
        ' TEST OF ACTIE VERLOPEN IS
        ' gebruikt door 'zoekprijs'
        '***************************************************
        Dim check As Boolean = False

        'Dim Reader As OdbcDataReader
        'Dim cmdstring As String
        'Dim yyyyMMdd As String = datum.ToString("yyyy/MM/dd")
        'cmdstring = "SELECT * FROM prijzen_datumlijst where id = " + Str(prijs_id) + " AND datum > '" + yyyyMMdd + "' ORDER BY datum DESC"
        'Try
        '    Using Conn As New OdbcConnection(ConnString)
        '        Conn.Open()

        '        'Execute Query
        '        Dim Cmd As New OdbcCommand(cmdstring, Conn)
        '        Reader = Cmd.ExecuteReader()
        '        If Reader.HasRows Then
        '            check = True
        '        Else
        '            check = False
        '        End If

        '    End Using
        'Catch ex As Exception
        '    ErrorLog("Database fout: (acktie check)" + ex.Message)
        '    MessageBox.Show("Database fout: (actie check)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        'End Try
        For j = 1 To UBound(prijzendatumlijst)
            If prijs_id = prijzendatumlijst(j).id And prijzendatumlijst(j).datum.Date > datum.Date Then
                check = True
                Exit For
            End If
        Next j


        Return check
    End Function
    Private Function ZoekSoortCode(ByVal type As String, ByVal soortid As Integer) As Integer

        '***************************************************
        ' S-CODES vertalen 
        ' gebruikt in Load_favorites
        '***************************************************

        Dim soortcode As Integer = 0
        If soortid < 10000 Then
            For i = 1 To UBound(soorten)
                If soorten(i).id = soortid Then
                    Select Case type
                        Case "bbrijpheid"
                            soortcode = soorten(i).bbrijpheid
                        Case "bbhoogte"
                            soortcode = soorten(i).bbhoogte
                        Case "bbdiameter"
                            soortcode = soorten(i).bbdiameter
                        Case "klokrijpheid"
                            soortcode = soorten(i).klokrijpheid
                        Case "klokhoogte"
                            soortcode = soorten(i).klokhoogte
                        Case "klokdiameter"
                            soortcode = soorten(i).klokdiameter
                        Case "transporthoogte"
                            soortcode = soorten(i).transporthoogte
                        Case "potmaat"
                            soortcode = soorten(i).potmaat
                        Case "vestiging"
                            soortcode = soorten(i).vestiging
                    End Select
                    Exit For
                End If
            Next i
        End If
        If soortid >= 10000 And soortid < 20000 Then
            For i = 1 To UBound(mixen)
                If mixen(i).id = (soortid - 10000) Then
                    Select Case type
                        Case "bbrijpheid"
                            soortcode = mixen(i).rijpheid
                        Case "bbhoogte"
                            soortcode = mixen(i).hoogte
                        Case "bbdiameter"
                            soortcode = mixen(i).diameter
                        Case "klokrijpheid"
                            soortcode = mixen(i).rijpheid
                        Case "klokhoogte"
                            soortcode = mixen(i).hoogte
                        Case "klokdiameter"
                            soortcode = mixen(i).diameter
                        Case "transporthoogte"
                            soortcode = mixen(i).transporthoogte
                        Case "potmaat"
                            soortcode = mixen(i).potmaat
                        Case "vestiging"
                            soortcode = mixen(i).vestiging
                    End Select
                    Exit For
                End If
            Next i
        End If
        Return soortcode
    End Function
    Private Function ZoekFust(ByVal fustid As Integer, ByVal soortid As Integer) As Integer
        '***************************************************
        ' FUST bepalen 
        ' gebruikt in Load_favorites
        '***************************************************
        If soortid < 10000 Then
            For i = 1 To UBound(soorten)
                If soorten(i).id = soortid Then
                    If soorten(i).vastefustcode > 0 Then
                        fustid = soorten(i).vastefustcode
                        Exit For
                    End If
                End If
            Next i
        End If
        If soortid >= 10000 And soortid < 20000 Then
            For i = 1 To UBound(mixen)
                If mixen(i).id = (soortid - 10000) Then
                    fustid = mixen(i).fust
                    Exit For
                End If
            Next i
        End If
        Return fustid
    End Function
    Private Sub OrdersMenuNieuw_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrdersMenuNieuw.Click
        '***************************************************
        ' Nieuwe order aanmaken 
        '***************************************************

        Dim aantalcol As Integer = FindCol(Order_invoer_FlexGrid, "Aantal")

        SetComboIndex(Vervoer_Vervoerder_cmb, 1)  'set de winter default in vervoer sheet
        'reset klok order sheet
        ResetOrderinvoer()

        Order_invoer_FlexGrid.Item(0, aantalcol) = "Aantal"
        Order_aanvulling_chk.Tag = "System"
        Order_aanvulling_chk.Checked = False
        Order_aanvulling_chk.Tag = "0"
        Order_aanvulling_chk.Text = "Aanvulling"

        For j = 0 To 8  '10 scans  'clear opmerking tabs 
            For i = 0 To Order_OpmTab.TabPages.Count - 1   'remove koper tab
                If Order_OpmTab.TabPages(i).Tag = "koper" Then
                    Order_OpmTab.TabPages.RemoveAt(i)
                    Exit For
                End If
            Next i
        Next j
        user_date_change = False
        Order_MonthCalendar.SelectionStart = Now
        Order_MonthCalendar.SelectionEnd = Now

        'Order_MonthCalendar.SelectionEnd = OrderDateTimePicker.Value
        user_date_change = True

        Order_id_lbl.Text = "0"
        Order_ean_lbl.Text = "0000000000000"
        Order_admnr_txt.Text = ""
        TabOrdersPanelTop.Enabled = True
        Order_OpmTab.Enabled = True
        Order_invoer_FlexGrid.Enabled = True
        Order_koper_combo.Text = ""
        OrderDateTimePicker.Value = Now


        order_date = OrderDateTimePicker.Value

        Order_prijsopslag_txt.Text = "0.00"
        Order_OpmOrderinfo_txt.Text = ""
        Order_Pakboninfo_txt.Text = ""
        Order_opmerking_txt.Text = ""
        order_contacts_combo.Text = ""
        If Val(Mid(TimeOfDay, 1, 2)) < 12 Then
            Order_Aflevertijd_combo.Text = "12:00"
        Else
            Order_Aflevertijd_combo.Text = "17:00"
        End If
        Order_koper_combo.Focus()
        ' Order_invoer_FlexGrid.BeginUpdate()
        Order_invoer_FlexGrid.Rows.Count = 1
        'Load_Favorites(1, 1, False)
        'Order_invoer_FlexGrid.Focus()
        'Order_invoer_FlexGrid.Select(1, 2, 1, 2)
        'Order_invoer_FlexGrid.EndUpdate()
        Order_versie_lbl.Text = "0"

        Order_reservering_chk.Checked = False

        Order_Slot_Chk.Enabled = False
        Order_Slot_Chk.Tag = "System"
        Order_Slot_Chk.Checked = False
        Order_Slot_Chk.Tag = ""

        'C1Tab.SelectedTab = C1Tab.TabPages(0)
        SetTabPage("Order invoer")

        Order_Opslaan_but.Enabled = True



    End Sub
    Private Sub Order_invoer_FlexGrid_CellButtonClick(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Order_invoer_FlexGrid.CellButtonClick



        If e.Col = pluscol Then
            '***************************************************
            ' ORDERREGEL KOPIEREN NA CLICK op kolom 1
            '***************************************************
            With Order_invoer_FlexGrid
                .Rows.Insert(e.Row)
                Dim j As Integer
                For j = 0 To .Cols.Count - 1
                    .Item(e.Row, j) = .Item(e.Row + 1, j)
                Next
                .Item(e.Row + 1, aantalcol) = 0  ' aantal
                .Item(e.Row + 1, 0) = 0  ' id 
                .Select(e.Row + 1, aantalcol, e.Row + 1, aantalcol)

                .Rows(e.Row).Style = .Styles("RowColor")
                .Rows(e.Row + 1).Style = .Styles("Default")

            End With
        End If

        '************************************************************
        ' LABELCODE INVOER
        '************************************************************
        If e.Col = labelcol Then

            StickerType_cmb.SelectedIndex = 1

            If IsNothing(Order_invoer_FlexGrid.Item(e.Row, aantalcol)) Then
                MsgBox("Vul eerst het aantal planten in")
                Exit Sub
            End If
            Dim labelnummerstr As String = Order_invoer_FlexGrid.Item(e.Row, labelcol)
            Dim labelnummer As Integer = Val(labelnummerstr)

            Dim soort_id As Integer = Order_invoer_FlexGrid.Item(e.Row, soortcol)
            Dim soort As String = soorten(GID(soorten, soort_id)).soortnaam
            Dim aantal As Integer = Order_invoer_FlexGrid.Item(e.Row, aantalcol)
            Dim fust_id As Integer = Order_invoer_FlexGrid.Item(e.Row, fustcol)
            Dim koper_ean As String = Order_ean_lbl.Text
            Dim koper_naam As String = Order_koper_combo.Text
            Dim opmerking As String = Order_invoer_FlexGrid.Item(e.Row, opmerkingcol)
            Dim accessoire1 As Integer = Val(Order_invoer_FlexGrid.Item(e.Row, acce1col))


            Dim accessoire1naam As String = ""
            If accessoire(GID(accessoire, accessoire1)).fust > 0 Then
                accessoire1naam = accessoire(GID(accessoire, accessoire1)).naam
            End If

            LabelWindow.Init(labelnummer, soort_id, aantal, fust_id, e.Row, koper_ean, koper_naam, opmerking, accessoire1naam, 0)
            'LabelWindow.TopMost = True
            LabelWindow.Show()
            'global labeledit


        End If

        '************************************************************
        ' FOTO INVOER
        '************************************************************
        If e.Col = fotocol Then
            Dim FotoTradeItemDBId As Integer = 0
            Dim soortmixid As Integer = 0
            Try
                soortmixid = CHint(Order_invoer_FlexGrid.GetData(e.Row, FindCol(Order_invoer_FlexGrid, "Soort")))
            Catch ex As Exception

            End Try
            If soortmixid = 0 Then
                MsgBox("Selecteer eerst een soort")
                Exit Sub
            End If

            If soortmixid < 10000 Then
                For i = 0 To UBound(soorten) - 1
                    If soorten(i).id = soortmixid Then
                        FotoTradeItemDBId = soorten(i).tradeitemklok
                        Exit For
                    End If
                Next
            Else
                For i = 0 To UBound(mixen) - 1
                    If mixen(i).id = soortmixid - 10000 Then
                        FotoTradeItemDBId = mixen(i).tradeitemklok
                        Exit For
                    End If
                Next
            End If
            If FotoTradeItemDBId = 0 Then
                MsgBox("Dit soort heeft geen klok-tradeitem")
                Exit Sub
            End If

            If FotoTradeItemDBId > 0 Then
                Form15.FotoTradeItemDBId = FotoTradeItemDBId

                Dim rijpheid As Integer = 0
                Dim fustid As Integer = 0
                Dim Hoes As Integer = 0
                Dim Hoogte As Integer = 0
                Dim Diameter As Integer = 0
                Dim Schermen As Integer = 0
                Dim Keurcode As Integer = 0
                Dim fotopath As String = ""

                Try
                    rijpheid = CHint(Order_invoer_FlexGrid.GetData(e.Row, rijpheidcol))
                    fustid = CHint(Order_invoer_FlexGrid.GetData(e.Row, fustcol))
                    Hoes = CHint(Order_invoer_FlexGrid.GetData(e.Row, hoescol))
                    Hoogte = CHint(Order_invoer_FlexGrid.GetData(e.Row, hoogtecol))
                    Diameter = CHint(Order_invoer_FlexGrid.GetData(e.Row, diametercol))
                    Schermen = CHint(Order_invoer_FlexGrid.GetData(e.Row, schermencol))
                    Keurcode = CHint(Order_invoer_FlexGrid.GetData(e.Row, keurcodecol))
                    fotopath = CHstr(Order_invoer_FlexGrid.GetData(e.Row, fotocol))

                Catch ex As Exception
                End Try

                    Form15.rijpheid = rijpheid
                Form15.fustcode = fust(GID(fust, fustid)).fustcode
                Form15.hoogte = Hoogte
                Form15.diameter = Diameter
                Form15.schermen = Schermen
                Form15.keurcode = Keurcode
                Form15.flexgridrow = e.Row
                Form15.flexgridcol = fotocol
                Form15.exportgrid = 2
                Form15.fotopath = fotopath

                Form15.StartPosition = FormStartPosition.CenterScreen
                Form15.Show()
            End If

        End If

        '************************************************************
        ' AANBOD REFERENTIE
        '************************************************************
        If e.Col = floridaynrcol Then

            C1TabOrderInvoer.Enabled = False
            C1TabKarindeling.Enabled = True
            C1TabFloriday.Enabled = True
            C1TabFlorecom.Enabled = False
            C1TabVervoer.Enabled = False
            C1TabOverzichten.Enabled = False
            C1TabInloggen.Enabled = False
            C1TabDatabase.Enabled = False
            C1TabInstellingen.Enabled = False
            C1TabVoorraad.Enabled = False
            C1TabPrijzen.Enabled = False
            C1TabWPS.Enabled = False
            SetupFloridayGrid()
            Floriday_Calendar.SelectionStart = Now.Date
            Floriday_Calendar.SelectionEnd = Now.Date
            Fd_archief_rb.Checked = True

            Dim orderline As Integer = CHint(Order_invoer_FlexGrid.GetData(e.Row, 0))   'col 0 = id col
            FloridayOrdersShow(orderline)


        End If



    End Sub
    Private Sub Order_veilingbrief_combo_SelectedValueChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles Order_veilingbrief_combo.SelectedValueChanged
        '***************************************************
        ' ADM.NR veranderen bij veilingbrief verandering
        '***************************************************

        Dim Reader As OdbcDataReader

        Dim CmdString As String = "select * from klanten where ean ='" + Order_ean_lbl.Text + "'"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    If Order_veilingbrief_combo.SelectedValue = 1 Then
                        Order_admnr_txt.Text = CHstr(Reader("veilingnr_westland"))
                    End If
                    If Order_veilingbrief_combo.SelectedValue = 2 Then
                        Order_admnr_txt.Text = CHstr(Reader("veilingnr_vba"))
                    End If
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (veilingbriefcombo)" + ex.Message)
            MessageBox.Show("Database fout: (veilingbriefcombo)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub ResetOrderinvoer()
        ' For i = 1 To 27
        ' Order_invoer_FlexGrid.Cols(i).Visible = True
        ' Next
        overgooier = ""
    End Sub
    Private Sub Order_koper_combo_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles Order_koper_combo.KeyDown

        '***************************************************
        ' KOPER DATA inladen na ENTER 
        '***************************************************


        If e.KeyCode = 13 Then


            Dim koper_naam As String = Order_koper_combo.SelectedText
            Dim count As Int16 = Order_koper_combo.SelectedIndex
            Dim koper_ean As String = DirectCast(DirectCast(Order_koper_combo.SelectedItem, System.Object), System.Data.DataRowView).Item(0)

            Order_ean_lbl.Text = Trim(koper_ean)

            ' laad koper instellingen

            'setup ordergrid klok orders
            'If jenptenhave = True Then
            ' If Mid(koper_ean, 1, 4) = "0000" Then  'klokorders
            ' With Order_invoer_FlexGrid
            ' .Cols(10).Visible = False
            ' .Cols(12).Visible = False
            ' .Cols(13).Visible = False
            ' .Cols(22).Visible = False
            ' .Cols(13).Visible = False
            ' .Cols(23).Visible = False

            ' End With
            ' Else
            ' ResetOrderinvoer()
            ' End If
            'End If


            Dim Reader As OdbcDataReader
            Dim CmdString As String = "select * from klanten where ean ='" + koper_ean + "'"
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'Execute Query
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read()
                        Order_koper_combo.Text = CHstr(Reader("klantnaam"))
                        Order_bakstikkers_chk.Checked = CHbool(Reader("bakstikker"))
                        SetComboIndex(Order_veilingbrief_combo, Reader("veiling_voorkeur"))
                        If Order_veilingbrief_combo.SelectedValue = 1 Then
                            Order_admnr_txt.Text = CHstr(Reader("veilingnr_westland"))
                        End If
                        If Order_veilingbrief_combo.SelectedValue = 2 Then
                            Order_admnr_txt.Text = CHstr(Reader("veilingnr_vba"))
                        End If
                        SetComboIndex(Order_afleverloc_combo, CHint(Reader("bdo")))
                        SetComboIndex(Order_kar_combo, CHint(Reader("kar_voorkeur")))
                        SetComboIndex(Order_vervoerder_combo, CHint(Reader("vervoerder")))
                        ' SetComboIndex(Order_fust_combo, CHint(Reader("fust_voorkeur")))
                        SetComboIndex(Order_hoescat_cmb, CHint(Reader("hoescategorie")))
                        SetComboIndex(Order_fustcat_cmb, CHint(Reader("fustcategorie")))

                        Dim default_accessoire As Integer = CHint((Reader("decorum")))

                        If IsDecorum(koper_ean) > 0 Then
                            Order_Decorum_chk.Checked = True
                        Else
                            Order_Decorum_chk.Checked = False
                        End If

                        StickerType_cmb.SelectedIndex = CHint(Reader("stikker"))

                        'Order_Decorum_chk.Tag = Str(CHint((Reader("decorum"))))
                        Order_prijsopslag_txt.Text = CHstr(Reader("stikkeropslag"))
                        'Order_opmerking_txt.Text = Reader("opmerking")

                        order_contacts_combo.Text = "-"  'gebruikt voor florecom nr's 


                    Loop
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (koper_combokeydown)" + ex.Message)
                MessageBox.Show("Database fout: (koper_combokeydown)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

            verwerk_opmerkingen(koper_ean)

            '  set focus sheet
            If Mid(koper_ean, 1, 12) = "900000000000" Then  'verzamelkar
                Order_invoer_FlexGrid.Enabled = False
            Else

                Order_invoer_FlexGrid.Enabled = True
                Order_koper_combo.DroppedDown = False
                Load_Favorites(1, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
                Order_invoer_FlexGrid.Focus()
                Try
                    Dim aantalcol As Integer = FindCol(Order_invoer_FlexGrid, "Aantal")
                    Order_invoer_FlexGrid.Select(1, aantalcol, 1, aantalcol)
                Catch ex As Exception

                End Try
            End If
            BoekStatus = 8
            Update_Boek(1, koper_ean)
        End If
    End Sub

    Private Sub verwerk_opmerkingen(ByVal koper_ean As String, Optional ByVal aanpassen As Boolean = False)


        For j = 0 To 8  '10 scans  'clear opmerking tabs 
            For i = 0 To Order_OpmTab.TabPages.Count - 1   'remove koper tab
                If Order_OpmTab.TabPages(i).Tag = "koper" Then
                    Order_OpmTab.TabPages.RemoveAt(i)
                    Exit For
                End If
            Next i
        Next j

        Dim contact_string As String = "-;0"    ' naam;id%naam2;id2  etc
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from klanten where ean ='" + koper_ean + "'"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()

                    Order_opmerking_txt.Text = CHstr(Reader("opmerking"))

                    Dim klantopmerking As String = CHstr(Reader("opmerking"))
                    If klantopmerking <> "" And aanpassen = False Then
                        Dim searchstring = klantopmerking.ToLower
                        Dim position1 As Integer = InStr(1, searchstring, "tijd:")
                        If position1 > 0 Then
                            Dim position2 As Integer = InStr(position1, searchstring, vbCrLf)
                            If position2 = 0 Then position2 = Len(klantopmerking)
                            Dim defaulttijd As String = Mid(klantopmerking, position1 + 5, position2 - position1)

                            Dim timearray() As String = defaulttijd.Split(":")
                            If UBound(timearray) = 1 Then
                                Dim hours As Integer = Val(timearray(0))
                                Dim minutes As Integer = Val(timearray(1))
                                If hours >= 0 And hours <= 23 And minutes <= 0 And minutes <= 59 Then

                                    Dim order_datum As Date = OrderDateTimePicker.Value.ToShortDateString
                                    Dim order_datumtijd = Date.Parse(order_datum + " " + Trim(defaulttijd))

                                    If order_datumtijd > Now Then
                                        Order_Aflevertijd_combo.Text = Trim(defaulttijd)
                                    End If


                                End If

                            End If

                        End If

                    End If

                    contact_string = CHstr(Reader("opmerking_contacts"))

                    'Order_OpmOrderinfo_txt.Text = Trim(CHstr(Reader("opmerking")))
                    'Order_Pakboninfo_txt.Text = Trim(CHstr(Reader("pakbon_opmerking")))


                    If Trim(Order_opmerking_txt.Text) <> "" And Order_OpmOrderinfo_txt.Text = "" Then
                        Order_OpmTab.SelectedTab = Order_OpmTab.TabPages(0)
                    ElseIf Order_OpmOrderinfo_txt.Text <> "" Then
                        Order_OpmTab.SelectedTab = Order_OpmTab.TabPages(1)
                    Else
                        Order_OpmTab.SelectedTab = Order_OpmTab.TabPages(2)
                    End If


                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (koper_combokeydown)" + ex.Message)
            MessageBox.Show("Database fout: (koper_combokeydown)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Dim contacts() As String = Microsoft.VisualBasic.Strings.Split(contact_string, "%")
        If UBound(contacts) > 0 Then
            Dim tabcounter As Integer = 1

            Dim Reader2 As OdbcDataReader

            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    For i = 1 To UBound(contacts)
                        Dim contact_data() As String = Microsoft.VisualBasic.Strings.Split(contacts(i), ";")
                        Dim naam As String = contact_data(0)
                        Dim id As String = contact_data(1)
                        If tabcounter < 9 Then
                            Order_OpmTab.TabPages.Insert(3, kopertab(i - 1))
                            Order_OpmTab.TabPages(3).Text = naam
                            Dim CmdString2 As String = "select * from contact_opmerkingen where id =" + id
                            Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                            Reader2 = Cmd2.ExecuteReader()
                            If Reader2.HasRows Then
                                Reader2.Read()
                                Select Case tabcounter
                                    Case 1
                                        Order_OpmKoper1_txt.Text = CHstr(Reader2("opmerking"))
                                        Order_OpmKoper1_txt.Tag = id
                                    Case 2
                                        Order_OpmKoper2_txt.Text = CHstr(Reader2("opmerking"))
                                        Order_OpmKoper2_txt.Tag = id
                                    Case 3
                                        Order_OpmKoper3_txt.Text = CHstr(Reader2("opmerking"))
                                        Order_OpmKoper3_txt.Tag = id
                                    Case 4
                                        Order_OpmKoper4_txt.Text = CHstr(Reader2("opmerking"))
                                        Order_OpmKoper4_txt.Tag = id
                                    Case 5
                                        Order_OpmKoper5_txt.Text = CHstr(Reader2("opmerking"))
                                        Order_OpmKoper5_txt.Tag = id
                                    Case 6
                                        Order_OpmKoper6_txt.Text = CHstr(Reader2("opmerking"))
                                        Order_OpmKoper6_txt.Tag = id
                                    Case 7
                                        Order_OpmKoper7_txt.Text = CHstr(Reader2("opmerking"))
                                        Order_OpmKoper7_txt.Tag = id
                                    Case 8
                                        Order_OpmKoper8_txt.Text = CHstr(Reader2("opmerking"))
                                        Order_OpmKoper8_txt.Tag = id
                                End Select
                            End If
                        End If
                        tabcounter = tabcounter + 1
                    Next

                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (koper_combokeydown)" + ex.Message)
                MessageBox.Show("Database fout: (koper_combokeydown)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

        End If

    End Sub
    Private Sub Order_admnr_txt_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles Order_admnr_txt.KeyDown

        '***************************************************
        ' Koperdata inladen na enter op ADM.NR.
        '***************************************************
        If e.KeyCode = 13 Then

            Dim Reader As OdbcDataReader
            Dim koper_ean As String = "0000000000000"
            Dim CmdString As String = "select * from klanten where veilingnr_westland =" + Trim(Order_admnr_txt.Text) + " or veilingnr_vba =" + Trim(Order_admnr_txt.Text)
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'Execute Query
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        koper_ean = CHstr(Reader("ean"))
                        Order_koper_combo.Text = CHstr(Reader("klantnaam"))
                    Else
                        Exit Sub
                    End If
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (admnr keydown)" + ex.Message)
                MessageBox.Show("Database fout: (admnr keydown)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

            'Dim koper_naam As String = Order_koper_combo.SelectedText
            'Dim count As Int16 = Order_koper_combo.SelectedIndex
            'Dim koper_ean As String = DirectCast(DirectCast(Order_koper_combo.SelectedItem, System.Object), System.Data.DataRowView).Item(0)

            Order_ean_lbl.Text = Trim(koper_ean)

            ' laad koper instellingen

            CmdString = "select * from klanten where ean ='" + koper_ean + "'"
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'Execute Query
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read()
                        SetComboIndex(Order_veilingbrief_combo, CHint(Reader("veiling_voorkeur")))
                        If Order_veilingbrief_combo.SelectedValue = 1 Then
                            Order_admnr_txt.Text = CHstr(Reader("veilingnr_westland"))
                        End If
                        If Order_veilingbrief_combo.SelectedValue = 2 Then
                            Order_admnr_txt.Text = CHstr(Reader("veilingnr_vba"))
                        End If
                        SetComboIndex(Order_afleverloc_combo, CHint(Reader("bdo")))
                        SetComboIndex(Order_kar_combo, CHint(Reader("kar_voorkeur")))
                        SetComboIndex(Order_vervoerder_combo, CHint(Reader("vervoerder")))
                        ' SetComboIndex(Order_fust_combo, CHint(Reader("fust_voorkeur")))
                        Dim default_accessoire As Integer = CHint(Reader("decorum"))
                        SetComboIndex(Order_hoescat_cmb, CHint(Reader("hoescategorie")))
                        SetComboIndex(Order_fustcat_cmb, CHint(Reader("fustcategorie")))

                        If IsDecorum(koper_ean) > 0 Then
                            Order_Decorum_chk.Checked = True
                        Else
                            Order_Decorum_chk.Checked = False
                        End If

                        ' Order_Decorum_chk.Tag = Str(CHint(Reader("decorum")))
                        Order_prijsopslag_txt.Text = Format(CHint(Reader("stikkeropslag")), "#0.00")
                        Order_opmerking_txt.Text = CHstr(Reader("opmerking"))
                        Dim contacts() As String = Microsoft.VisualBasic.Strings.Split(CheckDBNull(Reader("contact")), ";")
                        'order_contacts_combo.Items.Clear()
                        'For i = 0 To UBound(contacts)
                        ' order_contacts_combo.Items.Add(contacts(i))
                        ' Next i
                        order_contacts_combo.Text = "-"
                    Loop
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (admnr keydown2)" + ex.Message)
                MessageBox.Show("Database fout: (admnr keydown2)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

            verwerk_opmerkingen(koper_ean)

            '  set focus sheet
            Load_Favorites(1, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
            Order_invoer_FlexGrid.Focus()
            Try
                Dim aantalcol As Integer = FindCol(Order_invoer_FlexGrid, "Aantal")
                Order_invoer_FlexGrid.Select(2, aantalcol, 2, aantalcol)
            Catch ex As Exception

            End Try


        End If
    End Sub
    Private Sub SetComboIndex(ByRef cb As ComboBox, ByVal value As Integer)
        '***************************************************
        ' Juiste selectie in combobox maken aan de hand van selectie
        ' gebruikt in Order_koper_combo_KeyDown
        '***************************************************
        Try
            With cb
                For i = 0 To .Items.Count - 1
                    If .Items(i)(0) = value Then
                        .SelectedIndex = i
                        Exit For
                    End If
                Next
            End With
        Catch ex As Exception

        End Try

    End Sub
    Private Sub Order_koper_combo_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles Order_koper_combo.KeyPress
        '***************************************************
        ' Auto-dropdown and Auto-complete van kopercombobox
        '***************************************************
        If Not e.KeyChar = Chr(13) Then
            Order_koper_combo.DroppedDown = True
        End If
        AutoComplete(Order_koper_combo, e, True)
    End Sub
    Private Sub Order_Opslaan_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Opslaan_but.Click
        order_opslaan_verdelen()
    End Sub
    Private Sub order_opslaan_verdelen()
        'dubbele order?
        Dim tweedevestiging As Boolean = False
        Dim vestigingnummer As Integer = 0


        With Order_invoer_FlexGrid
            For i = 1 To .Rows.Count - 1


                If .Item(i, aantalcol) > 0 Then  ' aantal > 0 ?

                    'prijs check bij bb
                    If Val(.Item(i, prijscol)) <= 0.01 And Val(Order_ean_lbl.Text) > 2000 Then
                        MsgBox("Bij een van de order-regels in de prijs niet ingevuld")
                        Exit Sub
                    End If


                    Dim vestigingline As Integer = .Item(i, vestigingcol)  'vestiging van line

                    If vestigingnummer = 0 Then
                        vestigingnummer = vestigingline
                    End If
                    If vestigingline <> vestigingnummer Then
                        'tweede vestiging gevonden
                        tweedevestiging = True
                        Exit For
                    End If

                End If
            Next i
        End With

        If vestigingnummer = 0 Then
            ' vestigingnummer = 1  ' verzamelkar heeft geen vestiging, altijd op locatie1 (kreekrug/haagkamp)
        End If

        'nieuw kopelnummer ophalen zodat orders die over twee vestingingen verdeelt zijn, nog steeds te koppelen zijn
        Dim koppelnummer As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim UnBCmdString As String = "select koppelnummer from instellingen"
                Dim UnBCmd As New OdbcCommand(UnBCmdString, Conn)
                Dim UnBReader As OdbcDataReader
                UnBReader = UnBCmd.ExecuteReader
                If UnBReader.HasRows Then
                    UnBReader.Read()
                    koppelnummer = CHint(UnBReader("koppelnummer"))
                End If
                koppelnummer = koppelnummer + 1
                UnBReader.Close()
                UnBCmd.CommandText = "UPDATE instellingen SET koppelnummer=?"
                UnBCmd.Parameters.Clear()
                UnBCmd.Parameters.AddWithValue("", koppelnummer)
                UnBCmd.ExecuteNonQuery()
            End Using
        Catch ex As Exception
            ErrorLog("Fout koppelnummer: " + ex.Message)
            MessageBox.Show("Fout koppelnummer:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        'OPSLAAN ORDER
        If tweedevestiging = True Then
            Order_Opslaan(1, False, koppelnummer)
            Order_Opslaan(2, True, koppelnummer)
        Else
            Order_Opslaan(vestigingnummer, False, koppelnummer)
        End If

    End Sub

    Private Sub Order_Opslaan(ByVal vestigingnummer As Integer, ByVal tweedevestiging As Boolean, ByVal koppelnummer As Integer)
        '***************************************************
        ' ORDER Opslaan
        '***************************************************


        Order_invoer_FlexGrid.Enabled = True

        ' checks (koper ingevuld en aantallen?)
        If Order_ean_lbl.Text = "0000000000000" Then Exit Sub

        If Mid(Order_ean_lbl.Text, 1, 12) = "900000000000" Then  'verzamelkar
            ' bij verzamelkar is aantal altijd leeg, toch opslaan
        Else
            'anders check op ingevulde aantallen
            Dim invoer As Boolean = False
            With Order_invoer_FlexGrid
                For i = 1 To .Rows.Count - 1
                    If .Item(i, aantalcol) > 0 Then  ' aantal > 0 ?
                        invoer = True
                        Exit For
                    End If
                Next i
            End With

            If invoer = False Then Exit Sub
        End If

        'GP check.. 1 orderline mogelijk per GP

        Dim Gpfound As Boolean = False
        Dim Gpaantal As Integer = 1
        Dim linecount As Integer = 0
        With Order_invoer_FlexGrid
            For i = 1 To .Rows.Count - 1
                If .Item(i, aantalcol) > 0 Then
                    linecount = linecount + 1
                    Gpaantal = .Item(i, GPcol)
                    If Gpaantal > 1 Then  ' GP > 1 ?
                        Gpfound = True
                    End If
                End If
            Next i
        End With
        If Gpfound = True And linecount > 1 Then
            MsgBox("Bij GP karren maximaal 1 orderline per order")
            Exit Sub
        End If



        ' check op labelcode om opmerking aan te vullen
        With Order_invoer_FlexGrid
            For i = 1 To .Rows.Count - 1
                If Val(.Item(i, labelcol)) > 0 Then  'labels ?
                    Dim check_al_aanwezig As String = ""
                    If Order_Pakboninfo_txt.Text <> "" Then
                        check_al_aanwezig = Mid(Order_Pakboninfo_txt.Text, Len(Order_Pakboninfo_txt.Text), 1)
                    End If
                    If check_al_aanwezig = ">" Then
                        'letop al aanwezig
                    Else
                        Order_Pakboninfo_txt.Text = Order_Pakboninfo_txt.Text + "<LET OP!!! STICKERS PLAKKEN>"
                    End If
                    Exit For
                End If
            Next i
        End With

        ' prevent further edit 
        If Not Mid(Order_ean_lbl.Text, 1, 12) = "900000000000" Then
            Try
                Order_invoer_FlexGrid.Select(2, 2, False)
            Catch ex As Exception
            End Try

        End If
        TabOrdersPanelTop.Enabled = False
        Order_OpmTab.Enabled = False
        Order_invoer_FlexGrid.Enabled = False
        OrdersMenuNieuw.Focus()

        ' databases selecteren 
        Dim orderheader_db As String
        Dim orderlines_db As String
        Dim orderyear As String
        Dim header_id As Integer


        header_id = Val(Order_id_lbl.Text)
        orderyear = Trim(Str(Year(order_date)))
        If staticyear = True Then orderyear = ""

        orderheader_db = "OrderHeaders" + orderyear
        orderlines_db = "OrderLines" + orderyear

        'check of de order door iemand anders is aangepast in de tussentijd 

        If header_id > 0 Then
            If Order_is_aangepast(Val(Order_versie_lbl.Text), orderheader_db, header_id) = True Then
                MsgBox("Deze order is aangepast in de tijd dat de order door u bewerkt werd, deze order kan niet worden opgeslagen, probeer opnieuw", vbOKOnly)
                Exit Sub
            End If
        End If


        ' write order header to database
        Dim Sticker As Integer = 0  '0 = Nee
        Dim cmdstring As String
        Dim klok As Boolean = False
        cmdstring = "SELECT * FROM " + orderheader_db + " WHERE 1=0"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                With Cmd
                    Dim neworder As Boolean = False
                    If header_id = 0 Or tweedevestiging = True Then
                        neworder = True
                    End If

                    If neworder = True Then   'nieuwe order
                        .CommandText = "INSERT INTO " + orderheader_db + "(afleverdatum,invoerdatumtijd,koper_ean,koper_naam,afleverloc,veilingbrief_id," _
                                        & "vervoerder_id,contact,opmerking,inlog_naam,prijs_opslag,agenda_mark,decorum,status,kar_id,versie,aanvulling,sticker,pakbon_opmerking,vestiging,koppelnummer,gpflags) " _
                                        & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                    Else   'veranderde order 
                        .CommandText = "UPDATE " + orderheader_db + " SET afleverdatum=?,koper_ean=?,koper_naam=?, afleverloc=?,veilingbrief_id=?,vervoerder_id=?," _
                                        & "contact=?,opmerking=?,inlog_naam=?,prijs_opslag=?,agenda_mark=?,decorum=?,status=?,kar_id=?,versie=?,aanvulling=?,sticker=?,pakbon_opmerking=?,vestiging=?,gpflags=? " _
                                        & "WHERE header_id = " + Trim(Str(header_id))
                    End If
                    .Parameters.Clear()
                    Dim EAN As Long = Val(Order_ean_lbl.Text)
                    Dim mydate As Date
                    Dim order_date As Date = OrderDateTimePicker.Value
                    If EAN >= 1000 And EAN <= 1059 Then
                        EAN = EAN - 1000
                        klok = True
                        mydate = Date.Parse(order_date.ToShortDateString & "  19:" & Format(EAN, "00") & ":00")
                    Else
                        mydate = Date.Parse(order_date.ToShortDateString & " " & Trim(Order_Aflevertijd_combo.Text) & ":00")
                    End If
                    If Order_reservering_chk.Checked = True Then
                        mydate = Date.Parse(order_date.ToShortDateString & " 23:59")
                    End If
                    .Parameters.AddWithValue("", mydate)                                            ' 1 afleverdatum
                    If neworder = True Then
                        .Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                    End If
                    .Parameters.AddWithValue("", Order_ean_lbl.Text)                                ' 4 koper_ean

                    'floriday check

                    .Parameters.AddWithValue("", Order_koper_combo.Text)                            ' 5 koper_naam
                    .Parameters.AddWithValue("", Order_afleverloc_combo.SelectedValue)              ' 6 afleverloc
                    .Parameters.AddWithValue("", Order_veilingbrief_combo.SelectedValue)            ' 7 veilingbrief id
                    .Parameters.AddWithValue("", Order_vervoerder_combo.SelectedValue)              ' 8 vervoerder id

                    If order_contacts_combo.Text.Length > 2 Then

                        Dim tabcount As Integer = Order_OpmTab.TabCount
                        If tabcount > 3 Then
                            For i = 3 To tabcount - 1
                                If Order_OpmTab.SelectedTab.Text = Order_OpmTab.TabPages(i).Text Then
                                    order_contacts_combo.Text = Order_OpmTab.TabPages(i).Text
                                End If
                            Next i
                        End If
                    End If


                    Sticker = StickerType_cmb.SelectedIndex
                    'Select Case StickerType_cmb.Text
                    '    Case "Ja" : Sticker = 1
                    '    Case "Voorbereiden (potcover/label)" : Sticker = 2
                    '    Case "Floraconnect" : Sticker = 3
                    '    Case "Floraconnect voorbereiden" : Sticker = 4
                    '    Case "Nep order voor stikkers" : Sticker = 5
                    '    Case "labelbericht voorbereiden" : Sticker = 6
                    '    Case "labelbericht op pot" : Sticker = 7
                    '    Case "Wachten op labelbericht" : Sticker = 8
                    '    Case "Document toevoegen" : Sticker = 9
                    '    Case "Document toevoegen+stickeren" : Sticker = 10
                    'End Select


                    .Parameters.AddWithValue("", Mid(order_contacts_combo.Text, 1, 99))             ' 9 contact
                    .Parameters.AddWithValue("", Order_OpmOrderinfo_txt.Text)                       '10 opmerking
                    .Parameters.AddWithValue("", Login_name)                                        '11 inlog_naam
                    .Parameters.AddWithValue("", Val(Order_prijsopslag_txt.Text))                   '12 prijs_opslag
                    If Order_reservering_chk.Checked = True Then
                        .Parameters.AddWithValue("", 2)                                             '13 agenda_mark
                    Else
                        .Parameters.AddWithValue("", 1)                                             '13 agenda_mark -> orders marked
                    End If
                    Dim decorum As Integer = IsDecorum(Order_ean_lbl.Text)
                    .Parameters.AddWithValue("", decorum)                         '14 decorum
                    If Order_reservering_chk.Checked = True Then
                        .Parameters.AddWithValue("", 98)                                            '15 status reservering, anders..
                    ElseIf Mid(Order_ean_lbl.Text, 1, 12) = "900000000000" Then                                    'verzamelkar
                        .Parameters.AddWithValue("", 55)
                    Else
                        If Sticker = 1 Or Sticker = 3 Or Sticker = 7 Or Sticker = 10 Then
                            .Parameters.AddWithValue("", 21)
                        ElseIf Sticker = 2 Or Sticker = 4 Or Sticker = 6 Then
                            .Parameters.AddWithValue("", 22)
                        ElseIf Sticker = 8 Then
                            .Parameters.AddWithValue("", 24)
                        ElseIf Sticker = 5 Then
                            .Parameters.AddWithValue("", 100)
                        Else
                            .Parameters.AddWithValue("", 20)
                        End If
                    End If
                    .Parameters.AddWithValue("", Order_kar_combo.SelectedValue)
                    If neworder = True Then
                        .Parameters.AddWithValue("", 0) 'versie nr = 0 voor nieuwe orders
                    Else
                        Dim versie As Integer = CInt(Val(Order_versie_lbl.Text))
                        versie = versie + 1                 'versienr ophogen voor aanpassingen
                        Order_versie_lbl.Text = Str(versie)
                        .Parameters.AddWithValue("", versie)
                    End If
                    If Order_aanvulling_chk.Checked = True Then
                        .Parameters.AddWithValue("", Val(Order_aanvulling_chk.Tag)) 'aanvulling
                    Else
                        .Parameters.AddWithValue("", 0) ' geen aanvulling
                    End If

                    .Parameters.AddWithValue("", Sticker)
                    .Parameters.AddWithValue("", Order_Pakboninfo_txt.Text)

                    .Parameters.AddWithValue("", vestigingnummer)
                    If neworder = True Then
                        .Parameters.AddWithValue("", koppelnummer)
                    End If
                    Dim gpstring As String = ""
                    For i = 1 To Gpaantal
                        gpstring = gpstring + "0"
                    Next
                    .Parameters.AddWithValue("", gpstring)

                    .ExecuteNonQuery()

                    If neworder = True Then  'if new header fetch header
                        If postgress = True Then
                            Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('orderheaders','header_id'))", Conn)
                            header_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                        Else
                            Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                            header_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                        End If
                    End If

                End With
            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag header: " + ex.Message)
            MsgBox("Fout orderopslag header: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        '****************************** ORDER LINES ************************************************************************

        Dim line_id As Integer

        With Order_invoer_FlexGrid

            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    For i = 1 To .Rows.Count - 1

                        'DELETE LINES?
                        If (.Item(i, aantalcol) = 0 And Val(.Item(i, 0)) > 0) Or (Val(.Item(i, 0)) > 0 And vestigingnummer = 1 And Val(.Item(i, vestigingcol)) = 2) Then   'orderline gewist of vestiging is aangepast in een regel?
                            line_id = Val(.Item(i, 0))
                            Dim DelString As String = "DELETE FROM " + orderlines_db + " WHERE OrderLine_id = " + Trim(Str(line_id))
                            Dim DelCmd As New OdbcCommand(DelString, Conn)
                            DelCmd.ExecuteNonQuery()
                            .Item(i, 0) = 0
                        End If

                        'NEW LINES 
                        If .Item(i, aantalcol) > 0 And .Item(i, vestigingcol) = vestigingnummer Then  ' aantal > 0 en vesting =1of2?

                            'Execute Query
                            cmdstring = "SELECT * FROM " + orderlines_db + " WHERE 1=0"
                            Dim Cmd As New OdbcCommand(cmdstring, Conn)

                            line_id = CVal(.Item(i, 0))
                            Dim labelberichtnr As Integer = CVal(.Item(i, labelcol))
                            Dim sdfbarcode As Integer = 0
                            If line_id = 0 Then   'nieuwe orderline

                                'Get new SDF barcode
                                Dim reader5 As OdbcDataReader
                                Dim Cmd2 As New OdbcCommand("SELECT sdfbarcode from instellingen", Conn)
                                reader5 = Cmd2.ExecuteReader()
                                If reader5.HasRows Then
                                    reader5.Read()
                                    sdfbarcode = CHint(reader5("sdfbarcode"))
                                    sdfbarcode = sdfbarcode + 1
                                    If sdfbarcode >= 100000000 Then sdfbarcode = 1
                                    reader5.Close()
                                    Cmd2.CommandText = "UPDATE instellingen SET sdfbarcode = ?"
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", sdfbarcode)
                                    Cmd2.ExecuteNonQuery()
                                End If


                                Cmd.CommandText = "INSERT INTO " + orderlines_db + "(OrderHeader_id,Koper_naam,Aantal,Soort_id,Fust_id,Prijs,GP,Rijpheid,Hoogte,Diameter," _
                                                & "Accessoire1,Accessoire2,Accessoire3,Accessoire4,Accessoire5,Kopercode,Potmaat,Wps_filternr,Vestiging,Opmerking,Keurcode,Transporthoogte,Florecom_nr,actie_type,Wps_filternr2,labelbericht_code,sdfbarcode,old_header_id, " _
                                                & "Accessoire6,Accessoire7,Accessoire8,Schermen,foto,supplyref,floridaynr) " _
                                                & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"

                            Else
                                'als labelberichtnr = 0 dan niet updaten ivm tussenkomende koppeling/sdfbarcode ook niet updaten
                                If labelberichtnr = 0 Then
                                    Cmd.CommandText = "UPDATE " + orderlines_db + " SET OrderHeader_id=?,Koper_naam=?,Aantal=?,Soort_id=?,Fust_id=?,Prijs=?,GP=?,Rijpheid=?," _
                                             & "Hoogte=?,Diameter=?,Accessoire1=?,Accessoire2=?,Accessoire3=?,Accessoire4=?,Accessoire5=?," _
                                             & "Kopercode=?,Potmaat=?,Wps_Filternr=?,Vestiging=?,Opmerking=?,Keurcode=?,Transporthoogte=?,Florecom_nr=?,actie_type=?,Wps_filternr2=?,old_header_id=?, " _
                                             & "Accessoire6=?,Accessoire7=?,Accessoire8=?,Schermen=?,foto=?,supplyref=?,floridaynr=? " _
                                             & "WHERE OrderLine_id = " + Trim(Str(line_id))

                                Else
                                    Cmd.CommandText = "UPDATE " + orderlines_db + " SET OrderHeader_id=?,Koper_naam=?,Aantal=?,Soort_id=?,Fust_id=?,Prijs=?,GP=?,Rijpheid=?," _
                                             & "Hoogte=?,Diameter=?,Accessoire1=?,Accessoire2=?,Accessoire3=?,Accessoire4=?,Accessoire5=?," _
                                             & "Kopercode=?,Potmaat=?,Wps_Filternr=?,Vestiging=?,Opmerking=?,Keurcode=?,Transporthoogte=?,Florecom_nr=?,actie_type=?,Wps_filternr2=?,labelbericht_code=?,old_header_id=?, " _
                                             & "Accessoire6=?,Accessoire7=?,Accessoire8=?,Schermen=?,foto=?,supplyref=?,floridaynr=? " _
                                             & "WHERE OrderLine_id = " + Trim(Str(line_id))

                                End If
                            End If
                            Cmd.Parameters.Clear()

                            Cmd.Parameters.AddWithValue("", header_id)                                      ' 1 orderheader_id 
                            Cmd.Parameters.AddWithValue("", CNStr(Order_koper_combo.Text))                     ' 2 koper_naam
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, aantalcol)))                       ' 3 aantal
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, soortcol)))                        ' 4 soort_id
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, fustcol)))                         ' 5 fust_id
                            Cmd.Parameters.AddWithValue("", DVal(.Item(i, prijscol)))                        ' 6 prijs
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, GPcol)))                           ' 7 GP

                            Dim rijpheid As Integer = CVal(.Item(i, rijpheidcol))
                            If rijpheid = 1 Then rijpheid = 11
                            If rijpheid = 2 Then rijpheid = 22
                            If rijpheid = 3 Then rijpheid = 33
                            If rijpheid = 4 Then rijpheid = 44
                            Cmd.Parameters.AddWithValue("", rijpheid)                                       ' 8 Rijpheid

                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, hoogtecol)))                               ' 9 hoogte
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, diametercol)))                              '10 Diameter
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, acce1col)))                              '11 Accessoire1
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, acce2col)))                              '12 Accessoire2
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, hoescol)))                               '13 Accessoire3/Hoes
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, acce4col)))                              '14 Accessoire4
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, acce5col)))                              '15 Accessoire5
                            Cmd.Parameters.AddWithValue("", CNStr(.Item(i, kopercodecol)))                                '16 kopercode
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, potmaatcol)) * 10)                         '17 potmaat
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, wpsfilter2col)))                              '18 wps filternr    

                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, vestigingcol)))                              '19 vestiging  

                            Cmd.Parameters.AddWithValue("", Mid(CNStr(.Item(i, opmerkingcol)), 1, 195))                      '21 Opmerking
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, keurcodecol)))                              '21 Keurcode
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, transporthoogtecol)))                              '22 Transporthoogte
                            Cmd.Parameters.AddWithValue("", CNStr(.Item(i, florecomnrcol)))                                 '23 Florecom_nr
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, actiecol)))                              '24 actie_type
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, wpsfilter3col)))                              '25 wps filternr2

                            If line_id = 0 Then
                                Cmd.Parameters.AddWithValue("", CVal(.Item(i, labelcol)))                          '15 labelcode
                                Cmd.Parameters.AddWithValue("", CNStr(sdfbarcode))                              ' sdfbarcode
                            Else
                                If labelberichtnr <> 0 Then Cmd.Parameters.AddWithValue("", CVal(.Item(i, labelcol))) '15 labelcode
                            End If


                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, oldheadercol)))                              '15 old header id

                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, acce6col)))
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, acce7col)))
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, acce8col)))
                            Cmd.Parameters.AddWithValue("", CVal(.Item(i, schermencol)))
                            Cmd.Parameters.AddWithValue("", CNStr(.Item(i, fotocol)))
                            Cmd.Parameters.AddWithValue("", CNStr(.Item(i, aanbodcol)))
                            Cmd.Parameters.AddWithValue("", CNStr(.Item(i, floridaynrcol)))
                            Cmd.ExecuteNonQuery()


                        End If
                    Next i

                    Dim floridayflag As Integer = 1
                    'update floridayflag
                    Dim cmd12 As New OdbcCommand("", Conn)
                    Dim reader12 As OdbcDataReader
                    cmd12.CommandText = "SELECT * from orderlines WHERE orderheader_id = " + Trim(Str(header_id))
                    reader12 = cmd12.ExecuteReader()
                    Do While reader12.Read
                        Dim FloridayNr As String = CHstr(reader12("Floridaynr"))
                        If FloridayNr = "" Then
                            floridayflag = 0
                        End If
                    Loop
                    reader12.Close()

                    If klok = True Then floridayflag = 1

                    If floridayflag = 1 Then
                        cmd12.CommandText = "UPDATE orderheaders SET floridayflag=1 WHERE header_id = " + Str(header_id)
                        cmd12.ExecuteNonQuery()
                    End If

                End Using
            Catch ex As Exception
                ErrorLog("Fout orderopslag lines: " + ex.Message)
                MsgBox("Fout orderopslag lines: " + ex.Message, MsgBoxStyle.OkOnly)
            End Try

        End With

        'karindeling aanmaken
        Maak_Karindeling(Order_Slot_Chk.Checked, Order_kar_combo.SelectedValue, header_id, order_date)


        'condense grid
        Dim irow As Integer = 1
        With Order_invoer_FlexGrid

            Dim flexrows As Integer = .Rows.Count - 1
            Do While irow < flexrows + 1
                If .Item(irow, aantalcol) = 0 Then  ' aantal > 0 ?
                    .Rows.Remove(irow)
                    flexrows = flexrows - 1
                Else
                    .Rows(irow).Style = .Styles("RowColor")
                    irow = irow + 1
                End If
            Loop
        End With
        '
        'Set_Boek_reload()
        'Update_Boek()
        'Update_Boek(1, koper_ean)
    End Sub
    Private Function CVal(value As Object) As Integer
        Dim returnval As Integer = 0
        Try
            If IsNothing(value) Then
                returnval = 0
            Else
                returnval = CInt(Val(value))
            End If
        Catch ex As Exception
            returnval = 0
        End Try

        Return returnval
    End Function
    Private Function DVal(value As Object) As Double
        Dim returnval As Double = 0
        Try
            If IsNothing(value) Then
                returnval = 0
            Else
                returnval = Val(value)
            End If
        Catch ex As Exception
            returnval = 0
        End Try

        Return returnval
    End Function
    Private Function CNStr(value As Object) As String
        Dim returnval As String = ""
        Try
            If IsNothing(value) Then
                returnval = ""
            Else
                returnval = CStr(value)
            End If
        Catch ex As Exception
            returnval = ""
        End Try

        Return returnval
    End Function
    Private Function Order_is_aangepast(ByVal versie_nr As Integer, ByVal orderheader_db As String, ByVal header_id As Integer) As Boolean
        'check of versienummers nog overeenkomen bij opslaan van order en/of karindeling 
        Dim is_aangepast As Boolean = False

        Dim Reader As OdbcDataReader
        Dim cmdstring As String = ""

        '** Datum range
        cmdstring = "SELECT versie FROM " + orderheader_db + " where header_id =" + Str(header_id)
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query

                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()

                    Dim versie As Integer = CHint(Reader("versie"))
                    If versie = versie_nr Then
                        is_aangepast = False
                    Else
                        is_aangepast = True
                    End If
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Fout orderaangepast check: " + ex.Message)
            MessageBox.Show("Order aangepast check:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return is_aangepast
    End Function
    Private Function Order_laad_versienr(ByVal header_id As Integer) As Integer

        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim Reader As OdbcDataReader
        Dim cmdstring As String = "SELECT versie FROM " + orderheader_db + " where header_id =" + Str(header_id)
        Dim Versie As Integer = -1

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query

                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    Versie = CHint(Reader("versie"))
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Fout order laad versie: " + ex.Message)
            MessageBox.Show("Order laad versie fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return Versie
    End Function
    Private Sub OrdersMenuAanpassen_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrdersMenuAanpassen.Click

        Dim aanpassen As Boolean
        Order_invoer_FlexGrid.Rows.Count = 1
        aanpassen = OrderAanpassen()
        If aanpassen = True Then
            Load_Favorites(1, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
        End If
        Order_Opslaan_but.Enabled = True
        Update_Boek()
    End Sub
    Private Sub OrdersMenuBekijken_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrdersMenuBekijken.Click
        ResetOrderinvoer()
        Order_Opslaan_but.Enabled = False
        Dim aanpassen As Boolean
        Order_invoer_FlexGrid.Rows.Count = 1
        aanpassen = OrderAanpassen()
    End Sub
    Private Sub Order_Slot_Chk_CheckedChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles Order_Slot_Chk.CheckedChanged
        If Not Order_Slot_Chk.Tag = "System" Then
            If Order_Slot_Chk.Checked = True Then
                'orders kan je niet zelf op true zetten
                Order_Slot_Chk.Checked = False
            Else

                ' Test of de order al naar floriday verstuurd is.
                Dim header_id As Integer = CInt(Val(Order_id_lbl.Text))
                If header_id > 0 Then

                    Try
                        'Open Connection
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()

                            Dim verwerkt As Boolean = False
                            Dim Cmd3 As New OdbcCommand("select floriday_printflag from orderkarren WHERE Header_id = ?", Conn)
                            Cmd3.Parameters.Clear()
                            Cmd3.Parameters.AddWithValue("", header_id)
                            Dim Reader3 As OdbcDataReader
                            Reader3 = Cmd3.ExecuteReader()
                            Do While Reader3.Read()
                                Dim printflag As Integer = CHint(Reader3("floriday_printflag"))
                                If printflag = 1 Or printflag = 2 Or printflag = 3 Or printflag = 4 Or printflag = 5 Then verwerkt = True
                            Loop

                            If verwerkt = False Then
                                Order_Slot_Chk.Tag = "System"
                                Order_Slot_Chk.Checked = False
                                Order_Slot_Chk.Tag = ""
                            Else
                                Order_Slot_Chk.Tag = "System"
                                Order_Slot_Chk.Checked = True
                                Order_Slot_Chk.Tag = ""
                                MsgBox("Deze order is al verwerkt op floriday en kan alleen worden aangepast als de levering is verwijderd")
                            End If

                        End Using
                    Catch ex As Exception
                        ErrorLog("Fout order-checker: " + ex.Message)
                        MsgBox("Fout order-checker: " + ex.Message, MsgBoxStyle.OkOnly)
                    End Try
                End If




            End If






        End If




    End Sub


    Dim ordertable() As tablelayout
    Private Sub Setup_Order_Grid()

        '***************************************************
        ' SETUP order flexgrid 
        '***************************************************

        'set ordergrid background colors 
        Dim rs As C1.Win.C1FlexGrid.CellStyle
        Order_invoer_FlexGrid.Styles.Clear()
        rs = Order_invoer_FlexGrid.Styles.Add("RowColor")
        rs.BackColor = Color.PowderBlue

        rs = Order_invoer_FlexGrid.Styles.Add("ErrorColor")
        rs.BackColor = Color.Red

        rs = Order_invoer_FlexGrid.Styles.Add("WarningColor")
        rs.BackColor = Color.Salmon

        rs = Order_invoer_FlexGrid.Styles.Add("Default")
        rs.Clear()




        ' load favorite buttons

        TabOrdersPanelTop.Enabled = False
        Order_invoer_FlexGrid.Enabled = False
        Order_OpmTab.Enabled = False

        Dim flexgridfill(12) As String
        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim CmdString As String = "select * from favorieten_naam"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Dim i = 0
                Reader.Read()
                If Reader.HasRows Then
                    Order_groep1_but.Text = CHstr(Reader("naam"))
                    Order_ToolStripMenuItem2.Text = CHstr(Reader("naam"))
                End If
                Reader.Read()
                If Reader.HasRows Then
                    Order_groep2_but.Text = CHstr(Reader("naam"))
                    Order_ToolStripMenuItem3.Text = CHstr(Reader("naam"))
                End If
                Reader.Read()
                If Reader.HasRows Then
                    Order_groep3_but.Text = CHstr(Reader("naam"))
                    Order_ToolStripMenuItem4.Text = CHstr(Reader("naam"))
                End If
                Reader.Read()
                If Reader.HasRows Then
                    Order_groep4_but.Text = CHstr(Reader("naam"))
                    Order_ToolStripMenuItem5.Text = CHstr(Reader("naam"))
                End If
                Reader.Read()
                If Reader.HasRows Then
                    Order_groep5_but.Text = CHstr(Reader("naam"))
                    Order_ToolStripMenuItem6.Text = CHstr(Reader("naam"))
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Setup Ordergrid: " + ex.Message)
            MessageBox.Show("Setup Ordergrid: " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        ' setup top area
        Dim day As Integer
        Dim morgen As String
        day = Now.DayOfWeek + 1
        Select Case day
            Case 2
                morgen = "Dinsdag"
            Case 3
                morgen = "Woensdag"
            Case 4
                morgen = "Donderdag"
            Case 5
                morgen = "Vrijdag"
            Case 6
                morgen = "Maandag"
            Case 7
                morgen = "Maandag"
            Case Else
                morgen = "Maandag"
        End Select
        Order_Morgen_but.Text = morgen
        Dim overmorgen As String
        day = Now.DayOfWeek + 2
        Select Case day
            Case 2
                overmorgen = "Dinsdag"
            Case 3
                overmorgen = "Woensdag"
            Case 4
                overmorgen = "Donderdag"
            Case 5
                overmorgen = "Vrijdag"
            Case 6
                overmorgen = "Maandag"
            Case 7
                overmorgen = "Dinsdag"
            Case 8
                overmorgen = "Dinsdag"
            Case 9
                overmorgen = "Dinsdag"
            Case Else
                overmorgen = "Maandag"
        End Select
        Order_OverMorgen_but.Text = overmorgen



        Order_koper_combo.AutoCompleteMode = AutoCompleteMode.SuggestAppend
        Order_koper_combo.AutoCompleteSource = AutoCompleteSource.CustomSource
        Order_koper_combo.DisplayMember = "desc"
        Order_koper_combo.ValueMember = "ID"
        Order_koper_combo.DropDownStyle = ComboBoxStyle.DropDown
        Order_koper_combo.MaxDropDownItems = 12
        Order_koper_combo.DataSource = dt_kopers

        Order_afleverloc_combo.DataSource = dt_afleverloc
        Order_afleverloc_combo.DisplayMember = "desc"
        Order_afleverloc_combo.ValueMember = "ID"
        Order_afleverloc_combo.DropDownStyle = ComboBoxStyle.DropDownList

        Order_veilingbrief_combo.DataSource = dt_brief
        Order_veilingbrief_combo.DisplayMember = "desc"
        Order_veilingbrief_combo.ValueMember = "ID"
        Order_veilingbrief_combo.DropDownStyle = ComboBoxStyle.DropDownList

        ' Order_fust_combo.DataSource = dt_fust
        ' Order_fust_combo.DisplayMember = "desc"
        ' Order_fust_combo.ValueMember = "ID"
        ' Order_fust_combo.DropDownStyle = ComboBoxStyle.DropDownList

        Order_vervoerder_combo.DataSource = dt_vervoerder
        Order_vervoerder_combo.DisplayMember = "desc"
        Order_vervoerder_combo.ValueMember = "ID"
        Order_vervoerder_combo.DropDownStyle = ComboBoxStyle.DropDownList

        Order_kar_combo.DataSource = dt_kar
        Order_kar_combo.DisplayMember = "desc"
        Order_kar_combo.ValueMember = "ID"
        Order_kar_combo.DropDownStyle = ComboBoxStyle.DropDownList

        Order_fustcat_cmb.DataSource = dt_fustcategorie
        Order_fustcat_cmb.DisplayMember = "desc"
        Order_fustcat_cmb.ValueMember = "ID"
        Order_fustcat_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        Order_hoescat_cmb.DataSource = dt_hoescategorie
        Order_hoescat_cmb.DisplayMember = "desc"
        Order_hoescat_cmb.ValueMember = "ID"
        Order_hoescat_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        ' setup grid

        ordertable = BuildTable("orderinvoer", Order_invoer_FlexGrid)
        'Order_invoer_FlexGrid.Cols(0).Visible = True

        acce1col = FindCol(Order_invoer_FlexGrid, "Accessoire1")
        acce2col = FindCol(Order_invoer_FlexGrid, "Accessoire2")
        acce4col = FindCol(Order_invoer_FlexGrid, "Accessoire4")
        acce5col = FindCol(Order_invoer_FlexGrid, "Accessoire5")
        acce6col = FindCol(Order_invoer_FlexGrid, "Accessoire6")
        acce7col = FindCol(Order_invoer_FlexGrid, "Accessoire7")
        acce8col = FindCol(Order_invoer_FlexGrid, "Accessoire8")

        fotocol = FindCol(Order_invoer_FlexGrid, "Foto")
        hoescol = FindCol(Order_invoer_FlexGrid, "Hoes")
        rijpheidcol = FindCol(Order_invoer_FlexGrid, "Rijpheid")
        diametercol = FindCol(Order_invoer_FlexGrid, "Diameter")
        hoogtecol = FindCol(Order_invoer_FlexGrid, "Hoogte")
        schermencol = FindCol(Order_invoer_FlexGrid, "Schermen")
        keurcodecol = FindCol(Order_invoer_FlexGrid, "Keurcode")
        transporthoogtecol = FindCol(Order_invoer_FlexGrid, "Transporthoogte")
        fotocol = FindCol(Order_invoer_FlexGrid, "Foto")

        aantalcol = FindCol(Order_invoer_FlexGrid, "Aantal")
        GPcol = FindCol(Order_invoer_FlexGrid, "GP")
        labelcol = FindCol(Order_invoer_FlexGrid, "Labelcode")
        fustcol = FindCol(Order_invoer_FlexGrid, "Fust")
        soortcol = FindCol(Order_invoer_FlexGrid, "Soort")
        potmaatcol = FindCol(Order_invoer_FlexGrid, "Potmaat")
        xcol = FindCol(Order_invoer_FlexGrid, "x")

        vestigingcol = FindCol(Order_invoer_FlexGrid, "Vestiging")
        aanbodcol = FindCol(Order_invoer_FlexGrid, "Aanbod referentie")
        prijscol = FindCol(Order_invoer_FlexGrid, "Prijs")

        wpsfilter1col = FindCol(Order_invoer_FlexGrid, "Wps filter")
        wpsfilter2col = FindCol(Order_invoer_FlexGrid, "wpsfilternr1")
        wpsfilter3col = FindCol(Order_invoer_FlexGrid, "wpsfilternr2")

        pluscol = FindCol(Order_invoer_FlexGrid, "+")
        opmerkingcol = FindCol(Order_invoer_FlexGrid, "Opmerking")

        kopercodecol = FindCol(Order_invoer_FlexGrid, "Koper referentie")
        florecomnrcol = FindCol(Order_invoer_FlexGrid, "Florecom nr")
        floridaynrcol = FindCol(Order_invoer_FlexGrid, "Floriday nr")
        actiecol = FindCol(Order_invoer_FlexGrid, "Actie")
        oldheadercol = FindCol(Order_invoer_FlexGrid, "oude headerId")

        'Dim cn() As String = New String() {"desc"}
        'With Order_invoer_FlexGrid

        '    .Clear()
        '    .Cols.Count = 29
        '    .Rows.Count = 1

        '    .Cols(0).Visible = False
        '    .Cols(0).Width = 30

        '    .Cols(1).StyleNew.Trimming = StringTrimming.EllipsisCharacter
        '    '.Cols(1).CellButtonImage = System.Drawing.Image.FromFile("C:\dollar.bmp")
        '    .CellButtonImage = IconList.Images(1)

        '    .Cols(1).Caption = " + "
        '    .Cols(1).DataType = System.Type.GetType("System.String")
        '    .Cols(1).ComboList = "..."
        '    .Cols(1).Width = 20
        '    .Cols(1).AllowEditing = True

        '    .Cols(2).Caption = "Aantal"
        '    .Cols(2).DataType = System.Type.GetType("System.Int32")
        '    .Cols(2).Width = 50
        '    .Cols(2).AllowEditing = True

        '    .Cols(3).Caption = " x "
        '    .Cols(3).DataType = System.Type.GetType("System.String")
        '    .Cols(3).Width = 30
        '    .Cols(3).AllowEditing = False

        '    .Cols(4).Caption = "Soort"
        '    .Cols(4).DataType = System.Type.GetType("System.String")
        '    .Cols(4).Width = 120
        '    Dim mcd_soort As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_soortmix, "ID", cn, 0)
        '    .Cols(4).DataMap = mcd_soort

        '    .Cols(5).Caption = "Prijs"
        '    .Cols(5).DataType = System.Type.GetType("System.Double")
        '    .Cols(5).Width = 60
        '    .Cols(5).AllowEditing = True
        '    .Cols(5).Format = "N2"

        '    .Cols(6).Caption = "Fust"
        '    .Cols(6).DataType = System.Type.GetType("System.String")
        '    .Cols(6).Width = 80
        '    Dim mcd_fust As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_fust, "ID", cn, 0)
        '    .Cols(6).DataMap = mcd_fust

        '    Dim mcd_accessoire As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_accessoire, "ID", cn, 0)
        '    .Cols(7).Caption = "Hoes"
        '    .Cols(7).DataType = System.Type.GetType("System.String")
        '    .Cols(7).Width = 80
        '    .Cols(7).DataMap = mcd_accessoire

        '    .Cols(8).Caption = "Rijpheid"
        '    .Cols(8).DataType = System.Type.GetType("System.string")
        '    .Cols(8).Width = 35
        '    Dim mcd_Rijpheid As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_rijpheid, "ID", cn, 0)
        '    .Cols(8).DataMap = mcd_Rijpheid
        '    .Cols(8).AllowEditing = True

        '    .Cols(9).Caption = "Hoogte"
        '    .Cols(9).DataType = System.Type.GetType("System.string")
        '    .Cols(9).Width = 35
        '    Dim mcd_hoogte As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_hoogte, "ID", cn, 0)
        '    .Cols(9).DataMap = mcd_hoogte
        '    .Cols(9).AllowEditing = True

        '    .Cols(10).Caption = "Diameter"
        '    .Cols(10).DataType = System.Type.GetType("System.string")
        '    Dim mcd_diameter As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_diameter, "ID", cn, 0)
        '    .Cols(10).DataMap = mcd_diameter
        '    .Cols(10).Width = 35
        '    .Cols(10).AllowEditing = True

        '    .Cols(11).Caption = "Accessoire 1"
        '    .Cols(11).DataType = System.Type.GetType("System.String")
        '    .Cols(11).Width = 120
        '    .Cols(11).DataMap = mcd_accessoire

        '    .Cols(12).Caption = "Accessoire 2"
        '    .Cols(12).DataType = System.Type.GetType("System.String")
        '    .Cols(12).Width = 120
        '    .Cols(12).DataMap = mcd_accessoire

        '    .Cols(13).Caption = "Kopercode"
        '    .Cols(13).DataType = System.Type.GetType("System.String")
        '    .Cols(13).Width = 80
        '    .Cols(13).AllowEditing = True

        '    .Cols(14).Caption = "Opmerking"
        '    .Cols(14).DataType = System.Type.GetType("System.String")
        '    .Cols(14).Width = 70
        '    .Cols(14).AllowEditing = True

        '    .Cols(15).Caption = "Labelcode"
        '    .Cols(15).DataType = System.Type.GetType("System.int32")
        '    .Cols(15).ComboList = "..."
        '    .Cols(15).Width = 60
        '    .Cols(15).AllowEditing = True

        '    .Cols(16).Caption = "WPS Filternr"
        '    .Cols(16).DataType = System.Type.GetType("System.String")
        '    .Cols(16).Width = 150
        '    .Cols(16).AllowEditing = True

        '    .Cols(17).Caption = "Vestiging"
        '    .Cols(17).DataType = System.Type.GetType("System.String")
        '    Dim mcd_vestiging As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_vestiging, "ID", cn, 0)
        '    .Cols(17).Width = 80
        '    .Cols(17).DataMap = mcd_vestiging

        '    .Cols(18).Caption = "Keurcode"
        '    .Cols(18).DataType = System.Type.GetType("System.int32")
        '    .Cols(18).Width = 80
        '    Dim mcd_keurcode As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_keurcode, "ID", cn, 0)
        '    .Cols(18).DataMap = mcd_keurcode

        '    .Cols(19).Caption = "Potmaat"
        '    .Cols(19).DataType = System.Type.GetType("System.Double")
        '    .Cols(19).Width = 50
        '    .Cols(19).AllowEditing = True

        '    .Cols(20).Caption = "Transp. hoogte"
        '    .Cols(20).DataType = System.Type.GetType("System.Int32")
        '    .Cols(20).Width = 40
        '    .Cols(20).AllowEditing = True

        '    .Cols(21).Caption = "GP"
        '    .Cols(21).DataType = System.Type.GetType("System.String")
        '    .Cols(21).Width = 40
        '    Dim mcd_GP As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_gp, "ID", cn, 0)
        '    .Cols(21).DataMap = mcd_GP

        '    .Cols(22).Caption = "Accessoire 4"
        '    .Cols(22).DataType = System.Type.GetType("System.String")
        '    .Cols(22).Width = 100
        '    .Cols(22).DataMap = mcd_accessoire

        '    .Cols(23).Caption = "Accessoire 5"
        '    .Cols(23).DataType = System.Type.GetType("System.String")
        '    .Cols(23).Width = 100
        '    .Cols(23).DataMap = mcd_accessoire

        '    .Cols(24).Caption = "Florecom nr"
        '    .Cols(24).DataType = System.Type.GetType("System.String")
        '    .Cols(24).Width = 80
        '    .Cols(24).AllowEditing = False

        '    .Cols(25).Caption = "Eindklant Code"
        '    .Cols(25).DataType = System.Type.GetType("System.String")
        '    .Cols(25).Width = 80
        '    Dim mcd_actie_type As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_prijsactie, "ID", cn, 0)
        '    .Cols(25).DataMap = mcd_actie_type

        '    .Cols(26).Caption = "WpsFilter ID"
        '    .Cols(26).DataType = System.Type.GetType("System.Int32")
        '    .Cols(26).Width = 80
        '    '.Cols(26).Visible = False 

        '    .Cols(27).Caption = "WpsFilter ID2"
        '    .Cols(27).DataType = System.Type.GetType("System.Int32")
        '    .Cols(27).Width = 80
        '    '.Cols(27).Visible = False 

        '    .Cols(28).Caption = "Oude header_id"
        '    .Cols(28).DataType = System.Type.GetType("System.Int32")
        '    .Cols(28).Width = 80
        '    .Cols(28).AllowEditing = False
        '    .Cols(28).Visible = False
        'End With
    End Sub
    Private Sub Order_Aflevertijd9_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Aflevertijd9_but.Click
        Order_Aflevertijd_combo.Text = "9:00"
        Order_koper_combo.Focus()
    End Sub
    Private Sub Order_Aflevertijd12_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Aflevertijd12_but.Click
        Order_Aflevertijd_combo.Text = "12:00"
        Order_koper_combo.Focus()
    End Sub
    Private Sub Order_Aflevertijd17_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Aflevertijd17_but.Click
        Order_Aflevertijd_combo.Text = "17:00"
        Order_koper_combo.Focus()
    End Sub
    Private Sub Order_Vandaag_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Vandaag_but.Click
        OrderDateTimePicker.Value = Now
        user_date_change = False
        Order_MonthCalendar.SelectionStart = Now
        Order_MonthCalendar.SelectionEnd = Now
        user_date_change = True
        order_date = Now
        Order_Aflevertijd12_but.Focus()
    End Sub
    Private Sub Order_Morgen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Morgen_but.Click

        Dim day As Integer
        day = Now.DayOfWeek

        If day = 0 Or day = 1 Or day = 2 Or day = 3 Or day = 4 Or day = 7 Then
            OrderDateTimePicker.Value = DateAdd("d", 1, Now)
        End If
        If day = 1 Or day = 4 Or day = 7 Then
            Order_Aflevertijd_combo.Text = "12:00"
        End If
        If day = 2 Or day = 3 Then
            Order_Aflevertijd_combo.Text = "12:00"
        End If
        If day = 5 Then
            OrderDateTimePicker.Value = DateAdd("d", 3, Now)
            Order_Aflevertijd_combo.Text = "12:00"
        End If
        If day = 6 Then
            OrderDateTimePicker.Value = DateAdd("d", 2, Now)
            Order_Aflevertijd_combo.Text = "12:00"
        End If


        Dim klantopmerking As String = Order_opmerking_txt.Text
        If klantopmerking <> "" Then
            Dim searchstring = klantopmerking.ToLower
            Dim position1 As Integer = InStr(1, searchstring, "tijd:")
            If position1 > 0 Then
                Dim position2 As Integer = InStr(position1, searchstring, vbCrLf)
                If position2 = 0 Then position2 = Len(klantopmerking)
                Dim defaulttijd As String = Mid(klantopmerking, position1 + 5, position2 - position1)

                Dim timearray() As String = defaulttijd.Split(":")
                If UBound(timearray) = 1 Then
                    Dim hours As Integer = Val(timearray(0))
                    Dim minutes As Integer = Val(timearray(1))
                    If hours >= 0 And hours <= 23 And minutes <= 0 And minutes <= 59 Then

                        Dim order_datum As Date = OrderDateTimePicker.Value.ToShortDateString
                        Dim order_datumtijd = Date.Parse(order_datum + " " + Trim(defaulttijd))

                        If order_datumtijd > Now Then
                            Order_Aflevertijd_combo.Text = Trim(defaulttijd)
                        End If


                    End If

                End If

            End If

        End If




        Order_Aflevertijd12_but.Focus()
        order_date = OrderDateTimePicker.Value
        user_date_change = False
        Order_MonthCalendar.SelectionStart = OrderDateTimePicker.Value
        Order_MonthCalendar.SelectionEnd = OrderDateTimePicker.Value
        user_date_change = True
    End Sub
    Private Sub OrderDateTimePicker_ValueChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrderDateTimePicker.ValueChanged
        If Weekday(OrderDateTimePicker.Value, FirstDayOfWeek.Monday) = 5 Then
            Order_AflevertijdZA_but.Visible = True
        Else
            Order_AflevertijdZA_but.Visible = False
        End If

        user_date_change = False
        Order_MonthCalendar.SelectionStart = OrderDateTimePicker.Value
        Order_MonthCalendar.SelectionEnd = OrderDateTimePicker.Value
        If Order_ean_lbl.Text <> "0000000000000" Then
            BoekStatus = 8
            Update_Boek(1, Order_ean_lbl.Text)
        End If

        user_date_change = True


        'herbereken prijzen


        If Order_invoer_FlexGrid.Rows.Count > 1 Then
            For rowloop = 1 To Order_invoer_FlexGrid.Rows.Count - 1

                If Order_invoer_FlexGrid.Item(rowloop, 0) > 0 And Order_Slot_Chk.Checked = True Then   'locked = id aanwezig + lock
                    'locked orders,don't touch
                Else
                    'alleen veranderen als aantal nog nul is.
                    If Order_invoer_FlexGrid.Item(rowloop, aantalcol) = 0 Then

                        order_date = OrderDateTimePicker.Value
                        Dim soortid As Integer = Order_invoer_FlexGrid.Item(rowloop, soortcol)
                        Dim koper_ean As String = Order_ean_lbl.Text
                        Dim datum As Date = OrderDateTimePicker.Value
                        Dim prijskleur As Integer = 0 'dummy
                        Dim actie_type As Integer = 0
                        Dim accessoireId = Order_invoer_FlexGrid.Item(rowloop, acce1col)
                        Dim huidige_prijs As Double = ZoekPrijs(soortid, koper_ean, order_date, prijskleur, actie_type)
                        Dim prijs As Double = FindAccessoirePrijs(koper_ean, huidige_prijs, accessoireId, soortid, order_date, actie_type)
                        Order_invoer_FlexGrid.Item(rowloop, prijscol) = prijs
                        Order_invoer_FlexGrid.Item(rowloop, actiecol) = actie_type
                    End If
                End If
            Next rowloop
        End If
        order_date = OrderDateTimePicker.Value
    End Sub
    Private Sub Order_AflevertijdZA_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_AflevertijdZA_but.Click
        Order_Aflevertijd_combo.Text = "18:00"
        Order_koper_combo.Focus()
    End Sub
    Private Sub Order_OverMorgen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_OverMorgen_but.Click
        Dim day As Integer
        day = Now.DayOfWeek

        If day = 0 Or day = 1 Or day = 2 Or day = 3 Or day = 7 Then
            OrderDateTimePicker.Value = DateAdd("d", 2, Now)
        End If
        If day = 4 Or day = 5 Then
            OrderDateTimePicker.Value = DateAdd("d", 4, Now)
        End If
        If day = 6 Then
            OrderDateTimePicker.Value = DateAdd("d", 3, Now)
        End If
        Order_Aflevertijd_combo.Text = "12:00"

        Dim klantopmerking As String = Order_opmerking_txt.Text
        If klantopmerking <> "" Then
            Dim searchstring = klantopmerking.ToLower
            Dim position1 As Integer = InStr(1, searchstring, "tijd:")
            If position1 > 0 Then
                Dim position2 As Integer = InStr(position1, searchstring, vbCrLf)
                If position2 = 0 Then position2 = Len(klantopmerking)
                Dim defaulttijd As String = Mid(klantopmerking, position1 + 5, position2 - position1)

                Dim timearray() As String = defaulttijd.Split(":")
                If UBound(timearray) = 1 Then
                    Dim hours As Integer = Val(timearray(0))
                    Dim minutes As Integer = Val(timearray(1))
                    If hours >= 0 And hours <= 23 And minutes <= 0 And minutes <= 59 Then

                        Dim order_datum As Date = OrderDateTimePicker.Value.ToShortDateString
                        Dim order_datumtijd = Date.Parse(order_datum + " " + Trim(defaulttijd))

                        If order_datumtijd > Now Then
                            Order_Aflevertijd_combo.Text = Trim(defaulttijd)
                        End If


                    End If

                End If

            End If

        End If

        Order_Aflevertijd12_but.Focus()
        order_date = OrderDateTimePicker.Value
        user_date_change = False
        Order_MonthCalendar.SelectionStart = OrderDateTimePicker.Value
        Order_MonthCalendar.SelectionEnd = OrderDateTimePicker.Value
        user_date_change = True
    End Sub
    Private Sub Order_Aflevertijd_combo_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles Order_Aflevertijd_combo.Validated
        Dim tijd As String
        Dim chktijd As String = "12:00"
        Dim find As Integer
        Dim uur As Integer
        Dim minuut As Integer

        tijd = Order_Aflevertijd_combo.Text
        find = InStr(tijd, ":")
        If find > 0 Then
            uur = Val(Mid(tijd, 1, find - 1))
            minuut = Val(Mid(tijd, find + 1, 2))
            If uur > 23 Then uur = 23
            If minuut > 59 Then minuut = 59
            chktijd = Trim(Str(uur)) + ":" + Trim(Format(minuut, "00"))
        Else
            chktijd = "12:00"
        End If
        Order_Aflevertijd_combo.Text = chktijd
    End Sub
    Private Sub Order_prijsopslag_txt_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles Order_prijsopslag_txt.Validated
        'Order_prijsopslag_txt.Text = Format(Val(Order_prijsopslag_txt.Text), "0.00")
        If CVal(Order_prijsopslag_txt.Text) = 0 Then Order_prijsopslag_txt.Text = "0.00"
        Dim CmdString As String = "SELECT * FROM klanten WHERE 1=0"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                With Cmd

                    .CommandText = "UPDATE klanten SET stikkeropslag=? WHERE ean = '" + Trim(Order_ean_lbl.Text) + "'"
                    .Parameters.Clear()
                    .Parameters.AddWithValue("", Val(Order_prijsopslag_txt.Text))
                    .ExecuteNonQuery()
                End With
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopersinstellingen/opslag opslaan)" + ex.Message)
            MsgBox("Database fout: (kopersinstellingen/opslag opslaan)" + ex.Message, MsgBoxStyle.OkOnly)
        End Try

    End Sub
    Private Sub Order_zoek_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_zoek_but.Click
        If Order_zoeken_chk.Checked = True Then
            Set_BoekInstellingen(0, 0, 1)
            Update_Boek()
        End If
    End Sub
    Private Sub Order_zoeken_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_zoeken_chk.CheckedChanged
        If Order_zoeken_chk.Checked = False Then
            Order_zoek_txt.Text = ""
            Set_BoekInstellingen(1, 1, 6)
        End If
    End Sub
    Private Sub Order_Selectie_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) 
        If TreeView1.CheckBoxes = False Then
            TreeView1.CheckBoxes = True
        Else
            TreeView1.CheckBoxes = False
        End If
    End Sub

    Private Function OrderAanpassen(Optional ByVal order_header_id As Integer = -1) As Boolean

        ResetOrderinvoer()

        Dim aantalcol As Integer = FindCol(Order_invoer_FlexGrid, "Aantal")
        order_date = OrderDateTimePicker.Value

        'C1Tab.SelectedTab = C1Tab.TabPages(0)
        SetTabPage("Order invoer")

        'find selected item
        Dim header_id As Integer = -1

        If order_header_id > 0 Then  'bij orders samenvoegen komt de header mee
            header_id = order_header_id
        Else

            Dim Nodes As TreeNodeCollection = TreeView1.Nodes
            Dim Node As TreeNode
            For Each Node In Nodes
                If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                    header_id = Val(Mid(Node.Tag, 4))
                End If

                If Node.Nodes.Count > 0 Then
                    Dim node2 As TreeNode
                    For Each node2 In Node.Nodes
                        If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                            header_id = Val(Mid(node2.Tag, 4))
                            Exit For
                        End If
                    Next node2
                End If
            Next Node

            If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
                If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                    header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                End If
            End If

        End If



        If header_id = -1 Then Return False

        Dim block As Boolean = check_wps_inbehandeling(header_id)


        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear
        Dim Reader As OdbcDataReader
        Dim cmdstring As String = ""

        '** Datum range
        cmdstring = "SELECT * FROM " + orderheader_db + " where header_id =" + Str(header_id)

        Dim ean As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query

                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()

                    '***************************************************
                    ' Veld invullen 
                    '***************************************************
                    TabOrdersPanelTop.Enabled = True
                    Order_invoer_FlexGrid.Enabled = True
                    Order_OpmTab.Enabled = True

                    ean = CHstr(Reader("koper_ean"))

                    Order_id_lbl.Text = Trim(Str(header_id))
                    Order_ean_lbl.Text = ean
                    Dim afleverdatum As Date = CType(Reader("afleverdatum"), Date)
                    OrderDateTimePicker.Value = afleverdatum.ToShortDateString
                    order_date = OrderDateTimePicker.Value
                    Dim prijsopslag As Double = CHdouble(Reader("prijs_opslag"))
                    Order_prijsopslag_txt.Text = pformatprijs(prijsopslag, 2)
                    Order_OpmOrderinfo_txt.Text = Trim(CHstr(Reader("opmerking")))
                    Order_Pakboninfo_txt.Text = Trim(CHstr(Reader("pakbon_opmerking")))
                    order_contacts_combo.Text = CHstr(Reader("contact"))
                    Order_Aflevertijd_combo.Text = afleverdatum.ToShortTimeString
                    SetComboIndex(Order_veilingbrief_combo, CHint(Reader("veilingbrief_id")))
                    SetComboIndex(Order_afleverloc_combo, CHint(Reader("afleverloc")))
                    SetComboIndex(Order_vervoerder_combo, CHint(Reader("vervoerder_id")))
                    SetComboIndex(Order_kar_combo, CHint(Reader("kar_id")))
                    StickerType_cmb.SelectedIndex = CHint(Reader("Sticker"))
                    Order_versie_lbl.Text = Trim(CHstr(Reader("versie")))
                    Order_koper_combo.Focus()
                    Order_invoer_FlexGrid.Rows.Count = 1
                    If Reader("agenda_mark") = 2 Then
                        Order_reservering_chk.Checked = True
                    Else
                        Order_reservering_chk.Checked = False
                    End If
                    Dim aanvulling As Integer = CHint(Reader("aanvulling"))
                    If aanvulling > 0 Then
                        Order_aanvulling_chk.Tag = "System"
                        Order_aanvulling_chk.Checked = True
                        Order_aanvulling_chk.Tag = Trim(Str(aanvulling))
                        Order_aanvulling_chk.Text = "Aanvulling : " + Str(aanvulling)
                    Else
                        Order_aanvulling_chk.Tag = "System"
                        Order_aanvulling_chk.Checked = False
                        Order_aanvulling_chk.Tag = "0"
                        Order_aanvulling_chk.Text = "Aanvulling"
                    End If

                    OrderAanpassen_Vul_Koper_data(ean)
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Orderaanpassen fout:" + ex.Message)
            MessageBox.Show("Orderaanpassen fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        '  set focus sheet
        OrderAanpassen_LoadLines(orderlines_db, header_id, ean)

        Order_Slot_Chk.Enabled = True
        Order_Slot_Chk.Tag = "System"
        Order_Slot_Chk.Checked = True
        Order_Slot_Chk.Tag = ""

        If Mid(ean, 1, 12) = "900000000000" Then
            Order_invoer_FlexGrid.Enabled = False
            Return False
        Else
            If Order_Opslaan_but.Enabled = True Then
                SetMark(True, header_id)
                Load_Favorites(1, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
                Order_invoer_FlexGrid.Focus()
                Try
                    Order_invoer_FlexGrid.Select(2, aantalcol, 2, aantalcol)
                Catch ex As Exception

                End Try

            End If
        End If
        Return True
    End Function
    Private Sub OrderAanpassen_LoadLines(ByVal orderline_db As String, ByVal orderheader_id As Integer, ByVal koper_ean As String, Optional ByVal save_header As Boolean = False)
        'fill grid 



        If Mid(koper_ean, 1, 12) = "900000000000" Then  'verzamelkar
            Order_invoer_FlexGrid.Enabled = False
            Exit Sub
        Else
            Order_invoer_FlexGrid.Enabled = True
        End If


        Dim Reader As OdbcDataReader
        Dim gridfill1(60) As Object

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query

                Dim CmdString As String = "select * from " + orderline_db + " where OrderHeader_id = " + Str(orderheader_id)

                Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                Reader = Cmd2.ExecuteReader()
                Do While Reader.Read()

                    ' fill list
                    Dim newfustid As Integer = CHint(Reader("fust_id"))

                    gridfill1(0) = CHint(Reader("orderline_id"))
                    gridfill1(pluscol) = "+"              'plus
                    gridfill1(aantalcol) = CHstr(Reader("aantal"))              '
                    gridfill1(xcol) = "x" + Str(fust(GID(fust, newfustid)).aantal_per_fust)
                    gridfill1(soortcol) = CHstr(Reader("Soort_id"))
                    gridfill1(prijscol) = Format(Reader("Prijs"), "0.00")
                    gridfill1(fustcol) = CHstr(newfustid)
                    gridfill1(GPcol) = CHstr(Reader("GP"))

                    gridfill1(rijpheidcol) = CHstr(Reader("Rijpheid"))
                    gridfill1(hoogtecol) = CHstr(Reader("Hoogte"))
                    gridfill1(diametercol) = CHstr(Reader("Diameter"))
                    gridfill1(acce1col) = CHstr(Reader("Accessoire1"))
                    gridfill1(acce2col) = CHstr(Reader("Accessoire2"))
                    gridfill1(kopercodecol) = CHstr(Reader("Kopercode"))
                    gridfill1(opmerkingcol) = CHstr(Reader("Opmerking"))
                    gridfill1(labelcol) = CHstr(Reader("labelbericht_code"))
                    gridfill1(fotocol) = CHstr(Reader("foto"))

                    Dim wpsfilternaam As String = ""
                    Dim wpsfilterid As Integer = CHint(Reader("Wps_filternr"))
                    If wpsfilterid = 0 Then
                        Dim filter1 As Integer
                        Dim filter2 As Integer
                        GetWPSFilterNr(koper_ean, CHint(Reader("Soort_id")), CHint(Reader("Accessoire1")), filter1, filter2)
                        wpsfilterid = filter1
                    End If

                    For j = 0 To UBound(wpsfilter)
                        If wpsfilterid = wpsfilter(j).filternummer Then
                            wpsfilternaam = wpsfilter(j).filternaam
                            Exit For
                        End If
                    Next j

                    gridfill1(wpsfilter1col) = wpsfilternaam
                    gridfill1(vestigingcol) = CHstr(Reader("Vestiging"))
                    gridfill1(keurcodecol) = CHstr(Reader("Keurcode"))
                    gridfill1(potmaatcol) = Str(CHint(Reader("potmaat")) / 10)
                    gridfill1(transporthoogtecol) = CHstr(Reader("Transporthoogte"))
                    gridfill1(hoescol) = CHstr(Reader("Accessoire3"))
                    gridfill1(acce4col) = CHstr(Reader("Accessoire4"))
                    gridfill1(acce5col) = CHstr(Reader("Accessoire5"))
                    gridfill1(florecomnrcol) = CHstr(Reader("florecom_nr"))
                    gridfill1(actiecol) = CHstr(Reader("actie_type"))
                    gridfill1(wpsfilter2col) = CHstr(Reader("Wps_filternr"))
                    gridfill1(wpsfilter3col) = CHstr(Reader("Wps_filternr2"))
                    If save_header = True Then
                        gridfill1(oldheadercol) = orderheader_id
                    Else
                        gridfill1(oldheadercol) = CHstr(Reader("old_header_id"))
                    End If
                    gridfill1(acce6col) = CHstr(Reader("Accessoire6"))
                    gridfill1(acce7col) = CHstr(Reader("Accessoire7"))
                    gridfill1(acce8col) = CHstr(Reader("Accessoire8"))
                    gridfill1(schermencol) = CHstr(Reader("Schermen"))
                    gridfill1(aanbodcol) = CHstr(Reader("supplyref"))
                    gridfill1(floridaynrcol) = CHstr(Reader("floridaynr"))
                    Order_invoer_FlexGrid.AddItem(gridfill1)

                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Orderaanpassen/orderlines fout:" + ex.Message)
            MessageBox.Show("Order aanpassen fout: (Orderlines laden)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub OrderAanpassen_Vul_Koper_data(ByVal ean As String)

        '***************************************************
        ' KOPER DATA inladen 
        '***************************************************


        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from klanten where ean ='" + ean + "'"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    Order_koper_combo.Text = CHstr(Reader("klantnaam"))
                    If Order_veilingbrief_combo.SelectedValue = 1 Then
                        Order_admnr_txt.Text = CHstr(Reader("veilingnr_westland"))
                    End If
                    If Order_veilingbrief_combo.SelectedValue = 2 Then
                        Order_admnr_txt.Text = CHstr(Reader("veilingnr_vba"))
                    End If
                    'SetComboIndex(Order_fust_combo, CHint(Reader("fust_voorkeur")))
                    SetComboIndex(Order_hoescat_cmb, CHint(Reader("hoescategorie")))
                    SetComboIndex(Order_fustcat_cmb, CHint(Reader("fustcategorie")))
                    'Order_Decorum_chk.Checked = CheckDBNull(Reader("decorum"))
                    Dim default_accessoire As Integer = CHint(Reader("decorum"))
                    'For i = 1 To UBound(accessoire)
                    ' If default_accessoire = accessoire(i).id Then
                    ' If accessoire(i).decorum = True Then
                    ' Order_Decorum_chk.Checked = CHint(Reader("decorum"))
                    ' Exit For
                    'Els() 'e
                    '' Order_Decorum_chk.Checked = 0
                    'Exit For
                    'End If
                    'End If
                    '    Next i
                    If IsDecorum(ean) > 0 Then
                        Order_Decorum_chk.Checked = True
                    Else
                        Order_Decorum_chk.Checked = False
                    End If

                    Order_Decorum_chk.Tag = Str(CHint(Reader("decorum")))
                    'Dim contacts() As String = Split(CheckDBNull(Reader("contact")), ";")
                    'order_contacts_combo.Items.Clear()
                    'For i = 0 To UBound(contacts)
                    ' order_contacts_combo.Items.Add(contacts(i))
                    ' Next i

                    'Order_OpmOrderinfo_txt.Text = CHstr(Reader("opmerking"))
                    'Order_Pakboninfo_txt.Text = CHstr(Reader("pakbon_opmerking"))

                    verwerk_opmerkingen(ean, True)


                    'Order_OpmTab.SelectedTab = Order_OpmTab.TabPages(1)

                End If
            End Using
        Catch ex As Exception
            ErrorLog("Vul koperdata fout:" + ex.Message)
            MessageBox.Show("Vul koperdata fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub OrdersMenuAnnuleren_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrdersMenuAnnuleren.Click


        'find selected treeview item

        Dim header_id As Integer = -1
        For i = 0 To TreeView1.Nodes.Count - 1
            If TreeView1.Nodes(i).Checked = True And Mid(TreeView1.Nodes(i).Tag, 1, 2) = "ID" Then
                header_id = Val(Mid(TreeView1.Nodes(i).Tag, 4))
            End If
        Next i

        If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 2) = "ID" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If

        If header_id = -1 Then Exit Sub

        ' write order status = 99 to database

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand("UPDATE orderheaders SET status=99 WHERE header_id = ?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", header_id)
                Cmd.ExecuteNonQuery()

                Dim Cmd2 As New OdbcCommand("UPDATE orderkarren SET Wps_status=6 WHERE header_id = ?", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", header_id)
                Cmd2.ExecuteNonQuery()


            End Using
        Catch ex As Exception
            ErrorLog("Fout order annuleren: " + ex.Message)
            MsgBox("Fout order annuleren: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        Set_Boek_reload()
        Update_Boek()
    End Sub
    Private Sub OrdersMenuSamenvoegen_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrdersMenuSamenvoegen.Click
        Order_Opslaan_but.Enabled = True
        'reset klok order sheet
        ResetOrderinvoer()

        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        'zoek eerste 2 headers
        Dim header1_id As Integer = -1
        Dim header2_id As Integer = -1
        Dim search As Integer = 1

        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 2) = "ID" Then
                If search = 1 Then
                    header1_id = Val(Mid(Node.Tag, 4))
                End If
                If search = 2 Then
                    header2_id = Val(Mid(Node.Tag, 4))
                    Exit For
                End If
                search = search + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 2) = "ID" And node2.Checked = True Then
                        If search = 1 Then
                            header1_id = Val(Mid(node2.Tag, 4))
                        End If
                        If search = 2 Then
                            header2_id = Val(Mid(node2.Tag, 4))
                            Exit For
                        End If
                        search = search + 1
                        'Exit For
                    End If
                Next node2
            End If
        Next Node


        Dim Reader As OdbcDataReader
        Dim cmdstring As String = ""
        'check of kopers hetzelfde zijn
        Dim ean1 As String = "1"
        Dim ean2 As String = "2"
        Dim contact1 As String = ""
        Dim contact2 As String = ""
        Dim wps_status1 As Integer = 0
        Dim wps_status2 As Integer = 0
        Dim sticker1 As Integer = 0
        Dim sticker2 As Integer = 0
        Dim vestiging1 As Integer = 1
        Dim vestiging2 As Integer = 1
        Dim pakbon_opmerking As String = ""
        Dim afleverlocatie1 As String = ""
        Dim afleverlocatie2 As String = ""

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                cmdstring = "SELECT * FROM " + orderheader_db + " where header_id =" + Str(header1_id)
                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    ean1 = CHstr(Reader("koper_ean"))
                    contact1 = CHstr(Reader("contact"))
                    wps_status1 = CHint(Reader("status"))
                    sticker1 = CHint(Reader("sticker"))
                    vestiging1 = CHint(Reader("vestiging"))
                    afleverlocatie1 = CHstr(Reader("afleverloc_ean"))
                End If
                Reader.Close()
                'Execute Query
                cmdstring = "SELECT * FROM " + orderheader_db + " where header_id =" + Str(header2_id)
                Dim Cmd3 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd3.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    ean2 = CHstr(Reader("koper_ean"))
                    contact2 = CHstr(Reader("contact"))
                    wps_status2 = CHint(Reader("status"))
                    sticker2 = CHint(Reader("sticker"))
                    pakbon_opmerking = CHstr(Reader("pakbon_opmerking"))
                    vestiging2 = CHint(Reader("vestiging"))
                    afleverlocatie2 = CHstr(Reader("afleverloc_ean"))
                End If


                If wps_status1 >= 34 And wps_status1 <= 38 Then
                    MsgBox("Orders kunnen alleen worden samengevoegd als ze klaar zijn in wps", vbOKOnly)
                    Exit Sub
                End If
                If wps_status2 >= 34 And wps_status2 <= 38 Then
                    MsgBox("Orders kunnen alleen worden samengevoegd als ze klaar zijn in wps", vbOKOnly)
                    Exit Sub
                End If

                If Mid(ean1, 1, 12) = "900000000000" Then  'verzamelkar
                    MsgBox("Verzamelkarren kunnen niet worden samengevoegd", vbOKOnly)
                    Exit Sub
                End If

                If Not (ean1 = ean2) Then
                    MsgBox("Alleen orders van dezelfde koper kunnen worden samengevoegd", vbOKOnly)
                    Exit Sub
                End If

                If Not (afleverlocatie1 = afleverlocatie2) Then
                    MsgBox("Alleen orders met dezelfde afleverlocatie kunnen worden samengevoegd", vbOKOnly)
                    Exit Sub
                End If

                If header1_id = -1 Or header2_id = -1 Then Exit Sub

                SetMark(True, header2_id)
                SetMark(True, header1_id)

                If Not (vestiging1 = vestiging2) Then
                    Dim message As String = "Yes = Samenvoegen op Kreekrug" + vbCrLf + "No = Samenvoegen op Herenwerf" + vbCrLf + "Cancel = Samenvoegen annuleren"
                    Dim answer As Integer = MsgBox(message, vbYesNoCancel)
                    If answer = vbYes Then
                        If vestiging1 = 1 Then
                            Dim Cmd4 As New OdbcCommand("UPDATE orderheaders SET vestiging=1 WHERE header_id = ?", Conn)
                            Cmd4.Parameters.Clear()
                            Cmd4.Parameters.AddWithValue("", header2_id)
                            Cmd4.ExecuteNonQuery()
                            Dim Cmd5 As New OdbcCommand("UPDATE orderlines SET vestiging=1 WHERE orderheader_id = ?", Conn)
                            Cmd5.Parameters.Clear()
                            Cmd5.Parameters.AddWithValue("", header2_id)
                            Cmd5.ExecuteNonQuery()
                        Else
                            Dim Cmd4 As New OdbcCommand("UPDATE orderheaders SET vestiging=1 WHERE header_id = ?", Conn)
                            Cmd4.Parameters.Clear()
                            Cmd4.Parameters.AddWithValue("", header1_id)
                            Cmd4.ExecuteNonQuery()
                            Dim Cmd5 As New OdbcCommand("UPDATE orderlines SET vestiging=1 WHERE orderheader_id = ?", Conn)
                            Cmd5.Parameters.Clear()
                            Cmd5.Parameters.AddWithValue("", header1_id)
                            Cmd5.ExecuteNonQuery()
                        End If
                    End If

                    If answer = vbNo Then
                        If vestiging1 = 1 Then
                            Dim Cmd4 As New OdbcCommand("UPDATE orderheaders SET vestiging=2 WHERE header_id = ?", Conn)
                            Cmd4.Parameters.Clear()
                            Cmd4.Parameters.AddWithValue("", header1_id)
                            Cmd4.ExecuteNonQuery()
                            Dim Cmd5 As New OdbcCommand("UPDATE orderlines SET vestiging=2 WHERE orderheader_id = ?", Conn)
                            Cmd5.Parameters.Clear()
                            Cmd5.Parameters.AddWithValue("", header1_id)
                            Cmd5.ExecuteNonQuery()
                        Else
                            Dim Cmd4 As New OdbcCommand("UPDATE orderheaders SET vestiging=2 WHERE header_id = ?", Conn)
                            Cmd4.Parameters.Clear()
                            Cmd4.Parameters.AddWithValue("", header2_id)
                            Cmd4.ExecuteNonQuery()
                            Dim Cmd5 As New OdbcCommand("UPDATE orderlines SET vestiging=2 WHERE orderheader_id = ?", Conn)
                            Cmd5.Parameters.Clear()
                            Cmd5.Parameters.AddWithValue("", header2_id)
                            Cmd5.ExecuteNonQuery()
                        End If
                    End If
                    If answer = vbCancel Then
                        Exit Sub
                    End If
                End If


                Reader.Close()

            End Using
        Catch ex As Exception
            ErrorLog("Order samenvoegen fout:" + ex.Message)
            MessageBox.Show("Order samenvoegen fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        Dim dum As Boolean = OrderAanpassen(header1_id)

        'sticker info vergelijken
        If sticker1 = 0 Then
            StickerType_cmb.SelectedIndex = sticker2
        End If
        If sticker1 = 9 Or sticker2 = 9 Then
            StickerType_cmb.SelectedIndex = 9
        End If
        If sticker1 = 10 Or sticker2 = 10 Then
            StickerType_cmb.SelectedIndex = 10
        End If
        If sticker1 = 8 Or sticker2 = 8 Then
            StickerType_cmb.SelectedIndex = 8
        End If


        Order_aanvulling_chk.Tag = "System"
        Order_aanvulling_chk.Checked = False
        Order_aanvulling_chk.Tag = "0"
        Order_aanvulling_chk.Text = "Aanvulling"

        'barcode(s) van 2de order opzoeken om ze te bewaren

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                '
                'Execute Query
                cmdstring = "SELECT * FROM " + orderkarren_db + " where header_id =" + Str(header2_id)
                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()
                'eerste barcode opslaan
                Do While Reader.Read()
                    Dim barcode As String = CHstr(Reader("Barcode"))

                    Dim cmdstring3 As String = "INSERT INTO barcode_save(save_id,barcode) VALUES(?,?)"
                    Dim Cmd3 As New OdbcCommand(cmdstring3, Conn)
                    Cmd3.Parameters.Clear()
                    Cmd3.Parameters.AddWithValue("", header2_id)  'save id = oude header id
                    Cmd3.Parameters.AddWithValue("", barcode)
                    Cmd3.ExecuteNonQuery()

                Loop

                Reader.Close()
            End Using
        Catch ex As Exception
            ErrorLog("Order samenvoegen fout:" + ex.Message)
            MessageBox.Show("Order samenvoegen fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        OrderAanpassen_LoadLines(orderlines_db, header2_id, ean1, True)
        Load_Favorites(1, Order_fustcat_cmb.SelectedValue, Order_hoescat_cmb.SelectedValue, Order_ean_lbl.Text)
        order_contacts_combo.Text = contact1 + "+" + contact2

        'delete 2nd order  & update contacts
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim DelString As String = "DELETE FROM " + orderheader_db + " WHERE header_id='" + Str(header2_id) + "'"
                Dim DelCmd As New OdbcCommand(DelString, Conn)
                DelCmd.ExecuteNonQuery()
            End Using
        Catch ex As Exception
            ErrorLog("Order2 verwijderen fout:" + ex.Message)
            MessageBox.Show("Order2 verwijderen fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        'tel aantal karren in order1
        Dim karcount As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd3 As New OdbcCommand("select * from orderkarren WHERE Header_id = ?", Conn)
                Cmd3.Parameters.Clear()
                Cmd3.Parameters.AddWithValue("", header1_id)
                Dim Reader3 As OdbcDataReader
                Reader3 = Cmd3.ExecuteReader()
                Do While Reader3.Read()
                    karcount = karcount + 1
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("KarrenTellen fout:" + ex.Message)
            MessageBox.Show("KarrenTellen fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        order_opslaan_verdelen()

        'bestaat order1 uit meer dan 1 karren en is het een aanvulling? dan opmerking aanvulling laten zien
        If Mid(pakbon_opmerking, 1, 10) = "AANVULLING" Then

            If karcount > 1 Then
                MsgBox(pakbon_opmerking)
            End If


        End If

    End Sub
    Private Sub Order_kar_combo_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_kar_combo.SelectedIndexChanged
        Order_Slot_Chk.Enabled = False
        Order_Slot_Chk.Tag = "System"
        Order_Slot_Chk.Checked = False
        Order_Slot_Chk.Tag = ""
    End Sub
    Private Sub Order_InstelOpslaan_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_InstelOpslaan_but.Click
        Dim CmdString As String = "SELECT * FROM klanten WHERE 1=0"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                With Cmd

                    .CommandText = "UPDATE klanten SET veiling_voorkeur=?,kar_voorkeur=?," _
                                    & "vervoerder=?,bdo=?,stikkeropslag=?,opmerking=?,stikker=?,fustcategorie=?,hoescategorie=? " _
                                    & "WHERE ean = '" + Trim(Order_ean_lbl.Text) + "'"
                    .Parameters.Clear()
                    .Parameters.AddWithValue("", Order_veilingbrief_combo.SelectedValue)
                    .Parameters.AddWithValue("", Order_kar_combo.SelectedValue)
                    '    .Parameters.AddWithValue("", Order_fust_combo.SelectedValue)
                    .Parameters.AddWithValue("", Order_vervoerder_combo.SelectedValue)
                    .Parameters.AddWithValue("", Order_afleverloc_combo.SelectedValue)
                    'If CVal(Order_Decorum_chk.Tag) > 0 Then
                    '.Parameters.AddWithValue("", Order_Decorum_chk.Tag)
                    ' Else
                    '.Parameters.AddWithValue("", Order_Decorum_chk.Checked)
                    ' End If
                    .Parameters.AddWithValue("", Val(Order_prijsopslag_txt.Text))
                    .Parameters.AddWithValue("", Order_opmerking_txt.Text)

                    Dim Sticker As Integer = 0  '0 = Nee
                    Select Case StickerType_cmb.Text
                        Case "Ja" : Sticker = 1
                        Case "Voorbereiden (potcover/label)" : Sticker = 2
                        Case "Floraconnect" : Sticker = 3
                        Case "Floraconnect voorbereiden" : Sticker = 4
                    End Select
                    .Parameters.AddWithValue("", Sticker)
                    .Parameters.AddWithValue("", Order_fustcat_cmb.SelectedValue)
                    .Parameters.AddWithValue("", Order_hoescat_cmb.SelectedValue)

                    .ExecuteNonQuery()
                End With
                MsgBox("kopersinstellingen opgeslagen!", MsgBoxStyle.OkOnly)
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopersinstellingen opslaan)" + ex.Message)
            MsgBox("Database fout: (kopersinstellingen opslaan)" + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub
    Private Sub Orders_WpsKlaar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Orders_WpsKlaar.Click

        Dim mark_idlist(101) As Integer

        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If

        Next Node

        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "IDv" Then
                Dim header_id As Integer = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                Try
                    'Open Connection
                    Using Conn As New OdbcConnection(ConnString)
                        Conn.Open()

                        Dim CmdHeaderString1 As String = ""
                        Dim Cmd4 As New OdbcCommand(CmdHeaderString1, Conn)
                        With Cmd4
                            .CommandText = "UPDATE OrderHeaders SET status=32 WHERE Header_id = " + Str(header_id)
                            .ExecuteNonQuery()
                        End With
                    End Using
                Catch ex As Exception
                    MsgBox("Fout opslag wpsklaar: " + ex.Message, MsgBoxStyle.OkOnly)
                End Try
                Update_Boek()
                Exit Sub
            End If
        End If

        If id_counter = 1 Then Exit Sub

        Dim id As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim cmdstring6 As String = "SELECT wps_flag FROM OrderKarLines WHERE 1=0"
                Dim Cmd As New OdbcCommand(cmdstring6, Conn)
                For i = 1 To id_counter - 1

                    Dim reader5 As OdbcDataReader
                    Dim cmd5 As New OdbcCommand("SELECT agenda_mark FROM orderheaders where header_id = " + Trim(Str(mark_idlist(i))), Conn)
                    reader5 = cmd5.ExecuteReader()
                    If reader5.HasRows Then
                        reader5.Read()
                        Dim mark As Integer = reader5("agenda_mark")
                        If mark = 0 Then
                            Cmd.CommandText = "UPDATE OrderKarLines SET Wps_flag=1 WHERE header_id = " + Trim(Str(mark_idlist(i)))
                            Cmd.ExecuteNonQuery()

                            Cmd.CommandText = "UPDATE OrderKarren SET Wps_status=6 WHERE header_id = " + Trim(Str(mark_idlist(i)))
                            Cmd.ExecuteNonQuery()
                        End If
                    End If

                Next
            End Using
        Catch ex As Exception
            MsgBox("Fout opslag wpsklaar: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        For i = 1 To id_counter - 1
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, mark_idlist(i))
        Next

    End Sub
    Private Sub Orders_Mark_Click_old(ByVal sender As System.Object, ByVal e As System.EventArgs)


        ' mark = 0 'geen mark
        ' mark = 1 'attentie mark
        ' mark = 2 'reservering
        ' mark = 3 'vervoer temp flag

        Dim header_id As Integer = -1
        If Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If

        If header_id < 0 Then Exit Sub

        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim Reader As OdbcDataReader

        Dim id As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim CmdHeaderString As String = "select * from " + orderheader_db + " WHERE Header_id = " + Str(header_id)
                Dim Cmd As New OdbcCommand(CmdHeaderString, Conn)

                Reader = Cmd.ExecuteReader()
                Dim mark As Integer = 0
                If Reader.HasRows Then
                    Reader.Read()
                    mark = CHint(Reader("agenda_mark"))
                End If
                Reader.Close()
                If mark = 1 Or mark = 3 Then
                    Cmd.CommandText = "UPDATE " + orderheader_db + " SET agenda_mark=0 WHERE header_id = " + Trim(Str(header_id))
                    Cmd.ExecuteNonQuery()
                End If
                If mark = 0 Then
                    Cmd.CommandText = "UPDATE " + orderheader_db + " SET agenda_mark=1 WHERE header_id = " + Trim(Str(header_id))
                    Cmd.ExecuteNonQuery()
                End If

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag agenda mark: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id)
    End Sub
    Private Sub Orders_Mark_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Orders_Mark.Click


        ' mark = 0 'geen mark
        ' mark = 1 'attentie mark
        ' mark = 2 'reservering
        ' mark = 3 'vervoer temp flag

        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub
        Dim id As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                For i = 1 To id_counter - 1
                    Dim header_id As Integer = mark_idlist(i)
                    Dim Cmd As New OdbcCommand("select * from orderheaders WHERE Header_id = ?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", header_id)
                    Dim reader As OdbcDataReader
                    Reader = Cmd.ExecuteReader()
                    Dim mark As Integer = 0
                    If Reader.HasRows Then
                        Reader.Read()
                        mark = CHint(Reader("agenda_mark"))
                    End If
                    Reader.Close()
                    If mark = 1 Or mark = 3 Then
                        Cmd.CommandText = "UPDATE orderheaders SET agenda_mark=0 WHERE header_id = ?"
                        Cmd.Parameters.Clear()
                        Cmd.Parameters.AddWithValue("", header_id)
                        Cmd.ExecuteNonQuery()
                    End If
                    If mark = 0 Then
                        Cmd.CommandText = "UPDATE orderheaders SET agenda_mark=1 WHERE header_id = ?"
                        Cmd.Parameters.Clear()
                        Cmd.Parameters.AddWithValue("", header_id)
                        Cmd.ExecuteNonQuery()
                    End If
                Next

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag agenda mark: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        For i = 1 To id_counter - 1
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, mark_idlist(i))
        Next



    End Sub
    Private Sub SetMark(ByVal setmark As Boolean, ByVal header_id As Integer)
        ' mark = 0 'geen mark
        ' mark = 1 'attentie mark
        ' mark = 2 'reservering
        ' mark = 3 'vervoer temp flag
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand("select * from orderheaders WHERE Header_id = ?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", header_id)
                Dim reader As OdbcDataReader
                reader = Cmd.ExecuteReader()
                Dim mark As Integer = 0
                If reader.HasRows Then
                    reader.Read()
                    mark = CHint(reader("agenda_mark"))
                End If
                reader.Close()
                If setmark = True Then
                    If mark = 0 Then
                        Cmd.CommandText = "UPDATE orderheaders SET agenda_mark=1 WHERE header_id = ?"
                        Cmd.Parameters.Clear()
                        Cmd.Parameters.AddWithValue("", header_id)
                        Cmd.ExecuteNonQuery()
                    End If
                End If
                If setmark = False Then
                    If mark = 1 Then
                        Cmd.CommandText = "UPDATE orderheaders SET agenda_mark=0 WHERE header_id = ?"
                        Cmd.Parameters.Clear()
                        Cmd.Parameters.AddWithValue("", header_id)
                        Cmd.ExecuteNonQuery()
                    End If
                End If


            End Using
        Catch ex As Exception
            MsgBox("Fout opslag agenda mark: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        Set_Database_reload()
    End Sub

    Private Sub KoperscodeKopierenToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        'If Order_invoer_FlexGrid.Rows.Count > 1 Then
        '    Dim row As Integer = Order_invoer_FlexGrid.Row
        '    If row < 1 Then row = 1
        '    Dim kopercode As String = Order_invoer_FlexGrid.Item(row, 13)
        '    For i = 1 To Order_invoer_FlexGrid.Rows.Count - 1
        '        If Order_invoer_FlexGrid.Item(i, 13) = "" Then
        '            Order_invoer_FlexGrid.Item(i, 13) = kopercode
        '        End If
        '    Next
        'End If
    End Sub
    Private Sub OrderKopierenToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrderKopierenToolStripMenuItem.Click


        If OrderAanpassen() = True Then
            'erase line id's 

            Dim labels As Boolean = False
            For i = 1 To Order_invoer_FlexGrid.Rows.Count - 1
                If Val(Order_invoer_FlexGrid.Item(i, 15)) > 0 Then  'labels?
                    labels = True
                End If
            Next

            '

            For i = 1 To Order_invoer_FlexGrid.Rows.Count - 1
                Order_invoer_FlexGrid.Item(i, 0) = 0
                Order_invoer_FlexGrid.Item(i, 15) = 0  'erase label ids
            Next

            'erase header id 
            Order_id_lbl.Text = "0"
            Order_versie_lbl.Text = "0"

            'unlock
            Order_Slot_Chk.Enabled = False
            Order_Slot_Chk.Tag = "System"
            Order_Slot_Chk.Checked = False
            Order_Slot_Chk.Tag = ""

            ' C1Tab.SelectedTab = C1Tab.TabPages(0)
            SetTabPage("Order invoer")

            If labels = True Then
                MsgBox("Let op, stikkers opnieuw aanmaken!")
            End If


        End If
    End Sub
    
    Private Sub Order_herbereken_prijzen_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_herbereken_prijzen.Click


        For i = 1 To Order_invoer_FlexGrid.Rows.Count - 1

            Dim prijskleur = 0
            Dim actie_type As Integer
            Dim koper_ean As String = Order_ean_lbl.Text
            Dim accessoire_id As Integer = Order_invoer_FlexGrid.Item(i, acce1col)
            Dim soortid As Integer = Order_invoer_FlexGrid.Item(i, soortcol)
            Dim huidige_prijs As Double = ZoekPrijs(soortid, koper_ean, order_date, prijskleur, actie_type)
            Dim nieuwe_prijs As Double = FindAccessoirePrijs(koper_ean, huidige_prijs, accessoire_id, soortid, order_date, actie_type)
            Order_invoer_FlexGrid.Item(i, prijscol) = nieuwe_prijs
            Order_invoer_FlexGrid.Item(i, actiecol) = Str(actie_type)
            Order_invoer_FlexGrid.SetCellStyle(i, 5, "WarningColor")

        Next i

    End Sub
    Private Sub Order_Prijscor_plus_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Prijscor_plus_but.Click
        Dim prijs As Double = Val(Order_Prijscor_prijs_txt.Text)
        Dim prijscol As Integer = FindCol(Order_invoer_FlexGrid, "Prijs")
        With Order_invoer_FlexGrid
            For i = 1 To .Rows.Count - 1
                .Item(i, prijscol) = .Item(i, prijscol) + prijs
            Next i
        End With
    End Sub
    Private Sub Order_Prijscor_min_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Prijscor_min_but.Click
        Dim prijs As Double = Val(Order_Prijscor_prijs_txt.Text)
        Dim prijscol As Integer = FindCol(Order_invoer_FlexGrid, "Prijs")
        With Order_invoer_FlexGrid
            For i = 1 To .Rows.Count - 1
                .Item(i, prijscol) = .Item(i, prijscol) - prijs
            Next i
        End With
    End Sub
    Private Sub Order_Prijscor_minS_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Prijscor_minS_but.Click
        Dim prijs As Double = Val(Order_Prijscor_prijs_txt.Text)

        With Order_invoer_FlexGrid
            For i = 1 To .Rows.Count - 1
                If .IsCellSelected(i, soortcol) Or .IsCellSelected(i, prijscol) Then
                    .Item(i, prijscol) = .Item(i, prijscol) - prijs
                End If
            Next i
        End With
    End Sub
    Private Sub Order_Prijscor_plusS_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Prijscor_plusS_but.Click
        Dim prijs As Double = Val(Order_Prijscor_prijs_txt.Text)
  
        With Order_invoer_FlexGrid
            For i = 1 To .Rows.Count - 1
                If .IsCellSelected(i, soortcol) Or .IsCellSelected(i, prijscol) Then
                    .Item(i, prijscol) = .Item(i, prijscol) + prijs
                End If
            Next i
        End With
    End Sub

    Private Sub Order_Opm_addcontact_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_Opm_addcontact_but.Click

        Dim koper_ean As String = Order_ean_lbl.Text
        If koper_ean <> "0000000000000" And Order_Opm_addcontact_txt.Text <> "" Then

            Order_Opm_addcontact_txt.Text = Order_Opm_addcontact_txt.Text.Replace("%", "#")
            Order_Opm_addcontact_txt.Text = Order_Opm_addcontact_txt.Text.Replace(";", ":")
            Order_Opm_addcontact_txt.Text = Order_Opm_addcontact_txt.Text.Replace("'", "`")

            Dim CmdString As String = "select * from klanten where ean ='" + koper_ean + "'"
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)


                    Conn.Open()
                    Dim Cmd As New OdbcCommand(CmdString, Conn)

                    Dim Reader As OdbcDataReader
                    Dim opmerking_contacts As String = "-;0"
                    Reader = Cmd.ExecuteReader

                    'read contacts
                    If Reader.HasRows Then
                        Reader.Read()
                        opmerking_contacts = CHstr(Reader("opmerking_contacts"))
                    End If
                    Reader.Close()

                    'create new line in opmerkingen tabel
                    CmdString = "SELECT * FROM contact_opmerkingen WHERE 1=0"
                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                    Cmd2.CommandText = "INSERT INTO contact_opmerkingen(opmerking) VALUES('-')"
                    Cmd2.ExecuteNonQuery()
                    Dim opmerking_id As Integer = 0
                    If postgress = True Then
                        Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('contact_opmerkingen','id'))", Conn)
                        opmerking_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                    Else
                        Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                        opmerking_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                    End If

                    'schijf nieuw contact 
                    opmerking_contacts = opmerking_contacts + "%" + Order_Opm_addcontact_txt.Text + ";" + Trim(Str(opmerking_id))

                    Dim CmdString6 As String = "SELECT * FROM klanten WHERE 1=0"
                    Dim Cmd6 As New OdbcCommand(CmdString6, Conn)
                    Cmd6.CommandText = "UPDATE klanten SET opmerking_contacts = '" + opmerking_contacts + "' WHERE ean = '" + koper_ean + "'"
                    Cmd6.ExecuteNonQuery()

                    Order_Opm_addcontact_txt.Text = ""

                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (update contact_opmerkingen)" + ex.Message)
                MessageBox.Show("Database fout: (update contact_opmerkingen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

            verwerk_opmerkingen(koper_ean, True)

        End If
    End Sub
    Private Sub orders_opmerking_opslaan_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles orders_opmerking_opslaan.Click

        Dim koper_ean As String = Order_ean_lbl.Text
        If koper_ean <> "0000000000000" Then


            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)

                    Conn.Open()
                    ' Dim opmerking_algemeen As String = Mid(Order_OpmAlgemeen_txt.Text.Replace("'", "`"), 1, 490)
                    Dim opmerking As String = Mid(Order_opmerking_txt.Text.Replace("'", "`"), 1, 290)

                    Dim CmdString5 As String = "SELECT * FROM klanten WHERE 1=0"
                    Dim Cmd5 As New OdbcCommand(CmdString5, Conn)
                    Cmd5.CommandText = "UPDATE klanten SET opmerking = '" + opmerking + "' WHERE ean = '" + koper_ean + "'"
                    Cmd5.ExecuteNonQuery()

                    'Dim CmdString6 As String = "SELECT * FROM klanten WHERE 1=0"
                    'Dim Cmd6 As New OdbcCommand(CmdString6, Conn)
                    'Cmd6.CommandText = "UPDATE klanten SET opmerking_algemeen = '" + opmerking_algemeen + "' WHERE ean = " + koper_ean
                    'Cmd6.ExecuteNonQuery()

                    Dim tabcount As Integer = Order_OpmTab.TabCount

                    If tabcount > 2 Then
                        Dim kopercounter As Integer = 1
                        For i = 3 To tabcount - 2
                            Dim kopertext As String = ""
                            Dim koperid As String = ""
                            Select Case kopercounter
                                Case 1
                                    kopertext = Mid(Order_OpmKoper1_txt.Text.Replace("'", "`"), 1, 990)
                                    koperid = Order_OpmKoper1_txt.Tag
                                Case 2
                                    kopertext = Mid(Order_OpmKoper2_txt.Text.Replace("'", "`"), 1, 990)
                                    koperid = Order_OpmKoper2_txt.Tag
                                Case 3
                                    kopertext = Mid(Order_OpmKoper3_txt.Text.Replace("'", "`"), 1, 990)
                                    koperid = Order_OpmKoper3_txt.Tag
                                Case 4
                                    kopertext = Mid(Order_OpmKoper4_txt.Text.Replace("'", "`"), 1, 990)
                                    koperid = Order_OpmKoper4_txt.Tag
                                Case 5
                                    kopertext = Mid(Order_OpmKoper5_txt.Text.Replace("'", "`"), 1, 990)
                                    koperid = Order_OpmKoper5_txt.Tag
                                Case 6
                                    kopertext = Mid(Order_OpmKoper6_txt.Text.Replace("'", "`"), 1, 990)
                                    koperid = Order_OpmKoper6_txt.Tag
                                Case 7
                                    kopertext = Mid(Order_OpmKoper7_txt.Text.Replace("'", "`"), 1, 990)
                                    koperid = Order_OpmKoper7_txt.Tag
                                Case 8
                                    kopertext = Mid(Order_OpmKoper8_txt.Text.Replace("'", "`"), 1, 990)
                                    koperid = Order_OpmKoper8_txt.Tag
                            End Select
                            kopercounter = kopercounter + 1
                            If koperid <> "" Then
                                'update line in opmerkingen tabel
                                Dim CmdString As String = "SELECT * FROM contact_opmerkingen WHERE 1=0"
                                Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                Cmd2.CommandText = "update contact_opmerkingen SET opmerking = '" + kopertext + "' WHERE id = " + koperid
                                Cmd2.ExecuteNonQuery()
                            End If
                        Next i
                    End If


                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (update contact_opmerkingen)" + ex.Message)
                MessageBox.Show("Database fout: (update contact_opmerkingen)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        End If

    End Sub

    Private Sub Order_aanvulling_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_aanvulling_chk.CheckedChanged
        'find selected item
        If Order_aanvulling_chk.Tag = "System" Then Exit Sub 'cancel sub als systeem de flag zet

        Dim header_id As Integer = -1
        For i = 0 To TreeView1.Nodes.Count - 1
            If TreeView1.Nodes(i).Checked = True And Mid(TreeView1.Nodes(i).Tag, 1, 2) = "ID" Then
                header_id = Val(Mid(TreeView1.Nodes(i).Tag, 4))
                Exit For
            End If
        Next i
        If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 2) = "ID" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If

        If header_id = -1 Then
            MsgBox("Selecteer eerst de order waarop je een aanvulling wil maken")
        Else
            If Order_aanvulling_chk.Checked = True Then
                Order_aanvulling_chk.Tag = Trim(Str(header_id))
                Order_aanvulling_chk.Text = "Aanvulling : " + Trim(Str(header_id))
            Else
                Order_aanvulling_chk.Tag = "0"
                Order_aanvulling_chk.Text = "Aanvulling"
            End If

        End If

    End Sub
    Private Sub Order_aanvulling_chk_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles Order_aanvulling_chk.Click
        If Order_Pakboninfo_txt.Text = "" Or Order_Pakboninfo_txt.Text = " " Then
            Order_Pakboninfo_txt.Text = "AANVULLING!"
        End If
    End Sub
    Private Sub StickersPrintenToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) 
        If Order_invoer_FlexGrid.Rows.Count > 1 Then
            Dim row As Integer = Order_invoer_FlexGrid.Row
            Form9.StartPosition = FormStartPosition.CenterScreen
            Form9.Show()
            Application.DoEvents()
            Form9.Labelnr_invoer_txt.Text = Order_invoer_FlexGrid.Item(row, 15)
        End If

    End Sub
    Private Sub OrdersMenuAanvulling_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrdersMenuAanvulling.Click
        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderheader_db As String = "OrderHeaders" + orderyear

        'zoek eerste 2 headers
        Dim header1_id As Integer = -1
        Dim header2_id As Integer = -1
        Dim search As Integer = 1

        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                If search = 1 Then
                    header1_id = Val(Mid(Node.Tag, 4))
                End If
                If search = 2 Then
                    header2_id = Val(Mid(Node.Tag, 4))
                    Exit For
                End If
                search = search + 1
            End If

        Next Node

        If header1_id = 0 Or header2_id = 0 Then Exit Sub

       

        ' write order header to database



        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'read time 
                Dim pakbonopmerking As String = ""
                Dim pakbonopmerking2 As String = ""
                Dim vestiging1 As Integer = 0
                Dim locatiedif As String = ""
                Dim CmdHeaderString As String = "select * from " + orderheader_db + " WHERE Header_id = " + Str(header1_id)
                Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmdr.ExecuteReader()
                Dim afleverdatum As Date = Now
                If Reader.HasRows Then
                    Reader.Read()
                    afleverdatum = CType(Reader("afleverdatum"), Date)
                    pakbonopmerking = CHstr(Reader("pakbon_opmerking"))
                    vestiging1 = CHint(Reader("vestiging"))
                End If
                Reader.Close()

                Dim vestiging2 As Integer = 0
                Dim CmdHeaderString2 As String = "select * from " + orderheader_db + " WHERE Header_id = " + Str(header2_id)
                Dim Cmdr2 As New OdbcCommand(CmdHeaderString2, Conn)
                Dim Reader2 As OdbcDataReader
                Reader2 = Cmdr2.ExecuteReader()
                If Reader2.HasRows Then
                    Reader2.Read()
                    pakbonopmerking2 = CHstr(Reader2("pakbon_opmerking"))
                    vestiging2 = CHint(Reader2("vestiging"))
                End If
                Reader2.Close()
                If vestiging1 <> vestiging2 Then
                    locatiedif = "Op kar van andere locatie"
                End If

                'bepaal aantal karren in order 1


                Dim Cmd3 As New OdbcCommand("select * from orderkarren WHERE Header_id = ?", Conn)
                Cmd3.Parameters.Clear()
                Cmd3.Parameters.AddWithValue("", header1_id)
                Dim Reader3 As OdbcDataReader
                Reader3 = Cmd3.ExecuteReader()
                Dim karcount As Integer = 0
                Dim barcode As String = ""
                Do While Reader3.Read()
                    karcount = karcount + 1
                    barcode = CHstr(Reader3("barcode"))
                Loop
                Reader3.Close()
                Dim barcode_short As String = Mid(barcode, Len(barcode) - 2, 3)


                'if 1 kar then auto
                'if meer karren then karoverzicht
                If karcount < 2 Then

                    'write new info to database
                    'Execute Query
                    Dim cmdstring As String = ""
                    Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                    Cmd2.CommandText = "UPDATE " + orderheader_db + " SET aanvulling=?, pakbon_opmerking=?,afleverdatum=? WHERE header_id = " + Trim(Str(header2_id))
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", header1_id)
                    Cmd2.Parameters.AddWithValue("", "AANVULLING " + locatiedif + " KAR : " + barcode_short + vbCrLf + pakbonopmerking2)
                    Cmd2.Parameters.AddWithValue("", Format(afleverdatum, "yyyy-MM-dd HH:mm"))
                    Cmd2.ExecuteNonQuery()
                    Set_Boek_reload()
                    Update_Boek()
                Else
                    'open karindeling order 1
                    kar_aanvulling1_but.Visible = True
                    kar_aanvulling2_but.Visible = True
                    kar_aanvulling3_but.Visible = True
                    kar_aanvulling4_but.Visible = True
                    PanelKarindelingOnder.Enabled = False
                    PanelKarindelingMidden.Enabled = True
                    PanelKarIndelingBoven.Enabled = False
                    header2_aanvulling = header2_id 'global save
                    Show_Karindeling(header1_id)
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Fout OrdersMenuAanvulling: " + ex.Message)
            MsgBox("Fout OrdersMenuAanvulling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

    End Sub
    Private Sub OrdersMenuVerzamelkar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrdersMenuVerzamelkar.Click
        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderheader_db As String = "OrderHeaders" + orderyear

        'zoek verzamelkar
        Dim header_vk As Integer = -1

        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "IDv" Then
                header_vk = Val(Mid(Node.Tag, 4))
            End If
        Next Node

        If header_vk = -1 Then
            MsgBox("Verzamel kar niet gevonden")
            Exit Sub
        End If

        'maak lijst id's 
        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        If id_counter = 1 Then Exit Sub
        Dim verzamelkar_ean As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'read time 

                Dim CmdHeaderString As String = "select * from " + orderheader_db + " WHERE Header_id = " + Str(header_vk)
                Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmdr.ExecuteReader()
                Dim afleverdatum As Date = Now
                If Reader.HasRows Then
                    Reader.Read()
                    verzamelkar_ean = CHstr(Reader("koper_ean"))
                    afleverdatum = CType(Reader("afleverdatum"), Date)
                End If
                Reader.Close()

                'write new info to database
                'Execute Query
                For headercount = 1 To id_counter - 1
                    'check of deze koper in kopersgroep staat

                    'read koper ean
                    Dim CmdHeaderString2 As String = "select * from " + orderheader_db + " WHERE Header_id = " + Trim(Str(mark_idlist(headercount)))
                    Dim Cmd2 As New OdbcCommand(CmdHeaderString2, Conn)
                    Dim Reader2 As OdbcDataReader
                    Reader2 = Cmd2.ExecuteReader()
                    Dim koper_ean As String = ""
                    Dim koper_naam As String = ""
                    Dim opmerking As String = ""
                    If Reader2.HasRows Then
                        Reader2.Read()
                        koper_ean = CHstr(Reader2("koper_ean"))
                        koper_naam = CHstr(Reader2("koper_naam"))
                        opmerking = CHstr(Reader2("pakbon_opmerking"))
                    End If
                    Reader2.Close()

                    'check of ean in kopersgroep_eans 8 of 10 staat
                    Dim koper_in_groep As Boolean = False
                    Dim CmdHeaderString3 As String = ""
                    If verzamelkar_ean = "90000000000005" Then
                        'plantion geen check
                        koper_in_groep = True
                    Else

                        If verzamelkar_ean = "9000000000000" Or verzamelkar_ean = "90000000000001" Or verzamelkar_ean = "90000000000002" Then
                            CmdHeaderString3 = "select * from kopersgroepen2_eans WHERE id=8 and ean = '" + koper_ean + "'" 'westland
                        Else
                            CmdHeaderString3 = "select * from kopersgroepen2_eans WHERE id=10 and ean = '" + koper_ean + "'" 'vba
                        End If

                        Dim Cmd3 As New OdbcCommand(CmdHeaderString3, Conn)
                        Dim Reader3 As OdbcDataReader
                        Reader3 = Cmd3.ExecuteReader()
                        If Reader3.HasRows Then
                            koper_in_groep = True
                        End If
                        Reader3.Close()
                    End If

                    'afleverdatum, aanvullen en kar op NVT zetten
                    If koper_in_groep = True Then
                        Dim cmdstring As String = ""
                        Dim Cmd4 As New OdbcCommand(cmdstring, Conn)
                        Cmd4.CommandText = "UPDATE " + orderheader_db + " SET aanvulling=?, afleverdatum=?, pakbon_opmerking=?, kar_id = 8 WHERE header_id = " + Trim(Str(mark_idlist(headercount)))
                        Cmd4.Parameters.Clear()
                        Cmd4.Parameters.AddWithValue("", header_vk)
                        Cmd4.Parameters.AddWithValue("", Format(afleverdatum, "yyyy-MM-dd HH:mm"))

                        If verzamelkar_ean = "90000000000005" Then
                            opmerking = "Plantion Verzamelkar  " + opmerking
                        Else
                            opmerking = "DFD Verzamelkar  " + opmerking
                        End If
                        Cmd4.Parameters.AddWithValue("", opmerking)
                        Cmd4.ExecuteNonQuery()

                        Dim cmdstring5 As String = ""
                        Dim Cmd5 As New OdbcCommand(cmdstring5, Conn)
                        If verzamelkar_ean = "90000000000005" Then
                            Cmd5.CommandText = "UPDATE orderkarren SET kar_type=15, aantal_lagen=0 WHERE header_id = " + Trim(Str(mark_idlist(headercount)))
                        ElseIf verzamelkar_ean = "9000000000000" Or verzamelkar_ean = "90000000000001" Or verzamelkar_ean = "90000000000002" Then
                            Cmd5.CommandText = "UPDATE orderkarren SET kar_type=13, aantal_lagen=0 WHERE header_id = " + Trim(Str(mark_idlist(headercount)))
                        Else
                            Cmd5.CommandText = "UPDATE orderkarren SET kar_type=14, aantal_lagen=0 WHERE header_id = " + Trim(Str(mark_idlist(headercount)))
                        End If

                        Cmd5.ExecuteNonQuery()

                    Else
                        MsgBox("Koper " + koper_naam + " staat niet op de verzamelkar koperlijst")
                    End If
                Next
            End Using
        Catch ex As Exception
            ErrorLog("Fout OrdersMenuAanvulling: " + ex.Message)
            MsgBox("Fout OrdersMenuAanvulling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        Set_Boek_reload()
        Update_Boek()

    End Sub

    Private Sub OrderStikkersVerzamelkarToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrderStikkersVerzamelkarToolStripMenuItem.Click
   
        Dim ipAddress As String = Inst_printerip_txt.Text
        Dim port As Integer = 9100
        Dim zplcode As String = ""

        Dim header_id As Integer = -1

        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "IDv" Then
                header_id = Val(Mid(Node.Tag, 4))
            End If
        Next Node

        If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "IDv" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If

        If header_id = -1 Then Exit Sub


        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'read time 
                Dim CmdHeaderString As String = "select oh.header_id, SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean, oh.sticker FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.status<99 AND oh.aanvulling = " + Str(header_id) + " GROUP BY ol.koper_naam"

                If TreeviewVestiging = 1 Then
                    CmdHeaderString = "select oh.header_id, SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean, oh.sticker FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.vestiging = 1 AND oh.status<99 AND oh.aanvulling = " + Str(header_id) + " GROUP BY ol.koper_naam"
                End If

                If TreeviewVestiging = 2 Then
                    CmdHeaderString = "select oh.header_id, SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean, oh.sticker FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.vestiging = 2 AND oh.status<99 AND oh.aanvulling = " + Str(header_id) + " GROUP BY ol.koper_naam"
                End If
                Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmdr.ExecuteReader()
                Dim afleverdatum As Date = Now
                Do While Reader.Read()
                    Dim oheader_id As Integer = CHint(Reader("header_id"))
                    Dim aantal As Integer = CHint(Reader("taantal"))
                    Dim koper_naam As String = CHstr(Reader("koper_naam"))
                    Dim koper_ean As String = CHstr(Reader("koper_ean"))
                    Dim sticker As Integer = CHint(Reader("sticker"))

                    If sticker = 12 Then '
                        'dfd sticker al geprint voor deze order, skip
                    Else
                        'update dfd flag
                        Dim Cmd4 As New OdbcCommand("UPDATE OrderHeaders SET sticker=12 WHERE Header_id = ?", Conn)
                        Cmd4.Parameters.AddWithValue("", oheader_id)
                        Cmd4.ExecuteNonQuery()

                        Dim koper_naam2 As String = ""
                        For i = 1 To Len(koper_naam)
                            Dim zplchar As String = Mid(koper_naam, i, 1)
                            If zplchar = "~" Or zplchar = "^" Or zplchar = "&" Or zplchar = "_" Then
                                koper_naam2 = koper_naam2 + "+"
                            Else
                                koper_naam2 = koper_naam2 + zplchar
                            End If
                        Next

                        Dim admnr As String = ""
                        Dim opmerking As String = ""
                        Dim veiling As Integer = 0
                        Dim bdo As Integer = 3
                        Dim CmdString2 As String = "SELECT * FROM klanten where ean = '" + koper_ean + "'"
                        Dim Reader2 As OdbcDataReader
                        Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()
                            bdo = CHint(Reader2("bdo"))

                            veiling = CHint(Reader2("veiling_voorkeur"))
                            If veiling = 2 Then 'vba
                                bdo = 1 'vba brief op vba leveren
                                admnr = CHint(Reader2("veilingnr_vba"))
                                If admnr = 0 Then
                                    admnr = CHint(Reader2("veilingnr_westland"))
                                End If
                            Else
                                admnr = CHint(Reader2("veilingnr_westland"))
                            End If
                        End If
                        Dim ZPLString2 As String = ""
                        Dim ZPLString3 As String = ""
                        Dim ZPLString4 As String = ""

                        If inst_dfdkleinprint.Checked = True Then
                            ZPLString2 = "^XA^FO25,100^A0N,40,40^FH^FD" + koper_naam2 + "^FS"
                            ZPLString4 = "^FO25,200^A0N,40,40^FH^FD" + "admnr: " + admnr + "^FS"
                        Else

                            If Len(koper_naam2) < 18 Then
                                ZPLString2 = "^XA^FO25,250^A0N,60,60^FH^FD" + koper_naam2 + "^FS"
                                ZPLString4 = "^FO25,350^A0N,60,60^FH^FD" + "admnr: " + admnr + "^FS"
                            Else
                                ZPLString2 = "^XA^FO25,150^A0N,60,60^FH^FD" + Mid(koper_naam2, 1, 17) + "^FS"
                                ZPLString3 = "^FO25,250^A0N,60,60^FH^FD" + Mid(koper_naam2, 18) + "^FS"
                                ZPLString4 = "^FO25,350^A0N,60,60^FH^FD" + "admnr: " + admnr + "^FS"
                            End If
                        End If
                        zplcode = ZPLString2 + ZPLString3 + ZPLString4 + "^PQ" + Trim(Str(aantal)) + "~SD23^XZ"
                        'Open Connection
                        Dim client As New System.Net.Sockets.TcpClient
                        client.Connect(ipAddress, port)

                        'Write ZPL String to Connection
                        Dim writer As New System.IO.StreamWriter(client.GetStream())
                        writer.Write(zplcode)

                        writer.Flush()

                        writer.Close()
                        client.Close()
                    End If
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Fout opslaan verzamelkar: " + ex.Message)
            MsgBox("Fout opslaan verzamelkar: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        PrintDecorumFijnDistributieA4(header_id)
        MsgBox("Stikkers en A4 opgestuurd naar printer", MsgBoxStyle.OkOnly)

    End Sub

    Private Sub PrintDecorumFijnDistributieA4(header_id As Integer)
        Try
            ' Open(Connection)
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd2 As New OdbcCommand("INSERT INTO printer_spooler_dfd SET header_id=?, jenptenhave=?,vestiging=?", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", header_id)
                Cmd2.Parameters.AddWithValue("", jenptenhave)
                Cmd2.Parameters.AddWithValue("", TreeviewVestiging)
                Cmd2.ExecuteNonQuery()
            
            End Using
        Catch ex As Exception
            MsgBox("Fout opslag wps versturen: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub

    Private Sub Orders_pakbonnenprinten_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Orders_pakbonnenprinten.Click

        Dim mark_idlist(101) As Integer

        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If

        Next Node


        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "IDv" Then
                Dim header_id As Integer = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                Try
                    'Open Connection
                    Using Conn As New OdbcConnection(ConnString)
                        Conn.Open()

                        Dim CmdHeaderString1 As String = ""
                        Dim Cmd4 As New OdbcCommand(CmdHeaderString1, Conn)
                        With Cmd4
                            .CommandText = "UPDATE OrderHeaders SET status=32 WHERE Header_id = " + Str(header_id)
                            .ExecuteNonQuery()
                        End With
                    End Using
                Catch ex As Exception
                    MsgBox("Fout pakbonprintlist: " + ex.Message, MsgBoxStyle.OkOnly)
                End Try
                Update_Boek()
                Exit Sub
            End If
        End If


        If id_counter = 1 Then Exit Sub


        Dim id As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For i = 1 To id_counter - 1

                    Dim header_id As Integer = mark_idlist(i)
                    Dim Cmd As New OdbcCommand("select * from orderheaders WHERE Header_id = ?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", header_id)
                    Dim reader0 As OdbcDataReader
                    reader0 = Cmd.ExecuteReader()
                    Dim mark As Integer = 0
                    If reader0.HasRows Then
                        reader0.Read()
                        mark = CHint(reader0("agenda_mark"))
                    End If
                    reader0.Close()

                    If mark = 0 Then


                        'Print pakbonnen van order
                        Dim reader As OdbcDataReader
                        Dim Cmd2 As New OdbcCommand("select kar_id from OrderKarren WHERE header_id = ?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", mark_idlist(i))
                        reader = Cmd2.ExecuteReader()
                        Do While reader.Read()
                            'read kar-id
                            Dim kar_id As Integer = CHint(reader("kar_id"))

                            Dim reader5 As OdbcDataReader
                            Dim Cmd5 As New OdbcCommand("select wps_flag from OrderKarlines WHERE kar_id = ?", Conn)
                            Cmd5.Parameters.Clear()
                            Cmd5.Parameters.AddWithValue("", kar_id)
                            reader5 = Cmd5.ExecuteReader()
                            If reader5.HasRows Then
                                reader5.Read()
                                Dim wps_flag As Integer = CHint(reader5("wps_flag"))

                                If wps_flag > 0 Then
                                    Dim answer As Integer = MsgBox("Van deze order zijn al pakbonnen afgedrukt, nog een keer afdrukken?", vbYesNo)
                                    If answer = vbYes Then
                                        wps_flag = 0
                                    End If
                                End If

                                If wps_flag = 0 Then


                                    'welke printer

                                    Dim printernr As Integer = 1
                                    Dim reader6 As OdbcDataReader
                                    Dim Cmd6 As New OdbcCommand("select vestiging from Orderlines WHERE OrderHeader_id = ?", Conn)
                                    Cmd6.Parameters.Clear()
                                    Cmd6.Parameters.AddWithValue("", mark_idlist(i))
                                    reader6 = Cmd6.ExecuteReader()
                                    If reader6.HasRows Then
                                        Dim vestiging As Integer = CHint(reader6("vestiging"))
                                        If vestiging = 2 Then printernr = 2
                                    End If


                                    'split order?
                                    Dim jenp_split As Boolean = False
                                    Dim CmdKarLineString As String = "select * from orderkarlines WHERE kar_id = " + Str(kar_id)
                                    Dim CmdKarlines As New OdbcCommand(CmdKarLineString, Conn)
                                    Dim KarLineReader As OdbcDataReader
                                    KarLineReader = CmdKarlines.ExecuteReader
                                    Dim flagset As Boolean = False
                                    If KarLineReader.HasRows Then
                                        flagset = KarLineReader("wps17_flag")
                                        Do While KarLineReader.Read()
                                            Dim splitflag As Boolean = KarLineReader("wps17_flag")
                                            If splitflag <> flagset Then
                                                jenp_split = True
                                                Exit Do
                                            End If
                                        Loop
                                    End If


                                    'insert into printerspooler
                                    If jenp_split = False Then
                                        Dim Cmd3 As New OdbcCommand("INSERT INTO printer_spooler SET kar_id=?, datum=?, printer=?", Conn)
                                        Cmd3.Parameters.Clear()
                                        Cmd3.Parameters.AddWithValue("", kar_id)
                                        Cmd3.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                                        Cmd3.Parameters.AddWithValue("", printernr)
                                        Cmd3.ExecuteNonQuery()
                                    Else
                                        'deel order pakbon, 2 pakbonnen sturen.
                                        Dim Cmd3 As New OdbcCommand("INSERT INTO printer_spooler SET kar_id=?, datum=?, printer=?, wpsdeelorder=?", Conn)
                                        Cmd3.Parameters.Clear()
                                        Cmd3.Parameters.AddWithValue("", kar_id)
                                        Cmd3.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                                        Cmd3.Parameters.AddWithValue("", printernr)
                                        Cmd3.Parameters.AddWithValue("", 1)
                                        Cmd3.ExecuteNonQuery()

                                        Dim Cmd4 As New OdbcCommand("INSERT INTO printer_spooler SET kar_id=?, datum=?, printer=?, wpsdeelorder=?", Conn)
                                        Cmd4.Parameters.Clear()
                                        Cmd4.Parameters.AddWithValue("", kar_id)
                                        Cmd4.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                                        Cmd4.Parameters.AddWithValue("", printernr)
                                        Cmd4.Parameters.AddWithValue("", 2)
                                        Cmd4.ExecuteNonQuery()

                                    End If

                                    'Set wps flag
                                    Dim Cmd9 As New OdbcCommand("UPDATE OrderKarLines SET Wps_flag=1 WHERE kar_id = ?", Conn)
                                    Cmd9.Parameters.Clear()
                                    Cmd9.Parameters.AddWithValue("", kar_id)
                                    Cmd9.ExecuteNonQuery()

                                    Cmd.CommandText = "UPDATE OrderKarren SET Wps_status=6 WHERE kar_id = " + Trim(Str(kar_id))
                                    Cmd.ExecuteNonQuery()


                                End If
                            End If

                        Loop
                    End If
                Next
            End Using
        Catch ex As Exception
            MsgBox("Fout opslag printpakbonnen: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        For i = 1 To id_counter - 1
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, mark_idlist(i))
        Next

    End Sub
    Private Sub GP2ToolStripMenuItem_Click(sender As System.Object, e As System.EventArgs) Handles GP2ToolStripMenuItem.Click
        If Order_invoer_FlexGrid.Rows.Count > 1 Then
            Dim row As Integer = Order_invoer_FlexGrid.Row
            If row < 1 Then row = 1
            Order_invoer_FlexGrid.Item(row, 21) = 2
            
        End If
    End Sub
    Private Sub GP3ToolStripMenuItem_Click(sender As System.Object, e As System.EventArgs) Handles GP3ToolStripMenuItem.Click
        If Order_invoer_FlexGrid.Rows.Count > 1 Then
            Dim row As Integer = Order_invoer_FlexGrid.Row
            If row < 1 Then row = 1
            Order_invoer_FlexGrid.Item(row, 21) = 3
           
        End If
    End Sub

    Private Sub OrderNaar900VolgendeDagToolStripMenuItem_Click(sender As System.Object, e As System.EventArgs) Handles OrderNaar900VolgendeDagToolStripMenuItem.Click
        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If
        Next Node


        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub

        Dim id As Integer = 0
        Try
            ' Open(Connection)
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For i = 1 To id_counter - 1
                    Dim datum As Date
                    Dim newdatum As Date
                    Dim header_id As Integer = mark_idlist(i)
                    Dim Cmd As New OdbcCommand("select * from orderheaders WHERE Header_id = ?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", header_id)
                    Dim reader As OdbcDataReader
                    reader = Cmd.ExecuteReader()
                    Dim mark As Integer = 0
                    If reader.HasRows Then
                        reader.Read()
                        mark = CHint(reader("agenda_mark"))
                        datum = CType(reader("afleverdatum"), Date)

                        Dim morgen As Date = DateAdd("d", 1, datum)
                        newdatum = Date.Parse(morgen.ToShortDateString & " 8:00")

                    End If
                    reader.Close()
                    If mark = 0 Then
                        Dim Cmd2 As New OdbcCommand("UPDATE orderheaders SET afleverdatum=? WHERE header_id = ?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", Format(newdatum, "yyyy-MM-dd HH:mm"))
                        Cmd2.Parameters.AddWithValue("", header_id)
                        Cmd2.ExecuteNonQuery()
                    End If
                Next

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag wps versturen: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        Set_Boek_reload()
        Update_Boek()

    End Sub
    Private Sub Order_ean_lbl_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_ean_lbl.Click
        Clipboard.SetText(Order_ean_lbl.Text)
    End Sub
    Private Sub Orders_PlusAccessoires_but_Click(sender As Object, e As EventArgs) Handles Orders_PlusAccessoires_but.Click

        Dim acce1col As Integer = FindCol(Order_invoer_FlexGrid, "Accessoire1")
        Dim acce2col As Integer = FindCol(Order_invoer_FlexGrid, "Accessoire2")
        Dim acce4col As Integer = FindCol(Order_invoer_FlexGrid, "Accessoire4")
        Dim acce5col As Integer = FindCol(Order_invoer_FlexGrid, "Accessoire5")
        Dim acce6col As Integer = FindCol(Order_invoer_FlexGrid, "Accessoire6")
        Dim acce7col As Integer = FindCol(Order_invoer_FlexGrid, "Accessoire7")
        Dim acce8col As Integer = FindCol(Order_invoer_FlexGrid, "Accessoire8")

        If Order_invoer_FlexGrid.Cols(acce4col).Visible = False Then
            Order_invoer_FlexGrid.Cols(acce4col).Visible = True
        ElseIf Order_invoer_FlexGrid.Cols(acce5col).Visible = False Then
            Order_invoer_FlexGrid.Cols(acce5col).Visible = True
        ElseIf Order_invoer_FlexGrid.Cols(acce6col).Visible = False Then
            Order_invoer_FlexGrid.Cols(acce6col).Visible = True
        ElseIf Order_invoer_FlexGrid.Cols(acce7col).Visible = False Then
            Order_invoer_FlexGrid.Cols(acce7col).Visible = True
        ElseIf Order_invoer_FlexGrid.Cols(acce8col).Visible = False Then
            Order_invoer_FlexGrid.Cols(acce8col).Visible = True
        End If
    End Sub

#End Region

#Region "Wps & Sdf & Scan"

    Private Sub Orders_WpsVersturen_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Orders_WpsVersturen.Click

        'global var  wps_idlist
        For clearloop = 0 To 100
            wps_idlist(clearloop) = -1
        Next

        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                wps_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        wps_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        'Dim id_counter As Integer = 1
        'For i = 0 To TreeView1.Nodes.Count - 1
        ' If TreeView1.Nodes(i).Checked = True And Mid(TreeView1.Nodes(i).Tag, 1, 3) = "ID:" Then
        ' wps_idlist(id_counter) = Val(Mid(TreeView1.Nodes(i).Tag, 4))
        ' id_counter = id_counter + 1
        ' If id_counter > 100 Then Exit For
        ' End If
        ' Next i
        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                wps_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub

        wps_date = Order_MonthCalendar.SelectionStart

        'TreeView1.CheckBoxes = False
        Orders_WpsVersturen.Enabled = False

        Me.SendToBack()

        'WpsWindow.StartPosition = FormStartPosition.CenterScreen
        WpsWindow.TopMost = True
        WpsWindow.Show()

    End Sub
    Private Sub Orders_SdfVersturen_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Orders_SdfVersturen.Click

        If jenptenhave = False Then
            Orders_SdfVersturenMain(-1, -1)
            Update_Boek()
            MsgBox("Orders verstuurd", vbOKOnly, "SDF")
        Else
            'Orders_SdfVersturenJenP(-1, -1)
            Orders_SdfVersturenJenP2(-1, -1)
            Update_Boek()
            MsgBox("Orders verstuurd", vbOKOnly, "SDF")
        End If


    End Sub

    Private Sub Orders_SdfVersturenJenP2(ByVal SpecifiekeKar_header As Integer, ByVal SpecifiekeKar_id As Integer)

        Dim sdf_idlist(101) As Integer
        For clearloop = 0 To 100
            sdf_idlist(clearloop) = -1
        Next
        Dim id_counter As Integer = 1

        If SpecifiekeKar_header = -1 Then         'geen specifieke kar, dan lijst met id's uit agenda halen
            'global var  sdf_idlist

            'Dim id_counter As Integer = 1
            Dim Nodes As TreeNodeCollection = TreeView1.Nodes
            Dim Node As TreeNode
            For Each Node In Nodes
                If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                    sdf_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                    id_counter = id_counter + 1
                End If

                If Node.Nodes.Count > 0 Then
                    Dim node2 As TreeNode
                    For Each node2 In Node.Nodes
                        If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                            sdf_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                            id_counter = id_counter + 1
                            'Exit For
                        End If
                    Next node2
                End If
            Next Node

            'For i = 0 To TreeView1.Nodes.Count - 1
            'If TreeView1.Nodes(i).Checked = True And Mid(TreeView1.Nodes(i).Tag, 1, 3) = "ID:" Then
            'sdf_idlist(id_counter) = Val(Mid(TreeView1.Nodes(i).Tag, 4))
            'id_counter = id_counter + 1
            ' If id_counter > 100 Then Exit For
            'End If
            ' Next i
            If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
                If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                    sdf_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                    id_counter = id_counter + 1
                End If
            End If
            sdf_date = Order_MonthCalendar.SelectionStart
            If id_counter = 1 Then Exit Sub
        Else
            sdf_idlist(1) = SpecifiekeKar_header
            id_counter = 2
            sdf_date = karindeling_date
        End If

        Dim sdf_ordercount As Integer = id_counter - 1
        Dim orderyear As String = Trim(Str(Year(sdf_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear

        'DebugText.Text = ""

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()


                Me.Cursor = Cursors.WaitCursor

                FormProgressBar.StartPosition = FormStartPosition.CenterScreen
                FormProgressBar.Show()

                Dim progressstep As Integer = (100 / (sdf_ordercount + 1))


                Me.Cursor = Cursors.Default

                For orderloop = 1 To sdf_ordercount
                    Dim header_id As Integer = sdf_idlist(orderloop)

                    'koper ean ophalen + brief-type (ivm factuur generatie ipv sdf versturen) 
                    Dim koper_ean As String = ""
                    Dim veilingbrief_id As Integer = 1
                    Dim aanvulling_headerid As Integer = 0

                    Dim CmdString As String = "select * from " + orderheader_db + " WHERE  Header_id = " + Str(header_id) + " "
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Dim Reader As OdbcDataReader
                    Reader = Cmd.ExecuteReader
                    If Reader.HasRows Then
                        Reader.Read()
                        koper_ean = CHstr(Reader("koper_ean"))
                        veilingbrief_id = CHint(Reader("veilingbrief_id"))
                        aanvulling_headerid = CHint(Reader("aanvulling"))
                    End If

                    'verzamelkar check
                    'staat deze ean in kopersgroep 8 (verzamelkar)
                    Dim nietprinten As Boolean = False
                    If jenptenhave = False Then

                        Dim koper_in_groep As Boolean = False
                        Dim CmdHeaderString3 As String = "select * from kopersgroepen2_eans WHERE id=8 and ean = '" + koper_ean + "'"
                        Dim Cmd3 As New OdbcCommand(CmdHeaderString3, Conn)
                        Dim Reader3 As OdbcDataReader
                        Reader3 = Cmd3.ExecuteReader()
                        If Reader3.HasRows Then
                            koper_in_groep = True
                        End If
                        Reader3.Close()

                        If koper_in_groep = True Then
                            'is het minder als 10 bakjes?

                            Dim CmdHeaderString As String = "select SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.header_id = " + Str(header_id) + " GROUP BY ol.koper_naam"
                            Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                            Dim Reader5 As OdbcDataReader
                            Reader5 = Cmdr.ExecuteReader()
                            Do While Reader5.Read()
                                Dim aantal As Integer = CHint(Reader5("taantal"))
                                Dim koper_naam As String = CHstr(Reader5("koper_naam"))
                                If aantal < 9 And aanvulling_headerid = 0 Then
                                    Dim result As Integer = MessageBox.Show("Koper '" + koper_naam + "' heeft minder als 9 bakken en staat in de verzamelkar lijst. Wilt u deze kar toch versturen naar SDF?", "", MessageBoxButtons.YesNo)
                                    If result = DialogResult.No Then
                                        nietprinten = True
                                    ElseIf result = DialogResult.Yes Then
                                        nietprinten = False
                                    End If
                                End If
                            Loop
                        End If
                        '
                    End If

                    If veilingbrief_id = 3 Then   'factuur?
                        print_factuur(header_id)
                    ElseIf nietprinten = True Then
                        'skip.. niet printen maar handmatig verzamelkar van maken
                    Else
                        ' load kar-info & lines
                        Dim karcounter As Integer = 1


                        Dim Maxregels As Integer = 4
                        If veilingbrief_id = 1 Then  'westland brief 
                            ' 4 regels
                            Maxregels = 5
                        End If
                        If veilingbrief_id = 2 Then  'vba brief 
                            ' 5 regels
                            Maxregels = 4
                        End If
                        If veilingbrief_id = 4 Then   'plantion brief
                            Maxregels = 6
                        End If
                        If veilingbrief_id = 5 Then  ' rhein maas brief 
                            ' 4 regels
                            Maxregels = 5
                        End If
                        Dim CmdKarString As String = ""
                        If SpecifiekeKar_id = -1 Then
                            CmdKarString = "select * from " + orderkarren_db + " WHERE  Header_id = " + Str(header_id) + " "
                        Else
                            CmdKarString = "select * from " + orderkarren_db + " WHERE  Kar_id = " + Str(SpecifiekeKar_id) + " "
                        End If
                        Dim CmdKar As New OdbcCommand(CmdKarString, Conn)
                        Dim KarrenReader As OdbcDataReader
                        KarrenReader = CmdKar.ExecuteReader
                        Dim kar_id_list(100) As Integer
                        Dim karrencount As Integer = 1
                        Dim kartype As Integer = 0
                        Do While KarrenReader.Read()           ' loop :  karren in de order 
                            Dim sdf_flag As Boolean = CHbool(KarrenReader("sdf_flag"))
                            If sdf_flag = False Then
                                kar_id_list(karrencount) = CHint(KarrenReader("kar_id"))
                                kartype = KarrenReader("kar_type")
                                karrencount = karrencount + 1
                            End If
                        Loop

                        'special for dv's 
                        If kartype = 10 Or kartype = 11 And karrencount = 3 Then
                            karrencount = 2  'DV's opsturen als 1 kar (ook al zijn het er 2)
                        End If


                        If karrencount > 1 Then

                            For karloop = 1 To karrencount - 1          ' loop : aantal karren in de order 


                                Dim progres As Integer = Int(progressstep * orderloop)  'progressbar and sleep every 5 orders for .5 seconds.
                                If progres > 100 Then progres = 100
                                FormProgressBar.DataProgressBar.Value = progres
                                Application.DoEvents()
                                Dim every5 As Integer = orderloop Mod 5
                                If every5 = 0 Then
                                    Threading.Thread.Sleep(500)
                                End If

                                Dim sdf_karid = kar_id_list(karloop)

                                'read lines

                                Dim CmdLinecountString As String = ""
                                If Mid(koper_ean, 1, 4) = "0000" Then  'klokorders omgekeert sorteren
                                    If kartype = 10 Or kartype = 11 Then  'DV's
                                        CmdLinecountString = "SELECT id FROM " + orderkarlines_db + " WHERE  kar_id = " + Str(kar_id_list(karloop)) + " OR kar_id = " + Str(kar_id_list(karloop + 1)) + " ORDER BY sorteren ASC"
                                    Else
                                        CmdLinecountString = "SELECT id FROM " + orderkarlines_db + " WHERE  kar_id = " + Str(sdf_karid) + " ORDER BY sorteren DESC"  'normal klok
                                    End If
                                Else
                                    CmdLinecountString = "SELECT id FROM " + orderkarlines_db + " WHERE  kar_id = " + Str(sdf_karid) + " ORDER BY sorteren ASC"  'BB
                                End If
                                Dim line_id_List(Max_Kar_Lines) As Integer
                                Dim CmdLine As New OdbcCommand(CmdLinecountString, Conn)
                                Dim LineReader As OdbcDataReader = CmdLine.ExecuteReader()
                                Dim MaxLineCount As Integer = 1
                                Do While LineReader.Read()
                                    line_id_List(MaxLineCount) = CHint(LineReader("id"))
                                    MaxLineCount = MaxLineCount + 1
                                Loop
                                MaxLineCount = MaxLineCount - 1
                                LineReader.Close()

                                ' een kar kan meerdere brieven hebben, dus onderverdelen in 4/5 regels
                                Dim RegelCounter As Integer = 1
                                Dim Lin_count As Integer = 1
                                Dim brief As Integer = 1

                                Dim edistring As String = ""
                                Do While Lin_count <= MaxLineCount

                                    ' Get and Update UNB counter 
                                    Dim UnbCounter As Integer = 0
                                    Dim UnBCmdString As String = "select UNB_Message_Counter from instellingen"
                                    Dim UnBCmd As New OdbcCommand(UnBCmdString, Conn)
                                    Dim UnBReader As OdbcDataReader
                                    UnBReader = UnBCmd.ExecuteReader
                                    If UnBReader.HasRows Then
                                        UnBReader.Read()
                                        UnbCounter = CHint(UnBReader("UNB_Message_Counter"))
                                    End If
                                    UnbCounter = UnbCounter + 1
                                    UnBReader.Close()
                                    UnBCmd.CommandText = "UPDATE instellingen SET UNB_Message_Counter=?"
                                    UnBCmd.Parameters.Clear()
                                    UnBCmd.Parameters.AddWithValue("", UnbCounter)
                                    UnBCmd.ExecuteNonQuery()

                                    'create new edi header 
                                    edistring = ""
                                    Dim edi_string = create_edi_header(UnbCounter, koper_ean, sdf_karid)          ' header

                                    'create edi lines 
                                    Do While Lin_count <= MaxLineCount And RegelCounter <= Maxregels
                                        Dim edi_line As String = create_edi_lineJenP2(line_id_List(Lin_count), RegelCounter, brief)  'lines
                                        edi_string = edi_string + edi_line
                                        RegelCounter = RegelCounter + 1
                                        Lin_count = Lin_count + 1
                                    Loop
                                    'create edi footer 
                                    Dim edi_footer As String = create_edi_footer(UnbCounter, header_id, edi_string, sdf_karid) 'footer 
                                    edi_string = edi_string + edi_footer

                                    'send edi
                                    Mail_Edi(header_id, edi_string)

                                    If RegelCounter > Maxregels Then
                                        RegelCounter = RegelCounter - Maxregels
                                        brief = brief + 1
                                    End If

                                    C1TabFlorecom.Enabled = True
                                    'C1Tab.SelectedTab = C1Tab.TabPages(2)
                                    '  DebugText1.Text = DebugText1.Text + vbCrLf + vbCrLf + edi_string

                                Loop

                                'update sdf flag 

                                CmdString = "SELECT * FROM " + orderkarren_db + " WHERE kar_id = " + Str(sdf_karid)
                                Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                Cmd2.CommandText = "UPDATE " + orderkarren_db + " SET sdf_flag=TRUE  WHERE kar_id = " + Str(sdf_karid)
                                Cmd2.ExecuteNonQuery()


                            Next


                        End If


                    End If
                    If nietprinten = False Then
                        SetNewStatusFlag(sdf_date, header_id, False)
                    End If
                Next orderloop


                FormProgressBar.Close()
                Me.Cursor = Cursors.Default


                'Update_Boek()
                Set_Boek_reload()

            End Using
        Catch ex As Exception
            ErrorLog("Fout: sdf orderlist" + ex.Message)
            MessageBox.Show("Fout: sdf orderlist" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        'MsgBox("Orders verstuurd", vbOKOnly, "SDF")

    End Sub
    Private Function create_edi_lineJenP2(ByVal karline_id As Integer, ByVal lin_count As Integer, ByVal brief As Integer) As String

        Dim es As String = ""

        Dim LIN_Product_Code As String = "1234"                     '
        Dim IMD_SoortNaam As String = "Campanula Isophylla"         '
        Dim AantalFusten As Integer = 10                            '
        Dim QTY_Aantal As Integer = 10                              '
        Dim DTM_Delivery_Date As Date = Now                         '
        Dim FTX_Text_Literal = "OOO;DECORUM;FOTO;"                  '
        Dim potmaat As Integer = 110                                 '
        Dim hoogte As Integer = 20                                   '
        Dim diameter As Integer = 20                                 ' 
        Dim rijpheid As Integer = 1                                  '
        Dim transporthoogte As Integer = 30                          '
        Dim kwaliteit As String = "A1"                               '
        Dim keurcode As Integer = 1                                  '
        Dim kleur As Integer = 0                                     '
        Dim veilingbrief As Integer = 1   '1 = westland  2= vba  (3 = factuur is al eerder afgevangen)  4 = plantion
        Dim PRI_prijs As Double = 1.0                                '
        Dim PAC_Fust_Code As String = "206"                          '
        Dim MEA_Aantal_per_Fust As String = "8"                      '
        Dim PAC_Kar_Code As String = "1"                             '
        Dim MEA_Aantal_Plant_per_kar As String = "100"               '
        Dim MEA_Aantal_lagen_per_kar As String = "7"                 '
        Dim NAD_buyer_ean As String = "1234567890123"                '
        Dim NAD_deliveringparty_ean As String = "1234567890123"      '
        Dim CC_RFID As String = ""    ' "123456789012345678901234"           '
        Dim PIA_SA_Code As String = ""
        Dim GP As Integer = 1                                        '
        Dim kopercode As String = ""                                 '
        Dim foto As Boolean = False                                  '
        Dim decorum As Boolean = False                               '

        Dim orderyear As String = Trim(Str(Year(sdf_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear
        Dim kar_type As Integer = 0
        Dim keten_ean As String = ""
        Dim sdfbarcode As Integer = 0
        Dim sdfbarcode2 As Integer = 0
        Dim header_id As Integer = -1
        Dim kar_id As Integer = -1
        Dim hoeskleur As Integer = 0
        Dim barcode As String = "1234"
        Dim accessoire_code As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' load data from database
                Dim Reader As OdbcDataReader
                Dim CmdString As String = "SELECT * FROM " + orderkarlines_db + " WHERE id = " + Str(karline_id)
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader
                Dim orderline_id As Integer = -1


                If Reader.HasRows Then
                    Reader.Read()
                    AantalFusten = CHint(Reader("aantal"))       'aantal fusten
                    orderline_id = CHint(Reader("orderline_id"))
                    kar_id = CHint(Reader("kar_id"))
                    header_id = CHint(Reader("header_id"))
                    'sdfbarcode2 = CHint(Reader("sdfbarcode2"))
                End If
                Reader.Close()
                CmdString = "SELECT * FROM " + orderkarren_db + " WHERE kar_id = " + Str(kar_id)
                Dim KarCmd As New OdbcCommand(CmdString, Conn)
                Reader = KarCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    kar_type = CHint(Reader("kar_type"))       'kartype
                    PAC_Kar_Code = "999"
                    If kar_type = 1 Or kar_type = 2 Then  'denen cc
                        PAC_Kar_Code = "2"
                    End If
                    If kar_type = 3 Or kar_type = 9 Then  'veilingkarren
                        PAC_Kar_Code = "1"
                    End If
                    MEA_Aantal_lagen_per_kar = Trim(Str(CHint(Reader("aantal_lagen"))))
                    If (kar_type = 1 Or kar_type = 2) And MEA_Aantal_lagen_per_kar = "1" Then
                        MEA_Aantal_lagen_per_kar = "2"
                    End If
                    CC_RFID = CHstr(Reader("CC_RFID"))
                    barcode = CHstr(Reader("barcode"))
                End If
                Reader.Close()

                CmdString = "SELECT * FROM " + orderlines_db + " WHERE orderline_id = " + Str(orderline_id)
                Dim OCmd As New OdbcCommand(CmdString, Conn)
                Reader = OCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    Dim accessoire_id1 As Integer = CHint(Reader("accessoire1"))
                    Dim accessoire_id2 As Integer = CHint(Reader("accessoire2"))
                    Dim hoes As Integer = CHint(Reader("accessoire3"))
                    Dim accessoire_id4 As Integer = CHint(Reader("accessoire4"))

                    If accessoire(GID(accessoire, accessoire_id1)).keten_ean <> "" Then
                        keten_ean = accessoire(GID(accessoire, accessoire_id1)).keten_ean
                    End If
                    If accessoire(GID(accessoire, accessoire_id2)).keten_ean <> "" Then
                        keten_ean = accessoire(GID(accessoire, accessoire_id2)).keten_ean
                    End If
                    If accessoire(GID(accessoire, accessoire_id4)).keten_ean <> "" Then
                        keten_ean = accessoire(GID(accessoire, accessoire_id4)).keten_ean
                    End If
                    If accessoire(GID(accessoire, hoes)).sdf_code > 0 Then
                        hoeskleur = accessoire(GID(accessoire, hoes)).sdf_code
                    End If

                    If accessoire(GID(accessoire, accessoire_id1)).sdf_code > 0 Then
                        accessoire_code = accessoire(GID(accessoire, accessoire_id1)).sdf_code
                    End If
                    If accessoire_code = 0 Then
                        If accessoire(GID(accessoire, accessoire_id2)).sdf_code > 0 Then
                            accessoire_code = accessoire(GID(accessoire, accessoire_id2)).sdf_code
                        End If
                    End If

                    Dim soort_id = CHint(Reader("soort_id"))
                    If soort_id < 10000 Then
                        LIN_Product_Code = soorten(GID(soorten, soort_id)).vbn_code
                        IMD_SoortNaam = soorten(GID(soorten, soort_id)).soortnaam
                        kleur = accessoire(GID(accessoire, accessoire_id1)).sdf_code
                        PIA_SA_Code = soorten(GID(soorten, soort_id)).sdf_code
                    Else
                        soort_id = soort_id - 10000
                        LIN_Product_Code = mixen(GID(mixen, soort_id)).vbn_code
                        IMD_SoortNaam = mixen(GID(mixen, soort_id)).naam
                        kleur = mixen(GID(mixen, soort_id)).sdf_code
                    End If
                    Dim fust_id As Integer = CHint(Reader("fust_id"))
                    Dim fustlist_id = GID(fust, CHint(Reader("fust_id")))
                    PAC_Fust_Code = fust(fustlist_id).fustcode_sdf
                    MEA_Aantal_per_Fust = Trim(Str(fust(fustlist_id).aantal_per_fust))
                    QTY_Aantal = fust(fustlist_id).aantal_per_fust * AantalFusten
                    MEA_Aantal_Plant_per_kar = QTY_Aantal
                    PRI_prijs = CHdouble(Reader("prijs"))
                    GP = CHint(Reader("GP"))
                    sdfbarcode = CHint(Reader("sdfbarcode"))
                    'voorraden aftellen

                    AftellenVoorraad(AantalFusten, GP, fust_id, accessoire_id1, accessoire_id2)

                    'dvs
                    If kar_type = 10 And GP = 1 Then  'westland
                        PAC_Kar_Code = "1"
                    End If
                    If kar_type = 10 And GP > 1 Then  'westland
                        PAC_Kar_Code = "2"
                    End If

                    If kar_type = 11 And GP = 1 Then  'vba
                        PAC_Kar_Code = "1"
                    End If
                    If kar_type = 11 And GP > 1 Then  'vba
                        PAC_Kar_Code = "2"
                    End If

                    rijpheid = CHint(Reader("rijpheid"))
                    hoogte = CHint(Reader("hoogte"))
                    diameter = CHint(Reader("diameter"))
                    kopercode = CHstr(Reader("kopercode"))
                    keurcode = CHint(Reader("keurcode"))
                    transporthoogte = CHint(Reader("transporthoogte"))

                    potmaat = CHint(Reader("potmaat"))
                    If potmaat = 55 Then
                        potmaat = 505
                    ElseIf potmaat = 65 Then
                        potmaat = 506
                    ElseIf potmaat = 75 Then
                        potmaat = 507
                    ElseIf potmaat = 85 Then
                        potmaat = 508
                    ElseIf potmaat = 95 Then
                        potmaat = 509
                    ElseIf potmaat = 105 Then
                        potmaat = 510
                    ElseIf potmaat = 115 Then
                        potmaat = 511
                    ElseIf potmaat = 125 Then
                        potmaat = 512
                    Else
                        potmaat = potmaat / 10
                    End If

                    If keurcode > 0 Then
                        kwaliteit = "A2"
                    Else
                        kwaliteit = "A1"
                    End If
                    'If accessoire(GID(accessoire, accessoire_id1)).decorum = True Then  'decorum
                    ' decorum = True
                    '' End If
                    'If accessoire(GID(accessoire, accessoire_id2)).decorum = True Then  'decorum
                    ' decorum = True
                    'End If

                End If
                Reader.Close()

                CmdString = "SELECT * FROM " + orderheader_db + " WHERE header_id = " + Str(header_id)
                Dim HCmd As New OdbcCommand(CmdString, Conn)
                Reader = HCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    DTM_Delivery_Date = CType(Reader("afleverdatum"), Date)
                    NAD_buyer_ean = CHstr(Reader("koper_ean"))
                    If Mid(NAD_buyer_ean, 1, 4) = "0000" Then    'klok orders 1 dag verder zetten
                        Dim veildag As Integer = Weekday(DTM_Delivery_Date, FirstDayOfWeek.Monday)
                        Select Case veildag
                            Case 5 : DTM_Delivery_Date = DateAdd("d", 3, DTM_Delivery_Date)
                            Case 6 : DTM_Delivery_Date = DateAdd("d", 2, DTM_Delivery_Date)
                            Case Else : DTM_Delivery_Date = DateAdd("d", 1, DTM_Delivery_Date)
                        End Select
                    End If
                    Dim afleverlocatie As Integer = CHint(Reader("afleverloc"))
                    Dim afleverloc_ean As String = CHstr(Reader("afleverloc_ean"))
                    NAD_deliveringparty_ean = afleverloc(GID(afleverloc, afleverlocatie)).ean
                    '
                    If IsDecorum(NAD_buyer_ean) > 0 Then
                        decorum = True
                    End If

                    'lemkes niet standaard afleverloc maar van de florecom doorvertalen
                    If NAD_buyer_ean = "8714231140016" Then
                        NAD_deliveringparty_ean = afleverloc_ean
                    End If

                    veilingbrief = CHint(Reader("veilingbrief_id"))
                End If
                Reader.Close()

                CmdString = "SELECT * FROM klanten WHERE ean = '" + Trim(NAD_buyer_ean) + "'"
                Dim KCmd As New OdbcCommand(CmdString, Conn)
                Reader = KCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    foto = CHint(Reader("foto"))
                End If
                Reader.Close()

                FTX_Text_Literal = "OOO;"
                If decorum = True Then
                    FTX_Text_Literal = FTX_Text_Literal + "DECORUM;"
                End If
                If foto = True Then
                    FTX_Text_Literal = FTX_Text_Literal + "FOTO;"
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Fout: create edi line" + ex.Message)
            MessageBox.Show("Fout: create edi line" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        es = es + "LIN+" + Trim(Str(lin_count)) + "++" + LIN_Product_Code + ":CC:57:VBN'" + lf
        If PIA_SA_Code = "" Then
            es = es + "PIA+5+" + LIN_Product_Code + ":IN:57:92'" + lf
        Else
            es = es + "PIA+5+" + LIN_Product_Code + ":IN:57:92+" + Trim(PIA_SA_Code) + ":SA:57:91'" + lf
        End If

        es = es + "IMD+++" + LIN_Product_Code + ":161:86:" + UNOA(IMD_SoortNaam) + "'" + lf

        If GP > 1 Then
            es = es + "QTY+21:" + Trim(Str(GP)) + ":5'" + lf
        Else
            es = es + "QTY+21:" + Trim(Str(QTY_Aantal)) + ":1'" + lf   ' stuks = aantal fusten * aantal/fust 
        End If

        es = es + "DTM+137:" + Format(Now, "yyyyMMddHHmm") + ":203'" + lf
        es = es + "DTM+2:" + Format(DTM_Delivery_Date, "yyyyMMddHHmm") + ":203'" + lf
        es = es + "FTX+ACB+++-:" + FTX_Text_Literal + "'" + lf

        es = es + "CCI+++S01:161:VBN'" + lf
        es = es + "CAV+" + Format(potmaat, "000") + ":161:VBN'" + lf

        If hoogte > 0 Then
            es = es + "CCI+++S02:161:VBN'" + lf
            es = es + "CAV+" + Format(hoogte, "000") + ":161:VBN'" + lf
        End If
        If diameter > 0 Then
            es = es + "CCI+++S04:161:VBN'" + lf
            es = es + "CAV+" + Format(diameter, "000") + ":161:VBN'" + lf
        End If

        es = es + "CCI+++S05:161:VBN'" + lf
        es = es + "CAV+" + Format(rijpheid, "000") + ":161:VBN'" + lf

        es = es + "CCI+++S15:161:VBN'" + lf
        es = es + "CAV+" + Format(transporthoogte, "000") + ":161:VBN'" + lf

        If hoeskleur > 0 Then   'HOESKLEUR / SDFCODE
            es = es + "CCI+++S69:161:VBN'" + lf
            es = es + "CAV+" + Format(hoeskleur, "000") + ":161:VBN'" + lf
        End If

        If accessoire_code > 0 Then
            es = es + "CCI+++S63:161:VBN'" + lf   'S63 accessoire code
            es = es + "CAV+" + Format(accessoire_code, "000") + ":161:VBN'" + lf
        End If

        'If kleur > 0 Then
        ' es = es + "CCI+++S50:161:VBN'" + lf
        ' es = es + "CAV+" + Format(kleur, "000") + ":161:VBN'" + lf
        ' End If

        es = es + "CCI+++S98:161:VBN'" + lf
        es = es + "CAV+" + kwaliteit + ":161:VBN'" + lf

        es = es + "CCI+++S62:161:VBN'" + lf   'land van herkomst
        es = es + "CAV+NL:161:VBN'" + lf

        ' es = es + "CCI+++K07:161:VBN'" + lf   'MPS GAP
        ' es = es + "CAV+014:161:VBN'" + lf

        If keurcode > 0 Then
            es = es + "CCI+++K01:161:VBN'" + lf
            es = es + "CAV+" + Format(keurcode, "000") + ":161:VBN'" + lf
        End If
        If veilingbrief = 1 Then
            es = es + "PAT+BVH'" + lf
        End If
        If veilingbrief = 2 Then
            es = es + "PAT+VBA'" + lf
        End If
        If veilingbrief = 4 Then
            es = es + "PAT+PLE'" + lf
        End If
        If veilingbrief = 5 Then
            es = es + "PAT+VRM'" + lf
        End If
        '   If Mid(NAD_buyer_ean, 1, 4) = "0000" Then
        'es = es + "PRI+INV:0.000::AAJ:1:1'" + lf    'klokorder, prijs 0
        '  Else
        ' klokprijzen ook opsturen imv klokvoorverkoop

        Dim stringprijs As String = pformatprijs(PRI_prijs, 3)
        es = es + "PRI+INV:" + stringprijs + "::AAJ:1:1'" + lf
        'Dim testprijs As String = "PRI+INV:" + stringprijs + "::AAJ:1:1'" + lf
        ' End If
        es = es + "CUX+7:EUR'" + lf

        es = es + "PAC++2+" + PAC_Fust_Code + ":67:VBN'" + lf
        es = es + "MEA+AAE++1:" + MEA_Aantal_per_Fust + "'" + lf

        'If lin_count = 1 And brief = 1 Then
        ' es = es + "PAC++3+" + PAC_Kar_Code + ":146:EF'" + lf
        ' es = es + "MEA+AAE++1:" + MEA_Aantal_Plant_per_kar + "'" + lf
        ' es = es + "MEA+AAE++4:" + MEA_Aantal_lagen_per_kar + "'" + lf
        ' ElseIf lin_count = 2 And brief = 1 And (kar_type = 10 Or kar_type = 11) Then   'DV's .. deen meesturen met regel 2
        ' es = es + "PAC++3+" + PAC_Kar_Code + ":146:EF'" + lf
        ' es = es + "MEA+AAE++1:" + MEA_Aantal_Plant_per_kar + "'" + lf
        ' es = es + "MEA+AAE++4:" + MEA_Aantal_lagen_per_kar + "'" + lf
        ' Else
        ' es = es + "PAC++3+999:146:EF'" + lf
        ' es = es + "MEA+AAE++1:5000'" + lf
        ' End If


        'barcode = barcode van orderline + karnummer (01-99)
        Dim karcount As Integer = CalcKarnummer(kar_id, header_id)
        Dim karnummer As String = Format(karcount, "00")
        Dim barcodesdf As String = Format(sdfbarcode, "0000000000") + karnummer
        barcodesdf = barcodesdf + calc_check_digit(barcodesdf)
        Dim barcodeshort9 As String = Mid(barcodesdf, 5, 9)

        If lin_count = 1 Then
            es = es + "PAC++3+" + PAC_Kar_Code + ":146:EF'" + lf
            If GP > 1 Then
                es = es + "MEA+AAE++1:" + MEA_Aantal_Plant_per_kar + "'" + lf
                ' es = es + "MEA+AAE++4:" + MEA_Aantal_lagen_per_kar + "'" + lf
                es = es + "PCI++" + barcodeshort9 + "++2'" + lf
            Else
                es = es + "MEA+AAE++1:5000'" + lf
                es = es + "PCI++" + barcodeshort9 + "++2'" + lf
            End If
        Else
            es = es + "PAC++3+999:146:EF'" + lf
            es = es + "MEA+AAE++1:5000'" + lf
            es = es + "PCI++" + barcodeshort9 + "++2'" + lf
        End If

        'nads
        Dim buyer_ean = Trim(NAD_buyer_ean)
        If Len(buyer_ean) > 13 Then
            buyer_ean = Mid(buyer_ean, 1, 13)
        End If
        es = es + "NAD+BY+" + buyer_ean + ":160:9'" + lf
        If kopercode = "" Then
            es = es + "RFF+ON:L" + Trim(lin_count)
        Else
            es = es + "RFF+ON:" + Trim(kopercode)
        End If
        es = es + "'" + lf


        'Representative misbruiken om pakbonnummer mee te sturen


        es = es + "NAD+SR+" + onze_ean + ":160:9'" + lf
        es = es + "RFF+ON:" + Trim(barcode)
        es = es + "'" + lf


        If Mid(NAD_buyer_ean, 1, 4) = "0000" Or NAD_deliveringparty_ean = "" Then
            'geen NAD DP omdat het een klokorder of distrubitie is
        Else
            es = es + "NAD+DP+" + Trim(NAD_deliveringparty_ean) + ":160:9'" + lf
        End If

        es = es + "NAD+SE+" + Trim(onze_ean) + ":160:9'" + lf

        'voor BB veiling plantion marktplaats invullen voor correcte brief
        If veilingbrief = 4 And Mid(NAD_buyer_ean, 1, 4) <> "0000" Then  'plantion bb
            keten_ean = "8718288045188"   'plantion DM
        End If

        If keten_ean <> "" Then
            es = es + "NAD+MA+" + Trim(keten_ean) + ":160:9'" + lf
        End If
        Return es
    End Function
    Private Function CalcKarnummer(kar_id, header_id) As Integer
        Dim karnummer As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' load data from database
                Dim Reader As OdbcDataReader
                Dim CmdString As String = "SELECT kar_id FROM orderkarren WHERE header_id = " + Str(header_id) + " ORDER BY kar_id"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader
                Dim count As Integer = 1
                Do While Reader.Read

                    Dim searchkar_id As Integer = CHint(Reader("kar_id"))
                    If searchkar_id = kar_id Then
                        karnummer = count
                        Exit Do
                    End If
                    count = count + 1
                Loop
                Reader.Close()

            End Using
        Catch ex As Exception
            ErrorLog("Fout: count kar" + ex.Message)
            MessageBox.Show("Fout: countkar" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Return karnummer
    End Function

   
    Private Function create_edi_lineJenP(ByVal orderline_id As Integer, ByVal lin_count As Integer) As String

        Dim es As String = ""

        Dim LIN_Product_Code As String = "1234"                     '
        Dim IMD_SoortNaam As String = "Campanula Isophylla"         '
        Dim AantalFusten As Integer = 10                            '
        Dim QTY_Aantal As Integer = 10                              '
        Dim DTM_Delivery_Date As Date = Now                         '
        Dim FTX_Text_Literal = "OOO;DECORUM;FOTO;"                  '
        Dim potmaat As Integer = 110                                 '
        Dim hoogte As Integer = 20                                   '
        Dim diameter As Integer = 20                                 ' 
        Dim rijpheid As Integer = 1                                  '
        Dim transporthoogte As Integer = 30                          '
        Dim kwaliteit As String = "A1"                               '
        Dim keurcode As Integer = 1                                  '
        Dim kleur As Integer = 0                                     '
        Dim veilingbrief As Integer = 1   '1 = westland  2= vba  (3 = factuur is al eerder afgevangen)  4 = plantion
        Dim PRI_prijs As Double = 1.0                                '
        Dim PAC_Fust_Code As String = "206"                          '
        Dim MEA_Aantal_per_Fust As String = "8"                      '
        Dim PAC_Kar_Code As String = "1"                             '
        Dim MEA_Aantal_Plant_per_kar As String = "100"               '
        Dim MEA_Aantal_lagen_per_kar As String = "7"                 '
        Dim NAD_buyer_ean As String = "1234567890123"                '
        Dim NAD_deliveringparty_ean As String = "1234567890123"      '
        Dim CC_RFID As String = ""    ' "123456789012345678901234"           '
        Dim PIA_SA_Code As String = ""
        Dim GP As Integer = 1                                        '
        Dim kopercode As String = ""                                 '
        Dim foto As Boolean = False                                  '
        Dim decorum As Boolean = False                               '
        Dim barcode As Integer = 0
        Dim orderyear As String = Trim(Str(Year(sdf_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear
        Dim kar_type As Integer = 0
        Dim keten_ean As String = ""
        Dim hoeskleur As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' load data from database

                'AantalFusten = CHint(Reader("aantal"))       'aantal fusten
                'orderline_id = CHint(Reader("orderline_id"))
                'kar_id = CHint(Reader("kar_id"))
                'header_id = CHint(Reader("header_id"))
                Dim reader As OdbcDataReader
                Dim CmdString As String = "SELECT * FROM orderlines WHERE orderline_id = " + Str(orderline_id)
                Dim OCmd As New OdbcCommand(CmdString, Conn)
                reader = OCmd.ExecuteReader
                Dim header_id As Integer = 0
                If Reader.HasRows Then
                    reader.Read()
                    header_id = CHint(reader("OrderHeader_id"))
                    AantalFusten = CHint(reader("aantal"))
                    Dim accessoire_id1 As Integer = CHint(Reader("accessoire1"))
                    Dim accessoire_id2 As Integer = CHint(reader("accessoire2"))
                    Dim hoes As Integer = CHint(reader("accessoire3"))
                    hoeskleur = accessoire(GID(accessoire, hoes)).sdf_code

                    If accessoire(GID(accessoire, accessoire_id1)).keten_ean <> "" Then
                        keten_ean = accessoire(GID(accessoire, accessoire_id1)).keten_ean
                    End If
                    If accessoire(GID(accessoire, accessoire_id2)).keten_ean <> "" Then
                        keten_ean = accessoire(GID(accessoire, accessoire_id2)).keten_ean
                    End If

                    Dim soort_id = CHint(reader("soort_id"))
                    ' potmaat = CHint(reader("potmaat"))
                    If soort_id < 10000 Then
                        LIN_Product_Code = soorten(GID(soorten, soort_id)).vbn_code
                        IMD_SoortNaam = soorten(GID(soorten, soort_id)).soortnaam
                        'kleur = accessoire(GID(accessoire, accessoire_id1)).sdf_code
                        PIA_SA_Code = soorten(GID(soorten, soort_id)).sdf_code
                    Else
                        soort_id = soort_id - 10000
                        LIN_Product_Code = mixen(GID(mixen, soort_id)).vbn_code
                        IMD_SoortNaam = mixen(GID(mixen, soort_id)).naam
                        'kleur = mixen(GID(mixen, soort_id)).sdf_code
                    End If
                    Dim fust_id As Integer = CHint(Reader("fust_id"))
                    Dim fustlist_id = GID(fust, CHint(Reader("fust_id")))
                    PAC_Fust_Code = fust(fustlist_id).fustcode_sdf
                    MEA_Aantal_per_Fust = Trim(Str(fust(fustlist_id).aantal_per_fust))
                    QTY_Aantal = fust(fustlist_id).aantal_per_fust * AantalFusten
                    MEA_Aantal_Plant_per_kar = QTY_Aantal
                    PRI_prijs = CHdouble(Reader("prijs"))
                    GP = CHint(Reader("GP"))

                    'voorraden aftellen

                    AftellenVoorraad(AantalFusten, GP, fust_id, accessoire_id1, accessoire_id2)

                    rijpheid = CHint(reader("rijpheid"))
                    hoogte = CHint(Reader("hoogte"))
                    diameter = CHint(Reader("diameter"))
                    kopercode = CHstr(Reader("kopercode"))
                    keurcode = CHint(Reader("keurcode"))
                    transporthoogte = CHint(Reader("transporthoogte"))
                    barcode = CHint(reader("sdfbarcode"))
                    potmaat = CHint(Reader("potmaat"))
                    If potmaat = 55 Then
                        potmaat = 505
                    ElseIf potmaat = 65 Then
                        potmaat = 506
                    ElseIf potmaat = 75 Then
                        potmaat = 507
                    ElseIf potmaat = 85 Then
                        potmaat = 508
                    ElseIf potmaat = 95 Then
                        potmaat = 509
                    ElseIf potmaat = 105 Then
                        potmaat = 510
                    ElseIf potmaat = 115 Then
                        potmaat = 511
                    ElseIf potmaat = 125 Then
                        potmaat = 512
                    Else
                        potmaat = potmaat / 10
                    End If

                    If keurcode > 0 Then
                        kwaliteit = "A2"
                    Else
                        kwaliteit = "A1"
                    End If

                End If
                Reader.Close()

                CmdString = "SELECT * FROM orderheaders WHERE header_id = " + Str(header_id)
                Dim HCmd As New OdbcCommand(CmdString, Conn)
                Reader = HCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    DTM_Delivery_Date = CType(Reader("afleverdatum"), Date)
                    NAD_buyer_ean = CHstr(Reader("koper_ean"))
                    If Mid(NAD_buyer_ean, 1, 4) = "0000" Then    'klok orders 1 dag verder zetten
                        Dim veildag As Integer = Weekday(DTM_Delivery_Date, FirstDayOfWeek.Monday)
                        Select Case veildag
                            Case 5 : DTM_Delivery_Date = DateAdd("d", 3, DTM_Delivery_Date)
                            Case 6 : DTM_Delivery_Date = DateAdd("d", 2, DTM_Delivery_Date)
                            Case Else : DTM_Delivery_Date = DateAdd("d", 1, DTM_Delivery_Date)
                        End Select
                    End If
                    Dim afleverlocatie As Integer = CHint(Reader("afleverloc"))
                    Dim afleverloc_ean As String = CHstr(Reader("afleverloc_ean"))
                    NAD_deliveringparty_ean = afleverloc(GID(afleverloc, afleverlocatie)).ean
                    kar_type = CHint(reader("kar_id"))       'kartype
                    PAC_Kar_Code = "999"
                    If kar_type = 1 Or kar_type = 2 Then  'denen cc
                        PAC_Kar_Code = "2"
                    End If
                    If kar_type = 3 Or kar_type = 9 Then  'veilingkarren
                        PAC_Kar_Code = "1"
                    End If
                    MEA_Aantal_lagen_per_kar = 20 ' Trim(Str(CHint(Reader("aantal_lagen"))))
                    If (kar_type = 1 Or kar_type = 2) And MEA_Aantal_lagen_per_kar = "1" Then
                        MEA_Aantal_lagen_per_kar = "2"
                    End If
                    ' CC_RFID = CHstr(Reader("CC_RFID"))
                    'lemkes niet standaard afleverloc maar van de florecom doorvertalen
                    If NAD_buyer_ean = "8714231140016" Then
                        NAD_deliveringparty_ean = afleverloc_ean
                    End If
                    veilingbrief = CHint(reader("veilingbrief_id"))
                End If
                Reader.Close()

                If IsDecorum(NAD_buyer_ean) > 0 Then
                    decorum = True
                End If

                CmdString = "SELECT * FROM klanten WHERE ean = '" + Trim(NAD_buyer_ean) + "'"
                Dim KCmd As New OdbcCommand(CmdString, Conn)
                Reader = KCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    foto = CHint(Reader("foto"))
                End If
                Reader.Close()

                FTX_Text_Literal = "OOO;"
                If decorum = True Then
                    FTX_Text_Literal = FTX_Text_Literal + "DECORUM;"
                End If
                If foto = True Then
                    FTX_Text_Literal = FTX_Text_Literal + "FOTO;"
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Fout: create edi line" + ex.Message)
            MessageBox.Show("Fout: create edi line" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        es = es + "LIN+" + Trim(Str(lin_count)) + "++" + LIN_Product_Code + ":CC:57:VBN'" + lf
        If PIA_SA_Code = "" Then
            es = es + "PIA+5+" + LIN_Product_Code + ":IN:57:92'" + lf
        Else
            es = es + "PIA+5+" + LIN_Product_Code + ":IN:57:92+" + Trim(PIA_SA_Code) + ":SA:57:91'" + lf
        End If

        es = es + "IMD+++" + LIN_Product_Code + ":161:86:" + UNOA(IMD_SoortNaam) + "'" + lf

        If GP > 1 Then
            es = es + "QTY+21:" + Trim(Str(GP)) + ":5'" + lf
        Else
            es = es + "QTY+21:" + Trim(Str(QTY_Aantal)) + ":1'" + lf   ' stuks = aantal fusten * aantal/fust 
        End If

        es = es + "DTM+137:" + Format(Now, "yyyyMMddHHmm") + ":203'" + lf
        es = es + "DTM+2:" + Format(DTM_Delivery_Date, "yyyyMMddHHmm") + ":203'" + lf
        es = es + "FTX+ACB+++-:" + FTX_Text_Literal + "'" + lf

        es = es + "CCI+++S01:161:VBN'" + lf
        es = es + "CAV+" + Format(potmaat, "000") + ":161:VBN'" + lf

        If hoogte > 0 Then
            es = es + "CCI+++S02:161:VBN'" + lf
            es = es + "CAV+" + Format(hoogte, "000") + ":161:VBN'" + lf
        End If
        If diameter > 0 Then
            es = es + "CCI+++S04:161:VBN'" + lf
            es = es + "CAV+" + Format(diameter, "000") + ":161:VBN'" + lf
        End If

        es = es + "CCI+++S05:161:VBN'" + lf
        es = es + "CAV+" + Format(rijpheid, "000") + ":161:VBN'" + lf

        es = es + "CCI+++S15:161:VBN'" + lf
        es = es + "CAV+" + Format(transporthoogte, "000") + ":161:VBN'" + lf

        'If kleur > 0 Then
        ' es = es + "CCI+++S50:161:VBN'" + lf
        ' es = es + "CAV+" + Format(kleur, "000") + ":161:VBN'" + lf
        ' End If

        If hoeskleur > 0 Then   'HOESKLEUR / SDFCODE
            es = es + "CCI+++S69:161:VBN'" + lf
            es = es + "CAV+" + Format(hoeskleur, "000") + ":161:VBN'" + lf
        End If


        es = es + "CCI+++S98:161:VBN'" + lf
        es = es + "CAV+" + kwaliteit + ":161:VBN'" + lf

        es = es + "CCI+++S62:161:VBN'" + lf   'land van herkomst
        es = es + "CAV+NL:161:VBN'" + lf

        ' es = es + "CCI+++K07:161:VBN'" + lf   'MPS GAP
        ' es = es + "CAV+014:161:VBN'" + lf

        If keurcode > 0 Then
            es = es + "CCI+++K01:161:VBN'" + lf
            es = es + "CAV+" + Format(keurcode, "000") + ":161:VBN'" + lf
        End If
        If veilingbrief = 1 Then
            es = es + "PAT+BVH'" + lf
        End If
        If veilingbrief = 2 Then
            es = es + "PAT+VBA'" + lf
        End If
        If veilingbrief = 4 Then
            es = es + "PAT+PLE'" + lf
        End If
        If veilingbrief = 5 Then
            es = es + "PAT+VRM'" + lf
        End If
        '   If Mid(NAD_buyer_ean, 1, 4) = "0000" Then
        'es = es + "PRI+INV:0.000::AAJ:1:1'" + lf    'klokorder, prijs 0
        '  Else
        ' klokprijzen ook opsturen imv klokvoorverkoop

        Dim stringprijs As String = pformatprijs(PRI_prijs, 3)
        es = es + "PRI+INV:" + stringprijs + "::AAJ:1:1'" + lf
        'Dim testprijs As String = "PRI+INV:" + stringprijs + "::AAJ:1:1'" + lf
        ' End If
        es = es + "CUX+7:EUR'" + lf

        es = es + "PAC++2+" + PAC_Fust_Code + ":67:VBN'" + lf
        es = es + "MEA+AAE++1:" + MEA_Aantal_per_Fust + "'" + lf

        Dim barcodesdf As String = Format(barcode, "000000000000")
        barcodesdf = barcodesdf + calc_check_digit(barcodesdf)
        Dim barcodeshort9 As String = Mid(barcodesdf, 5, 9)

        If lin_count = 1 Then
            es = es + "PAC++3+" + PAC_Kar_Code + ":146:EF'" + lf
            'es = es + "MEA+AAE++1:" + MEA_Aantal_Plant_per_kar + "'" + lf
            'es = es + "MEA+AAE++4:" + MEA_Aantal_lagen_per_kar + "'" + lf
            es = es + "MEA+AAE++1:5000'" + lf
            es = es + "PCI++" + barcodeshort9 + "++2'"
        Else
            es = es + "PAC++3+999:146:EF'" + lf
            es = es + "MEA+AAE++1:5000'" + lf
            es = es + "PCI++" + barcodeshort9 + "++2'" + lf
        End If

        'nads
        Dim buyer_ean = Trim(NAD_buyer_ean)
        If Len(buyer_ean) > 13 Then
            buyer_ean = Mid(buyer_ean, 1, 13)
        End If
        es = es + "NAD+BY+" + buyer_ean + ":160:9'" + lf
        If kopercode = "" Then
            es = es + "RFF+ON:L" + Trim(lin_count)
        Else
            es = es + "RFF+ON:" + Trim(kopercode)
        End If
        es = es + "'" + lf

        If Mid(NAD_buyer_ean, 1, 4) = "0000" Or NAD_deliveringparty_ean = "" Then
            'geen NAD DP omdat het een klokorder of distrubitie is
        Else
            es = es + "NAD+DP+" + Trim(NAD_deliveringparty_ean) + ":160:9'" + lf
        End If

        es = es + "NAD+SE+" + Trim(onze_ean) + ":160:9'" + lf
        If keten_ean <> "" Then
            es = es + "NAD+MA+" + Trim(keten_ean) + ":160:9'" + lf
        End If

        Return es
    End Function

    Private Function calc_check_digit(ByVal data As String) As String


        Dim Factor As Integer = 3
        Dim WeightedTotal As Integer = 0

        Dim data12 = Mid(data, 1, 12)

        For i = Len(data12) To 1 Step -1
            Dim CurrentCharNum As String = Mid(data12, i, 1)
            WeightedTotal = CInt(WeightedTotal + (Val(CurrentCharNum) * Factor))
            Factor = 4 - Factor
        Next i
        Dim wt As Integer = (WeightedTotal Mod 10)
        Dim checkdigit As Integer = 0
        If wt <> 0 Then
            checkdigit = (10 - wt)
        Else
            checkdigit = 0
        End If


        Return Trim(Str(checkdigit))
    End Function

    Private Sub Orders_SdfVersturenMain(ByVal SpecifiekeKar_header As Integer, ByVal SpecifiekeKar_id As Integer)

        Dim sdf_idlist(101) As Integer
        For clearloop = 0 To 100
            sdf_idlist(clearloop) = -1
        Next
        Dim id_counter As Integer = 1

        If SpecifiekeKar_header = -1 Then         'geen specifieke kar, dan lijst met id's uit agenda halen
            'global var  sdf_idlist

            'Dim id_counter As Integer = 1
            Dim Nodes As TreeNodeCollection = TreeView1.Nodes
            Dim Node As TreeNode
            For Each Node In Nodes
                If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                    sdf_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                    id_counter = id_counter + 1
                End If

                If Node.Nodes.Count > 0 Then
                    Dim node2 As TreeNode
                    For Each node2 In Node.Nodes
                        If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                            sdf_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                            id_counter = id_counter + 1
                            'Exit For
                        End If
                    Next node2
                End If
            Next Node

            'For i = 0 To TreeView1.Nodes.Count - 1
            'If TreeView1.Nodes(i).Checked = True And Mid(TreeView1.Nodes(i).Tag, 1, 3) = "ID:" Then
            'sdf_idlist(id_counter) = Val(Mid(TreeView1.Nodes(i).Tag, 4))
            'id_counter = id_counter + 1
            ' If id_counter > 100 Then Exit For
            'End If
            ' Next i
            If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
                If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                    sdf_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                    id_counter = id_counter + 1
                End If
            End If
            sdf_date = Order_MonthCalendar.SelectionStart
            If id_counter = 1 Then Exit Sub
        Else
            sdf_idlist(1) = SpecifiekeKar_header
            id_counter = 2
            sdf_date = karindeling_date
        End If

        Dim sdf_ordercount As Integer = id_counter - 1
        Dim orderyear As String = Trim(Str(Year(sdf_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear

        'DebugText.Text = ""

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For orderloop = 1 To sdf_ordercount
                    Dim header_id As Integer = sdf_idlist(orderloop)



                    'koper ean ophalen + brief-type (ivm factuur generatie ipv sdf versturen) 
                    Dim koper_ean As String = ""
                    Dim veilingbrief_id As Integer = 1
                    Dim aanvulling_headerid As Integer = 0

                    Dim CmdString As String = "select * from " + orderheader_db + " WHERE  Header_id = " + Str(header_id) + " "
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Dim Reader As OdbcDataReader
                    Reader = Cmd.ExecuteReader
                    If Reader.HasRows Then
                        Reader.Read()
                        koper_ean = CHstr(Reader("koper_ean"))
                        veilingbrief_id = CHint(Reader("veilingbrief_id"))
                        aanvulling_headerid = CHint(Reader("aanvulling"))
                    End If

                    'verzamelkar check
                    'staat deze ean in kopersgroep 8 (verzamelkar)
                    Dim koper_in_groep As Boolean = False
                    Dim CmdHeaderString3 As String = "select * from kopersgroepen2_eans WHERE id=8 and ean = '" + koper_ean + "'"
                    Dim Cmd3 As New OdbcCommand(CmdHeaderString3, Conn)
                    Dim Reader3 As OdbcDataReader
                    Reader3 = Cmd3.ExecuteReader()
                    If Reader3.HasRows Then
                        koper_in_groep = True
                    End If
                    Reader3.Close()
                    Dim nietprinten As Boolean = False
                    If koper_in_groep = True Then
                        'is het minder als 10 bakjes?

                        Dim CmdHeaderString As String = "select SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.header_id = " + Str(header_id) + " GROUP BY ol.koper_naam"
                        Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                        Dim Reader5 As OdbcDataReader
                        Reader5 = Cmdr.ExecuteReader()
                        Do While Reader5.Read()
                            Dim aantal As Integer = CHint(Reader5("taantal"))
                            Dim koper_naam As String = CHstr(Reader5("koper_naam"))
                            If aantal < 9 And aanvulling_headerid = 0 Then
                                Dim result As Integer = MessageBox.Show("Koper '" + koper_naam + "' heeft minder als 9 bakken en staat in de verzamelkar lijst. Wilt u deze kar toch versturen naar SDF?", "", MessageBoxButtons.YesNo)
                                If result = DialogResult.No Then
                                    nietprinten = True
                                ElseIf result = DialogResult.Yes Then
                                    nietprinten = False
                                End If
                            End If
                        Loop
                    End If
                    '


                    If veilingbrief_id = 3 Then   'factuur?
                        print_factuur(header_id)
                    ElseIf nietprinten = True Then
                        'skip.. niet printen maar handmatig verzamelkar van maken
                    Else
                        ' load kar-info & lines
                        Dim karcounter As Integer = 1


                        Dim Maxregels As Integer = 4
                        If veilingbrief_id = 1 Then  'westland brief 
                            ' 4 regels
                            Maxregels = 5
                        End If
                        If veilingbrief_id = 2 Then  'vba brief 
                            ' 5 regels
                            Maxregels = 4
                        End If
                        If veilingbrief_id = 4 Then   'plantion brief
                            Maxregels = 6
                        End If
                        If veilingbrief_id = 5 Then  ' rhein maas brief 
                            ' 4 regels
                            Maxregels = 5
                        End If
                        Dim CmdKarString As String = ""
                        If SpecifiekeKar_id = -1 Then
                            CmdKarString = "select * from " + orderkarren_db + " WHERE  Header_id = " + Str(header_id) + " "
                        Else
                            CmdKarString = "select * from " + orderkarren_db + " WHERE  Kar_id = " + Str(SpecifiekeKar_id) + " "
                        End If
                        Dim CmdKar As New OdbcCommand(CmdKarString, Conn)
                        Dim KarrenReader As OdbcDataReader
                        KarrenReader = CmdKar.ExecuteReader
                        Dim kar_id_list(100) As Integer
                        Dim karrencount As Integer = 1
                        Dim kartype As Integer = 0
                        Do While KarrenReader.Read()           ' loop :  karren in de order 
                            Dim sdf_flag As Boolean = CHbool(KarrenReader("sdf_flag"))
                            If sdf_flag = False Then
                                kar_id_list(karrencount) = CHint(KarrenReader("kar_id"))
                                kartype = KarrenReader("kar_type")
                                karrencount = karrencount + 1
                            End If
                        Loop

                        'special for dv's 
                        If kartype = 10 Or kartype = 11 And karrencount = 3 Then
                            karrencount = 2  'DV's opsturen als 1 kar (ook al zijn het er 2)
                        End If


                        If karrencount > 1 Then

                            For karloop = 1 To karrencount - 1          ' loop : aantal karren in de order 

                                Dim sdf_karid = kar_id_list(karloop)

                                'read lines

                                Dim CmdLinecountString As String = ""
                                If Mid(koper_ean, 1, 4) = "0000" Then  'klokorders omgekeert sorteren
                                    If kartype = 10 Or kartype = 11 Then  'DV's
                                        CmdLinecountString = "SELECT id FROM " + orderkarlines_db + " WHERE  kar_id = " + Str(kar_id_list(karloop)) + " OR kar_id = " + Str(kar_id_list(karloop + 1)) + " ORDER BY sorteren ASC"
                                    Else
                                        CmdLinecountString = "SELECT id FROM " + orderkarlines_db + " WHERE  kar_id = " + Str(sdf_karid) + " ORDER BY sorteren DESC"  'normal klok
                                    End If
                                Else
                                    CmdLinecountString = "SELECT id FROM " + orderkarlines_db + " WHERE  kar_id = " + Str(sdf_karid) + " ORDER BY sorteren ASC"  'BB
                                End If
                                Dim line_id_List(Max_Kar_Lines) As Integer
                                Dim CmdLine As New OdbcCommand(CmdLinecountString, Conn)
                                Dim LineReader As OdbcDataReader = CmdLine.ExecuteReader()
                                Dim MaxLineCount As Integer = 1
                                Do While LineReader.Read()
                                    line_id_List(MaxLineCount) = CHint(LineReader("id"))
                                    MaxLineCount = MaxLineCount + 1
                                Loop
                                MaxLineCount = MaxLineCount - 1
                                LineReader.Close()

                                ' een kar kan meerdere brieven hebben, dus onderverdelen in 4/5 regels
                                Dim RegelCounter As Integer = 1
                                Dim Lin_count As Integer = 1
                                Dim brief As Integer = 1

                                Dim edistring As String = ""
                                Do While Lin_count <= MaxLineCount

                                    ' Get and Update UNB counter 
                                    Dim UnbCounter As Integer = 0
                                    Dim UnBCmdString As String = "select UNB_Message_Counter from instellingen"
                                    Dim UnBCmd As New OdbcCommand(UnBCmdString, Conn)
                                    Dim UnBReader As OdbcDataReader
                                    UnBReader = UnBCmd.ExecuteReader
                                    If UnBReader.HasRows Then
                                        UnBReader.Read()
                                        UnbCounter = CHint(UnBReader("UNB_Message_Counter"))
                                    End If
                                    UnbCounter = UnbCounter + 1
                                    UnBReader.Close()
                                    UnBCmd.CommandText = "UPDATE instellingen SET UNB_Message_Counter=?"
                                    UnBCmd.Parameters.Clear()
                                    UnBCmd.Parameters.AddWithValue("", UnbCounter)
                                    UnBCmd.ExecuteNonQuery()

                                    'create new edi header 
                                    edistring = ""
                                    Dim edi_string = create_edi_header(UnbCounter, koper_ean, sdf_karid)          ' header

                                    'create edi lines 
                                    Do While Lin_count <= MaxLineCount And RegelCounter <= Maxregels
                                        Dim edi_line As String = create_edi_line(line_id_List(Lin_count), RegelCounter, brief)  'lines
                                        edi_string = edi_string + edi_line
                                        RegelCounter = RegelCounter + 1
                                        Lin_count = Lin_count + 1
                                    Loop
                                    'create edi footer 
                                    Dim edi_footer As String = create_edi_footer(UnbCounter, header_id, edi_string, sdf_karid) 'footer 
                                    edi_string = edi_string + edi_footer

                                    'send edi
                                    Mail_Edi(header_id, edi_string)

                                    If RegelCounter > Maxregels Then
                                        RegelCounter = RegelCounter - Maxregels
                                        brief = brief + 1
                                    End If

                                    C1TabFlorecom.Enabled = True
                                    'C1Tab.SelectedTab = C1Tab.TabPages(2)
                                    '  DebugText1.Text = DebugText1.Text + vbCrLf + vbCrLf + edi_string

                                Loop

                                'update sdf flag 

                                CmdString = "SELECT * FROM " + orderkarren_db + " WHERE kar_id = " + Str(sdf_karid)
                                Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                Cmd2.CommandText = "UPDATE " + orderkarren_db + " SET sdf_flag=TRUE  WHERE kar_id = " + Str(sdf_karid)
                                Cmd2.ExecuteNonQuery()


                            Next


                        End If


                    End If
                    If nietprinten = False Then
                        SetNewStatusFlag(sdf_date, header_id, False)
                    End If
                Next orderloop
                'Update_Boek()
                Set_Boek_reload()

            End Using
        Catch ex As Exception
            ErrorLog("Fout: sdf orderlist" + ex.Message)
            MessageBox.Show("Fout: sdf orderlist" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        'MsgBox("Orders verstuurd", vbOKOnly, "SDF")

    End Sub
    Private Sub print_factuur(ByVal header_id As Integer)
        MsgBox("Factuur printen is nog niet af")
    End Sub
    Private Function create_edi_header(ByVal UNBCounter As Double, ByVal koper_ean As String, ByVal Kar_id As Integer) As String

        ' edi header maken 
        Dim es As String = ""

        es = es + "UNB+UNOA:2+" + Trim(onze_ean) + ":14+"
        es = es + Trim(koper_ean) + ":14+"
        es = es + Format(Now, "yyMMdd:HHmm") + "+"
        'es = es + "AVR" + Format(UNBCounter, "00000000000") + "++"
        'es = es + "220'" + lf

        'es = es + "UNH+" + "AVR" + Format(UNBCounter, "00000000000")
        'es = es + "+ORDERS:D:02A:UN:DF0220'" + lf


        es = es + Format(UNBCounter, "00000000000") + "++"
        es = es + "220'" + lf

        es = es + "UNH+" + Format(UNBCounter, "00000000000")
        es = es + "+ORDERS:D:02A:UN:DF0221'" + lf

        es = es + "BGM+220:42:6+"
        es = es + Trim(Str(UNBCounter)) + ":1'" + lf
        es = es + "DTM+137:" + Format(Now, "yyyyMMddHHmm") + ":203'" + lf

        Return es
    End Function
    Private Function create_edi_line(ByVal karline_id As Integer, ByVal lin_count As Integer, ByVal brief As Integer) As String

        Dim es As String = ""

        Dim LIN_Product_Code As String = "1234"                     '
        Dim IMD_SoortNaam As String = "Campanula Isophylla"         '
        Dim AantalFusten As Integer = 10                            '
        Dim QTY_Aantal As Integer = 10                              '
        Dim DTM_Delivery_Date As Date = Now                         '
        Dim FTX_Text_Literal = "OOO;DECORUM;FOTO;"                  '
        Dim potmaat As Integer = 110                                 '
        Dim hoogte As Integer = 20                                   '
        Dim diameter As Integer = 20                                 ' 
        Dim rijpheid As Integer = 1                                  '
        Dim transporthoogte As Integer = 30                          '
        Dim kwaliteit As String = "A1"                               '
        Dim keurcode As Integer = 1                                  '
        Dim kleur As Integer = 0                                     '
        Dim veilingbrief As Integer = 1   '1 = westland  2= vba  (3 = factuur is al eerder afgevangen)  4 = plantion
        Dim PRI_prijs As Double = 1.0                                '
        Dim PAC_Fust_Code As String = "206"                          '
        Dim MEA_Aantal_per_Fust As String = "8"                      '
        Dim PAC_Kar_Code As String = "1"                             '
        Dim MEA_Aantal_Plant_per_kar As String = "100"               '
        Dim MEA_Aantal_lagen_per_kar As String = "7"                 '
        Dim NAD_buyer_ean As String = "1234567890123"                '
        Dim NAD_deliveringparty_ean As String = "1234567890123"      '
        Dim CC_RFID As String = ""    ' "123456789012345678901234"           '
        Dim PIA_SA_Code As String = ""
        Dim GP As Integer = 1                                        '
        Dim kopercode As String = ""                                 '
        Dim foto As Boolean = False                                  '
        Dim decorum As Boolean = False                               '

        Dim orderyear As String = Trim(Str(Year(sdf_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear
        Dim kar_type As Integer = 0
        Dim keten_ean As String = ""
        Dim barcode As String = "1234"
        Dim soort_id As Integer = 1
        Dim accessoire_code As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' load data from database
                Dim Reader As OdbcDataReader
                Dim CmdString As String = "SELECT * FROM " + orderkarlines_db + " WHERE id = " + Str(karline_id)
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader
                Dim orderline_id As Integer = -1
                Dim kar_id As Integer = -1
                Dim header_id As Integer = -1
                If Reader.HasRows Then
                    Reader.Read()
                    AantalFusten = CHint(Reader("aantal"))       'aantal fusten
                    orderline_id = CHint(Reader("orderline_id"))
                    kar_id = CHint(Reader("kar_id"))
                    header_id = CHint(Reader("header_id"))
                End If
                Reader.Close()
                CmdString = "SELECT * FROM " + orderkarren_db + " WHERE kar_id = " + Str(kar_id)
                Dim KarCmd As New OdbcCommand(CmdString, Conn)
                Reader = KarCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    kar_type = CHint(Reader("kar_type"))       'kartype
                    PAC_Kar_Code = "999"
                    If kar_type = 1 Or kar_type = 2 Then  'denen cc
                        PAC_Kar_Code = "2"
                    End If
                    If kar_type = 3 Or kar_type = 9 Then  'veilingkarren
                        PAC_Kar_Code = "1"
                    End If
                    MEA_Aantal_lagen_per_kar = Trim(Str(CHint(Reader("aantal_lagen"))))
                    If (kar_type = 1 Or kar_type = 2) And MEA_Aantal_lagen_per_kar = "1" Then
                        MEA_Aantal_lagen_per_kar = "2"
                    End If
                    CC_RFID = CHstr(Reader("CC_RFID"))
                    barcode = CHstr(Reader("barcode"))
                End If
                Reader.Close()

                CmdString = "SELECT * FROM " + orderlines_db + " WHERE orderline_id = " + Str(orderline_id)
                Dim OCmd As New OdbcCommand(CmdString, Conn)
                Reader = OCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    Dim accessoire_id1 As Integer = CHint(Reader("accessoire1"))
                    Dim accessoire_id2 As Integer = CHint(Reader("accessoire2"))

                    If accessoire(GID(accessoire, accessoire_id1)).keten_ean <> "" Then
                        keten_ean = accessoire(GID(accessoire, accessoire_id1)).keten_ean
                    End If
                    If accessoire(GID(accessoire, accessoire_id2)).keten_ean <> "" Then
                        keten_ean = accessoire(GID(accessoire, accessoire_id2)).keten_ean
                    End If

                    If accessoire(GID(accessoire, accessoire_id1)).sdf_code > 0 Then
                        accessoire_code = accessoire(GID(accessoire, accessoire_id1)).sdf_code
                    End If
                    If accessoire_code = 0 Then
                        If accessoire(GID(accessoire, accessoire_id2)).sdf_code > 0 Then
                            accessoire_code = accessoire(GID(accessoire, accessoire_id2)).sdf_code
                        End If
                    End If

                    soort_id = CHint(Reader("soort_id"))
                    If soort_id < 10000 Then
                        LIN_Product_Code = soorten(GID(soorten, soort_id)).vbn_code
                        IMD_SoortNaam = soorten(GID(soorten, soort_id)).soortnaam
                        kleur = accessoire(GID(accessoire, accessoire_id1)).sdf_code
                        PIA_SA_Code = soorten(GID(soorten, soort_id)).sdf_code
                    Else
                        Dim mix_id As Integer = soort_id - 10000
                        LIN_Product_Code = mixen(GID(mixen, mix_id)).vbn_code
                        IMD_SoortNaam = mixen(GID(mixen, mix_id)).naam
                        kleur = mixen(GID(mixen, mix_id)).sdf_code
                        PIA_SA_Code = Trim(mixen(GID(mixen, mix_id)).sdf_artcode)
                    End If
                    Dim fust_id As Integer = CHint(Reader("fust_id"))
                    Dim fustlist_id = GID(fust, CHint(Reader("fust_id")))
                    PAC_Fust_Code = fust(fustlist_id).fustcode_sdf
                    MEA_Aantal_per_Fust = Trim(Str(fust(fustlist_id).aantal_per_fust))
                    QTY_Aantal = fust(fustlist_id).aantal_per_fust * AantalFusten
                    MEA_Aantal_Plant_per_kar = QTY_Aantal
                    PRI_prijs = CHdouble(Reader("prijs"))
                    GP = CHint(Reader("GP"))

                    'voorraden aftellen

                    AftellenVoorraad(AantalFusten, GP, fust_id, accessoire_id1, accessoire_id2)

                    'dvs
                    If kar_type = 10 And GP = 1 Then  'westland
                        PAC_Kar_Code = "1"
                    End If
                    If kar_type = 10 And GP > 1 Then  'westland
                        PAC_Kar_Code = "2"
                    End If

                    If kar_type = 11 And GP = 1 Then  'vba
                        PAC_Kar_Code = "1"
                    End If
                    If kar_type = 11 And GP > 1 Then  'vba
                        PAC_Kar_Code = "2"
                    End If

                    rijpheid = CHint(Reader("rijpheid"))
                    hoogte = CHint(Reader("hoogte"))
                    diameter = CHint(Reader("diameter"))
                    kopercode = CHstr(Reader("kopercode"))
                    keurcode = CHint(Reader("keurcode"))
                    transporthoogte = CHint(Reader("transporthoogte"))

                    potmaat = CHint(Reader("potmaat"))
                    If potmaat = 55 Then
                        potmaat = 505
                    ElseIf potmaat = 65 Then
                        potmaat = 506
                    ElseIf potmaat = 75 Then
                        potmaat = 507
                    ElseIf potmaat = 85 Then
                        potmaat = 508
                    ElseIf potmaat = 95 Then
                        potmaat = 509
                    ElseIf potmaat = 105 Then
                        potmaat = 510
                    ElseIf potmaat = 115 Then
                        potmaat = 511
                    ElseIf potmaat = 125 Then
                        potmaat = 512
                    Else
                        potmaat = potmaat / 10
                    End If

                    If keurcode > 0 Then
                        kwaliteit = "A2"
                    Else
                        kwaliteit = "A1"
                    End If
                    'If accessoire(GID(accessoire, accessoire_id1)).decorum = True Then  'decorum
                    ' decorum = True
                    '' End If
                    'If accessoire(GID(accessoire, accessoire_id2)).decorum = True Then  'decorum
                    ' decorum = True
                    'End If

                End If
                Reader.Close()

                CmdString = "SELECT * FROM " + orderheader_db + " WHERE header_id = " + Str(header_id)
                Dim HCmd As New OdbcCommand(CmdString, Conn)
                Reader = HCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    DTM_Delivery_Date = CType(Reader("afleverdatum"), Date)
                    NAD_buyer_ean = CHstr(Reader("koper_ean"))
                    If Mid(NAD_buyer_ean, 1, 4) = "0000" Then    'klok orders 1 dag verder zetten
                        Dim veildag As Integer = Weekday(DTM_Delivery_Date, FirstDayOfWeek.Monday)
                        Select Case veildag
                            Case 5 : DTM_Delivery_Date = DateAdd("d", 3, DTM_Delivery_Date)
                            Case 6 : DTM_Delivery_Date = DateAdd("d", 2, DTM_Delivery_Date)
                            Case Else : DTM_Delivery_Date = DateAdd("d", 1, DTM_Delivery_Date)
                        End Select
                    End If
                    Dim afleverlocatie As Integer = CHint(Reader("afleverloc"))
                    Dim afleverloc_ean As String = CHstr(Reader("afleverloc_ean"))
                    NAD_deliveringparty_ean = afleverloc(GID(afleverloc, afleverlocatie)).ean
                    '
                    If IsDecorum(NAD_buyer_ean) > 0 Then
                        decorum = True
                    End If

                    'lemkes niet standaard afleverloc maar van de florecom doorvertalen
                    If NAD_buyer_ean = "8714231140016" Then
                        NAD_deliveringparty_ean = afleverloc_ean
                    End If

                    veilingbrief = CHint(Reader("veilingbrief_id"))
                End If
                Reader.Close()

                CmdString = "SELECT * FROM klanten WHERE ean = '" + Trim(NAD_buyer_ean) + "'"
                Dim KCmd As New OdbcCommand(CmdString, Conn)
                Reader = KCmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    foto = CHint(Reader("foto"))
                End If
                Reader.Close()

                FTX_Text_Literal = "OOO;"
                If decorum = True Then
                    FTX_Text_Literal = FTX_Text_Literal + "DECORUM;"
                End If
                If foto = True Then
                    FTX_Text_Literal = FTX_Text_Literal + "FOTO;"
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Fout: create edi line" + ex.Message)
            MessageBox.Show("Fout: create edi line" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        es = es + "LIN+" + Trim(Str(lin_count)) + "++" + LIN_Product_Code + ":CC:57:VBN'" + lf
        If PIA_SA_Code = "" Then
            es = es + "PIA+5+" + LIN_Product_Code + ":IN:57:92'" + lf
        Else
            es = es + "PIA+5+" + LIN_Product_Code + ":IN:57:92+" + Trim(PIA_SA_Code) + ":SA:57:91'" + lf
        End If

        es = es + "IMD+++" + LIN_Product_Code + ":161:86:" + UNOA(IMD_SoortNaam) + "'" + lf

        If GP > 1 Then
            es = es + "QTY+21:" + Trim(Str(GP)) + ":5'" + lf
        Else
            es = es + "QTY+21:" + Trim(Str(QTY_Aantal)) + ":1'" + lf   ' stuks = aantal fusten * aantal/fust 
        End If

        es = es + "DTM+137:" + Format(Now, "yyyyMMddHHmm") + ":203'" + lf
        es = es + "DTM+2:" + Format(DTM_Delivery_Date, "yyyyMMddHHmm") + ":203'" + lf
        es = es + "FTX+ACB+++-:" + FTX_Text_Literal + "'" + lf

        es = es + "CCI+++S01:161:VBN'" + lf
        es = es + "CAV+" + Format(potmaat, "000") + ":161:VBN'" + lf

        If hoogte > 0 Then
            es = es + "CCI+++S02:161:VBN'" + lf
            es = es + "CAV+" + Format(hoogte, "000") + ":161:VBN'" + lf
        End If
        If diameter > 0 Then
            es = es + "CCI+++S04:161:VBN'" + lf
            es = es + "CAV+" + Format(diameter, "000") + ":161:VBN'" + lf
        End If

        es = es + "CCI+++S05:161:VBN'" + lf
        es = es + "CAV+" + Format(rijpheid, "000") + ":161:VBN'" + lf

        es = es + "CCI+++S15:161:VBN'" + lf
        es = es + "CAV+" + Format(transporthoogte, "000") + ":161:VBN'" + lf


        If decorum = True Then
            es = es + "CCI+++T19:161:VBN'" + lf  'Decorum
            es = es + "CAV+001:161:VBN'" + lf
        End If

        'If kleur > 0 Then
        ' es = es + "CCI+++S50:161:VBN'" + lf
        ' es = es + "CAV+" + Format(kleur, "000") + ":161:VBN'" + lf
        ' End If

        '  If 1 = 0 Then
        If soort_id < 10000 Then
            If kleur > 0 Then
                es = es + "CCI+++S50:161:VBN'" + lf
                es = es + "CAV+" + Format(kleur, "000") + ":161:VBN'" + lf
            End If
        Else
            If kleur > 0 Then
                ' es = es + "CCI+++S99:161:VBN'" + lf   'S99 ipv kleur
                ' es = es + "CAV+" + Format(kleur, "000") + ":161:VBN'" + lf


                es = es + "CCI+++S50:161:VBN'" + lf  'kleur mix
                es = es + "CAV+51:161:VBN'" + lf
            End If
        End If
        '   End If

        If accessoire_code > 0 Then
            es = es + "CCI+++S63:161:VBN'" + lf   'S63 interne code
            es = es + "CAV+" + Format(accessoire_code, "000") + ":161:VBN'" + lf
        End If


        'If hoeskleur > 0 Then   'HOESKLEUR / SDFCODE
        'Dim hoeskleur As Integer = 2
        'es = es + "CCI+++S69:161:VBN'" + lf
        'es = es + "CAV+" + Format(hoeskleur, "000") + ":161:VBN'" + lf
        ' End If

        es = es + "CCI+++S98:161:VBN'" + lf
        es = es + "CAV+" + kwaliteit + ":161:VBN'" + lf

        es = es + "CCI+++S62:161:VBN'" + lf   'land van herkomst
        es = es + "CAV+NL:161:VBN'" + lf

        es = es + "CCI+++K07:161:VBN'" + lf   'MPS GAP
        es = es + "CAV+014:161:VBN'" + lf

        If keurcode > 0 Then
            es = es + "CCI+++K01:161:VBN'" + lf
            es = es + "CAV+" + Format(keurcode, "000") + ":161:VBN'" + lf
        End If
        If veilingbrief = 1 Then
            es = es + "PAT+BVH'" + lf
        End If
        If veilingbrief = 2 Then
            es = es + "PAT+VBA'" + lf
        End If
        If veilingbrief = 4 Then
            es = es + "PAT+PLE'" + lf
        End If
        If veilingbrief = 5 Then
            es = es + "PAT+VRM'" + lf
        End If
        '   If Mid(NAD_buyer_ean, 1, 4) = "0000" Then
        'es = es + "PRI+INV:0.000::AAJ:1:1'" + lf    'klokorder, prijs 0
        '  Else
        ' klokprijzen ook opsturen imv klokvoorverkoop

        Dim stringprijs As String = pformatprijs(PRI_prijs, 3)
        es = es + "PRI+INV:" + stringprijs + "::AAJ:1:1'" + lf
        'Dim testprijs As String = "PRI+INV:" + stringprijs + "::AAJ:1:1'" + lf
        ' End If
        es = es + "CUX+7:EUR'" + lf

        es = es + "PAC++2+" + PAC_Fust_Code + ":67:VBN'" + lf
        es = es + "MEA+AAE++1:" + MEA_Aantal_per_Fust + "'" + lf

        If lin_count = 1 And brief = 1 Then
            es = es + "PAC++3+" + PAC_Kar_Code + ":146:EF'" + lf
            es = es + "MEA+AAE++1:" + MEA_Aantal_Plant_per_kar + "'" + lf
            es = es + "MEA+AAE++4:" + MEA_Aantal_lagen_per_kar + "'" + lf
        ElseIf lin_count = 2 And brief = 1 And (kar_type = 10 Or kar_type = 11) Then   'DV's .. deen meesturen met regel 2
            es = es + "PAC++3+" + PAC_Kar_Code + ":146:EF'" + lf
            es = es + "MEA+AAE++1:" + MEA_Aantal_Plant_per_kar + "'" + lf
            es = es + "MEA+AAE++4:" + MEA_Aantal_lagen_per_kar + "'" + lf
        Else
            es = es + "PAC++3+999:146:EF'" + lf
            es = es + "MEA+AAE++1:5000'" + lf
        End If

        'nads
        Dim buyer_ean = Trim(NAD_buyer_ean)
        If Len(buyer_ean) > 13 Then
            buyer_ean = Mid(buyer_ean, 1, 13)
        End If
        es = es + "NAD+BY+" + buyer_ean + ":160:9'" + lf
        If kopercode = "" Then
            es = es + "RFF+ON:L" + Trim(lin_count)
        Else
            es = es + "RFF+ON:" + UNOA(Trim(kopercode))
        End If
        es = es + "'" + lf

        'Representative misbruiken om pakbonnummer mee te sturen
        es = es + "NAD+SR+" + onze_ean + ":160:9'" + lf
        es = es + "RFF+ON:" + Trim(barcode)
        es = es + "'" + lf


        If Mid(NAD_buyer_ean, 1, 4) = "0000" Or NAD_deliveringparty_ean = "" Then
            'geen NAD DP omdat het een klokorder of distrubitie is
        Else
            es = es + "NAD+DP+" + Trim(NAD_deliveringparty_ean) + ":160:9'" + lf
        End If

        es = es + "NAD+SE+" + Trim(onze_ean) + ":160:9'" + lf


        If keten_ean <> "" Then
            es = es + "NAD+MA+" + Trim(keten_ean) + ":160:9'" + lf
        End If
        Return es
    End Function
    Public Function pformatprijs(ByVal prijs As Double, ByVal decimals As Integer) As String
        Dim stringprijs As String = ""

        If decimals = 2 Then
            stringprijs = Format(prijs, "##0.00")
        End If
        If decimals = 3 Then
            stringprijs = Format(prijs, "##0.000")
        End If
        Dim puntpos As Integer = InStr(stringprijs, ",")
        If puntpos > 0 Then
            stringprijs = Mid(stringprijs, 1, puntpos - 1) + "." + Mid(stringprijs, puntpos + 1, 3)
        End If
        Return stringprijs
    End Function
    Private Function create_edi_footer(ByVal UNBcounter As Double, ByVal header_id As Integer, ByVal edi_string As String, ByVal Kar_id As Integer) As String
        Dim linecount As Integer
        Dim es As String
        es = edi_string + "UNS+S'"
        linecount = countlines(es)
        es = "UNS+S'" + lf

        es = es + "UNT+" + Trim(Str$(linecount)) + "+" + Format(UNBcounter, "00000000000") + "'" + lf
        es = es + "UNZ+1+" + Format(UNBcounter, "00000000000") + "'"
        Return es
    End Function
    Private Function countlines(ByVal edi As String) As Integer

        Dim index As Long
        Dim bytes() As Byte
        Dim lcount As Integer = 0

        ' the fastest way to process this string
        ' is copy it into an array of Bytes
        bytes = StrToByteArray(edi)
        index = 0
        Do While index <= UBound(bytes)
            ' if this is a control character

            'EdiText.Text = EdiText.Text + Chr(bytes(index))

            If bytes(index) = Asc("?") Then
                index = index + 1
            Else
                If bytes(index) = Asc("'") Then
                    lcount = lcount + 1
                    'EdiText.Text = EdiText.Text + " " + Str(lcount)
                End If
            End If
            index = index + 1

        Loop
        Return lcount
    End Function
    Private Function UNOA(ByVal edi As String) As String
        Dim i As Long
        Dim kchar As String
        Dim charset As String
        Dim edilen As Integer
        'check charset UNOA
        edi = Trim(UCase(edi))
        'UNOA allows: A to Z    0 to 9     . , – ( ) / = (space)
        edi = Replace(edi, "`", "'")
        charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,–()/= :+'?" + Chr(45)
        For i = 1 To Len(edi) + 1
            kchar = Mid$(edi, i, 1)
            If Not InStr(1, charset, kchar, vbBinaryCompare) > 0 Then
                edi = Replace(edi, kchar, " ")  'replace forbidden chars with space
                edi = Trim(edi)                'cut ending spaces
            End If
        Next i
        'charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,–()/= :+'?"
        edilen = Len(edi)
        i = 1
        Do While i <= edilen
            kchar = Mid(edi, i, 1)
            If kchar = ":" Or kchar = "+" Or kchar = "'" Or kchar = "?" Then
                edi = Mid(edi, 1, i - 1) + "?" + Mid(edi, i, edilen - i + 1)
                i = i + 1
                edilen = edilen + 1
            End If
            i = i + 1
        Loop

        UNOA = edi
    End Function
    Private Sub OrderResetToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OrderResetToolStripMenuItem.Click

        Dim header_id As Integer = -1

        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(Node.Tag, 4))
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        header_id = Val(Mid(node2.Tag, 4))
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If


        If header_id >= 0 Then

            Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
            If staticyear = True Then orderyear = ""
            Dim orderkarren_db As String = "OrderKarren" + orderyear
            Dim orderkarlines_db As String = "OrderKarLines" + orderyear

            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim ordernr As String = ""
                    Dim karid As Integer = -1
                    'find error
                    Dim Reader2 As OdbcDataReader
                    Dim cmdstring7 As String = "SELECT barcode,kar_id FROM " + orderkarren_db + " where wps_status = -1 and header_id = " + Str(header_id)
                    Dim Cmd3 As New OdbcCommand(cmdstring7, Conn)
                    Reader2 = Cmd3.ExecuteReader()
                    Do While Reader2.Read()
                        ordernr = CHstr(Reader2("barcode"))
                        karid = CHint(Reader2("kar_id"))
                        'set status 
                        Dim cmdstring As String = "UPDATE " + orderkarren_db + " SET wps_status = 6 where barcode = '" + ordernr + "'"
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        Cmd.ExecuteNonQuery()

                        Dim cmdstring4 As String = "UPDATE " + orderkarlines_db + " SET wps_flag = 1 where kar_id =" + Str(karid)
                        Dim Cmd4 As New OdbcCommand(cmdstring4, Conn)
                        Cmd4.ExecuteNonQuery()

                    Loop
                    Reader2.Close()
                  
                    SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id)

                End Using

            Catch ex As Exception
                MsgBox("Fout opslag wps status: " + ex.Message, MsgBoxStyle.OkOnly)
            End Try

        End If

    End Sub
    Public Sub SetNewStatusFlag(ByVal datum As Date, ByVal header_id As Integer, Optional ByVal update_boek_now As Boolean = True)
        ' set new status flags
        Dim orderyear As String = Trim(Str(Year(datum)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear
        Dim newstatus As Integer = 0

        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim cmdstring6 As String = "SELECT * FROM " + orderkarren_db + " WHERE Header_id = " + Str(header_id)
                Dim Cmd2 As New OdbcCommand(cmdstring6, Conn)
                Reader = Cmd2.ExecuteReader()
                Dim sdf_flagtrue As Boolean = 0
                Dim sdf_flagfalse As Boolean = 0

                '  Dim scan_flagtrue As Boolean = 0
                '  Dim scan_flagfalse As Boolean = 0


                Dim vervoer_flagtrue As Boolean = 0
                Dim vervoer_flagfalse As Boolean = 0


                Dim floriday_done As Boolean = True
                Dim floriday_clear As Boolean = True
                Dim floriday_error As Boolean = False
                Dim floriday_printflag As Integer = 0
                Dim sdf_flag As Boolean
                'Dim scan_flag As Boolean
                Dim vervoer_flag As Boolean
                Dim wps_status As Integer = 0
                Dim wps_tempstatus As Integer = 0
                Dim alle_karren_onderweg As Boolean = True
                Do While Reader.Read()
                    sdf_flag = CHbool(Reader("sdf_flag"))
                    vervoer_flag = CHbool(Reader("vervoer_flag"))
                    'scan_flag = CHbool(Reader("scan_flag"))
                    floriday_printflag = CHint(Reader("floriday_printflag"))

                    If floriday_printflag > 0 Then sdf_flag = True

                    If sdf_flag = True Then
                        sdf_flagtrue = True
                    End If
                    If sdf_flag = False Then
                        sdf_flagfalse = True
                    End If

                    If floriday_printflag > 90 Then
                        floriday_error = True
                    End If

                    'If scan_flag = True Then
                    'scan_flagtrue = True
                    'End If
                    'If scan_flag = False Then
                    'scan_flagfalse = True
                    ' End If

                    If vervoer_flag = True Then
                        vervoer_flagtrue = True
                    End If
                    If vervoer_flag = False Then
                        vervoer_flagfalse = True
                    End If
                    wps_tempstatus = CHint(Reader("wps_status"))
                    If wps_tempstatus = 0 Then
                        alle_karren_onderweg = False
                    Else
                        Dim dum As Integer = 0
                    End If


                    Select Case wps_tempstatus
                        Case -1
                            wps_status = -1
                        Case 1
                            If wps_status = 0 Then wps_status = 1
                        Case 2
                            If wps_status = 0 Or wps_status = 1 Then wps_status = 2
                        Case 3
                            If wps_status <= 3 Then wps_status = 3
                        Case 4
                            If wps_status <= 4 Then wps_status = 4
                        Case 5
                            If wps_status <= 5 Then wps_status = 5
                        Case 6
                            If wps_status <= 6 Then wps_status = 6
                        Case 7
                            If wps_status <= 7 Then wps_status = 7

                    End Select
                Loop

                Reader.Close()
                Dim sdf_done As Boolean = False
                If sdf_flagtrue = True And sdf_flagfalse = True Then
                    'If scan_flagfalse = True Then
                    newstatus = 40  'sdf gedeeltelijk
                    sdf_done = True
                    'End If
                    'If scan_flagtrue = True And scan_flagfalse = False Then
                    'newstatus = 45  'sdf gedeeltelijk + scan
                    'sdf_done = True
                    'endIf
                End If
                If sdf_flagtrue = True And sdf_flagfalse = False Then
                    newstatus = 41  'sdf compleet
                    sdf_done = True
                End If



                '  wps berekenen

                Dim cmdstring7 As String = "SELECT wps_flag FROM " + orderkarlines_db + " WHERE Header_id = " + Str(header_id)
                Dim Cmd3 As New OdbcCommand(cmdstring7, Conn)
                Reader = Cmd3.ExecuteReader()
                Dim wps_flagtrue As Boolean = 0
                Dim wps_flagfalse As Boolean = 0
                Dim wps_flag As Boolean
                Do While Reader.Read()
                    wps_flag = CHbool(Reader("wps_flag"))
                    If wps_flag = True Then
                        wps_flagtrue = True
                    End If
                    If wps_flag = False Then
                        wps_flagfalse = True
                    End If
                Loop
                Reader.Close()
                If wps_flagtrue = True And wps_flagfalse = False Then
                    If sdf_done = False Then
                        'newstatus = 32  'wps compleet

                        'If scan_flagfalse = True Then
                        newstatus = 32  'wps compleet
                        'End If
                        'If scan_flagtrue = True And scan_flagfalse = False Then
                        ' newstatus = 29  'wps compleet + scan
                        ' sdf_done = True
                        'End If

                    End If
                End If
                If wps_flagtrue = True And wps_flagfalse = True Then
                    If sdf_done = False Then
                        newstatus = 37   'wps gedeeltelijk
                        Select Case wps_status
                            Case -1 : newstatus = 39  'fout, uitroepteken
                            Case 0 : newstatus = 31  'nieuwe orderregel toegevoegd,niet verstuurd 
                            Case 1 : newstatus = 33  'klaar voor versturen, geel
                            Case 2 : newstatus = 37  'verstuurd, blauw
                            Case 3 : newstatus = 37  'wps bezig afsturen, paars
                            Case 4 : newstatus = 37  'wps bezig afsturen, paars
                            Case 5 : newstatus = 37  'wps bezig afsturen, paars
                            Case 6 : newstatus = 38  'wps bezig afsturen, paars
                            Case 7 : newstatus = 38  'wps bezig afsturen, paars

                        End Select
                    Else
                        If alle_karren_onderweg = True Then
                            newstatus = 42   'wps gedeeltelijk/sdf af/gedeeltelijk
                        Else
                            newstatus = 28
                        End If

                    End If
                End If
                If wps_flagtrue = False And wps_flagfalse = True Then
                    If sdf_done = True Then
                        'newstatus = 28   'wps niet af/sdf af/gedeeltelijk
                        If alle_karren_onderweg = True Then
                            newstatus = 42   'wps gedeeltelijk/sdf af/gedeeltelijk
                        Else
                            newstatus = 28
                        End If

                    End If
                End If
                If newstatus = 41 Then   'sdf&wps done?
                    If vervoer_flagtrue = True And vervoer_flagfalse = True Then
                        newstatus = 50  'vervoer gedeeltelijk
                    End If
                    If vervoer_flagtrue = True And vervoer_flagfalse = False Then
                        newstatus = 51  'vervoer compleet
                    End If
                End If

                'nieuwe wps statusen

                If newstatus = 0 Then
                    Select Case wps_status
                        Case -1 : newstatus = 39  'fout, uitroepteken
                        Case 0 : newstatus = 20  'nieuwe order 
                        Case 1 : newstatus = 33  'klaar voor versturen, geel
                        Case 2 : newstatus = 34  'verstuurd, blauw
                        Case 3 : newstatus = 34  'geaccepteerd in wps
                        Case 4 : newstatus = 34  'order vrijgegeven door boek
                        Case 5 : newstatus = 35  'wps bezig afsturen, paars
                        Case 6 : newstatus = 36  'wps pakbon uitdraaien
                        Case 7 : newstatus = 36  'wps klaar > wps klaar geeft V)
                    End Select
                End If
                Dim CmdHeaderString As String = "select * from " + orderheader_db + " WHERE Header_id = " + Str(header_id)
                Dim Cmd As New OdbcCommand(CmdHeaderString, Conn)

                Reader = Cmd.ExecuteReader()
                Dim afleverlocs As Integer = 0
                Dim agenda_mark As Integer = 0
                Dim stickers As Integer = 0
                If Reader.HasRows Then
                    Reader.Read()
                    afleverlocs = CHint(Reader("afleverloc"))
                    agenda_mark = CHint(Reader("agenda_mark"))
                    stickers = CHint(Reader("sticker"))
                End If

                If newstatus = 41 Then 'sdf klaar -> document toevoegen?
                    If stickers = 9 Or stickers = 10 Then
                        newstatus = 44
                    End If
                End If

                If newstatus = 20 Then
                    If stickers = 1 Or stickers = 3 Or stickers = 7 Or stickers = 10 Then
                        newstatus = 21
                    End If
                    If stickers = 2 Or stickers = 4 Or stickers = 6 Then
                        newstatus = 22
                    End If
                    If stickers = 8 Then
                        newstatus = 24
                    End If
                    If stickers = 11 Then
                        newstatus = 25
                    End If
                End If

                If floriday_error = True Then
                    newstatus = 48
                End If

                If agenda_mark = 1 Then
                    newstatus = 43
                End If
                If agenda_mark = 2 Then
                    newstatus = 98
                End If
                If agenda_mark = 3 Then
                    newstatus = 49
                End If

                Dim CmdHeaderString1 As String = "select * from " + orderheader_db + " WHERE 1=0"
                Dim Cmd4 As New OdbcCommand(CmdHeaderString1, Conn)
                With Cmd4
                    .CommandText = "UPDATE " + orderheader_db + " SET status=? WHERE Header_id = " + Str(header_id)
                    .Parameters.Clear()
                    .Parameters.AddWithValue("", newstatus)
                    .ExecuteNonQuery()
                End With
            End Using
        Catch ex As Exception

            ErrorLog("Fout update status flags : " + ex.Message)
            MsgBox("Fout update status flags : " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        If update_boek_now = True Then
            Set_Boek_reload()
            Update_Boek()
        End If

    End Sub
    Private Sub Mail_Edi(ByVal header_id As Integer, ByVal edistring As String)


        Dim mailman As New Chilkat.MailMan()

        Dim success As Boolean
        success = mailman.UnlockComponent("CAIWNLMAILQ_Z9R85EV9nR4V")
        If (success <> True) Then
            MsgBox("MailComponent unlock failed, sendmail failed")
            MsgBox(mailman.LastErrorText)
            Exit Sub
        End If

        Dim tempname As String
        tempname = Format(header_id, "00000000") + ".dat"

        '  Set the SMTP server.
        'MailRecipient = "home@campanula.com" '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        'MailHost = "smtp.caiway.nl"

        If MailHost <> "" Or MailRecipient <> "" Then
            mailman.SmtpHost = MailHost
        Else
            MsgBox("<Mailhost/recipient not found> Cannot send edi")
            Exit Sub
        End If
        '  Create a new email object
        Dim email As New Chilkat.Email()

        email.Subject = "ORDERS;AVR"
        email.Body = ""
        email.From = "home@campanula.com"
        email.AddTo("sdf", MailRecipient)
        email.ClearBcc()
        '   email.AddBcc("Florecom BCC", "home@campanula.com")

        Dim attachmentContent As String
        attachmentContent = edistring

        email.AddStringAttachment2(tempname, attachmentContent, "ansi")
        email.AddAttachmentHeader(0, "Content-Type", "application/edifact")

        ' success = False
        success = mailman.SendEmail(email)                                          '  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! DEBUG

        If (success <> True) Then
            MsgBox("Mail error, Send mail failed")
        End If

    End Sub
    Private Sub Orders_WpsXML_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Orders_WpsXML_but.Click
        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        'Exit For
                    End If
                Next node2
            End If
        Next Node


        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub

        Dim id As Integer = 0
        Try
            ' Open(Connection)
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For i = 1 To id_counter - 1

                    Dim header_id As Integer = mark_idlist(i)
                    Dim Cmd As New OdbcCommand("select * from orderheaders WHERE Header_id = ?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", header_id)
                    Dim reader As OdbcDataReader
                    reader = Cmd.ExecuteReader()
                    Dim mark As Integer = 0
                    If reader.HasRows Then
                        reader.Read()
                        mark = CHint(reader("agenda_mark"))
                    End If
                    reader.Close()
                    If mark = 0 Then
                        Dim Cmd2 As New OdbcCommand("UPDATE OrderKarren SET Wps_status=1 WHERE header_id = ?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", mark_idlist(i))
                        Cmd2.ExecuteNonQuery()
                    End If
                Next

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag wps versturen: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        For i = 1 To id_counter - 1
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, mark_idlist(i))
        Next


    End Sub

    Private Sub Order_PrintBriefFloriday_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Order_PrintBriefFloriday.Click
        Dim mark_idlist(101) As Integer

        Dim idlist(101) As Integer
        For clearloop = 0 To 100
            idlist(clearloop) = -1
        Next
        Dim id_counter As Integer = 1

        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        'Exit For
                    End If
                Next node2
            End If
        Next Node

        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If
        sdf_date = Order_MonthCalendar.SelectionStart
        If id_counter = 1 Then Exit Sub


        Dim ordercount As Integer = id_counter - 1
        Dim orderyear As String = Trim(Str(Year(sdf_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear

        'DebugText.Text = ""

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim print_ok As Boolean = False
                For orderloop = 1 To ordercount
                    Dim header_id As Integer = idlist(orderloop)

                    'koper ean ophalen + brief-type (ivm factuur generatie ipv sdf versturen) 
                    Dim koper_ean As String = ""
                    Dim veilingbrief_id As Integer = 1
                    Dim aanvulling_headerid As Integer = 0

                    Dim CmdString As String = "select * from " + orderheader_db + " WHERE  Header_id = " + Str(header_id) + " "
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Dim Reader As OdbcDataReader
                    Reader = Cmd.ExecuteReader
                    If Reader.HasRows Then
                        Reader.Read()
                        koper_ean = CHstr(Reader("koper_ean"))
                        veilingbrief_id = CHint(Reader("veilingbrief_id"))
                        aanvulling_headerid = CHint(Reader("aanvulling"))
                    End If

                    'verzamelkar check
                    'staat deze ean in kopersgroep 8 (verzamelkar)
                    Dim koper_in_groep As Boolean = False
                    Dim CmdHeaderString3 As String = "select * from kopersgroepen2_eans WHERE id=8 and ean = '" + koper_ean + "'"
                    Dim Cmd3 As New OdbcCommand(CmdHeaderString3, Conn)
                    Dim Reader3 As OdbcDataReader
                    Reader3 = Cmd3.ExecuteReader()
                    If Reader3.HasRows Then
                        koper_in_groep = True
                    End If
                    Reader3.Close()
                    Dim nietprinten As Boolean = False
                    If koper_in_groep = True Then
                        'is het minder als 10 bakjes?

                        Dim CmdHeaderString As String = "select SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.header_id = " + Str(header_id) + " GROUP BY ol.koper_naam"
                        Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                        Dim Reader5 As OdbcDataReader
                        Reader5 = Cmdr.ExecuteReader()
                        Do While Reader5.Read()
                            Dim aantal As Integer = CHint(Reader5("taantal"))
                            Dim koper_naam As String = CHstr(Reader5("koper_naam"))
                            If aantal < 9 And aanvulling_headerid = 0 Then
                                Dim result As Integer = MessageBox.Show("Koper '" + koper_naam + "' heeft minder als 9 bakken en staat in de verzamelkar lijst. Wilt u deze kar toch printen?", "", MessageBoxButtons.YesNo)
                                If result = DialogResult.No Then
                                    nietprinten = True
                                ElseIf result = DialogResult.Yes Then
                                    nietprinten = False
                                End If
                            End If
                        Loop
                    End If
                    '
                    If veilingbrief_id = 3 Then   'factuur?
                        print_factuur(header_id)
                    ElseIf nietprinten = True Then
                        'skip.. niet printen maar handmatig verzamelkar van maken
                    Else
                        Dim success As Boolean = PrintBriefFloriday(header_id, 0)
                        If success = True Then print_ok = True
                    End If

                Next orderloop
                'Update_Boek()

                If print_ok = True Then
                    MsgBox("Brieven worden geprint")
                End If


                Set_Boek_reload()

            End Using
        Catch ex As Exception
            ErrorLog("Fout: print floriday" + ex.Message)
            MessageBox.Show("Fout: print floriday" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Function PrintBriefFloriday(header_id As Integer, kar_id As Integer) As Boolean

        Dim print_ok As Boolean = True
        Dim id As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand("", Conn)
                Dim reader As OdbcDataReader

                Dim Cmd2 As New OdbcCommand("", Conn)
                Dim reader2 As OdbcDataReader


                'check of alle trade-items zijn ingevuld bij klokbrieven via floriday
                'is het een klok order?
                Dim klok As Boolean = False
                Cmd.CommandText = "SELECT koper_ean from orderheaders WHERE header_id = " + Trim(Str(header_id))
                reader = Cmd.ExecuteReader()
                If reader.HasRows Then
                    reader.Read()
                    Dim koper_ean As String = CHstr(reader("koper_ean"))
                    If Val(koper_ean) >= 1000 And Val(koper_ean) < 2000 Then
                        klok = True
                    End If
                End If
                reader.Close()

                If klok = True Then
                    Cmd.CommandText = "SELECT * from orderlines WHERE OrderHeader_id = " + Trim(Str(header_id))
                    reader = Cmd.ExecuteReader()
                    Do While reader.Read()
                        Dim soort_id As Integer = CHint(reader("soort_id"))
                        Dim fotopath As String = CHstr(reader("foto"))

                        If soort_id < 10000 Then
                            Cmd2.CommandText = "SELECT * from soorten3 WHERE id = " + Trim(Str(soort_id))
                            reader2 = Cmd2.ExecuteReader()
                            If reader2.HasRows Then
                                reader2.Read()
                                Dim tradeitem_klok As Integer = CHint(reader2("tradeitem_klok"))
                                Dim soortnaam As String = CHstr(reader2("soortnaam"))
                                If tradeitem_klok > 0 Then
                                    'ok
                                Else
                                    MsgBox("Van deze klokbrief is " + soortnaam + " niet voorzien van een trade-item (Database->Soorten->Tradeitem klok), de brief kan niet worden geprint")
                                    print_ok = False
                                End If
                            End If
                            reader2.Close()
                        Else
                            Cmd2.CommandText = "SELECT * from mixen WHERE id = " + Trim(Str(soort_id - 10000))
                            reader2 = Cmd2.ExecuteReader()
                            If reader2.HasRows Then
                                reader2.Read()
                                Dim tradeitem_klok As Integer = CHint(reader2("tradeitem_klok"))
                                Dim naam As String = CHstr(reader2("naam"))
                                If tradeitem_klok > 0 Then
                                    'ok
                                Else
                                    MsgBox("Van deze klokbrief is " + naam + " niet voorzien van een trade-item (Database->Mixen->Tradeitem klok), de brief kan niet worden geprint")
                                    print_ok = False
                                End If
                            End If
                            reader2.Close()
                        End If

                        If fotopath = "" Then
                            MsgBox("Van enkele orderlines is de foto nog niet toegevoegd, brief kan niet geprint worden")
                            Return False
                        End If

                    Loop
                    reader.Close()
                Else
                    'BB check for floriday 
                    print_ok = True
                    Cmd2.CommandText = "SELECT * from orderlines WHERE orderheader_id = " + Trim(Str(header_id))
                    reader2 = Cmd2.ExecuteReader()
                    Do While reader2.Read()
                        Dim FloridayNr As String = CHstr(reader2("Floridaynr"))

                        If FloridayNr = "" Then
                            print_ok = False
                        End If
                    Loop
                    If print_ok = False Then
                        MsgBox("Van deze BB brief zijn niet alle orderlines afkomstig van Floriday, de brief kan niet worden geprint via floriday")
                    End If
                    reader2.Close()

                End If

                If print_ok = True Then

                    If kar_id > 0 Then

                        Cmd2.CommandText = "SELECT * from orderkarren WHERE kar_id = " + Trim(Str(kar_id))
                        reader2 = Cmd2.ExecuteReader()
                        If reader2.HasRows Then
                            reader2.Read()
                            Dim floriday_printflag As Integer = CHint(reader2("floriday_printflag"))

                            If floriday_printflag = 0 Then   'eerste keer printen
                                Cmd.CommandText = "UPDATE orderkarren Set floriday_printflag=1 WHERE kar_id = " + Str(kar_id)
                                Cmd.ExecuteNonQuery()
                                SetNewStatusFlag(Now, header_id)
                            End If
                            If floriday_printflag = 5 Then  ' nogmaals printen

                                Cmd.CommandText = "INSERT INTO afleverscan(datumtijd,kar_id,status,barcode,vestiging,pagina) VALUES (?,?,?,?,?,?)"
                                Cmd.Parameters.Clear()
                                Cmd.Parameters.AddWithValue("", Format(Now, "yy-MM-dd HH:mm:ss"))
                                Cmd.Parameters.AddWithValue("", kar_id)
                                Cmd.Parameters.AddWithValue("", 1) 'print handmatig
                                Cmd.Parameters.AddWithValue("", "")
                                Cmd.Parameters.AddWithValue("", TreeviewVestiging)  'vestiging afhankelijk van boek
                                Cmd.Parameters.AddWithValue("", 1)
                                Cmd.ExecuteNonQuery()
                                SetNewStatusFlag(Now, header_id)
                            End If
                        End If


                    Else
                        Cmd2.CommandText = "SELECT * from orderkarren WHERE header_id = " + Trim(Str(header_id))
                        reader2 = Cmd2.ExecuteReader()
                        Do While reader2.Read()
                            Dim floriday_printflag As Integer = CHint(reader2("floriday_printflag"))
                            Dim karrun_id As Integer = CHint(reader2("kar_id"))

                            If floriday_printflag = 0 Then   'eerste keer printen
                                Cmd.CommandText = "UPDATE orderkarren Set floriday_printflag=1 WHERE kar_id = " + Str(karrun_id)
                                Cmd.ExecuteNonQuery()
                                SetNewStatusFlag(Now, header_id)
                            End If

                            If floriday_printflag = 5 Then  ' nogmaals printen

                                Cmd.CommandText = "INSERT INTO afleverscan(datumtijd,kar_id,status,barcode,vestiging,pagina) VALUES (?,?,?,?,?,?)"
                                Cmd.Parameters.Clear()
                                Cmd.Parameters.AddWithValue("", Format(Now, "yy-MM-dd HH:mm:ss"))
                                Cmd.Parameters.AddWithValue("", karrun_id)
                                Cmd.Parameters.AddWithValue("", 1) 'print handmatig
                                Cmd.Parameters.AddWithValue("", "")
                                Cmd.Parameters.AddWithValue("", TreeviewVestiging)  'vestiging afhankelijk van boek
                                Cmd.Parameters.AddWithValue("", 1)
                                Cmd.ExecuteNonQuery()
                                SetNewStatusFlag(Now, header_id)

                            End If


                        Loop
                        reader2.Close()
                    End If

                End If


            End Using
        Catch ex As Exception
            MsgBox("Fout print floriday brieven: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        SetNewStatusFlag(Order_MonthCalendar.SelectionStart, kar_id)

        If print_ok = True Then
            Return True
        End If
        Return False

    End Function

    Private Sub TimerBarcodeServer_Tick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TimerBarcodeServer.Tick

        If 0 = 0 Then Exit Sub

        If Me.Inst_barcodeserver.Checked = True Then
            If barcode_tick_active = False Then
                'lees barcode uit scan tabel
                barcode_tick_active = True
                Try
                    'Open Connection
                    Using Conn As New OdbcConnection(ConnString)
                        Conn.Open()

                        Dim cmdstring As String = "SELECT * FROM barcode_list where done = 0"
                        Dim reader As OdbcDataReader
                        'Execute Query
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        reader = Cmd.ExecuteReader()
                        Do While reader.Read
                            Dim barcode As String = CHstr(reader("barcode"))
                            Dim barcode_lijstid As Integer = CHint(reader("id"))
                            barcode = "00" + barcode

                            Dim header_id As Integer = -1
                            Dim sdf_flag As Integer = -1
                            Dim scan_flag As Integer = -1
                            Dim kar_id As Integer = -1
                            ' kar info ophalen
                            Dim cmdstring2 As String = "SELECT * FROM orderkarren where barcode='" + barcode + "'"
                            Dim reader2 As OdbcDataReader
                            Dim Cmd2 As New OdbcCommand(cmdstring2, Conn)
                            reader2 = Cmd2.ExecuteReader()
                            If reader2.HasRows Then
                                reader2.Read()
                                header_id = CHint(reader2("header_id"))
                                sdf_flag = CHbool(reader2("sdf_flag"))
                                scan_flag = CHbool(reader2("scan_flag"))
                                kar_id = CHint(reader2("kar_id"))
                            End If
                            reader2.Close()

                            Dim order_aanwezig As Boolean = False
                            If header_id > 0 Then  'kar gevonden, kijken of order nog wel aanwezig is
                                Dim cmdstring3 As String = "SELECT * FROM orderheaders where header_id=" + Trim(Str(header_id))
                                Dim reader3 As OdbcDataReader
                                Dim Cmd3 As New OdbcCommand(cmdstring3, Conn)
                                reader3 = Cmd3.ExecuteReader()
                                If reader3.HasRows Then
                                    If sdf_flag = 0 And scan_flag = 1 And kar_id > 0 Then
                                        'order gevonden -> versturen naar sdf
                                        Orders_SdfVersturenMain(header_id, kar_id)
                                    End If
                                Else
                                    'voor samengevoegde orders nieuwe kar traceren
                                    Dim cmdstring5 As String = "SELECT * FROM orderlines where old_header_id=" + Trim(Str(header_id))
                                    Dim reader5 As OdbcDataReader
                                    Dim Cmd5 As New OdbcCommand(cmdstring5, Conn)
                                    reader5 = Cmd5.ExecuteReader()
                                    Do While reader5.Read
                                        'orderline gevonden, op welke kar staat deze orderline nu ?

                                        Dim orderline_id As Integer = CHint(reader5("orderline_id"))

                                        'zoek orderline in orderkarlines
                                        Dim cmdstring6 As String = "SELECT * FROM orderkarlines where orderline_id=" + Trim(Str(orderline_id))
                                        Dim reader6 As OdbcDataReader
                                        Dim Cmd6 As New OdbcCommand(cmdstring6, Conn)
                                        reader6 = Cmd6.ExecuteReader()
                                        Do While reader6.Read
                                            'orderline gevonden, op welke kar(ren) staat deze orderline nu ?
                                            Dim foundkar_id As Integer = CHint(reader6("kar_id"))

                                            Dim cmdstring7 As String = "SELECT * FROM orderkarren where kar_id=" + Trim(Str(foundkar_id))
                                            Dim reader7 As OdbcDataReader
                                            Dim Cmd7 As New OdbcCommand(cmdstring7, Conn)
                                            reader7 = Cmd7.ExecuteReader()
                                            If reader7.HasRows Then
                                                reader7.Read()
                                                header_id = CHint(reader7("header_id"))
                                                sdf_flag = CHbool(reader7("sdf_flag"))
                                                scan_flag = CHbool(reader7("scan_flag"))
                                                kar_id = CHint(reader7("kar_id"))
                                                Dim cmdstring8 As String = "SELECT * FROM orderheaders where header_id=" + Trim(Str(header_id))
                                                Dim reader8 As OdbcDataReader
                                                Dim Cmd8 As New OdbcCommand(cmdstring8, Conn)
                                                reader8 = Cmd8.ExecuteReader()
                                                If reader8.HasRows Then
                                                    If sdf_flag = 0 And scan_flag = 1 And kar_id > 0 Then
                                                        'order versturen
                                                        Orders_SdfVersturenMain(header_id, kar_id)
                                                    End If
                                                End If
                                            End If
                                            reader7.Close()
                                        Loop
                                        reader6.Close()
                                    Loop
                                    reader5.Close()
                                End If
                            End If


                            Dim cmdstring4 As String = "UPDATE barcode_list SET done=1 WHERE id = " + Str(barcode_lijstid)
                            Dim Cmd4 As New OdbcCommand(cmdstring4, Conn)
                            Cmd4.ExecuteNonQuery()

                        Loop
                        reader.Close()
                    End Using
                Catch ex As Exception
                    ErrorLog("Database fout: (Read barcode list)" + ex.Message)
                    MessageBox.Show("Database fout: (Read barcode list)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                End Try
                barcode_tick_active = False
            End If
        End If
    End Sub

#End Region

#Region "Florecom"

    Private Sub Load_Florecom_Data()
        ' initialize datastructure for dropdown menu's 
        If dtt_fc_orderstatus.Columns.Count = 0 Then
            dtt_fc_orderstatus.Columns.Add("ID", GetType(String))
            dtt_fc_orderstatus.Columns.Add("desc", GetType(String))
        Else
            dtt_fc_orderstatus.Clear()
        End If
        dtt_fc_orderstatus.Rows.Add(New String() {Tstr(0), "Nieuw"})
        dtt_fc_orderstatus.Rows.Add(New String() {Tstr(1), "Verwerkt"})
        dtt_fc_orderstatus.Rows.Add(New String() {Tstr(2), "Verzonden"})


        If dtt_fc_linestatus.Columns.Count = 0 Then
            dtt_fc_linestatus.Columns.Add("ID", GetType(String))
            dtt_fc_linestatus.Columns.Add("desc", GetType(String))
        Else
            dtt_fc_linestatus.Clear()
        End If
        dtt_fc_linestatus.Rows.Add(New String() {Str(99), "Nog te bewerken"})
        dtt_fc_linestatus.Rows.Add(New String() {str(5), "Geaccepteerd"})
        dtt_fc_linestatus.Rows.Add(New String() {Str(6), "Niet geaccepteerd:Tegenvoorstel"})
        dtt_fc_linestatus.Rows.Add(New String() {Str(7), "Afgewezen"})
        dtt_fc_linestatus.Rows.Add(New String() {Str(24), "Geaccepteerd na telefonisch overleg"})
        dtt_fc_linestatus.Rows.Add(New String() {Str(999), "VMP Order"})

    End Sub
    Private Sub Setup_Florecom_Grid()

        Dim cn() As String = New String() {"desc"}
        With FC_Flexgrid_orderlijst
            .AllowEditing = False
            .Rows.Count = 1
            .Cols(1).DataType = System.Type.GetType("System.String")
            Dim mcd_status As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_fc_orderstatus, "ID", cn, 0)
            .Cols(1).DataMap = mcd_status

        End With

        FC_Flexgrid_orderlines.Styles.Clear()
        Dim rs As C1.Win.C1FlexGrid.CellStyle
        rs = FC_Flexgrid_orderlines.Styles.Add("kleur")

        Fc_Flexgrid_LineData.Styles.Clear()

        Dim rs1 As C1.Win.C1FlexGrid.CellStyle
        rs1 = Fc_Flexgrid_LineData.Styles.Add("RED")
        rs1.BackColor = Color.Red

        Dim rs2 As C1.Win.C1FlexGrid.CellStyle
        rs2 = Fc_Flexgrid_LineData.Styles.Add("CORAL")
        rs2.BackColor = Color.Coral

        Dim rs3 As C1.Win.C1FlexGrid.CellStyle
        rs3 = Fc_Flexgrid_LineData.Styles.Add("GREEN")
        rs3.BackColor = Color.Green

        Dim rs4 As C1.Win.C1FlexGrid.CellStyle
        rs4 = Fc_Flexgrid_LineData.Styles.Add("ORANGE")
        rs4.BackColor = Color.Orange

        Dim rs5 As C1.Win.C1FlexGrid.CellStyle
        rs5 = Fc_Flexgrid_LineData.Styles.Add("YELLOW")
        rs5.BackColor = Color.Yellow

        Dim rs6 As C1.Win.C1FlexGrid.CellStyle
        rs6 = Fc_Flexgrid_LineData.Styles.Add("LAVENDER")
        rs6.BackColor = Color.Lavender

        Dim rs7 As C1.Win.C1FlexGrid.CellStyle
        rs7 = Fc_Flexgrid_LineData.Styles.Add("WHITE")
        rs7.BackColor = Color.Lavender


        With FC_Flexgrid_orderlines
            .Rows.Count = 2
            .Cols(1).DataType = System.Type.GetType("System.String")
            Dim mcd_status2 As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_fc_linestatus, "ID", cn, 0)
            .Cols(1).DataMap = mcd_status2
            .Cols(1).AllowEditing = True

            .Cols(2).AllowEditing = False
            .Cols(3).AllowEditing = False
            .Cols(4).AllowEditing = False
        End With

        FC_Flexgrid_orderlijst.Rows.Count = 1
        Fc_Flexgrid_LineData.Rows.Count = 1
        FC_Flexgrid_orderlines.Rows.Count = 1
        FC_Flexgrid_contactdata.Rows.Count = 1

    End Sub
    Private Sub FcMenu_nieuw_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FcMenu_nieuw_but.Click
        LaadNieuweFlorecoms()
    End Sub
    Private Sub LaadNieuweFlorecoms()
        FC_Flexgrid_orderlijst.Rows.Count = 1
        Fc_Flexgrid_LineData.Rows.Count = 1
        FC_Flexgrid_orderlines.Rows.Count = 1
        FC_Flexgrid_contactdata.Rows.Count = 1
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'check of florecom ophalen door server gelocked is...
                Dim lockreader As OdbcDataReader
                Dim Cmdlck As New OdbcCommand("select * from instellingen", Conn)
                lockreader = Cmdlck.ExecuteReader()
                If lockreader.HasRows Then
                    lockreader.Read()
                    Dim lock As Integer = CHint(lockreader("LockFlorecomFetch"))
                    If lock = 1 Then
                        MsgBox("Florecom ophalen geblokeerd i.v.m. verwerking data, probeer nog een keer")
                        Exit Sub
                    End If
                End If


                Dim all_orders_done As Boolean = False
                Do While all_orders_done = False

                    Dim id As Integer = 0
                    Dim aflevertijd As Date = Now
                    Dim Reader As OdbcDataReader
                    Dim koper_ean As String = ""
                    Dim koper_naam As String = "Onbekende koper"
                    Dim locatie_ean As String = ""
                    'Execute Query
                    Dim CmdString As String = "SELECT * FROM edi2_lines where status='0' and ordernr='0'"
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        id = CHint(Reader("id"))
                        aflevertijd = CType(Reader("DTM_Delivery_Date"), Date)
                    Else
                        all_orders_done = True
                        Exit Do
                    End If
                    Reader.Close()

                    'koperean
                    Dim CmdString2 As String = "SELECT NAD_Party_ean FROM edi2_lines_nad where edi_line_id='" + Str(id) + "' and NAD_Party_Code = 'BY'"
                    Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                    Reader = Cmd2.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        koper_ean = CHstr(Reader("NAD_Party_ean"))
                    Else
                        'nad nog niet aanwezig, opnieuw in volgende loop 

                        Exit Do

                    End If
                    Reader.Close()

                    'locatie_ean
                    Dim CmdString3 As String = "SELECT NAD_Party_ean FROM edi2_lines_nad where edi_line_id='" + Str(id) + "' and NAD_Party_Code = 'DP'"
                    Dim Cmd3 As New OdbcCommand(CmdString3, Conn)
                    Reader = Cmd3.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        locatie_ean = CHstr(Reader("NAD_Party_ean"))
                    Else
                        locatie_ean = koper_ean  ' Geen DP dan maar gelijk aan koper ean

                    End If
                    Reader.Close()

                    'kopernaam
                    Dim koperfound As Boolean = False
                    Dim CmdString4a As String = "SELECT klantnaam FROM klanten where ean='" + Trim(koper_ean) + "'"
                    Dim Cmd4a As New OdbcCommand(CmdString4a, Conn)
                    Reader = Cmd4a.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        koper_naam = CHstr(Reader("klantnaam"))
                        koperfound = True
                    End If
                    Reader.Close()

                    If koperfound = False Then
                        Dim CmdString4 As String = "SELECT company_name FROM klantenlijst where GLN_Company_address_code='" + Trim(koper_ean) + "'"
                        Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                        Reader = Cmd4.ExecuteReader()
                        If Reader.HasRows Then
                            Reader.Read()
                            koper_naam = CHstr(Reader("company_name"))
                        End If
                        Reader.Close()
                    End If

                    'create new order
                    Dim CmdString5 = "SELECT id FROM edi2_orders WHERE 1=0"
                    Dim Cmd5 As New OdbcCommand(CmdString5, Conn)
                    With Cmd5
                        .CommandText = "INSERT INTO edi2_orders(status,koper_ean,koper_naam,aanmaak_datum,aantalcorrectie,boekopmerking,aflevertijd) VALUES(?,?,?,?,?,?,?)"
                        .Parameters.Clear()
                        .Parameters.AddWithValue("", 0)
                        .Parameters.AddWithValue("", koper_ean)
                        .Parameters.AddWithValue("", koper_naam)
                        .Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                        .Parameters.AddWithValue("", 0)
                        .Parameters.AddWithValue("", "")
                        .Parameters.AddWithValue("", Format(aflevertijd, "yyyy-MM-dd HH:mm"))
                        .ExecuteNonQuery()
                    End With
                    Dim order_id As Integer = 0
                    If postgress = True Then
                        Dim Cmd6 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('edi2_orders','id'))", Conn)
                        order_id = Convert.ToInt32(Cmd6.ExecuteScalar())
                    Else
                        Dim Cmd6 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                        order_id = Convert.ToInt32(Cmd6.ExecuteScalar())
                    End If

                    Cmd.CommandText = "UPDATE edi2_lines SET ordernr=? WHERE id = " + Str(id)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", order_id)
                    Cmd.ExecuteNonQuery()

                    'compare with new line

                    Dim next_id As Integer = 0
                    Dim next_aflevertijd As Date = Now
                    Dim next_koper_ean As String = ""
                    Dim next_locatie_ean As String = ""

                    Dim CmdString7 = "SELECT * FROM edi2_lines where status='0' and ordernr='0'"
                    Dim Cmd7 As New OdbcCommand(CmdString7, Conn)
                    Reader = Cmd7.ExecuteReader()
                    Do While Reader.Read()
                        next_id = CHint(Reader("id"))
                        next_aflevertijd = CType(Reader("DTM_Delivery_Date"), Date)

                        'koperean
                        Dim CmdString8 As String = "SELECT NAD_Party_ean FROM edi2_lines_nad where edi_line_id='" + Str(next_id) + "' and NAD_Party_Code = 'BY'"
                        Dim Cmd8 As New OdbcCommand(CmdString8, Conn)
                        Dim Reader2 As OdbcDataReader
                        Reader2 = Cmd8.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()
                            next_koper_ean = CHstr(Reader2("NAD_Party_ean"))
                        End If
                        Reader2.Close()

                        'locatie_ean
                        Dim CmdString9 As String = "SELECT NAD_Party_ean FROM edi2_lines_nad where edi_line_id='" + Str(next_id) + "' and NAD_Party_Code = 'DP'"
                        Dim Cmd9 As New OdbcCommand(CmdString9, Conn)
                        Reader2 = Cmd9.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()
                            next_locatie_ean = CHstr(Reader2("NAD_Party_ean"))
                        Else
                            next_locatie_ean = next_koper_ean  ' Geen DP dan maar gelijk aan koper ean
                        End If
                        Reader2.Close()

                        If aflevertijd = next_aflevertijd And koper_ean = next_koper_ean And locatie_ean = next_locatie_ean Then
                            Dim CmdString11 = "SELECT * FROM edi2_lines where 1=0"
                            Dim Cmd11 As New OdbcCommand(CmdString11, Conn)
                            Cmd11.CommandText = "UPDATE edi2_lines SET ordernr=? WHERE id = " + Str(next_id)
                            Cmd11.Parameters.Clear()
                            Cmd11.Parameters.AddWithValue("", order_id)
                            Cmd11.ExecuteNonQuery()
                        End If
                    Loop
                Loop

                'show list 
                Dim Reader5 As OdbcDataReader
                Dim flexgridfill(4) As String
                Dim CmdString10 As String = "SELECT * FROM edi2_orders where status='0'"
                Dim Cmd10 As New OdbcCommand(CmdString10, Conn)
                Reader5 = Cmd10.ExecuteReader()
                Do While Reader5.Read()
                    flexgridfill(0) = CHstr(Reader5("id"))
                    flexgridfill(1) = CHstr(Reader5("status"))
                    flexgridfill(2) = CHstr(Reader5("koper_naam"))
                    Dim datum As Date = CDate(Reader5("aflevertijd"))
                    flexgridfill(3) = Format(datum, "dddd dd-MM HH:mm")
                    FC_Flexgrid_orderlijst.AddItem(flexgridfill)
                Loop
                Reader5.Close()

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom nieuw)" + ex.Message)
            MessageBox.Show("Database fout: (florecom nieuw)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub FcMenu_Archief_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FcMenu_Archief.Click
        FC_Flexgrid_orderlijst.Rows.Count = 1
        Fc_Flexgrid_LineData.Rows.Count = 1
        FC_Flexgrid_orderlines.Rows.Count = 1
        FC_Flexgrid_contactdata.Rows.Count = 1
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader

                Dim order_id As Integer = Val(FcMenu_fcnummer_txt.Text)

                If Mid(FcMenu_fcnummer_txt.Text, 1, 1) = "L" Or Mid(FcMenu_fcnummer_txt.Text, 1, 1) = "l" Then
                    Dim lineid As Integer = Val(Mid(FcMenu_fcnummer_txt.Text, 2))
                    If lineid > 0 Then
                        Dim CmdString = "SELECT ordernr FROM edi2_lines where id = '" + Str(lineid) + "'"
                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                        Reader = Cmd.ExecuteReader()
                        If Reader.HasRows Then
                            order_id = CHint(Reader("ordernr"))
                        End If
                        Reader.Close()
                    End If
                End If

                If order_id > 0 Then
                    Dim CmdString = "SELECT * FROM edi2_orders where id = '" + Str(order_id) + "'"
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    Dim flexgridfill(5) As String
                    If Reader.HasRows Then
                        Reader.Read()
                        flexgridfill(0) = CHstr(Reader("id"))
                        flexgridfill(1) = CHstr(Reader("status"))
                        flexgridfill(2) = CHstr(Reader("koper_naam"))
                        Dim datum As Date = CType(Reader("aflevertijd"), Date)
                        flexgridfill(3) = Format(datum, "dd-MM-yyyy HH:mm")
                        FC_Flexgrid_orderlijst.AddItem(flexgridfill)
                    End If

                Else
                    '"AND koper_naam LIKE '%" + Order_zoek_txt.Text + "%' "
                    Dim searchkoper As String = ""
                    If FcMenu_fczoek_chk.Checked = True Then
                        searchkoper = "koper_naam LIKE '%" + FcMenu_fczoek_txt.Text + "%' AND"
                    End If
                    Dim CmdString = "SELECT * FROM edi2_orders where " + searchkoper + " status <> '0' AND aanmaak_datum BETWEEN '" + Format(Fc_DateTimePicker.Value, "yyyy-MM-dd") + " 00:00:00' AND '" + Format(Fc_DateTimePicker.Value, "yyyy-MM-dd") + " 23:59:59' ORDER BY aanmaak_datum DESC"
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    Dim flexgridfill(5) As String

                    Do While Reader.Read()
                        flexgridfill(0) = CHstr(Reader("id"))
                        flexgridfill(1) = CHstr(Reader("status"))
                        flexgridfill(2) = CHstr(Reader("koper_naam"))
                        Dim datum As Date = CType(Reader("aflevertijd"), Date)
                        flexgridfill(3) = Format(datum, "dd-MM-yyyy HH:mm")
                        FC_Flexgrid_orderlijst.AddItem(flexgridfill)
                    Loop

                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom archief)" + ex.Message)
            MessageBox.Show("Database fout: (florecom archief)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub FcMenu_vandaag_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FcMenu_vandaag_but.Click
        FcMenu_fcnummer_txt.Text = ""
        Fc_DateTimePicker.Value = Now
        FcMenu_Archief_Click(sender, e)
    End Sub

    ' Dim timeperparse As Stopwatch
    ' Private Sub TimePassed(ByVal title As String)
    '      Static oldtime As Long
    ''     Vervoer_Listbox.Items.Add(title + " : " + Str(timeperparse.ElapsedMilliseconds - oldtime))
    '     oldtime = timeperparse.ElapsedMilliseconds
    '  End Sub

    Private Sub DeleteFlorecomMenuStrip_Click(sender As System.Object, e As System.EventArgs) Handles DeleteFlorecomMenuStrip.Click
        'find selected row
        Dim rowsel As Integer = 0
        For i = 1 To FC_Flexgrid_orderlijst.Rows.Count - 1
            If FC_Flexgrid_orderlijst.Rows(i).Selected = True Then
                rowsel = i
                Exit For
            End If
        Next i

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim order_id As Integer = Val(FC_Flexgrid_orderlijst.Item(rowsel, 0))
                Dim antwoord As MsgBoxResult = MsgBox("Deze florecom wissen (alleen bij lege florecoms!)", vbYesNo)
                If antwoord = MsgBoxResult.Yes Then
                    Dim Cmd2 As New OdbcCommand("UPDATE edi2_orders SET status=1 WHERE id=?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", order_id)
                    Cmd2.ExecuteNonQuery()
                    LaadNieuweFlorecoms()
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom orderlijst)" + ex.Message)
            MessageBox.Show("Database fout: (florecom orderlijst)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Sub FC_Flexgrid_orderlijst_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FC_Flexgrid_orderlijst.Click
        If FC_Flexgrid_orderlijst.Rows.Count > 1 Then

            FcMenu_Verwerk_but.Enabled = False
            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'find selected row
                    Dim rowsel As Integer = 0
                    For i = 1 To FC_Flexgrid_orderlijst.Rows.Count - 1
                        If FC_Flexgrid_orderlijst.Rows(i).Selected = True Then
                            rowsel = i
                            Exit For
                        End If
                    Next i

                    FC_Flexgrid_contactdata.Rows.Count = 1
                    Fc_Flexgrid_LineData.Rows.Count = 1
                    FC_Flexgrid_orderlines.Rows.Count = 1

                    Dim order_id As Integer = Val(FC_Flexgrid_orderlijst.Item(rowsel, 0))

                    Dim Reader As OdbcDataReader
                    If order_id > 0 Then
                        'save global for later use 
                        FC_CurrentEditOrder = order_id

                        Me.Cursor = Cursors.WaitCursor

                        FormProgressBar.StartPosition = FormStartPosition.CenterScreen
                        FormProgressBar.Show()
                        FormProgressBar.DataProgressBar.Value = 5


                        Dim CmdString = "SELECT * FROM edi2_lines where ordernr = " + Str(order_id) + " order by potmaat, lin_product_code"
                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                        Reader = Cmd.ExecuteReader()
                        Dim koper_ean As String = ""
                        Dim afleverplaats As String = ""
                        Dim decorum As Integer = 0
                        Dim data As String
                        Dim status As Integer = 0
                        Dim boektijd As Date = Now
                        If Reader.HasRows Then
                            Reader.Read()
                            Dim line_id As Integer = CHint(Reader("id"))
                            Dim dtm_delivery_date As Date = CType(Reader("DTM_Delivery_date"), Date)
                            Dim dtm_recieve_date As Date = CType(Reader("Recieve_date"), Date)
                            Dim dtm_send_date As Date = CType(Reader("send_date"), Date)
                            boektijd = CType(Reader("boektijd"), Date)
                            status = CHint(Reader("status"))

                            'is deze order westland of niet?
                            Dim testlocatie = New NAD
                            testlocatie = ReadNAD(line_id, "DP")
                            Dim plaats As String = ReadSQLString("locatielijst", "GLN_Location_code", testlocatie.NAD_PartyEAN, "city_name")
                            afleverplaats = plaats
                            If Mid(plaats, 1, 4) = "fout" Then
                                plaats = ReadSQLString("locatielijst", "GLN_company_address_code", testlocatie.NAD_PartyEAN, "city_name")
                            End If
                            Dim westland As Boolean = False
                            If Mid(plaats, 1, 4) = "fout" Then
                                westland = False
                            Else
                                If plaats.ToUpper = "HONSELERSDIJK" Then
                                    westland = True
                                Else
                                    westland = False
                                End If
                            End If

                            FormProgressBar.DataProgressBar.Value = 15
                            ' leverdatum bepalen 
                            If status = 0 Then
                                'tijd 00:00 afvangen
                                Dim zerohour As String = Format(dtm_delivery_date, "HH:mm")
                                If zerohour = "00:00" Then
                                    If Val(Format(Now, "HH")) < 12 Then
                                        dtm_delivery_date = DateAdd(DateInterval.Hour, 12, dtm_delivery_date)
                                    Else
                                        dtm_delivery_date = DateAdd(DateInterval.Hour, 17, dtm_delivery_date)
                                    End If
                                End If
                                'leverdatum bepalen
                                If Now > dtm_delivery_date Then
                                    addcontact("Aflevertijd", "AFLEVERTIJD", Format(dtm_delivery_date, "dddd dd-MM-yy HH:mm"), "#FF4444")
                                    MsgBox("Let op, deze order is al te laat!", vbOKOnly)
                                ElseIf DateAdd("h", 1, Now) > dtm_delivery_date Then
                                    addcontact("Aflevertijd", "AFLEVERTIJD", Format(dtm_delivery_date, "dddd dd-MM-yy HH:mm"), "#FF9999")
                                    MsgBox("Let op, deze order is zowat te laat!", vbOKOnly)
                                Else
                                    addcontact("Aflevertijd", "AFLEVERTIJD", Format(dtm_delivery_date, "dddd dd-MM-yy HH:mm"), "#FFFFFF")
                                End If
                            Else
                                addcontact("Aflevertijd", "AFLEVERTIJD", Format(dtm_delivery_date, "dddd dd-MM-yy HH:mm"), "#FFFFFF")
                            End If

                            FormProgressBar.DataProgressBar.Value = 25
                            'boektijd
                            If Year(boektijd) < 2000 Then
                                boektijd = BerekenBoektijd(dtm_delivery_date, westland)
                                addcontact("Boektijd", "boektijd", Format(boektijd, "dddd dd-MM-yy HH:mm"), "#CCCCFF")
                            Else
                                addcontact("Boektijd", "boektijd", Format(boektijd, "dddd dd-MM-yy HH:mm"), "#CCCCFF")
                            End If

                            addcontact("Ontvangsttijd", "", Format(dtm_recieve_date, "dddd dd-MM-yy HH:mm"), "#FFFFFF")
                            If Year(dtm_send_date) > 2000 Then
                                addcontact("Verzendtijd", "", Format(dtm_send_date, "dddd dd-MM-yy HH:mm"), "#FFFFFF")
                            End If

                            'opmerking
                            addcontact("", "", "", "#FFFFFF")
                            Dim opmerking As String = ReadSQLString("edi2_orders", "id", order_id, "BoekOpmerking")
                            addcontact("Algemene opmerking", "opmerking", "", "#CCCCFF")

                            addcontact("", "", "", "#FFFFFF")

                            FormProgressBar.DataProgressBar.Value = 35
                            'koper
                            Dim buyer = New NAD
                            buyer = ReadNAD(line_id, "BY")
                            koper_ean = buyer.NAD_PartyEAN
                            addcontact("Koper EAN", "", koper_ean, "#FFFFFF")
                            Dim kopernaam As String = ReadSQLString("klantenlijst", "GLN_Company_address_code", buyer.NAD_PartyEAN, "company_name")
                            If Mid(kopernaam, 1, 4) = "fout" Then
                                addcontact("Koper", "", "Onbekende koper", "#FFFFFF")
                            Else
                                addcontact("Koper", "", kopernaam, "#FFFFFF")
                            End If
                            If buyer.CTA1_NAME <> "" Then addcontact("Naam", "", buyer.CTA1_NAME, "#FFFFFF")
                            If buyer.COM1_TE <> "" Then addcontact("Telefoon", "", buyer.COM1_TE, "#FFFFFF")
                            If buyer.COM1_FX <> "" Then addcontact("Fax", "", buyer.COM1_FX, "#FFFFFF")
                            If buyer.CTA2_NAME <> "" Then addcontact("Naam", "", buyer.CTA2_NAME, "#FFFFFF")
                            If buyer.COM2_TE <> "" Then addcontact("Telefoon", "", buyer.COM2_TE, "#FFFFFF")
                            If buyer.COM2_FX <> "" Then addcontact("Fax", "", buyer.COM2_FX, "#FFFFFF")
                            '
                            'Decorum 
                            decorum = IsDecorum(koper_ean)

                            data = ReadSQLString("klanten", "ean", buyer.NAD_PartyEAN, "decorum")

                            If Mid(data, 1, 4) = "fout" Then
                                MsgBox("Deze klant komt nog niet voor in het klantbestand, voeg eerst de klant toe")
                                FormProgressBar.Close()
                                Me.Cursor = Cursors.Default
                                Exit Sub
                            End If


                            If decorum > 0 Then
                                addcontact("Decorum", "", "Ja", "#FFFFFF")
                            Else
                                addcontact("Decorum", "", "Nee", "#FFFFFF")
                            End If
                            '
                            addcontact("", "", "", "#FFFFFF")
                            '
                            FormProgressBar.DataProgressBar.Value = 45
                            ' lever locatie
                            Dim location = New NAD
                            location = ReadNAD(line_id, "DP")
                            Dim afleverlocatie As String = ReadSQLString("locatielijst", "GLN_Location_code", location.NAD_PartyEAN, "location_name")
                            If Mid(afleverlocatie, 1, 4) = "fout" Then
                                addcontact("Afleverlocatie", "", "", "#FFFFFF")
                                Dim afleverlocatiedesc As String = ReadSQLString("locatielijst", "GLN_company_address_code", location.NAD_PartyEAN, "location_description")
                                addcontact("Locatie", "", afleverlocatiedesc, "#FFFFFF")
                                Dim afleverlocatienaam As String = ReadSQLString("locatielijst", "GLN_company_address_code", location.NAD_PartyEAN, "location_name")
                                addcontact("Locatie naam", "", afleverlocatienaam, "#FFFFFF")
                                Dim adres As String = ReadSQLString("locatielijst", "GLN_company_address_code", location.NAD_PartyEAN, "street_name")
                                adres = adres + " " + ReadSQLString("locatielijst", "GLN_company_address_code", location.NAD_PartyEAN, "street_number")
                                addcontact("Locatie adres", "", adres, "#FFFFFF")
                                Dim lplaats As String = ReadSQLString("locatielijst", "GLN_company_address_code", location.NAD_PartyEAN, "city_name")
                                addcontact("Loactie plaats", "", lplaats, "#FFFFFF")
                            ElseIf afleverlocatie = "AF TUIN" Then  'afleverlocatie  'THUIS Afhalen'  

                                addcontact("Afleverlocatie", "", "WORDT OPGEHAALD (AF TUIN)", "#FF0000")

                            Else
                                addcontact("Afleverlocatie", "", "", "#FFFFFF")
                                Dim afleverlocatiedesc As String = ReadSQLString("locatielijst", "GLN_Location_code", location.NAD_PartyEAN, "location_description")
                                addcontact("Locatie", "", afleverlocatiedesc, "#FFFFFF")
                                Dim afleverlocatienaam As String = ReadSQLString("locatielijst", "GLN_Location_code", location.NAD_PartyEAN, "location_name")
                                addcontact("Locatie naam", "", afleverlocatienaam, "#FFFFFF")
                                Dim adres As String = ReadSQLString("locatielijst", "GLN_Location_code", location.NAD_PartyEAN, "street_name")
                                adres = adres + " " + ReadSQLString("locatielijst", "GLN_Location_code", location.NAD_PartyEAN, "street_number")
                                addcontact("Locatie adres", "", adres, "#FFFFFF")
                                Dim lplaats As String = ReadSQLString("locatielijst", "GLN_Location_code", location.NAD_PartyEAN, "city_name")
                                addcontact("Locatie plaats", "", lplaats, "#FFFFFF")

                                If location.CTA1_NAME <> "" Then addcontact("Naam", "", location.CTA1_NAME, "#FFFFFF")
                                If location.COM1_TE <> "" Then addcontact("Telefoon", "", location.COM1_TE, "#FFFFFF")
                                If location.COM1_FX <> "" Then addcontact("Fax", "", location.COM1_FX, "#FFFFFF")
                                If location.CTA2_NAME <> "" Then addcontact("Naam", "", location.CTA2_NAME, "#FFFFFF")
                                If location.COM2_TE <> "" Then addcontact("Telefoon", "", location.COM2_TE, "#FFFFFF")
                                If location.COM2_FX <> "" Then addcontact("Fax", "", location.COM2_FX, "#FFFFFF")

                            End If
                            '
                            addcontact("", "", "", "#FFFFFF")
                            '
                            FormProgressBar.DataProgressBar.Value = 55
                            ' overslaglocatie
                            Dim olocation = New NAD
                            olocation = ReadNAD(line_id, "HC")
                            If olocation.NAD_PartyEAN <> "0000000000000" Then
                                Dim oafleverlocatie As String = ReadSQLString("locatielijst", "GLN_Location_code", olocation.NAD_PartyEAN, "location_name")
                                addcontact("Overslaglocatie", "", "", "#FFFFFF")
                                Dim oafleverlocatiedesc As String = ReadSQLString("locatielijst", "GLN_Location_code", olocation.NAD_PartyEAN, "location_description")
                                addcontact("Locatie", "", oafleverlocatiedesc, "#FFFFFF")
                                Dim oafleverlocatienaam As String = ReadSQLString("locatielijst", "GLN_Location_code", olocation.NAD_PartyEAN, "location_name")
                                addcontact("Locatie naam", "", oafleverlocatienaam, "#FFFFFF")
                                Dim oadres As String = ReadSQLString("locatielijst", "GLN_Location_code", olocation.NAD_PartyEAN, "street_name")
                                oadres = oadres + " " + ReadSQLString("locatielijst", "GLN_Location_code", olocation.NAD_PartyEAN, "street_number")
                                addcontact("Locatie adres", "", oadres, "#FFFFFF")
                                Dim olplaats As String = ReadSQLString("locatielijst", "GLN_Location_code", olocation.NAD_PartyEAN, "city_name")
                                addcontact("Locatie plaats", "", olplaats, "#FFFFFF")
                                '
                                addcontact("", "", "", "#FFFFFF")
                            End If

                            FormProgressBar.DataProgressBar.Value = 65
                            ' verkoper
                            Dim seller = New NAD
                            seller = ReadNAD(line_id, "SE")
                            Dim sellernaam As String = ReadSQLString("klantenlijst", "GLN_Company_address_code", seller.NAD_PartyEAN, "company_name")
                            If Mid(kopernaam, 1, 4) = "fout" Then
                                addcontact("Kweker", "", "Onbekende verkoper", "#FFFFFF")
                            Else
                                addcontact("Kweker", "", sellernaam, "#FFFFFF")
                            End If
                            If seller.CTA1_NAME <> "" Then addcontact("Naam", "", seller.CTA1_NAME, "#FFFFFF")
                            If seller.COM1_TE <> "" Then addcontact("Telefoon", "", seller.COM1_TE, "#FFFFFF")
                            If seller.COM1_FX <> "" Then addcontact("Fax", "", seller.COM1_FX, "#FFFFFF")
                            If seller.CTA2_NAME <> "" Then addcontact("Naam", "", seller.CTA2_NAME, "#FFFFFF")
                            If seller.COM2_TE <> "" Then addcontact("Telefoon", "", seller.COM2_TE, "#FFFFFF")
                            If seller.COM2_FX <> "" Then addcontact("Fax", "", seller.COM2_FX, "#FFFFFF")
                            '
                            addcontact("", "", "", "#FFFFFF")

                            FormProgressBar.DataProgressBar.Value = 75
                            ' SalesRepresentative
                            Dim SalesAgent = New NAD
                            SalesAgent = ReadNAD(line_id, "SR")
                            If SalesAgent.NAD_PartyEAN <> "0000000000000" Then
                                Dim SalesAgentnaam As String = ReadSQLString("klantenlijst", "GLN_Company_address_code", SalesAgent.NAD_PartyEAN, "company_name")
                                If Mid(kopernaam, 1, 4) = "fout" Then
                                    addcontact("Verkoper", "", "Onbekende verkoper", "#FFFFFF")
                                Else
                                    addcontact("Verkoper", "", SalesAgentnaam, "#FFFFFF")
                                End If
                                If SalesAgent.CTA1_NAME <> "" Then addcontact("Naam", "", SalesAgent.CTA1_NAME, "#FFFFFF")
                                If SalesAgent.COM1_TE <> "" Then addcontact("Telefoon", "", SalesAgent.COM1_TE, "#FFFFFF")
                                If SalesAgent.COM1_FX <> "" Then addcontact("Fax", "", SalesAgent.COM1_FX, "#FFFFFF")
                                If SalesAgent.CTA2_NAME <> "" Then addcontact("Naam", "", SalesAgent.CTA2_NAME, "#FFFFFF")
                                If SalesAgent.COM2_TE <> "" Then addcontact("Telefoon", "", SalesAgent.COM2_TE, "#FFFFFF")
                                If SalesAgent.COM2_FX <> "" Then addcontact("Fax", "", SalesAgent.COM2_FX, "#FFFFFF")
                                '
                                addcontact("", "", "", "#FFFFFF")
                            End If
                            '
                            '
                            FormProgressBar.DataProgressBar.Value = 80
                            ' Inspectie
                            Dim Inspector = New NAD
                            Inspector = ReadNAD(line_id, "FO")
                            If Inspector.NAD_PartyEAN <> "0000000000000" Then
                                Dim Inspectornaam As String = ReadSQLString("klantenlijst", "GLN_Company_address_code", Inspector.NAD_PartyEAN, "company_name")
                                If Mid(kopernaam, 1, 4) = "fout" Then
                                    addcontact("Verkoper", "", "Onbekende verkoper", "#FFFFFF")
                                Else
                                    addcontact("Verkoper", "", Inspectornaam, "#FFFFFF")
                                End If
                                If Inspector.CTA1_NAME <> "" Then addcontact("Naam", "", Inspector.CTA1_NAME, "#FFFFFF")
                                If Inspector.COM1_TE <> "" Then addcontact("Telefoon", "", Inspector.COM1_TE, "#FFFFFF")
                                If Inspector.COM1_FX <> "" Then addcontact("Fax", "", Inspector.COM1_FX, "#FFFFFF")
                                If Inspector.CTA2_NAME <> "" Then addcontact("Naam", "", Inspector.CTA2_NAME, "#FFFFFF")
                                If Inspector.COM2_TE <> "" Then addcontact("Telefoon", "", Inspector.COM2_TE, "#FFFFFF")
                                If Inspector.COM2_FX <> "" Then addcontact("Fax", "", Inspector.COM2_FX, "#FFFFFF")
                                '
                                addcontact("", "", "", "#FFFFFF")
                            End If


                            ' !!!!!!!!! UPDATE AGENDA
                            user_date_change = False
                            Order_MonthCalendar.SelectionStart = boektijd
                            Order_MonthCalendar.SelectionEnd = boektijd
                            user_date_change = True
                            BoekStatus = 8
                            Update_Boek(1, koper_ean)

                        End If

                        addcontact("Florecom ordernr", "", Str(order_id), "#FFFFFF")

                        Reader.Close()

                        If status = 0 Then
                            ' save koperean & plaats & decorum
                            Dim CmdString2 As String = "SELECT * FROM edi2_lines where 1=0"
                            Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                            Cmd2.CommandText = "UPDATE edi2_lines SET NAD_BY_EAN=?,NAD_DP_City_Name=?,Decorum=?,boektijd=?  where ordernr = " + Str(order_id)
                            Cmd2.Parameters.Clear()
                            Cmd2.Parameters.AddWithValue("", koper_ean)
                            Cmd2.Parameters.AddWithValue("", afleverplaats)
                            Cmd2.Parameters.AddWithValue("", decorum)
                            Cmd2.Parameters.AddWithValue("", boektijd)
                            Cmd2.ExecuteNonQuery()
                        End If

                        FormProgressBar.DataProgressBar.Value = 85



                        ' ************** Read orderlines *************

                        SetOrderLines(order_id)


                        If FC_Flexgrid_orderlines.Rows.Count > 1 Then
                            Dim line_id = FC_Flexgrid_orderlines.Item(1, 0)
                            FC_CurrentEditLine = line_id
                            ShowLineData(line_id)
                        End If


                        FormProgressBar.DataProgressBar.Value = 95
                        FormProgressBar.Close()
                        Me.Cursor = Cursors.Default

                    End If
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (florecom orderlijst)" + ex.Message)
                MessageBox.Show("Database fout: (florecom orderlijst)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
            FcMenu_Verwerk_but.Enabled = True
        End If
    End Sub
    Private Sub FC_Flexgrid_contactdata_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FC_Flexgrid_contactdata.Click
        If FC_Flexgrid_contactdata.Rows.Count > 1 Then
            If FC_Flexgrid_contactdata.Col = 2 And FC_Flexgrid_contactdata.Item(FC_Flexgrid_contactdata.Row, 0) <> "" Then

                '***************************************************
                ' COMBO invullen als er op geclicked wordt
                ' Create the custom editor.
                '***************************************************
                Dim style As C1.Win.C1FlexGrid.CellStyle = FC_Flexgrid_contactdata.Styles.Add("newGridStyle")

                ' Dim mycombo = New C1.Win.C1List.C1Combo()
                'Me.Controls.Add(mycombo)
                'mycombo.Visible = False
                'mycombo.DataMode = C1.Win.C1List.DataModeEnum.Normal
                Dim cn() As String = New String() {"Naam", "Code"}

                Fc_ContactCombo.DataMode = C1.Win.C1List.DataModeEnum.Normal

                Dim dt_fc As New DataTable
                dt_fc.Columns.Add("Naam", GetType(String))
                dt_fc.Columns.Add("Code", GetType(Date))
                dt_fc.Clear()

                Dim dt_fc2 As New DataTable
                dt_fc2.Columns.Add("Naam", GetType(String))
                dt_fc2.Columns.Add("Code", GetType(String))
                dt_fc2.Clear()


                '*********** LIJST GENEREREN **************************
                Dim linecode As String = FC_Flexgrid_contactdata.Item(FC_Flexgrid_contactdata.Row, 0)

                Select Case linecode
                    Case "boektijd"
                        Dim berekende_datetime As DateTime = FC_Flexgrid_contactdata.Item(FC_Flexgrid_contactdata.Row, 2)

                        For Day = -3 To 3
                            Dim daydate As Date = DateAdd("d", Day, berekende_datetime)
                            Dim Daynr As Integer = daydate.DayOfWeek
                            'If Daynr = 0 Or Daynr = 6 Then
                            'weekend..skip 
                            'Else
                            Dim newdatum As Date
                            Dim datum_str As String = DateAdd("d", Day, berekende_datetime).ToShortDateString
                            newdatum = Date.Parse(datum_str + " 9:00")
                            dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})

                            If jenptenhave = True Then
                                newdatum = Date.Parse(datum_str + " 11:00")
                                dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})
                            End If

                            newdatum = Date.Parse(datum_str + " 12:00")
                            dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})

                            If jenptenhave = True Then
                                newdatum = Date.Parse(datum_str + " 15:00")
                                dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})
                            End If

                            If newdatum.DayOfWeek = 5 And jenptenhave = False Then 'vrijdag
                                newdatum = Date.Parse(datum_str + " 18:00")
                                dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy ZA"), newdatum})
                            Else
                                newdatum = Date.Parse(datum_str + " 17:00")
                                dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})
                            End If
                            Fc_ContactCombo.DataSource = dt_fc
                            Fc_ContactCombo.DisplayMember = "Naam"
                            Fc_ContactCombo.ValueMember = "Code"
                            Fc_ContactCombo.ComboStyle = 2  'list style combo

                            'End If
                        Next
                    Case "opmerking"
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Reader As OdbcDataReader
                                Dim CmdString = "SELECT * FROM opmerkingen where type = '1'"
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                Reader = Cmd.ExecuteReader()
                                Do While Reader.Read
                                    Dim opmerking As String = CHstr(Reader("opmerking"))
                                    dt_fc2.Rows.Add(New String() {opmerking, opmerking})
                                Loop
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (florecom contact data)" + ex.Message)
                            MessageBox.Show("Database fout: (florecom contact data)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try
                        Fc_ContactCombo.DataSource = dt_fc2
                        Fc_ContactCombo.DisplayMember = "Naam"
                        Fc_ContactCombo.ValueMember = "Code"
                        Fc_ContactCombo.ComboStyle = 0  'combo style combo
                    Case "AFLEVERTIJD"
                        Dim berekende_datetime As DateTime = FC_Flexgrid_contactdata.Item(FC_Flexgrid_contactdata.Row, 2)
                        dt_fc.Rows.Add(New String() {Format(berekende_datetime, "dddd dd-MM-yy HH:mm"), berekende_datetime})
                        For Day = 0 To 5
                            Dim daydate As Date = DateAdd("d", Day, berekende_datetime)
                            Dim Daynr As Integer = daydate.DayOfWeek
                            If Daynr = 0 Or Daynr = 6 Then
                                'weekend..skip 
                            Else
                                Dim newdatum As Date
                                Dim datum_str As String = DateAdd("d", Day, berekende_datetime).ToShortDateString
                                newdatum = Date.Parse(datum_str + " 9:00")
                                dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})
                                newdatum = Date.Parse(datum_str + " 12:00")
                                dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})
                                newdatum = Date.Parse(datum_str + " 15:00")
                                dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})
                                newdatum = Date.Parse(datum_str + " 17:00")
                                dt_fc.Rows.Add(New String() {Format(newdatum, "dddd dd-MM-yy HH:mm"), newdatum})
                                Fc_ContactCombo.DataSource = dt_fc
                                Fc_ContactCombo.DisplayMember = "Naam"
                                Fc_ContactCombo.ValueMember = "Code"
                                Fc_ContactCombo.ComboStyle = 2  'list style combo

                            End If
                        Next
                End Select

                Fc_ContactCombo.DropDownWidth = 400
                Fc_ContactCombo.ColumnWidth = 390
                Fc_ContactCombo.MaxDropDownItems = 15

                style.Editor = Fc_ContactCombo
                FC_Flexgrid_contactdata.SetCellStyle(FC_Flexgrid_contactdata.Row, 2, style)
                FC_Flexgrid_contactdata.StartEditing(FC_Flexgrid_contactdata.Row, 2)
                Fc_ContactCombo.DroppedDown = True
            End If
        End If
    End Sub
    Private Sub Fc_ContactCombo_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles Fc_ContactCombo.Validated

        If FC_CurrentEditOrder > 0 Then
            Dim linecode As String = FC_Flexgrid_contactdata.Item(FC_Flexgrid_contactdata.Row, 0)

            Select Case linecode
                Case "boektijd"
                    Try
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()
                            Dim boektijd As Date = Fc_ContactCombo.SelectedValue
                           
                            Dim CmdString = "SELECT id FROM edi2_lines where 1=0"
                            Dim Cmd As New OdbcCommand(CmdString, Conn)
                            Cmd.CommandText = "UPDATE edi2_lines SET boektijd ='" + Format(boektijd, "yyyy-MM-dd HH:mm") + "' WHERE ordernr = " + Str(FC_CurrentEditOrder)
                            Cmd.ExecuteNonQuery()

                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: (florecom save contactdata)" + ex.Message)
                        MessageBox.Show("Database fout: (florecom save contactdata)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try


                Case "opmerking"

                    Try
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()
                            Dim boekopmerking As String = Fc_ContactCombo.SelectedValue
                            Dim CmdString = "SELECT id FROM edi2_orders where 1=0"
                            Dim Cmd As New OdbcCommand(CmdString, Conn)
                            Cmd.CommandText = "UPDATE edi2_orders SET boekopmerking ='" + boekopmerking + "' WHERE id = " + Str(FC_CurrentEditOrder)
                            Cmd.ExecuteNonQuery()
                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: (florecom save contactdata)" + ex.Message)
                        MessageBox.Show("Database fout: (florecom save contactdata)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try

                Case "AFLEVERTIJD"
                    Try
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()
                            Dim aflevertijd As Date = Fc_ContactCombo.SelectedValue

                            'Dim dtm_delivery_date As Date = Reader("DTM_Delivery_date")
                            Dim CmdString = "SELECT id FROM edi2_lines where 1=0"
                            Dim Cmd As New OdbcCommand(CmdString, Conn)
                            Cmd.CommandText = "UPDATE edi2_lines SET DTM_Delivery_date ='" + Format(aflevertijd, "yyyy-MM-dd HH:mm") + "' WHERE ordernr = " + Str(FC_CurrentEditOrder)
                            Cmd.ExecuteNonQuery()
                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: (florecom save contactdata)" + ex.Message)
                        MessageBox.Show("Database fout: (florecom save contactdata)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try



            End Select
        End If

    End Sub
    Private Function IsDecorum(ByVal ean) As Integer
        Dim decorum As Integer = 0

        For k = 1 To UBound(kopersgroepen)
            If kopersgroepen(k).groepnaam = "Decorum" Then
                For i = 1 To UBound(kopergroepEANs)
                    If kopergroepEANs(i).id = kopersgroepen(k).id Then
                        If kopergroepEANs(i).ean = ean Then
                            Return 1 'deco found
                        End If
                    End If
                Next
            End If
        Next

        Return 0
    End Function

    Private Function AltijdDecorum(ByVal ean) As Integer
        Dim decorum As Integer = 0

        For k = 1 To UBound(kopersgroepen)
            If kopersgroepen(k).groepnaam = "FC_AltijdDecorum" Then
                For i = 1 To UBound(kopergroepEANs)
                    If kopergroepEANs(i).id = kopersgroepen(k).id Then
                        If kopergroepEANs(i).ean = ean Then
                            Return 1 'deco found
                        End If
                    End If
                Next
            End If
        Next

        Return 0
    End Function
    Private Function KiesNieuwePorto(ByVal ean) As Integer
        Dim decorum As Integer = 0

        For k = 1 To UBound(kopersgroepen)
            If kopersgroepen(k).groepnaam = "Nieuwe Porto" Then
                For i = 1 To UBound(kopergroepEANs)
                    If kopergroepEANs(i).id = kopersgroepen(k).id Then
                        If kopergroepEANs(i).ean = ean Then
                            Return 1 'deco found
                        End If
                    End If
                Next
            End If
        Next

        Return 0
    End Function
    Private Function DecorumWelFustGeenPotcover(ByVal ean) As Integer
        Dim decorum As Integer = 0

        For k = 1 To UBound(kopersgroepen)
            If kopersgroepen(k).groepnaam = "FC_Decofust_geenPotcover" Then
                For i = 1 To UBound(kopergroepEANs)
                    If kopergroepEANs(i).id = kopersgroepen(k).id Then
                        If kopergroepEANs(i).ean = ean Then
                            Return 1 'deco found
                        End If
                    End If
                Next
            End If
        Next

        Return 0
    End Function


    Private Sub ZoekPrijsFCJenP(ByVal SoortId, ByVal koper_ean, ByVal LIN_Responce, ByVal kwekerscode, ByRef jpsoort, ByRef jpaccessoire1, ByRef jpaccessoire2, ByRef jpfust, ByRef jphoes, ByRef jpprijs, ByRef jpkorting)

        Dim prijs_only As Boolean = False
        If kwekerscode <> "" Then
            Dim findid As Integer = 0
            For i = 1 To UBound(prijslijst)

                If LIN_Responce = "999" Then   'FLORAMONDO
                    If kwekerscode = prijslijst(i).kwekerscode And prijslijst(i).omschrijving = "MONDO" Then
                        findid = i
                    End If
                Else
                    If kwekerscode = prijslijst(i).kwekerscode Then
                        findid = i
                    End If
                End If

                If findid > 0 Then
                    jpsoort = prijslijst(findid).soort
                    jpaccessoire1 = prijslijst(findid).accessoire1
                    jpaccessoire2 = prijslijst(findid).accessoire2
                    jpfust = prijslijst(findid).fust
                    jphoes = prijslijst(findid).hoes
                    jpprijs = prijslijst(findid).prijs

                    If jpprijs = 0 Then
                        prijs_only = True
                        GoTo search_on
                    End If

                    If prijslijst(findid).korting <> 0 Then
                        For j = 1 To UBound(kortingsgroepen)
                            Dim kopersgroepid As Integer = kortingsgroepen(j).kopergroep
                            For k = 1 To UBound(kopergroepEANs)
                                If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                                    'korting found
                                    jpkorting = kortingsgroepen(j).korting
                                    Exit Sub
                                End If
                            Next
                        Next
                    End If
                    'geen korting
                    Exit Sub
                End If

            Next
        End If
search_on:
        'kwekerscode niet gevonden

        'zoeken in klantgroepen groter als decorum (1)
        For i = 1 To UBound(prijslijst)
            If prijslijst(i).kopersgroep > 1 And SoortId = prijslijst(i).soort Then
                Dim kopersgroepid As Integer = prijslijst(i).kopersgroep
                For k = 1 To UBound(kopergroepEANs)
                    If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                        'koper gevonden in kopersgroep 
                        Dim findid As Integer = i
                        If prijs_only = False Then
                            jpsoort = prijslijst(findid).soort
                            jpaccessoire1 = prijslijst(findid).accessoire1
                            jpaccessoire2 = prijslijst(findid).accessoire2
                            jpfust = prijslijst(findid).fust
                            jphoes = prijslijst(findid).hoes
                        End If
                        jpprijs = prijslijst(findid).prijs
                        If prijslijst(findid).korting <> 0 Then
                            For j = 1 To UBound(kortingsgroepen)
                                Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                                For m = 1 To UBound(kopergroepEANs)
                                    If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                        'korting found
                                        jpkorting = kortingsgroepen(j).korting
                                        Exit Sub
                                    End If
                                Next
                            Next
                        End If
                        Exit Sub
                    End If
                Next
            End If
        Next

        'zoeken in klantgroepen decorum (1)
        For i = 1 To UBound(prijslijst)
            If prijslijst(i).kopersgroep = 1 And SoortId = prijslijst(i).soort Then
                Dim kopersgroepid As Integer = 1
                For k = 1 To UBound(kopergroepEANs)
                    If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                        'koper gevonden in kopersgroep 
                        Dim findid As Integer = i
                        If prijs_only = False Then
                            jpsoort = prijslijst(findid).soort
                            jpaccessoire1 = prijslijst(findid).accessoire1
                            jpaccessoire2 = prijslijst(findid).accessoire2
                            jpfust = prijslijst(findid).fust
                            jphoes = prijslijst(findid).hoes
                        End If
                        jpprijs = prijslijst(findid).prijs
                        If prijslijst(findid).korting <> 0 Then
                            For j = 1 To UBound(kortingsgroepen)
                                Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                                For m = 1 To UBound(kopergroepEANs)
                                    If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                        'korting found
                                        jpkorting = kortingsgroepen(j).korting
                                        Exit Sub
                                    End If
                                Next
                            Next
                        End If
                        Exit Sub
                    End If
                Next
            End If
        Next

        'zoeken in totaal aanbod
        For i = 1 To UBound(prijslijst)
            If SoortId = prijslijst(i).soort Then
                'Dim kopersgroepid As Integer = 0
                'For k = 1 To UBound(kopergroepEANs)
                'If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                '(kopersgroep = 0)
                Dim findid As Integer = i
                If prijs_only = False Then
                    jpsoort = prijslijst(findid).soort
                    jpaccessoire1 = prijslijst(findid).accessoire1
                    jpaccessoire2 = prijslijst(findid).accessoire2
                    jpfust = prijslijst(findid).fust
                    jphoes = prijslijst(findid).hoes
                End If
                jpprijs = prijslijst(findid).prijs
                If prijslijst(findid).korting <> 0 Then
                    For j = 1 To UBound(kortingsgroepen)
                        Dim kopersgroepid2 As Integer = kortingsgroepen(j).kopergroep
                        For m = 1 To UBound(kopergroepEANs)
                            If kopergroepEANs(m).id = kopersgroepid2 And kopergroepEANs(m).ean = koper_ean Then
                                'korting found
                                jpkorting = kortingsgroepen(j).korting
                                Exit Sub
                            End If
                        Next
                    Next
                End If
                Exit Sub
                'End If
                'Next
            End If
        Next


    End Sub

    Public Function ShowLineData(ByVal line_id As Integer, Optional ByVal secondrun As Boolean = False) As Integer
        Dim warning As Boolean = False
        Dim double_warning As Boolean = False
        Dim geen_kwekercode As Boolean = False
        'save as global var
        'FC_CurrentEditLine = line_id

        Fc_Flexgrid_LineData.Rows.Count = 1
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()


                Dim Reader As OdbcDataReader
                Dim CmdString2 = "SELECT * FROM edi2_lines where id = " + Str(line_id)
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Reader = Cmd2.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    Dim ediline_id As Integer = CHint(Reader("id"))

                    Dim SoortId = CHint(Reader("Soort_id"))
                    If SoortId = 0 Then
                        warning = True
                        addline("Soort", "SOORT", "Onbekend soort", "CORAL")
                    Else
                        If SoortId < 10000 Then
                            addline("Soort", "SOORT", soorten(GID(soorten, SoortId)).soortnaam, "LAVENDER", Str(SoortId))
                        Else
                            addline("Soort", "SOORT", mixen(GID(mixen, SoortId - 10000)).naam, "LAVENDER", Str(0))
                        End If
                    End If
                    Dim accessoire1 As Integer = CHint(Reader("Accessoire1"))
                    Dim accessoire2 As Integer = CHint(Reader("Accessoire2"))
                    Dim decorumfl As Integer = CHint(Reader("Decorum"))
                    Dim wps_filternr As Integer = CHint(Reader("wps_filternr"))
                    Dim label_nummer As Integer = CHint(Reader("label_nummer"))
                    Dim hoes As Integer = CHint(Reader("hoes"))
                    Dim koper_ean As String = CHstr(Reader("NAD_BY_EAN"))
                    Dim kwekerscode As String = CHstr(Reader("PIA_SA_EAN"))
                    Dim actienummer As String = "" ' actiecode prijslijst
                    If Len(kwekerscode) = 12 Then
                        If (Asc(Mid(kwekerscode, 1, 1)) >= Asc("A") And Asc(Mid(kwekerscode, 1, 1)) <= Asc("Z")) And Mid(kwekerscode, 5, 1) = "-" Then
                            actienummer = Mid(kwekerscode, 10, 3)
                        End If
                    End If
                    Dim Lin_reponce As Integer = CHint(Reader("LIN_Responce"))
                    'prijzen
                    Dim dumkleur As Integer
                    Dim actie_type As Integer = 0
                    Dim boekprijs As Double = 0.0

                    'j en p lijst
                    Dim jpsoort As Integer = 0
                    Dim jpaccessoire1 As Integer = 0
                    Dim jpaccessoire2 As Integer = 0
                    Dim jpfust As Integer = 0
                    Dim jphoes As Integer = 0
                    Dim jpprijs As Integer = 0
                    Dim jpkorting As Integer = 0
                    If jenptenhave = True Then
                        boekprijs = ZoekPrijs(SoortId, koper_ean, Reader("boektijd"), dumkleur, actie_type, True, actienummer)
                        If boekprijs = 0 Then
                            ZoekPrijsFCJenP(SoortId, koper_ean, Lin_reponce, kwekerscode, jpsoort, jpaccessoire1, jpaccessoire2, jpfust, jphoes, jpprijs, jpkorting)
                            boekprijs = jpprijs / 100
                        End If
                    Else
                        boekprijs = ZoekPrijs(SoortId, koper_ean, Reader("boektijd"), dumkleur, actie_type, True, actienummer)
                    End If

                    Dim rijpheidaccessoire As Integer = 0
                    If secondrun = False Then

                        If jenptenhave = False And (koper_ean = "8714231188759" Or koper_ean = "8714231185123") Then  'rijpheden special voor waterdrinker klant 10/OZ

                            If accessoire1 = 1 Or accessoire1 = 2 Or accessoire1 = 88 Or accessoire1 = 0 Then   'alleen bij default regel
                                If accessoire2 = 1 Or accessoire2 = 2 Or accessoire2 = 88 Or accessoire2 = 0 Then

                                    Dim CCICAVString2 As String = CHstr(Reader("CCICAV"))
                                    Dim CCICAV2() As String = Microsoft.VisualBasic.Strings.Split(CCICAVString2, "*")
                                    For i = 0 To UBound(CCICAV2) - 1
                                        Dim cci = Mid(CCICAV2(i), 1, 3)
                                        Dim cav = Mid(CCICAV2(i), 5, 3)

                                        If cci = "S05" Then

                                            Dim rijpheid As Integer = Val(cav)
                                            rijpheidaccessoire = 68
                                            Select Case rijpheid

                                                Case 0 : rijpheidaccessoire = 69
                                                Case 1 : rijpheidaccessoire = 36
                                                Case 2 : rijpheidaccessoire = 68
                                                Case 3 : rijpheidaccessoire = 76
                                                Case 4 : rijpheidaccessoire = 34

                                                Case 11 : rijpheidaccessoire = 36
                                                Case 22 : rijpheidaccessoire = 68
                                                Case 33 : rijpheidaccessoire = 76
                                                Case 44 : rijpheidaccessoire = 34

                                                Case 12 : rijpheidaccessoire = 68
                                                Case 23 : rijpheidaccessoire = 76
                                                Case 34 : rijpheidaccessoire = 34
                                            End Select
                                            Dim CmdString21 = "UPDATE edi2_lines SET Accessoire1 = ?, Accessoire2 = 2 WHERE id = " + Str(line_id)  'save line status
                                            Dim Cmd21 As New OdbcCommand(CmdString21, Conn)
                                            Cmd21.Parameters.Clear()
                                            Cmd21.Parameters.AddWithValue("", rijpheidaccessoire)
                                            accessoire1 = rijpheidaccessoire
                                            accessoire2 = 2
                                            Cmd21.ExecuteNonQuery()
                                        End If
                                    Next
                                End If
                            End If
                        End If
                        If accessoire1 = 0 And jpaccessoire1 > 0 Then
                            accessoire1 = jpaccessoire1

                            Dim CmdString21 = "UPDATE edi2_lines SET Accessoire1 = ? WHERE id = " + Str(line_id)  'save line status
                            Dim Cmd21 As New OdbcCommand(CmdString21, Conn)
                            Cmd21.Parameters.Clear()
                            Cmd21.Parameters.AddWithValue("", accessoire1)
                            Cmd21.ExecuteNonQuery()

                        End If
                        If accessoire2 = 0 And jpaccessoire2 > 0 Then
                            accessoire2 = jpaccessoire2

                            Dim CmdString21 = "UPDATE edi2_lines SET Accessoire2 = ? WHERE id = " + Str(line_id)  'save line status
                            Dim Cmd21 As New OdbcCommand(CmdString21, Conn)
                            Cmd21.Parameters.Clear()
                            Cmd21.Parameters.AddWithValue("", accessoire2)
                            Cmd21.ExecuteNonQuery()

                        End If
                        If hoes = 0 And jphoes > 0 Then
                            hoes = jphoes
                        End If
                    End If

                    If accessoire1 > 0 Then
                        boekprijs = FindAccessoirePrijs(CHstr(Reader("NAD_BY_EAN")), boekprijs, accessoire1, SoortId, Reader("boektijd"), actie_type)
                    End If

                    addline("Accessoire 1", "ACCE1", accessoire(GID(accessoire, accessoire1)).naam, "LAVENDER", Str(accessoire1))
                    addline("Accessoire 2", "ACCE2", accessoire(GID(accessoire, accessoire2)).naam, "LAVENDER", Str(accessoire2))
                    If hoes = 0 Then
                        Dim accessoire3 As Integer = FindHoes(CHstr(Reader("NAD_BY_EAN")), SoortId)
                    End If
                    addline("Hoes", "ACCE3", accessoire(GID(accessoire, hoes)).naam, "LAVENDER", Str(hoes))
                    If wps_filternr = 0 Then
                        addline("Filter", "WPSFILTER", "-", "LAVENDER")
                    Else
                        Dim filternaam As String = "-"
                        For i = 0 To UBound(wpsfilter)
                            If wps_filternr = wpsfilter(i).filternummer Then
                                filternaam = wpsfilter(i).filternaam
                                Exit For
                            End If
                        Next i

                        addline("Filter", "WPSFILTER", filternaam, "LAVENDER")
                    End If
                    addline("Labelnummer", "LABELGEN", label_nummer, "LAVENDER")


                    addline("", "", "", "WHITE")
                    '
                    'edi soortomschrijving

                    Dim vbncode As String = CHstr(Reader("LIN_Product_Code"))
                    If vbncode = "" Then vbncode = "0"
                    Dim vbnstring = vbncode + " " + ReadSQLString("soortenlijst", "product_id", vbncode, "VBN_product_name")

                    Dim vbnfound As Boolean = False
                    For i = 1 To UBound(soorten)
                        If soorten(i).vbn_code = vbncode Then
                            vbnfound = True
                        End If
                    Next
                    For i = 1 To UBound(mixen)
                        If mixen(i).vbn_code = vbncode Then
                            vbnfound = True
                        End If
                    Next

                    If vbnfound = True Then
                        addline("VBN Code", "", vbnstring, "WHITE")
                    Else
                        addline("VBN Code", "", vbnstring, "LAVENDER")
                        warning = True
                    End If

                    addline("Soort Omschrijving", "", CHstr(Reader("IMD_Full_Name")), "WHITE")
                    addline("Artikelcode Danpot", "", CHstr(Reader("PIA_CC_EAN")), "WHITE")
                    addline("Artikelcode Winkel", "", CHstr(Reader("PIA_UA_EAN")), "WHITE")
                    addline("Artikelcode Koper", "", CHstr(Reader("PIA_IN_EAN")), "WHITE")

                    Dim artikelcode_kweker As String = CHstr(Reader("PIA_SA_EAN"))
                    If Trim(artikelcode_kweker) = "" Then
                        addline("Artikelcode Teler", "", "Geen artikel code", "CORAL")
                        geen_kwekercode = True
                    Else
                        addline("Artikelcode Teler", "", artikelcode_kweker, "WHITE")
                    End If
                    addline("", "", "", "WHITE")

                    If boekprijs = 0 Then
                        addline("Prijs aanbod", "PRIJSAANBOD", pformatprijs(boekprijs, 2), "RED")
                        double_warning = True
                    Else
                        addline("Prijs aanbod", "PRIJSAANBOD", pformatprijs(boekprijs, 2), "WHITE")
                    End If


                    Dim labelprijs As Double = Val(CHstr(Reader("PRI_AAE_Price_Amount")))           'label functie lemkes
                    Dim lemkes_prijsopslag As Double = 0
                    '                    If koper_ean = "8714231140016" Then
                    ' If labelprijs > 0 Then
                    ' lemkes_prijsopslag = GetLabelPrijs("8714231140016") / 100
                    ' addline("Prijs sticker", "", formatprijs(lemkes_prijsopslag, 2), "#FFFFFF")
                    '
                    '           Dim CmdString21 = "UPDATE edi2_lines SET label_status = 3 WHERE id = " + Str(line_id)  'save line status
                    '           Dim Cmd21 As New OdbcCommand(CmdString21, Conn)
                    '           Cmd21.ExecuteNonQuery()
                    ' End If
                    ' end If

                    Dim CCICAVStr As String = CHstr(Reader("CCICAV"))                              'label functie labelbericht 
                    Dim labelberichtopslag As Integer = 0
                    labelberichtopslag = TestLabelBerichtOpslag(koper_ean, CCICAVStr)
                    Dim lb_opslag As Double = 0
                    If labelberichtopslag >= 0 Then
                        lb_opslag = labelberichtopslag / 100
                        addline("Prijs sticker", "", pformatprijs(lb_opslag, 2), "WHITE")

                        Dim CmdString21 = "UPDATE edi2_lines SET label_status = 1 WHERE id = " + Str(line_id)  'save line status
                        Dim Cmd21 As New OdbcCommand(CmdString21, Conn)
                        Cmd21.ExecuteNonQuery()

                    Else
                        'function returns -1.. dan opslag = 0
                        labelberichtopslag = 0
                    End If
                    Dim jp_opslag As Double = 0
                    If jpkorting > 0 Then
                        jp_opslag = -jpkorting / 100
                        addline("Korting", "", pformatprijs(jp_opslag, 2), "WHITE")
                    End If

                    boekprijs = boekprijs + lb_opslag + jp_opslag
                    If boekprijs = 0 Then
                        addline("Totaal prijs", "TOTPRIJS", pformatprijs(boekprijs, 2), "RED")
                        'warning = True
                    Else
                        addline("Totaal prijs", "TOTPRIJS", pformatprijs(boekprijs, 2), "WHITE")
                    End If

                    Dim prijs As Double = Val(CHstr(Reader("PRI_INV_Price_Amount")))

                    If CInt(prijs * 1000) < CInt(boekprijs * 1000) Then
                        addline("Prijs koper", "PRIJS", pformatprijs(prijs, 2), "RED", pformatprijs(prijs, 2))
                        warning = True
                        double_warning = True
                    ElseIf CInt(prijs * 1000) > CInt(boekprijs * 1000) Then
                        addline("Prijs koper", "PRIJS", pformatprijs(prijs, 2), "GREEN", pformatprijs(prijs, 2))
                    Else
                        addline("Prijs koper", "PRIJS", pformatprijs(prijs, 2), "WHITE", pformatprijs(prijs, 2))
                    End If
                    ' TimePassed("Part6")
                    If actie_type > 0 And boekprijs = prijs Then
                        Dim CmdString18 = "SELECT id FROM edi2_lines where 1=0"
                        Dim Cmd18 As New OdbcCommand(CmdString18, Conn)
                        Cmd18.CommandText = "UPDATE edi2_lines SET Actie_type ='" + Str(actie_type) + "' WHERE id = " + Str(line_id)
                        Cmd18.ExecuteNonQuery()
                    End If

                    Dim prijsvoorwaarde_value As String = CHstr(Reader("PRI_INV_Price_specification_code"))
                    Dim prijsvoorwaarde As String
                    If Val(prijsvoorwaarde_value) = 43 Then
                        prijsvoorwaarde = "all in"
                    Else
                        prijsvoorwaarde = ReadSQLData("data_elementen", "date_element_code", 5387, "date_element_value", prijsvoorwaarde_value, "date_element_value_description")
                    End If

                    addline("Prijsvoorwaarde", "", prijsvoorwaarde, "WHITE")
                    addline("Munteenheid", "", CHstr(Reader("CUX_INV")), "WHITE")
                    addline("", "", "", "WHITE")

                    ' fust
                    'get aantal/per fust 
                    Dim MEA_Aantal_per_fust As Integer = CHint(Reader("MEA_Aantal_per_Fust"))
                    Dim PAC_Fust_Code As Integer = CHint(Reader("PAC_Fust_Code"))
                    Dim decorum As Integer = CHint(Reader("Decorum"))
                    addline("Fust", "EDIFUST", PAC_Fust_Code, "WHITE")
                    Dim boekfustid As Integer = CHint(Reader("boekfustid"))
                    If MEA_Aantal_per_fust <> fust(GID(fust, boekfustid)).aantal_per_fust Then
                    End If

                    addline("Aantal per fust", "AANTALPERFUST", MEA_Aantal_per_fust, "WHITE")

                    Dim boekfust As String = ""
                    Dim fustid As Integer = CHint(Reader("boekfustid"))

                    boekfust = fust(GID(fust, fustid)).fustnaam

                    If boekfust = "" Or IsNothing(boekfust) Then
                        addline("Boek fust", "BOEKFUST", "Fust onbekend", "RED")
                        warning = True
                        double_warning = True
                    Else
                        addline("Boek fust", "BOEKFUST", boekfust, "LAVENDER", Str(fustid))
                    End If
                    'kar
                    Dim PAC_Kar_code = CHint(Reader("PAC_Kar_code"))



                    Dim KarString As String = ReadSQLData("data_elementen", "date_element_code", 7065, "date_element_value", PAC_Kar_code, "date_element_value_description")
                    If PAC_Kar_code = "2" Or PAC_Kar_code = "6" Then
                        addline("Kar", "", KarString, "WHITE")
                    Else
                        addline("Kar", "", KarString, "CORAL")
                        warning = True
                    End If

                    ' TimePassed("Part7")

                    Dim karvoorkeur As Integer = ReadSQLString("klanten", "ean", CHstr(Reader("NAD_BY_EAN")), "kar_voorkeur")
                    Dim veilingvoorkeur As Integer = ReadSQLString("klanten", "ean", CHstr(Reader("NAD_BY_EAN")), "veiling_voorkeur")
                    Dim karid As Integer = CHint(Reader("BoekKarId"))
                    If karid = 0 Then
                        karid = 1 'default
                        If PAC_Kar_code = 2 Or PAC_Kar_code = 6 Or PAC_Kar_code = 0 Or IsNothing(PAC_Kar_code) Then
                            karid = 1  'denen
                        End If
                        If PAC_Kar_code = 1 Then
                            If karvoorkeur = 1 Then  ' karvoorkeur = deen , florecom een veilingkar.. dan toch deen
                                karid = 1 'deen
                            Else
                                karid = 3 'westland kar
                            End If
                        End If
                        If PAC_Kar_code = 10 Then
                            karid = 4
                        End If
                        Dim CmdString7 = "SELECT id FROM edi2_lines where 1=0"
                        Dim Cmd7 As New OdbcCommand(CmdString7, Conn)
                        Cmd7.CommandText = "UPDATE edi2_lines SET BoekKarId ='" + Str(karid) + "' WHERE id = " + Str(line_id)
                        Cmd7.ExecuteNonQuery()
                    End If
                    addline("Boek kar", "KAR", kar(GID(kar, karid)).karnaam, "LAVENDER")

                    addline("", "", "", "WHITE")

                    'get aantal
                    Dim QTY_Unit_Code As Integer = CHint(Reader("QTY_Unit_Code"))
                    Dim QTY_Quantity As Integer = CHint(Reader("QTY_Quantity"))
                    addline("Aantal", "AANTAL", CHstr(QTY_Quantity), "WHITE")
                    Dim eenheid As String = ReadSQLData("data_elementen", "date_element_code", 6411, "date_element_value", QTY_Unit_Code, "date_element_value_description")
                    addline("Eenheid", "", eenheid, "WHITE")
                    Dim boekaantal As Integer = CHint(Reader("Aantal"))
                    If boekaantal = 0 Then
                        addline("Aantal fust boek", "AANTALBOEK", CHint(Reader("Aantal")), "RED")
                    Else
                        addline("Aantal fust boek", "AANTALBOEK", CHint(Reader("Aantal")), "LAVENDER")
                    End If

                    addline("", "", "", "WHITE")

                    '
                    Dim paspoort_toevoegen As Boolean = False
                    'opmerking ACB
                    Dim FTX_Text_Literal_1 As String = CHstr(Reader("FTX_Text_Literal_1"))
                    Dim FTX_Text_Literal_2 As String = CHstr(Reader("FTX_Text_Literal_2"))
                    If FTX_Text_Literal_1 <> "" Or FTX_Text_Literal_2 <> "" Then
                        If InStr(FTX_Text_Literal_1.ToLower, "paspoort") > 0 Or InStr(FTX_Text_Literal_2.ToLower, "paspoort") > 0 Then
                            warning = True
                            double_warning = True
                            addline("Opmerking1", "OPM1", FTX_Text_Literal_1, "RED")
                            addline("Opmerking2", "OPM2", FTX_Text_Literal_2, "RED")
                            paspoort_toevoegen = True
                        ElseIf check_opmerking(FTX_Text_Literal_1, FTX_Text_Literal_2, CHstr(Reader("NAD_BY_EAN")), CHstr(Reader("LIN_Product_Code")), CHstr(Reader("IMD_Full_Name")), CHstr(Reader("PIA_SA_EAN"))) = False Then
                            warning = True
                            addline("Opmerking1", "OPM1", FTX_Text_Literal_1, "CORAL")
                            addline("Opmerking2", "OPM2", FTX_Text_Literal_2, "CORAL")
                        Else
                            addline("Opmerking1", "OPM1", FTX_Text_Literal_1, "WHITE")
                            addline("Opmerking2", "OPM2", FTX_Text_Literal_2, "WHITE")
                        End If
                    Else
                        addline("Opmerking1", "OPM1", FTX_Text_Literal_1, "WHITE")
                        addline("Opmerking2", "OPM2", FTX_Text_Literal_2, "WHITE")
                    End If

                    'opmerking COI
                    Dim FTX_COI_Text_Literal_1 As String = Trim(CHstr(Reader("FTX_COI_Text_Literal_1")))
                    Dim FTX_COI_Text_Literal_2 As String = Trim(CHstr(Reader("FTX_COI_Text_Literal_2")))
                    If Not (FTX_COI_Text_Literal_1 = "") And (FTX_COI_Text_Literal_2 = "") Then
                        If InStr(FTX_COI_Text_Literal_1.ToLower, "paspoort") > 0 Or InStr(FTX_COI_Text_Literal_2.ToLower, "paspoort") > 0 Then
                            warning = True
                            double_warning = True
                            addline("Opmerking1", "OPM1", FTX_COI_Text_Literal_1, "RED")
                            addline("Opmerking2", "OPM2", FTX_COI_Text_Literal_2, "RED")
                            paspoort_toevoegen = True
                        ElseIf check_opmerking(FTX_COI_Text_Literal_1, FTX_COI_Text_Literal_2, CHstr(Reader("NAD_BY_EAN")), CHstr(Reader("LIN_Product_Code")), CHstr(Reader("IMD_Full_Name")), CHstr(Reader("PIA_SA_EAN"))) = False Then
                            warning = True
                            addline("Opmerking3", "OPM3", FTX_COI_Text_Literal_1, "CORAL")
                            addline("Opmerking4", "OPM4", FTX_COI_Text_Literal_2, "CORAL")
                        Else
                            addline("Opmerking3", "OPM3", FTX_COI_Text_Literal_1, "WHITE")
                            addline("Opmerking4", "OPM4", FTX_COI_Text_Literal_2, "WHITE")
                        End If
                    Else
                        addline("Opmerking3", "OPM3", FTX_COI_Text_Literal_1, "WHITE")
                        addline("Opmerking4", "OPM4", FTX_COI_Text_Literal_2, "WHITE")
                    End If


                    Dim opmerkingboek As String = CHstr(Reader("OpmerkingBoek"))

                    'Lemkes labelbericht check
                    If koper_ean = "8714231140016" And opmerkingboek = "" Then
                        Dim CCICAVr() As String = Microsoft.VisualBasic.Strings.Split(CCICAVStr, "*")
                        Dim potstikkerfound As Boolean = False
                        For i = 0 To UBound(CCICAVr) - 1
                            Dim cci = Mid(CCICAVr(i), 1, 3)
                            Dim cav = Mid(CCICAVr(i), 5, 3)
                            If cci = "S61" And cav = "008" Then  'labels lemkes
                                potstikkerfound = True
                            End If
                        Next i

                        If potstikkerfound = True Then
                            opmerkingboek = "Stikker!!!"
                            Dim Cmd7 As New OdbcCommand("UPDATE edi2_lines SET OpmerkingBoek=? WHERE id = ?", Conn)
                            Cmd7.Parameters.Clear()
                            Cmd7.Parameters.AddWithValue("", "Stikker!!!")
                            Cmd7.Parameters.AddWithValue("", line_id)
                            Cmd7.ExecuteNonQuery()
                        End If

                    End If

                    addline("Opmerking boek", "OPMB", opmerkingboek, "LAVENDER")
                    addline("", "", "", "WHITE")

                    ' TimePassed("Part8")
                    'kenmerken
                    Dim labelbericht_gevonden As Boolean = False

                    Dim CCICAVString As String = CHstr(Reader("CCICAV"))
                    Dim CCICAV() As String = Microsoft.VisualBasic.Strings.Split(CCICAVString, "*")
                    For i = 0 To UBound(CCICAV) - 1
                        Dim cci = Mid(CCICAV(i), 1, 3)
                        Dim cav = Mid(CCICAV(i), 5, 3)

                        Dim kenmerk As String = ReadSQLData("data_elementen", "date_element_code", "7037", "date_element_value", cci, "date_element_value_description")
                        If cci = "T19" Then kenmerk = "Merk"
                        If cci = "T17" Then kenmerk = "Speciaal"
                        'If cci = "S76" Then kenmerk = "Labelbericht"
                        If cci = "L18" Then kenmerk = "Labelbericht"
                        If cci = "L19" Then kenmerk = "Labelbericht"
                        If cci = "L20" Then kenmerk = "Labelbericht"
                        If cci = "L21" Then kenmerk = "Labelbericht"
                        If cci = "L22" Then kenmerk = "Labelbericht"

                        Dim waarde As String = ReadSQLData("sort_elementen", "sort_element_code", cci, "sort_element_value", cav, "sort_element_value_description")

                        If cci = "S61" And cav = "004" Then  'PLANTENPASPOORT
                            warning = True
                            double_warning = True
                            addline(kenmerk, "CCI:" + cci, waarde, "RED")
                            paspoort_toevoegen = True
                        End If

                        If cci = "S01" Then
                            Dim soort_potmaat As Integer = 110
                            If SoortId < 10000 Then
                                soort_potmaat = soorten(GID(soorten, SoortId)).potmaat
                            Else
                                soort_potmaat = mixen(GID(mixen, SoortId - 10000)).potmaat
                            End If

                            Dim accessoire_potmaat As Integer = 0
                            If accessoire1 > 0 Then
                                accessoire_potmaat = accessoire(GID(accessoire, accessoire1)).potmaat
                            End If
                            If accessoire1 = 0 Or accessoire_potmaat = 0 Then
                                If Val(cav) * 10 <> soort_potmaat Then 'potmaat
                                    addline(kenmerk, "CCI:" + cci, waarde, "CORAL")
                                    warning = True
                                Else
                                    addline(kenmerk, "CCI:" + cci, waarde, "WHITE")
                                End If
                            Else
                                If accessoire_potmaat <> (Val(cav) * 10) Then
                                    addline(kenmerk, "CCI:" + cci, waarde, "CORAL")
                                    warning = True
                                Else
                                    addline(kenmerk, "CCI:" + cci, waarde, "WHITE")
                                End If
                            End If
                        ElseIf cci = "S51" And Val(cav) > 2 Then 'potvorm
                            addline(kenmerk, "CCI:" + cci, waarde, "CORAL")
                            warning = True
                        ElseIf cci = "S05" Then
                            If jenptenhave = False Then
                                If SoortId < 10000 Then
                                    If soorten(GID(soorten, SoortId)).klokrijpheid = Val(cav) Or soorten(GID(soorten, SoortId)).bbrijpheid = Val(cav) Then
                                        addline(kenmerk, "cci:" + cci, waarde, "WHITE")
                                    Else
                                        addline(kenmerk, "cci:" + cci, waarde, "CORAL")
                                        warning = True
                                    End If
                                Else
                                    If mixen(GID(mixen, SoortId - 10000)).rijpheid = Val(cav) Then
                                        addline(kenmerk, "cci:" + cci, waarde, "WHITE")
                                    Else
                                        addline(kenmerk, "cci:" + cci, waarde, "CORAL")
                                        warning = True
                                    End If

                                End If
                            End If
                        ElseIf kenmerk = "Labelbericht" Then
                            addline(kenmerk, "CCI:" + cci, waarde, "CORAL")
                            warning = True
                            labelbericht_gevonden = True
                        Else
                            addline(kenmerk, "CCI:" + cci, waarde, "WHITE")
                        End If

                    Next

                    If labelbericht_gevonden = True Then
                        addline("", "", "", "WHITE")
                        If paspoort_toevoegen = True Then
                            addline("LB Paspoort", "PASPOORT", "Ja", "RED")
                            Dim Cmd17 As New OdbcCommand("UPDATE edi2_lines SET Label_referentie ='paspoort' WHERE id =?", Conn)
                            Cmd17.Parameters.Clear()
                            Cmd17.Parameters.AddWithValue("", line_id)
                            Cmd17.ExecuteNonQuery()
                        Else
                            addline("Paspoort", "PASPOORT", "Nee", "WHITE")
                            Dim Cmd17 As New OdbcCommand("UPDATE edi2_lines SET Label_referentie ='' WHERE id =?", Conn)
                            Cmd17.Parameters.Clear()
                            Cmd17.Parameters.AddWithValue("", line_id)
                            Cmd17.ExecuteNonQuery()
                        End If
                    End If



                    addline("", "", "", "WHITE")

                    '  TimePassed("Part9")

                    ' referenties koper/kweker
                    Dim kopernad As NAD
                    kopernad = ReadNAD(line_id, "BY")
                    addline("Koper Referenties", "", ".", "WHITE")
                    ShowRefs(kopernad.id, line_id)

                    'Dim kwekernad As NAD
                    'kwekernad = ReadNAD(line_id, "SE")
                    'addline("Kweker Referenties", "", ".", "WHITE")
                    'ShowRefs(kwekernad.id)
                    addline("", "", "", "WHITE")

                    'diverse retailprice/docs etc
                    For i = 0 To 5
                        Dim edidoc As String = CHstr(Reader("DOC_" + Trim(Str(i))))
                        If edidoc <> "" Then
                            Dim docdesc = ReadSQLData("data_elementen", "date_element_code", "1001", "date_element_value", edidoc, "date_element_value_description")
                            addline("Document bijvoegen", "", docdesc, "CORAL")
                            warning = True
                        End If
                    Next

                    Dim rprijs As Double = Val(CHstr(Reader("PRI_AAE_Price_Amount")))
                    If rprijs > 0 Then
                        addline("Retail prijs", "", pformatprijs(rprijs, 2), "WHITE")
                        Dim rprijsvoorwaarde As String = ReadSQLData("data_elementen", "date_element_code", 5387, "date_element_value", CHstr(Reader("PRI_AAE_Price_specification_code")), "date_element_value_description")
                        addline("Prijsvoorwaarde", "", rprijsvoorwaarde, "WHITE")
                        addline("Munteenheid", "", CHstr(Reader("CUX_AAE")), "WHITE")
                        addline("", "", "", "WHITE")
                    End If

                    If CHstr(Reader("PCI_Label_Description_fust")) <> "" Then
                        warning = True
                        addline("Fustlabel", "", CHstr(Reader("PCI_Label_Description_fust")), "WHITE")
                    End If
                    If CHstr(Reader("PCI_Label_Description_kar")) <> "" Then
                        warning = True
                        addline("Fustlabel", "", CHstr(Reader("PCI_Label_Description_kar")), "WHITE")
                    End If

                    If CHstr(Reader("PCI_Label_Code_fust")) <> "" Then
                        warning = True
                        Dim code As String = ReadSQLData("data_elementen", "date_element_code", "7511", "date_element_value", CHstr(Reader("PCI_Label_Code_fust")), "date_element_value_description")
                        addline("Barcode type fust", "", code, "WHITE")
                    End If
                    If CHstr(Reader("PCI_Label_Code_kar")) <> "" Then
                        warning = True
                        Dim code As String = ReadSQLData("data_elementen", "date_element_code", "7511", "date_element_value", CHstr(Reader("PCI_Label_Code_kar")), "date_element_value_description")
                        addline("Barcode type kar", "", code, "WHITE")
                    End If
                    Dim plpk As String = CHstr(Reader("MEA_Aantal_plant_per_kar"))
                    Dim lpk As String = CHstr(Reader("MEA_Aantal_lagen_per_kar"))
                    If plpk <> "" Or lpk <> "" Then

                        addline("Laadvoorstel:", "", ".", "WHITE")
                        addline("Planten per kar:", "", plpk, "WHITE")
                        addline("lagen per kar:", "", lpk, "WHITE")
                    End If
                    addline("", "", "", "WHITE")
                    addline("Florecom line ID", "", "L" + Trim(Str(line_id)), "WHITE")
                End If

                'TimePassed("Part10")

                ' TimePassed("End")
                ' timeperparse.Stop()




            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom ShowLineData)" + ex.Message)
            MessageBox.Show("Database fout: (florecom ShowLineData)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Dim w_return As Integer = 0
        If warning = True Then w_return = 1
        If geen_kwekercode = True Then w_return = 3
        If double_warning = True Then w_return = 2
        Return w_return

    End Function
    Private Function FindHoes(ByVal koper_ean, ByVal soortid) As Integer
        Dim accessoire_id = 0
        Dim hoescat As Integer = 0
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand("SELECT hoescategorie from klanten WHERE ean=?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", koper_ean)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    hoescat = CHint(Reader("hoescategorie"))
                End If
                accessoire_id = FindHoesFromHoesCat(hoescat, soortid)
                Reader.Close()
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (fc hoes)" + ex.Message)
            MessageBox.Show("Database fout: (fc hoes)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return accessoire_id
    End Function
    Private Sub ShowRefs(ByVal ref_id As Integer, ByVal line_id As Integer)
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader
                Dim CmdString = "SELECT * FROM edi2_lines_nad_rff where edi_line_nad_id = '" + Str(ref_id) + "'"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Dim koperordernr As String = ""
                Dim labelref As String = ""
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read
                    Dim Nad_rff_code As String = CHstr(Reader("RFF_Code_Qualifier"))
                    Dim nad_rff_id As String = CHstr(Reader("RFF_Identifier"))
                    Dim nad_RFF_version As String = CHstr(Reader("RFF_Version"))
                    If Nad_rff_code = "ON" Then
                        koperordernr = nad_rff_id
                    End If
                    'save label ref
                    If Nad_rff_code = "AAG" Then
                        labelref = nad_rff_id
                    End If

                    Dim title As String = ReadSQLData("data_elementen", "date_element_code", "1153", "date_element_value", Nad_rff_code, "date_element_value_description")
                    addline(title, "", nad_rff_id + " " + nad_RFF_version, "WHITE")
                Loop
                Reader.Close()

                Dim CmdString7 = "SELECT id FROM edi2_lines where 1=0"
                Dim Cmd7 As New OdbcCommand(CmdString7, Conn)
                Cmd7.CommandText = "UPDATE edi2_lines SET Koperordernr ='" + koperordernr + "' WHERE id = " + Str(line_id)
                Cmd7.ExecuteNonQuery()
                'Cmd7.CommandText = "UPDATE edi2_lines SET Label_referentie ='" + labelref + "' WHERE id = " + Str(line_id)
                'Cmd7.ExecuteNonQuery()

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom read rffs)" + ex.Message)
            MessageBox.Show("Database fout: (florecom read rffs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub FC_Flexgrid_orderlines_AfterEdit(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles FC_Flexgrid_orderlines.AfterEdit
        If FC_Flexgrid_orderlines.Rows.Count > 1 Then

            'update Lin Responce after edit

            Dim rowsel As Integer = 0
            For i = 1 To FC_Flexgrid_orderlines.Rows.Count - 1
                If FC_Flexgrid_orderlines.Rows(i).Selected = True Then
                    rowsel = i
                    Exit For
                End If
            Next i
            If rowsel = 0 Then rowsel = 1
            Dim line_id = FC_Flexgrid_orderlines.Item(rowsel, 0)
            Dim acceptedstate = FC_Flexgrid_orderlines.Item(rowsel, 1)
            If acceptedstate > 0 Then
                Try
                    Using Conn As New OdbcConnection(ConnString)
                        Conn.Open()

                        Dim CmdString = "SELECT id FROM edi2_lines where 1=0"
                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                        Cmd.CommandText = "UPDATE edi2_lines SET LIN_Responce ='" + Str(acceptedstate) + "' WHERE id = " + Str(line_id)
                        Cmd.ExecuteNonQuery()
                    End Using
                Catch ex As Exception
                    ErrorLog("Database fout: (florecom save data)" + ex.Message)
                    MessageBox.Show("Database fout: (florecom save data)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                End Try
            End If
        End If

    End Sub
    Private Sub FC_Flexgrid_orderlines_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FC_Flexgrid_orderlines.Click
        'find selected row
        If FC_Flexgrid_orderlines.Rows.Count > 1 Then


            Dim rowsel As Integer = 0
            For i = 1 To FC_Flexgrid_orderlines.Rows.Count - 1
                If FC_Flexgrid_orderlines.Rows(i).Selected = True Then
                    rowsel = i
                    Exit For
                End If
            Next i
            Dim line_id = FC_Flexgrid_orderlines.Item(rowsel, 0)
            FC_CurrentEditLine = line_id
            ShowLineData(line_id)

        End If


    End Sub

    Private Sub SetOrderLines(ByVal order_id As Integer)

        Fc_Flexgrid_LineData.Rows.Count = 1
        FC_Flexgrid_orderlines.Rows.Count = 1
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Reader As OdbcDataReader


                If order_id > 0 Then
                    Dim CmdString2 = "SELECT * FROM edi2_lines where ordernr = " + Str(order_id) + " order by potmaat, lin_product_code DESC"
                    Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                    Reader = Cmd2.ExecuteReader()
                    Do While Reader.Read
                        Dim ediline_id As Integer = CHint(Reader("id"))

                        'Get Aantal  / AantalPerFust
                        Dim Aantal As Integer = 0
                        Dim AantalPerFust As Integer = 0

                        'get aantal/per fust 

                        Dim MEA_Aantal_per_fust As Integer = CHint(Reader("MEA_Aantal_per_Fust"))
                        Dim PAC_Fust_Code As Integer = CHint(Reader("PAC_Fust_Code"))
                        Dim BoekFustId As Integer = CHint(Reader("BoekFustId"))
                        Dim BoekFustCode As String = fust(GID(fust, BoekFustId)).fustcode_florecom
                        If BoekFustId = 0 Then
                            If MEA_Aantal_per_fust = 0 Then
                                For i = 0 To UBound(fust)
                                    If fust(i).fustcode_florecom = PAC_Fust_Code Then
                                        AantalPerFust = fust(i).aantal_per_fust
                                        Exit For
                                    End If
                                Next
                            Else
                                For i = 0 To UBound(fust)
                                    If fust(i).fustcode_florecom = PAC_Fust_Code And fust(i).aantal_per_fust = MEA_Aantal_per_fust Then
                                        AantalPerFust = fust(i).aantal_per_fust
                                        Exit For
                                    End If
                                Next
                            End If
                        Else
                            If MEA_Aantal_per_fust = 0 Then
                                For i = 0 To UBound(fust)
                                    If fust(i).fustcode_florecom = BoekFustCode Then
                                        AantalPerFust = fust(i).aantal_per_fust
                                        Exit For
                                    End If
                                Next
                            Else
                                For i = 0 To UBound(fust)
                                    If fust(i).fustcode_florecom = BoekFustCode And fust(i).aantal_per_fust = MEA_Aantal_per_fust Then
                                        AantalPerFust = fust(i).aantal_per_fust
                                        Exit For
                                    End If
                                Next
                            End If
                        End If
                        'get aantal


                        Dim QTY_Unit_Code As Integer = CHint(Reader("QTY_Unit_Code"))
                        Dim QTY_Quantity As Integer = CHint(Reader("QTY_Quantity"))
                        Aantal = CHint(Reader("Aantal"))
                        If Aantal = 0 Then
                            If QTY_Unit_Code = 1 And AantalPerFust > 0 Then
                                Aantal = Int((QTY_Quantity / AantalPerFust) + 0.5)
                            ElseIf QTY_Unit_Code = 3 Then
                                Aantal = QTY_Quantity
                            End If
                        End If

                        ' maak string  "24 x 8"
                        Dim boekregel As String = ""
                        If Aantal > 0 Then
                            boekregel = Trim(Str(Aantal)) + " x "
                        Else
                            boekregel = "? x "
                        End If
                        If AantalPerFust > 0 Then
                            boekregel = boekregel + Trim(Str(AantalPerFust))
                        Else
                            boekregel = boekregel + "?"
                        End If

                        'Get Soort / Accessoire1 / Accessoire 2
                        Dim SoortId As Integer = 0
                        Dim AccessoireId1 As Integer = 0
                        Dim AccessoireId2 As Integer = 0
                        Dim Hoes_id As Integer = 0
                        Dim boekprijs As Integer = 0
                        Dim actienummer As String = ""

                        Dim IMD_Full_Name As String = CHstr(Reader("IMD_FUll_Name"))
                        Dim PIA_SA_EAN As String = CHstr(Reader("PIA_SA_EAN"))

                        Dim VBN_Code As String = CHstr(Reader("LIN_Product_Code"))
                        Dim EAN_Koper As String = CHstr(Reader("NAD_BY_EAN"))
                        Dim status As Integer = CHint(Reader("Status"))
                        Dim Lin_Responce As Integer = CHint(Reader("LIN_Responce"))

                        If EAN_Koper = "8714231202523" Then   'auto accept martin (floraconnect)
                            Lin_Responce = 999
                        End If

                        Dim opmerking3 As String = CHstr(Reader("FTX_COI_Text_Literal_1"))

                        Dim decorum As Integer = IsDecorum(EAN_Koper)
                        Dim altijd_decorum As Integer = AltijdDecorum(EAN_Koper)
                        Dim decowelfustgeenpotcover As Integer = DecorumWelFustGeenPotcover(EAN_Koper)
                        'Dim nieuweporto As Integer = KiesNieuwePorto(EAN_Koper)

                        'Betulia's zijn nooit decorum
                        Dim betulia As Boolean = False
                        For s = 0 To UBound(soortgroep)
                            If soortgroep(s).naam = "Begonia 19" Then
                                For t = 0 To UBound(soortgroepids)
                                    If soortgroepids(t).id = soortgroep(s).id Then
                                        Dim soortmixid As Integer = soortgroepids(t).soortmixid
                                        For i = 0 To UBound(soorten)
                                            If soorten(i).id = soortmixid Then
                                                If soorten(i).vbn_code = VBN_Code Then
                                                    betulia = True
                                                    Exit For
                                                End If
                                            End If
                                        Next
                                        For i = 0 To UBound(mixen)
                                            If mixen(i).id = soortmixid - 10000 Then
                                                If mixen(i).vbn_code = VBN_Code Then
                                                    betulia = True
                                                    Exit For
                                                End If
                                            End If
                                        Next
                                    End If
                                Next
                            End If
                        Next

                        If betulia = True Then
                            decorum = 0
                        End If


                        SoortId = CHint(Reader("Soort_id"))
                        AccessoireId1 = CHint(Reader("Accessoire1"))
                        AccessoireId2 = CHint(Reader("Accessoire2"))
                        Hoes_id = CHint(Reader("Hoes"))
                        Dim potmaat As Integer = CHint(Reader("potmaat"))
                        If potmaat = 510 Then
                            potmaat = 105
                        Else
                            potmaat = potmaat * 10
                        End If


                        Dim soortmatch As Boolean = False
                        If SoortId = 0 Then   'eerste keer aanmaken


                            'andere codes for gloxinia gemengd
                            If Val(VBN_Code) = 8346 Or Val(VBN_Code) = 100488 Then
                                VBN_Code = "29005"
                            End If


                            If BoekFustId = 0 Then

                                'wel of geen deco fust zoeken?

                                If Len(PIA_SA_EAN) = 12 Then
                                    If (Asc(Mid(PIA_SA_EAN, 1, 1)) >= Asc("A") And Asc(Mid(PIA_SA_EAN, 1, 1)) <= Asc("Z")) And Mid(PIA_SA_EAN, 5, 1) = "-" Then
                                        'cut extra codes klantspecifiek
                                        PIA_SA_EAN = Mid(PIA_SA_EAN, 1, 9)
                                    End If
                                End If

                                If Len(PIA_SA_EAN) = 9 Then
                                    If (Asc(Mid(PIA_SA_EAN, 1, 1)) >= Asc("A") And Asc(Mid(PIA_SA_EAN, 1, 1)) <= Asc("Z")) And Mid(PIA_SA_EAN, 5, 1) = "-" Then
                                        Dim eigencode_startletter As String = Mid(PIA_SA_EAN, 1, 1)
                                        If eigencode_startletter = "N" Then
                                            decorum = 0
                                        End If
                                        If eigencode_startletter = "C" Or eigencode_startletter = "D" Or eigencode_startletter = "R" Then  'cyclamen, decorum, russia decorum
                                            decorum = 1
                                        End If
                                    End If
                                End If

                                If altijd_decorum = 1 Then
                                    decorum = 1
                                End If


                                If decorum <> 0 Then
                                    Dim deco_found As Boolean = False
                                    For i = 0 To UBound(fust)

                                        'j en p 816 code -> verbouwen naar 4 gaats (kopers sturen wat anders mee)
                                        If fust(i).fustcode_florecom = 816 Then
                                            If fust(i).fustcode_florecom = PAC_Fust_Code And fust(i).decorum = True And fust(i).aantal_per_fust = 4 Then
                                                BoekFustId = fust(i).id
                                                deco_found = True
                                                Exit For
                                            End If
                                        Else

                                            If fust(i).fustcode_florecom = PAC_Fust_Code And fust(i).decorum = True And fust(i).aantal_per_fust = AantalPerFust Then
                                                BoekFustId = fust(i).id
                                                deco_found = True
                                                Exit For
                                            End If

                                        End If


                                    Next i
                                    If deco_found = False Then
                                        For i = 0 To UBound(fust)
                                            If fust(i).fustcode_florecom = PAC_Fust_Code And fust(i).aantal_per_fust = AantalPerFust Then
                                                BoekFustId = fust(i).id
                                                Exit For
                                            End If
                                        Next
                                    End If
                                Else
                                    Dim foundnondecofust As Boolean = False
                                    For i = 0 To UBound(fust)
                                        If fust(i).fustcode_florecom = PAC_Fust_Code And fust(i).aantal_per_fust = AantalPerFust And fust(i).decorum = False Then
                                            BoekFustId = fust(i).id
                                            foundnondecofust = True
                                            Exit For
                                        End If
                                    Next
                                    If foundnondecofust = False Then
                                        For i = 0 To UBound(fust)
                                            If fust(i).fustcode_florecom = PAC_Fust_Code And fust(i).aantal_per_fust = AantalPerFust Then
                                                BoekFustId = fust(i).id
                                                foundnondecofust = True
                                                Exit For
                                            End If
                                        Next
                                    End If

                                End If

                                'check for fust 813, glox of begonia
                                If PAC_Fust_Code = 813 Then
                                    'zijn het gloxen?
                                    Dim gloxen As Boolean = False
                                    For s = 0 To UBound(soortgroep)
                                        If soortgroep(s).naam = "Gloxinia" Then
                                            For t = 0 To UBound(soortgroepids)
                                                If soortgroepids(t).id = soortgroep(s).id Then
                                                    Dim soortmixid As Integer = soortgroepids(t).soortmixid
                                                    For i = 0 To UBound(soorten)
                                                        If soorten(i).id = soortmixid Then
                                                            If soorten(i).vbn_code = VBN_Code Then
                                                                gloxen = True
                                                                Exit For
                                                            End If
                                                        End If
                                                    Next
                                                End If
                                            Next
                                        End If
                                    Next
                                    If gloxen = True Then
                                        If decorum <> 0 Then
                                            BoekFustId = 55  'best deco
                                        Else
                                            BoekFustId = 54  'best norm
                                        End If
                                    Else
                                        If decorum <> 0 Then
                                            BoekFustId = 46  'eurodan 6x deco
                                        Else
                                            BoekFustId = 47  'eurodan 6x norm
                                        End If
                                    End If
                                End If


                            End If


                            'find soortid & accessoires


                            '1de match
                            Dim reader4 As OdbcDataReader
                            Dim CmdString4 = "SELECT * FROM soortmatch3 where opmerking3 = '" + opmerking3 + "' and koper_ean = '" + Trim(EAN_Koper) + "' and vbn_code = '" + Trim(VBN_Code) + "' and PIA_SA_EAN = '" + Trim(PIA_SA_EAN) + "' and IMD_Full_Name = '" + Trim(IMD_Full_Name) + "' and potmaat =" + Trim(Str(potmaat))
                            Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                            reader4 = Cmd4.ExecuteReader()
                            ' 1ste match met database 
                            If reader4.HasRows Then
                                SoortId = CHint(reader4("Soortid"))
                                AccessoireId1 = CHint(reader4("accessoire1"))
                                AccessoireId2 = CHint(reader4("accessoire2"))
                                BoekFustId = CHint(reader4("fustcode"))
                                Hoes_id = CHint(reader4("hoes"))
                                soortmatch = True
                            Else

                                Dim reader3 As OdbcDataReader
                                Dim CmdString3 = "SELECT * FROM soortmatch2 where koper_ean = '" + Trim(EAN_Koper) + "' and vbn_code = '" + Trim(VBN_Code) + "' and PIA_SA_EAN = '" + Trim(PIA_SA_EAN) + "' and IMD_Full_Name = '" + Trim(IMD_Full_Name) + "' and potmaat =" + Trim(Str(potmaat))
                                Dim Cmd3 As New OdbcCommand(CmdString3, Conn)
                                reader3 = Cmd3.ExecuteReader()
                                ' 2de match met database 
                                If reader3.HasRows Then
                                    SoortId = CHint(reader3("Soortid"))
                                    AccessoireId1 = CHint(reader3("accessoire1"))
                                    AccessoireId2 = CHint(reader3("accessoire2"))
                                    BoekFustId = CHint(reader3("fustcode"))
                                    Hoes_id = CHint(reader3("hoes"))
                                    soortmatch = True

                                ElseIf EAN_Koper = "8714231202523" Then    'floraconnect martin ignore SA and Text code  (floraconnect)
                                    Dim reader14 As OdbcDataReader
                                    Dim CmdString14 = "SELECT * FROM soortmatch2 where koper_ean = '" + Trim(EAN_Koper) + "' and vbn_code = '" + Trim(VBN_Code) + "'"
                                    Dim Cmd14 As New OdbcCommand(CmdString14, Conn)
                                    reader14 = Cmd14.ExecuteReader()
                                    ' 1ste match met database 
                                    If reader14.HasRows Then
                                        SoortId = CHint(reader14("Soortid"))
                                        AccessoireId1 = CHint(reader14("accessoire1"))
                                        AccessoireId2 = CHint(reader14("accessoire2"))
                                        BoekFustId = CHint(reader14("fustcode"))
                                        Hoes_id = CHint(reader14("hoes"))
                                        soortmatch = True
                                    End If


                                Else

                                    '2 match met klantnummer 
                                    If PIA_SA_EAN <> "" Then

                                        If PIA_SA_EAN = "D032-4800" Then        'petticoat mix fix
                                            PIA_SA_EAN = "D185-4800"
                                        End If

                                        If PIA_SA_EAN = "N032-4900" Then        'petticoat mix fix
                                            PIA_SA_EAN = "N185-4900"
                                        End If

                                        If PIA_SA_EAN = "C032-4800" Then        'petticoat mix fix
                                            PIA_SA_EAN = "C185-4800"
                                        End If

                                        If PIA_SA_EAN = "M032-4900" Then        'petticoat mix fix
                                            PIA_SA_EAN = "M185-4900"
                                        End If

                                        If jenptenhave = True Then
                                            'als de laatste code een 'A' is dan eraf hakken voor j&p  (speciale regels voor klant1)
                                            If Mid(PIA_SA_EAN, Len(PIA_SA_EAN), 1) = "A" Then
                                                PIA_SA_EAN = Mid(PIA_SA_EAN, 1, Len(PIA_SA_EAN) - 1)

                                            End If
                                        End If


                                        If Len(PIA_SA_EAN) = 9 And (Asc(Mid(PIA_SA_EAN, 1, 1)) >= Asc("A") And Asc(Mid(PIA_SA_EAN, 1, 1)) <= Asc("Z")) And Mid(PIA_SA_EAN, 5, 1) = "-" Then

                                            Dim interne_code As Integer = Val(Mid(PIA_SA_EAN, 2, 3))
                                            If Val(interne_code) < 100 Then
                                                For i = 0 To UBound(soorten)
                                                    If interne_code = soorten(i).interne_code Then
                                                        SoortId = soorten(i).id
                                                        Exit For
                                                    End If
                                                Next

                                            Else
                                                'fout met mixen oplossen
                                                If jenptenhave = False Then
                                                    If interne_code >= 202 And interne_code <= 210 Then
                                                        interne_code = 308
                                                        For i = 0 To UBound(mixen)
                                                            If interne_code = mixen(i).interne_code Then
                                                                SoortId = mixen(i).id + 10000
                                                                Exit For
                                                            End If
                                                        Next
                                                    End If
                                                End If

                                                For i = 0 To UBound(mixen)
                                                    If interne_code = mixen(i).interne_code Then
                                                        If mixen(i).fust = BoekFustId Then          'bij mixen meerdere mixen met 1 interne code mogelijk
                                                            SoortId = mixen(i).id + 10000
                                                            Exit For
                                                        End If
                                                    End If
                                                Next
                                            End If

                                            Dim AccessoireId1_code As String = Mid(PIA_SA_EAN, 6, 2)
                                            Dim AccessoireId2_code As String = Mid(PIA_SA_EAN, 8, 2)
                                            For i = 0 To UBound(accessoire)
                                                If AccessoireId1_code = accessoire(i).code Then


                                                    'Decorum accessoire ombouwen potcover
                                                    If jenptenhave = False And AccessoireId1_code = "01" And decorum <> 0 And SoortGroepCampanula(SoortId) = True Then
                                                        AccessoireId1 = 2

                                                        If decowelfustgeenpotcover = 1 Then
                                                            AccessoireId1 = 46
                                                        End If

                                                        If EAN_Koper = "8713782686677" Then 'metz
                                                            'AccessoireId1 = 46
                                                        ElseIf EAN_Koper = "8718288022011" Then 'xl flor (metz)
                                                            'AccessoireId1 = 46
                                                        ElseIf EAN_Koper = "8714231200215" Then 'donck
                                                            'AccessoireId1 = 46
                                                        End If


                                                        Exit For
                                                    Else
                                                        AccessoireId1 = accessoire(i).id

                                                        'N regel bij decorum klant -> "geen decorum" accessoire toevoegen
                                                        Dim eigencode_startletter As String = Mid(PIA_SA_EAN, 1, 1)
                                                        If jenptenhave = False And IsDecorum(EAN_Koper) = 1 And eigencode_startletter = "N" And (AccessoireId1_code = "00" Or AccessoireId1_code = "01") Then
                                                            AccessoireId1 = 37
                                                        End If

                                                        If jenptenhave = False And eigencode_startletter = "G" And AccessoireId1_code = "01" Then
                                                            AccessoireId1 = 66
                                                        End If

                                                        Exit For
                                                    End If

                                                End If
                                            Next
                                            For i = 0 To UBound(accessoire)
                                                If AccessoireId2_code = accessoire(i).code Then
                                                    AccessoireId2 = accessoire(i).id
                                                    Exit For
                                                End If
                                            Next
                                        Else
                                            'zoek soorten in kwekerscode tabel


                                            'Execute Query
                                            Dim Cmd As New OdbcCommand("SELECT * FROM prijslijst WHERE kwekerscode = ?", Conn)
                                            Cmd.Parameters.Clear()
                                            Cmd.Parameters.AddWithValue("", Trim(PIA_SA_EAN))
                                            Dim reader8 As OdbcDataReader
                                            reader8 = Cmd.ExecuteReader()
                                            If reader8.HasRows Then
                                                AccessoireId1 = CHint(reader8("accessoire1"))
                                                AccessoireId2 = CHint(reader8("accessoire2"))
                                                Hoes_id = CHint(reader8("hoes"))
                                                SoortId = CHint(reader8("soort"))

                                                If PAC_Fust_Code = 704 Or PAC_Fust_Code = 746 Or (PAC_Fust_Code >= 340 And PAC_Fust_Code <= 360) Then 'palentino of deense doos then
                                                    'skip read
                                                Else
                                                    BoekFustId = CHint(reader8("fust"))
                                                End If

                                            Else
                                                Dim soortfound As Boolean = False
                                                For i = 0 To UBound(soorten)
                                                    If VBN_Code = soorten(i).vbn_code And CInt(potmaat) = CInt(soorten(i).potmaat) Then
                                                        SoortId = soorten(i).id
                                                        soortfound = True
                                                        If decorum <> 0 Then  'label/potcover toevoegen bij decorum kopers
                                                            If jenptenhave = False Then
                                                                If decorum <> 0 And SoortGroepCampanula(SoortId) = True Then
                                                                    AccessoireId1 = 2
                                                                Else
                                                                    AccessoireId1 = 1
                                                                End If
                                                            End If

                                                        End If
                                                        Exit For
                                                    End If
                                                Next
                                                If soortfound = False Then
                                                    For i = 0 To UBound(mixen)
                                                        If VBN_Code = mixen(i).vbn_code And CInt(potmaat) = CInt(mixen(i).potmaat) Then
                                                            SoortId = mixen(i).id + 10000

                                                            If decorum <> 0 Then  'label/potcover toevoegen bij decorum kopers
                                                                If jenptenhave = False Then
                                                                    If decorum <> 0 And SoortGroepCampanula(SoortId) = True Then
                                                                        AccessoireId1 = 2
                                                                    Else
                                                                        AccessoireId1 = 1
                                                                    End If
                                                                End If

                                                            End If
                                                            Exit For
                                                        End If
                                                    Next
                                                End If
                                            End If
                                        End If
                                    Else



                                        '3 match met vbn code & potmaat
                                        Dim soortfound As Boolean = False
                                        For i = 0 To UBound(soorten)
                                            If Val(VBN_Code) = soorten(i).vbn_code And CInt(potmaat) = CInt(soorten(i).potmaat) Then
                                                SoortId = soorten(i).id
                                                soortfound = True
                                                If decorum <> 0 Then  'label/potcover toevoegen bij decorum kopers
                                                    If jenptenhave = False Then
                                                        If decorum <> 0 And SoortGroepCampanula(SoortId) = True Then
                                                            AccessoireId1 = 2
                                                        Else
                                                            AccessoireId1 = 1
                                                        End If
                                                    End If
                                                End If
                                                Exit For

                                            End If
                                        Next
                                        If soortfound = False Then
                                            For i = 0 To UBound(mixen)

                                                If Val(VBN_Code) = mixen(i).vbn_code And CInt(potmaat) = CInt(mixen(i).potmaat) Then
                                                    SoortId = mixen(i).id + 10000

                                                    If decorum <> 0 Then  'label/potcover toevoegen bij decorum kopers
                                                        If jenptenhave = False Then
                                                            If decorum <> 0 And SoortGroepCampanula(SoortId) = True Then
                                                                AccessoireId1 = 2
                                                            Else
                                                                AccessoireId1 = 1
                                                            End If
                                                        End If
                                                        Exit For
                                                    End If

                                                End If
                                            Next
                                        End If
                                    End If
                                End If
                            End If


                            If jenptenhave = True Then  'bij eddie en special edd altijd bakstikker toevoegen
                                If EAN_Koper = "8714231140962" Or EAN_Koper = "8718288004116" Then
                                    If AccessoireId1 = 0 And AccessoireId2 = 0 Then
                                        '  AccessoireId1 = 73   'stikker op bak bij jenp
                                    End If
                                End If
                            End If

                            If jenptenhave = False And SoortId = 3 Then  ' And nieuweporto = 1 Then
                                SoortId = 4
                            End If

                        End If



                        If Hoes_id = 0 And SoortId > 0 Then
                            Dim Cmd18 As New OdbcCommand("SELECT hoescategorie FROM klanten WHERE ean = ?", Conn)
                            Cmd18.Parameters.Clear()
                            Cmd18.Parameters.AddWithValue("", EAN_Koper)
                            Dim reader18 As OdbcDataReader
                            reader18 = Cmd18.ExecuteReader()
                            If reader18.HasRows Then
                                Dim hoescatid As Integer = CHint(reader18("hoescategorie"))
                                Hoes_id = FindHoesFromHoesCat(hoescatid, SoortId)
                            End If
                        End If

                        If status = 0 Then

                            ' save boekregel,
                            Dim CmdString4 As String = "SELECT * FROM edi2_lines where 1=0"
                            Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                            Cmd4.CommandText = "UPDATE edi2_lines SET LIN_Responce=?,soort_id=?,Aantal=?,Boekregel=?,Accessoire1=?,Accessoire2=?,boekprijs=0,BoekFustId=?,hoes=? where id = " + Str(ediline_id)
                            Cmd4.Parameters.Clear()
                            Cmd4.Parameters.AddWithValue("", Lin_Responce)
                            Cmd4.Parameters.AddWithValue("", SoortId)
                            Cmd4.Parameters.AddWithValue("", Aantal)
                            Cmd4.Parameters.AddWithValue("", boekregel) 'compatibliteit met boek2.0
                            Cmd4.Parameters.AddWithValue("", AccessoireId1)
                            Cmd4.Parameters.AddWithValue("", AccessoireId2)
                            Cmd4.Parameters.AddWithValue("", BoekFustId)
                            Cmd4.Parameters.AddWithValue("", Hoes_id)
                            Cmd4.ExecuteNonQuery()
                        End If

                        'write line 

                        Dim warning As Integer = 0
                        FC_CheckRun = True
                        warning = ShowLineData(ediline_id)
                        FC_CheckRun = False

                        ' FC_Flexgrid_orderlines.Styles.Clear()
                        Dim rs As C1.Win.C1FlexGrid.CellStyle = FC_Flexgrid_orderlines.Styles("kleur")
                        '   rs = FC_Flexgrid_orderlines.Styles.Add("kleur")

                        If Lin_Responce = 0 Then
                            Lin_Responce = 99 ' nog te bewerken
                        End If

                        If warning = 1 Then
                            rs.BackColor = GetColorValue("#FF9999")
                        ElseIf warning = 2 Then
                            rs.BackColor = GetColorValue("#FF0000")
                        ElseIf warning = 3 Then
                            rs.BackColor = GetColorValue("#FFAA00")
                        Else
                            rs.BackColor = GetColorValue("#FFFFFF")
                        End If

                        If Lin_Responce = 999 Then
                            rs.BackColor = GetColorValue("#00cc00")
                        End If

                        If soortmatch = True Then
                            rs.BackColor = GetColorValue("#ff8c00")
                        End If


                        Dim fxfill(5) As String
                        fxfill(0) = Str(ediline_id)
                        fxfill(1) = Str(Lin_Responce)
                        fxfill(2) = boekregel
                        If SoortId = 0 Then
                            fxfill(3) = "Onbekend soort"
                        Else
                            If SoortId < 10000 Then
                                fxfill(3) = soorten(GID(soorten, SoortId)).soortnaam
                            Else
                                fxfill(3) = mixen(GID(mixen, SoortId - 10000)).naam
                            End If
                        End If
                        boekregel = boekregel + " " + fxfill(3) 'compatibliteit met boek2.0
                        fxfill(4) = accessoire(GID(accessoire, AccessoireId1)).naam
                        fxfill(5) = accessoire(GID(accessoire, AccessoireId2)).naam
                        FC_Flexgrid_orderlines.AddItem(fxfill)
                        FC_Flexgrid_orderlines.Rows(FC_Flexgrid_orderlines.Rows.Count - 1).Style = FC_Flexgrid_orderlines.Styles("kleur")


                    Loop
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom SetOrderLines)" + ex.Message)
            MessageBox.Show("Database fout: (florecom SetOrderLines)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


    End Sub
    Private Function SoortGroepCampanula(ByVal soortid As Integer) As Boolean
        Dim soortgroepcamp As Boolean = False
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Reader As OdbcDataReader

                Dim CmdString2 = "SELECT * FROM soortgroepen_ids where soortmixid = " + Str(soortid) + " AND id = 1"
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Reader = Cmd2.ExecuteReader()
                If Reader.HasRows Then
                    soortgroepcamp = True
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (soortgroepsearch)" + ex.Message)
            MessageBox.Show("Database fout: (soortgroepsearch)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return soortgroepcamp
    End Function
    Private Function BerekenBoektijd(ByVal edi_datum As Date, ByVal westland As Boolean) As Date
        Dim boektijd As Date

        'Dim datum As String = edi_datum.ToShortDateString
        Dim dag As Integer = edi_datum.DayOfWeek
        If dag = 0 Then dag = 7 'zondag
        Dim uur As Integer = Val(Format(edi_datum, "HH"))
        Dim minuut As Integer = Val(Format(edi_datum, "mm"))
        If minuut > 30 Then uur = uur + 1
        Dim fc_uur As String = "12:00"
        Dim fc_datum As String = ""
        Dim veiling As Integer
        If westland = True Then
            veiling = 1
        Else
            veiling = 2
        End If

        'fetch dag data from database
        Dim checked(8) As Boolean
        Dim check_tijd(8) As Integer
        Dim subdag(8) As Integer
        Dim boek_tijd(8) As String

        checked(1) = True    'defaults
        check_tijd(1) = 24
        subdag(1) = 0
        boek_tijd(1) = "12:00"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand("SELECT * FROM vervoerstijden WHERE weekdag=? AND veiling=?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", dag)
                Cmd.Parameters.AddWithValue("", veiling)
                Reader = Cmd.ExecuteReader()
                Dim positie As Integer = 1
                Do While Reader.Read
                    checked(positie) = CHbool(Reader("checked"))
                    If checked(positie) = True Then
                        check_tijd(positie) = CHint(Reader("checktijd"))
                        subdag(positie) = CHint(Reader("subdag"))
                        boek_tijd(positie) = CHstr(Reader("boektijd"))
                    End If
                    positie = positie + 1
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom vervoerstijden)" + ex.Message)
            MessageBox.Show("Database fout: (florecom vervoerstijden)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        If checked(1) = True And uur < check_tijd(1) Then
            edi_datum = DateAdd("d", subdag(1), edi_datum)
            fc_uur = boek_tijd(1)
        ElseIf checked(2) = True And uur < check_tijd(2) Then
            edi_datum = DateAdd("d", subdag(2), edi_datum)
            fc_uur = boek_tijd(2)
        ElseIf checked(3) = True And uur < check_tijd(3) Then
            edi_datum = DateAdd("d", subdag(3), edi_datum)
            fc_uur = boek_tijd(3)
        ElseIf checked(4) = True And uur < check_tijd(4) Then
            edi_datum = DateAdd("d", subdag(4), edi_datum)
            fc_uur = boek_tijd(4)
        ElseIf checked(5) = True And uur < check_tijd(5) Then
            edi_datum = DateAdd("d", subdag(5), edi_datum)
            fc_uur = boek_tijd(5)
        ElseIf checked(6) = True And uur < check_tijd(6) Then
            edi_datum = DateAdd("d", subdag(6), edi_datum)
            fc_uur = boek_tijd(6)
        ElseIf checked(7) = True And uur < check_tijd(7) Then
            edi_datum = DateAdd("d", subdag(7), edi_datum)
            fc_uur = boek_tijd(7)
        End If


        'Select Case dag
        '    Case 1  'maandag
        '        If westland = True Then
        '            If uur < 10 Then
        '                edi_datum = DateAdd("d", -3, edi_datum)  '3 dagen eraf
        '                fc_uur = "18:00"
        '            ElseIf uur < 13 Then
        '                fc_uur = "9:00"
        '            ElseIf uur < 18 Then
        '                fc_uur = "12:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "17:00"
        '            End If
        '        Else
        '            If uur < 12 Then
        '                edi_datum = DateAdd("d", -3, edi_datum)  '3 dagen eraf
        '                fc_uur = "18:00"
        '            ElseIf uur < 16 Then
        '                fc_uur = "9:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "12:00"
        '            End If
        '        End If

        '    Case 2  'dinsdag 
        '        If westland = True Then
        '            If uur < 10 Then
        '                edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '                fc_uur = "17:00"
        '            ElseIf uur < 13 Then
        '                fc_uur = "9:00"
        '            ElseIf uur < 18 Then
        '                fc_uur = "12:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "17:00"
        '            End If
        '        Else
        '            If uur < 12 Then
        '                edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '                fc_uur = "17:00"
        '            ElseIf uur < 16 Then
        '                fc_uur = "9:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "12:00"
        '            End If
        '        End If

        '    Case 3   'woensdag
        '        If westland = True Then
        '            If uur < 13 Then
        '                edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '                fc_uur = "17:00"
        '            ElseIf uur < 18 Then
        '                fc_uur = "12:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "17:00"
        '            End If
        '        Else
        '            If uur < 16 Then
        '                edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '                fc_uur = "17:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "12:00"
        '            End If
        '        End If

        '    Case 4  'donderdag 
        '        If westland = True Then
        '            If uur < 13 Then
        '                edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '                fc_uur = "17:00"
        '            ElseIf uur < 18 Then
        '                fc_uur = "12:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "17:00"
        '            End If
        '        Else
        '            If uur < 16 Then
        '                edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '                fc_uur = "17:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "12:00"
        '            End If
        '        End If

        '    Case 5  'vrijdag
        '        If westland = True Then
        '            If uur < 13 Then
        '                edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '                fc_uur = "17:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "12:00"
        '            End If
        '        Else
        '            If uur < 16 Then
        '                edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '                fc_uur = "17:00"
        '            ElseIf uur < 24 Then
        '                fc_uur = "12:00"
        '            End If
        '        End If

        '    Case 6  'zaterdag
        '        edi_datum = DateAdd("d", -1, edi_datum)  '1 dag eraf
        '        fc_uur = "12:00"
        '    Case 0  'zondag
        '        edi_datum = DateAdd("d", -2, edi_datum)  '2 dagen eraf
        '        fc_uur = "18:00"

        'End Select
        fc_datum = edi_datum.ToShortDateString

        boektijd = Date.Parse(fc_datum + " " + fc_uur)

        If boektijd < Now Then
            Dim boekdatum = Now.ToShortDateString
            Dim currenttime As Integer = Val(Format(Now, "HH"))
            Dim currentboektime As String = "12:00"
            If currenttime <= 9 Then
                currentboektime = "9:00"
            ElseIf currenttime <= 12 Then
                currentboektime = "12:00"
            ElseIf currenttime <= 15 Then
                If Now.DayOfWeek = 5 Then
                    MsgBox("Letop, deze order moet vandaag nog worden gemaakt!", vbOKOnly)
                End If
                currentboektime = "17:00"
            ElseIf currenttime <= 24 Then
                MsgBox("Letop, deze order moet vandaag nog worden gemaakt!", vbOKOnly)
                currentboektime = "17:00"
            End If

            Dim weekendtest As Integer = Now.DayOfWeek
            If weekendtest = 0 Then 'zondag 
                boekdatum = DateAdd("d", 1, boekdatum)
            End If
            If weekendtest = 6 Then 'zaterdag 
                boekdatum = DateAdd("d", 2, boekdatum)
            End If
            boektijd = Date.Parse(boekdatum + " " + currentboektime)
        End If


        Return boektijd
    End Function
    Private Sub GenerateLabelsInFlorecom()
        Dim labelnr As Integer = 0
        Dim aantal_boek As Integer = 0
        Dim labelnummer As Integer = 0
        Dim soort_id As Integer = -1
        Dim fust_id As Integer = -1
        Dim koper_ean As String = ""
        Dim opmerking As String = ""
        Dim accessoire1 As Integer = 0
        If FC_CurrentEditLine > 0 Then
            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim Reader As OdbcDataReader
                    Dim CmdString = "SELECT * FROM edi2_lines where id = " + Str(FC_CurrentEditLine)
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        soort_id = CHint(Reader("soort_id"))
                        fust_id = CHint(Reader("BoekFustId"))
                        koper_ean = CHstr(Reader("NAD_BY_EAN"))
                        opmerking = CHstr(Reader("OpmerkingBoek"))
                        labelnummer = CHint(Reader("label_nummer"))
                        aantal_boek = CHint(Reader("aantal"))
                        accessoire1 = CHint(Reader("accessoire1"))
                    End If
                End Using
                Dim kopernaam As String = ReadSQLString("klantenlijst", "GLN_Company_address_code", koper_ean, "company_name")
            Catch ex As Exception
                ErrorLog("Database fout: (florecom read data soorid)" + ex.Message)
                MessageBox.Show("Database fout: (florecom read soortid)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

        End If


        Dim koper_naam As String = ""
        Dim row As Integer = -1

        If aantal_boek <= 0 Then
            MsgBox("Het aantal planten moet bekend zijn")
            Exit Sub
        End If

        Dim soort As String = soorten(GID(soorten, soort_id)).soortnaam


        Dim accessoire1naam As String = ""
        If accessoire(GID(accessoire, accessoire1)).fust > 0 Then
            accessoire1naam = accessoire(GID(accessoire, accessoire1)).naam
        End If

        LabelWindow.Init(labelnummer, soort_id, aantal_boek, fust_id, row, koper_ean, koper_naam, opmerking, accessoire1naam, 1)

        LabelWindow.Show()
        'global labeledit

    End Sub

    Private Sub Fc_Flexgrid_LineData_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Fc_Flexgrid_LineData.Click
        If Fc_Flexgrid_LineData.Rows.Count > 1 Then

            If Fc_Flexgrid_LineData.Col = 1 And Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 0) <> "" Then
                Dim linecode As String = Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 0)
                Select Case linecode

                    '' Opmerking copieren naar opmerking boek als op kolom 1 wordt geclickt

                    Case "OPM1"
                        SaveLineData("OpmerkingBoek", Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2))
                        For i = 1 To Fc_Flexgrid_LineData.Rows.Count - 1
                            If Fc_Flexgrid_LineData.Item(i, 0) = "OPMB" Then
                                Fc_Flexgrid_LineData.Item(i, 2) = Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2)
                                Exit For
                            End If
                        Next

                    Case "OPM2"
                        SaveLineData("OpmerkingBoek", Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2))
                        For i = 1 To Fc_Flexgrid_LineData.Rows.Count - 1
                            If Fc_Flexgrid_LineData.Item(i, 0) = "OPMB" Then
                                Fc_Flexgrid_LineData.Item(i, 2) = Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2)
                                Exit For
                            End If
                        Next


                    Case "OPM3"
                        SaveLineData("OpmerkingBoek", Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2))
                        For i = 1 To Fc_Flexgrid_LineData.Rows.Count - 1
                            If Fc_Flexgrid_LineData.Item(i, 0) = "OPMB" Then
                                Fc_Flexgrid_LineData.Item(i, 2) = Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2)
                                Exit For
                            End If
                        Next

                    Case "OPM4"
                        SaveLineData("OpmerkingBoek", Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2))
                        For i = 1 To Fc_Flexgrid_LineData.Rows.Count - 1
                            If Fc_Flexgrid_LineData.Item(i, 0) = "OPMB" Then
                                Fc_Flexgrid_LineData.Item(i, 2) = Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2)
                                Exit For
                            End If
                        Next

                End Select
            End If


            If Fc_Flexgrid_LineData.Col = 2 And Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 0) <> "" Then


                Dim linecode As String = Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 0)

                If linecode = "LABELGEN" Then
                    GenerateLabelsInFlorecom()
                    Exit Sub
                End If

                If linecode = "PASPOORT" Then
                    Try
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()
                            If Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2) = "Ja" Then
                                Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2) = "Nee"
                                Dim Cmd17 As New OdbcCommand("UPDATE edi2_lines SET Label_referentie ='' WHERE id =?", Conn)
                                Cmd17.Parameters.Clear()
                                Cmd17.Parameters.AddWithValue("", FC_CurrentEditLine)
                                Cmd17.ExecuteNonQuery()
                            Else
                                Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2) = "Ja"
                                Dim Cmd17 As New OdbcCommand("UPDATE edi2_lines SET Label_referentie ='paspoort' WHERE id =?", Conn)
                                Cmd17.Parameters.Clear()
                                Cmd17.Parameters.AddWithValue("", FC_CurrentEditLine)
                                Cmd17.ExecuteNonQuery()

                            End If
                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: (florecom save paspoort)" + ex.Message)
                        MessageBox.Show("Database fout: (florecom save paspoort)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try

                End If

                '***************************************************
                ' COMBO invullen als er op geclicked wordt
                ' Create the custom editor.
                '***************************************************
                Dim style As C1.Win.C1FlexGrid.CellStyle = Fc_Flexgrid_LineData.Styles.Add("newGridStyle")
                Fc_LineCombo.DataMode = C1.Win.C1List.DataModeEnum.Normal

                Dim dt_fc As New DataTable
                dt_fc.Columns.Add("Naam", GetType(String))
                dt_fc.Columns.Add("Code", GetType(String))

                Dim cn() As String = New String() {"Naam", "Code"}
                dt_fc.Clear()

                '*********** LIJST GENEREREN **************************

                Select Case linecode
                    Case "SOORT"
                        dt_soortmix.DefaultView.Sort = String.Format("volgorde", "DESC")
                        Fc_LineCombo.DataSource = dt_soortmix
                        Fc_LineCombo.DisplayMember = "desc"
                        Fc_LineCombo.ValueMember = "ID"
                        Fc_LineCombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                        Fc_LineCombo.Splits(0).DisplayColumns(2).Visible = False  ' volgorde
                        Fc_LineCombo.ComboStyle = 2  'combo style list
                    Case "ACCE1"
                        Fc_LineCombo.DataSource = dt_accessoire
                        Fc_LineCombo.DisplayMember = "desc"
                        Fc_LineCombo.ValueMember = "ID"
                        Fc_LineCombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                        Fc_LineCombo.ComboStyle = 2  'combo style list
                    Case "ACCE2"
                        Fc_LineCombo.DataSource = dt_accessoire
                        Fc_LineCombo.DisplayMember = "desc"
                        Fc_LineCombo.ValueMember = "ID"
                        Fc_LineCombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                        Fc_LineCombo.ComboStyle = 2  'combo style list
                    Case "ACCE3"
                        Fc_LineCombo.DataSource = dt_accessoire
                        Fc_LineCombo.DisplayMember = "desc"
                        Fc_LineCombo.ValueMember = "ID"
                        Fc_LineCombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                        Fc_LineCombo.ComboStyle = 2  'combo style list
                    Case "WPSFILTER"

                        If FC_CurrentEditLine > 0 Then
                            Dim soort_id = 0
                            Try
                                Using Conn As New OdbcConnection(ConnString)
                                    Conn.Open()
                                    Dim Reader As OdbcDataReader
                                    Dim CmdString = "SELECT soort_id FROM edi2_lines where id = " + Str(FC_CurrentEditLine)
                                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                                    Reader = Cmd.ExecuteReader()
                                    If Reader.HasRows Then
                                        Reader.Read()
                                        soort_id = CHint(Reader("soort_id"))

                                    End If
                                End Using
                            Catch ex As Exception
                                ErrorLog("Database fout: (florecom read data soorid)" + ex.Message)
                                MessageBox.Show("Database fout: (florecom read soortid)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                            End Try

                            Dim wps_soort_id = soorten(GID(soorten, soort_id)).wps_code
                            Dim potmaat = soorten(GID(soorten, soort_id)).potmaat

                            Dim filterfound As Boolean = False
                            For i = 0 To UBound(wpsfilter)
                                If potmaat = 190 Then potmaat = 170
                                If wps_soort_id = wpsfilter(i).wps_soortnummer And potmaat = wpsfilter(i).potmaat Then
                                    dt_fc.Rows.Add(New String() {wpsfilter(i).filternaam, wpsfilter(i).filternummer})
                                End If
                            Next i
                            If filterfound = False And soort_id < 10000 Then
                                dt_fc.Rows.Add(New String() {999999, "Niet via WPS"})
                            End If



                            Fc_LineCombo.DataSource = dt_fc
                            Fc_LineCombo.DisplayMember = "Naam"
                            Fc_LineCombo.ValueMember = "Code"
                            Fc_LineCombo.Splits(0).DisplayColumns(1).Visible = False  ' id
                            Fc_LineCombo.ComboStyle = 2  'combo style list
                        End If
                    Case "PRIJSAANBOD"
                        If jenptenhave = True Then
                            Dim koper_ean As String = ""
                            Dim soortid = 0
                            Try
                                Using Conn As New OdbcConnection(ConnString)
                                    Conn.Open()
                                    Dim Reader As OdbcDataReader
                                    Dim CmdString = "SELECT soort_id, NAD_BY_EAN FROM edi2_lines where id = " + Str(FC_CurrentEditLine)
                                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                                    Reader = Cmd.ExecuteReader()
                                    If Reader.HasRows Then
                                        Reader.Read()
                                        soortid = CHint(Reader("soort_id"))
                                        koper_ean = CHstr(Reader("NAD_BY_EAN"))
                                    End If
                                End Using
                            Catch ex As Exception
                                ErrorLog("Database fout: (florecom read data soorid)" + ex.Message)
                                MessageBox.Show("Database fout: (florecom read soortid)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                            End Try

                            'prijslijst J&P doorspitten

                            Dim jpsoort As Integer = 0
                            Dim jpaccessoire1 As Integer = 0
                            Dim jpaccessoire2 As Integer = 0
                            Dim jpfust As Integer = 0
                            Dim jpprijs As Integer = 0
                            Dim jphoes As Integer = 0
                            Dim jpkorting As Integer = 0
                            Dim jpomschrijving As String = ""
                            Dim soortprijs As Double = 0
                            'zoeken in klantgroepen groter als decorum (1)
                            Dim kortingfound As Boolean = False
                            For i = 1 To UBound(prijslijst)
                                If prijslijst(i).kopersgroep > 1 And soortid = prijslijst(i).soort Then
                                    Dim kopersgroepid As Integer = prijslijst(i).kopersgroep
                                    For k = 1 To UBound(kopergroepEANs)
                                        If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                                            'koper gevonden in kopersgroep 
                                            Dim findid As Integer = i
                                            jpsoort = prijslijst(findid).soort
                                            jpaccessoire1 = prijslijst(findid).accessoire1
                                            jpaccessoire2 = prijslijst(findid).accessoire2
                                            jpfust = prijslijst(findid).fust
                                            jphoes = prijslijst(findid).hoes
                                            jpprijs = prijslijst(findid).prijs
                                            jpomschrijving = prijslijst(findid).omschrijving

                                            soortprijs = (jpprijs - jpkorting) / 100
                                            dt_fc.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})
                                        End If
                                    Next
                                End If
                            Next

                            'zoeken in klantgroepen decorum (1)
                            kortingfound = False
                            For i = 1 To UBound(prijslijst)
                                If prijslijst(i).kopersgroep = 1 And soortid = prijslijst(i).soort Then
                                    Dim kopersgroepid As Integer = 1
                                    For k = 1 To UBound(kopergroepEANs)
                                        If kopergroepEANs(k).id = kopersgroepid And kopergroepEANs(k).ean = koper_ean Then
                                            'koper gevonden in kopersgroep 
                                            Dim findid As Integer = i
                                            jpsoort = prijslijst(findid).soort
                                            jpaccessoire1 = prijslijst(findid).accessoire1
                                            jpaccessoire2 = prijslijst(findid).accessoire2
                                            jpfust = prijslijst(findid).fust
                                            jphoes = prijslijst(findid).hoes
                                            jpprijs = prijslijst(findid).prijs
                                            jpomschrijving = prijslijst(findid).omschrijving

                                            soortprijs = (jpprijs - jpkorting) / 100
                                            dt_fc.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})
                                        End If
                                    Next
                                End If
                            Next

                            'zoeken in totaal aanbod
                            kortingfound = False
                            For i = 1 To UBound(prijslijst)
                                If soortid = prijslijst(i).soort Then

                                    If prijslijst(i).kopersgroep = 0 Then
                                        '(kopersgroep = 0 : Algemeen aanbod)
                                        Dim findid As Integer = i
                                        jpsoort = prijslijst(findid).soort
                                        jpaccessoire1 = prijslijst(findid).accessoire1
                                        jpaccessoire2 = prijslijst(findid).accessoire2
                                        jpfust = prijslijst(findid).fust
                                        jphoes = prijslijst(findid).hoes
                                        jpprijs = prijslijst(findid).prijs
                                        jpomschrijving = prijslijst(findid).omschrijving
                                        soortprijs = (jpprijs - jpkorting) / 100
                                        dt_fc.Rows.Add(New String() {Format(soortprijs, "#.00"), jpomschrijving})


                                    End If
                                End If

                            Next


                        End If
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo
                        '
                    Case "PRIJS"
                        Dim edi_prijs As Double = CVal(Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 2))
                        If edi_prijs = 0 Then edi_prijs = 1.0
                        For prijsloop = edi_prijs - 0.2 To edi_prijs + 0.2 Step 0.01
                            If prijsloop >= 0 Then
                                dt_fc.Rows.Add(New String() {Format(prijsloop, "#0.00"), prijsloop})
                            End If
                        Next
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo

                    Case "EDIFUST"
                        For fustloop = 1 To UBound(fust) - 1
                            dt_fc.Rows.Add(New String() {fust(fustloop).fustnaam, fust(fustloop).fustcode})
                        Next
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 2  'combo style list
                    Case "AANTALPERFUST"
                        For aloop = 1 To 25
                            dt_fc.Rows.Add(New String() {aloop, aloop})
                        Next
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo

                    Case "BOEKFUST"
                        Fc_LineCombo.DataSource = dt_fust
                        Fc_LineCombo.DisplayMember = "desc"
                        Fc_LineCombo.ValueMember = "ID"
                        Fc_LineCombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                        Fc_LineCombo.ComboStyle = 2  'combo style list
                    Case "AANTAL"
                        For aloop = 1 To 50
                            dt_fc.Rows.Add(New String() {aloop, aloop})
                        Next
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo
                    Case "AANTALBOEK"
                        For aloop = 1 To 50
                            dt_fc.Rows.Add(New String() {aloop, aloop})
                        Next
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo
                    Case "OPM1"
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Reader As OdbcDataReader
                                Dim CmdString = "SELECT * FROM opmerkingen where type='0'"
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                Reader = Cmd.ExecuteReader()
                                Do While Reader.Read
                                    Dim opmerking As String = CHstr(Reader("opmerking"))
                                    dt_fc.Rows.Add(New String() {opmerking, opmerking})
                                Loop
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (florecom read data opm1)" + ex.Message)
                            MessageBox.Show("Database fout: (florecom read data opm1)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo
                    Case "OPM2"
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Reader As OdbcDataReader
                                Dim CmdString = "SELECT * FROM opmerkingen where type = '0'"
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                Reader = Cmd.ExecuteReader()
                                Do While Reader.Read
                                    Dim opmerking As String = CHstr(Reader("opmerking"))
                                    dt_fc.Rows.Add(New String() {opmerking, opmerking})
                                Loop
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (florecom read data opm2)" + ex.Message)
                            MessageBox.Show("Database fout: (florecom read data opm2)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo
                    Case "OPM3"
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Reader As OdbcDataReader
                                Dim CmdString = "SELECT * FROM opmerkingen where type='0'"
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                Reader = Cmd.ExecuteReader()
                                Do While Reader.Read
                                    Dim opmerking As String = CHstr(Reader("opmerking"))
                                    dt_fc.Rows.Add(New String() {opmerking, opmerking})
                                Loop
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (florecom read data opm3)" + ex.Message)
                            MessageBox.Show("Database fout: (florecom read data opm3)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo
                    Case "OPM4"
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Reader As OdbcDataReader
                                Dim CmdString = "SELECT * FROM opmerkingen where type = '0'"
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                Reader = Cmd.ExecuteReader()
                                Do While Reader.Read
                                    Dim opmerking As String = CHstr(Reader("opmerking"))
                                    dt_fc.Rows.Add(New String() {opmerking, opmerking})
                                Loop
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (florecom read data opm4)" + ex.Message)
                            MessageBox.Show("Database fout: (florecom read data opm4)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo
                    Case "OPMB"
                        Try
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()
                                Dim Reader As OdbcDataReader
                                Dim CmdString = "SELECT * FROM opmerkingen where type = '1'"
                                Dim Cmd As New OdbcCommand(CmdString, Conn)
                                Reader = Cmd.ExecuteReader()
                                Do While Reader.Read
                                    Dim opmerking As String = CHstr(Reader("opmerking"))
                                    dt_fc.Rows.Add(New String() {opmerking, opmerking})
                                Loop
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (florecom read data opm2)" + ex.Message)
                            MessageBox.Show("Database fout: (florecom read data opm2)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                        End Try
                        Fc_LineCombo.DataSource = dt_fc
                        Fc_LineCombo.DisplayMember = "Naam"
                        Fc_LineCombo.ValueMember = "Code"
                        Fc_LineCombo.ComboStyle = 0  'combo style combo
                    Case "KAR"
                        Fc_LineCombo.DataSource = dt_kar
                        Fc_LineCombo.DisplayMember = "desc"
                        Fc_LineCombo.ValueMember = "ID"
                        Fc_LineCombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                        Fc_LineCombo.ComboStyle = 2  'combo style list

                End Select
                If Mid(linecode, 1, 3) = "CCI" Then
                    Dim cci = Mid(linecode, 5, 3)
                    Try
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()
                            Dim Reader As OdbcDataReader
                            Dim CmdString = "SELECT * FROM sort_elementen where sort_element_code = '" + cci + "'"
                            Dim Cmd As New OdbcCommand(CmdString, Conn)
                            Reader = Cmd.ExecuteReader()
                            Do While Reader.Read
                                Dim desc As String = CHstr(Reader("sort_element_value_description"))
                                Dim value As String = CHstr(Reader("sort_element_value"))
                                dt_fc.Rows.Add(New String() {desc, value})
                            Loop
                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: (florecom read data cci)" + ex.Message)
                        MessageBox.Show("Database fout: (florecom read data cci)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try
                    Fc_LineCombo.DataSource = dt_fc
                    Fc_LineCombo.DisplayMember = "Naam"
                    Fc_LineCombo.ValueMember = "Code"
                    Fc_LineCombo.ComboStyle = 2  'combo style list
                End If

                Fc_LineCombo.DropDownWidth = 400
                Fc_LineCombo.ColumnWidth = 390
                Fc_LineCombo.MaxDropDownItems = 15

                style.Editor = Fc_LineCombo
                Fc_Flexgrid_LineData.SetCellStyle(Fc_Flexgrid_LineData.Row, 2, style)
                Fc_Flexgrid_LineData.StartEditing(Fc_Flexgrid_LineData.Row, 2)

                Fc_LineCombo.DroppedDown = True

            End If
        End If
    End Sub
    Private Sub Fc_Flexgrid_LineData_MouseDown(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles Fc_Flexgrid_LineData.MouseDown
        'toolstrip
        If Fc_Flexgrid_LineData.Rows.Count > 1 And e.Button = MouseButtons.Right Then
            Me.Florecom_MenuStrip.Show(Me.Fc_Flexgrid_LineData, e.Location)
        End If
    End Sub
    Private Sub Fc_LineCombo_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles Fc_LineCombo.Validated
        Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 3) = Fc_LineCombo.SelectedValue
        If FC_CurrentEditLine > 0 Then
            Dim linecode As String = Fc_Flexgrid_LineData.Item(Fc_Flexgrid_LineData.Row, 0)

            Select Case linecode
                Case "SOORT"
                    SaveLineData("Soort_Id", Fc_LineCombo.SelectedValue)
                    SetOrderLines(FC_CurrentEditOrder)
                    ShowLineData(FC_CurrentEditLine, True)
                Case "ACCE1"
                    SaveLineData("Accessoire1", Fc_LineCombo.SelectedValue)
                    SetOrderLines(FC_CurrentEditOrder)
                    ShowLineData(FC_CurrentEditLine, True)
                Case "ACCE2"
                    SaveLineData("Accessoire2", Fc_LineCombo.SelectedValue)
                    SetOrderLines(FC_CurrentEditOrder)
                    ShowLineData(FC_CurrentEditLine)
                Case "ACCE3"
                    SaveLineData("Hoes", Fc_LineCombo.SelectedValue)
                    'SetOrderLines(FC_CurrentEditOrder)
                    ShowLineData(FC_CurrentEditLine, True)
                Case "WPSFILTER"
                    Dim wpsfilter As String = Str(Val(Fc_LineCombo.SelectedValue))
                    SaveLineData("wps_filternr", wpsfilter)
                    SetOrderLines(FC_CurrentEditOrder)
                    ShowLineData(FC_CurrentEditLine, True)
                Case "PRIJS"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        'Dim prijsstr As String = Fc_LineCombo.SelectedValue
                        If CVal(Fc_LineCombo.SelectedValue) > 0 Then
                            SaveLineData("PRI_INV_Price_Amount", pformatprijs(Fc_LineCombo.SelectedValue, 2))
                        Else
                            MsgBox("Fout:  Prijs <= 0")
                        End If
                    Else
                        If CVal(Fc_LineCombo.Text) > 0 Then
                            Dim puntpos As Integer = InStr(Fc_LineCombo.Text, ".")
                            If puntpos > 0 Then
                                Fc_LineCombo.Text = Mid(Fc_LineCombo.Text, 1, puntpos - 1) + "," + Mid(Fc_LineCombo.Text, puntpos + 1, 3)
                            End If
                            SaveLineData("PRI_INV_Price_Amount", pformatprijs(Fc_LineCombo.Text, 2))
                        Else
                            MsgBox("Fout:  Prijs <= 0")
                        End If
                    End If
                Case "EDIFUST"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("PAC_Fust_Code", Fc_LineCombo.SelectedValue)
                    Else
                        If Val(Fc_LineCombo.Text) > 0 Then
                            SaveLineData("PAC_Fust_Code", Val(Fc_LineCombo.Text))
                        End If
                    End If
                    SetOrderLines(FC_CurrentEditOrder)
                    ShowLineData(FC_CurrentEditLine, True)
                Case "AANTALPERFUST"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("MEA_Aantal_per_Fust", Fc_LineCombo.SelectedValue)
                    Else
                        If Val(Fc_LineCombo.Text) > 0 Then
                            SaveLineData("MEA_Aantal_per_Fust", Val(Fc_LineCombo.Text))
                        Else
                            MsgBox("Fout:  Aantal <= 0")
                        End If
                    End If
                    SetOrderLines(FC_CurrentEditOrder)
                    ShowLineData(FC_CurrentEditLine, True)
                Case "BOEKFUST"
                    SaveLineData("BoekFustID", Fc_LineCombo.SelectedValue)
                    Dim fustId As Integer = Fc_LineCombo.SelectedValue
                    Dim AantalPerFust As Integer = fust(GID(fust, fustId)).aantal_per_fust
                    Dim aantal As Integer = 0
                    'aantal herberekenen
                    Try
                        Using Conn As New OdbcConnection(ConnString)
                            Conn.Open()

                            Dim Reader As OdbcDataReader
                            Dim CmdString2 = "SELECT * FROM edi2_lines where id = " + Str(FC_CurrentEditLine)
                            Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                            Reader = Cmd2.ExecuteReader()
                            Dim QTY_Unit_Code As Integer = 0
                            Dim QTY_Quantity As Integer = 0
                            If Reader.HasRows Then
                                Reader.Read()
                                QTY_Unit_Code = CHint(Reader("QTY_Unit_Code"))
                                QTY_Quantity = CHint(Reader("QTY_Quantity"))
                            End If
                            Reader.Close()
                            If QTY_Unit_Code = 1 And AantalPerFust > 0 Then
                                aantal = Int((QTY_Quantity / AantalPerFust) + 0.5)
                                Cmd2.CommandText = "UPDATE edi2_lines SET aantal ='" + Str(aantal) + "' WHERE id = " + Str(FC_CurrentEditLine)
                                Cmd2.ExecuteNonQuery()
                            End If
                        End Using
                    Catch ex As Exception
                        ErrorLog("Database fout: Save Nieuw aantal)" + ex.Message)
                        MessageBox.Show("Database fout: Save Nieuw aantal " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                    End Try

                    SetOrderLines(FC_CurrentEditOrder)
                    ShowLineData(FC_CurrentEditLine, True)
                Case "KAR"
                    SaveLineData("BoekKarId", Fc_LineCombo.SelectedValue)
                Case "AANTAL"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("QTY_Quantity", Str(Fc_LineCombo.SelectedValue))
                    Else
                        If Val(Fc_LineCombo.Text) > 0 Then
                            SaveLineData("QTY_Quantity", Str(Fc_LineCombo.Text))
                        Else
                            MsgBox("Fout:  Aantal <= 0")
                        End If
                    End If
                Case "AANTALBOEK"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("Aantal", Str(Fc_LineCombo.SelectedValue))
                        SetOrderLines(FC_CurrentEditOrder)
                        ShowLineData(FC_CurrentEditLine, True)
                    Else
                        If Val(Fc_LineCombo.Text) > 0 Then
                            SaveLineData("Aantal", Fc_LineCombo.Text)
                            SetOrderLines(FC_CurrentEditOrder)
                            ShowLineData(FC_CurrentEditLine, True)
                        Else
                            MsgBox("Fout:  Aantal <= 0")
                        End If
                    End If
                Case "OPM1"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("FTX_Text_Literal_1", Fc_LineCombo.SelectedValue)
                    Else
                        SaveLineData("FTX_Text_Literal_1", Fc_LineCombo.Text)
                    End If
                Case "OPM2"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("FTX_Text_Literal_2", Fc_LineCombo.SelectedValue)
                    Else
                        SaveLineData("FTX_Text_Literal_2", Fc_LineCombo.Text)
                    End If
                Case "OPM3"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("FTX_COI_Text_Literal_1", Fc_LineCombo.SelectedValue)
                    Else
                        SaveLineData("FTX_COI_Text_Literal_1", Fc_LineCombo.Text)
                    End If
                Case "OPM4"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("FTX_COI_Text_Literal_2", Fc_LineCombo.SelectedValue)
                    Else
                        SaveLineData("FTX_COI_Text_Literal_2", Fc_LineCombo.Text)
                    End If
                Case "OPMB"
                    If Val(Fc_LineCombo.SelectedValue) > 0 Then
                        SaveLineData("OpmerkingBoek", Fc_LineCombo.SelectedValue)
                    Else
                        SaveLineData("OpmerkingBoek", Fc_LineCombo.Text)
                    End If

            End Select

            If Mid(linecode, 1, 3) = "CCI" Then
                Dim selectedcci = Mid(linecode, 5, 3)

                Try
                    Using Conn As New OdbcConnection(ConnString)
                        Conn.Open()

                        Dim Reader As OdbcDataReader
                        Dim CmdString2 = "SELECT * FROM edi2_lines where id = " + Str(FC_CurrentEditLine)
                        Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                        Reader = Cmd2.ExecuteReader()
                        If Reader.HasRows Then
                            Reader.Read()
                            'read cci
                            Dim CCICAVString As String = CHstr(Reader("CCICAV"))
                            Reader.Close()
                            Dim CCICAV() As String = Microsoft.VisualBasic.Strings.Split(CCICAVString, "*")
                            Dim CCICAVString2 = ""
                            'change cci
                            For i = 0 To UBound(CCICAV) - 1
                                Dim cci = Mid(CCICAV(i), 1, 3)
                                Dim cav = Mid(CCICAV(i), 5, 3)
                                If cci = selectedcci Then
                                    cav = Fc_LineCombo.SelectedValue
                                End If
                                CCICAVString2 = CCICAVString2 + cci + ";" + cav + "*"
                            Next i
                            'save cci
                            If CCICAVString <> CCICAVString2 Then
                                Cmd2.CommandText = "UPDATE edi2_lines SET CCICAV ='" + CCICAVString2 + "' WHERE id = " + Str(FC_CurrentEditLine)
                                Cmd2.ExecuteNonQuery()
                            End If

                        End If
                    End Using
                Catch ex As Exception
                    ErrorLog("Database fout: Save CCI)" + ex.Message)
                    MessageBox.Show("Database fout: Save CCI" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                End Try
            End If
        End If
    End Sub

    Private Sub addcontact(ByVal titel As String, ByVal editnaam As String, ByVal waarde As String, ByVal kleur As String)
        Dim fxfill(2) As String
        fxfill(0) = editnaam
        fxfill(1) = titel
        fxfill(2) = waarde
        FC_Flexgrid_contactdata.AddItem(fxfill)
        FC_Flexgrid_contactdata.Styles.Clear()
        Dim rs As C1.Win.C1FlexGrid.CellStyle
        rs = FC_Flexgrid_contactdata.Styles.Add("kleur")
        rs.BackColor = GetColorValue(kleur)
        FC_Flexgrid_contactdata.Rows(FC_Flexgrid_contactdata.Rows.Count - 1).Style = FC_Flexgrid_contactdata.Styles("kleur")
    End Sub
    Private Sub addline(ByVal titel As String, ByVal editnaam As String, ByVal waarde As String, ByVal kleur As String, Optional ByVal value As String = "")

        If FC_CheckRun = True Then
            Exit Sub
        End If

        If titel <> "" And editnaam = "" And waarde = "" Then
            Exit Sub
        End If

        Dim fxfill(3) As String
        fxfill(0) = editnaam
        fxfill(1) = titel
        fxfill(2) = waarde
        If value > "" Then
            '  fxfill(3) = value
        End If
        Fc_Flexgrid_LineData.AddItem(fxfill)
        'Fc_Flexgrid_LineData.Styles.Clear()
        'Dim rs As C1.Win.C1FlexGrid.CellStyle
        'rs = Fc_Flexgrid_LineData.Styles.Add("kleur")
        'rs.BackColor = GetColorValue(kleur)
        'Fc_Flexgrid_LineData.Rows(Fc_Flexgrid_LineData.Rows.Count - 1).Style = Fc_Flexgrid_LineData.Styles("kleur")

        Fc_Flexgrid_LineData.Rows(Fc_Flexgrid_LineData.Rows.Count - 1).Style = Fc_Flexgrid_LineData.Styles(kleur)
    End Sub
    Private Function ReadNAD(ByVal line_id As Integer, ByVal code As String) As NAD
        Dim nd As NAD
        nd.id = 0
        nd.NAD_PartyEAN = "0000000000000"
        nd.CTA1_EAN = ""
        nd.CTA1_NAME = ""
        nd.COM1_TE = ""
        nd.COM1_FX = ""
        nd.CTA2_EAN = ""
        nd.CTA2_NAME = ""
        nd.COM2_TE = ""
        nd.COM2_FX = ""
        nd.AGENCY_CODE = 0

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Reader As OdbcDataReader

                Dim CmdString = "SELECT * FROM edi2_lines_nad where edi_line_id = " + Str(line_id) + " AND NAD_Party_Code = '" + Trim(code) + "'"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()

                If Reader.HasRows Then
                    Reader.Read()
                    nd.id = CHint(Reader("id"))
                    nd.NAD_PartyEAN = CHstr(Reader("NAD_Party_ean"))
                    nd.CTA1_EAN = CHstr(Reader("CTA1_EAN"))
                    nd.CTA1_NAME = CHstr(Reader("CTA1_NAME"))
                    nd.COM1_TE = CHstr(Reader("COM1_TE"))
                    nd.COM1_FX = CHstr(Reader("COM1_FX"))
                    nd.CTA2_EAN = CHstr(Reader("CTA2_EAN"))
                    nd.CTA2_NAME = CHstr(Reader("CTA2_NAME"))
                    nd.COM2_TE = CHstr(Reader("COM2_TE"))
                    nd.COM2_FX = CHstr(Reader("COM2_FX"))
                    nd.AGENCY_CODE = CHint(Reader("NAD_Agency_code"))
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom orderlijst NAD)" + ex.Message)
            MessageBox.Show("Database fout: (florecom orderlijst NAD)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return nd
    End Function
    Private Function ReadSQLString(ByVal table As String, ByVal key As String, ByVal value As String, ByVal column As String) As String
        Dim data As String = "fout: key not found"
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Reader As OdbcDataReader

                Dim CmdString = "SELECT * FROM " + table + " where " + key + " = '" + value + "'"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    data = CHstr(Reader(column))
                Else
                    data = "fout: " + key + ":" + value + " not found."
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom read data str)" + ex.Message)
            MessageBox.Show("Database fout: (florecom read data str)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return data
    End Function
    Private Function ReadSQLData_oud(ByVal table As String, ByVal column1 As String, ByVal value1 As String, ByVal column2 As String, ByVal value2 As String, ByVal column As String) As String
        Dim data As String = "fout: key not found"
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Reader As OdbcDataReader

                Dim CmdString = "SELECT * FROM " + table + " where " + column1 + " = '" + value1 + "' AND " + column2 + " = '" + value2 + "'"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    data = CHstr(Reader(column))
                Else
                    data = "fout: " + column2 + ":" + value2 + " not found."
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom read data)" + ex.Message)
            MessageBox.Show("Database fout: (florecom read data)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return data
    End Function
    Private Function ReadSQLData(ByVal table As String, ByVal column1 As String, ByVal value1 As String, ByVal column2 As String, ByVal value2 As String, ByVal column As String) As String
        Dim data As String = "fout: key not found"
        Select Case table
            Case "data_elementen"
                For i = 0 To UBound(dataelementen)
                    If dataelementen(i).code = value1 And dataelementen(i).value = value2 Then
                        data = dataelementen(i).description
                        Exit For
                    End If
                Next
            Case "sort_elementen"
                For i = 0 To UBound(sortelementen)
                    If sortelementen(i).code = value1 And sortelementen(i).value = value2 Then
                        data = sortelementen(i).description
                        Exit For
                    End If
                Next


        End Select
        Return data
    End Function

    Public Sub SaveLineData(ByVal key As String, ByVal value As Object)
        If FC_CurrentEditLine >= 0 Then
            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Dim CmdString = "SELECT id FROM edi2_lines where 1=0"
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Cmd.CommandText = "UPDATE edi2_lines SET " + key + "='" + value + "' WHERE id = " + Str(FC_CurrentEditLine)
                    Cmd.ExecuteNonQuery()
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (florecom save data)" + ex.Message)
                MessageBox.Show("Database fout: (florecom save data)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        End If
    End Sub

    Private Sub FC_Toolstrip_Opmerking_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FC_Toolstrip_Opmerking.Click
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim opmerking1 As String = ""
                Dim opmerking2 As String = ""
                Dim koper_ean As String = ""
                Dim vbn_code As String = ""
                Dim soort_omschrijving As String = ""
                Dim artikelcode_teler As String = ""

                Dim CmdString = "SELECT * FROM edi2_lines where id=" + Str(FC_CurrentEditLine)
                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    opmerking1 = CHstr(Reader("FTX_Text_Literal_1"))
                    opmerking2 = CHstr(Reader("FTX_Text_Literal_2"))
                    koper_ean = CHstr(Reader("NAD_BY_EAN"))
                    vbn_code = CHstr(Reader("LIN_Product_Code"))
                    soort_omschrijving = CHstr(Reader("IMD_Full_Name"))
                    artikelcode_teler = CHstr(Reader("PIA_SA_EAN"))
                End If
                Reader.Close()

                Dim CmdString2 = "SELECT id FROM opmerkingmatch where 1=0"
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Cmd2.CommandText = "INSERT INTO opmerkingmatch(opmerking1,opmerking2,koper_ean,vbn_code,soort_omschrijving,artikelcode_teler) VALUES(?,?,?,?,?,?)"
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", opmerking1)
                Cmd2.Parameters.AddWithValue("", opmerking2)
                Cmd2.Parameters.AddWithValue("", koper_ean)
                Cmd2.Parameters.AddWithValue("", vbn_code)
                Cmd2.Parameters.AddWithValue("", soort_omschrijving)
                Cmd2.Parameters.AddWithValue("", artikelcode_teler)


                Cmd2.ExecuteNonQuery()
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom save opmerkingmatch)" + ex.Message)
            MessageBox.Show("Database fout: (florecom save opmerkingmatch)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Function check_opmerking(ByVal opm1 As String, ByVal opm2 As String, ByVal koper_ean As String, ByVal vbn_code As String, ByVal omschrijving As String, ByVal telercode As String) As Boolean
        Dim check As Boolean = False
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim CmdString = "SELECT id FROM opmerkingmatch where opmerking1='" + opm1 + "' AND opmerking2='" + opm2 + "' AND koper_ean='" + koper_ean + "' AND vbn_code='" + vbn_code + "' AND soort_omschrijving='" + omschrijving + "' AND artikelcode_teler ='" + telercode + "'"

                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    check = True
                End If
                Reader.Close()

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom check opmerkingmatch)" + ex.Message)
            MessageBox.Show("Database fout: (florecom check opmerkingmatch)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return check
    End Function
    Private Sub FC_Toolstrip_SoortOpmerking_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FC_Toolstrip_SoortOpmerking.Click
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim koper_ean As String = ""
                Dim vbn_code As String = ""
                Dim soort_omschrijving As String = ""
                Dim opmerking3 As String = ""
                Dim artikelcode_teler As String = ""
                Dim soortid As Integer = 0
                Dim accessoire1 As Integer = 0
                Dim accessoire2 As Integer = 0
                Dim boekfustid As Integer = 0
                Dim potmaat As Integer = 0
                Dim hoes As Integer = 0
                Dim CmdString = "SELECT * FROM edi2_lines where id=" + Str(FC_CurrentEditLine)
                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    koper_ean = CHstr(Reader("NAD_BY_EAN"))
                    vbn_code = CHstr(Reader("LIN_Product_Code"))
                    soort_omschrijving = CHstr(Reader("IMD_Full_Name"))
                    artikelcode_teler = CHstr(Reader("PIA_SA_EAN"))
                    opmerking3 = CHstr(Reader("FTX_COI_Text_Literal_1"))
                    soortid = CHint(Reader("soort_id"))
                    accessoire1 = CHint(Reader("accessoire1"))
                    accessoire2 = CHint(Reader("accessoire2"))
                    boekfustid = CHint(Reader("boekfustid"))
                    potmaat = CHint(Reader("potmaat"))
                    hoes = CHint(Reader("hoes"))
                End If
                Reader.Close()

                If potmaat = 510 Then
                    potmaat = 105
                Else
                    potmaat = potmaat * 10
                End If

                Dim CmdString2 = "SELECT id FROM soortmatch2 where 1=0"
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Cmd2.CommandText = "INSERT INTO soortmatch3(opmerking3,soortid,accessoire1,accessoire2,koper_ean,vbn_code,IMD_Full_Name,PIA_SA_EAN,fustcode,potmaat,hoes) VALUES(?,?,?,?,?,?,?,?,?,?,?)"
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", Trim(opmerking3))
                Cmd2.Parameters.AddWithValue("", soortid)
                Cmd2.Parameters.AddWithValue("", accessoire1)
                Cmd2.Parameters.AddWithValue("", accessoire2)
                Cmd2.Parameters.AddWithValue("", koper_ean)
                Cmd2.Parameters.AddWithValue("", vbn_code)
                Cmd2.Parameters.AddWithValue("", soort_omschrijving)
                Cmd2.Parameters.AddWithValue("", artikelcode_teler)
                Cmd2.Parameters.AddWithValue("", boekfustid)
                Cmd2.Parameters.AddWithValue("", potmaat)
                Cmd2.Parameters.AddWithValue("", hoes)
                Cmd2.ExecuteNonQuery()
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom save soortmatch)" + ex.Message)
            MessageBox.Show("Database fout: (florecom save soortmatch)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub FC_Toolstrip_Soort_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FC_Toolstrip_Soort.Click
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim koper_ean As String = ""
                Dim vbn_code As String = ""
                Dim soort_omschrijving As String = ""
                Dim artikelcode_teler As String = ""
                Dim soortid As Integer = 0
                Dim accessoire1 As Integer = 0
                Dim accessoire2 As Integer = 0
                Dim boekfustid As Integer = 0
                Dim potmaat As Integer = 11
                Dim hoes As Integer = 0
                Dim CmdString = "SELECT * FROM edi2_lines where id=" + Str(FC_CurrentEditLine)
                Dim Reader As OdbcDataReader
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    koper_ean = CHstr(Reader("NAD_BY_EAN"))
                    vbn_code = CHstr(Reader("LIN_Product_Code"))
                    soort_omschrijving = CHstr(Reader("IMD_Full_Name"))
                    artikelcode_teler = CHstr(Reader("PIA_SA_EAN"))
                    soortid = CHint(Reader("soort_id"))
                    accessoire1 = CHint(Reader("accessoire1"))
                    accessoire2 = CHint(Reader("accessoire2"))
                    boekfustid = CHint(Reader("boekfustid"))
                    potmaat = CHint(Reader("potmaat"))
                    hoes = CHint(Reader("hoes"))
                End If
                Reader.Close()

                If potmaat = 510 Then
                    potmaat = 105
                Else
                    potmaat = potmaat * 10
                End If

                Dim CmdString2 = "SELECT id FROM soortmatch2 where 1=0"
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Cmd2.CommandText = "INSERT INTO soortmatch2(soortid,accessoire1,accessoire2,koper_ean,vbn_code,IMD_Full_Name,PIA_SA_EAN,fustcode,potmaat,hoes) VALUES(?,?,?,?,?,?,?,?,?,?)"
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", soortid)
                Cmd2.Parameters.AddWithValue("", accessoire1)
                Cmd2.Parameters.AddWithValue("", accessoire2)
                Cmd2.Parameters.AddWithValue("", koper_ean)
                Cmd2.Parameters.AddWithValue("", vbn_code)
                Cmd2.Parameters.AddWithValue("", soort_omschrijving)
                Cmd2.Parameters.AddWithValue("", artikelcode_teler)
                Cmd2.Parameters.AddWithValue("", boekfustid)
                Cmd2.Parameters.AddWithValue("", potmaat)
                Cmd2.Parameters.AddWithValue("", hoes)

                Cmd2.ExecuteNonQuery()
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (florecom save soortmatch)" + ex.Message)
            MessageBox.Show("Database fout: (florecom save soortmatch)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub FC_Toolstrip_PrijsKoperSet_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FC_Toolstrip_PrijsKoperSet.Click

        If Fc_Flexgrid_LineData.Rows.Count > 1 Then
            For i = 1 To Fc_Flexgrid_LineData.Rows.Count - 1
                If Fc_Flexgrid_LineData.Col = 1 And Fc_Flexgrid_LineData.Item(i, 0) <> "" Then
                    Dim linecode As String = Fc_Flexgrid_LineData.Item(i, 0)
                    If linecode = "TOTPRIJS" Then
                        Dim prijs As Double = CVal(Fc_Flexgrid_LineData.Item(i, 2))

                        SaveLineData("PRI_INV_Price_Amount", pformatprijs(prijs, 2))
                        ShowLineData(FC_CurrentEditLine, True)
                        Exit For
                    End If
                End If
            Next i


        End If


    End Sub

    Private Sub FcMenu_Verwerk_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FcMenu_Verwerk_but.Click
        VerwerkFlorecom()
    End Sub

    Private Sub FCMenu_Nietverwerken_but_Click(sender As Object, e As EventArgs) Handles FCMenu_Nietverwerken_but.Click
        VerwijderFlorecomOrder()
    End Sub

    Private Sub VerwijderFlorecomOrder()

        FcMenu_Verwerk_but.Enabled = False
        Application.DoEvents()

        If FC_CurrentEditOrder > 0 Then
            'reread all order lines
            SetOrderLines(FC_CurrentEditOrder)
        Else
            GoTo exit_verwerk4
        End If

        'zijn alle lines geaccepteerd etc?

        If FC_Flexgrid_orderlines.Rows.Count > 1 Then
            For i = 1 To FC_Flexgrid_orderlines.Rows.Count - 1
                Dim acceptedstate As Integer = CInt(Val(FC_Flexgrid_orderlines.Item(i, 1)))
                If acceptedstate = 99 Or acceptedstate = 0 Then
                    MsgBox("Een of meerdere orderlines moeten nog bewerkt worden", vbOKOnly)
                    GoTo exit_verwerk4
                End If
            Next i
        Else
            Exit Sub
        End If

        'is de order nog steeds nieuw ? 
        '(orderstatus & linestatus = 0)

        Dim tweedevestiging As Boolean = False
        Dim vestigingnummer As Integer = 0

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'read info from florecom database
                Dim Reader As OdbcDataReader
                Dim CmdString2 = "SELECT * FROM edi2_orders where id = " + Str(FC_CurrentEditOrder)
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Reader = Cmd2.ExecuteReader()
                Dim status As Integer = 0
                Dim koper_ean As String = ""
                If Reader.HasRows Then
                    status = CHint(Reader("Status"))
                    koper_ean = CHstr(Reader("koper_ean"))
                Else
                    MsgBox("Florecom vertaal fout, order niet correct opgeslagen")
                    GoTo exit_verwerk5
                End If
                If status <> 0 Then
                    MsgBox("Deze order is al verwerkt")
                    'SaveOrder = True
                    FcMenu_Verwerk_but.Enabled = True
                    GoTo exit_verwerk5                               '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                End If

                Dim Cmd8 As New OdbcCommand("", Conn)
                Cmd8.CommandText = "UPDATE edi2_lines SET status=3 where ordernr = " + Str(FC_CurrentEditOrder)
                Cmd8.ExecuteNonQuery()

                Cmd8.CommandText = "UPDATE edi2_orders SET status=2 where id = " + Str(FC_CurrentEditOrder)
                Cmd8.ExecuteNonQuery()


exit_verwerk5:
                Reader.Close()
            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag fc check: " + ex.Message)
            MsgBox("Fout orderopslag fc check: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

exit_verwerk4:
        Me.Cursor = Cursors.Default
        'reload florecom list
        LaadNieuweFlorecoms()

        FcMenu_Verwerk_but.Enabled = True

    End Sub

    Private Sub VerwerkFlorecom()

        FcMenu_Verwerk_but.Enabled = False
        Application.DoEvents()

        If FC_CurrentEditOrder > 0 Then
            'reread all order lines
            SetOrderLines(FC_CurrentEditOrder)
        Else
            GoTo exit_verwerk2
        End If

        'zijn alle lines geaccepteerd etc?

        If FC_Flexgrid_orderlines.Rows.Count > 1 Then
            For i = 1 To FC_Flexgrid_orderlines.Rows.Count - 1
                Dim acceptedstate As Integer = CInt(Val(FC_Flexgrid_orderlines.Item(i, 1)))
                If acceptedstate = 99 Or acceptedstate = 0 Then
                    MsgBox("Een of meerdere orderlines moeten nog bewerkt worden", vbOKOnly)
                    GoTo exit_verwerk2
                End If
            Next i
        Else
            Exit Sub
        End If

        'is de order nog steeds nieuw ? 
        '(orderstatus & linestatus = 0)

        Dim tweedevestiging As Boolean = False
        Dim vestigingnummer As Integer = 0

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'read info from florecom database
                Dim Reader As OdbcDataReader
                Dim CmdString2 = "SELECT * FROM edi2_orders where id = " + Str(FC_CurrentEditOrder)
                Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                Reader = Cmd2.ExecuteReader()
                Dim status As Integer = 0
                Dim koper_ean As String = ""
                If Reader.HasRows Then
                    status = CHint(Reader("Status"))
                    koper_ean = CHstr(Reader("koper_ean"))
                Else
                    MsgBox("Florecom vertaal fout, order niet correct opgeslagen")
                    GoTo exit_verwerk2
                End If
                If status <> 0 Then
                    MsgBox("Deze order is al verwerkt")
                    'SaveOrder = True
                    FcMenu_Verwerk_but.Enabled = True
                    GoTo exit_verwerk2                               '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                End If
                Reader.Close()

                

                Dim CmdString4 = "SELECT * FROM edi2_lines where ordernr = " + Str(FC_CurrentEditOrder)
                Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                Reader = Cmd4.ExecuteReader()
                Do While Reader.Read
                    Dim chk_aantal As Integer = CHint(Reader("aantal"))
                    Dim chk_soortid As Integer = CHint(Reader("soort_id"))
                    Dim chk_fustid As Integer = CHint(Reader("BoekfustId"))
                    Dim chk_kar_id As Integer = CHint(Reader("BoekKarId"))
                    Dim chk_status As Integer = CHint(Reader("status"))
                    Dim label_ean As String = CHstr(Reader("PCI_Label_Description_Fust"))
                    Dim label_status As Integer = CHint(Reader("label_status"))
                    Dim chk_Lin_Responce As Integer = CHint(Reader("Lin_Responce"))
                    If (chk_Lin_Responce = 5 Or chk_Lin_Responce = 24 Or chk_Lin_Responce = 999) And chk_status = 0 Then

                        If chk_kar_id < 1 Then
                            MsgBox("Fout bij orderopslag: Kar niet bekend in een van de geaccepteerde orderlines")
                            GoTo exit_verwerk2
                            Exit Sub
                        End If
                        If chk_aantal < 1 Then
                            MsgBox("Fout bij orderopslag: Aantal niet bekend in een van de geaccepteerde orderlines")
                            GoTo exit_verwerk2
                            Exit Sub
                        End If
                        If chk_fustid < 1 Then
                            MsgBox("Fout bij orderopslag: Fust niet bekend in een van de geaccepteerde orderlines")
                            GoTo exit_verwerk2
                            Exit Sub
                        End If
                        If chk_soortid < 1 Then
                            MsgBox("Fout bij orderopslag: Soort niet bekend in een van de geaccepteerde orderlines")
                            GoTo exit_verwerk2
                            Exit Sub
                        End If


                        '2 vestigingen?
                        Dim vestigingline As Integer = 1
                        If chk_soortid < 10000 Then
                            vestigingline = soorten(GID(soorten, chk_soortid)).vestiging  'vestiging van line
                        Else
                            vestigingline = mixen(GID(mixen, chk_soortid - 10000)).vestiging
                        End If

                        If vestigingnummer = 0 Then
                            vestigingnummer = vestigingline
                        End If
                        If vestigingline <> vestigingnummer Then
                            'tweede vestiging gevonden
                            tweedevestiging = True
                        End If


                    End If

                Loop

                Reader.Close()

            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag fc check: " + ex.Message)
            MsgBox("Fout orderopslag fc check: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        'nieuw kopelnummer ophalen zodat orders die over twee vestingingen verdeelt zijn, nog steeds te koppelen zijn
        Dim koppelnummer As Integer = 0
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim UnBCmdString As String = "select koppelnummer from instellingen"
                Dim UnBCmd As New OdbcCommand(UnBCmdString, Conn)
                Dim UnBReader As OdbcDataReader
                UnBReader = UnBCmd.ExecuteReader
                If UnBReader.HasRows Then
                    UnBReader.Read()
                    koppelnummer = CHint(UnBReader("koppelnummer"))
                End If
                koppelnummer = koppelnummer + 1
                UnBReader.Close()
                UnBCmd.CommandText = "UPDATE instellingen SET koppelnummer=?"
                UnBCmd.Parameters.Clear()
                UnBCmd.Parameters.AddWithValue("", koppelnummer)
                UnBCmd.ExecuteNonQuery()
            End Using
        Catch ex As Exception
            ErrorLog("Fout koppelnummer: " + ex.Message)
            MessageBox.Show("Fout koppelnummer:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


       
        If tweedevestiging = True Then
            OpslaanFlorecom(1, False, koppelnummer)
            OpslaanFlorecom(2, True, koppelnummer)
        Else
            OpslaanFlorecom(vestigingnummer, True, koppelnummer)
        End If

        Exit Sub

exit_verwerk2:

        'reload florecom list
        LaadNieuweFlorecoms()

        FcMenu_Verwerk_but.Enabled = True


    End Sub

    Public Sub OpslaanFlorecom(ByVal vestigingnummer As Integer, ByVal bevestig As Boolean, ByVal koppelnummer As Integer)

        Dim SaveOrder As Boolean = False
        Dim labelsfound As Boolean = False
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader
                Dim CmdString4 = "SELECT soort_id,label_status,Lin_Responce FROM edi2_lines where ordernr = " + Str(FC_CurrentEditOrder)
                Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                Reader = Cmd4.ExecuteReader()
                Do While Reader.Read
                    Dim chk_soortid As Integer = CHint(Reader("soort_id"))
                    Dim vestigingcheck As Integer = 1
                    If chk_soortid < 10000 Then
                        vestigingcheck = soorten(GID(soorten, chk_soortid)).vestiging  'vestiging van line
                    Else
                        vestigingcheck = mixen(GID(mixen, chk_soortid - 10000)).vestiging
                    End If
                    If vestigingcheck = vestigingnummer Then
                        Dim label_status As Integer = CHint(Reader("label_status"))
                        Dim chk_Lin_Responce As Integer = CHint(Reader("Lin_Responce"))
                        If (chk_Lin_Responce = 5 Or chk_Lin_Responce = 24 Or chk_Lin_Responce = 999) Then

                            SaveOrder = True
                            'labelscheck
                            If label_status = 1 Or label_status = 2 Or label_status = 3 Then
                                labelsfound = True
                            End If

                        End If
                    End If
                Loop

                Reader.Close()

            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag fc check2: " + ex.Message)
            MsgBox("Fout orderopslag fc check2: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        FormProgressBar.StartPosition = FormStartPosition.CenterScreen
        FormProgressBar.Show()
        FormProgressBar.DataProgressBar.Value = 5

        'order opslaan

        Dim fc_afleverdatum As Date = Now
        Dim fc_koper_ean As String = "0000000000000"
        Dim fc_kopernaam As String = "FC ERROR"
        Dim fc_afleverloc As Integer = 1
        Dim fc_veilingbrief_id As Integer = 1
        Dim fc_vervoerder As Integer = 1
        Dim fc_florecomnr As String = "FC ERROR"
        Dim fc_opmerking As String = "FC ERROR"
        Dim fc_decorum As Integer = 0
        Dim fc_kar_id As Integer = 1
        Dim fc_locatie_ean As String = "FC ERROR"

        ' databases selecteren 
        Dim orderheader_db As String
        Dim orderlines_db As String
        Dim orderyear As String
        Dim header_id As Integer

        header_id = 0
        orderyear = Trim(Str(Year(fc_afleverdatum)))
        If staticyear = True Then orderyear = ""

        orderheader_db = "OrderHeaders" + orderyear
        orderlines_db = "OrderLines" + orderyear

        FormProgressBar.DataProgressBar.Value = 30

        If SaveOrder = True Then
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'read info from florecom database
                    Dim Reader As OdbcDataReader
                    Dim CmdString2 = "SELECT * FROM edi2_orders where id = " + Str(FC_CurrentEditOrder)
                    Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                    Reader = Cmd2.ExecuteReader()
                    If Reader.HasRows Then
                        ' read info from florecom database
                        fc_opmerking = CHstr(Reader("BoekOpmerking"))
                        If labelsfound = True Then
                            fc_opmerking = fc_opmerking + vbCrLf + "<LET OP!!! STICKERS PLAKKEN>"
                        End If
                        fc_koper_ean = CHstr(Reader("koper_ean"))
                        fc_kopernaam = CHstr(Reader("koper_naam"))
                        fc_florecomnr = "Florecom: " + Str(CHint(Reader("id")))
                    Else
                        MsgBox("Florecom vertaal fout, order niet correct opgeslagen")
                    End If
                    Reader.Close()

                    Dim CmdString4 = "SELECT * FROM edi2_lines where ordernr = " + Str(FC_CurrentEditOrder)
                    Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                    Reader = Cmd4.ExecuteReader()
                    Dim fc_line_id As Integer = 0
                    If Reader.HasRows Then
                        ' read info from florecom database
                        fc_afleverdatum = CType(Reader("BoekTijd"), Date)
                        fc_decorum = IsDecorum(fc_koper_ean)
                        fc_kar_id = CHint(Reader("BoekKarId"))
                        fc_line_id = CHint(Reader("id"))
                    Else
                        MsgBox("Florecom vertaal fout, order niet correct opgeslagen")
                    End If
                    Reader.Close()

                    'locatie_ean
                    Dim CmdString3 As String = "SELECT NAD_Party_ean FROM edi2_lines_nad where edi_line_id='" + Str(fc_line_id) + "' and NAD_Party_Code = 'DP'"
                    Dim Cmd3 As New OdbcCommand(CmdString3, Conn)
                    Reader = Cmd3.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        fc_locatie_ean = CHstr(Reader("NAD_Party_ean"))
                    Else
                        fc_locatie_ean = fc_koper_ean  ' Geen DP dan maar gelijk aan koper ean
                    End If
                    Reader.Close()


                    Dim CmdString5 = "SELECT * FROM klanten where ean = " + fc_koper_ean
                    Dim Cmd5 As New OdbcCommand(CmdString5, Conn)
                    Reader = Cmd5.ExecuteReader()
                    If Reader.HasRows Then
                        fc_afleverloc = CHint(Reader("bdo"))

                        If jenptenhave = False Then
                            If fc_locatie_ean = "8714231208761" Then    'EAN locatie AF TUIN => haagkamp
                                fc_afleverloc = 7
                            End If
                        End If

                        fc_veilingbrief_id = CHint(Reader("veiling_voorkeur"))
                        fc_vervoerder = CHint(Reader("vervoerder"))
                    Else
                        MsgBox("Florecom vertaal fout, order niet correct opgeslagen")
                    End If
                    Reader.Close()

                    'write info to order header database 

                    'Execute Query
                    Dim cmdstring As String = "SELECT * FROM " + orderheader_db + " WHERE 1=0"
                    Dim Cmd As New OdbcCommand(cmdstring, Conn)
                    With Cmd

                        'write info to order header database 

                        .CommandText = "INSERT INTO " + orderheader_db + "(afleverdatum,invoerdatumtijd,koper_ean,koper_naam,afleverloc,veilingbrief_id," _
                                        & "vervoerder_id,contact,opmerking,inlog_naam,prijs_opslag,agenda_mark,decorum,status,kar_id,versie,afleverloc_ean,vestiging,koppelnummer) " _
                                        & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                        .Parameters.Clear()
                        .Parameters.AddWithValue("", Format(fc_afleverdatum, "yyyy-MM-dd HH:mm"))                       ' 1 afleverdatum
                        .Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                        .Parameters.AddWithValue("", fc_koper_ean)                              ' 4 koper_ean
                        .Parameters.AddWithValue("", fc_kopernaam)                              ' 5 koper_naam
                        .Parameters.AddWithValue("", fc_afleverloc)                             ' 6 afleverloc
                        .Parameters.AddWithValue("", fc_veilingbrief_id)                        ' 7 veilingbrief id
                        .Parameters.AddWithValue("", fc_vervoerder)                             ' 8 vervoerder id
                        .Parameters.AddWithValue("", fc_florecomnr)                             ' 9 contact
                        .Parameters.AddWithValue("", fc_opmerking)                              '10 opmerking
                        .Parameters.AddWithValue("", Login_name)                                '11 inlog_naam
                        .Parameters.AddWithValue("", 0)                                         '12 prijs_opslag
                        .Parameters.AddWithValue("", 1)                                         '13 agenda_mark
                        .Parameters.AddWithValue("", fc_decorum)                                '14 decorum
                        .Parameters.AddWithValue("", 20)

                        .Parameters.AddWithValue("", fc_kar_id)    'kar_id
                        .Parameters.AddWithValue("", 0) 'versie nr = 0 voor nieuwe orders
                        .Parameters.AddWithValue("", fc_locatie_ean)
                        .Parameters.AddWithValue("", vestigingnummer)
                        .Parameters.AddWithValue("", koppelnummer)
                        .ExecuteNonQuery()

                        If postgress = True Then
                            Dim Cmd15 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('orderheaders','id'))", Conn)
                            header_id = Convert.ToInt32(Cmd15.ExecuteScalar())
                        Else
                            Dim Cmd15 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)  'fetch headerid
                            header_id = Convert.ToInt32(Cmd15.ExecuteScalar())
                        End If
                    End With
                End Using
            Catch ex As Exception
                ErrorLog("Fout orderopslag fc-header: " + ex.Message)
                MsgBox("Fout orderopslag fc-header: " + ex.Message, MsgBoxStyle.OkOnly)
            End Try
        End If

        '****************************** ORDER LINES ************************************************************************
        FormProgressBar.DataProgressBar.Value = 60
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                If SaveOrder = True Then

                    Dim total_label_status As Integer = 0
                    Dim total_label_accessoire As Integer = 0

                    Dim Reader As OdbcDataReader
                    Dim CmdString2 = "SELECT * FROM edi2_lines where ordernr = " + Str(FC_CurrentEditOrder)
                    Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                    Reader = Cmd2.ExecuteReader()
                    Do While Reader.Read

                        Dim ediline_id As Integer = CHint(Reader("id"))

                        ' read info from florecom database

                        Dim chk_Lin_Responce As Integer = CHint(Reader("Lin_Responce"))


                        If (chk_Lin_Responce = 5 Or chk_Lin_Responce = 24 Or chk_Lin_Responce = 999) Then  'alleen geaccepteerde orders bewaren
                            Dim fcl_soortid As Integer = CHint(Reader("soort_id"))

                            Dim vestigingcheck As Integer = 1
                            If fcl_soortid < 10000 Then
                                vestigingcheck = soorten(GID(soorten, fcl_soortid)).vestiging  'vestiging van line
                            Else
                                vestigingcheck = mixen(GID(mixen, fcl_soortid - 10000)).vestiging
                            End If

                            If vestigingcheck = vestigingnummer Then
                                Dim fcl_aantal As Integer = CHint(Reader("aantal"))

                                Dim fcl_fustid As Integer = CHint(Reader("BoekfustId"))
                                Dim fcl_prijs As Double = Val(CHstr(Reader("PRI_INV_Price_Amount")))
                                Dim fcl_acces1 As Integer = CHint(Reader("accessoire1"))
                                Dim fcl_acces2 As Integer = CHint(Reader("accessoire2"))
                                Dim fcl_acces3 As Integer = CHint(Reader("hoes"))
                                Dim fcl_kopercode As String = CHstr(Reader("Koperordernr"))
                                fcl_kopercode = Mid(fcl_kopercode, 1, 19)
                                Dim fcl_opmerking As String = CHstr(Reader("opmerkingboek"))
                                Dim fcl_florecomnr As String = "L" + Trim(Str(ediline_id))
                                Dim fcl_actie_type As Integer = CHint(Reader("actie_type"))
                                Dim fcl_wpsfilternr As Integer = CHint(Reader("wps_filternr"))
                                Dim fcl_label_nummer As Integer = CHint(Reader("label_nummer"))
                                Dim flc_PCI_Label_Description_kar = CHstr(Reader("PCI_Label_Description_kar"))  'martin
                                Dim fcl_rijpheid As Integer
                                Dim fcl_hoogte As Integer
                                Dim fcl_diameter As Integer
                                Dim fcl_potmaat As Integer
                                Dim fcl_transporthoogte As String

                                Dim fcl_labelref As String = ""
                                If fcl_soortid < 10000 Then
                                    fcl_rijpheid = soorten(GID(soorten, fcl_soortid)).bbrijpheid
                                    fcl_hoogte = soorten(GID(soorten, fcl_soortid)).bbhoogte
                                    fcl_diameter = soorten(GID(soorten, fcl_soortid)).bbdiameter
                                    fcl_potmaat = soorten(GID(soorten, fcl_soortid)).potmaat
                                    fcl_transporthoogte = soorten(GID(soorten, fcl_soortid)).transporthoogte
                                Else
                                    fcl_rijpheid = mixen(GID(mixen, fcl_soortid - 10000)).rijpheid
                                    fcl_hoogte = mixen(GID(mixen, fcl_soortid - 10000)).hoogte
                                    fcl_diameter = mixen(GID(mixen, fcl_soortid - 10000)).diameter
                                    fcl_potmaat = mixen(GID(mixen, fcl_soortid - 10000)).potmaat
                                    fcl_transporthoogte = mixen(GID(mixen, fcl_soortid - 10000)).transporthoogte
                                End If
                                Dim fcl_retail_prijs As String = CHstr(Reader("PRI_AAE_Price_Amount"))
                                Dim fcl_label_ean As String = CHstr(Reader("PCI_Label_Description_Fust"))

                                Dim fcl_label_status As Integer = CHint(Reader("label_status"))
                                If fcl_label_status > total_label_status Then
                                    total_label_status = fcl_label_status
                                End If
                                If jenptenhave = True Then
                                    If fcl_acces1 = 70 Or fcl_acces2 = 70 Then 'stikker op hoes?
                                        total_label_accessoire = 1
                                    End If
                                End If


                                If fcl_label_status = 1 Or fcl_label_status = 2 Or fcl_label_status = 3 Then
                                    If Len(fcl_opmerking) < 10 Then fcl_opmerking = fcl_opmerking + "Stikker!!!" 'labelbericht 
                                End If

                                If fc_koper_ean = "8714231202523" Or fc_koper_ean = "8714231186120" Then ' martin (karnummers opslaan van floraconnect)
                                    fcl_opmerking = "Kar " + flc_PCI_Label_Description_kar
                                    fcl_label_ean = flc_PCI_Label_Description_kar  'hier wordt op gesorteerd in karindeling martin
                                End If

                                fcl_labelref = CHstr(Reader("Label_referentie"))
                                'write info to order database 

                                'Get new SDF barcode
                                Dim sdfbarcode As Integer = 0
                                Dim reader5 As OdbcDataReader
                                Dim Cmd5 As New OdbcCommand("SELECT sdfbarcode from instellingen", Conn)
                                reader5 = Cmd5.ExecuteReader()
                                If reader5.HasRows Then
                                    reader5.Read()
                                    sdfbarcode = CHint(reader5("sdfbarcode"))
                                    sdfbarcode = sdfbarcode + 1
                                    If sdfbarcode >= 100000000 Then sdfbarcode = 1
                                    reader5.Close()
                                    Cmd5.CommandText = "UPDATE instellingen SET sdfbarcode = ?"
                                    Cmd5.Parameters.Clear()
                                    Cmd5.Parameters.AddWithValue("", sdfbarcode)
                                    Cmd5.ExecuteNonQuery()
                                End If

                                Dim cmdstring3 As String = "SELECT * FROM " + orderlines_db + " WHERE 1=0"
                                Dim Cmd As New OdbcCommand(cmdstring3, Conn)
                                Cmd.CommandText = "INSERT INTO " + orderlines_db + "(OrderHeader_id,Koper_naam,Aantal,Soort_id,Fust_id,Prijs,GP,Rijpheid,Hoogte,Diameter," _
                                                & "Accessoire1,Accessoire2,Accessoire3,Accessoire4,Accessoire5,Kopercode,Potmaat,Wps_filternr,Opmerking,Keurcode," _
                                                & "Transporthoogte,Florecom_nr,actie_type,Wps_filternr2,retail_prijs,label_ean,label_status,label_referentie,labelbericht_code,vestiging,sdfbarcode) " _
                                                & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                                Cmd.Parameters.Clear()
                                Cmd.Parameters.AddWithValue("", header_id)                              ' 1 orderheader_id 
                                Cmd.Parameters.AddWithValue("", fc_kopernaam)                           ' 2 koper_naam
                                Cmd.Parameters.AddWithValue("", fcl_aantal)                             ' 3 aantal
                                Cmd.Parameters.AddWithValue("", fcl_soortid)                            ' 4 soort_id
                                Cmd.Parameters.AddWithValue("", fcl_fustid)                             ' 5 fust_id
                                Cmd.Parameters.AddWithValue("", fcl_prijs)                              ' 6 prijs
                                Cmd.Parameters.AddWithValue("", 1)                                      ' 7 GP
                                Cmd.Parameters.AddWithValue("", fcl_rijpheid)                           ' 8 Rijpheid
                                Cmd.Parameters.AddWithValue("", fcl_hoogte)                             ' 9 hoogte
                                Cmd.Parameters.AddWithValue("", fcl_diameter)                           '10 Diameter
                                Cmd.Parameters.AddWithValue("", fcl_acces1)                             '11 Accessoire1
                                Cmd.Parameters.AddWithValue("", fcl_acces2)                             '12 Accessoire2
                                Cmd.Parameters.AddWithValue("", fcl_acces3)                                      '13 Accessoire3
                                Cmd.Parameters.AddWithValue("", 0)                                      '14 Accessoire4
                                Cmd.Parameters.AddWithValue("", 0)                                      '15 Accessoire5
                                Cmd.Parameters.AddWithValue("", fcl_kopercode)                          '16 kopercode
                                Cmd.Parameters.AddWithValue("", fcl_potmaat)                            '17 potmaat

                                Dim wpsfilterid As Integer = fcl_wpsfilternr
                                Dim wpsfilterid2 As Integer = 0
                                'GetWPSFilterNr(fc_koper_ean, fcl_soortid, fcl_acces1, wpsfilterid, wpsfilterid2)

                                Cmd.Parameters.AddWithValue("", wpsfilterid)                            '18 wps filternr
                                Cmd.Parameters.AddWithValue("", fcl_opmerking)                          '19 Opmerking
                                Cmd.Parameters.AddWithValue("", 0)                                      '20 Keurcode
                                Cmd.Parameters.AddWithValue("", fcl_transporthoogte)                    '21 Transporthoogte
                                Cmd.Parameters.AddWithValue("", fcl_florecomnr)                         '22 Florecom_nr
                                Cmd.Parameters.AddWithValue("", fcl_actie_type)                         '23 Actie_type
                                Cmd.Parameters.AddWithValue("", wpsfilterid2)
                                Cmd.Parameters.AddWithValue("", fcl_retail_prijs)
                                Cmd.Parameters.AddWithValue("", fcl_label_ean)
                                Cmd.Parameters.AddWithValue("", fcl_label_status)
                                Cmd.Parameters.AddWithValue("", fcl_labelref)
                                Cmd.Parameters.AddWithValue("", fcl_label_nummer)
                                Cmd.Parameters.AddWithValue("", vestigingnummer)
                                Cmd.Parameters.AddWithValue("", sdfbarcode)
                                Cmd.ExecuteNonQuery()
                            End If

                        End If

                    Loop

                    'new status for labelorder
                    If total_label_status = 1 Or total_label_status = 3 Then   'labelbericht of lemkes
                        Dim cmdstring As String = ""
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        Cmd.CommandText = "UPDATE " + orderheader_db + " SET status=24, sticker=8 WHERE header_id = " + Str(header_id)
                        Cmd.ExecuteNonQuery()
                    End If
                    If total_label_status = 2 Then                          'OZ
                        Dim cmdstring As String = ""
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        Cmd.CommandText = "UPDATE " + orderheader_db + " SET status=22, sticker=2 WHERE header_id = " + Str(header_id)
                        Cmd.ExecuteNonQuery()
                    End If
                    If total_label_status = 0 And total_label_accessoire = 1 Then
                        Dim cmdstring As String = ""
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        Cmd.CommandText = "UPDATE " + orderheader_db + " SET status=25, sticker=11 WHERE header_id = " + Str(header_id)
                        Cmd.ExecuteNonQuery()
                    End If

                    'ignore IBH labelbericht 
                    If fc_koper_ean = "8718288047960" Or fc_koper_ean = "8714231149262" Or fc_koper_ean = "8718288017048" Or fc_koper_ean = "8714231193463" Or fc_koper_ean = "8718288071316" Or fc_koper_ean = "8718288031037" Or fc_koper_ean = "8718288019189" Or fc_koper_ean = "8713783498682" Or fc_koper_ean = "8718288019226" Then
                        If total_label_status = 1 Then   'labelbericht
                            Dim cmdstring As String = ""
                            Dim Cmd As New OdbcCommand(cmdstring, Conn)
                            Cmd.CommandText = "UPDATE " + orderheader_db + " SET status=21, sticker=1 WHERE header_id = " + Str(header_id)
                            Cmd.ExecuteNonQuery()
                        End If
                    End If


                End If

                'florecom bevestigen
                If bevestig = True Then

                    Dim CmdString8 = "SELECT id FROM edi2_lines where 1=0"
                    Dim Cmd8 As New OdbcCommand(CmdString8, Conn)
                    Cmd8.CommandText = "UPDATE edi2_lines SET status ='1' where ordernr = " + Str(FC_CurrentEditOrder)
                    Cmd8.ExecuteNonQuery()

                    Dim CmdString9 = "SELECT id FROM edi2_orders where 1=0"
                    Dim Cmd9 As New OdbcCommand(CmdString9, Conn)
                    Cmd9.CommandText = "UPDATE edi2_orders SET status ='1' where id = " + Str(FC_CurrentEditOrder)
                    Cmd9.ExecuteNonQuery()

                End If
            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag lines: " + ex.Message)
            MsgBox("Fout orderopslag lines: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        'karindeling of order aanmaken
        If SaveOrder = True Then

            ' !!!!!!!!! UPDATE AGENDA
            user_date_change = False
            Order_MonthCalendar.SelectionStart = fc_afleverdatum
            Order_MonthCalendar.SelectionEnd = fc_afleverdatum
            user_date_change = True
            BoekStatus = 8
            Update_Boek(1, fc_koper_ean)

            Maak_Karindeling(False, fc_kar_id, header_id, fc_afleverdatum)


        End If
            '

        'Set_Boek_reload()
        'Set_BoekInstellingen(0, 0, 6)
        'Update_Boek(1, fc_koper_ean, header_id)


exit_verwerk:
            FormProgressBar.DataProgressBar.Value = 95
            FormProgressBar.Close()
            Me.Cursor = Cursors.Default

            'reload florecom list
            LaadNieuweFlorecoms()

            FcMenu_Verwerk_but.Enabled = True
    End Sub
    Private Function GetLabelPrijs(ByVal koper_ean As String) As Integer
        Dim prijs_in_centen As Integer = 0

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Reader As OdbcDataReader

                Dim CmdString = "SELECT * FROM label_prijs where koper_ean ='" + koper_ean + "'"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    prijs_in_centen = CHint(Reader("prijs_in_eurocent"))
                End If
            End Using
        Catch ex As Exception
            MessageBox.Show("Database fout: (labelprijs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Return prijs_in_centen
    End Function
    Private Function TestLabelBerichtOpslag(ByVal koper_ean As String, ByVal CCICAVstr As String) As Integer

        Dim prijs_in_centen As Integer = -1
        Dim potstikker_prijs As Integer = 10
        Dim fuststikker_prijs As Integer = 0

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Reader As OdbcDataReader

                Dim CmdString = "SELECT * FROM label_prijs where koper_ean ='" + koper_ean + "'"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    potstikker_prijs = CHint(Reader("prijs_in_eurocent"))
                    fuststikker_prijs = CHint(Reader("fuststikker_in_eurocent"))
                End If
            End Using
        Catch ex As Exception
            MessageBox.Show("Database fout: (labelprijs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Dim CCICAV() As String = Microsoft.VisualBasic.Strings.Split(CCICAVstr, "*")
        Dim potstikkerfound As Boolean = False
        Dim fuststikkerfound As Boolean = False
        For i = 0 To UBound(CCICAV) - 1
            Dim cci = Mid(CCICAV(i), 1, 3)
            Dim cav = Mid(CCICAV(i), 5, 3)
            ' If cci = "L18" Then kenmerk = "Labelbericht"
            ' If cci = "L19" Then kenmerk = "Labelbericht"
            If cci = "L21" Then fuststikkerfound = True
            If cci = "L20" Then potstikkerfound = True
            If koper_ean = "8714231140016" And cci = "S61" And cav = "008" Then  'labels lemkes
                potstikkerfound = True
            End If
            'If cci = "L22" Then kenmerk = "Labelbericht"
        Next i
        If fuststikkerfound = True And potstikkerfound = False Then
            prijs_in_centen = fuststikker_prijs
        End If
        If potstikkerfound = True Then
            prijs_in_centen = potstikker_prijs
        End If

        Return prijs_in_centen

    End Function

    Private Sub FcMenu_fczoek_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles FcMenu_fczoek_chk.CheckedChanged
        FcMenu_fczoek_txt.Text = ""
    End Sub

    Private Sub TimerFlorecom_Tick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles TimerFlorecom.Tick
        TestSQLConnection()
        If SQLRUN = True Then
            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'check florecom
                    Dim CmdString As String = "select status,ordernr from edi2_lines where status = 0 and ordernr = 0"
                    Dim Reader As OdbcDataReader
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()

                    If Reader.HasRows Then
                        C1NavBar1.Buttons(2).Text = "Florecom (nieuw)"
                    Else
                        C1NavBar1.Buttons(2).Text = "Florecom"
                    End If


                End Using


            Catch ex As Exception
                MessageBox.Show("Fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                SQLRUN = False
            End Try
        End If
    End Sub
#End Region

#Region "Karindeling"

    Private Sub Maak_Karindeling(ByVal lock As Boolean, ByVal kartype_id As Integer, ByVal header_id As Integer, ByVal order_datum As Date, Optional ByVal indeling As Integer = 0)

        If jenptenhave = True Then
            Kar_markeer_chk.Checked = True
        Else
            Kar_markeer_chk.Checked = False
        End If

        Dim orderyear As String = Trim(Str(Year(order_datum)))
        If staticyear = True Then orderyear = ""

        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear
        overgooier = "" 'clear global overgooi var

        'check wps status/abort on wps bezig


        'clear global vars
        Array.Clear(KarHeaders, KarHeaders.GetLowerBound(0), KarHeaders.Length)
        Array.Clear(KarLines, KarLines.GetLowerBound(0), KarLines.Length)

        'if lock = true load old data   
        'delete old data
        Dim karcounter As Integer = 1
        Dim linecounter As Integer = 1

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                If lock = True Then
                    ' load locked kar-info & lines


                    Dim CmdKarString As String = "select * from " + orderkarren_db + " WHERE  Header_id = " + Str(header_id)
                    Dim CmdKar As New OdbcCommand(CmdKarString, Conn)
                    Dim KarrenReader As OdbcDataReader

                    KarrenReader = CmdKar.ExecuteReader
                    Do While KarrenReader.Read()
                        Dim kar_id As Integer = KarrenReader("kar_id")
                        KarHeaders(karcounter).tag = True
                        KarHeaders(karcounter).kar_id = kar_id
                        KarHeaders(karcounter).header_id = CHint(KarrenReader("header_id"))
                        KarHeaders(karcounter).aantal_lagen = CHint(KarrenReader("Aantal_lagen"))
                        KarHeaders(karcounter).kar_type = CHint(KarrenReader("kar_type"))
                        KarHeaders(karcounter).sdf_flag = CHbool(KarrenReader("sdf_flag"))
                        KarHeaders(karcounter).wps_status = CHint(KarrenReader("wps_status"))
                        KarHeaders(karcounter).vervoer_flag = CHbool(KarrenReader("vervoer_flag"))
                        KarHeaders(karcounter).barcode = CHstr(KarrenReader("barcode"))
                        KarHeaders(karcounter).cc_rfid = CHstr(KarrenReader("cc_rfid"))
                        KarHeaders(karcounter).kar_nummer = 0
                        KarHeaders(karcounter).scan_flag = CHbool(KarrenReader("scan_flag"))
                        KarHeaders(karcounter).overgooien_naar = CHstr(KarrenReader("overgooien_naar"))
                        KarHeaders(karcounter).overgooien_hierop = CHstr(KarrenReader("overgooien_hierop"))

                        'load kar  lines
                        Dim CmdKarLineString As String = "select * from " + orderkarlines_db + " WHERE  kar_id = " + Str(kar_id)
                        Dim CmdKarlines As New OdbcCommand(CmdKarLineString, Conn)
                        Dim KarLineReader As OdbcDataReader
                        KarLineReader = CmdKarlines.ExecuteReader
                        Do While KarLineReader.Read()
                            KarLines(linecounter).tag = True
                            KarLines(linecounter).aantal = CHint(KarLineReader("aantal"))
                            KarLines(linecounter).kar_id = CHint(KarLineReader("kar_id"))
                            KarLines(linecounter).Orderline_id = CHint(KarLineReader("orderline_id"))
                            KarLines(linecounter).wps_flag = CHbool(KarLineReader("wps_flag"))
                            KarLines(linecounter).header_id = CHint(KarLineReader("header_id"))
                            KarLines(linecounter).kar_nummerref = 0
                            KarLines(linecounter).wps17_flag = CHbool(KarLineReader("wps17_flag"))
                            KarLines(linecounter).sdfbarcode2 = CHint(KarLineReader("sdfbarcode2"))
                            linecounter = linecounter + 1
                        Loop
                        karcounter = karcounter + 1
                    Loop
                Else        'delete old lines if you take off the lock 


                    ' delete kar-info & lines from database 
                    ' delete all non-locked karinfo
                    Dim DelString As String = "DELETE FROM " + orderkarren_db + " WHERE header_id='" + Str(header_id) + "'"
                    Dim DelCmd As New OdbcCommand(DelString, Conn)
                    DelCmd.ExecuteNonQuery()

                    'delete all kar-line info
                    Dim DelString2 As String = "DELETE FROM " + orderkarlines_db + " WHERE header_id='" + Str(header_id) + "'"
                    Dim DelCmd2 As New OdbcCommand(DelString2, Conn)
                    DelCmd2.ExecuteNonQuery()
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Fout: Maak karindeling" + ex.Message)
            MessageBox.Show("Fout: Maak karindeling" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        ' berekenen of de order past op normale of verhoogde denen
        Dim rekenkartype_id As Integer = kartype_id
        Dim maxlagenjenp As Integer = 6
        If lock = False And (kartype_id = 1 Or kartype_id = 4) Then
            Dim karcounterlaag As Integer = 1
            Dim karcounterhoog As Integer = 1
            Dim cReader As OdbcDataReader
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Dim plaatslaag As Double = 0
                    Dim laaglaag As Integer = 1
                    Dim plaatshoog As Double = 0
                    Dim laaghoog As Integer = 1

                    Dim maxlagenhoog As Integer = kar(GID(kar, kartype_id)).aantal_lagen  ' maxaantallagen
                    Dim maxlagenlaag As Integer = maxlagenhoog - 1

                    If jenptenhave = True Then
                        maxlagenhoog = jenplagenhoog(header_id)
                        'maxlagenlaag = maxlagenhoog - 1
                        maxlagenlaag = maxlagenhoog
                    End If

                    'Execute Query

                    Dim CmdString3 As String = "select * from " + orderlines_db + " where OrderHeader_id = " + Str(header_id) + " ORDER BY fust_id ASC"
                    Dim Cmd2 As New OdbcCommand(CmdString3, Conn)
                    cReader = Cmd2.ExecuteReader()
                    Do While cReader.Read()

                        ' fill list
                        Dim fust_id As Integer = CHint(cReader("fust_id"))
                        Dim fustlist_id As Integer = GID(fust, fust_id)
                        Dim totaantallaag As Integer = CHint(cReader("aantal"))
                        Dim totaantalhoog As Integer = CHint(cReader("aantal"))

                        Dim fustperlaag_code = kar(GID(kar, kartype_id)).fust_per_laag_code
                        Dim aantalperlaag As Integer = 1
                        Select Case fustperlaag_code
                            Case 1 : aantalperlaag = fust(fustlist_id).fpl_deen
                            Case 2 : aantalperlaag = fust(fustlist_id).fpl_veilingkar
                            Case 3 : aantalperlaag = fust(fustlist_id).fpl_overig
                            Case 4 : aantalperlaag = fust(fustlist_id).fpl_reserve1
                            Case 5 : aantalperlaag = fust(fustlist_id).fpl_reserve2
                        End Select

                        Do While totaantallaag > 0
                            Dim i As Integer
                            For i = 1 To totaantallaag

                                'past het?
                                plaatslaag = plaatslaag + 1 / aantalperlaag
                                If plaatslaag > 1.01 Then
                                    plaatslaag = 1 / aantalperlaag
                                    laaglaag = laaglaag + 1
                                End If
                                If laaglaag > maxlagenlaag Then
                                    karcounterlaag = karcounterlaag + 1
                                    Exit For
                                End If
                            Next i
                            totaantallaag = totaantallaag - (i - 1)
                            If laaglaag > maxlagenlaag Then
                                laaglaag = 0
                            End If
                        Loop
                        ' res = karcounterlaag

                        Do While totaantalhoog > 0
                            Dim i As Integer
                            For i = 1 To totaantalhoog

                                'past het?
                                plaatshoog = plaatshoog + 1 / aantalperlaag
                                If plaatshoog > 1.01 Then
                                    plaatshoog = 1 / aantalperlaag
                                    laaghoog = laaghoog + 1
                                End If
                                If laaghoog > maxlagenhoog Then
                                    karcounterhoog = karcounterhoog + 1
                                    Exit For
                                End If
                            Next i
                            totaantalhoog = totaantalhoog - (i - 1)
                            If laaghoog > maxlagenhoog Then
                                laaghoog = 0
                            End If
                        Loop
                        ' res = karcounterhoog

                    Loop
                    If karcounterhoog = karcounterlaag Then
                        maxlagenjenp = maxlagenlaag
                        If kartype_id = 1 Then rekenkartype_id = 2 ' CC met opzet wordt CC zonder opzet
                        If kartype_id = 4 Then rekenkartype_id = 5 ' DC met opzet wordt DC zonder opzet 
                    Else
                        maxlagenjenp = maxlagenhoog
                    End If

                End Using
            Catch ex As Exception
                ErrorLog("Fout: Maak karindeling2" + ex.Message)
                MessageBox.Show("Fout: Maak karindeling2" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

        End If


        Dim gpaantal As Integer = 1

        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim plaats As Double = 0
                Dim laag As Integer = 1

                Dim maxlagen As Integer = kar(GID(kar, rekenkartype_id)).aantal_lagen  ' maxaantallagen

                If jenptenhave = True Then
                    maxlagen = maxlagenjenp

                    'gloxen?


                End If


                'Execute Query
                Dim CmdString4 As String = "select * from orderlines where OrderHeader_id = " + Str(header_id) + " ORDER BY labelbericht_code = 0,fust_id,accessoire3,potmaat,soort_id ASC" 'default 
                Select Case indeling
                    Case 0 : CmdString4 = "select * from orderlines where OrderHeader_id = " + Str(header_id) + " ORDER BY labelbericht_code = 0,fust_id,accessoire3,potmaat,soort_id ASC"  'order by fust 
                    Case 1 : CmdString4 = "select * from orderlines where OrderHeader_id = " + Str(header_id) + " ORDER BY orderline_id ASC"      'order by orderline
                    Case 2 : CmdString4 = "select * from orderlines where OrderHeader_id = " + Str(header_id) + " ORDER BY label_ean ASC"      'order by karnummer (martin)
                End Select
                'If indeling = 0 Then
                '    CmdString4 = "select * from " + orderlines_db + " where OrderHeader_id = " + Str(header_id) + " ORDER BY fust_id,soort_id ASC"
                'Else
                ''     CmdString4 = "select * from " + orderlines_db + " where OrderHeader_id = " + Str(header_id) + " ORDER BY orderline_id ASC"
                'End If

                Dim Cmd2 As New OdbcCommand(CmdString4, Conn)
                Reader = Cmd2.ExecuteReader()

                Dim generate_new_barcode As Boolean = True
                Dim barcode_save As String = ""

                Do While Reader.Read()

                    ' fill list
                    Dim fust_id As Integer = CHint(Reader("fust_id"))
                    Dim fustlist_id As Integer = GID(fust, fust_id)
                    Dim orderline_id As Integer = CHint(Reader("orderline_id"))
                    Dim totaantal As Integer = CHint(Reader("aantal"))
                    Dim soort_id As Integer = CHint(Reader("Soort_id"))
                    Dim gp_id As Integer = CHint(Reader("GP"))
                    gpaantal = gp_id
                    If gp_id > 1 Then
                        maxlagen = 200
                    End If

                    ' is de orderline al geladen?  ja? dan niet verwerken
                    Dim line_geladen As Boolean = False
                    Dim searchcounter As Integer = 1
                    Do While KarLines(searchcounter).tag = True
                        If KarLines(searchcounter).Orderline_id = orderline_id Then
                            line_geladen = True
                        End If
                        searchcounter = searchcounter + 1
                    Loop

                    If line_geladen = False Then

                        'orderline verwerken 
                        Dim fustperlaag_code = kar(GID(kar, kartype_id)).fust_per_laag_code
                        Dim aantalperlaag As Integer = 1
                        Select Case fustperlaag_code
                            Case 1 : aantalperlaag = fust(fustlist_id).fpl_deen
                            Case 2 : aantalperlaag = fust(fustlist_id).fpl_veilingkar
                            Case 3 : aantalperlaag = fust(fustlist_id).fpl_overig
                            Case 4 : aantalperlaag = fust(fustlist_id).fpl_reserve1
                            Case 5 : aantalperlaag = fust(fustlist_id).fpl_reserve2
                        End Select

                        If rekenkartype_id = 10 Or rekenkartype_id = 11 Then   'DV's 
                            If gp_id = 1 Then
                                aantalperlaag = fust(fustlist_id).fpl_veilingkar
                            End If
                            If gp_id > 1 Then
                                aantalperlaag = fust(fustlist_id).fpl_deen
                            End If
                        End If

                        Do While totaantal > 0
                            Dim i As Integer
                            For i = 1 To totaantal

                                'past het?
                                plaats = plaats + 1 / aantalperlaag
                                If plaats > 1.01 Then
                                    plaats = 1 / aantalperlaag
                                    laag = laag + 1
                                End If
                                If laag > maxlagen Then
                                    KarHeaders(karcounter).tag = True
                                    KarHeaders(karcounter).aantal_lagen = laag - 1
                                    KarHeaders(karcounter).header_id = header_id
                                    KarHeaders(karcounter).kar_type = kartype_id
                                    KarHeaders(karcounter).sdf_flag = False
                                    KarHeaders(karcounter).vervoer_flag = False
                                    If generate_new_barcode = True Then
                                        KarHeaders(karcounter).barcode = GetNewBarcode(order_datum)   '  "1234567890123"
                                        barcode_save = KarHeaders(karcounter).barcode
                                        generate_new_barcode = False
                                    Else
                                        KarHeaders(karcounter).barcode = barcode_save
                                    End If
                                    KarHeaders(karcounter).cc_rfid = ""   '  "123456789012345678901234"
                                    KarHeaders(karcounter).kar_nummer = karcounter
                                    KarHeaders(karcounter).scan_flag = False
                                    KarHeaders(karcounter).overgooien_naar = ""
                                    KarHeaders(karcounter).overgooien_hierop = ""
                                    Exit For
                                End If
                            Next i
                            If (i - 1) > 0 Then
                                KarLines(linecounter).tag = True
                                KarLines(linecounter).aantal = i - 1
                                KarLines(linecounter).kar_id = 0
                                KarLines(linecounter).Orderline_id = orderline_id
                                KarLines(linecounter).wps_flag = False
                                KarLines(linecounter).wps17_flag = FetchWps17(linecounter)
                                KarLines(linecounter).kar_nummerref = karcounter
                                linecounter = linecounter + 1
                                totaantal = totaantal - (i - 1)
                            End If
                            If laag > maxlagen Then
                                laag = 1
                                plaats = 0
                                karcounter = karcounter + 1
                                generate_new_barcode = True
                            End If
                        Loop
                        KarHeaders(karcounter).tag = True
                        KarHeaders(karcounter).aantal_lagen = laag
                        KarHeaders(karcounter).header_id = header_id
                        KarHeaders(karcounter).kar_type = kartype_id
                        KarHeaders(karcounter).sdf_flag = 0
                        KarHeaders(karcounter).vervoer_flag = 0
                        If generate_new_barcode = True Then
                            KarHeaders(karcounter).barcode = GetNewBarcode(order_datum)   '  "1234567890123"
                            barcode_save = KarHeaders(karcounter).barcode
                            generate_new_barcode = False
                        Else
                            KarHeaders(karcounter).barcode = barcode_save
                        End If
                        KarHeaders(karcounter).cc_rfid = ""   '  "123456789012345678901234"
                        KarHeaders(karcounter).kar_nummer = karcounter
                        KarHeaders(karcounter).scan_flag = False
                        KarHeaders(karcounter).overgooien_naar = ""
                        KarHeaders(karcounter).overgooien_hierop = ""
                    End If

                    If rekenkartype_id = 10 Or rekenkartype_id = 11 Then   'DV's 
                        laag = 1
                        plaats = 0
                        karcounter = karcounter + 1
                    End If

                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Fout: Maak karindeling3" + ex.Message)
            MessageBox.Show("Fout: Maak karindeling3" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        ' opslaan gemaakte karindeling in database
        Dim karlinecounter As Integer = 1
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                karcounter = 1
                Do While KarHeaders(karcounter).tag = True

                    If KarHeaders(karcounter).kar_nummer > 0 Then

                        'Execute Query
                        Dim cmdstring As String = "SELECT * FROM " + orderkarren_db + " WHERE 1=0"
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        With Cmd


                            .CommandText = "INSERT INTO " + orderkarren_db + "(header_id,kar_type,aantal_lagen,sdf_flag,vervoer_flag,barcode,cc_rfid,scan_flag)" _
                                            & "VALUES(?,?,?,?,?,?,?,?)"
                            .Parameters.Clear()
                            .Parameters.AddWithValue("", header_id)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).kar_type)

                            If kar(GID(kar, KarHeaders(karcounter).kar_type)).fust_per_laag_code = 1 Then  'deen 
                                .Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagen)
                            ElseIf kar(GID(kar, KarHeaders(karcounter).kar_type)).fust_per_laag_code = 2 Then ' veilingkar
                                If jenptenhave = True Then
                                    .Parameters.AddWithValue("", 0)
                                Else
                                    .Parameters.AddWithValue("", 1)
                                End If

                            ElseIf KarHeaders(karcounter).kar_type = 10 Or KarHeaders(karcounter).kar_type = 11 Then 'dv's 
                                If karcounter = 1 Then
                                    .Parameters.AddWithValue("", 1)
                                Else
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagen)
                                End If
                            Else
                                .Parameters.AddWithValue("", 0) 'pallets e.d.
                            End If

                            .Parameters.AddWithValue("", KarHeaders(karcounter).sdf_flag)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).vervoer_flag)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).barcode)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).cc_rfid)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).scan_flag)

                            .ExecuteNonQuery()

                            ' fetch header
                            If postgress = True Then
                                Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('orderkarren','kar_id'))", Conn)
                                KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                            Else
                                Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                            End If
                        End With
                    End If
                    karcounter = karcounter + 1
                Loop

                'karlines opslaan
                karlinecounter = 1
                Dim cmdstring6 As String = "SELECT * FROM " + orderkarlines_db + " WHERE 1=0"
                Dim sorteringteller As Integer = 2000
                Do While KarLines(karlinecounter).tag = True

                    If KarLines(karlinecounter).kar_nummerref > 0 Then
                        'Execute Query
                        Dim Cmd As New OdbcCommand(cmdstring6, Conn)
                        With Cmd

                            .CommandText = "INSERT INTO " + orderkarlines_db + "(kar_id,aantal,Orderline_id,wps_flag,wps17_flag,header_id,sorteren)" _
                                            & "VALUES(?,?,?,?,?,?,?)"

                            Dim karcounter2 As Integer = 1

                            If KarLines(karlinecounter).kar_nummerref > 0 Then    ' line id's van nieuwe karren koppelen aan kar id's 
                                Do While KarHeaders(karcounter2).tag = True
                                    If KarHeaders(karcounter2).kar_nummer = KarLines(karlinecounter).kar_nummerref Then
                                        KarLines(karlinecounter).kar_id = KarHeaders(karcounter2).kar_id
                                        Exit Do
                                    End If
                                    karcounter2 = karcounter2 + 1
                                Loop
                            End If
                            .Parameters.Clear()
                            .Parameters.AddWithValue("", KarLines(karlinecounter).kar_id)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).aantal)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).Orderline_id)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).wps_flag)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).wps17_flag)
                            .Parameters.AddWithValue("", header_id)
                            .Parameters.AddWithValue("", sorteringteller)

                            .ExecuteNonQuery()

                        End With
                    End If
                    karlinecounter = karlinecounter + 1
                    sorteringteller = sorteringteller + 1
                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag karindeling: " + ex.Message)
            MsgBox("Fout orderopslag karindeling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        Dim koper_ean As String = ""
        Dim klok_order As Boolean = False  'bij klokorders & meer als 1 line, karindeling laten zien
        Try                   'klok order?
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim CmdString8 As String = "select * from " + orderheader_db + " WHERE  Header_id = " + Str(header_id) + " "
                Dim Cmd8 As New OdbcCommand(CmdString8, Conn)
                Dim Reader8 As OdbcDataReader
                Reader8 = Cmd8.ExecuteReader
                If Reader8.HasRows Then
                    Reader8.Read()
                    koper_ean = CHstr(Reader8("koper_ean"))
                    If Mid(koper_ean, 1, 4) = "0000" Then
                        klok_order = True

                        Kar_markeer_chk.Checked = False  'j en p check uitzetten bij klok
                    End If
                End If

                'header overzicht berekenen voor snel overzicht.

                If jenptenhave = True Then
                    Dim aantal_karren As Integer = GetKarCount(orderyear, header_id)
                    Dim p12 As Integer = GetBakCount(header_id, 120, 139)
                    Dim p14 As Integer = GetBakCount(header_id, 140, 169)
                    Dim p17 As Integer = GetBakCount(header_id, 170, 200)
                    Dim bakverdeling As String = ""

                    If gpaantal > 1 Then
                        bakverdeling = bakverdeling + Trim(Str(gpaantal)) + "x"
                    End If
                    If p12 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p12)) + "x12 "
                    End If
                    If p14 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p14)) + "x14 "
                    End If
                    If p17 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p17)) + "x17 "
                    End If

                    Dim Cmd2 As New OdbcCommand("UPDATE orderheaders SET aantal_karren=?, bakverdeling=? WHERE header_id = ?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", aantal_karren)
                    Cmd2.Parameters.AddWithValue("", bakverdeling)
                    Cmd2.Parameters.AddWithValue("", header_id)
                    Cmd2.ExecuteNonQuery()
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag karindeling: " + ex.Message)
            MsgBox("Fout orderopslag karindeling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        If jenptenhave = False Then

            If karlinecounter >= 3 And klok_order = True Then
                Set_Boek_reload()
                BoekStatus = 8
                Update_Boek(1, koper_ean, header_id)

                karindeling_date = order_datum
                Show_Karindeling(header_id)
                PanelKarindelingOnder.Enabled = True
                PanelKarindelingMidden.Enabled = True
                PanelKarIndelingBoven.Enabled = True
            ElseIf karcounter >= 3 Then
                Set_Boek_reload()
                BoekStatus = 8
                Update_Boek(1, koper_ean, header_id)

                karindeling_date = order_datum
                Show_Karindeling(header_id)
                PanelKarindelingOnder.Enabled = True
                PanelKarindelingMidden.Enabled = True
                PanelKarIndelingBoven.Enabled = True
            Else
                SetMark(False, header_id)
                Set_Boek_reload()
                Set_BoekInstellingen(0, 0, 6)
                Update_Boek()
            End If

        Else
            'If karcounter >= 3 Then
            If Mid(Order_ean_lbl.Text, 1, 12) = "900000000000" Then  'verzamelkar geen karindeling etc.
                SetMark(False, header_id)
                Set_BoekInstellingen(0, 0, 6)
                Set_Boek_reload()
                Update_Boek()
            Else
                Set_Boek_reload()
                BoekStatus = 8
                Update_Boek(1, koper_ean, header_id)

                karindeling_date = order_datum
                Show_Karindeling(header_id)
                PanelKarindelingOnder.Enabled = True
                PanelKarindelingMidden.Enabled = True
                PanelKarIndelingBoven.Enabled = True
                'End If
            End If

        End If

    
    End Sub

    Private Function jenplagenhoog(ByVal header_id As Integer) As Integer
        Dim lagenhoog As Integer = 5

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim alleengloxinia As Boolean = True
                Dim alleenprincettia17 As Boolean = True
                Dim alleenpoincettia14 As Boolean = True

                Dim found1719 As Boolean = False
                Dim Cmd2 As New OdbcCommand("select * from orderlines where Orderheader_id=? ORDER BY fust_id ASC", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", header_id)
                Dim reader As OdbcDataReader
                Reader = Cmd2.ExecuteReader()
                Do While Reader.Read()
                    Dim soortid As Integer = reader("soort_id")
                    Dim potmaat As Integer = reader("potmaat")

                    'find soort in soortgroep gloxinia
                    Dim gloxfound As Boolean = False
                    For i = 1 To UBound(soortgroep)
                        If soortgroep(i).naam = "Gloxinia" Then
                            For j = 1 To UBound(soortgroepids)
                                If soortgroepids(j).id = soortgroep(i).id And soortgroepids(j).soortmixid = soortid Then
                                    gloxfound = True
                                End If
                            Next
                        End If
                    Next
                    If gloxfound = False Then
                        alleengloxinia = False
                    End If
                    'find soort in soortgroep princettia 17
                    Dim prin17found As Boolean = False
                    For i = 1 To UBound(soortgroep)
                        If soortgroep(i).naam = "Princettia 17" Then
                            For j = 1 To UBound(soortgroepids)
                                If soortgroepids(j).id = soortgroep(i).id And soortgroepids(j).soortmixid = soortid Then
                                    prin17found = True
                                End If
                            Next
                        End If
                    Next
                    If prin17found = False Then
                        alleenprincettia17 = False
                    End If
                    'find soort in soortgroep poincettia 14
                    Dim poin14found As Boolean = False
                    For i = 1 To UBound(soortgroep)
                        If soortgroep(i).naam = "Poincettia 14" Then
                            For j = 1 To UBound(soortgroepids)
                                If soortgroepids(j).id = soortgroep(i).id And soortgroepids(j).soortmixid = soortid Then
                                    poin14found = True
                                End If
                            Next
                        End If
                    Next
                    If poin14found = False Then
                        alleenpoincettia14 = False
                    End If



                    'find potmaat 17/19
                    If potmaat = 190 Or potmaat = 170 Then
                        found1719 = True
                    End If
                Loop

                If alleengloxinia = True Then
                    lagenhoog = 7
                ElseIf alleenpoincettia14 = True Then
                    lagenhoog = 4
                ElseIf alleenprincettia17 = True Then
                    lagenhoog = 5
                ElseIf found1719 = True Then
                    lagenhoog = 5
                Else
                    lagenhoog = 6
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Fout berekenmaxlagen karindeling: " + ex.Message)
            MsgBox("Fout berekenmaxlagen karindeling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        Return lagenhoog
    End Function

    Private Sub Show_Karindeling(ByVal header_id As Integer)


        'C1Tab.SelectedTab = C1Tab.TabPages(1)
        SetTabPage("Kar indeling")
        'Kar_vestiging_lbl.Text = "Karindeling " + vestiging(vestigingnum).naam

        'load karindeling in data vars
        Dim orderyear As String = Trim(Str(Year(karindeling_date)))
        If staticyear = True Then orderyear = ""

        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear

        'clear global vars
        Array.Clear(KarHeaders, KarHeaders.GetLowerBound(0), KarHeaders.Length)
        Array.Clear(KarLines, KarLines.GetLowerBound(0), KarLines.Length)
        For i = 0 To KarLines.Length - 1
            KarLines(i).sorteren = 4000
        Next


        Dim karcounter As Integer = 1
        Dim linecounter As Integer = 1

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' load header data 
                Dim CmdHeaderString As String = "select * from " + orderheader_db + " WHERE  Header_id = " + Str(header_id) + " "
                Dim CmdHeader As New OdbcCommand(CmdHeaderString, Conn)
                Dim HeaderReader As OdbcDataReader

                HeaderReader = CmdHeader.ExecuteReader
                If HeaderReader.HasRows() Then
                    HeaderReader.Read()
                    Kar_kopernaam_lbl.Text = CHstr(HeaderReader("Koper_naam"))
                    Kar_karvoorkeur_lbl.Text = kar(GID(kar, CHint(HeaderReader("kar_id")))).karnaam
                    KarOrder_versie_lbl.Text = CHstr(HeaderReader("versie"))

                    Kar_vestiging_lbl.Text = "Karindeling " + vestiging(CHint(HeaderReader("vestiging"))).naam
                End If


                ' load locked kar-info & lines

                Dim CmdKarString As String = "select * from " + orderkarren_db + " WHERE  Header_id = " + Str(header_id) + " "
                Dim CmdKar As New OdbcCommand(CmdKarString, Conn)
                Dim KarrenReader As OdbcDataReader

                KarrenReader = CmdKar.ExecuteReader
                Do While KarrenReader.Read()
                    Dim kar_id As Integer = CHint(KarrenReader("kar_id"))
                    KarHeaders(karcounter).tag = True
                    KarHeaders(karcounter).kar_id = kar_id
                    KarHeaders(karcounter).header_id = CHint(KarrenReader("header_id"))
                    KarHeaders(karcounter).aantal_lagen = CHint(KarrenReader("Aantal_lagen"))
                    KarHeaders(karcounter).aantal_lagenlock = CHbool(KarrenReader("Aantal_lagenLock"))
                    KarHeaders(karcounter).kar_type = CHint(KarrenReader("kar_type"))
                    KarHeaders(karcounter).sdf_flag = CHbool(KarrenReader("sdf_flag"))
                    KarHeaders(karcounter).wps_status = CHint(KarrenReader("wps_status"))
                    KarHeaders(karcounter).vervoer_flag = CHbool(KarrenReader("vervoer_flag"))
                    KarHeaders(karcounter).barcode = CHstr(KarrenReader("barcode"))
                    KarHeaders(karcounter).cc_rfid = CHstr(KarrenReader("cc_rfid"))
                    KarHeaders(karcounter).kar_nummer = 0
                    KarHeaders(karcounter).scan_flag = CHbool(KarrenReader("scan_flag"))
                    KarHeaders(karcounter).overgooien_naar = CHstr(KarrenReader("overgooien_naar"))
                    KarHeaders(karcounter).overgooien_hierop = CHstr(KarrenReader("overgooien_hierop"))
                    KarHeaders(karcounter).floriday_printflag = CHint(KarrenReader("floriday_printflag"))
                    'load kar  lines
                    Dim CmdKarLineString As String = "select * from " + orderkarlines_db + " WHERE  kar_id = " + Str(kar_id)
                    Dim CmdKarlines As New OdbcCommand(CmdKarLineString, Conn)
                    Dim KarLineReader As OdbcDataReader
                    KarLineReader = CmdKarlines.ExecuteReader
                    Do While KarLineReader.Read()
                        KarLines(linecounter).tag = True
                        KarLines(linecounter).aantal = CHint(KarLineReader("aantal"))
                        KarLines(linecounter).kar_id = CHint(KarLineReader("kar_id"))
                        KarLines(linecounter).Orderline_id = CHint(KarLineReader("orderline_id"))
                        KarLines(linecounter).wps_flag = CHbool(KarLineReader("wps_flag"))
                        KarLines(linecounter).wps17_flag = CHbool(KarLineReader("wps17_flag"))
                        KarLines(linecounter).header_id = CHint(KarLineReader("header_id"))
                        KarLines(linecounter).kar_nummerref = 0
                        KarLines(linecounter).sorteren = CHint(KarLineReader("sorteren"))
                        KarLines(linecounter).line_id = CHint(KarLineReader("id"))
                        'load extra lineinfo 
                        'load kar  lines
                        Dim CmdInfoLineString As String = "select * from " + orderlines_db + " WHERE  OrderLine_id = " + Str(KarLines(linecounter).Orderline_id)
                        Dim CmdInfolines As New OdbcCommand(CmdInfoLineString, Conn)
                        Dim KarInfoReader As OdbcDataReader
                        KarInfoReader = CmdInfolines.ExecuteReader
                        If KarInfoReader.HasRows Then
                            KarInfoReader.Read()
                            KarLines(linecounter).fustlist_id = GID(fust, CHint(KarInfoReader("Fust_id")))
                            KarLines(linecounter).accessoirelist_id = GID(accessoire, CHint(KarInfoReader("Accessoire1")))
                            KarLines(linecounter).gp = CHint(KarInfoReader("gp"))
                            KarLines(linecounter).opmerking = CHstr(KarInfoReader("Opmerking"))

                            Dim soort_id = CHint(KarInfoReader("Soort_id"))
                            If soort_id < 10000 Then
                                KarLines(linecounter).soortnaam = soorten(GID(soorten, soort_id)).soortnaam
                            Else
                                KarLines(linecounter).soortnaam = mixen(GID(mixen, soort_id - 10000)).naam
                            End If
                            linecounter = linecounter + 1
                        End If

                    Loop
                    karcounter = karcounter + 1
                Loop

                Kar_kopernaam_lbl.Text = Kar_kopernaam_lbl.Text + "    In totaal " + Trim(Str(karcounter - 1)) + " karren."


            End Using
        Catch ex As Exception
            ErrorLog("Fout: Show karindeling" + ex.Message)
            MessageBox.Show("Fout: Show karindeling" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Kar_selectietot_lbl.Text = ""
        Kar_selectietot_lbl.Tag = ""

        Karindeling_Invullen(1)


    End Sub
    Private Sub Karindeling_Invullen(ByVal startkar As Integer)


        ' sorteren kar indeling op volgorde 
        'Create an instance of our comparer
        Dim Comp As New KarLineComparer
        'Now lets use our interface to sort
        Array.Sort(KarLines, Comp)

        ' clear flexgrids
        Kar_flexgrid1.Rows.Count = 1
        Kar_flexgrid2.Rows.Count = 1
        Kar_flexgrid3.Rows.Count = 1
        Kar_flexgrid4.Rows.Count = 1

        Dim lege_kar As String = "N.V.T"

        Kar_nummer1_lbl.Text = Trim(Str(startkar))
        Kar_nummer2_lbl.Text = Trim(Str(startkar + 1))
        Kar_nummer3_lbl.Text = Trim(Str(startkar + 2))
        Kar_nummer4_lbl.Text = Trim(Str(startkar + 3))

        kar_overgooien1_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
        kar_overgooien2_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
        kar_overgooien3_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
        kar_overgooien4_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)

        kar_overgooien1_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
        kar_overgooien2_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
        kar_overgooien3_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
        kar_overgooien4_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)

        Dim karlock As Boolean = False
        For i = 1 To UBound(KarHeaders)
            If KarHeaders(i).floriday_printflag > 0 Then
                karlock = True
            End If
        Next

        If karlock = True Then
            Kar_allesop1_but.Enabled = False
            Kar_SortMartin_but.Enabled = False
            Kar_verdelenals2_but.Enabled = False
            Kar_opnieuwberekenen_but.Enabled = False
            Kar_opnieuwberekeneninvoer_but.Enabled = False
            Kar_plus1_but.Enabled = False
            Kar_plus2_but.Enabled = False
            Kar_plus3_but.Enabled = False
            Kar_plus4_but.Enabled = False
        Else
            Kar_allesop1_but.Enabled = True
            Kar_SortMartin_but.Enabled = True
            Kar_verdelenals2_but.Enabled = True
            Kar_opnieuwberekenen_but.Enabled = True
            Kar_opnieuwberekeneninvoer_but.Enabled = True
            Kar_plus1_but.Enabled = True
            Kar_plus2_but.Enabled = True
            Kar_plus3_but.Enabled = True
            Kar_plus4_but.Enabled = True
        End If

        Dim karindex As Integer = 0
        Dim fixedloop As Integer = 1
        For karloop = startkar To startkar + 3

            If KarHeaders(karloop).tag = True Then
                ' aantal lagen invullen 
                Dim karlist = GID(kar, KarHeaders(karloop).kar_type)
                Select Case KarHeaders(karloop).kar_type
                    Case 1, 2 : karindex = 0
                    Case 3 : karindex = 1
                    Case 8, 9, 12, 13, 14, 15 : karindex = 2
                    Case 16 : karindex = 4
                    Case 4, 5 : karindex = 3
                    Case 6 : karindex = 5
                    Case 7 : karindex = 6
                End Select
                'kartype invullen 
                Select Case fixedloop
                    Case 1
                        Kar_Kartype1_cmb.SelectedIndex = karindex
                    Case 2
                        Kar_Kartype2_cmb.SelectedIndex = karindex
                    Case 3
                        Kar_Kartype3_cmb.SelectedIndex = karindex
                    Case 4
                        Kar_Kartype4_cmb.SelectedIndex = karindex
                End Select


                If kar(karlist).fust_per_laag_code = 1 Then   ''deen 
                    Select Case fixedloop
                        Case 1
                            Kar_lagen1_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            'Kar_lagen1_lbl.Text = "deense lagen"
                            'lege_kar = "deense lagen"
                        Case 2
                            Kar_lagen2_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            'Kar_lagen2_lbl.Text = "deense lagen"
                            'lege_kar = "deense lagen"
                        Case 3
                            Kar_lagen3_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            ' Kar_lagen3_lbl.Text = "deense lagen"
                            'lege_kar = "deense lagen"
                        Case 4
                            Kar_lagen4_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            'Kar_lagen4_lbl.Text = "deense lagen"
                            'lege_kar = "deense lagen"
                    End Select
                End If
                If kar(karlist).fust_per_laag_code = 2 Then   'veilingkar 
                    Select Case fixedloop
                        Case 1
                            Kar_lagen1_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            'Kar_lagen1_lbl.Text = "extra platen en 1 kar"
                           ' lege_kar = "extra platen en 1 kar"
                        Case 2
                            Kar_lagen2_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            ' Kar_lagen2_lbl.Text = "extra platen en 1 kar"
                           ' lege_kar = "extra platen en 1 kar"
                        Case 3
                            Kar_lagen3_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            '  Kar_lagen3_lbl.Text = "extra platen en 1 kar"
                          '  lege_kar = "extra platen en 1 kar"
                        Case 4
                            Kar_lagen4_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            ' Kar_lagen4_lbl.Text = "extra platen en 1 kar"
                            ' lege_kar = "extra platen en 1 kar"
                    End Select
                End If
                If kar(karlist).fust_per_laag_code = 3 Then   'pallets e.d.
                    Select Case fixedloop
                        Case 1
                            Kar_lagen1_txt.Text = ""
                            '  Kar_lagen1_lbl.Text = "N.V.T."
                          '  lege_kar = "N.V.T."
                        Case 2
                            Kar_lagen2_txt.Text = ""
                            '  Kar_lagen2_lbl.Text = "N.V.T."
                           ''   lege_kar = "N.V.T."
                        Case 3
                            Kar_lagen3_txt.Text = ""
                            '  Kar_lagen3_lbl.Text = "N.V.T."
                          '  lege_kar = "N.V.T."
                        Case 4
                            Kar_lagen4_txt.Text = ""
                            '  Kar_lagen4_lbl.Text = "N.V.T."
                            '  lege_kar = "N.V.T."
                    End Select
                End If
                If KarHeaders(karloop).kar_type = 10 Or KarHeaders(karloop).kar_type = 11 Then 'DV's 
                    Select Case fixedloop
                        Case 1
                            If startkar = 1 Then
                                Kar_lagen1_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                                '   Kar_lagen1_lbl.Text = "extra platen en 1 kar"
                                '    lege_kar = "extra platen en 1 kar"
                            Else
                                Kar_lagen1_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                                '   Kar_lagen1_lbl.Text = "deense lagen"
                                '   lege_kar = "deense lagen"
                            End If
                        Case 2
                            Kar_lagen2_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            'Kar_lagen2_lbl.Text = "deense lagen"
                           'lege_kar = "deense lagen"
                        Case 3
                            Kar_lagen3_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            ' Kar_lagen3_lbl.Text = "deense lagen"
                           ' lege_kar = "deense lagen"
                        Case 4
                            Kar_lagen4_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                            ' Kar_lagen4_lbl.Text = "deense lagen"
                            ' lege_kar = "deense lagen"
                    End Select
                End If

                '
                ' sdf verstuurd/vervoer/barcode/rfid
                Select Case fixedloop
                    Case 1
                        Kar_sdfverzonden1_chk.Checked = KarHeaders(karloop).sdf_flag
                        'Kar_scanready1_chk.Checked = KarHeaders(karloop).scan_flag
                        Kar_vervoer1_chk.Checked = KarHeaders(karloop).vervoer_flag
                        Kar_barcode1_txt.Text = KarHeaders(karloop).barcode
                        Kar_rfid1_txt.Text = KarHeaders(karloop).cc_rfid
                        If KarHeaders(karloop).floriday_printflag = 0 Then
                            Kar_fdverzonden1_chk.Checked = False
                        Else
                            Kar_fdverzonden1_chk.Checked = True
                        End If
                    Case 2
                        Kar_sdfverzonden2_chk.Checked = KarHeaders(karloop).sdf_flag
                        'Kar_scanready2_chk.Checked = KarHeaders(karloop).scan_flag
                        Kar_vervoer2_chk.Checked = KarHeaders(karloop).vervoer_flag
                        Kar_barcode2_txt.Text = KarHeaders(karloop).barcode
                        Kar_rfid2_txt.Text = KarHeaders(karloop).cc_rfid
                        If KarHeaders(karloop).floriday_printflag = 0 Then
                            Kar_fdverzonden2_chk.Checked = False
                        Else
                            Kar_fdverzonden2_chk.Checked = True
                        End If
                    Case 3
                        Kar_sdfverzonden3_chk.Checked = KarHeaders(karloop).sdf_flag
                        'Kar_scanready3_chk.Checked = KarHeaders(karloop).scan_flag
                        Kar_vervoer3_chk.Checked = KarHeaders(karloop).vervoer_flag
                        Kar_barcode3_txt.Text = KarHeaders(karloop).barcode
                        Kar_rfid3_txt.Text = KarHeaders(karloop).cc_rfid
                        If KarHeaders(karloop).floriday_printflag = 0 Then
                            Kar_fdverzonden3_chk.Checked = False
                        Else
                            Kar_fdverzonden3_chk.Checked = True
                        End If
                    Case 4
                        Kar_sdfverzonden4_chk.Checked = KarHeaders(karloop).sdf_flag
                        'Kar_scanready4_chk.Checked = KarHeaders(karloop).scan_flag
                        Kar_vervoer4_chk.Checked = KarHeaders(karloop).vervoer_flag
                        Kar_barcode4_txt.Text = KarHeaders(karloop).barcode
                        Kar_rfid4_txt.Text = KarHeaders(karloop).cc_rfid
                        If KarHeaders(karloop).floriday_printflag = 0 Then
                            Kar_fdverzonden4_chk.Checked = False
                        Else
                            Kar_fdverzonden4_chk.Checked = True
                        End If
                End Select



                ' karlagen lock 
                Select Case fixedloop
                    Case 1
                        If KarHeaders(karloop).aantal_lagenlock = True Then
                            Kar_lagenlock1_but.BackColor = Color.Red
                        Else
                            Kar_lagenlock1_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 2
                        If KarHeaders(karloop).aantal_lagenlock = True Then
                            Kar_lagenlock2_but.BackColor = Color.Red
                        Else
                            Kar_lagenlock2_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 3
                        If KarHeaders(karloop).aantal_lagenlock = True Then
                            Kar_lagenlock3_but.BackColor = Color.Red
                        Else
                            Kar_lagenlock3_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 4
                        If KarHeaders(karloop).aantal_lagenlock = True Then
                            Kar_lagenlock4_but.BackColor = Color.Red
                        Else
                            Kar_lagenlock4_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                End Select

                'overgooien naar
                Select Case fixedloop
                    Case 1
                        If Not (KarHeaders(karloop).overgooien_naar = "" Or KarHeaders(karloop).overgooien_naar = "-") Then
                            kar_overgooien1_naar_but.BackColor = Color.Red
                        Else
                            kar_overgooien1_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 2
                        If Not (KarHeaders(karloop).overgooien_naar = "" Or KarHeaders(karloop).overgooien_naar = "-") Then
                            kar_overgooien2_naar_but.BackColor = Color.Red
                        Else
                            kar_overgooien2_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 3
                        If Not (KarHeaders(karloop).overgooien_naar = "" Or KarHeaders(karloop).overgooien_naar = "-") Then
                            kar_overgooien3_naar_but.BackColor = Color.Red
                        Else
                            kar_overgooien3_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 4
                        If Not (KarHeaders(karloop).overgooien_naar = "" Or KarHeaders(karloop).overgooien_naar = "-") Then
                            kar_overgooien4_naar_but.BackColor = Color.Red
                        Else
                            kar_overgooien4_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                End Select

                'overgooien hierop
                Select Case fixedloop
                    Case 1
                        If Not (KarHeaders(karloop).overgooien_hierop = "" Or KarHeaders(karloop).overgooien_hierop = "-") Then
                            kar_overgooien1_hierop_but.BackColor = Color.Red
                        Else
                            kar_overgooien1_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 2
                        If Not (KarHeaders(karloop).overgooien_hierop = "" Or KarHeaders(karloop).overgooien_hierop = "-") Then
                            kar_overgooien2_hierop_but.BackColor = Color.Red
                        Else
                            kar_overgooien2_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 3
                        If Not (KarHeaders(karloop).overgooien_hierop = "" Or KarHeaders(karloop).overgooien_hierop = "-") Then
                            kar_overgooien3_hierop_but.BackColor = Color.Red
                        Else
                            kar_overgooien3_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                    Case 4
                        If Not (KarHeaders(karloop).overgooien_hierop = "" Or KarHeaders(karloop).overgooien_hierop = "-") Then
                            kar_overgooien4_hierop_but.BackColor = Color.Red
                        Else
                            kar_overgooien4_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        End If
                End Select

                ' lines 

                Dim totaalfust1 As Integer = 0
                Dim totaalfust2 As Integer = 0
                Dim totaalstring As String = ""
                Dim fust_id1 As Integer = -1
                Dim fust_id2 As Integer = -1
                'voor totalen:  2 fust max, bij meer -> diverse

                For lineloop = 0 To Max_Kar_Lines - 1
                    If KarLines(lineloop).tag = True Then

                        If KarLines(lineloop).kar_id = KarHeaders(karloop).kar_id Then

                            'totalen berekenen
                            If fust_id1 >= 0 And fust_id2 >= 0 Then
                                If KarLines(lineloop).fustlist_id <> fust_id1 And KarLines(lineloop).fustlist_id <> fust_id2 Then
                                    totaalstring = "Diverse"
                                End If
                            End If
                            If fust_id1 >= 0 And fust_id2 = -1 And KarLines(lineloop).fustlist_id <> fust_id1 Then
                                fust_id2 = KarLines(lineloop).fustlist_id
                            End If
                            If fust_id1 = -1 Then
                                fust_id1 = KarLines(lineloop).fustlist_id
                            End If
                            If KarLines(lineloop).fustlist_id = fust_id1 Then
                                totaalfust1 = totaalfust1 + KarLines(lineloop).aantal
                            End If
                            If KarLines(lineloop).fustlist_id = fust_id2 Then
                                totaalfust2 = totaalfust2 + KarLines(lineloop).aantal
                            End If

                            Dim soortlistline As String = ""
                            'soorten/fust/wps in lijst zetten
                            If KarLines(lineloop).gp > 1 Then
                                soortlistline = soortlistline + Trim(Str(KarLines(lineloop).gp)) + " x "
                            End If
                            soortlistline = soortlistline + Trim(Str(KarLines(lineloop).aantal)) + " x "
                            soortlistline = soortlistline + Trim(Str(fust(KarLines(lineloop).fustlist_id).aantal_per_fust)) + " "
                            soortlistline = soortlistline + KarLines(lineloop).soortnaam + " "

                            If accessoire(KarLines(lineloop).accessoirelist_id).fust > 0 Or accessoire(KarLines(lineloop).accessoirelist_id).prijslijst > 0 Then
                                soortlistline = soortlistline + accessoire(KarLines(lineloop).accessoirelist_id).naam
                            End If
                            Dim wpslist As Boolean = KarLines(lineloop).wps_flag
                            Dim wps17 As Boolean = KarLines(lineloop).wps17_flag
                            Dim fustnaamlist As String = fust(KarLines(lineloop).fustlist_id).fustnaam
                            Dim extra As String = KarLines(lineloop).opmerking
                            Dim listadd(6) As String

                            listadd(0) = soortlistline
                            listadd(1) = wpslist
                            listadd(2) = wps17
                            listadd(3) = fustnaamlist
                            listadd(4) = lineloop
                            listadd(5) = extra

                            Select Case fixedloop
                                Case 1 : Kar_flexgrid1.AddItem(listadd)
                                Case 2 : Kar_flexgrid2.AddItem(listadd)
                                Case 3 : Kar_flexgrid3.AddItem(listadd)
                                Case 4 : Kar_flexgrid4.AddItem(listadd)
                            End Select
                        End If
                    End If
                Next

                If totaalstring = "" Then
                    If totaalfust1 > 0 Then
                        totaalstring = Trim(Str(totaalfust1)) + " x " + Trim(Str(fust(fust_id1).aantal_per_fust)) + " "
                    End If
                    If totaalfust2 > 0 Then
                        totaalstring = totaalstring + "  +  " + Trim(Str(totaalfust2)) + " x " + Trim(Str(fust(fust_id2).aantal_per_fust)) + " "
                    End If
                    totaalstring = totaalstring + "Totaal"
                End If

                'totalen 
                Select Case fixedloop
                    Case 1
                        Kar_aantaltotaal1_lbl.Text = totaalstring
                    Case 2
                        Kar_aantaltotaal2_lbl.Text = totaalstring
                    Case 3
                        Kar_aantaltotaal3_lbl.Text = totaalstring
                    Case 4
                        Kar_aantaltotaal4_lbl.Text = totaalstring
                End Select

            Else
                'erase empty grids

                Select Case fixedloop
                    Case 1
                        Kar_Kartype1_cmb.SelectedIndex = karindex
                    Case 2
                        Kar_Kartype2_cmb.SelectedIndex = karindex
                    Case 3
                        Kar_Kartype3_cmb.SelectedIndex = karindex
                    Case 4
                        Kar_Kartype4_cmb.SelectedIndex = karindex
                End Select


                Select Case fixedloop 'erase kartypes
                    Case 1
                        Kar_lagen1_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                        'Kar_lagen1_lbl.Text = lege_kar
                    Case 2
                        Kar_lagen2_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                       ' Kar_lagen2_lbl.Text = lege_kar
                    Case 3
                        Kar_lagen3_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                       ' Kar_lagen3_lbl.Text = lege_kar
                    Case 4
                        Kar_lagen4_txt.Text = Trim(Str(KarHeaders(karloop).aantal_lagen))
                        '  Kar_lagen4_lbl.Text = lege_kar
                End Select
                Select Case fixedloop  'erase extra vars
                    Case 1
                        Kar_lagenlock1_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        Kar_sdfverzonden1_chk.Checked = False
                        Kar_fdverzonden1_chk.Checked = False
                        'Kar_scanready1_chk.Checked = False
                        Kar_vervoer1_chk.Checked = False
                        Kar_barcode1_txt.Text = ""
                        Kar_rfid1_txt.Text = ""
                        Kar_aantaltotaal1_lbl.Text = ""
                    Case 2
                        Kar_lagenlock2_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        Kar_sdfverzonden2_chk.Checked = False
                        Kar_fdverzonden2_chk.Checked = False
                        'Kar_scanready2_chk.Checked = False
                        Kar_vervoer2_chk.Checked = False
                        Kar_barcode2_txt.Text = ""
                        Kar_rfid2_txt.Text = ""
                        Kar_aantaltotaal2_lbl.Text = ""
                    Case 3
                        Kar_lagenlock3_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        Kar_sdfverzonden3_chk.Checked = False
                        Kar_fdverzonden3_chk.Checked = False
                        'Kar_scanready3_chk.Checked = False
                        Kar_vervoer3_chk.Checked = False
                        Kar_barcode3_txt.Text = ""
                        Kar_rfid3_txt.Text = ""
                        Kar_aantaltotaal3_lbl.Text = ""
                    Case 4
                        Kar_lagenlock4_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                        Kar_sdfverzonden4_chk.Checked = False
                        Kar_fdverzonden4_chk.Checked = False
                        'Kar_scanready4_chk.Checked = False
                        Kar_vervoer4_chk.Checked = False
                        Kar_barcode4_txt.Text = ""
                        Kar_rfid4_txt.Text = ""
                        Kar_aantaltotaal4_lbl.Text = ""
                End Select
            End If
            fixedloop = fixedloop + 1

        Next karloop
    End Sub
    Private Sub Kar_Opslaan_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_opslaan2_but.Click
        PanelKarindelingOnder.Enabled = False
        PanelKarindelingMidden.Enabled = False
        PanelKarIndelingBoven.Enabled = False
        Kar_opslaanMain()

        If C1Tab.TabPages(0).Enabled = True Then  'order invoer
            C1Tab.SelectedTab = C1Tab.TabPages(0)
        End If

        If C1Tab.TabPages(2).Enabled = True Then  'floriday
            C1Tab.SelectedTab = C1Tab.TabPages(2)
        End If

        If C1Tab.TabPages(3).Enabled = True Then  'florecom
            C1Tab.SelectedTab = C1Tab.TabPages(3)
        End If

        'zoek eerste header
        Dim header_id = -1
        Dim header_id2 As Integer = -1
        For i = 1 To Max_Kar_Headers
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If
        'zoek tweede header
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'write new info to database
                Dim koppelnummer As Integer = 0
                Dim Cmdr As New OdbcCommand("select koppelnummer from orderheaders WHERE header_id=?", Conn)
                Cmdr.Parameters.Clear()
                Cmdr.Parameters.AddWithValue("", header_id)
                Dim Reader As OdbcDataReader
                Reader = Cmdr.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    koppelnummer = CHint(Reader("koppelnummer"))
                End If
                Reader.Close()
                If koppelnummer > 0 Then
                    Dim Cmdr2 As New OdbcCommand("select header_id from orderheaders WHERE header_id<>? AND koppelnummer=?", Conn)
                    Cmdr2.Parameters.Clear()
                    Cmdr2.Parameters.AddWithValue("", header_id)
                    Cmdr2.Parameters.AddWithValue("", koppelnummer)
                    Dim Reader2 As OdbcDataReader
                    Reader2 = Cmdr2.ExecuteReader()

                    If Reader2.HasRows Then
                        Reader2.Read()
                        header_id2 = CHint(Reader2("header_id"))
                    End If
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Fout Wissel karindeling: " + ex.Message)
            MsgBox("Fout Wissel karindeling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        If Kar_markeer_chk.Checked = False Then
            If header_id > 0 Then SetMark(False, header_id)
            If header_id2 > 0 Then SetMark(False, header_id2)
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id)
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id2)
            Set_BoekInstellingen(0, 0, 6)
            Update_Boek()
            overgooier = ""

        Else
            If header_id > 0 Then SetMark(True, header_id)
            If header_id2 > 0 Then SetMark(True, header_id2)
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id)
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id2)
            Set_BoekInstellingen(0, 0, 6)
            Update_Boek()
            overgooier = ""

        End If

    End Sub
    Private Sub Kar_opslaanMain()

        Dim orderyear As String = Trim(Str(Year(karindeling_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear

        Dim header_id = -1
        For i = 1 To Max_Kar_Headers
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If

        'check of de order door iemand anders is aangepast in de tussentijd 

        If Order_is_aangepast(Val(KarOrder_versie_lbl.Text), orderheader_db, header_id) = True Then
            MsgBox("Deze order is aangepast in de tijd dat de order door u bewerkt werd, deze order kan niet worden opgeslagen, probeer opnieuw", vbOKOnly)
            Exit Sub
        End If

        Dim karlock As Boolean = False
        For i = 1 To UBound(KarHeaders)
            If KarHeaders(i).floriday_printflag > 0 Then
                karlock = True
            End If
        Next

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'is het een gp?
                Dim gpaantal As Integer = 1
                Dim Cmd15 As New OdbcCommand("SELECT gp from orderlines where orderheader_id=?", Conn)
                Cmd15.Parameters.Clear()
                Cmd15.Parameters.AddWithValue("", header_id)
                Dim reader15 As OdbcDataReader
                reader15 = Cmd15.ExecuteReader()
                If reader15.HasRows Then
                    reader15.Read()
                    gpaantal = CHint(reader15("gp"))
                End If


                If karlock = False Then   'nieuwe karindeling opslaan

                    ' delete kar-info & lines from database 
                    ' delete all non-locked karinfo
                    Dim DelString As String = "DELETE FROM " + orderkarren_db + " WHERE header_id='" + Str(header_id) + "'"
                    Dim DelCmd As New OdbcCommand(DelString, Conn)
                    DelCmd.ExecuteNonQuery()

                    ' delete all kar-line info
                    Dim DelString2 As String = "DELETE FROM " + orderkarlines_db + " WHERE header_id='" + Str(header_id) + "'"
                    Dim DelCmd2 As New OdbcCommand(DelString2, Conn)
                    DelCmd2.ExecuteNonQuery()

                    For karcounter = 1 To Max_Kar_Headers
                        If KarHeaders(karcounter).tag = True Then

                            'extra check, heeft deze kar nog wel lagen?
                            Dim linecheck As Boolean = False
                            For karlinecounter = 0 To Max_Kar_Lines
                                If KarLines(karlinecounter).tag = True And KarLines(karlinecounter).kar_id = KarHeaders(karcounter).kar_id Then
                                    linecheck = True
                                    Exit For
                                End If
                            Next karlinecounter
                            If linecheck = True Then

                                'Execute Query
                                Dim cmdstring As String = "SELECT * FROM " + orderkarren_db + " WHERE 1=0"
                                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                                With Cmd

                                    .CommandText = "INSERT INTO " + orderkarren_db + "(header_id,kar_type,aantal_lagen,aantal_lagenlock,sdf_flag,wps_status,vervoer_flag,barcode,cc_rfid,scan_flag,overgooien_naar,overgooien_hierop)" _
                                                    & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?)"
                                    .Parameters.Clear()
                                    .Parameters.AddWithValue("", header_id)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).kar_type)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagen)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagenlock)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).sdf_flag)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).wps_status)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).vervoer_flag)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).barcode)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).cc_rfid)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).scan_flag)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).overgooien_naar)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).overgooien_hierop)

                                    .ExecuteNonQuery()

                                    KarHeaders(karcounter).kar_nummer = KarHeaders(karcounter).kar_id    'oude id opslaan om karlines te koppelen 
                                    ' fetch header
                                    If postgress = True Then
                                        Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('orderkarren','kar_id'))", Conn)
                                        KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                    Else
                                        Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                        KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                    End If
                                End With
                            End If
                        End If
                    Next karcounter

                    'karlines opslaan

                    Dim cmdstring6 As String = "SELECT * FROM " + orderkarlines_db + " WHERE 1=0"
                    For karlinecounter = 0 To Max_Kar_Lines
                        If KarLines(karlinecounter).tag = True Then

                            'Execute Query
                            Dim Cmd As New OdbcCommand(cmdstring6, Conn)
                            With Cmd

                                'Get new SDF barcode
                                Dim sdfbarcode2 As Integer = 0
                                Dim reader5 As OdbcDataReader
                                Dim Cmd2 As New OdbcCommand("SELECT sdfbarcode2 from instellingen", Conn)
                                reader5 = Cmd2.ExecuteReader()
                                If reader5.HasRows Then
                                    reader5.Read()
                                    sdfbarcode2 = CHint(reader5("sdfbarcode2"))
                                    sdfbarcode2 = sdfbarcode2 + 1
                                    If sdfbarcode2 >= 100000000 Then sdfbarcode2 = 1
                                    reader5.Close()
                                    Cmd2.CommandText = "UPDATE instellingen SET sdfbarcode2 = ?"
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", sdfbarcode2)
                                    Cmd2.ExecuteNonQuery()
                                End If


                                .CommandText = "INSERT INTO " + orderkarlines_db + "(kar_id,aantal,Orderline_id,wps_flag,wps17_flag,header_id,sorteren,sdfbarcode2)" _
                                                & "VALUES(?,?,?,?,?,?,?,?)"

                                ' line id's van nieuwe karren koppelen aan kar id's 
                                For karcounter2 = 1 To Max_Kar_Headers
                                    KarHeaders(karcounter2).tag = True
                                    If KarHeaders(karcounter2).kar_nummer = KarLines(karlinecounter).kar_id Then
                                        KarLines(karlinecounter).kar_id = KarHeaders(karcounter2).kar_id
                                        Exit For
                                    End If
                                Next
                                .Parameters.Clear()
                                .Parameters.AddWithValue("", KarLines(karlinecounter).kar_id)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).aantal)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).Orderline_id)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).wps_flag)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).wps17_flag)
                                .Parameters.AddWithValue("", header_id)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).sorteren)
                                .Parameters.AddWithValue("", sdfbarcode2)
                                .ExecuteNonQuery()

                            End With

                        End If
                    Next karlinecounter


                Else    'Karren zijn gelocked , alleen update opslaan
                    Dim Cmd As New OdbcCommand("", Conn)
                    For karcounter = 1 To Max_Kar_Headers
                        If KarHeaders(karcounter).tag = True Then

                            'Execute Query
                            Cmd.CommandText = "UPDATE orderkarren SET kar_type=?,aantal_lagen=?,aantal_lagenlock=?,sdf_flag=?,wps_status=?,vervoer_flag=?,barcode=?,overgooien_naar=?,overgooien_hierop=? WHERE kar_id=?"
                            Cmd.Parameters.Clear()
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).kar_type)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagen)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagenlock)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).sdf_flag)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).wps_status)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).vervoer_flag)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).barcode)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).overgooien_naar)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).overgooien_hierop)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).kar_id)
                            Cmd.ExecuteNonQuery()

                        End If

                    Next karcounter

                    'karlines opslaan

                    For karlinecounter = 0 To Max_Kar_Lines
                        If KarLines(karlinecounter).tag = True Then
                            Cmd.CommandText = "UPDATE orderkarlines SET wps_flag=?,wps17_flag=?,sorteren=? WHERE id=?"
                            Cmd.Parameters.Clear()
                            Cmd.Parameters.AddWithValue("", KarLines(karlinecounter).wps_flag)
                            Cmd.Parameters.AddWithValue("", KarLines(karlinecounter).wps17_flag)
                            Cmd.Parameters.AddWithValue("", KarLines(karlinecounter).sorteren)
                            Cmd.Parameters.AddWithValue("", KarLines(karlinecounter).line_id)
                            Cmd.ExecuteNonQuery()
                        End If
                    Next karlinecounter

                End If

                'header overzicht berekenen voor snel overzicht.

                If jenptenhave = True Then
                    Dim aantal_karren As Integer = GetKarCount(orderyear, header_id)
                    Dim p12 As Integer = GetBakCount(header_id, 120, 139)
                    Dim p14 As Integer = GetBakCount(header_id, 140, 169)
                    Dim p17 As Integer = GetBakCount(header_id, 170, 200)
                    Dim bakverdeling As String = ""
                    If gpaantal > 1 Then
                        bakverdeling = bakverdeling + Trim(Str(gpaantal)) + "x"
                    End If
                    If p12 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p12)) + "x12 "
                    End If
                    If p14 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p14)) + "x14 "
                    End If
                    If p17 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p17)) + "x17 "
                    End If

                    Dim Cmd2 As New OdbcCommand("UPDATE orderheaders SET aantal_karren=?, bakverdeling=? WHERE header_id = ?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", aantal_karren)
                    Cmd2.Parameters.AddWithValue("", bakverdeling)
                    Cmd2.Parameters.AddWithValue("", header_id)
                    Cmd2.ExecuteNonQuery()
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Fout: opslag karindeling" + ex.Message)
            MsgBox("Fout opslag karindeling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        'If jenptenhave = False Then
        ' SetMark(False, header_id)
        ' End If

        'SetNewStatusFlag(karindeling_date, header_id)
        Set_Boek_reload()
        ' Update_Boek()

    End Sub


    Private Sub Kar_opslaanMainNew()


        ' NOT USED ATM

        Dim orderyear As String = Trim(Str(Year(karindeling_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear
        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear

        Dim header_id = -1
        For i = 1 To Max_Kar_Headers
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If

        'check of de order door iemand anders is aangepast in de tussentijd 

        If Order_is_aangepast(Val(KarOrder_versie_lbl.Text), orderheader_db, header_id) = True Then
            MsgBox("Deze order is aangepast in de tijd dat de order door u bewerkt werd, deze order kan niet worden opgeslagen, probeer opnieuw", vbOKOnly)
            Exit Sub
        End If

        Dim karlock As Boolean = False
        For i = 1 To UBound(KarHeaders)
            If KarHeaders(i).floriday_printflag > 0 Then
                karlock = True
            End If
        Next

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'is het een gp?
                Dim gpaantal As Integer = 1
                Dim Cmd15 As New OdbcCommand("SELECT gp from orderlines where orderheader_id=?", Conn)
                Cmd15.Parameters.Clear()
                Cmd15.Parameters.AddWithValue("", header_id)
                Dim reader15 As OdbcDataReader
                reader15 = Cmd15.ExecuteReader()
                If reader15.HasRows Then
                    reader15.Read()
                    gpaantal = CHint(reader15("gp"))
                End If


                If karlock = False Then   'nieuwe karindeling opslaan

                    ' delete kar-info & lines from database 
                    ' delete all non-locked karinfo
                    Dim DelString As String = "DELETE FROM " + orderkarren_db + " WHERE header_id='" + Str(header_id) + "'"
                    Dim DelCmd As New OdbcCommand(DelString, Conn)
                    DelCmd.ExecuteNonQuery()

                    ' delete all kar-line info
                    Dim DelString2 As String = "DELETE FROM " + orderkarlines_db + " WHERE header_id='" + Str(header_id) + "'"
                    Dim DelCmd2 As New OdbcCommand(DelString2, Conn)
                    DelCmd2.ExecuteNonQuery()

                    For karcounter = 1 To Max_Kar_Headers
                        If KarHeaders(karcounter).tag = True Then

                            'extra check, heeft deze kar nog wel lagen?
                            Dim linecheck As Boolean = False
                            For karlinecounter = 0 To Max_Kar_Lines
                                If KarLines(karlinecounter).tag = True And KarLines(karlinecounter).kar_id = KarHeaders(karcounter).kar_id Then
                                    linecheck = True
                                    Exit For
                                End If
                            Next karlinecounter
                            If linecheck = True Then

                                'Execute Query
                                Dim cmdstring As String = "SELECT * FROM " + orderkarren_db + " WHERE 1=0"
                                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                                With Cmd

                                    .CommandText = "INSERT INTO " + orderkarren_db + "(header_id,kar_type,aantal_lagen,aantal_lagenlock,sdf_flag,wps_status,vervoer_flag,barcode,cc_rfid,scan_flag,overgooien_naar,overgooien_hierop)" _
                                                    & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?)"
                                    .Parameters.Clear()
                                    .Parameters.AddWithValue("", header_id)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).kar_type)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagen)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagenlock)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).sdf_flag)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).wps_status)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).vervoer_flag)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).barcode)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).cc_rfid)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).scan_flag)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).overgooien_naar)
                                    .Parameters.AddWithValue("", KarHeaders(karcounter).overgooien_hierop)

                                    .ExecuteNonQuery()

                                    KarHeaders(karcounter).kar_nummer = KarHeaders(karcounter).kar_id    'oude id opslaan om karlines te koppelen 
                                    ' fetch header
                                    If postgress = True Then
                                        Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('orderkarren','kar_id'))", Conn)
                                        KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                    Else
                                        Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                        KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                                    End If
                                End With
                            End If
                        End If
                    Next karcounter

                    'karlines opslaan

                    Dim cmdstring6 As String = "SELECT * FROM " + orderkarlines_db + " WHERE 1=0"
                    For karlinecounter = 0 To Max_Kar_Lines
                        If KarLines(karlinecounter).tag = True Then

                            'Execute Query
                            Dim Cmd As New OdbcCommand(cmdstring6, Conn)
                            With Cmd

                                'Get new SDF barcode
                                Dim sdfbarcode2 As Integer = 0
                                Dim reader5 As OdbcDataReader
                                Dim Cmd2 As New OdbcCommand("SELECT sdfbarcode2 from instellingen", Conn)
                                reader5 = Cmd2.ExecuteReader()
                                If reader5.HasRows Then
                                    reader5.Read()
                                    sdfbarcode2 = CHint(reader5("sdfbarcode2"))
                                    sdfbarcode2 = sdfbarcode2 + 1
                                    If sdfbarcode2 >= 100000000 Then sdfbarcode2 = 1
                                    reader5.Close()
                                    Cmd2.CommandText = "UPDATE instellingen SET sdfbarcode2 = ?"
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", sdfbarcode2)
                                    Cmd2.ExecuteNonQuery()
                                End If


                                .CommandText = "INSERT INTO " + orderkarlines_db + "(kar_id,aantal,Orderline_id,wps_flag,wps17_flag,header_id,sorteren,sdfbarcode2)" _
                                                & "VALUES(?,?,?,?,?,?,?,?)"

                                ' line id's van nieuwe karren koppelen aan kar id's 
                                For karcounter2 = 1 To Max_Kar_Headers
                                    KarHeaders(karcounter2).tag = True
                                    If KarHeaders(karcounter2).kar_nummer = KarLines(karlinecounter).kar_id Then
                                        KarLines(karlinecounter).kar_id = KarHeaders(karcounter2).kar_id
                                        Exit For
                                    End If
                                Next
                                .Parameters.Clear()
                                .Parameters.AddWithValue("", KarLines(karlinecounter).kar_id)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).aantal)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).Orderline_id)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).wps_flag)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).wps17_flag)
                                .Parameters.AddWithValue("", header_id)
                                .Parameters.AddWithValue("", KarLines(karlinecounter).sorteren)
                                .Parameters.AddWithValue("", sdfbarcode2)
                                .ExecuteNonQuery()

                            End With

                        End If
                    Next karlinecounter


                Else    'Karren zijn gelocked , alleen update opslaan
                    Dim Cmd As New OdbcCommand("", Conn)
                    For karcounter = 1 To Max_Kar_Headers
                        If KarHeaders(karcounter).tag = True Then

                            'Execute Query
                            Cmd.CommandText = "UPDATE orderkarren SET aantal_lagen=?,aantal_lagenlock=?,sdf_flag=?,wps_status=?,vervoer_flag=?,barcode=?,overgooien_naar=?,overgooien_hierop=? WHERE kar_id=?"
                            Cmd.Parameters.Clear()
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagen)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagenlock)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).sdf_flag)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).wps_status)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).vervoer_flag)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).barcode)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).overgooien_naar)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).overgooien_hierop)
                            Cmd.Parameters.AddWithValue("", KarHeaders(karcounter).kar_id)
                            Cmd.ExecuteNonQuery()

                        End If

                    Next karcounter

                    'karlines opslaan

                    For karlinecounter = 0 To Max_Kar_Lines
                        If KarLines(karlinecounter).tag = True Then
                            Cmd.CommandText = "UPDATE orderkarlines SET wps_flag=?,wps17_flag=?,sorteren=? WHERE id=?"
                            Cmd.Parameters.Clear()
                            Cmd.Parameters.AddWithValue("", KarLines(karlinecounter).wps_flag)
                            Cmd.Parameters.AddWithValue("", KarLines(karlinecounter).wps17_flag)
                            Cmd.Parameters.AddWithValue("", KarLines(karlinecounter).sorteren)
                            Cmd.Parameters.AddWithValue("", KarLines(karlinecounter).line_id)
                            Cmd.ExecuteNonQuery()
                        End If
                    Next karlinecounter

                End If

                'header overzicht berekenen voor snel overzicht.

                If jenptenhave = True Then
                    Dim aantal_karren As Integer = GetKarCount(orderyear, header_id)
                    Dim p12 As Integer = GetBakCount(header_id, 120, 139)
                    Dim p14 As Integer = GetBakCount(header_id, 140, 169)
                    Dim p17 As Integer = GetBakCount(header_id, 170, 200)
                    Dim bakverdeling As String = ""
                    If gpaantal > 1 Then
                        bakverdeling = bakverdeling + Trim(Str(gpaantal)) + "x"
                    End If
                    If p12 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p12)) + "x12 "
                    End If
                    If p14 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p14)) + "x14 "
                    End If
                    If p17 > 0 Then
                        bakverdeling = bakverdeling + Trim(Str(p17)) + "x17 "
                    End If

                    Dim Cmd2 As New OdbcCommand("UPDATE orderheaders SET aantal_karren=?, bakverdeling=? WHERE header_id = ?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", aantal_karren)
                    Cmd2.Parameters.AddWithValue("", bakverdeling)
                    Cmd2.Parameters.AddWithValue("", header_id)
                    Cmd2.ExecuteNonQuery()
                End If


            End Using
        Catch ex As Exception
            ErrorLog("Fout: opslag karindeling" + ex.Message)
            MsgBox("Fout opslag karindeling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        'If jenptenhave = False Then
        ' SetMark(False, header_id)
        ' End If

        'SetNewStatusFlag(karindeling_date, header_id)
        Set_Boek_reload()
        ' Update_Boek()

    End Sub


    Private Sub HScrollBar1_Scroll(ByVal sender As System.Object, ByVal e As System.Windows.Forms.ScrollEventArgs) Handles HScrollBar1.Scroll
        Karindeling_Invullen(HScrollBar1.Value)
    End Sub

    Private Sub Kar_flexgrid1_AfterEdit(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Kar_flexgrid1.AfterEdit

        'wps vinkje aanzetten/uitzetten verwerken
        With Kar_flexgrid1
            Dim selected_row As Integer = .RowSel
            Dim selected_col As Integer = .ColSel
            If selected_row > 0 Then
                If selected_col = 1 Then
                    Dim line_id As Integer = .GetData(selected_row, 4)
                    KarLines(line_id).wps_flag = .GetData(selected_row, 1)
                End If
                If selected_col = 2 Then
                    Dim line_id As Integer = .GetData(selected_row, 4)
                    If FetchWps17(line_id) = True Then
                        .SetData(selected_row, 2, True)
                    Else
                        KarLines(line_id).wps17_flag = .GetData(selected_row, 2)
                    End If

                End If
            End If
        End With

    End Sub
    Private Sub Kar_flexgrid2_AfterEdit(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Kar_flexgrid2.AfterEdit

        'wps vinkje aanzetten/uitzetten verwerken
        With Kar_flexgrid2
            Dim selected_row As Integer = .RowSel
            Dim selected_col As Integer = .ColSel
            If selected_row > 0 Then
                If selected_col = 1 Then
                    Dim line_id As Integer = .GetData(selected_row, 4)
                    KarLines(line_id).wps_flag = .GetData(selected_row, 1)
                End If
                If selected_col = 2 Then
                    Dim line_id As Integer = .GetData(selected_row, 4)
                    If FetchWps17(line_id) = True Then
                        .SetData(selected_row, 2, True)
                    Else
                        KarLines(line_id).wps17_flag = .GetData(selected_row, 2)
                    End If
                End If
            End If
        End With

    End Sub
    Private Sub Kar_flexgrid3_AfterEdit(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Kar_flexgrid3.AfterEdit

        'wps vinkje aanzetten/uitzetten verwerken
        With Kar_flexgrid3
            Dim selected_row As Integer = .RowSel
            Dim selected_col As Integer = .ColSel
            If selected_row > 0 Then
                If selected_col = 1 Then
                    Dim line_id As Integer = .GetData(selected_row, 4)
                    KarLines(line_id).wps_flag = .GetData(selected_row, 1)
                End If
                If selected_col = 2 Then
                    Dim line_id As Integer = .GetData(selected_row, 4)
                    If FetchWps17(line_id) = True Then
                        .SetData(selected_row, 2, True)
                    Else
                        KarLines(line_id).wps17_flag = .GetData(selected_row, 2)
                    End If
                End If
            End If
        End With

    End Sub
    Private Sub Kar_flexgrid4_AfterEdit(ByVal sender As Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Kar_flexgrid4.AfterEdit

        'wps vinkje aanzetten/uitzetten verwerken
        With Kar_flexgrid4
            Dim selected_row As Integer = .RowSel
            Dim selected_col As Integer = .ColSel
            If selected_row > 0 Then
                If selected_col = 1 Then
                    Dim line_id As Integer = .GetData(selected_row, 4)
                    KarLines(line_id).wps_flag = .GetData(selected_row, 1)
                End If
                If selected_col = 2 Then
                    Dim line_id As Integer = .GetData(selected_row, 4)
                    If FetchWps17(line_id) = True Then
                        .SetData(selected_row, 2, True)
                    Else
                        KarLines(line_id).wps17_flag = .GetData(selected_row, 2)
                    End If
                End If
            End If
        End With

    End Sub
    Private Sub Kar_flexgrid1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_flexgrid1.Click
        Kar_flexgrid2.Select(0, 0)
        Kar_flexgrid3.Select(0, 0)
        Kar_flexgrid4.Select(0, 0)

        Dim aantal = Val(Kar_selectie_txt.Text)
        Kar_selectie_txt.Text = Str(aantal)
        If aantal = 0 Then
            Kar_selectie_txt.Text = "0"
            Exit Sub
        End If

        With Kar_flexgrid1
            Dim selected_row As Integer = .RowSel
            If selected_row > 0 Then
                Dim line_id As Integer = .GetData(selected_row, 4)

                If KarLines(line_id).aantal < aantal Then
                    aantal = KarLines(line_id).aantal
                End If

                Dim soortlistline As String = Trim(Str(aantal)) + " x "
                soortlistline = soortlistline + Trim(Str(fust(KarLines(line_id).fustlist_id).aantal_per_fust)) + " "
                soortlistline = soortlistline + KarLines(line_id).soortnaam + " "

                If accessoire(KarLines(line_id).accessoirelist_id).fust > 0 Or accessoire(KarLines(line_id).accessoirelist_id).prijslijst > 0 Then
                    soortlistline = soortlistline + accessoire(KarLines(line_id).accessoirelist_id).naam
                End If
                soortlistline = soortlistline + " kar " + Kar_nummer1_lbl.Text
                Kar_selectietot_lbl.Text = soortlistline

                Kar_selectietot_lbl.Tag = Str(aantal) + ";" + Str(line_id) + ";" + Kar_nummer1_lbl.Text
            End If
        End With


    End Sub
    Private Sub Kar_flexgrid2_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_flexgrid2.Click
        Kar_flexgrid1.Select(0, 0)
        Kar_flexgrid3.Select(0, 0)
        Kar_flexgrid4.Select(0, 0)

        Dim aantal = Val(Kar_selectie_txt.Text)
        Kar_selectie_txt.Text = Str(aantal)
        If aantal = 0 Then
            Kar_selectie_txt.Text = "0"
            Exit Sub
        End If

        With Kar_flexgrid2
            Dim selected_row As Integer = .RowSel
            If selected_row > 0 Then
                Dim line_id As Integer = .GetData(selected_row, 4)

                If KarLines(line_id).aantal < aantal Then
                    aantal = KarLines(line_id).aantal
                End If

                Dim soortlistline As String = Trim(Str(aantal)) + " x "
                soortlistline = soortlistline + Trim(Str(fust(KarLines(line_id).fustlist_id).aantal_per_fust)) + " "
                soortlistline = soortlistline + KarLines(line_id).soortnaam + " "

                If accessoire(KarLines(line_id).accessoirelist_id).fust > 0 Or accessoire(KarLines(line_id).accessoirelist_id).prijslijst > 0 Then
                    soortlistline = soortlistline + accessoire(KarLines(line_id).accessoirelist_id).naam
                End If
                soortlistline = soortlistline + " kar " + Kar_nummer2_lbl.Text
                Kar_selectietot_lbl.Text = soortlistline

                Kar_selectietot_lbl.Tag = Str(aantal) + ";" + Str(line_id) + ";" + Kar_nummer2_lbl.Text
            End If
        End With

    End Sub
    Private Sub Kar_flexgrid3_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_flexgrid3.Click
        Kar_flexgrid1.Select(0, 0)
        Kar_flexgrid2.Select(0, 0)
        Kar_flexgrid4.Select(0, 0)

        Dim aantal = Val(Kar_selectie_txt.Text)
        Kar_selectie_txt.Text = Str(aantal)
        If aantal = 0 Then
            Kar_selectie_txt.Text = "0"
            Exit Sub
        End If

        With Kar_flexgrid3
            Dim selected_row As Integer = .RowSel
            If selected_row > 0 Then
                Dim line_id As Integer = .GetData(selected_row, 4)

                If KarLines(line_id).aantal < aantal Then
                    aantal = KarLines(line_id).aantal
                End If

                Dim soortlistline As String = Trim(Str(aantal)) + " x "
                soortlistline = soortlistline + Trim(Str(fust(KarLines(line_id).fustlist_id).aantal_per_fust)) + " "
                soortlistline = soortlistline + KarLines(line_id).soortnaam + " "

                If accessoire(KarLines(line_id).accessoirelist_id).fust > 0 Or accessoire(KarLines(line_id).accessoirelist_id).prijslijst > 0 Then
                    soortlistline = soortlistline + accessoire(KarLines(line_id).accessoirelist_id).naam
                End If
                soortlistline = soortlistline + " kar " + Kar_nummer3_lbl.Text
                Kar_selectietot_lbl.Text = soortlistline

                Kar_selectietot_lbl.Tag = Str(aantal) + ";" + Str(line_id) + ";" + Kar_nummer3_lbl.Text
            End If
        End With

    End Sub
    Private Sub Kar_flexgrid4_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_flexgrid4.Click
        Kar_flexgrid1.Select(0, 0)
        Kar_flexgrid2.Select(0, 0)
        Kar_flexgrid3.Select(0, 0)

        Dim aantal = Val(Kar_selectie_txt.Text)
        Kar_selectie_txt.Text = Str(aantal)
        If aantal = 0 Then
            Kar_selectie_txt.Text = "0"
            Exit Sub
        End If

        With Kar_flexgrid4
            Dim selected_row As Integer = .RowSel
            If selected_row > 0 Then
                Dim line_id As Integer = .GetData(selected_row, 4)

                If KarLines(line_id).aantal < aantal Then
                    aantal = KarLines(line_id).aantal
                End If

                Dim soortlistline As String = Trim(Str(aantal)) + " x "
                soortlistline = soortlistline + Trim(Str(fust(KarLines(line_id).fustlist_id).aantal_per_fust)) + " "
                soortlistline = soortlistline + KarLines(line_id).soortnaam + " "

                If accessoire(KarLines(line_id).accessoirelist_id).fust > 0 Or accessoire(KarLines(line_id).accessoirelist_id).prijslijst > 0 Then
                    soortlistline = soortlistline + accessoire(KarLines(line_id).accessoirelist_id).naam
                End If
                soortlistline = soortlistline + " kar " + Kar_nummer4_lbl.Text
                Kar_selectietot_lbl.Text = soortlistline

                Kar_selectietot_lbl.Tag = Str(aantal) + ";" + Str(line_id) + ";" + Kar_nummer4_lbl.Text
            End If
        End With

    End Sub
    Private Sub Kar_up1_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_up1_but.Click
        With Kar_flexgrid1
            Dim selected_row As Integer = .RowSel
            If selected_row > 1 And selected_row > 0 Then
                Dim line_id1 As Integer = .GetData(selected_row, 4)
                Dim line_id2 As Integer = .GetData(selected_row - 1, 4)
                Dim swapbuf As Integer = KarLines(line_id1).sorteren
                KarLines(line_id1).sorteren = KarLines(line_id2).sorteren
                KarLines(line_id2).sorteren = swapbuf
                Karindeling_Invullen(HScrollBar1.Value)
                .Select(selected_row - 1, 0)
            End If
        End With
    End Sub
    Private Sub Kar_up2_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_up2_but.Click
        With Kar_flexgrid2
            Dim selected_row As Integer = .RowSel
            If selected_row > 1 And selected_row > 0 Then
                Dim line_id1 As Integer = .GetData(selected_row, 4)
                Dim line_id2 As Integer = .GetData(selected_row - 1, 4)
                Dim swapbuf As Integer = KarLines(line_id1).sorteren
                KarLines(line_id1).sorteren = KarLines(line_id2).sorteren
                KarLines(line_id2).sorteren = swapbuf
                Karindeling_Invullen(HScrollBar1.Value)
                .Select(selected_row - 1, 0)
            End If
        End With
    End Sub
    Private Sub Kar_up3_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_up3_but.Click
        With Kar_flexgrid3
            Dim selected_row As Integer = .RowSel
            If selected_row > 1 And selected_row > 0 Then
                Dim line_id1 As Integer = .GetData(selected_row, 4)
                Dim line_id2 As Integer = .GetData(selected_row - 1, 4)
                Dim swapbuf As Integer = KarLines(line_id1).sorteren
                KarLines(line_id1).sorteren = KarLines(line_id2).sorteren
                KarLines(line_id2).sorteren = swapbuf
                Karindeling_Invullen(HScrollBar1.Value)
                .Select(selected_row - 1, 0)
            End If
        End With
    End Sub
    Private Sub Kar_up4_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_up4_but.Click
        With Kar_flexgrid4
            Dim selected_row As Integer = .RowSel
            If selected_row > 1 And selected_row > 0 Then
                Dim line_id1 As Integer = .GetData(selected_row, 4)
                Dim line_id2 As Integer = .GetData(selected_row - 1, 4)
                Dim swapbuf As Integer = KarLines(line_id1).sorteren
                KarLines(line_id1).sorteren = KarLines(line_id2).sorteren
                KarLines(line_id2).sorteren = swapbuf
                Karindeling_Invullen(HScrollBar1.Value)
                .Select(selected_row - 1, 0)
            End If
        End With
    End Sub
    Private Sub Kar_down1_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_down1_but.Click
        With Kar_flexgrid1
            Dim selected_row As Integer = .RowSel
            Dim max_row As Integer = .Rows.Count - 1
            If selected_row < max_row And selected_row > 0 Then
                Dim line_id1 As Integer = .GetData(selected_row, 4)
                Dim line_id2 As Integer = .GetData(selected_row + 1, 4)
                Dim swapbuf As Integer = KarLines(line_id1).sorteren
                KarLines(line_id1).sorteren = KarLines(line_id2).sorteren
                KarLines(line_id2).sorteren = swapbuf
                Karindeling_Invullen(HScrollBar1.Value)
                .Select(selected_row + 1, 0)
            End If
        End With
    End Sub
    Private Sub Kar_down2_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_down2_but.Click
        With Kar_flexgrid2
            Dim selected_row As Integer = .RowSel
            Dim max_row As Integer = .Rows.Count - 1
            If selected_row < max_row And selected_row > 0 Then
                Dim line_id1 As Integer = .GetData(selected_row, 4)
                Dim line_id2 As Integer = .GetData(selected_row + 1, 4)
                Dim swapbuf As Integer = KarLines(line_id1).sorteren
                KarLines(line_id1).sorteren = KarLines(line_id2).sorteren
                KarLines(line_id2).sorteren = swapbuf
                Karindeling_Invullen(HScrollBar1.Value)
                .Select(selected_row + 1, 0)
            End If
        End With
    End Sub
    Private Sub Kar_down3_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_down3_but.Click
        With Kar_flexgrid3
            Dim selected_row As Integer = .RowSel
            Dim max_row As Integer = .Rows.Count - 1
            If selected_row < max_row And selected_row > 0 Then
                Dim line_id1 As Integer = .GetData(selected_row, 4)
                Dim line_id2 As Integer = .GetData(selected_row + 1, 4)
                Dim swapbuf As Integer = KarLines(line_id1).sorteren
                KarLines(line_id1).sorteren = KarLines(line_id2).sorteren
                KarLines(line_id2).sorteren = swapbuf
                Karindeling_Invullen(HScrollBar1.Value)
                .Select(selected_row + 1, 0)
            End If
        End With
    End Sub
    Private Sub Kar_down4_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_down4_but.Click
        With Kar_flexgrid4
            Dim selected_row As Integer = .RowSel
            Dim max_row As Integer = .Rows.Count - 1
            If selected_row < max_row And selected_row > 0 Then
                Dim line_id1 As Integer = .GetData(selected_row, 4)
                Dim line_id2 As Integer = .GetData(selected_row + 1, 4)
                Dim swapbuf As Integer = KarLines(line_id1).sorteren
                KarLines(line_id1).sorteren = KarLines(line_id2).sorteren
                KarLines(line_id2).sorteren = swapbuf
                Karindeling_Invullen(HScrollBar1.Value)
                .Select(selected_row + 1, 0)
            End If
        End With
    End Sub
    Private Sub Orders_Karindeling_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Orders_Karindeling.Click
        'find selected treeview item
        karindeling_date = Order_MonthCalendar.SelectionStart

        PanelKarindelingOnder.Enabled = True
        PanelKarindelingMidden.Enabled = True
        PanelKarIndelingBoven.Enabled = True

        Dim header_id As Integer = -1
        'For i = 0 To TreeView1.Nodes.Count - 1
        ' If TreeView1.Nodes(i).Checked = True And Mid(TreeView1.Nodes(i).Tag, 1, 3) = "ID:" Then
        ' header_id = Val(Mid(TreeView1.Nodes(i).Tag, 4))
        ' End If
        ' Next i
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(Node.Tag, 4))
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        header_id = Val(Mid(node2.Tag, 4))
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If

        If header_id = -1 Then Exit Sub

        Dim block As Boolean = check_wps_inbehandeling(header_id)
        Dim koper_ean As String = getkoperfromorder(header_id)
        BoekStatus = 8
        Update_Boek(1, koper_ean)

        Show_Karindeling(header_id)
    End Sub

    Private Function check_wps_inbehandeling(ByVal header_id As Integer) As Boolean
        Dim block As Boolean = False


        Return block
    End Function

    Private Sub kar_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles KarBut1.Click, KarBut2.Click, KarBut3.Click, KarBut4.Click, KarBut5.Click, KarBut6.Click, KarBut7.Click, KarBut8.Click, KarBut9.Click, KarBut10.Click, KarBut12.Click, KarBut16.Click, KarBut20.Click, KarBut35.Click, KarBut40.Click, KarBut100.Click
        Dim btn As Button
        btn = CType(sender, Button)
        Kar_selectie_txt.Text = btn.Tag

        Dim selectie() As String
        selectie = Microsoft.VisualBasic.Strings.Split(Kar_selectietot_lbl.Tag, ";")  ' gevuld door kar_flexgrid1_click (aantal;line_id;karnr)
        If UBound(selectie) = 2 Then

            Dim line_id As Integer = Val(selectie(1))
            Dim aantal As Integer = Val(btn.Tag)
            Dim karnr As String = selectie(2)

            If KarLines(line_id).aantal < aantal Then
                aantal = KarLines(line_id).aantal
            End If

            Dim soortlistline As String = Trim(Str(aantal)) + " x "
            soortlistline = soortlistline + Trim(Str(fust(KarLines(line_id).fustlist_id).aantal_per_fust)) + " "
            soortlistline = soortlistline + KarLines(line_id).soortnaam + " "

            If accessoire(KarLines(line_id).accessoirelist_id).fust > 0 Or accessoire(KarLines(line_id).accessoirelist_id).prijslijst > 0 Then
                soortlistline = soortlistline + accessoire(KarLines(line_id).accessoirelist_id).naam
            End If
            soortlistline = soortlistline + " kar " + karnr
            Kar_selectietot_lbl.Text = soortlistline

            Kar_selectietot_lbl.Tag = Str(aantal) + ";" + Str(line_id) + ";" + karnr

        End If

    End Sub
    Private Sub Kar_selectie_txt_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_selectie_txt.TextChanged
        Dim selectie() As String
        selectie = Microsoft.VisualBasic.Strings.Split(Kar_selectietot_lbl.Tag, ";")  ' gevuld door kar_flexgrid1_click (aantal;line_id;karnr)
        If UBound(selectie) = 2 And Val(Kar_selectie_txt.Text) > 0 Then

            Dim line_id As Integer = Val(selectie(1))
            Dim aantal As Integer = Val(Kar_selectie_txt.Text)
            Dim karnr As String = selectie(2)

            If KarLines(line_id).aantal < aantal Then
                aantal = KarLines(line_id).aantal
            End If

            Dim soortlistline As String = Trim(Str(aantal)) + " x "
            soortlistline = soortlistline + Trim(Str(fust(KarLines(line_id).fustlist_id).aantal_per_fust)) + " "
            soortlistline = soortlistline + KarLines(line_id).soortnaam + " "

            If accessoire(KarLines(line_id).accessoirelist_id).fust > 0 Or accessoire(KarLines(line_id).accessoirelist_id).prijslijst > 0 Then
                soortlistline = soortlistline + accessoire(KarLines(line_id).accessoirelist_id).naam
            End If
            soortlistline = soortlistline + " kar " + karnr
            Kar_selectietot_lbl.Text = soortlistline

            Kar_selectietot_lbl.Tag = Str(aantal) + ";" + Str(line_id) + ";" + karnr

        End If
    End Sub
    Private Sub Kar_plus_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_plus1_but.Click, Kar_plus2_but.Click, Kar_plus3_but.Click, Kar_plus4_but.Click

        Dim btn As Button
        Dim dest_karnr As Integer = 0
        btn = CType(sender, Button)
        Dim selectie_plus = Val(btn.Tag)
        Dim samenvoegen As Boolean = False
        Select Case btn.Tag
            Case 1
                dest_karnr = Val(Kar_nummer1_lbl.Text)
                samenvoegen = Kar_autosamenvoegen1_chk.Checked
            Case 2
                dest_karnr = Val(Kar_nummer2_lbl.Text)
                samenvoegen = Kar_autosamenvoegen2_chk.Checked
            Case 3
                dest_karnr = Val(Kar_nummer3_lbl.Text)
                samenvoegen = Kar_autosamenvoegen3_chk.Checked
            Case 4
                dest_karnr = Val(Kar_nummer4_lbl.Text)
                samenvoegen = Kar_autosamenvoegen4_chk.Checked
        End Select

        Dim selectie() As String
        selectie = Microsoft.VisualBasic.Strings.Split(Kar_selectietot_lbl.Tag, ";")  ' gevuld door kar_flexgrid1_click/buttons (aantal;line_id;karnr)
        If UBound(selectie) = 2 Then

            'get source data 
            Dim source_id As Integer = Val(selectie(1))
            Dim aantal As Integer = Val(selectie(0))
            Dim source_karnr As String = selectie(2)

            'find empty line for copy destination
            Dim findloop As Integer
            For findloop = 0 To Max_Kar_Lines
                If KarLines(findloop).tag = False Then
                    Exit For
                End If
            Next
            If findloop >= Max_Kar_Lines Then
                MsgBox("maximum aantal regels overschreden, bewerking niet mogelijk")
                Exit Sub
            End If
            Dim dest_id As Integer = findloop


            'destination karnummer bepalen


            'zoek of er al een kar is in the array van dit nummer 
            If KarHeaders(dest_karnr).tag = False Then   'deze kar bevat nog geen planten, nieuwe kar aanmaken 
                Dim FindHighKarID As Integer = 0
                For i = 0 To Max_Kar_Headers  'zoek hoogste kar_id + 1
                    If FindHighKarID <= KarHeaders(i).kar_id Then
                        FindHighKarID = KarHeaders(i).kar_id
                    End If
                Next
                Dim kar_id As Integer = FindHighKarID + 1
                KarHeaders(dest_karnr).tag = True
                KarHeaders(dest_karnr).kar_id = kar_id
                KarHeaders(dest_karnr).header_id = KarHeaders(source_karnr).header_id
                KarHeaders(dest_karnr).aantal_lagen = 0
                KarHeaders(dest_karnr).kar_type = KarHeaders(source_karnr).kar_type
                KarHeaders(dest_karnr).sdf_flag = 0
                KarHeaders(dest_karnr).vervoer_flag = 0
                KarHeaders(dest_karnr).barcode = GetNewBarcode(karindeling_date)   ' "1234567890123"
                KarHeaders(dest_karnr).cc_rfid = ""   ' "123456789012345678901234"
                KarHeaders(dest_karnr).kar_nummer = 0
                KarHeaders(dest_karnr).overgooien_naar = ""
                KarHeaders(dest_karnr).overgooien_hierop = ""
            End If

            'find lowest sorteringnr
            Dim sorterenlow As Integer = 4000
            For i = 0 To Max_Kar_Lines
                If KarLines(i).sorteren <= sorterenlow Then
                    sorterenlow = KarLines(i).sorteren
                End If
            Next
            sorterenlow = sorterenlow - 1
            If sorterenlow < 0 Then sorterenlow = 0



            'is er op deze kar al een regel met dezelfde soort_id? en staat het vinkje aan?
            Dim samengevoegd As Boolean = False
            If samenvoegen = True Then
                For lineloop = 0 To Max_Kar_Lines
                    If KarLines(lineloop).tag = True Then
                        If KarLines(lineloop).Orderline_id = KarLines(source_id).Orderline_id And KarLines(lineloop).kar_id = KarHeaders(dest_karnr).kar_id And KarLines(lineloop).wps_flag = KarLines(source_id).wps_flag Then
                            'zelfde id gevonden!
                            KarLines(lineloop).aantal = KarLines(lineloop).aantal + aantal  'aantal optellen

                            'oude line verwijderen?
                            If KarLines(source_id).aantal = aantal Then
                                'clearline 
                                KarLines(source_id).tag = False
                                KarLines(source_id).aantal = 0
                                KarLines(source_id).kar_id = 0
                                KarLines(source_id).Orderline_id = 0
                                KarLines(source_id).wps_flag = False
                                KarLines(source_id).wps17_flag = False
                                KarLines(source_id).header_id = 0
                                KarLines(source_id).kar_nummerref = 0
                                KarLines(source_id).sorteren = 4000
                                KarLines(source_id).fustlist_id = 0
                                KarLines(source_id).accessoirelist_id = 0
                                KarLines(source_id).soortnaam = ""
                            Else
                                'aantal aftrekken
                                KarLines(source_id).aantal = KarLines(source_id).aantal - aantal
                            End If
                            samengevoegd = True
                            Exit For
                        End If
                    End If
                Next
            End If


            If samengevoegd = False Then
                'word de hele regel overgezet?
                If KarLines(source_id).aantal = aantal Then
                    'ja, regel verplaatsen naar nieuwe kar 
                    KarLines(source_id).kar_id = KarHeaders(dest_karnr).kar_id
                Else
                    'nee
                    ' copy regel 
                    KarLines(dest_id).tag = KarLines(source_id).tag
                    KarLines(dest_id).aantal = aantal
                    KarLines(source_id).aantal = KarLines(source_id).aantal - aantal
                    KarLines(dest_id).kar_id = KarHeaders(dest_karnr).kar_id
                    KarLines(dest_id).Orderline_id = KarLines(source_id).Orderline_id
                    KarLines(dest_id).wps_flag = KarLines(source_id).wps_flag
                    KarLines(dest_id).wps17_flag = KarLines(source_id).wps17_flag
                    KarLines(dest_id).header_id = KarLines(source_id).header_id
                    KarLines(dest_id).kar_nummerref = 0
                    KarLines(dest_id).sorteren = sorterenlow
                    KarLines(dest_id).fustlist_id = KarLines(source_id).fustlist_id
                    KarLines(dest_id).accessoirelist_id = KarLines(source_id).accessoirelist_id
                    KarLines(dest_id).soortnaam = KarLines(source_id).soortnaam
                End If
            End If
            ' herberekenen aantal lagen van karren

            Dim karlist = GID(kar, KarHeaders(source_karnr).kar_type)
            If kar(karlist).fust_per_laag_code = 1 Then   ''deen 
                If KarHeaders(dest_karnr).aantal_lagenlock = False Then
                    KarHeaders(dest_karnr).aantal_lagen = Bereken_Aantal_Lagen(dest_karnr)
                End If
                If KarHeaders(source_karnr).aantal_lagenlock = False Then
                    KarHeaders(source_karnr).aantal_lagen = Bereken_Aantal_Lagen(source_karnr)
                End If
            End If
            If kar(karlist).fust_per_laag_code = 2 Then   ''veilingkar
                If KarHeaders(dest_karnr).aantal_lagenlock = False Then
                    KarHeaders(dest_karnr).aantal_lagen = Bereken_Aantal_LagenVkar(dest_karnr)
                End If
                If KarHeaders(source_karnr).aantal_lagenlock = False Then
                    KarHeaders(source_karnr).aantal_lagen = Bereken_Aantal_LagenVkar(source_karnr)
                End If
            End If
            If kar(karlist).fust_per_laag_code = 3 Then   ' palets e.d.
                If KarHeaders(dest_karnr).aantal_lagenlock = False Then
                    KarHeaders(dest_karnr).aantal_lagen = 0
                End If
                If KarHeaders(source_karnr).aantal_lagenlock = False Then
                    KarHeaders(source_karnr).aantal_lagen = 0
                End If
            End If
            'opnieuw invullen
            Karindeling_Invullen(HScrollBar1.Value)

        End If
    End Sub
    Private Function FetchWps17(ByVal lineid As Integer) As Boolean

        Dim soort_id As Integer = 0
        Dim orderline_id As Integer = KarLines(lineid).Orderline_id
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd2 As New OdbcCommand("select soort_id from orderlines where orderline_id = ?", Conn)
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", orderline_id)
                Dim reader As OdbcDataReader
                reader = Cmd2.ExecuteReader()
                If reader.HasRows Then
                    reader.Read()
                    soort_id = CHint(reader("Soort_id"))
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Fout: Fetch17" + ex.Message)
            MessageBox.Show("Fout: Fetch17" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        For i = 1 To UBound(soortgroep)
            If soortgroep(i).naam = "WPS17" Then
                Dim searchid As Integer = soortgroep(i).id
                For j = 1 To UBound(soortgroepids)
                    If soortgroepids(j).id = searchid And soortgroepids(j).soortmixid = soort_id Then
                        Return True
                    End If
                Next
            End If
        Next

        Return False
    End Function
    Private Function Bereken_Aantal_Lagen(ByVal kar_nr As Integer) As Integer
        Dim aantal_lagen = 0

        Dim laag As Integer = 1
        Dim plaats As Double = 0
        Dim line_found As Boolean = False
        For lineloop = 0 To Max_Kar_Lines
            If KarLines(lineloop).kar_id = KarHeaders(kar_nr).kar_id Then
                line_found = True

                'orderline verwerken 
                Dim fustlist_id As Integer = KarLines(lineloop).fustlist_id
                Dim fustperlaag_code = kar(GID(kar, KarHeaders(kar_nr).kar_type)).fust_per_laag_code
                Dim aantalperlaag As Integer = 1
                Select Case fustperlaag_code
                    Case 1 : aantalperlaag = fust(fustlist_id).fpl_deen
                    Case 2 : aantalperlaag = fust(fustlist_id).fpl_veilingkar
                    Case 3 : aantalperlaag = fust(fustlist_id).fpl_overig
                    Case 4 : aantalperlaag = fust(fustlist_id).fpl_reserve1
                    Case 5 : aantalperlaag = fust(fustlist_id).fpl_reserve2
                End Select

                Dim aantal = KarLines(lineloop).aantal

                Dim i As Integer
                For i = 1 To aantal

                    'past het?
                    plaats = plaats + 1 / aantalperlaag
                    If plaats > 1.01 Then
                        plaats = 1 / aantalperlaag
                        laag = laag + 1
                    End If
                Next i


            End If
        Next lineloop
        If line_found = False Then
            aantal_lagen = 0
        Else
            aantal_lagen = laag

            If aantal_lagen = 1 Then
                If KarHeaders(kar_nr).kar_type = 1 Or KarHeaders(kar_nr).kar_type = 2 Or KarHeaders(kar_nr).kar_type = 4 Or KarHeaders(kar_nr).kar_type = 5 Then
                    aantal_lagen = 2
                End If
            End If

        End If
            Return aantal_lagen
    End Function
    Private Function Bereken_Aantal_LagenVkar(ByVal kar_nr As Integer) As Integer
        Dim aantal_lagen = 0

        Dim laag As Integer = 1
        Dim plaats As Double = 0
        Dim line_found As Boolean = False
        For lineloop = 0 To Max_Kar_Lines
            If KarLines(lineloop).kar_id = KarHeaders(kar_nr).kar_id Then
                line_found = True

                'orderline verwerken 
                Dim fustlist_id As Integer = KarLines(lineloop).fustlist_id
                Dim fustperlaag_code = kar(GID(kar, KarHeaders(kar_nr).kar_type)).fust_per_laag_code
                Dim aantalperlaag As Integer = 1
                Select Case fustperlaag_code
                    Case 1 : aantalperlaag = fust(fustlist_id).fpl_deen
                    Case 2 : aantalperlaag = fust(fustlist_id).fpl_veilingkar
                    Case 3 : aantalperlaag = fust(fustlist_id).fpl_overig
                    Case 4 : aantalperlaag = fust(fustlist_id).fpl_reserve1
                    Case 5 : aantalperlaag = fust(fustlist_id).fpl_reserve2
                End Select

                Dim aantal = KarLines(lineloop).aantal

                Dim i As Integer
                For i = 1 To aantal

                    'past het?
                    plaats = plaats + 1 / aantalperlaag
                    If plaats > 1.01 Then
                        plaats = 1 / aantalperlaag
                        laag = laag + 1
                    End If
                Next i


            End If
        Next lineloop
        If line_found = False Then
            aantal_lagen = 0
        Else
            If laag > 4 Then
                aantal_lagen = laag - 4
            Else
                aantal_lagen = 1
            End If
        End If
        Return aantal_lagen
    End Function
    Private Sub Kar_lagenlock_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_lagenlock1_but.Click, Kar_lagenlock2_but.Click, Kar_lagenlock3_but.Click, Kar_lagenlock4_but.Click
        Dim btn As Button
        Dim karnr As Integer = 0
        btn = CType(sender, Button)
        Dim aantal_lagen As Integer = 0
        Select Case btn.Tag
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
                aantal_lagen = Val(Kar_lagen1_txt.Text)
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
                aantal_lagen = Val(Kar_lagen2_txt.Text)
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
                aantal_lagen = Val(Kar_lagen3_txt.Text)
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
                aantal_lagen = Val(Kar_lagen4_txt.Text)
        End Select
        If KarHeaders(karnr).aantal_lagenlock = False Then
            KarHeaders(karnr).aantal_lagenlock = True

            KarHeaders(karnr).aantal_lagen = aantal_lagen
            Karindeling_Invullen(HScrollBar1.Value)
        Else
            KarHeaders(karnr).aantal_lagenlock = False

            Dim karlist = GID(kar, KarHeaders(karnr).kar_type)
            If kar(karlist).fust_per_laag_code = 1 Then   ''deen 
                If KarHeaders(karnr).aantal_lagenlock = False Then
                    KarHeaders(karnr).aantal_lagen = Bereken_Aantal_Lagen(karnr)
                End If
            End If
            If kar(karlist).fust_per_laag_code = 2 Then   ''veilingkar
                If KarHeaders(karnr).aantal_lagenlock = False Then
                    KarHeaders(karnr).aantal_lagen = 1
                End If
                If KarHeaders(karnr).aantal_lagenlock = False Then
                    KarHeaders(karnr).aantal_lagen = 1
                End If
            End If
            If kar(karlist).fust_per_laag_code = 3 Then   ''veilingkar 
                If KarHeaders(karnr).aantal_lagenlock = False Then
                    KarHeaders(karnr).aantal_lagen = 0
                End If
                If KarHeaders(karnr).aantal_lagenlock = False Then
                    KarHeaders(karnr).aantal_lagen = 0
                End If
            End If

            Karindeling_Invullen(HScrollBar1.Value)
        End If

    End Sub
    Private Sub Kar_sdfverzonden_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_sdfverzonden1_chk.CheckedChanged, Kar_sdfverzonden2_chk.CheckedChanged, Kar_sdfverzonden3_chk.CheckedChanged, Kar_sdfverzonden4_chk.CheckedChanged
        Dim btn As CheckBox
        Dim karnr As Integer = 0
        btn = CType(sender, CheckBox)

        Select Case btn.Tag
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
                KarHeaders(karnr).sdf_flag = Kar_sdfverzonden1_chk.Checked
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
                KarHeaders(karnr).sdf_flag = Kar_sdfverzonden2_chk.Checked
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
                KarHeaders(karnr).sdf_flag = Kar_sdfverzonden3_chk.Checked
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
                KarHeaders(karnr).sdf_flag = Kar_sdfverzonden4_chk.Checked
        End Select
    End Sub

    Private Sub Kar_scanready_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        ' Dim btn As CheckBox
        ' Dim karnr As Integer = 0
        ' btn = CType(sender, CheckBox)

        ' Select Case btn.Tag
        '     Case 1
        ' karnr = Val(Kar_nummer1_lbl.Text)
        '' KarHeaders(karnr).scan_flag = Kar_scanready1_chk.Checked
        '    Case 2
        ' karnr = Val(Kar_nummer2_lbl.Text)
        ' KarHeaders(karnr).scan_flag = Kar_scanready2_chk.Checked
        '     Case 3
        ''  karnr = Val(Kar_nummer3_lbl.Text)
        ' KarHeaders(karnr).scan_flag = Kar_scanready3_chk.Checked
        '   Case 4
        '  karnr = Val(Kar_nummer4_lbl.Text)
        '  KarHeaders(karnr).scan_flag = Kar_scanready4_chk.Checked
        '  End Select
    End Sub

    Private Sub Kar_vervoer_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_vervoer1_chk.CheckedChanged, Kar_vervoer2_chk.CheckedChanged, Kar_vervoer3_chk.CheckedChanged, Kar_vervoer4_chk.CheckedChanged
        Dim btn As CheckBox
        Dim karnr As Integer = 0
        btn = CType(sender, CheckBox)

        Select Case btn.Tag
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
                KarHeaders(karnr).vervoer_flag = Kar_vervoer1_chk.Checked
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
                KarHeaders(karnr).vervoer_flag = Kar_vervoer2_chk.Checked
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
                KarHeaders(karnr).vervoer_flag = Kar_vervoer3_chk.Checked
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
                KarHeaders(karnr).vervoer_flag = Kar_vervoer4_chk.Checked
        End Select
    End Sub
    Private Sub Kar_opnieuwberekenen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_opnieuwberekenen_but.Click
        Dim header_id = -1
        Dim kartype_id = 1
        For i = 1 To 100
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
                kartype_id = KarHeaders(i).kar_type
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If

        Maak_Karindeling(False, kartype_id, header_id, karindeling_date)
        Show_Karindeling(header_id)
    End Sub
    Private Sub Kar_opnieuwberekeneninvoer_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_opnieuwberekeneninvoer_but.Click
        Dim header_id = -1
        Dim kartype_id = 1
        For i = 1 To 100
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
                kartype_id = KarHeaders(i).kar_type
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If

        Maak_Karindeling(False, kartype_id, header_id, karindeling_date, 1)
        Show_Karindeling(header_id)
    End Sub

    Private Sub Kar_allesop1_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_allesop1_but.Click

        Dim orderyear As String = Trim(Str(Year(karindeling_date)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear

        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear

        Dim kartype_id As Integer
        Dim header_id = -1
        For i = 1 To Max_Kar_Headers
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
                kartype_id = KarHeaders(i).kar_type
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If


        'check of de order door iemand anders is aangepast in de tussentijd 
        If Order_is_aangepast(Val(KarOrder_versie_lbl.Text), orderheader_db, header_id) = True Then
            MsgBox("Deze order is aangepast in de tijd dat de order door u bewerkt werd, deze order kan niet worden opgeslagen, probeer opnieuw", vbOKOnly)
            Exit Sub
        End If


        'clear global vars
        Array.Clear(KarHeaders, KarHeaders.GetLowerBound(0), KarHeaders.Length)
        Array.Clear(KarLines, KarLines.GetLowerBound(0), KarLines.Length)

        'delete old stuff
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' delete kar-info & lines from database 
                ' delete all non-locked karinfo
                Dim DelString As String = "DELETE FROM " + orderkarren_db + " WHERE header_id='" + Str(header_id) + "'"
                Dim DelCmd As New OdbcCommand(DelString, Conn)
                DelCmd.ExecuteNonQuery()

                'delete all kar-line info
                Dim DelString2 As String = "DELETE FROM " + orderkarlines_db + " WHERE header_id='" + Str(header_id) + "'"
                Dim DelCmd2 As New OdbcCommand(DelString2, Conn)
                DelCmd2.ExecuteNonQuery()

            End Using
        Catch ex As Exception
            ErrorLog("Fout: Alles op 1 kar1" + ex.Message)
            MessageBox.Show("Fout: Alles op 1 kar1" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim linecounter As Integer = 1
                Dim CmdString4 As String = "select * from " + orderlines_db + " where OrderHeader_id = " + Str(header_id) + " ORDER BY fust_id,soort_id ASC"
                Dim Cmd2 As New OdbcCommand(CmdString4, Conn)
                Reader = Cmd2.ExecuteReader()
                Do While Reader.Read()

                    ' fill list
                    Dim fust_id As Integer = CHint(Reader("fust_id"))
                    Dim fustlist_id = GID(fust, fust_id)
                    Dim orderline_id As Integer = CHint(Reader("orderline_id"))
                    Dim totaantal As Integer = CHint(Reader("aantal"))
                    Dim soort_id As Integer = CHint(Reader("Soort_id"))
                    Dim gp_id As Integer = CHint(Reader("GP"))


                    KarLines(linecounter).tag = True
                    KarLines(linecounter).aantal = totaantal
                    KarLines(linecounter).kar_id = 0
                    KarLines(linecounter).Orderline_id = orderline_id
                    KarLines(linecounter).wps_flag = False
                    KarLines(linecounter).wps17_flag = FetchWps17(linecounter)
                    KarLines(linecounter).kar_nummerref = 1
                    KarLines(linecounter).fustlist_id = fustlist_id
                    linecounter = linecounter + 1
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Fout: Alles op 1 kar2" + ex.Message)
            MessageBox.Show("Fout: Alles op 1 kar2" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        KarHeaders(1).tag = True
        KarHeaders(1).kar_id = 0
        KarHeaders(1).header_id = header_id
        KarHeaders(1).kar_type = kartype_id
        KarHeaders(1).aantal_lagen = Bereken_Aantal_Lagen(1)
        KarHeaders(1).sdf_flag = False
        KarHeaders(1).vervoer_flag = False
        KarHeaders(1).barcode = GetNewBarcode(karindeling_date)    '  "1234567890123"
        KarHeaders(1).cc_rfid = ""    '  "123456789012345678901234"
        KarHeaders(1).kar_nummer = 1
        KarHeaders(1).overgooien_naar = ""
        KarHeaders(1).overgooien_hierop = ""
        ' opslaan gemaakte karindeling in database

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim karcounter As Integer = 1
                Do While KarHeaders(karcounter).tag = True

                    If KarHeaders(karcounter).kar_nummer > 0 Then

                        'Execute Query
                        Dim cmdstring As String = "SELECT * FROM " + orderkarren_db + " WHERE 1=0"
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        With Cmd


                            .CommandText = "INSERT INTO " + orderkarren_db + "(header_id,kar_type,aantal_lagen,sdf_flag,vervoer_flag,barcode,cc_rfid)" _
                                            & "VALUES(?,?,?,?,?,?,?)"
                            .Parameters.Clear()
                            .Parameters.AddWithValue("", header_id)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).kar_type)

                            If kar(GID(kar, KarHeaders(karcounter).kar_type)).fust_per_laag_code = 1 Then  'deen 
                                .Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagen)
                            ElseIf kar(GID(kar, KarHeaders(karcounter).kar_type)).fust_per_laag_code = 2 Then ' veilingkar
                                .Parameters.AddWithValue("", 1)
                            Else
                                .Parameters.AddWithValue("", 0) 'pallets e.d.
                            End If

                            .Parameters.AddWithValue("", KarHeaders(karcounter).sdf_flag)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).vervoer_flag)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).barcode)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).cc_rfid)

                            .ExecuteNonQuery()

                            ' fetch header
                            If postgress = True Then
                                Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('orderkarren','kar_id'))", Conn)
                                KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                            Else
                                Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                            End If
                        End With
                    End If
                    karcounter = karcounter + 1
                Loop

                'karlines opslaan
                Dim karlinecounter As Integer = 1
                Dim cmdstring6 As String = "SELECT * FROM " + orderkarlines_db + " WHERE 1=0"
                Dim sorteringteller As Integer = 2000
                Do While KarLines(karlinecounter).tag = True

                    If KarLines(karlinecounter).kar_nummerref > 0 Then
                        'Execute Query
                        Dim Cmd As New OdbcCommand(cmdstring6, Conn)
                        With Cmd

                            .CommandText = "INSERT INTO " + orderkarlines_db + "(kar_id,aantal,Orderline_id,wps_flag,wps17_flag,header_id,sorteren)" _
                                            & "VALUES(?,?,?,?,?,?,?)"

                            Dim karcounter2 As Integer = 1

                            If KarLines(karlinecounter).kar_nummerref > 0 Then    ' line id's van nieuwe karren koppelen aan kar id's 
                                Do While KarHeaders(karcounter2).tag = True
                                    If KarHeaders(karcounter2).kar_nummer = KarLines(karlinecounter).kar_nummerref Then
                                        KarLines(karlinecounter).kar_id = KarHeaders(karcounter2).kar_id
                                        Exit Do
                                    End If
                                    karcounter2 = karcounter2 + 1
                                Loop
                            End If
                            .Parameters.AddWithValue("", KarLines(karlinecounter).kar_id)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).aantal)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).Orderline_id)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).wps_flag)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).wps17_flag)
                            .Parameters.AddWithValue("", header_id)
                            .Parameters.AddWithValue("", sorteringteller)

                            .ExecuteNonQuery()

                        End With
                    End If
                    karlinecounter = karlinecounter + 1
                    sorteringteller = sorteringteller + 1
                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Fout: Alles op 1 kar3 " + ex.Message)
            MsgBox("Fout: Alles op 1 kar3 " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        Show_Karindeling(header_id)


    End Sub
    Private Sub Kar_verdelenals2_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_verdelenals2_but.Click

        Dim orderyear As String = Trim(Str(Year(karindeling_date)))
        If staticyear = True Then orderyear = ""

        Dim orderlines_db As String = "OrderLines" + orderyear
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        Dim orderkarlines_db As String = "OrderKarLines" + orderyear

        Dim kartype_id As Integer
        Dim header_id = -1
        For i = 1 To Max_Kar_Headers
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
                kartype_id = KarHeaders(i).kar_type
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If

        Dim copylines(Max_Kar_Lines) As kar_line
        Dim copyrun As Integer = 1
        For copyloop = 0 To Max_Kar_Lines
            If KarLines(copyloop).kar_id = KarHeaders(2).kar_id Then
                copylines(copyrun) = KarLines(copyloop)
                copyrun = copyrun + 1
                If copyrun > Max_Kar_Lines Then Exit For
            End If
        Next

        'clear global vars
        Array.Clear(KarHeaders, KarHeaders.GetLowerBound(0), KarHeaders.Length)
        Array.Clear(KarLines, KarLines.GetLowerBound(0), KarLines.Length)

        'delete old stuff
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' delete kar-info & lines from database 
                ' delete all non-locked karinfo
                Dim DelString As String = "DELETE FROM " + orderkarren_db + " WHERE header_id='" + Str(header_id) + "'"
                Dim DelCmd As New OdbcCommand(DelString, Conn)
                DelCmd.ExecuteNonQuery()

                'delete all kar-line info
                Dim DelString2 As String = "DELETE FROM " + orderkarlines_db + " WHERE header_id='" + Str(header_id) + "'"
                Dim DelCmd2 As New OdbcCommand(DelString2, Conn)
                DelCmd2.ExecuteNonQuery()

            End Using
        Catch ex As Exception
            ErrorLog("Fout: Kar verdelen1 " + ex.Message)
            MessageBox.Show("Fout: Kar verdelen1 " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Dim Soortlines(100) As kar_line

        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim linecounter As Integer = 1
                Dim CmdString4 As String = "select * from " + orderlines_db + " where OrderHeader_id = " + Str(header_id) + " ORDER BY fust_id,soort_id ASC"
                Dim Cmd2 As New OdbcCommand(CmdString4, Conn)
                Reader = Cmd2.ExecuteReader()
                Do While Reader.Read()

                    ' fill list
                    Dim fust_id As Integer = CHint(Reader("fust_id"))
                    Dim fustlist_id = GID(fust, fust_id)
                    Dim orderline_id As Integer = CHint(Reader("orderline_id"))
                    Dim totaantal As Integer = CHint(Reader("aantal"))
                    Dim soort_id As Integer = CHint(Reader("Soort_id"))
                    Dim gp_id As Integer = CHint(Reader("GP"))

                    Soortlines(linecounter).tag = True
                    Soortlines(linecounter).aantal = totaantal
                    Soortlines(linecounter).kar_id = 0
                    Soortlines(linecounter).Orderline_id = orderline_id
                    Soortlines(linecounter).wps_flag = False
                    Soortlines(linecounter).wps17_flag = FetchWps17(linecounter)
                    Soortlines(linecounter).kar_nummerref = 1
                    Soortlines(linecounter).fustlist_id = fustlist_id
                    linecounter = linecounter + 1
                    If linecounter > 99 Then Exit Do
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Fout: Kar verdelen2 " + ex.Message)
            MessageBox.Show("Fout: Kar verdelen2 " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Dim line_made As Boolean = False
        Dim linecount As Integer = 1
        Dim fill_loop As Integer
        For fill_loop = 1 To Max_Kar_Headers
            line_made = False
            For linesearch = 1 To 100

                If copylines(linesearch).tag = True Then
                    Dim aantal As Integer = copylines(linesearch).aantal
                    For soortsearch = 1 To 100
                        If Soortlines(soortsearch).Orderline_id = copylines(linesearch).Orderline_id Then
                            If Soortlines(soortsearch).aantal - aantal >= 0 Then
                                Soortlines(soortsearch).aantal = Soortlines(soortsearch).aantal - aantal
                                KarLines(linecount) = copylines(linesearch)
                                KarLines(linecount).kar_nummerref = fill_loop
                                linecount = linecount + 1
                                line_made = True
                                Exit For
                            Else
                                If Soortlines(soortsearch).aantal > 0 Then
                                    KarLines(linecount) = copylines(linesearch)
                                    KarLines(linecount).aantal = Soortlines(soortsearch).aantal
                                    Soortlines(soortsearch).aantal = 0
                                    KarLines(linecount).kar_nummerref = fill_loop
                                    linecount = linecount + 1
                                    line_made = True
                                    Exit For
                                End If
                            End If
                        End If
                    Next soortsearch
                Else
                    Exit For
                End If
            Next
            If line_made = True Then
                KarHeaders(fill_loop).tag = True
                KarHeaders(fill_loop).kar_id = 0
                KarHeaders(fill_loop).header_id = header_id
                KarHeaders(fill_loop).kar_type = kartype_id
                KarHeaders(fill_loop).kar_nummer = fill_loop
                KarHeaders(fill_loop).aantal_lagen = Bereken_Aantal_LagenRef(fill_loop)
                KarHeaders(fill_loop).sdf_flag = False
                KarHeaders(fill_loop).vervoer_flag = False
                KarHeaders(fill_loop).barcode = GetNewBarcode(karindeling_date)  ' "1234567890123"
                KarHeaders(fill_loop).cc_rfid = ""  ' "123456789012345678901234"
                KarHeaders(fill_loop).overgooien_naar = ""
                KarHeaders(fill_loop).overgooien_hierop = ""
            Else
                Exit For
            End If
        Next fill_loop

        ' overgebleven soorten toevoegen.
        Dim soorten_over = False
        For soortdump = 1 To 100
            If Soortlines(soortdump).aantal > 0 Then
                soorten_over = True
                KarLines(linecount) = Soortlines(soortdump)
                KarLines(linecount).kar_nummerref = fill_loop
                linecount = linecount + 1
            End If
        Next
        If soorten_over = True Then
            KarHeaders(fill_loop).tag = True
            KarHeaders(fill_loop).kar_id = 0
            KarHeaders(fill_loop).header_id = header_id
            KarHeaders(fill_loop).kar_type = kartype_id
            KarHeaders(fill_loop).kar_nummer = fill_loop
            KarHeaders(fill_loop).aantal_lagen = Bereken_Aantal_LagenRef(fill_loop)
            KarHeaders(fill_loop).sdf_flag = False
            KarHeaders(fill_loop).vervoer_flag = False
            KarHeaders(fill_loop).barcode = GetNewBarcode(karindeling_date)   ' "1234567890123"
            KarHeaders(fill_loop).cc_rfid = "" '  "123456789012345678901234"
            KarHeaders(fill_loop).overgooien_naar = ""
            KarHeaders(fill_loop).overgooien_hierop = ""
        End If
        ' opslaan gemaakte karindeling in database

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim karcounter As Integer = 1
                Do While KarHeaders(karcounter).tag = True

                    If KarHeaders(karcounter).kar_nummer > 0 Then

                        'Execute Query
                        Dim cmdstring As String = "SELECT * FROM " + orderkarren_db + " WHERE 1=0"
                        Dim Cmd As New OdbcCommand(cmdstring, Conn)
                        With Cmd


                            .CommandText = "INSERT INTO " + orderkarren_db + "(header_id,kar_type,aantal_lagen,sdf_flag,vervoer_flag,barcode,cc_rfid)" _
                                            & "VALUES(?,?,?,?,?,?,?)"
                            .Parameters.Clear()
                            .Parameters.AddWithValue("", header_id)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).kar_type)

                            If kar(GID(kar, KarHeaders(karcounter).kar_type)).fust_per_laag_code = 1 Then  'deen 
                                .Parameters.AddWithValue("", KarHeaders(karcounter).aantal_lagen)
                            ElseIf kar(GID(kar, KarHeaders(karcounter).kar_type)).fust_per_laag_code = 2 Then ' veilingkar
                                .Parameters.AddWithValue("", 1)
                            Else
                                .Parameters.AddWithValue("", 0) 'pallets e.d.
                            End If

                            .Parameters.AddWithValue("", KarHeaders(karcounter).sdf_flag)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).vervoer_flag)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).barcode)
                            .Parameters.AddWithValue("", KarHeaders(karcounter).cc_rfid)

                            .ExecuteNonQuery()

                            ' fetch header
                            If postgress = True Then
                                Dim Cmd5 As New OdbcCommand("SELECT CURRVAL(pg_get_serial_sequence('orderkarren','kar_id'))", Conn)
                                KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                            Else
                                Dim Cmd5 As New OdbcCommand("SELECT LAST_INSERT_ID()", Conn)
                                KarHeaders(karcounter).kar_id = Convert.ToInt32(Cmd5.ExecuteScalar())
                            End If
                        End With
                    End If
                    karcounter = karcounter + 1
                Loop

                'karlines opslaan
                Dim karlinecounter As Integer = 1
                Dim cmdstring6 As String = "SELECT * FROM " + orderkarlines_db + " WHERE 1=0"
                Dim sorteringteller As Integer = 2000
                Do While KarLines(karlinecounter).tag = True

                    If KarLines(karlinecounter).kar_nummerref > 0 Then
                        'Execute Query
                        Dim Cmd As New OdbcCommand(cmdstring6, Conn)
                        With Cmd

                            .CommandText = "INSERT INTO " + orderkarlines_db + "(kar_id,aantal,Orderline_id,wps_flag,wps17_flag,header_id,sorteren)" _
                                            & "VALUES(?,?,?,?,?,?,?)"

                            Dim karcounter2 As Integer = 1

                            If KarLines(karlinecounter).kar_nummerref > 0 Then    ' line id's van nieuwe karren koppelen aan kar id's 
                                Do While KarHeaders(karcounter2).tag = True
                                    If KarHeaders(karcounter2).kar_nummer = KarLines(karlinecounter).kar_nummerref Then
                                        KarLines(karlinecounter).kar_id = KarHeaders(karcounter2).kar_id
                                        Exit Do
                                    End If
                                    karcounter2 = karcounter2 + 1
                                Loop
                            End If
                            .Parameters.Clear()
                            .Parameters.AddWithValue("", KarLines(karlinecounter).kar_id)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).aantal)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).Orderline_id)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).wps_flag)
                            .Parameters.AddWithValue("", KarLines(karlinecounter).wps17_flag)
                            .Parameters.AddWithValue("", header_id)
                            .Parameters.AddWithValue("", sorteringteller)

                            .ExecuteNonQuery()

                        End With
                    End If
                    karlinecounter = karlinecounter + 1
                    sorteringteller = sorteringteller + 1
                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Fout: Kar verdelen3 " + ex.Message)
            MsgBox("Fout: Kar verdelen3 " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        Show_Karindeling(header_id)

    End Sub
    Private Function Bereken_Aantal_LagenRef(ByVal kar_nr As Integer) As Integer
        Dim aantal_lagen = 0

        Dim laag As Integer = 1
        Dim plaats As Double = 0
        Dim line_found As Boolean = False
        For lineloop = 0 To Max_Kar_Lines
            If KarLines(lineloop).kar_nummerref = KarHeaders(kar_nr).kar_nummer Then
                line_found = True

                'orderline verwerken 
                Dim fustlist_id As Integer = KarLines(lineloop).fustlist_id
                Dim fustperlaag_code = kar(GID(kar, KarHeaders(kar_nr).kar_type)).fust_per_laag_code
                Dim aantalperlaag As Integer = 1
                Select Case fustperlaag_code
                    Case 1 : aantalperlaag = fust(fustlist_id).fpl_deen
                    Case 2 : aantalperlaag = fust(fustlist_id).fpl_veilingkar
                    Case 3 : aantalperlaag = fust(fustlist_id).fpl_overig
                    Case 4 : aantalperlaag = fust(fustlist_id).fpl_reserve1
                    Case 5 : aantalperlaag = fust(fustlist_id).fpl_reserve2
                End Select

                Dim aantal = KarLines(lineloop).aantal

                Dim i As Integer
                For i = 1 To aantal

                    'past het?
                    plaats = plaats + 1 / aantalperlaag
                    If plaats > 1.01 Then
                        plaats = 1 / aantalperlaag
                        laag = laag + 1
                    End If
                Next i


            End If
        Next lineloop
        If line_found = False Then
            aantal_lagen = 0
        Else
            aantal_lagen = laag
        End If
        Return aantal_lagen
    End Function


    Private Sub PrintViaSDF(karnr As Integer)

        Kar_opslaanMain()

        Dim header_id = -1
        For i = 1 To Max_Kar_Headers
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If

        Dim kar_id = KarHeaders(karnr).kar_id
        If jenptenhave = False Then
            Orders_SdfVersturenMain(header_id, kar_id)
            Update_Boek()
            MsgBox("Orders verstuurd", vbOKOnly, "SDF")
            Show_Karindeling(header_id)
        Else
            Orders_SdfVersturenJenP2(header_id, kar_id)
            Update_Boek()
            MsgBox("Orders verstuurd", vbOKOnly, "SDF")
            Show_Karindeling(header_id)
        End If
    End Sub
    Private Sub Kar_FlexGrid1_MouseMove(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles Kar_flexgrid1.MouseMove
        Try

            If Kar_flexgrid1.MouseRow > 0 And (Kar_flexgrid1.MouseCol = 0 Or Kar_flexgrid1.MouseCol = 3) Then
                Dim tip As String
                ToolTipKar.Active = True
                Static oldx As Integer
                Static oldy As Integer
                If oldx <> Kar_flexgrid1.MouseCol Or oldy <> Kar_flexgrid1.MouseRow Then
                    tip = Me.Kar_flexgrid1.Item(Kar_flexgrid1.MouseRow, Kar_flexgrid1.MouseCol)
                    Dim line_id As Integer = Kar_flexgrid1.Item(Kar_flexgrid1.MouseRow, 4)
                    Dim opmerking As String = KarLines(line_id).opmerking
                    tip = tip + "  " + opmerking
                    ToolTipKar.SetToolTip(Kar_flexgrid1, tip)
                End If
                oldx = Kar_flexgrid1.MouseCol
                oldy = Kar_flexgrid1.MouseRow
            Else
                ToolTipKar.Active = False
            End If
        Catch ex As Exception

        End Try
    End Sub
    Private Sub Kar_FlexGrid2_MouseMove(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles Kar_flexgrid2.MouseMove
        Try

            If Kar_flexgrid2.MouseRow > 0 And (Kar_flexgrid2.MouseCol = 0 Or Kar_flexgrid2.MouseCol = 3) Then
                Dim tip As String
                ToolTipKar.Active = True
                Static oldx As Integer
                Static oldy As Integer
                If oldx <> Kar_flexgrid2.MouseCol Or oldy <> Kar_flexgrid2.MouseRow Then
                    tip = Me.Kar_flexgrid2.Item(Kar_flexgrid2.MouseRow, Kar_flexgrid2.MouseCol)
                    Dim line_id As Integer = Kar_flexgrid2.Item(Kar_flexgrid2.MouseRow, 4)
                    Dim opmerking As String = KarLines(line_id).opmerking
                    tip = tip + "  " + opmerking
                    ToolTipKar.SetToolTip(Kar_flexgrid2, tip)
                End If
                oldx = Kar_flexgrid2.MouseCol
                oldy = Kar_flexgrid2.MouseRow
            Else
                ToolTipKar.Active = False
            End If
        Catch ex As Exception

        End Try
    End Sub
    Private Sub Kar_FlexGrid3_MouseMove(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles Kar_flexgrid3.MouseMove
        Try
            If Kar_flexgrid3.MouseRow > 0 And (Kar_flexgrid3.MouseCol = 0 Or Kar_flexgrid3.MouseCol = 3) Then
                Dim tip As String
                ToolTipKar.Active = True
                Static oldx As Integer
                Static oldy As Integer
                If oldx <> Kar_flexgrid3.MouseCol Or oldy <> Kar_flexgrid3.MouseRow Then
                    tip = Me.Kar_flexgrid3.Item(Kar_flexgrid3.MouseRow, Kar_flexgrid3.MouseCol)
                    Dim line_id As Integer = Kar_flexgrid3.Item(Kar_flexgrid3.MouseRow, 4)
                    Dim opmerking As String = KarLines(line_id).opmerking
                    tip = tip + "  " + opmerking
                    ToolTipKar.SetToolTip(Kar_flexgrid3, tip)
                End If
                oldx = Kar_flexgrid3.MouseCol
                oldy = Kar_flexgrid3.MouseRow
            Else
                ToolTipKar.Active = False
            End If
        Catch ex As Exception

        End Try
    End Sub
    Private Sub Kar_FlexGrid4_MouseMove(ByVal sender As Object, ByVal e As System.Windows.Forms.MouseEventArgs) Handles Kar_flexgrid4.MouseMove
        Try

            If Kar_flexgrid4.MouseRow > 0 And (Kar_flexgrid4.MouseCol = 0 Or Kar_flexgrid4.MouseCol = 3) Then
                Dim tip As String
                ToolTipKar.Active = True
                Static oldx As Integer
                Static oldy As Integer
                If oldx <> Kar_flexgrid4.MouseCol Or oldy <> Kar_flexgrid4.MouseRow Then
                    tip = Me.Kar_flexgrid4.Item(Kar_flexgrid4.MouseRow, Kar_flexgrid4.MouseCol)
                    Dim line_id As Integer = Kar_flexgrid4.Item(Kar_flexgrid4.MouseRow, 4)
                    Dim opmerking As String = KarLines(line_id).opmerking
                    tip = tip + "  " + opmerking
                    ToolTipKar.SetToolTip(Kar_flexgrid4, tip)
                End If
                oldx = Kar_flexgrid4.MouseCol
                oldy = Kar_flexgrid4.MouseRow
            Else
                ToolTipKar.Active = False
            End If
        Catch ex As Exception

        End Try

    End Sub
    Private Function GetNewBarcode(ByVal datum As Date)
        Dim barcode As Integer = 0
        Dim barcode_str As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' Get and Update UNB counter 
                Dim Cmd As New OdbcCommand("SELECT * FROM barcode_count WHERE datum=?", Conn)
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", Format(datum, "yyyy-MM-dd"))
                Dim Reader As OdbcDataReader
                Reader = Cmd.ExecuteReader
                If Reader.HasRows Then
                    Reader.Read()
                    barcode = CHint(Reader("counter"))

                    barcode = barcode + 1
                    If barcode > 9999 Then
                        barcode = 1
                    End If

                    Reader.Close()

                    Dim Cmd2 As New OdbcCommand("UPDATE barcode_count SET counter=? WHERE datum=?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", barcode)
                    Cmd2.Parameters.AddWithValue("", Format(datum, "yyyy-MM-dd"))
                    Cmd2.ExecuteNonQuery()

                Else
                    barcode = 1
                    Dim Cmd2 As New OdbcCommand("INSERT INTO barcode_count (counter,datum) VALUES (?,?)", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", barcode)
                    Cmd2.Parameters.AddWithValue("", Format(datum, "yyyy-MM-dd"))
                    Cmd2.ExecuteNonQuery()

                End If



            End Using
        Catch ex As Exception
            ErrorLog("Fout: New Barcode" + ex.Message)
            MessageBox.Show("Fout: New Barcode" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        barcode_str = "000" + Format(datum, "yyMMdd") + Format(barcode, "0000")
        Return barcode_str

    End Function

    Private Sub PrintPakbon(karnr As Integer)

        Dim kar_id As Integer
        kar_id = KarHeaders(karnr).kar_id
        'MsgBox(Str(karnr) + " : " + Str(kar_id))

        Dim barcode As String = KarHeaders(karnr).barcode
        MsgBox("Pakbon " + barcode + " wordt geprint")
        My.Computer.Clipboard.SetText(barcode)

        Dim CmdString As String = "SELECT * FROM  printer_spooler  WHERE 1=0"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'welke printer.. vestiging eerste orderline uitlezen
                Dim printernr As Integer = 1
                Dim reader6 As OdbcDataReader
                Dim Cmd6 As New OdbcCommand("select vestiging from Orderlines WHERE OrderHeader_id = ?", Conn)
                Cmd6.Parameters.Clear()
                Cmd6.Parameters.AddWithValue("", KarHeaders(karnr).header_id)
                reader6 = Cmd6.ExecuteReader()
                If reader6.HasRows Then
                    Dim vestiging As Integer = CHint(reader6("vestiging"))
                    If vestiging = 2 Then printernr = 2
                End If


                'insert into printerspooler
                Dim Cmd3 As New OdbcCommand("INSERT INTO printer_spooler SET kar_id=?, datum=?, printer=?", Conn)
                Cmd3.Parameters.Clear()
                Cmd3.Parameters.AddWithValue("", kar_id)
                Cmd3.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                Cmd3.Parameters.AddWithValue("", printernr)
                Cmd3.ExecuteNonQuery()

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (pakbon printerspooler)" + ex.Message)
            MsgBox("Database fout: (pakbon printerspooler)" + ex.Message, MsgBoxStyle.OkOnly)
        End Try


    End Sub

    Private Sub kar_aanvulling_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles kar_aanvulling1_but.Click, kar_aanvulling2_but.Click, kar_aanvulling3_but.Click, kar_aanvulling4_but.Click
        Dim btn As Button
        btn = CType(sender, Button)
        Dim selectie = Val(btn.Tag)
        Dim karnr As Integer = 0
        Select Case selectie
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
        End Select

        If karnr = -1 Then Exit Sub

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'write new info to database

                Dim header_id As Integer = -1
                Dim barcode As String = ""

                header_id = KarHeaders(karnr).header_id
                barcode = KarHeaders(karnr).barcode

                Dim barcode_short As String = Mid(barcode, Len(barcode) - 2, 3)
                If header_id = -1 Then
                    Exit Sub
                End If

                'read time 
                Dim vestiging1 As Integer = 0
                Dim locatiedif As String = ""
                Dim CmdHeaderString As String = "select * from orderheaders WHERE Header_id = " + Str(header_id)
                Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmdr.ExecuteReader()
                Dim afleverdatum As Date = Now
                If Reader.HasRows Then
                    Reader.Read()
                    afleverdatum = CType(Reader("afleverdatum"), Date)
                    vestiging1 = CHint(Reader("vestiging"))
                End If
                Reader.Close()

                Dim pakbonopmerking2 As String = ""
                Dim vestiging2 As Integer = 0
                Dim CmdHeaderString2 As String = "select * from  orderheaders WHERE Header_id = " + Str(header2_aanvulling)
                Dim Cmdr2 As New OdbcCommand(CmdHeaderString2, Conn)
                Dim Reader2 As OdbcDataReader
                Reader2 = Cmdr2.ExecuteReader()
                If Reader2.HasRows Then
                    Reader2.Read()
                    vestiging2 = CHint(Reader2("vestiging"))
                    pakbonopmerking2 = CHstr(Reader2("pakbon_opmerking"))
                End If
                Reader2.Close()
                If vestiging1 <> vestiging2 Then
                    locatiedif = "Op kar van andere locatie"
                End If


                If header2_aanvulling > 0 Then 'global uit aanvulling button

                    Dim cmdstring As String = ""
                    Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                    Cmd2.CommandText = "UPDATE orderheaders SET aanvulling=?, pakbon_opmerking=?,afleverdatum=? WHERE header_id = " + Trim(Str(header2_aanvulling))
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", header_id)
                    Cmd2.Parameters.AddWithValue("", "AANVULLING " + locatiedif + " KAR : " + barcode_short + " " + pakbonopmerking2)
                    Cmd2.Parameters.AddWithValue("", Format(afleverdatum, "yyyy-MM-dd HH:mm"))
                    Cmd2.ExecuteNonQuery()
                End If
                header2_aanvulling = 0
                kar_aanvulling1_but.Visible = False
                kar_aanvulling2_but.Visible = False
                kar_aanvulling3_but.Visible = False
                kar_aanvulling4_but.Visible = False
                PanelKarindelingOnder.Enabled = False
                PanelKarindelingMidden.Enabled = False
                PanelKarIndelingBoven.Enabled = False
                ' C1Tab.SelectedTab = C1Tab.TabPages(0)
                SetTabPage("Order invoer")
                Set_Boek_reload()
                Update_Boek()
            End Using
        Catch ex As Exception
            ErrorLog("Fout KarindelingAanvulling: " + ex.Message)
            MsgBox("Fout KarindelingAanvulling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub

    Private Sub Kar_SortMartin_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Kar_SortMartin_but.Click
        Dim header_id = -1
        Dim kartype_id = 1
        For i = 1 To 100
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
                kartype_id = KarHeaders(i).kar_type
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If

        Maak_Karindeling(False, kartype_id, header_id, karindeling_date, 2)
        Show_Karindeling(header_id)
    End Sub

    Private Sub kar_wissel_vestiging_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles kar_wissel_vestiging_but.Click

        Dim header_id = -1
        For i = 1 To Max_Kar_Headers
            If KarHeaders(i).tag = True Then
                header_id = KarHeaders(i).header_id
            End If
        Next
        If header_id = -1 Then
            Exit Sub
        End If

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'write new info to database
                Dim koppelnummer As Integer = 0
                Dim Cmdr As New OdbcCommand("select koppelnummer from orderheaders WHERE header_id=?", Conn)
                Cmdr.Parameters.Clear()
                Cmdr.Parameters.AddWithValue("", header_id)
                Dim Reader As OdbcDataReader
                Reader = Cmdr.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()
                    koppelnummer = CHint(Reader("koppelnummer"))
                End If
                Reader.Close()
                If koppelnummer > 0 Then
                    Dim header_id2 As Integer = 0
                    Dim Cmdr2 As New OdbcCommand("select header_id,koper_ean from orderheaders WHERE header_id<>? AND koppelnummer=?", Conn)
                    Cmdr2.Parameters.Clear()
                    Cmdr2.Parameters.AddWithValue("", header_id)
                    Cmdr2.Parameters.AddWithValue("", koppelnummer)
                    Dim Reader2 As OdbcDataReader
                    Reader2 = Cmdr2.ExecuteReader()

                    If Reader2.HasRows Then
                        Reader2.Read()
                        header_id2 = CHint(Reader2("header_id"))
                        Dim koper_ean As String = CHstr(Reader2("koper_ean"))
                        'opslaan
                        Kar_opslaanMain()
                        'andere kar openen
                        Show_Karindeling(header_id2)

                        Update_Boek(1, koper_ean, header_id2)
                    End If
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Fout Wissel karindeling: " + ex.Message)
            MsgBox("Fout Wissel karindeling: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub

    Private Sub kar_overgooien_naar_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles kar_overgooien1_naar_but.Click, kar_overgooien2_naar_but.Click, kar_overgooien3_naar_but.Click, kar_overgooien4_naar_but.Click
        Dim btn As Button
        Dim karnr As Integer = 0
        btn = CType(sender, Button)
        Dim selectie = Val(btn.Tag)
        Select Case selectie
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
                kar_overgooien1_naar_but.BackColor = Color.Green
                Kar_lagen1_txt.Text = "0"
                Kar_Kartype1_cmb.SelectedIndex = 2
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
                kar_overgooien2_naar_but.BackColor = Color.Green
                Kar_lagen2_txt.Text = "0"
                Kar_Kartype2_cmb.SelectedIndex = 2
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
                kar_overgooien3_naar_but.BackColor = Color.Green
                Kar_lagen3_txt.Text = "0"
                Kar_Kartype3_cmb.SelectedIndex = 2
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
                kar_overgooien4_naar_but.BackColor = Color.Green
                Kar_lagen4_txt.Text = "0"
                Kar_Kartype4_cmb.SelectedIndex = 2
        End Select

        Dim barcode As String = KarHeaders(karnr).barcode
        overgooier = barcode  'global

        KarHeaders(karnr).overgooien_naar = barcode

        KarHeaders(karnr).kar_type = 8  'N.V.T.
        KarHeaders(karnr).aantal_lagen = 0


    End Sub

    Private Sub kar_overgooien_hierop_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles kar_overgooien1_hierop_but.Click, kar_overgooien2_hierop_but.Click, kar_overgooien3_hierop_but.Click, kar_overgooien4_hierop_but.Click
        Dim btn As Button
        Dim karnr As Integer = 0
        btn = CType(sender, Button)
        Dim selectie = Val(btn.Tag)
        Select Case selectie
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
                kar_overgooien1_hierop_but.BackColor = Color.Red
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
                kar_overgooien2_hierop_but.BackColor = Color.Red
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
                kar_overgooien3_hierop_but.BackColor = Color.Red
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
                kar_overgooien4_hierop_but.BackColor = Color.Red
        End Select

        Dim kar_id = KarHeaders(karnr).kar_id
        If Not (overgooier = "" Or overgooier = "-") Then  'global saved in overgooien_naar
            KarHeaders(karnr).overgooien_hierop = overgooier
            Dim barcode As String = KarHeaders(karnr).barcode

            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Dim Cmd3 As New OdbcCommand("UPDATE orderkarren SET overgooien_hierop=? WHERE kar_id=?", Conn)
                    Cmd3.Parameters.Clear()
                    Cmd3.Parameters.AddWithValue("", overgooier)
                    Cmd3.Parameters.AddWithValue("", kar_id)
                    Cmd3.ExecuteNonQuery()

                    Dim Cmd2 As New OdbcCommand("UPDATE orderkarren SET overgooien_naar=? WHERE barcode=?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", barcode)
                    Cmd2.Parameters.AddWithValue("", overgooier)
                    Cmd2.ExecuteNonQuery()

                End Using
            Catch ex As Exception
                ErrorLog("Fout: overgooier save" + ex.Message)
                MessageBox.Show("Fout: overgooier save" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try



        End If


    End Sub

    Private Sub kar_overgooien_wis_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles kar_overgooien1_wis_but.Click, kar_overgooien2_wis_but.Click, kar_overgooien3_wis_but.Click, kar_overgooien4_wis_but.Click
        Dim btn As Button
        Dim karnr As Integer = 0
        btn = CType(sender, Button)
        Dim selectie = Val(btn.Tag)
        Select Case selectie
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
                kar_overgooien1_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                kar_overgooien1_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
                kar_overgooien2_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                kar_overgooien2_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
                kar_overgooien3_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                kar_overgooien3_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
                kar_overgooien4_hierop_but.BackColor = Color.FromKnownColor(KnownColor.Control)
                kar_overgooien4_naar_but.BackColor = Color.FromKnownColor(KnownColor.Control)
        End Select
        overgooier = ""
        Dim kar_id = KarHeaders(karnr).kar_id
        Dim overgooien_naar As String = KarHeaders(karnr).overgooien_naar
        Dim overgooien_hierop As String = KarHeaders(karnr).overgooien_hierop


        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                If Not (overgooien_naar = "" Or overgooien_naar = "-") Then
                    Dim Cmd3 As New OdbcCommand("UPDATE orderkarren SET overgooien_hierop='', overgooien_naar='' WHERE kar_id=?", Conn)
                    Cmd3.Parameters.Clear()
                    Cmd3.Parameters.AddWithValue("", kar_id)
                    Cmd3.ExecuteNonQuery()

                    Dim Cmd2 As New OdbcCommand("UPDATE orderkarren SET overgooien_hierop='', overgooien_naar='' WHERE barcode=?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", overgooien_naar)
                    Cmd2.ExecuteNonQuery()

                    KarHeaders(karnr).overgooien_naar = ""
                End If

                If Not (overgooien_hierop = "" Or overgooien_hierop = "-") Then
                    Dim Cmd3 As New OdbcCommand("UPDATE orderkarren SET overgooien_hierop='', overgooien_naar='' WHERE kar_id=?", Conn)
                    Cmd3.Parameters.Clear()
                    Cmd3.Parameters.AddWithValue("", kar_id)
                    Cmd3.ExecuteNonQuery()

                    Dim Cmd2 As New OdbcCommand("UPDATE orderkarren SET overgooien_hierop='', overgooien_naar='' WHERE barcode=?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", overgooien_hierop)
                    Cmd2.ExecuteNonQuery()

                    KarHeaders(karnr).overgooien_hierop = ""
                End If



            End Using
        Catch ex As Exception
            ErrorLog("Fout: overgooier save" + ex.Message)
            MessageBox.Show("Fout: overgooier save" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try





    End Sub

    Private Sub Kar_Kartype_cmb_SelectedIndexChanged(sender As Object, e As EventArgs) Handles Kar_Kartype1_cmb.SelectedIndexChanged, Kar_Kartype2_cmb.SelectedIndexChanged, Kar_Kartype3_cmb.SelectedIndexChanged, Kar_Kartype4_cmb.SelectedIndexChanged
        Dim btn As ComboBox
        Dim karnr As Integer = -1
        btn = CType(sender, ComboBox)
        Dim selectie = Val(btn.Tag)
        Dim selectedindex As Integer = 0
        Select Case selectie
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
                selectedindex = Kar_Kartype1_cmb.SelectedIndex
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
                selectedindex = Kar_Kartype2_cmb.SelectedIndex
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
                selectedindex = Kar_Kartype3_cmb.SelectedIndex
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
                selectedindex = Kar_Kartype4_cmb.SelectedIndex
        End Select

        If karnr = -1 Then Exit Sub
        Dim kartype As Integer = 0

        Select Case selectedindex
            Case 0 : kartype = 2
            Case 1 : kartype = 3
            Case 2 : kartype = 8
            Case 3 : kartype = 5
            Case 4 : kartype = 16
            Case 5 : kartype = 6
            Case 6 : kartype = 7
        End Select

        KarHeaders(karnr).kar_type = kartype
        Dim aantal_lagen As Integer = Bereken_Aantal_Lagen(karnr)

        If kartype = 3 Then aantal_lagen = aantal_lagen - 4
        If aantal_lagen < 0 Then aantal_lagen = 0
        If kartype > 5 Then aantal_lagen = 0
        KarHeaders(karnr).aantal_lagen = aantal_lagen


        Select Case selectie
            Case 1
                Kar_lagen1_txt.Text = Trim(Str(KarHeaders(karnr).aantal_lagen))
            Case 2
                Kar_lagen2_txt.Text = Trim(Str(KarHeaders(karnr).aantal_lagen))
            Case 3
                Kar_lagen3_txt.Text = Trim(Str(KarHeaders(karnr).aantal_lagen))
            Case 4
                Kar_lagen4_txt.Text = Trim(Str(KarHeaders(karnr).aantal_lagen))
        End Select


    End Sub

    Private Sub OvergooienHieropAanvullenToolStripMenuItem_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles OvergooienHieropAanvullenToolStripMenuItem.Click

        Dim kar_id As Integer = -1

        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 6) = "KARID:" Then
                kar_id = Val(Mid(Node.Tag, 7))
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 6) = "KARID:" And node2.Checked = True Then
                        kar_id = Val(Mid(node2.Tag, 7))
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        If kar_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 6) = "KARID:" Then
                kar_id = Val(Mid(TreeView1.SelectedNode.Tag, 7))
            End If
        End If


        If kar_id >= 0 Then

            If Not (overgooier = "" Or overgooier = "-") Then  'global saved in overgooien_naar
                Try
                    'Open Connection
                    Using Conn As New OdbcConnection(ConnString)
                        Conn.Open()

                        'read barcode from kar_id
                        Dim barcode As String = ""
                        Dim query As String = "SELECT barcode from orderkarren WHERE kar_id=" + Str(kar_id)
                        Dim Cmd4 As New OdbcCommand(query, Conn)
                        Dim reader4 As OdbcDataReader
                        reader4 = Cmd4.ExecuteReader
                        If reader4.HasRows Then
                            reader4.Read()
                            barcode = CHstr(reader4("barcode"))
                        End If
                        reader4.Close()

                        Dim Cmd3 As New OdbcCommand("UPDATE orderkarren SET overgooien_hierop=? WHERE kar_id=?", Conn)
                        Cmd3.Parameters.Clear()
                        Cmd3.Parameters.AddWithValue("", overgooier)
                        Cmd3.Parameters.AddWithValue("", kar_id)
                        Cmd3.ExecuteNonQuery()

                        Dim Cmd2 As New OdbcCommand("UPDATE orderkarren SET overgooien_naar=? WHERE barcode=?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", barcode)
                        Cmd2.Parameters.AddWithValue("", overgooier)
                        Cmd2.ExecuteNonQuery()



                        'zoek eerste header
                        Dim header_id = -1
                        For i = 1 To Max_Kar_Headers
                            If KarHeaders(i).tag = True Then

                                'update overgooien naar array
                                If KarHeaders(i).barcode = overgooier Then
                                    KarHeaders(i).overgooien_naar = barcode
                                End If
                                header_id = KarHeaders(i).header_id
                                End If
                        Next
                        If header_id = -1 Then
                            Exit Sub
                        End If
                        'read headerid en koper_ean voor update boek
                        Dim CmdKar As New OdbcCommand("SELECT header_id from orderkarren WHERE kar_id=?", Conn)
                        CmdKar.Parameters.Clear()
                        CmdKar.Parameters.AddWithValue("", kar_id)
                        Dim KarrenReader As OdbcDataReader
                        KarrenReader = CmdKar.ExecuteReader
                        If KarrenReader.HasRows Then
                            KarrenReader.Read()
                            Dim header_id2 As Integer = KarrenReader("header_id")
                            Dim koper_ean As String = getkoperfromorder(header_id2)
                            Update_Boek(1, koper_ean, header_id)
                        End If

                    End Using
                Catch ex As Exception
                    ErrorLog("Fout: overgooier koppelen " + ex.Message)
                    MessageBox.Show("Fout: overgooier koppelen " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
                End Try
            End If



        End If
    End Sub

    Private Sub KarCommand1_but_Click(sender As Object, e As EventArgs) Handles KarCommand1_but.Click, KarCommand2_but.Click, KarCommand3_but.Click, KarCommand4_but.Click

        Dim btn As Button
        Dim karnr As Integer = -1
        btn = CType(sender, Button)
        Dim selectie = Val(btn.Tag)
        Dim CommandText As String = ""
        Dim aantal_lagen As Integer = 0
        Select Case selectie
            Case 1
                karnr = Val(Kar_nummer1_lbl.Text)
                CommandText = KarCommand1_cmb.Text.ToLower
                aantal_lagen = CInt(Val(Kar_lagen1_txt.Text))
            Case 2
                karnr = Val(Kar_nummer2_lbl.Text)
                CommandText = KarCommand2_cmb.Text.ToLower
                aantal_lagen = CInt(Val(Kar_lagen2_txt.Text))
            Case 3
                karnr = Val(Kar_nummer3_lbl.Text)
                CommandText = KarCommand3_cmb.Text.ToLower
                aantal_lagen = CInt(Val(Kar_lagen3_txt.Text))
            Case 4
                karnr = Val(Kar_nummer4_lbl.Text)
                CommandText = KarCommand4_cmb.Text.ToLower
                aantal_lagen = CInt(Val(Kar_lagen4_txt.Text))
        End Select

        If karnr = -1 Then Exit Sub

        Dim kar_id As Integer = KarHeaders(karnr).kar_id
        Dim header_id As Integer = KarHeaders(karnr).header_id
        Dim kar_type As Integer = KarHeaders(karnr).kar_type

        'Print pakbon
        'Print brief via Floriday
        'Print brief via SDF
        'Floriday aanpassing 
        'Floriday rapport
        'Reset floriday error

        Select Case CommandText
            Case "" : MsgBox("Selecteer een optie om uit te voeren")
            Case "print pakbon" : PrintPakbon(karnr)
            Case "print brief via floriday"
                Dim success As Boolean = PrintBriefFloriday(header_id, kar_id)
                If success = True Then MsgBox("De brief wordt geprint")

            Case "print brief via sdf" : PrintViaSDF(karnr)
            Case "floriday aanpassen" : Floriday_OrderAanpassen(header_id, kar_id)
            'Case "fd lagen aanpassing" : Floriday_KarLagenAanpassen(header_id, kar_id, kar_type, aantal_lagen)
            'Case "fd brief verwijderen" : Floriday_BriefVerwijderen(header_id, kar_id)
            Case "floriday rapport" : PrintFloridayErrorReport(kar_id)
            Case "reset floriday fout" : Resetfloridayerror(kar_id)
        End Select


    End Sub

    Private Sub Floriday_BriefVerwijderen(orderheader_id As Integer, kar_id As Integer)

        Dim answer As MsgBoxResult = MsgBox("Gebruik deze optie om brieven te annuleren als ze naar floriday zijn verstuurd.  Kar annuleren?", vbYesNo)
        If answer = vbYes Then
            Dim query As String = ""
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Dim reader As OdbcDataReader
                    Dim reader2 As OdbcDataReader
                    Dim cmd As New OdbcCommand("", Conn)
                    Dim cmd2 As New OdbcCommand("", Conn)
                    Dim cmd3 As New OdbcCommand("", Conn)

                    'check of kar al verstuurd is......
                    Dim taskrun_id As Integer = 0
                    Dim fulfillmentOrderId As String = ""
                    Dim deliveryOrderId As String = ""
                    Dim pdf_saved As Boolean = False
                    Dim briefnummer As String = ""
                    query = "SELECT * From floriday_taskrun WHERE kar_id = " + Str(kar_id)
                    cmd.CommandText = query
                    reader = cmd.ExecuteReader()
                    If reader.HasRows Then
                        taskrun_id = CHint(reader("id"))
                        fulfillmentOrderId = CHstr(reader("fulfillmentOrderId"))
                        deliveryOrderId = CHstr(reader("deliveryOrderId"))
                        pdf_saved = CHbool(reader("pdf_saved"))
                        briefnummer = CHstr(reader("briefnummer"))
                        Dim fulfillment_STATUS As String = CHstr(reader("fulfillment_STATUS"))
                        If fulfillment_STATUS = "CANCELLED" Then
                            MsgBox("Deze order is al geannuleerd.")
                            Exit Sub
                        ElseIf fulfillment_STATUS <> "ACCEPTED" Then
                            MsgBox("Verwijderen is pas mogelijk als de veiling de brief heeft verwerkt.")
                            Exit Sub
                        End If
                        If pdf_saved = False Or briefnummer = "" Then
                            MsgBox("Een brief die nog niet geprint is, kan niet verwijderd worden.")
                            Exit Sub
                        End If
                    Else
                        MsgBox("Karinfo niet gevonden, het is niet mogelijk om deze order te verwijderen.")
                        Exit Sub
                    End If
                    reader.Close()

                    Dim koper_ean As String = ""
                    Dim klok As Boolean = False
                    query = "SELECT * FROM orderheaders WHERE  Header_id=" + Str(orderheader_id)
                    reader = cmd.ExecuteReader
                    If reader.HasRows Then
                        reader.Read()
                        koper_ean = CHstr(reader("koper_ean"))
                        If Mid(koper_ean, 1, 4) = "0000" Then
                            klok = True
                        End If
                    End If
                    reader.Close()

                    If klok = True Then
                        'FFO en Delivery verwijderen
                        Dim FFPostID As Integer = InsertTask(0, 95, "DELETE", "fulfillment-orders", fulfillmentOrderId, "", "", "", "", "", "", "", taskrun_id)
                        Dim FFPostID2 As Integer = InsertTask(120, 95, "DELETE", "delivery-orders", deliveryOrderId, "auction", "", "", "", "", "", "", taskrun_id)
                        'header status aanpassen

                        query = "UPDATE floriday_taskrun SET kar_id=? WHERE kar_id=" + Str(kar_id)
                        cmd3.Parameters.Clear()
                        cmd3.Parameters.AddWithValue("", -kar_id)
                        cmd3.CommandText = query
                        cmd3.ExecuteNonQuery()

                        query = "UPDATE orderkarren SET floriday_printflag=0 WHERE kar_id=" + Str(kar_id)
                        cmd3.CommandText = query
                        cmd3.ExecuteNonQuery()

                        SetNewStatusFlag(Now, orderheader_id, True)


                    Else
                        'BB -> FFO Verwijderen, reset aantallen in order
                        Dim FFPostID As Integer = InsertTask(0, 95, "DELETE", "fulfillment-orders", fulfillmentOrderId)

                        query = "SELECT * From orderkarlines WHERE kar_id =" + Str(kar_id)
                        cmd.CommandText = query
                        reader = cmd.ExecuteReader()
                        Do While reader.Read()
                            Dim aantal As Integer = CHint(reader("aantal"))
                            Dim orderline_id As Integer = CHint(reader("orderline_id"))

                            query = "SELECT * From floriday_salesorders_boek WHERE boek_orderlineId=" + Str(orderline_id)
                            cmd2.CommandText = query
                            reader2 = cmd2.ExecuteReader()
                            If reader2.HasRows Then
                                reader2.Read()
                                Dim packages_to_fullfill As Integer = CHint(reader2("packages_to_fullfill"))

                                query = "UPDATE floriday_salesorders_boek SET packages_to_fullfill=? WHERE boek_orderlineId=?"
                                cmd3.CommandText = query
                                cmd3.Parameters.Clear()
                                cmd3.Parameters.AddWithValue("", packages_to_fullfill + aantal)
                                cmd3.Parameters.AddWithValue("", orderline_id)
                                cmd3.ExecuteNonQuery()

                            End If
                            reader2.Close()
                        Loop
                        reader.Close()

                        query = "UPDATE floriday_taskrun SET kar_id=? WHERE kar_id=" + Str(kar_id)
                        cmd3.Parameters.Clear()
                        cmd3.Parameters.AddWithValue("", -kar_id)
                        cmd3.CommandText = query
                        cmd3.ExecuteNonQuery()

                        query = "UPDATE orderkarren SET floriday_printflag=0 WHERE kar_id=" + Str(kar_id)
                        cmd3.CommandText = query
                        cmd3.ExecuteNonQuery()

                        SetNewStatusFlag(Now, orderheader_id, True)

                    End If



                End Using
            Catch ex As Exception
                ErrorLog("Fout: FD Error reporter " + ex.Message)
                MessageBox.Show("Fout: FD Error reporter" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

        End If

    End Sub

    Private Sub Floriday_KarLagenAanpassen(header_id As Integer, kar_id As Integer, kar_type As Integer, aantal_lagen As Integer)
        Dim answer As MsgBoxResult = MsgBox("Gebruik deze optie om kar-lagen opnieuw te versturen als de brief al gemaakt is.  informatie opnieuw opsturen?", vbYesNo)
        If answer = vbYes Then


            Dim query As String = ""
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Dim reader As OdbcDataReader
                    Dim cmd As New OdbcCommand("", Conn)
                    Dim cmd2 As New OdbcCommand("", Conn)

                    'check of kar al verstuurd is......
                    Dim taskrun_id As Integer = 0
                    Dim fulfillmentOrderId As String = ""
                    Dim pdf_saved As Boolean = False
                    Dim briefnummer As String = ""
                    query = "SELECT * From floriday_taskrun WHERE kar_id = " + Str(kar_id)
                    cmd.CommandText = query
                    Reader = cmd.ExecuteReader()
                    If Reader.HasRows Then
                        taskrun_id = CHint(reader("id"))
                        fulfillmentOrderId = CHstr(reader("fulfillmentOrderId"))
                        pdf_saved = CHbool(reader("pdf_saved"))
                        briefnummer = CHstr(reader("briefnummer"))
                        Dim fulfillment_STATUS As String = CHstr(reader("fulfillment_STATUS"))
                        If fulfillment_STATUS <> "ACCEPTED" Then
                            MsgBox("Correcties zijn pas mogelijk als de veiling de brief heeft verwerkt.")
                            Exit Sub
                        End If
                        If pdf_saved = False Or briefnummer = "" Then
                            MsgBox("Correcties zijn alleen nodig voor brieven die al geprint zijn.")
                            Exit Sub
                        End If
                    Else
                        MsgBox("Karinfo niet gevonden, het is niet mogelijk om deze order te corrigeren.")
                        Exit Sub
                    End If
                    reader.Close()

                    If aantal_lagen = 0 Then
                        kar_type = 8  ' Kar naar NVT/NONE
                    End If
                    'kar type en aantal lagen
                    Dim kar_enum As String = "AUCTION_TROLLEY"
                    Dim extralagen As Integer = 1
                    Select Case kar_type
                        Case 1, 2
                            kar_enum = "DANISH_TROLLEY"
                            extralagen = aantal_lagen - 1
                        Case 3, 13, 14, 15
                            kar_enum = "AUCTION_TROLLEY"
                            extralagen = aantal_lagen
                        Case 4, 5
                            kar_enum = "DANISH_TROLLEY_NON_CC_RFID"
                            extralagen = aantal_lagen - 1
                        Case 8, 9, 10, 11, 12 : kar_enum = "NONE"
                        Case 6 : kar_enum = "PALLET"
                        Case 7 : kar_enum = "EURO_PALLET"
                        Case 16 : kar_enum = "EURO_TROLLEY"
                    End Select

                    query = "INSERT INTO floriday_fulfillmentorders_corrections(correctionId,status,creationDateTime,lastModifiedDateTime,crc,crc_delete) VALUES (?,?,?,?,?,?)"
                    cmd2.CommandText = query
                    cmd2.Parameters.Clear()

                    Dim newid As String = System.Guid.NewGuid().ToString()

                    cmd2.Parameters.AddWithValue("", newid)
                    cmd2.Parameters.AddWithValue("", "")
                    cmd2.Parameters.AddWithValue("", Format(Now, "yy-MM-dd HH:mm:ss"))
                    cmd2.Parameters.AddWithValue("", Format(Now, "yy-MM-dd HH:mm:ss"))
                    cmd2.Parameters.AddWithValue("", 0)
                    cmd2.Parameters.AddWithValue("", 0)
                    cmd2.ExecuteNonQuery()

                    cmd2.CommandText = "SELECT LAST_INSERT_ID()"
                    Dim id As Integer = Convert.ToInt32(cmd2.ExecuteScalar())

                    query = "INSERT INTO floriday_fulfillmentorders_corrections_loadcarriercorrections(logisticLabelCode,loadCarrierType,numberOfAdditionalLayers,crc,crc_delete,parent_id) VALUES (?,?,?,?,?,?)"
                    cmd2.CommandText = query
                    cmd2.Parameters.Clear()

                    cmd2.Parameters.AddWithValue("", briefnummer)
                    cmd2.Parameters.AddWithValue("", kar_enum)
                    cmd2.Parameters.AddWithValue("", extralagen)
                    cmd2.Parameters.AddWithValue("", 0)
                    cmd2.Parameters.AddWithValue("", 0)
                    cmd2.Parameters.AddWithValue("", id)
                    cmd2.ExecuteNonQuery()


                    InsertTask(0, 95, "PUT", "fulfillment-orders", fulfillmentOrderId, "corrections", "", "", "", "", "", "", id)
                    InsertTask(5, 95, "GET", "fulfillment-orders", fulfillmentOrderId)

                    Dim FFPostID As Integer = InsertTask(10, 95, "GET", "fulfillment-orders", fulfillmentOrderId, "logistic-labels", "", "", "", "", "", "", taskrun_id)

                    MsgBox("Het aantal lagen wordt gecorrigeerd")

                    'Dim answer2 As MsgBoxResult = MsgBox("Het aantal lagen is gecorrigeerd, brief opnieuw printen?", vbYesNo)
                    'If answer2 = vbYes Then

                    '    query = "UPDATE floriday_taskrun SET done=0, pdf_saved=0, floridayfulfillmentFlag=4, fulfillment_labelcodes_POST_id=? WHERE Id=" + Str(taskrun_id)
                    '    cmd2.CommandText = query
                    '    cmd2.Parameters.Clear()
                    '    cmd2.Parameters.AddWithValue("", FFPostID)
                    '    cmd2.ExecuteNonQuery()

                    'End If

                End Using
            Catch ex As Exception
                ErrorLog("Fout: FD karlagen veranderen " + ex.Message)
                MessageBox.Show("Fout: FD karlagen veranderen" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try


        End If

    End Sub

    Private Sub Resetfloridayerror(kar_id As Integer)

        Dim query As String = ""

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim reader As OdbcDataReader
                Dim reader2 As OdbcDataReader

                Dim cmd As New OdbcCommand("", Conn)
                Dim cmd2 As New OdbcCommand("", Conn)
                Dim cmd3 As New OdbcCommand("", Conn)

                Dim orderheaderid As Integer = 0
                Dim barcode As String = ""
                query = "SELECT * From orderkarren WHERE kar_id =" + Str(kar_id)
                cmd.CommandText = query
                reader = cmd.ExecuteReader()
                Dim floriday_printflag As Integer = 0
                If reader.HasRows Then
                    reader.Read()
                    floriday_printflag = CHint(reader("floriday_printflag"))
                    orderheaderid = CHint(reader("header_id"))
                    barcode = CHstr(reader("barcode"))
                Else
                    MsgBox("Deze brief is nog niet verwerkt, dus kan nog niet gereset worden")
                    Exit Sub
                End If
                reader.Close()

                If floriday_printflag = 99 Then   'Error

                    query = "SELECT * From floriday_taskrun WHERE kar_id =" + Str(kar_id)
                    cmd.CommandText = query
                    reader = cmd.ExecuteReader()
                    Dim floridayFulfillmentFlag As Integer = 0
                    If reader.HasRows Then
                        reader.Read()
                        floridayFulfillmentFlag = CHint(reader("floridayFulfillmentFlag"))
                    End If
                    reader.Close()

                    If floridayFulfillmentFlag > 1 Then

                        query = "SELECT * From orderkarlines WHERE kar_id =" + Str(kar_id)
                        cmd.CommandText = query
                        reader = cmd.ExecuteReader()
                        Do While reader.Read()
                            Dim aantal As Integer = CHint(reader("aantal"))
                            Dim orderline_id As Integer = CHint(reader("orderline_id"))

                            query = "SELECT * From floriday_salesorders_boek WHERE boek_orderlineId=" + Str(orderline_id)
                            cmd2.CommandText = query
                            reader2 = cmd2.ExecuteReader()
                            If reader2.HasRows Then
                                reader2.Read()
                                Dim packages_to_fullfill As Integer = CHint(reader2("packages_to_fullfill"))

                                query = "UPDATE floriday_salesorders_boek SET packages_to_fullfill=? WHERE boek_orderlineId=?"
                                cmd3.CommandText = query
                                cmd3.Parameters.Clear()
                                cmd3.Parameters.AddWithValue("", packages_to_fullfill + aantal)
                                cmd3.Parameters.AddWithValue("", orderline_id)
                                cmd3.ExecuteNonQuery()

                            End If
                            reader2.Close()
                        Loop
                        reader.Close()

                        query = "UPDATE floriday_taskrun SET kar_id=? WHERE kar_id=" + Str(kar_id)
                        cmd3.Parameters.Clear()
                        cmd3.Parameters.AddWithValue("", -kar_id)
                        cmd3.CommandText = query
                        cmd3.ExecuteNonQuery()

                        query = "UPDATE orderkarren SET floriday_printflag=0 WHERE kar_id=" + Str(kar_id)
                        cmd3.CommandText = query
                        cmd3.ExecuteNonQuery()

                        SetNewStatusFlag(Now, orderheaderid, True)

                        MsgBox("De kar kan opnieuw worden geprint.")

                    Else

                        query = "UPDATE floriday_taskrun SET kar_id=? WHERE kar_id=" + Str(kar_id)  'Reset TAsk
                        cmd3.Parameters.Clear()
                        cmd3.Parameters.AddWithValue("", -kar_id)
                        cmd3.CommandText = query
                        cmd3.ExecuteNonQuery()

                        query = "UPDATE orderkarren SET floriday_printflag=0 WHERE kar_id=" + Str(kar_id)
                        cmd3.CommandText = query
                        cmd3.ExecuteNonQuery()

                        SetNewStatusFlag(Now, orderheaderid, True)

                        MsgBox("De kar kan opnieuw worden geprint.")
                        Exit Sub
                    End If
                Else
                    MsgBox("Deze kar heeft geen foutmeldingen om gereset te worden.")
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Fout: FD Error reset " + ex.Message)
            MessageBox.Show("Fout: FD Error reset" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub

    Private Sub PrintFloridayErrorReport(kar_id As Integer)

        Form13.text_txt.Text = "Floriday brief afhandeling rapport" + vbNewLine + vbNewLine
        Dim query As String = ""

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim reader As OdbcDataReader
                Dim reader2 As OdbcDataReader

                Dim cmd As New OdbcCommand("", Conn)
                Dim cmd2 As New OdbcCommand("", Conn)
                Dim cmd3 As New OdbcCommand("", Conn)
                Dim cmd4 As New OdbcCommand("", Conn)
                Dim cmd5 As New OdbcCommand("", Conn)


                Dim count As Integer

                query = "SELECT COUNT(*) as 'COUNT' FROM floriday_tasks WHERE status=0"
                cmd.CommandText = query
                reader = cmd.ExecuteReader()
                If reader.HasRows Then
                    count = CHint(reader.Item("COUNT"))
                    Form13.text_txt.Text = Form13.text_txt.Text + "Serverstatus : " + Str(count) + " opdrachten in de wachtrij" + vbNewLine
                End If
                reader.Close()

                query = "SELECT * From orderkarren WHERE kar_id =" + Str(kar_id)
                cmd2.CommandText = query
                reader2 = cmd2.ExecuteReader()
                Dim floriday_printflag As Integer = 0
                If reader2.HasRows Then
                    reader2.Read()
                    floriday_printflag = CHint(reader2("floriday_printflag"))

                    If floriday_printflag = 0 Then Form13.text_txt.Text = Form13.text_txt.Text + "Deze kar heeft nog geen print-commando ontvangen (status=0)" + vbNewLine
                    If floriday_printflag = 1 Then Form13.text_txt.Text = Form13.text_txt.Text + "Deze kar heeft het print commando ontvangen, maar de server heeft het nog niet verwerkt. (status=1)." + vbNewLine
                    If floriday_printflag = 2 Then Form13.text_txt.Text = Form13.text_txt.Text + "Deze kar heeft het print commando ontvangen, de server is bezig met verwerking (status=2)." + vbNewLine
                    If floriday_printflag = 99 Then Form13.text_txt.Text = Form13.text_txt.Text + "Deze kar heeft het print commando ontvangen, maar er is iets fout gegaan in het proces (status=99)." + vbNewLine

                End If
                reader2.Close()

                query = "SELECT * From floriday_taskrun WHERE kar_id=" + Str(kar_id)
                cmd.CommandText = query
                reader = cmd.ExecuteReader()
                If reader.HasRows Then
                    reader.Read()

                    Dim id As Integer = CHint(reader("id"))
                    Dim pakbonnummer As String = CHstr(reader("barcode"))
                    Dim kopernaam As String = CHstr(reader("koper_naam"))
                    Dim dataflag As Integer = CHint(reader("dataflag"))
                    Dim floridayTradeitemFlag As Integer = CHint(reader("floridayTradeitemFlag"))
                    Dim floridayBatchFlag As Integer = CHint(reader("floridayBatchFlag"))
                    Dim floridayDeliveryFlag As Integer = CHint(reader("floridayDeliveryFlag"))
                    Dim floridayFulfillmentFlag As Integer = CHint(reader("floridayFulfillmentFlag"))
                    Dim printFlag As Integer = CHint(reader("printFlag"))
                    Dim klok As Boolean = CHbool(reader("klokorder"))
                    Dim timeout As Integer = CHint(reader("timeout"))
                    Dim fulfillment_STATUS As String = CHstr(reader("fulfillment_STATUS"))
                    Dim data_error As String = CHstr(reader("data_error"))

                    Dim delivery_POST_id As Integer = CHint(reader("delivery_POST_id"))
                    Dim delivery_POST_reply As Integer = CHint(reader("delivery_POST_reply"))
                    Dim delivery_POST_error As String = CHstr(reader("delivery_POST_error"))
                    Dim delivery_GET_id As Integer = CHint(reader("delivery_GET_id"))
                    Dim delivery_GET_reply As Integer = CHint(reader("delivery_GET_reply"))
                    Dim delivery_GET_error As String = CHstr(reader("delivery_GET_error"))
                    Dim fulfillment_POST_id As Integer = CHint(reader("fulfillment_POST_id"))
                    Dim fulfillment_POST_reply As Integer = CHint(reader("fulfillment_POST_reply"))
                    Dim fulfillment_POST_error As String = CHstr(reader("fulfillment_POST_error"))

                    Dim deliveryOrderId As String = CHstr(reader("deliveryOrderId"))
                    Dim fulfillmentOrderId As String = CHstr(reader("fulfillmentOrderId"))
                    reader.Close()

                    If dataflag = 1 Then
                        Form13.text_txt.Text = Form13.text_txt.Text + "Data-check is bezig" + vbNewLine
                    ElseIf dataflag = 99 Then
                        Form13.text_txt.Text = Form13.text_txt.Text + "Er is een fout geconstateerd in de data :" + data_error + vbNewLine
                    Else
                        Form13.text_txt.Text = Form13.text_txt.Text + "De Data-informatie is in orde" + vbNewLine + vbNewLine
                    End If

                    query = "SELECT * From floriday_taskrun_lines WHERE taskrun_id=" + Str(id)
                    cmd.CommandText = query
                    reader = cmd.ExecuteReader()
                    Do While reader.Read()
                        kar_id = CHint(reader("kar_id"))
                        Dim tradeItemId As String = CHstr(reader("new_tradeItemId"))
                        Dim tradeitem_POST_id As Integer = CHint(reader("tradeitem_POST_id"))
                        Dim tradeitem_POST_reply As Integer = CHint(reader("tradeitem_POST_reply"))
                        Dim tradeitem_POST_error As String = CHstr(reader("tradeitem_POST_error"))
                        Dim tradeitem_GET_id As Integer = CHint(reader("tradeitem_GET_id"))
                        Dim tradeitem_GET_reply As Integer = CHint(reader("tradeitem_GET_reply"))
                        Dim tradeitem_GET_error As String = CHstr(reader("tradeitem_GET_error"))

                        Form13.text_txt.Text = Form13.text_txt.Text + "Trade-item: " + tradeItemId + vbNewLine
                        If tradeitem_POST_reply = 202 Then Form13.text_txt.Text = Form13.text_txt.Text + "Trade-item variant correct verzonden" + vbNewLine
                        If tradeitem_POST_reply > 202 Then
                            Form13.text_txt.Text = Form13.text_txt.Text + "Trade-item variant niet correct verzonden:" + tradeitem_POST_error + vbNewLine
                        End If
                        If tradeitem_GET_reply = 200 Then Form13.text_txt.Text = Form13.text_txt.Text + "Trade-item variant correct gevonden op floriday" + vbNewLine
                        If tradeitem_GET_reply > 200 Then
                            Form13.text_txt.Text = Form13.text_txt.Text + "Trade-item variant niet gevonden op floriday:" + tradeitem_GET_error + vbNewLine
                        End If
                    Loop
                    reader.Close()
                    Form13.text_txt.Text = Form13.text_txt.Text + vbNewLine

                    query = "SELECT * From floriday_taskrun_lines WHERE taskrun_id=" + Str(id)
                    cmd.CommandText = query
                    reader = cmd.ExecuteReader()
                    Do While reader.Read()
                        Dim batch_id As String = CHstr(reader("batchId"))
                        Dim batch_POST_id As Integer = CHint(reader("batch_POST_id"))
                        Dim batch_POST_reply As Integer = CHint(reader("batch_POST_reply"))
                        Dim batch_POST_error As String = CHstr(reader("new_tradeItemId"))
                        Dim batch_GET_id As Integer = CHint(reader("batch_GET_id"))
                        Dim batch_GET_reply As Integer = CHint(reader("batch_GET_reply"))
                        Dim batch_GET_error As String = CHstr(reader("batch_GET_error"))

                        Form13.text_txt.Text = Form13.text_txt.Text + "Partij aangemaakt: " + batch_id + vbNewLine
                        If batch_POST_reply = 202 Then Form13.text_txt.Text = Form13.text_txt.Text + "Partij correct verzonden" + vbNewLine
                        If batch_POST_reply > 202 Then
                            Form13.text_txt.Text = Form13.text_txt.Text + "Partij niet correct verzonden:" + batch_POST_error + vbNewLine
                        End If
                        If batch_GET_reply = 200 Then Form13.text_txt.Text = Form13.text_txt.Text + "Partij correct gevonden op floriday" + vbNewLine
                        If batch_GET_reply > 200 Then
                            Form13.text_txt.Text = Form13.text_txt.Text + "Partij niet gevonden op floriday:" + batch_GET_error + vbNewLine
                        End If
                    Loop
                    reader.Close()

                    Form13.text_txt.Text = Form13.text_txt.Text + vbNewLine

                    Form13.text_txt.Text = Form13.text_txt.Text + "Delivery aangemaakt: " + deliveryOrderId + vbNewLine
                    If delivery_POST_reply = 202 Then Form13.text_txt.Text = Form13.text_txt.Text + "Delivery correct verzonden" + vbNewLine
                    If delivery_POST_reply > 202 Then
                        Form13.text_txt.Text = Form13.text_txt.Text + "Delivery niet correct verzonden:" + delivery_POST_error + vbNewLine
                    End If
                    If delivery_GET_reply = 200 Then Form13.text_txt.Text = Form13.text_txt.Text + "Delivery correct gevonden op floriday" + vbNewLine
                    If delivery_GET_reply > 200 Then
                        Form13.text_txt.Text = Form13.text_txt.Text + "Delivery niet gevonden op floriday:" + delivery_GET_error + vbNewLine
                    End If

                    Form13.text_txt.Text = Form13.text_txt.Text + vbNewLine

                    Form13.text_txt.Text = Form13.text_txt.Text + "Fulfillment aangemaakt: " + fulfillmentOrderId + vbNewLine
                    If fulfillment_POST_reply = 202 Then Form13.text_txt.Text = Form13.text_txt.Text + "fulfillment correct verzonden" + vbNewLine
                    If fulfillment_POST_reply > 202 Then
                        Form13.text_txt.Text = Form13.text_txt.Text + "Fulfillment niet correct verzonden:" + fulfillment_POST_error + vbNewLine
                    End If
                    Form13.text_txt.Text = Form13.text_txt.Text + "Fulfillment status : " + fulfillment_STATUS + vbNewLine + vbNewLine


                    Form13.text_txt.Text = Form13.text_txt.Text + vbNewLine
                    Form13.text_txt.Text = Form13.text_txt.Text + "VERWERKINGSLOG   Kar-id:" + Str(kar_id) + vbNewLine
                    Form13.text_txt.Text = Form13.text_txt.Text + vbNewLine

                    query = "SELECT * From floriday_taskrun_log WHERE Kar_Id=" + Str(kar_id) + " ORDER BY id"
                    cmd.CommandText = query
                    reader = cmd.ExecuteReader()
                    Do While reader.Read
                        Dim datum As DateTime = CHDate2(reader("datum"), Now)
                        Dim message As String = CHstr(reader("message"))
                        Form13.text_txt.Text = Form13.text_txt.Text + Format(datum, "dd-MM-yyyy HH:mm:ss") + " " + message + vbNewLine
                    Loop
                    reader.Close()


                    If fulfillmentOrderId <> "" Then
                        query = "SELECT * From floriday_fulfillmentorderssync_json WHERE fulfillmentOrderId='" + fulfillmentOrderId + "'"
                        cmd.CommandText = query
                        reader = cmd.ExecuteReader()
                        If reader.HasRows Then
                            reader.Read()

                            Form13.text_txt.Text = Form13.text_txt.Text + vbNewLine

                            Form13.text_txt.Text = Form13.text_txt.Text + vbNewLine

                            Dim json As String = CHstr(reader("json"))
                            Form13.text_txt.Text = Form13.text_txt.Text + json
                        End If
                        reader.Close()

                    End If
                Else
                    MsgBox("Kar_id niet gevonden")
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Fout: FD Error reporter " + ex.Message)
            MessageBox.Show("Fout: FD Error reporter" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try


        Form13.StartPosition = FormStartPosition.CenterScreen
        Form13.Show()


    End Sub


#End Region

#Region "Prijzen"

    Private Sub prijzen_nieuw_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles prijzen_nieuw_but.Click
        prijzen_id_lbl.Text = "0"
        prijzen_actief_check.Enabled = True
        prijzen_actief_check.Checked = True
        prijzen_naam_txt.Text = ""
        prijzen_naam_txt.Enabled = True
        prijzen_soort_combo.Enabled = True
        prijzen_algemeen_rb.Enabled = True
        prijzen_klantgroep_rb.Enabled = True
        prijzen_klant_rb.Enabled = True
        prijzen_kopergroep_combo.Enabled = True
        prijzen_kopergroep_combo.Text = "N.V.T."
        prijzen_koper_combo.Enabled = True
        prijzen_koper_combo.Text = "N.V.T."
        prijzen_accessoire_chk.Enabled = True
        prijzen_actiecode.Enabled = True

    End Sub
    Private Sub prijzen_koper_combo_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles prijzen_koper_combo.KeyPress
        prijzen_koper_combo.DroppedDown = True
        'If e.KeyChar = Chr(13) Then
        '    If Not prijzen_koper_combo.SelectedValue = Nothing Then
        '        prijzen_koper_combo.Tag = Str(prijzen_koper_combo.SelectedValue)
        '    End If
        'End If
    End Sub
    Private Sub Prijzen_opslaan_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Prijzen_opslaan_but.Click
        If prijzen_id_lbl.Text <> "-" Then
            Dim CmdString As String = "SELECT * FROM prijzen WHERE 1=0"
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    'Execute Query
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    With Cmd
                        Dim id As Integer = Val(prijzen_id_lbl.Text)
                        If id = 0 Then   'nieuwe prijssetting
                            .CommandText = "INSERT INTO prijzen(naam,soort,algemeen,klant,klantgroep,accessoire,actief,contact,telefoon,actie_type,actienummer) " _
                                            & "VALUES(?,?,?,?,?,?,?,?,?,?,?)"
                        Else   'veranderde prijssetting
                            .CommandText = "UPDATE prijzen SET naam=?,soort=?,algemeen=?,klant=?,klantgroep=?,accessoire=?, actief=?, contact =?, telefoon=?, actie_type=?, actienummer=? " _
                                            & "WHERE id = " + Str$(id)
                        End If

                        .Parameters.Clear()
                        .Parameters.AddWithValue("", prijzen_naam_txt.Text)
                        .Parameters.AddWithValue("", prijzen_soort_combo.SelectedValue)
                        If prijzen_algemeen_rb.Checked = True Then
                            .Parameters.AddWithValue("", 1)
                        Else
                            .Parameters.AddWithValue("", 0)
                        End If

                        If prijzen_klant_rb.Checked = True Then
                            If Not prijzen_koper_combo.SelectedValue = Nothing Then
                                If prijzen_koper_combo.SelectedValue = "000000000000" Then
                                    MsgBox("Onjuiste kopernaam")
                                    Exit Sub
                                End If
                                .Parameters.AddWithValue("", prijzen_koper_combo.SelectedValue)
                            Else
                                MsgBox("Onjuiste kopernaam")
                                Exit Sub
                            End If
                        Else
                            .Parameters.AddWithValue("", "0000000000000")
                        End If

                        If prijzen_klantgroep_rb.Checked = True Then
                            If Not prijzen_koper_combo.SelectedValue = Nothing Then
                                If prijzen_kopergroep_combo.SelectedValue = 0 Then
                                    MsgBox("Onjuiste groepskeuze")
                                    Exit Sub
                                End If
                                .Parameters.AddWithValue("", prijzen_kopergroep_combo.SelectedValue)
                            Else
                                MsgBox("Onjuiste groepskeuze")
                                Exit Sub
                            End If
                        Else
                            .Parameters.AddWithValue("", 0)
                        End If

                        If prijzen_accessoire_chk.Checked = True Then
                            .Parameters.AddWithValue("", 1)
                        Else
                            .Parameters.AddWithValue("", 0)
                        End If


                        If prijzen_actief_check.Checked = True Then
                            .Parameters.AddWithValue("", 1)
                        Else
                            .Parameters.AddWithValue("", 0)
                        End If
                        .Parameters.AddWithValue("", "")  'contact naam (not used here)
                        .Parameters.AddWithValue("", "")  'telefoon (not used here)
                        .Parameters.AddWithValue("", 0)  ' type (not used here)
                        .Parameters.AddWithValue("", Trim(Mid(prijzen_actiecode.Text, 1, 3)))

                        .ExecuteNonQuery()
                    End With
                    Load_prijzen_lijst()
                    MsgBox("Prijsinfo opgeslagen!", MsgBoxStyle.OkOnly)
                    prijzen_id_lbl.Text = "-"
                    prijzen_actief_check.Enabled = False
                    prijzen_naam_txt.Text = ""
                    prijzen_naam_txt.Enabled = False
                    prijzen_soort_combo.Text = "Algemeen"
                    prijzen_soort_combo.Enabled = False
                    prijzen_algemeen_rb.Enabled = False
                    prijzen_klantgroep_rb.Enabled = False
                    prijzen_klant_rb.Enabled = False
                    prijzen_kopergroep_combo.Enabled = False
                    prijzen_kopergroep_combo.Text = "N.V.T."
                    prijzen_koper_combo.Enabled = False
                    prijzen_koper_combo.Text = "N.V.T."
                    prijzen_accessoire_chk.Enabled = False
                    prijzen_actiecode.Enabled = False

                End Using
            Catch ex As Exception
                ErrorLog("Fout: prijzen opslaan " + ex.Message)
                MsgBox("Fout: prijzen opslaan " + ex.Message, MsgBoxStyle.OkOnly)
            End Try
        End If
        Set_Database_reload()
    End Sub
    Private Sub Load_prijzen_lijst()

        Dim cn() As String = New String() {"desc"}
        With Prijzen_flexgrid_soorten
            .Clear()
            .Cols.Count = 10
            .Rows.Count = 1

            .Cols(0).Caption = "Actief"
            .Cols(0).DataType = System.Type.GetType("System.Boolean")
            .Cols(0).Width = 40

            .Cols(1).Caption = "Prijs naam"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 100

            .Cols(2).Caption = "Soort"
            .Cols(2).DataType = System.Type.GetType("System.String")
            .Cols(2).Width = 100
            Dim mcd_prijzen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_soortmixprijzen, "ID", cn, 0)
            .Cols(2).DataMap = mcd_prijzen

            .Cols(3).Caption = "Prijs"
            .Cols(3).DataType = System.Type.GetType("System.Double")
            .Cols(3).Width = 70
            .Cols(3).Format = "C2"

            .Cols(4).Caption = "Algemeen"
            .Cols(4).DataType = System.Type.GetType("System.String")
            .Cols(4).Width = 90

            .Cols(5).Caption = "Koper"
            .Cols(5).DataType = System.Type.GetType("System.String")
            .Cols(5).Width = 100
            Dim mcd_kopers As New C1.Win.C1FlexGrid.MultiColumnDictionary(dtt_kopers, "ID", cn, 0)
            .Cols(5).DataMap = mcd_kopers

            .Cols(6).Caption = "Kopersgroep"
            .Cols(6).DataType = System.Type.GetType("System.String")
            .Cols(6).Width = 100
            Dim mcd_kopersgroepen As New C1.Win.C1FlexGrid.MultiColumnDictionary(dt_kopersgroepen, "ID", cn, 0)
            .Cols(6).DataMap = mcd_kopersgroepen

            .Cols(7).Caption = "id"  '(was 10) 
            .Cols(7).DataType = System.Type.GetType("System.Int32")
            .Cols(7).Width = 60
            .Cols(7).Visible = False

            .Cols(8).Caption = "Accessoire"
            .Cols(8).DataType = System.Type.GetType("System.Boolean")
            .Cols(8).Width = 60

            .Cols(9).Caption = "Eindklant code"
            .Cols(9).DataType = System.Type.GetType("System.String")
            .Cols(9).Width = 80

        End With

        Dim flexgridfill(11) As String
        Dim Reader As OdbcDataReader
        Dim cmdstring As String = "select * from prijzen order by algemeen DESC,klantgroep ASC,klant ASC"

        Try
            'Open Connection
            Prijzen_flexgrid_soorten.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CHstr(Reader("actief"))
                    flexgridfill(1) = CHstr(Reader("naam"))
                    flexgridfill(2) = CHstr(Reader("soort"))
                    flexgridfill(3) = fetchprijs(Reader("Id"), Now)
                    If Reader("Algemeen") = 0 Then
                        flexgridfill(4) = "N.V.T."
                    Else
                        flexgridfill(4) = "Algemeen"
                    End If
                    flexgridfill(5) = CHstr(Reader("Klant"))
                    flexgridfill(6) = CHstr(Reader("Klantgroep"))
                    flexgridfill(7) = CHstr(Reader("Id"))
                    flexgridfill(8) = CHstr(Reader("accessoire"))
                    flexgridfill(9) = CHstr(Reader("actienummer"))
                    Prijzen_flexgrid_soorten.AddItem(flexgridfill)

                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijslijst) " + ex.Message)
            MessageBox.Show("Database fout: (prijslijst) " + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub prijzen_verwijderen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles prijzen_verwijderen_but.Click
        Dim i As Integer
        Dim id As Integer


        For i = 1 To Prijzen_flexgrid_soorten.Rows.Count - 1
            If Prijzen_flexgrid_soorten.Rows(i).Selected = True Then
                id = Prijzen_flexgrid_soorten.Item(i, 7)
                If Val(id) > 1 Then
                    If MsgBox("Delete " + Prijzen_flexgrid_soorten.Item(i, 1) + "?", vbYesNo) = vbYes Then
                        Try
                            'Open Connection
                            Using Conn As New OdbcConnection(ConnString)
                                Conn.Open()

                                Dim CmdString As String = "DELETE FROM prijzen WHERE id = " + Str(id)
                                Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                                Cmd2.ExecuteNonQuery()
                                Load_prijzen_lijst()
                                prijzen_idsel_lbl.Text = 0
                                prijzen_toevoegendatum_but.Enabled = False
                                prijzen_verwijderdatum_but.Enabled = False
                                prijzen_datum_pick.Enabled = False
                                prijzen_prijs_txt.Enabled = False
                                Exit For
                            End Using
                        Catch ex As Exception
                            ErrorLog("Database fout: (prijzen_verwijderen)" + ex.Message)
                            MsgBox("Database fout: (prijzen_verwijderen)" + ex.Message, MsgBoxStyle.OkOnly)
                        End Try
                    End If
                End If
            End If
        Next i
    End Sub
    Private Sub prijzen_aanpassen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles prijzen_aanpassen_but.Click
        Dim i As Integer
        Dim dr As DataRow
        For i = 1 To Prijzen_flexgrid_soorten.Rows.Count - 1
            If Prijzen_flexgrid_soorten.Rows(i).Selected = True Then
                prijzen_id_lbl.Text = Prijzen_flexgrid_soorten.Item(i, 7)
                prijzen_actief_check.Enabled = True
                prijzen_actief_check.Checked = Prijzen_flexgrid_soorten.Item(i, 0)
                prijzen_accessoire_chk.Checked = Prijzen_flexgrid_soorten.Item(i, 8)
                prijzen_actiecode.Text = Prijzen_flexgrid_soorten.Item(i, 9)
                prijzen_naam_txt.Text = Prijzen_flexgrid_soorten.Item(i, 1)
                prijzen_naam_txt.Enabled = True
                prijzen_soort_combo.Enabled = True
                prijzen_accessoire_chk.Enabled = True
                prijzen_actiecode.Enabled = True

                For Each dr In dt_soortmixprijzen.Rows
                    If dr("ID") = Val(Prijzen_flexgrid_soorten.Item(i, 2)) Then
                        prijzen_soort_combo.Text = dr("desc")
                        Exit For
                    End If
                Next
                prijzen_algemeen_rb.Enabled = True
                prijzen_algemeen_rb.Checked = True
                prijzen_klantgroep_rb.Enabled = True
                prijzen_klant_rb.Enabled = True
                prijzen_kopergroep_combo.Enabled = True

                For Each dr In dt_kopersgroepen.Rows
                    If dr("ID") = Val(Prijzen_flexgrid_soorten.Item(i, 6)) Then
                        prijzen_kopergroep_combo.Text = dr("desc")
                        Exit For
                    End If
                Next
                If prijzen_kopergroep_combo.Text <> "N.V.T." Then
                    prijzen_klantgroep_rb.Checked = True
                End If
                prijzen_koper_combo.Enabled = True

                For Each dr In dt_kopers.Rows
                    If dr("ID") = Val(Prijzen_flexgrid_soorten.Item(i, 5)) Then
                        prijzen_koper_combo.Text = dr("desc")
                        Exit For
                    End If
                Next

                If prijzen_koper_combo.Text <> "_N.V.T." Then
                    prijzen_klant_rb.Checked = True
                End If

            End If
        Next i
    End Sub
    Private Sub prijzen_selecteer_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Dim i As Integer
        For i = 1 To Prijzen_flexgrid_soorten.Rows.Count - 1
            If Prijzen_flexgrid_soorten.Rows(i).Selected = True Then
                Dim id As Integer = Prijzen_flexgrid_soorten.Item(i, 7)
                prijzen_idsel_lbl.Text = id
                prijzen_toevoegendatum_but.Enabled = True
                prijzen_verwijderdatum_but.Enabled = True
                prijzen_datum_pick.Enabled = True
                prijzen_prijs_txt.Enabled = True

                prijzen_show_datelist(id)
                prijzen_show_graph(id)

            End If
        Next i
    End Sub
    Private Sub prijzen_toevoegendatum_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles prijzen_toevoegendatum_but.Click
        Dim CmdString As String = "SELECT * FROM prijzen_datumlijst WHERE 1=0"
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                With Cmd
                    Dim id As Integer = Val(prijzen_idsel_lbl.Text)
                    .CommandText = "INSERT INTO prijzen_datumlijst(id,datum,prijs)" _
                                    & "VALUES(?,?,?)"
                    .Parameters.Clear()
                    .Parameters.AddWithValue("", id)
                    .Parameters.AddWithValue("", Format(prijzen_datum_pick.Value, "yyyy-MM-dd"))

                    Dim prijsstring As String = prijzen_prijs_txt.Text
                    prijsstring = prijsstring.Replace(",", ".")
                    .Parameters.AddWithValue("", Val(prijsstring))

                    .ExecuteNonQuery()

                    prijzen_show_datelist(id)
                    prijzen_show_graph(id)
                    If prijzen_datum_pick.Value >= Now Then  'als de toegevoegde datum >= vandaag, dan status verlopen = false 
                        Dim CmdString2 As String = "SELECT * FROM prijzen WHERE 1=0"
                        Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                        With Cmd2
                            .CommandText = "UPDATE prijzen SET verlopen=0 WHERE id = " + Str(id)
                            .ExecuteNonQuery()
                        End With
                    End If
                End With
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijzen_toevoegendatum)" + ex.Message)
            MsgBox("Database fout: (prijzen_toevoegendatum)" + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        Set_Database_reload()
    End Sub
    Private Sub prijzen_show_datelist(ByVal id As Integer)
        prijzen_flexgrid_datums.Clear()
        prijzen_flexgrid_datums.Rows.Count = 1
        Dim jaar As String = Trim(Str(prijzen_jaar_updown.Value))
        Dim CmdString As String = "SELECT * FROM prijzen_datumlijst WHERE id=" + Str(id) + " AND datum>='" + jaar + "-01-01' AND datum<='" + jaar + "-12-31' ORDER BY datum ASC"
        Dim flexgridfill(2) As String
        With prijzen_flexgrid_datums
            .Cols(0).Caption = "Datum"
            .Cols(0).Width = 100
            .Cols(1).Caption = "Prijs"
            .Cols(1).Width = 100
        End With
        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    flexgridfill(0) = CType(Reader("datum"), Date)
                    flexgridfill(1) = Format(CHdouble(Reader("prijs")), "##.00")
                    prijzen_flexgrid_datums.AddItem(flexgridfill)
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijzen_show_datelist)" + ex.Message)
            MsgBox("Database fout: (prijzen_show_datelist)" + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub
    Private Sub prijzen_show_graph(ByVal id As Integer)
        Dim pen1 As New System.Drawing.Pen(Color.Black, 1)
        Dim g As System.Drawing.Graphics

        Dim xmax As Integer
        Dim ymax As Integer

        xmax = Prijzen_PictureBox.Width
        ymax = Prijzen_PictureBox.Height

        ' Prijzen_PictureBox.Image = Nothing

        Prijzen_PictureBox.Refresh()
        g = Prijzen_PictureBox.CreateGraphics
        pen1.Color = Color.Black
        g.DrawLine(pen1, 0, 0, xmax - 1, 0)
        g.DrawLine(pen1, 0, 0, 0, ymax - 1)
        g.DrawLine(pen1, xmax - 1, 0, xmax - 1, ymax - 1)
        g.DrawLine(pen1, 0, ymax - 1, xmax - 1, ymax - 1)


        'schaal strepen weeknrs 
        pen1.Color = Color.Gray
        Dim xcoor As Integer
        Dim i As Integer
        Dim drawpoint As System.Drawing.PointF
        Dim newfont As Font = New Font("Arial", 8)

        For i = 1 To 52
            xcoor = 20 + i * (xmax - 40) / 52
            g.DrawLine(pen1, xcoor, 20, xcoor, ymax - 21)
            drawpoint.X = xcoor - 18
            drawpoint.Y = 10
            If (i Mod 2) = 0 Then
                g.DrawString(Str(i), newfont, Brushes.Blue, drawpoint)
            End If
        Next i
        pen1.Color = Color.Black

        g.DrawLine(pen1, 20, 20, 20, ymax - 20)
        g.DrawLine(pen1, 20, ymax - 20, xmax - 20, ymax - 20)

        'data 
        Dim jaar As String = Trim(Str(prijzen_jaar_updown.Value))
        Dim CmdString As String = "SELECT * FROM prijzen_datumlijst WHERE id=" + Str(id) + " AND datum>='" + jaar + "-01-01' AND datum<='" + jaar + "-12-31' ORDER BY datum ASC"
        Dim Reader As OdbcDataReader
        Dim start_date As Date
        Dim end_date As Date
        Dim current_price As Double
        Dim new_price As Double
        Dim max_price As Double

        ' maximale prijs ophalen voor schaling
        start_date = jaar + "-01-01"
        max_price = start_price(id, jaar)
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    new_price = CHdouble(Reader("prijs"))
                    If new_price > max_price Then
                        max_price = new_price
                    End If
                Loop
                max_price = Int(max_price) + 1
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijzen_show_graf1) " + ex.Message)
            MsgBox("Database fout: (prijzen_show_graf1) " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        ' control op algemeen of koper(groep) specifieke prijs
        If check_algemeen(id) = True Then
            start_date = jaar + "-01-01"
            current_price = start_price(id, jaar)
        Else
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    'Execute Query
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        start_date = CType(Reader("datum"), Date)
                        current_price = CHdouble(Reader("prijs"))
                    End If
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (prijzen_show_graf2) " + ex.Message)
                MsgBox("Database fout: (prijzen_show_graf2) " + ex.Message, MsgBoxStyle.OkOnly)
            End Try
        End If

        ' draw graph
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()
                    end_date = CType(Reader("datum"), Date)
                    new_price = CHdouble(Reader("prijs"))
                    date_draw(start_date, end_date, current_price, max_price)
                    start_date = end_date
                    current_price = new_price
                Loop
                If check_algemeen(id) = True Then
                    end_date = jaar + "-12-31"
                    date_draw(start_date, end_date, current_price, max_price)
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (prijzen_show_graf3) " + ex.Message)
            MsgBox("Database fout: (prijzen_show_graf3) " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
    End Sub
    Private Function check_algemeen(ByVal id As Integer) As Boolean
        Dim check = False
        Dim jaar As String = Trim(Str(prijzen_jaar_updown.Value))
        Dim CmdString As String = "SELECT * FROM prijzen WHERE id=" + Str(id)
        Dim Reader As OdbcDataReader

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    If CHint(Reader("algemeen")) = 1 Then
                        check = True
                    Else
                        check = False
                    End If
                End If
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (check_algemeen) " + ex.Message)
            MsgBox("Database fout: (check_algemeen) " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        Return check
    End Function
    Private Function start_price(ByVal id As Integer, ByVal jaar As String) As Double
        Dim prijs As Double = 1.0
        Dim CmdString As String = "SELECT * FROM prijzen_datumlijst WHERE id=" + Str(id) + " AND datum<='" + jaar + "-01-01' ORDER BY datum DESC"
        Dim Reader As OdbcDataReader
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    prijs = CHdouble(Reader("prijs"))
                End If
            End Using
        Catch ex As Exception
            ErrorLog("fout: (startprijs) " + ex.Message)
            MsgBox("fout: (startprijs) " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        Return prijs
    End Function
    Private Sub date_draw(ByVal start_date As Date, ByVal end_date As Date, ByVal price As Double, ByVal maxprice As Integer)
        Dim pen1 As New System.Drawing.Pen(Color.Black, 1)
        Dim g As System.Drawing.Graphics

        Dim xmax As Integer
        Dim ymax As Integer
        Dim xscale As Double
        Dim yscale As Double

        Dim date1 As TimeSpan
        Dim date2 As TimeSpan
        Dim xpoint1 As Integer
        Dim xpoint2 As Integer
        Dim ypoint As Integer

        xmax = Prijzen_PictureBox.Width
        ymax = Prijzen_PictureBox.Height
        xscale = (xmax - 40) / 365
        yscale = (ymax - 40) / maxprice

        Dim start_of_year = Date.Parse("January 1, " + Trim(Str(prijzen_jaar_updown.Value)))

        date1 = start_date.Subtract(start_of_year)
        date2 = end_date.Subtract(start_of_year)
        xpoint1 = date1.Days * xscale
        xpoint2 = date2.Days * xscale

        ypoint = price * yscale

        g = Prijzen_PictureBox.CreateGraphics
        g.DrawLine(pen1, 20 + xpoint1, ymax - 20 - ypoint, 20 + xpoint2, ymax - 20 - ypoint)


        Dim drawpoint As System.Drawing.PointF
        Dim drawpoint2 As System.Drawing.PointF
        Dim newfont As Font = New Font("Arial", 8)
        drawpoint.X = 20 + xpoint1
        drawpoint.Y = ymax - 32 - ypoint
        drawpoint2.X = 20 + xpoint1
        drawpoint2.Y = ymax - 32
        g.DrawString(Format(price, "##.00"), newfont, Brushes.Blue, drawpoint)
        g.DrawString(Format(start_date, "dd-MM"), newfont, Brushes.Blue, drawpoint2)
    End Sub

    Private Sub copy_prijzen(ByVal datum As Date, ByVal prijs As Double)
        Dim target_id As Integer = Val(prijzen_idsel_lbl.Text)
        Dim CmdStringTarget As String = "SELECT * FROM prijzen_datumlijst WHERE id=" + Str(target_id)
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd_target As New OdbcCommand(CmdStringTarget, Conn)
                With Cmd_target
                    .CommandText = "INSERT INTO prijzen_datumlijst(id,datum,prijs)" _
                                    & "VALUES(?,?,?)"
                    .Parameters.Clear()
                    .Parameters.AddWithValue("", target_id)
                    .Parameters.AddWithValue("", datum)
                    .Parameters.AddWithValue("", prijs)
                    .ExecuteNonQuery()
                End With
            End Using
        Catch ex As Exception
            ErrorLog("fout copy_prijzen " + ex.Message)
            MsgBox("fout copy_prijzen " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        Set_Database_reload()
    End Sub
    Private Sub prijzen_verwijderdatum_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles prijzen_verwijderdatum_but.Click
        Dim i As Integer
        Dim datum As Date
        Dim prijs As Double
        For i = 1 To prijzen_flexgrid_datums.Rows.Count - 1
            If prijzen_flexgrid_datums.Rows(i).Selected = True Then
                Try
                    'Open Connection
                    Using Conn As New OdbcConnection(ConnString)
                        Conn.Open()
                        prijs = prijzen_flexgrid_datums.GetData(i, 1)
                        datum = prijzen_flexgrid_datums.GetData(i, 0)
                        Dim yyyyMMdd As String = datum.ToString("yyyy/MM/dd")
                        Dim id As Integer = Val(prijzen_idsel_lbl.Text)
                        Dim CmdString As String = "DELETE FROM prijzen_datumlijst WHERE id='" + Str(id) + "' AND prijs='" + Str(prijs) + "' AND datum='" + yyyyMMdd + "'"
                        Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                        Cmd2.ExecuteNonQuery()
                        prijzen_show_datelist(id)
                        prijzen_show_graph(id)
                        Exit For
                    End Using
                Catch ex As Exception
                    ErrorLog("fout  prijzen_verwijderdatum " + ex.Message)
                    MsgBox("fout  prijzen_verwijderdatum " + ex.Message, MsgBoxStyle.OkOnly)
                End Try
            End If
        Next i
        Set_Database_reload()
    End Sub
    Private Sub Prijzen_flexgrid_soorten_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Prijzen_flexgrid_soorten.Click
        For i = 1 To Prijzen_flexgrid_soorten.Rows.Count - 1
            If Prijzen_flexgrid_soorten.Rows(i).Selected = True Then
                prijzen_selecteer_but_Click(sender, e)
            End If
        Next
    End Sub
#End Region

#Region "Vervoer"

    Private Sub setup_vervoer_tab()

        Vervoer_Vervoerder_cmb.DataSource = New DataView(dt_vervoerder)
        Vervoer_Vervoerder_cmb.DisplayMember = "desc"
        Vervoer_Vervoerder_cmb.ValueMember = "ID"
        Vervoer_Vervoerder_cmb.DropDownStyle = ComboBoxStyle.DropDownList
        SetComboIndex(Vervoer_Vervoerder_cmb, 1)  'set de winter default
        vervoer_karrentotaal_lbl.Text = ""

        vervoer_omboek_afleverloc_cmb.DataSource = New DataView(dt_afleverloc)
        vervoer_omboek_afleverloc_cmb.DisplayMember = "desc"
        vervoer_omboek_afleverloc_cmb.ValueMember = "ID"
        vervoer_omboek_afleverloc_cmb.DropDownStyle = ComboBoxStyle.DropDownList
        SetComboIndex(vervoer_omboek_afleverloc_cmb, 1)  'set de winter default

        vervoer_omboek_vervoerder_cmb.DataSource = New DataView(dt_vervoerder)
        vervoer_omboek_vervoerder_cmb.DisplayMember = "desc"
        vervoer_omboek_vervoerder_cmb.ValueMember = "ID"
        vervoer_omboek_vervoerder_cmb.DropDownStyle = ComboBoxStyle.DropDownList
        SetComboIndex(vervoer_omboek_vervoerder_cmb, 1)  'set de winter default

        Overzicht_Soortgroep_cmb.DataSource = New DataView(dt_soortgroepen) 'set overzicht
        Overzicht_Soortgroep_cmb.DisplayMember = "desc"
        Overzicht_Soortgroep_cmb.ValueMember = "ID"
        Overzicht_Soortgroep_cmb.DropDownStyle = ComboBoxStyle.DropDownList
        SetComboIndex(Overzicht_Soortgroep_cmb, 1)
        SetComboIndex(Overzicht_TotaalNieuw_cmb, 1)
        SetComboIndex(Overzicht_klantspecifiek_cmb, 0)
    End Sub
    Private Sub Vervoer_OphalenBrieven_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Vervoer_OphalenBrieven_but.Click

        If jenptenhave = True Then
            OverzichtBrievenLadenJenP(False)
        Else
            OverzichtBrievenLaden(False)
        End If



    End Sub

    Private Sub Vervoer_OphalenSelectie_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Vervoer_OphalenSelectie_but.Click

        'find selected treeview item

        ' mark = 0 'geen mark
        ' mark = 1 'attentie mark
        ' mark = 2 'reservering

        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 2) = "ID" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 2) = "ID" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        'Exit For
                    End If
                Next node2
            End If
        Next Node

        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 2) = "ID" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub

        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""
        Dim orderheader_db As String = "OrderHeaders" + orderyear

        Dim id As Integer = 0
        Try
            ' Open(Connection)
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim cmdstring6 As String = ""
                Dim Cmd As New OdbcCommand(cmdstring6, Conn)
                For i = 1 To id_counter - 1
                    Cmd.CommandText = "UPDATE " + orderheader_db + " SET agenda_mark=3 WHERE header_id = " + Trim(Str(mark_idlist(i)))
                    Cmd.ExecuteNonQuery()
                Next

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag vervoerflag versturen: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        For i = 1 To id_counter - 1
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, mark_idlist(i))
        Next

        If jenptenhave = True Then
            OverzichtBrievenLadenJenP(True)
        Else
            OverzichtBrievenLaden(True)
        End If

    End Sub

    Private Sub OverzichtBrievenLadenJenP(ByVal selectie As Boolean)
        Dim aantal_denen As Integer = 0
        Dim aantal_vkar As Integer = 0

        ' ******* fetch start/end datum *****
        Dim Start_datum As Date
        Dim End_datum As Date
        Start_datum = Order_MonthCalendar.SelectionStart
        End_datum = Order_MonthCalendar.SelectionEnd
        If End_datum < Start_datum Then
            End_datum = Start_datum
        End If
        Dim Start_DatumStr As String = Start_datum.ToString("yyyy/MM/dd")
        Dim End_DatumStr As String = End_datum.ToString("yyyy/MM/dd")

        ' ************ build tree ************
        Vervoer_Treeview.BeginUpdate()
        Vervoer_Treeview.Nodes.Clear()

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' ********** create sql **************

                Dim orderyear As String = Trim(Str(Year(Start_datum)))
                If staticyear = True Then orderyear = ""

                Dim orderheader_db As String = "OrderHeaders" + orderyear
                Dim orderlines_db As String = "OrderLines" + orderyear
                Dim orderkarren_db As String = "OrderKarren" + orderyear

                Dim Reader As OdbcDataReader
                Dim cmdstring As String = ""

                '** Datum range
                If selectie = False Then
                    cmdstring = "SELECT * FROM " + orderheader_db + " where DATE(afleverdatum) >= '" + Start_DatumStr + "' AND DATE(afleverdatum) <= '" + End_DatumStr + "' "
                    cmdstring = cmdstring + "AND status > 39 AND status < 51 "
                Else
                    'alleen markering ophalen
                    cmdstring = "SELECT * FROM " + orderheader_db + " where DATE(afleverdatum) >= '" + Start_DatumStr + "' AND DATE(afleverdatum) <= '" + End_DatumStr + "' "
                    cmdstring = cmdstring + "AND status = 49 "
                End If
                '** sortering

                cmdstring = cmdstring + "ORDER BY vestiging,afleverloc,afleverdatum,invoerdatumtijd ASC"

                'Execute Query


                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()

                Dim cc_count As Integer = 0
                Dim dc_count As Integer = 0
                Dim fhkar_count As Integer = 0
                Dim vbakar_count As Integer = 0
                Dim oldafleverloc As Integer = 0
                Do While Reader.Read()

                    Dim afleverlocnr As Integer = CHint(Reader("afleverloc"))

                    Dim header_id As Integer = CHint(Reader("header_id"))
                    'Dim id_tag As String = "ID:" + Trim(Str(header_id))
                    Dim reservering As Integer = CHint(Reader("agenda_mark"))

                    '** titles

                    Dim sqldatum As Date = CType(Reader("afleverdatum"), Date)
                    Dim datum As String = sqldatum.ToShortDateString
                    Dim tijd As String = sqldatum.ToShortTimeString
                    'Dim xnode As TreeNode

                    '** koper
                    Dim kopernaam = CHstr(Reader("koper_naam"))
                    Dim opmerking = CHstr(Reader("opmerking"))
                    Dim koper_ean As String = CHstr(Reader("koper_ean"))

                    '** status    
                    ' 0-19 florecom nieuw
                    ' 20-39 nieuw
                    ' 30-39 wps
                    ' 40-48 sdf
                    ' 49-59 vervoer

                    Dim status = CHint(Reader("status"))


                    Dim icon_index As Integer = 18   'totaal vervoer


                    Dim invoertijd As Date = CType(Reader("invoerdatumtijd"), Date)
                    Dim verkoper As String = CHstr(Reader("inlog_naam"))
                    Dim afleverloc_id As Integer = CHint(Reader("afleverloc"))
                    Dim kar_id As Integer = CHint(Reader("kar_id"))
                    Dim koper_node As TreeNode

                    Dim skipline As Boolean = False

                    'If afleverloc_id = 7 Then skipline = True 'skip lines thuisleveren/
                    'If kar_id = 8 Then skipline = True ' skip karren met kar NVT

                    If afleverlocnr <> oldafleverloc Then
                        oldafleverloc = afleverlocnr
                        Dim aflever_node As TreeNode
                        Dim aflevernaam As String = ""
                        For i = 0 To UBound(afleverloc)
                            If afleverloc(i).id = afleverlocnr Then
                                aflevernaam = afleverloc(i).naam
                            End If
                        Next
                        aflever_node = New TreeNode("------------------------------ " + aflevernaam + " ------------------------------")
                        aflever_node.ImageIndex = icon_index
                        aflever_node.SelectedImageIndex = icon_index
                        aflever_node.Tag = "ID:0:0"
                        Vervoer_Treeview.Nodes.Add(aflever_node)
                    End If

                    If skipline = False Then
                        'gp & colli?
                        Dim gpcount As Integer = 1
                        Dim collicount As Integer = 0

                        Dim Reader3 As OdbcDataReader
                        Dim CmdString3 As String = "SELECT * FROM " + orderlines_db + " where OrderHeader_id = " + Str(header_id)
                        Dim Cmd3 As New OdbcCommand(CmdString3, Conn)
                        Reader3 = Cmd3.ExecuteReader()

                        Do While Reader3.Read()
                            gpcount = CHint(Reader3("GP"))
                            If gpcount > 1 Then
                                kopernaam = "GP: " + Trim(Str(gpcount)) + " x " + kopernaam
                            End If

                            If kar_id = 12 Then 'colli
                                collicount = collicount + CHint(Reader3("aantal"))
                            End If

                        Loop
                        Reader3.Close()

                        If collicount > 0 Then
                            kopernaam = "Colli: " + kopernaam
                        End If

                        If kar_id = 10 Or kar_id = 11 Then
                            kopernaam = "DV: " + kopernaam
                        End If

                        koper_node = New TreeNode(kopernaam)
                        koper_node.ImageIndex = icon_index
                        koper_node.SelectedImageIndex = icon_index


                        'karren
                        Dim count As Integer = 1
                        Dim Reader4 As OdbcDataReader
                        Dim CmdString4 As String = "SELECT * FROM " + orderkarren_db + " WHERE header_id =" + Str(header_id)
                        Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                        Reader4 = Cmd4.ExecuteReader()
                        Dim karrencount As Integer = 0
                        Dim karflag(100) As Integer
                        Dim karid(100) As Integer



                        If gpcount > 1 Then
                            karrencount = karrencount + 1
                            Reader4.Read()
                            Dim gpvervoer As Integer = CHint(Reader4("vervoer_flag"))
                            Dim gpkar As Integer = CHint(Reader4("kar_id"))
                            karflag(karrencount) = gpvervoer
                            karid(karrencount) = gpkar
                            For i = 2 To gpcount
                                karrencount = karrencount + 1
                                karflag(karrencount) = gpvervoer
                                karid(karrencount) = 0
                            Next
                        ElseIf collicount > 0 Then
                            karrencount = karrencount + 1
                            Reader4.Read()
                            Dim collivervoer As Integer = CHint(Reader4("vervoer_flag"))
                            Dim collikar As Integer = CHint(Reader4("kar_id"))
                            karflag(karrencount) = collivervoer
                            karid(karrencount) = collikar
                            For i = 2 To collicount
                                karrencount = karrencount + 1
                                karflag(karrencount) = collivervoer
                                karid(karrencount) = 0
                            Next

                        Else
                            'normale karrencount
                            Do While Reader4.Read
                                karrencount = karrencount + 1
                                karflag(karrencount) = CHint(Reader4("vervoer_flag"))
                                karid(karrencount) = CHint(Reader4("kar_id"))
                            Loop
                            Dim kardone As Boolean = True
                            For i = 1 To karrencount
                                If karflag(i) = 0 Then
                                    kardone = False
                                End If
                            Next
                            If kardone = True Then
                                koper_node.Checked = True
                            Else
                                koper_node.Checked = False
                            End If

                        End If

                        If Mid(koper_ean, 1, 12) = "900000000000" Then
                            karid(1) = -1
                        End If

                        koper_node.Tag = "ID:" + Trim(Str(header_id)) + ":" + Trim(Str(karid(1)))   'save ids   ID:headerid:karid
                        Vervoer_Treeview.Nodes.Add(koper_node)

                        If karrencount > 1 Then

                            For i = 1 To karrencount
                                Dim kar_node As New TreeNode()

                                kar_node.Text = "kar " + Str(i)

                                If kar_id = 10 Or kar_id = 11 Then
                                    If i = 1 Then
                                        kar_node.Text = "kar:" + Str(i)
                                    Else
                                        kar_node.Text = "cc:" + Str(i)
                                    End If
                                End If

                                If Mid(koper_node.Text, 1, 6) = "Colli:" Then
                                    kar_node.Text = "colli " + Str(i)
                                End If



                                Dim node_tagstart As String = "A:"
                                If Mid(koper_node.Text, 1, 3) = "GP:" Or Mid(koper_node.Text, 1, 6) = "Colli:" Or kar_id = 10 Or kar_id = 11 Then
                                    node_tagstart = "B:"
                                End If

                                If karflag(i) = 1 Then
                                    kar_node.Checked = True
                                    node_tagstart = "C:"
                                Else
                                    kar_node.Checked = False
                                End If


                                kar_node.Tag = node_tagstart + Trim(Str(karid(i)))
                                koper_node.Nodes.Add(kar_node)

                            Next
                        End If

                        If kar_id = 1 Or kar_id = 2 Then
                            cc_count = cc_count + karrencount
                        End If
                        If kar_id = 4 Or kar_id = 5 Then
                            dc_count = dc_count + karrencount
                        End If
                        If kar_id = 3 Then
                            fhkar_count = fhkar_count + karrencount
                        End If
                        If kar_id = 9 Then
                            vbakar_count = vbakar_count + karrencount
                        End If
                        If kar_id = 10 Then
                            cc_count = cc_count + karrencount - 1
                            fhkar_count = fhkar_count + 1
                        End If
                        If kar_id = 11 Then
                            cc_count = cc_count + karrencount - 1
                            vbakar_count = vbakar_count + 1
                        End If

                        Reader4.Close()
                    End If
                Loop

                ' toevoegen verzamelkarren

                ' ********** create sql **************

                Dim Reader10 As OdbcDataReader
                Dim cmdstring10 As String = ""

                '** Datum range
                If selectie = False Then
                    cmdstring10 = "SELECT * FROM " + orderheader_db + " where DATE(afleverdatum) >= '" + Start_DatumStr + "' AND DATE(afleverdatum) <= '" + End_DatumStr + "' "
                    cmdstring10 = cmdstring10 + "AND status = 55 "
                    cmdstring10 = cmdstring10 + "ORDER BY afleverdatum,invoerdatumtijd ASC"
                End If
                'status 55 = verzamelkar

                'Execute Query


                Dim Cmd10 As New OdbcCommand(cmdstring10, Conn)
                Reader10 = Cmd10.ExecuteReader()

                Do While Reader10.Read()

                    Dim header_id As Integer = CHint(Reader10("header_id"))
                    Dim reservering As Integer = CHint(Reader10("agenda_mark"))

                    '** titles

                    Dim sqldatum As Date = CType(Reader10("afleverdatum"), Date)
                    Dim datum As String = sqldatum.ToShortDateString
                    Dim tijd As String = sqldatum.ToShortTimeString
                    'Dim xnode As TreeNode

                    '** koper
                    Dim kopernaam = CHstr(Reader10("koper_naam"))
                    Dim opmerking = CHstr(Reader10("opmerking"))
                    Dim koper_ean As String = CHstr(Reader10("koper_ean"))

                    Dim status = CHint(Reader10("status"))
                    Dim icon_index As Integer = 18   'totaal vervoer

                    Dim invoertijd As Date = CType(Reader10("invoerdatumtijd"), Date)
                    Dim verkoper As String = CHstr(Reader10("inlog_naam"))
                    Dim afleverloc_id As Integer = CHint(Reader10("afleverloc"))
                    Dim kar_id As Integer = CHint(Reader10("kar_id"))
                    Dim koper_node As TreeNode

                    ' onderliggende karren ophalen en daarvan de vervoersflag/sdf flag checken
                    Dim cmdstring12 As String = "SELECT sdf_flag, vervoer_flag FROM orderkarren as ok LEFT JOIN orderheaders as oh ON ok.header_id=oh.header_id WHERE oh.aanvulling = " + Str(header_id)
                    Dim Cmd12 As New OdbcCommand(cmdstring12, Conn)
                    Dim Reader12 As OdbcDataReader
                    Reader12 = Cmd12.ExecuteReader()
                    Dim sdf_done As Boolean = True
                    Do While Reader12.Read
                        Dim sdf_flag As Boolean = CHbool(Reader12("sdf_flag"))
                        Dim vervoer_flag As Boolean = CHbool(Reader12("vervoer_flag"))
                        If sdf_flag = False Then
                            sdf_done = False
                        End If
                    Loop
                    Reader12.Close()

                    If sdf_done = True Then
                        koper_node = New TreeNode(kopernaam)
                        koper_node.ImageIndex = icon_index
                        koper_node.SelectedImageIndex = icon_index
                        koper_node.Tag = "ID:" + Trim(Str(header_id)) + ":-1"    'save ids   ID:headerid:karid   verzamelkar karid = -1
                        Vervoer_Treeview.Nodes.Add(koper_node)
                        ' onderliggende karren ophalen en laten zien

                        Dim cmdstring13 As String = "SELECT oh.koper_naam as koper_naam ,ok.kar_id as kar_id FROM orderkarren as ok LEFT JOIN orderheaders as oh ON ok.header_id=oh.header_id WHERE aanvulling = " + Str(header_id)
                        Dim Cmd13 As New OdbcCommand(cmdstring13, Conn)
                        Dim Reader13 As OdbcDataReader
                        Reader13 = Cmd13.ExecuteReader()
                        Do While Reader13.Read
                            Dim vkoper_naam As String = CHstr(Reader13("koper_naam"))
                            Dim vkar_id As Integer = CHint(Reader13("kar_id"))
                            Dim kar_node As New TreeNode()
                            kar_node.Tag = "V:" + Trim(Str(vkar_id))
                            kar_node.Text = vkoper_naam
                            koper_node.Nodes.Add(kar_node)
                        Loop
                        Reader13.Close()

                    End If

                    fhkar_count = fhkar_count + 1

                Loop

                Vervoer_Treeview.ExpandAll()
                vervoer_karrentotaal_lbl.Text = "Karren totaal: " + Trim(Str(cc_count)) + " Denen CC"
                If dc_count > 0 Then vervoer_karrentotaal_lbl.Text = vervoer_karrentotaal_lbl.Text + ", " + Trim(Str(dc_count)) + " Denen DC"
                vervoer_karrentotaal_lbl.Text = vervoer_karrentotaal_lbl.Text + ", " + Trim(Str(fhkar_count)) + " FH Kar"
                vervoer_karrentotaal_lbl.Text = vervoer_karrentotaal_lbl.Text + ", " + Trim(Str(vbakar_count)) + " VBA Kar"

            End Using
        Catch ex As Exception
            ErrorLog("Vervoer-Tree fout:" + ex.Message)
            MessageBox.Show("Vervoer-Tree fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Vervoer_Treeview.EndUpdate()


    End Sub


    Private Sub OverzichtBrievenLaden(ByVal selectie As Boolean)
        Dim aantal_denen As Integer = 0
        Dim aantal_vkar As Integer = 0

        ' ******* fetch start/end datum *****
        Dim Start_datum As Date
        Dim End_datum As Date
        Start_datum = Order_MonthCalendar.SelectionStart
        End_datum = Order_MonthCalendar.SelectionEnd
        If End_datum < Start_datum Then
            End_datum = Start_datum
        End If
        Dim Start_DatumStr As String = Start_datum.ToString("yyyy/MM/dd")
        Dim End_DatumStr As String = End_datum.ToString("yyyy/MM/dd")

        ' ************ build tree ************
        Vervoer_Treeview.BeginUpdate()
        Vervoer_Treeview.Nodes.Clear()

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                ' ********** create sql **************

                Dim orderyear As String = Trim(Str(Year(Start_datum)))
                If staticyear = True Then orderyear = ""

                Dim orderheader_db As String = "OrderHeaders" + orderyear
                Dim orderlines_db As String = "OrderLines" + orderyear
                Dim orderkarren_db As String = "OrderKarren" + orderyear

                Dim Reader As OdbcDataReader
                Dim cmdstring As String = ""

                '** Datum range
                If selectie = False Then
                    cmdstring = "SELECT * FROM " + orderheader_db + " where DATE(afleverdatum) >= '" + Start_DatumStr + "' AND DATE(afleverdatum) <= '" + End_DatumStr + "' "
                    cmdstring = cmdstring + "AND status > 39 AND status < 51 "
                Else
                    'alleen markering ophalen
                    cmdstring = "SELECT * FROM " + orderheader_db + " where DATE(afleverdatum) >= '" + Start_DatumStr + "' AND DATE(afleverdatum) <= '" + End_DatumStr + "' "
                    cmdstring = cmdstring + "AND status = 49 "
                End If
                '** sortering

                cmdstring = cmdstring + "ORDER BY afleverdatum,invoerdatumtijd ASC"

                'Execute Query


                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)
                Reader = Cmd2.ExecuteReader()

                Dim cc_count As Integer = 0
                Dim dc_count As Integer = 0
                Dim fhkar_count As Integer = 0
                Dim vbakar_count As Integer = 0

                Do While Reader.Read()

                    Dim header_id As Integer = CHint(Reader("header_id"))
                    'Dim id_tag As String = "ID:" + Trim(Str(header_id))
                    Dim reservering As Integer = CHint(Reader("agenda_mark"))

                    '** titles

                    Dim sqldatum As Date = CType(Reader("afleverdatum"), Date)
                    Dim datum As String = sqldatum.ToShortDateString
                    Dim tijd As String = sqldatum.ToShortTimeString
                    'Dim xnode As TreeNode

                    '** koper
                    Dim kopernaam = CHstr(Reader("koper_naam"))
                    Dim opmerking = CHstr(Reader("opmerking"))
                    Dim koper_ean As String = CHstr(Reader("koper_ean"))

                    '** status    
                    ' 0-19 florecom nieuw
                    ' 20-39 nieuw
                    ' 30-39 wps
                    ' 40-48 sdf
                    ' 49-59 vervoer

                    Dim status = CHint(Reader("status"))


                    Dim icon_index As Integer = 18   'totaal vervoer


                    Dim invoertijd As Date = CType(Reader("invoerdatumtijd"), Date)
                    Dim verkoper As String = CHstr(Reader("inlog_naam"))
                    Dim afleverloc_id As Integer = CHint(Reader("afleverloc"))
                    Dim kar_id As Integer = CHint(Reader("kar_id"))
                    Dim koper_node As TreeNode

                    Dim skipline As Boolean = False

                    If afleverloc_id = 7 Then skipline = True 'skip lines thuisleveren/
                    If kar_id = 8 Then skipline = True ' skip karren met kar NVT

                    If selectie = True And Mid(koper_ean, 1, 12) = "900000000000" Then
                        skipline = True
                    End If

                    If skipline = False Then
                        'gp & colli?
                        Dim gpcount As Integer = 1
                        Dim collicount As Integer = 0

                        Dim Reader3 As OdbcDataReader
                        Dim CmdString3 As String = "SELECT * FROM " + orderlines_db + " where OrderHeader_id = " + Str(header_id)
                        Dim Cmd3 As New OdbcCommand(CmdString3, Conn)
                        Reader3 = Cmd3.ExecuteReader()

                        Do While Reader3.Read()
                            gpcount = CHint(Reader3("GP"))
                            If gpcount > 1 Then
                                kopernaam = "GP: " + Trim(Str(gpcount)) + " x " + kopernaam
                            End If

                            If kar_id = 12 Then 'colli
                                collicount = collicount + CHint(Reader3("aantal"))
                            End If

                        Loop
                        Reader3.Close()

                        If collicount > 0 Then
                            kopernaam = "Colli: " + kopernaam
                        End If

                        If kar_id = 10 Or kar_id = 11 Then
                            kopernaam = "DV: " + kopernaam
                        End If

                        koper_node = New TreeNode(kopernaam)
                        koper_node.ImageIndex = icon_index
                        koper_node.SelectedImageIndex = icon_index


                        'karren
                        Dim count As Integer = 1
                        Dim Reader4 As OdbcDataReader
                        Dim CmdString4 As String = "SELECT * FROM " + orderkarren_db + " WHERE header_id =" + Str(header_id)
                        Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                        Reader4 = Cmd4.ExecuteReader()
                        Dim karrencount As Integer = 0
                        Dim karflag(100) As Integer
                        Dim karid(100) As Integer



                        If gpcount > 1 Then
                            karrencount = karrencount + 1
                            Reader4.Read()
                            Dim gpvervoer As Integer = CHint(Reader4("vervoer_flag"))
                            Dim gpkar As Integer = CHint(Reader4("kar_id"))
                            karflag(karrencount) = gpvervoer
                            karid(karrencount) = gpkar
                            For i = 2 To gpcount
                                karrencount = karrencount + 1
                                karflag(karrencount) = gpvervoer
                                karid(karrencount) = 0
                            Next
                        ElseIf collicount > 0 Then
                            karrencount = karrencount + 1
                            Reader4.Read()
                            Dim collivervoer As Integer = CHint(Reader4("vervoer_flag"))
                            Dim collikar As Integer = CHint(Reader4("kar_id"))
                            karflag(karrencount) = collivervoer
                            karid(karrencount) = collikar
                            For i = 2 To collicount
                                karrencount = karrencount + 1
                                karflag(karrencount) = collivervoer
                                karid(karrencount) = 0
                            Next

                        Else
                            'normale karrencount
                            Do While Reader4.Read
                                karrencount = karrencount + 1
                                karflag(karrencount) = CHint(Reader4("vervoer_flag"))
                                karid(karrencount) = CHint(Reader4("kar_id"))
                            Loop
                            Dim kardone As Boolean = True
                            For i = 1 To karrencount
                                If karflag(i) = 0 Then
                                    kardone = False
                                End If
                            Next
                            If kardone = True Then
                                koper_node.Checked = True
                            Else
                                koper_node.Checked = False
                            End If

                        End If

                        If Mid(koper_ean, 1, 12) = "900000000000" Then
                            karid(1) = -1
                        End If

                        koper_node.Tag = "ID:" + Trim(Str(header_id)) + ":" + Trim(Str(karid(1)))   'save ids   ID:headerid:karid
                        Vervoer_Treeview.Nodes.Add(koper_node)

                        If karrencount > 1 Then

                            For i = 1 To karrencount
                                Dim kar_node As New TreeNode()

                                kar_node.Text = "kar " + Str(i)

                                If kar_id = 10 Or kar_id = 11 Then
                                    If i = 1 Then
                                        kar_node.Text = "kar:" + Str(i)
                                    Else
                                        kar_node.Text = "cc:" + Str(i)
                                    End If
                                End If

                                If Mid(koper_node.Text, 1, 6) = "Colli:" Then
                                    kar_node.Text = "colli " + Str(i)
                                End If



                                Dim node_tagstart As String = "A:"
                                If Mid(koper_node.Text, 1, 3) = "GP:" Or Mid(koper_node.Text, 1, 6) = "Colli:" Or kar_id = 10 Or kar_id = 11 Then
                                    node_tagstart = "B:"
                                End If

                                If karflag(i) = 1 Then
                                    kar_node.Checked = True
                                    node_tagstart = "C:"
                                Else
                                    kar_node.Checked = False
                                End If


                                kar_node.Tag = node_tagstart + Trim(Str(karid(i)))
                                koper_node.Nodes.Add(kar_node)

                            Next
                        End If

                        If kar_id = 1 Or kar_id = 2 Then
                            cc_count = cc_count + karrencount
                        End If
                        If kar_id = 4 Or kar_id = 5 Then
                            dc_count = dc_count + karrencount
                        End If
                        If kar_id = 3 Then
                            fhkar_count = fhkar_count + karrencount
                        End If
                        If kar_id = 9 Then
                            vbakar_count = vbakar_count + karrencount
                        End If
                        If kar_id = 10 Then
                            cc_count = cc_count + karrencount - 1
                            fhkar_count = fhkar_count + 1
                        End If
                        If kar_id = 11 Then
                            cc_count = cc_count + karrencount - 1
                            vbakar_count = vbakar_count + 1
                        End If

                        Reader4.Close()
                    End If
                Loop

                ' toevoegen verzamelkarren

                ' ********** create sql **************

                Dim Reader10 As OdbcDataReader
                Dim cmdstring10 As String = ""

                '** Datum range
                If selectie = False Then
                    cmdstring10 = "SELECT * FROM " + orderheader_db + " where DATE(afleverdatum) >= '" + Start_DatumStr + "' AND DATE(afleverdatum) <= '" + End_DatumStr + "' "
                    cmdstring10 = cmdstring10 + "AND status = 55 "
                    cmdstring10 = cmdstring10 + "ORDER BY afleverdatum,invoerdatumtijd ASC"
                Else
                    cmdstring10 = "SELECT * FROM " + orderheader_db + " where DATE(afleverdatum) >= '" + Start_DatumStr + "' AND DATE(afleverdatum) <= '" + End_DatumStr + "' "
                    cmdstring10 = cmdstring10 + " AND status = 49 "
                    cmdstring10 = cmdstring10 + "ORDER BY afleverdatum,invoerdatumtijd ASC"
                End If
                ' status(55 = verzamelkar)

                'Execute Query


                Dim Cmd10 As New OdbcCommand(cmdstring10, Conn)
                Reader10 = Cmd10.ExecuteReader()

                Do While Reader10.Read()

                    Dim header_id As Integer = CHint(Reader10("header_id"))
                    Dim reservering As Integer = CHint(Reader10("agenda_mark"))

                    '** titles

                    Dim sqldatum As Date = CType(Reader10("afleverdatum"), Date)
                    Dim datum As String = sqldatum.ToShortDateString
                    Dim tijd As String = sqldatum.ToShortTimeString
                    'Dim xnode As TreeNode

                    '** koper
                    Dim kopernaam = CHstr(Reader10("koper_naam"))
                    Dim opmerking = CHstr(Reader10("opmerking"))
                    Dim koper_ean As String = CHstr(Reader10("koper_ean"))


                    If Mid(koper_ean, 1, 12) = "900000000000" Then
                        'yep verzamelkar

                        Dim status = CHint(Reader10("status"))
                        Dim icon_index As Integer = 18   'totaal vervoer

                        Dim invoertijd As Date = CType(Reader10("invoerdatumtijd"), Date)
                        Dim verkoper As String = CHstr(Reader10("inlog_naam"))
                        Dim afleverloc_id As Integer = CHint(Reader10("afleverloc"))
                        Dim kar_id As Integer = CHint(Reader10("kar_id"))
                        Dim koper_node As TreeNode

                        ' onderliggende karren ophalen en daarvan de vervoersflag/sdf flag checken
                        Dim cmdstring12 As String = "SELECT * FROM orderkarren as ok LEFT JOIN orderheaders as oh ON ok.header_id=oh.header_id WHERE oh.aanvulling = " + Str(header_id)
                        Dim Cmd12 As New OdbcCommand(cmdstring12, Conn)
                        Dim Reader12 As OdbcDataReader
                        Reader12 = Cmd12.ExecuteReader()
                        Dim sdf_done As Boolean = True
                        Do While Reader12.Read
                            Dim sdf_flag As Boolean = CHbool(Reader12("sdf_flag"))
                            Dim floriday_printflag As Integer = CHint(Reader12("floriday_printflag"))
                            Dim vervoer_flag As Boolean = CHbool(Reader12("vervoer_flag"))
                            If sdf_flag = False And floriday_printflag = 0 Then
                                sdf_done = False
                            End If
                        Loop
                        Reader12.Close()

                        If sdf_done = True Then
                            koper_node = New TreeNode(kopernaam)
                            koper_node.ImageIndex = icon_index
                            koper_node.SelectedImageIndex = icon_index
                            koper_node.Tag = "ID:" + Trim(Str(header_id)) + ":-1"    'save ids   ID:headerid:karid   verzamelkar karid = -1
                            Vervoer_Treeview.Nodes.Add(koper_node)
                            ' onderliggende karren ophalen en laten zien

                            Dim cmdstring13 As String = "SELECT oh.koper_naam as koper_naam ,ok.kar_id as kar_id FROM orderkarren as ok LEFT JOIN orderheaders as oh ON ok.header_id=oh.header_id WHERE aanvulling = " + Str(header_id)
                            Dim Cmd13 As New OdbcCommand(cmdstring13, Conn)
                            Dim Reader13 As OdbcDataReader
                            Reader13 = Cmd13.ExecuteReader()
                            Do While Reader13.Read
                                Dim vkoper_naam As String = CHstr(Reader13("koper_naam"))
                                Dim vkar_id As Integer = CHint(Reader13("kar_id"))
                                Dim kar_node As New TreeNode()
                                kar_node.Tag = "V:" + Trim(Str(vkar_id))
                                kar_node.Text = vkoper_naam
                                koper_node.Nodes.Add(kar_node)
                            Loop
                            Reader13.Close()

                        End If

                        fhkar_count = fhkar_count + 1
                    End If
                Loop

                Vervoer_Treeview.ExpandAll()
                vervoer_karrentotaal_lbl.Text = "Karren totaal: " + Trim(Str(cc_count)) + " Denen CC"
                If dc_count > 0 Then vervoer_karrentotaal_lbl.Text = vervoer_karrentotaal_lbl.Text + ", " + Trim(Str(dc_count)) + " Denen DC"
                vervoer_karrentotaal_lbl.Text = vervoer_karrentotaal_lbl.Text + ", " + Trim(Str(fhkar_count)) + " FH Kar"
                vervoer_karrentotaal_lbl.Text = vervoer_karrentotaal_lbl.Text + ", " + Trim(Str(vbakar_count)) + " VBA Kar"

            End Using
        Catch ex As Exception
            ErrorLog("Vervoer-Tree fout:" + ex.Message)
            MessageBox.Show("Vervoer-Tree fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Vervoer_Treeview.EndUpdate()


    End Sub
    Private Sub Vervoer_Treeview_AfterCheck(ByVal sender As System.Object, ByVal e As System.Windows.Forms.TreeViewEventArgs) Handles Vervoer_Treeview.AfterCheck

        Static system_checked As Boolean

        If system_checked = False Then
            'check all if parentnode is checked
            Dim bCheck As Boolean = e.Node.Checked

            If Mid(e.Node.Tag, 1, 3) = "ID:" Then   'parrent node?
                Dim id As String = Mid(e.Node.Tag, 4)
                Dim cNode As TreeNode
                Dim childcount As Integer = e.Node.GetNodeCount(True)
                If childcount > 1 Then
                    cNode = e.Node.FirstNode
                    system_checked = True
                    cNode.Checked = bCheck
                    system_checked = False
                    For i = 2 To childcount
                        cNode = cNode.NextNode
                        system_checked = True
                        cNode.Checked = bCheck
                        system_checked = False
                    Next
                End If
            End If


            'gp or colli - check all childnodes if one childnode is checked

            If Mid(e.Node.Tag, 1, 2) = "B:" Then   'special childnode?

                Dim cNode As TreeNode

                If (e.Node.Parent IsNot Nothing) Then
                    If (e.Node.Parent.GetType() Is GetType(TreeNode)) Then

                        Dim parent As TreeNode = e.Node.Parent
                        Dim childcount As Integer = parent.GetNodeCount(True)
                        If childcount > 1 Then
                            cNode = parent.FirstNode
                            system_checked = True
                            cNode.Checked = bCheck
                            system_checked = False
                            For i = 2 To childcount
                                cNode = cNode.NextNode
                                system_checked = True
                                cNode.Checked = bCheck
                                system_checked = False
                            Next
                        End If

                    End If
                Else

                End If



            End If

        End If
    End Sub
    Private Sub Vervoer_OverzichtPrint_but_OLD(ByVal sender As System.Object, ByVal e As System.EventArgs)

        C1PrintDocument1.Clear()

        Dim table As C1.C1Preview.RenderTable = New C1.C1Preview.RenderTable(Me.C1PrintDocument1)

        table.CellStyle.ImageAlign.StretchHorz = False
        table.CellStyle.ImageAlign.StretchVert = False
        table.CellStyle.ImageAlign.AlignHorz = C1.C1Preview.ImageAlignHorzEnum.Center

        Dim celltext1 As C1.C1Preview.RenderText = New C1.C1Preview.RenderText(Me.C1PrintDocument1)
        Dim celltext2 As C1.C1Preview.RenderText = New C1.C1Preview.RenderText(Me.C1PrintDocument1)

        Dim aNode As TreeNode
        Dim cNode As TreeNode
        Dim row As Integer = 0
        For Each aNode In Vervoer_Treeview.Nodes

            table.Cells.Item(row, 0).Text = "O"
            table.Cells.Item(row, 1).Text = aNode.Text
            row = row + 1
            Dim childcount As Integer = aNode.GetNodeCount(True)
            If childcount > 1 Then
                cNode = aNode.FirstNode
                table.Cells.Item(row, 0).Text = ""

                If Mid(aNode.Text, 1, 6) = "Colli:" Then
                    table.Cells.Item(row, 1).Text = "O   Colli 1"
                ElseIf Mid(cNode.Tag, 1, 1) = "V" Then
                    table.Cells.Item(row, 1).Text = "O   " + cNode.Text
                Else
                    If cNode.Checked = True Then
                        table.Cells.Item(row, 1).Text = "X   Kar 1"
                    Else
                        table.Cells.Item(row, 1).Text = "O   Kar 1"
                    End If

                End If

                row = row + 1
                For i = 2 To childcount
                    cNode = cNode.NextNode
                    table.Cells.Item(row, 0).Text = ""
                    If Mid(aNode.Text, 1, 6) = "Colli:" Then
                        table.Cells.Item(row, 1).Text = "O   Colli " + Trim(Str(i))
                    ElseIf Mid(cNode.Tag, 1, 1) = "V" Then
                        table.Cells.Item(row, 1).Text = "O   " + cNode.Text
                    Else
                        If cNode.Checked = True Then
                            table.Cells.Item(row, 1).Text = "X   Kar " + Trim(Str(i))
                        Else
                            table.Cells.Item(row, 1).Text = "O   Kar " + Trim(Str(i))
                        End If

                    End If

                    row = row + 1
                Next
            End If
        Next

        table.Style.FontSize = 16
        table.Style.LineSpacing = 120

        table.Cols(0).Width = New C1.C1Preview.Unit(1, C1.C1Preview.UnitTypeEnum.Cm)
        table.Cols(1).Width = New C1.C1Preview.Unit(16, C1.C1Preview.UnitTypeEnum.Cm)

        Me.C1PrintDocument1.Body.Children.Add(table)
        Me.C1PrintDocument1.Generate()
        'Me.C1PrintDocument1.Print()
        Me.C1PrintDocument1.PrintDialog()
    End Sub

    Private Sub Vervoer_OverzichtPrint_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Vervoer_OverzichtPrint_but.Click

        Dim htmltab As String = Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160)
        Dim html As String = ""

        html = html + "<table>"
        '        html = html + "<tr>"
        '    <td>Jill</td>
        '    <td>Smith</td>
        '    <td>50</td>
        '        html = html + "</tr>"




        Dim aNode As TreeNode
        Dim cNode As TreeNode
        Dim row As Integer = 0
        For Each aNode In Vervoer_Treeview.Nodes

            html = html + "<tr>"

            html = html + "<td>O" + htmltab + "</td>"
            'table.Cells.Item(row, 0).Text = "O"
            html = html + "<td>" + aNode.Text + "</td>"
            ' table.Cells.Item(row, 1).Text = aNode.Text
            html = html + "</tr>"
            'row = row + 1
            Dim childcount As Integer = aNode.GetNodeCount(True)
            If childcount > 1 Then
                cNode = aNode.FirstNode
                'table.Cells.Item(row, 0).Text = ""
                html = html + "<tr>"
                html = html + "<td></td>"
                If Mid(aNode.Text, 1, 6) = "Colli:" Then
                    html = html + "<td>O   Colli 1</td>"
                    'table.Cells.Item(row, 1).Text = "O   Colli 1"
                ElseIf Mid(cNode.Tag, 1, 1) = "V" Then
                    html = html + "<td>O" + htmltab + cNode.Text + "</td>"
                    'table.Cells.Item(row, 1).Text = "O   " + cNode.Text
                Else
                    If cNode.Checked = True Then
                        html = html + "<td>X" + htmltab + "Kar 1</td>"
                        'table.Cells.Item(row, 1).Text = "X   Kar 1"
                    Else
                        html = html + "<td>O" + htmltab + "Kar 1</td>"
                        'table.Cells.Item(row, 1).Text = "O   Kar 1"
                    End If

                End If
                html = html + "</tr>"
                row = row + 1
                For i = 2 To childcount
                    cNode = cNode.NextNode
                    html = html + "<tr>"
                    html = html + "<td></td>"
                    'table.Cells.Item(row, 0).Text = ""
                    If Mid(aNode.Text, 1, 6) = "Colli:" Then
                        html = html + "<td>O   Colli 1</td>"
                        'table.Cells.Item(row, 1).Text = "O   Colli " + Trim(Str(i))
                    ElseIf Mid(cNode.Tag, 1, 1) = "V" Then
                        html = html + "<td>O" + htmltab + cNode.Text + "</td>"
                        'table.Cells.Item(row, 1).Text = "O   " + cNode.Text
                    Else
                        If cNode.Checked = True Then
                            html = html + "<td>X" + htmltab + "Kar 1</td>"
                            'table.Cells.Item(row, 1).Text = "X   Kar " + Trim(Str(i))
                        Else
                            html = html + "<td>O" + htmltab + "Kar 1</td>"
                            'table.Cells.Item(row, 1).Text = "O   Kar " + Trim(Str(i))
                        End If

                    End If

                    html = html + "</tr>"
                Next
            End If
        Next

        html = html + "</table>"



        vervoerslog_form.WebBrowser1.Navigate("about:blank")
        If vervoerslog_form.WebBrowser1.Document IsNot Nothing Then
            vervoerslog_form.WebBrowser1.Document.Write(String.Empty)
        End If
        vervoerslog_form.WebBrowser1.DocumentText = html

        vervoerslog_form.StartPosition = FormStartPosition.CenterScreen
        vervoerslog_form.Show()
        Application.DoEvents()

        vervoerslog_form.WebBrowser1.ShowPrintDialog()

        'Me.Close()
    End Sub

    Private Sub Vervoer_OverzichtSelectAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Vervoer_OverzichtSelectAll.Click
        Dim aNode As TreeNode
        For Each aNode In Vervoer_Treeview.Nodes
            aNode.Checked = True
        Next
    End Sub
    Private Sub Vervoer_OverzichtDeSelectAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Vervoer_OverzichtDeSelectAll.Click
        Dim aNode As TreeNode
        For Each aNode In Vervoer_Treeview.Nodes
            aNode.Checked = False
        Next
    End Sub

    Public Sub vervoer_wordtopgehaald_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles vervoer_wordtopgehaald_but.Click
        Dim aNode As TreeNode
        Dim cnode As TreeNode
        For Each aNode In Vervoer_Treeview.Nodes
            Dim id As Integer = 0
            ' ID:Headerid:Karid
            Dim id_data() As String = Microsoft.VisualBasic.Strings.Split(aNode.Tag, ":")
            Dim header_id As Integer = Val(id_data(1))  'header id
            id = Val(id_data(2)) ' kar id

            If id > 0 Then
                Dim childcount As Integer = aNode.GetNodeCount(True)
                If childcount > 1 Then
                    cnode = aNode.FirstNode
                    Dim idchild_data() As String = Microsoft.VisualBasic.Strings.Split(cnode.Tag, ":")
                    id = Val(idchild_data(1))
                    'id = Val(cnode.Tag)
                    If cnode.Checked = True Then
                        SetVervoerFlag(1, id, 1)
                    Else
                        SetVervoerFlag(0, id, 1)
                    End If
                    For i = 2 To childcount
                        cnode = cnode.NextNode
                        Dim idchild2_data() As String = Microsoft.VisualBasic.Strings.Split(cnode.Tag, ":")
                        id = Val(idchild2_data(1))
                        'id = Val(cnode.Tag)
                        If cnode.Checked = True Then
                            SetVervoerFlag(1, id, i)
                        Else
                            SetVervoerFlag(0, id, i)
                        End If
                    Next
                Else
                    If aNode.Checked = True Then
                        SetVervoerFlag(1, id, 1)
                    Else
                        SetVervoerFlag(0, id, 1)
                    End If
                End If
                SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id, False)
            End If

        Next

        For Each aNode In Vervoer_Treeview.Nodes
            Dim id As Integer = 0
            ' ID:Headerid:Karid
            Dim id_data() As String = Microsoft.VisualBasic.Strings.Split(aNode.Tag, ":")
            Dim header_id As Integer = Val(id_data(1))  'header id
            SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id, False)
        Next

        Vervoer_Treeview.Nodes.Clear()
        vervoer_karrentotaal_lbl.Text = ""

        Set_Boek_reload()
        Update_Boek()

    End Sub

    Private Sub SetVervoerFlag(ByVal flag As Integer, ByVal kar_id As Integer, ByVal kar_nummer As Integer)
        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""
        Dim orderkarren_db As String = "OrderKarren" + orderyear
        If kar_id > 0 Then
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Dim CmdString4 As String = "SELECT * FROM " + orderkarren_db + " WHERE kar_id =" + Str(kar_id)
                    Dim Cmd4 As New OdbcCommand(CmdString4, Conn)
                    Cmd4.CommandText = "UPDATE " + orderkarren_db + " SET vervoer_flag=" + Trim(Str(flag)) + " WHERE kar_id =" + Str(kar_id)
                    Cmd4.ExecuteNonQuery()

                End Using
            Catch ex As Exception
                ErrorLog("Vervoer-SetFlag fout:" + ex.Message)
                MessageBox.Show("Vervoer-SetFlag fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        End If
    End Sub
    Private Sub Vervoer_VervoerderMail_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Vervoer_VervoerderMail_but.Click

        Mail_vervoerder_form.SetupMailGrid()

        Me.Cursor = Cursors.WaitCursor

        FormProgressBar.StartPosition = FormStartPosition.CenterScreen
        FormProgressBar.Show()
        Dim progressadd As Integer = 50 / Vervoer_Treeview.Nodes.Count

        FormProgressBar.DataProgressBar.Value = 0

        Dim aNode As TreeNode
        Dim cnode As TreeNode


        ' fill vervoer form
        Dim orderyear As String = Trim(Str(Year(Order_MonthCalendar.SelectionStart)))
        If staticyear = True Then orderyear = ""

        Dim orderheader_db As String = "OrderHeaders" + orderyear

        Dim node_checked As Boolean = False

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()


                For Each aNode In Vervoer_Treeview.Nodes

                    FormProgressBar.DataProgressBar.Value = FormProgressBar.DataProgressBar.Value + progressadd

                    Dim id As Integer = 0
                    Dim node_type As String = ""
                    ' ID:Headerid:Karid
                    Dim id_data() As String = Microsoft.VisualBasic.Strings.Split(aNode.Tag, ":")
                    Dim header_id As Integer = Val(id_data(1))  'header id
                    id = Val(id_data(2)) ' kar id

                    Dim setcount As Integer = 0
                    If Not id = 0 Then
                        Dim childcount As Integer = aNode.GetNodeCount(True)
                        If childcount > 1 Then
                            cnode = aNode.FirstNode

                            Dim idchild_data() As String = Microsoft.VisualBasic.Strings.Split(cnode.Tag, ":")
                            Dim idc As Integer = 0
                            idc = Val(idchild_data(1))
                            node_type = idchild_data(0)
                            If Not (node_type = "C") Then
                                If cnode.Checked = True Then
                                    SetVervoerFlag(1, idc, 1)
                                    setcount = setcount + 1
                                Else
                                    SetVervoerFlag(0, idc, 1)
                                End If
                            End If

                            For i = 2 To childcount
                                cnode = cnode.NextNode
                                Dim idchild2_data() As String = Microsoft.VisualBasic.Strings.Split(cnode.Tag, ":")
                                idc = Val(idchild2_data(1))
                                node_type = idchild2_data(0)
                                If Not (node_type = "C") Then
                                    If cnode.Checked = True Then
                                        SetVervoerFlag(1, idc, i)
                                        setcount = setcount + 1
                                    Else
                                        SetVervoerFlag(0, idc, i)
                                    End If
                                End If
                            Next
                            If id = -1 Then setcount = 1 'verzamelkarren is altijd 1 kar niet meerdere
                        Else
                            If id > 0 Then
                                If aNode.Checked = True Then
                                    SetVervoerFlag(1, id, 1)
                                    setcount = setcount + 1
                                Else
                                    SetVervoerFlag(0, id, 1)
                                End If
                            End If
                            If id = -1 Then setcount = 1 'verzamelkarren is altijd 1 kar niet meerdere
                        End If

                        If setcount > 0 Then
                            Dim bdo As Integer = 3
                            node_checked = True
                            Dim CmdString As String = "SELECT * FROM " + orderheader_db + " where Header_id = " + Str(header_id)
                            Dim Reader As OdbcDataReader
                            Dim Cmd As New OdbcCommand(CmdString, Conn)
                            Reader = Cmd.ExecuteReader()
                            Dim koper_ean As String = ""
                            Dim kartype As Integer = 0
                            Dim afleverloc_ean As String = ""
                            If Reader.HasRows Then
                                Reader.Read()
                                koper_ean = CHstr(Reader("koper_ean"))
                                kartype = CHint(Reader("kar_id"))
                                afleverloc_ean = CHstr(Reader("afleverloc_ean"))
                                bdo = CHint(Reader("afleverloc"))
                            End If
                            Reader.Close()

                            If Mid(koper_ean, 1, 12) = "900000000000" Then
                                OpslaanVerzamelkar(header_id)
                            End If

                            Dim admnr As String = ""
                            Dim opmerking As String = ""
                            Dim veiling As Integer = 0

                            Dim CmdString2 As String = "SELECT * FROM klanten where ean = '" + Trim(koper_ean) + "'"
                            Dim Reader2 As OdbcDataReader
                            Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                            Reader2 = Cmd2.ExecuteReader()
                            If Reader2.HasRows Then
                                Reader2.Read()
                                ' bdo = CHint(Reader2("bdo"))

                                'veiling uitzonderingen
                                If koper_ean = "0000000001002" Then bdo = 0 'bleiswijk -> nu naalwijk bloemistenklok
                                If koper_ean = "0000000001001" Then bdo = 1 'vba

                                veiling = CHint(Reader2("veiling_voorkeur"))
                                If veiling = 2 Then 'vba
                                    bdo = 1 'vba brief op vba leveren
                                    admnr = CHstr(Reader2("veilingnr_vba"))
                                    If admnr = 0 Then
                                        admnr = CHstr(Reader2("veilingnr_westland"))
                                    End If
                                Else
                                    admnr = CHstr(Reader2("veilingnr_westland"))
                                End If
                                opmerking = CHstr(Reader2("transport_opmerking1"))

                                'lemkes
                                If koper_ean = "8714231140016" Then
                                    If afleverloc_ean = "8713783218211" Then
                                        opmerking = "Hal 4 Dock 35-40"
                                    End If
                                    If afleverloc_ean = "8713783452776" Then
                                        opmerking = "Hal 4 Dock 45-48"
                                    End If
                                    If afleverloc_ean = "8713783250044" Then
                                        opmerking = "Hal 1 Dock 260-264"
                                    End If
                                    If afleverloc_ean = "8713783805275" Then
                                        opmerking = "Hal 5 Dock 268-278"
                                    End If
                                    If afleverloc_ean = "8713783805312" Then
                                        opmerking = "Hal 1 Dock 266-269"
                                    End If
                                    If afleverloc_ean = "8713783805619" Then
                                        opmerking = "Hal 2 Dock 25"
                                    End If
                                    If afleverloc_ean = "8713783899311" Then
                                        opmerking = "Hal 3 Dock 10-24"
                                    End If
                                    If afleverloc_ean = "8713783805411" Then
                                        opmerking = "Hal 1 Dock 255-257"
                                    End If
                                    If afleverloc_ean = "8713788038883" Then
                                        opmerking = "Hal 8 Dock 19-20"
                                    End If

                                End If

                            End If
                            Reader2.Close()

                            'search loop 

                            Dim addline As Boolean = True

                            If Mail_vervoerder_form.Vervoer_flexgrid.Rows.Count > 1 Then
                                For i = 1 To Mail_vervoerder_form.Vervoer_flexgrid.Rows.Count - 1
                                    If Mail_vervoerder_form.Vervoer_flexgrid.Item(i, 7) = koper_ean And Mail_vervoerder_form.Vervoer_flexgrid.Item(i, 1) = Tstr(kartype) And Mail_vervoerder_form.Vervoer_flexgrid.Item(i, 5) = Tstr(bdo) Then

                                        'add to old line
                                        Dim oldvalue As Integer = Val(Mail_vervoerder_form.Vervoer_flexgrid.Item(i, 0))
                                        Dim newvalue As Integer = oldvalue + setcount
                                        Mail_vervoerder_form.Vervoer_flexgrid.Item(i, 0) = Tstr(newvalue)
                                        If kartype = 3 Or kartype = 9 Then
                                            Mail_vervoerder_form.Vervoer_flexgrid.Item(i, 6) = Tstr(newvalue)
                                        End If

                                        addline = False

                                    End If

                                Next

                            End If

                            If addline = True Then
                                'add new line

                                If kartype = 10 Then
                                    'dv westland
                                    Dim flexgridfill(8) As String
                                    flexgridfill(0) = Tstr(1)

                                    flexgridfill(1) = Tstr(3) 'westlandkar
                                    flexgridfill(2) = koper_ean
                                    flexgridfill(3) = admnr
                                    flexgridfill(4) = opmerking
                                    flexgridfill(5) = Tstr(bdo)
                                    flexgridfill(6) = Tstr(1)
                                    flexgridfill(7) = koper_ean
                                    Mail_vervoerder_form.Vervoer_flexgrid.AddItem(flexgridfill)

                                    flexgridfill(0) = Tstr(setcount - 1)
                                    flexgridfill(1) = Tstr(2) '
                                    flexgridfill(2) = koper_ean
                                    flexgridfill(3) = admnr
                                    flexgridfill(4) = opmerking
                                    flexgridfill(5) = Tstr(bdo)
                                    flexgridfill(6) = ""
                                    flexgridfill(7) = koper_ean
                                    Mail_vervoerder_form.Vervoer_flexgrid.AddItem(flexgridfill)
                                ElseIf kartype = 11 Then
                                    'dv vba
                                    Dim flexgridfill(8) As String
                                    flexgridfill(0) = Str(1)

                                    flexgridfill(1) = Tstr(9) 'vbakar
                                    flexgridfill(2) = koper_ean
                                    flexgridfill(3) = admnr
                                    flexgridfill(4) = opmerking
                                    flexgridfill(5) = Tstr(bdo)
                                    flexgridfill(6) = Str(1)
                                    flexgridfill(7) = koper_ean
                                    Mail_vervoerder_form.Vervoer_flexgrid.AddItem(flexgridfill)

                                    flexgridfill(0) = Tstr(setcount - 1)
                                    flexgridfill(1) = Tstr(2) '
                                    flexgridfill(2) = koper_ean
                                    flexgridfill(3) = admnr
                                    flexgridfill(4) = opmerking
                                    flexgridfill(5) = Tstr(bdo)
                                    flexgridfill(6) = ""
                                    flexgridfill(7) = koper_ean
                                    Mail_vervoerder_form.Vervoer_flexgrid.AddItem(flexgridfill)
                                Else
                                    'normaal
                                    Dim flexgridfill(8) As String
                                    flexgridfill(0) = Tstr(setcount)

                                    flexgridfill(1) = Tstr(kartype)
                                    flexgridfill(2) = koper_ean
                                    flexgridfill(3) = admnr
                                    flexgridfill(4) = opmerking
                                    flexgridfill(5) = Tstr(bdo)
                                    If kartype = 3 Or kartype = 9 Then
                                        flexgridfill(6) = Tstr(setcount)
                                    Else
                                        flexgridfill(6) = ""
                                    End If
                                    flexgridfill(7) = koper_ean

                                    Mail_vervoerder_form.Vervoer_flexgrid.AddItem(flexgridfill)
                                End If


                            End If

                        End If
                    End If
                Next


                For Each aNode In Vervoer_Treeview.Nodes
                    If FormProgressBar.DataProgressBar.Value + progressadd < FormProgressBar.DataProgressBar.Maximum Then
                        FormProgressBar.DataProgressBar.Value = FormProgressBar.DataProgressBar.Value + progressadd
                    End If

                    Dim id As Integer = 0
                    ' ID:Headerid:Karid
                    Dim id_data() As String = Microsoft.VisualBasic.Strings.Split(aNode.Tag, ":")
                    Dim header_id As Integer = Val(id_data(1))  'header id

                    Dim CmdString As String = ""
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Cmd.CommandText = "UPDATE " + orderheader_db + " SET agenda_mark=3 WHERE header_id = " + Trim(Str(header_id))
                    Cmd.ExecuteNonQuery()

                    SetNewStatusFlag(Order_MonthCalendar.SelectionStart, header_id, False)

                Next


            End Using
        Catch ex As Exception
            MessageBox.Show("MailList fout:" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try



        FormProgressBar.Close()
        Me.Cursor = Cursors.Default

        If node_checked = True Then
            Vervoer_Treeview.Nodes.Clear()
            vervoer_karrentotaal_lbl.Text = ""

            Set_Boek_reload()
            Update_Boek()

            Mail_vervoerder_form.StartPosition = FormStartPosition.CenterScreen
            Mail_vervoerder_form.Show()
            Application.DoEvents()
        End If
    End Sub
    Private Sub Vervoer_MonthCalendar_DateChanged(ByVal sender As System.Object, ByVal e As System.Windows.Forms.DateRangeEventArgs) Handles Vervoer_MonthCalendar.DateChanged
        Dim datum As Date = Vervoer_MonthCalendar.SelectionStart
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Reader As OdbcDataReader


                Dim CmdString = "SELECT * FROM vervoer_logs where datum BETWEEN '" + Format(datum, "yyyy-MM-dd") + " 00:00:00' AND '" + Format(datum, "yyyy-MM-dd") + " 23:59:59'"
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Vervoer_Listbox.Items.Clear()
                Do While Reader.Read()
                    Dim logid As Integer = CHint(Reader("id"))
                    Dim logdatum As Date = CType(Reader("datum"), Date)
                    Dim vervoerder As String = CHstr(Reader("vervoerder"))
                    Dim vervoerlist As String = Trim(Str(logid)) + " : " + Format(logdatum, "dd-MM-yyyy HH:mm") + "  " + vervoerder
                    Vervoer_Listbox.Items.Add(vervoerlist)
                Loop

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (vervoer_logs)" + ex.Message)
            MessageBox.Show("Database fout: (vervoer_logs)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Private Sub Vervoer_Listbox_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Vervoer_Listbox.SelectedIndexChanged

        Dim curItem As String = Vervoer_Listbox.SelectedItem.ToString()
        Dim splitup() As String = Microsoft.VisualBasic.Strings.Split(curItem, ":")
        Dim id As Integer = Val(Trim(splitup(0)))
        If id > 0 Then
            Dim html As String = ""
            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim Reader As OdbcDataReader

                    Dim CmdString = "SELECT * FROM vervoer_logs where id =" + Str(id)
                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        html = CHstr(Reader("html"))
                    End If

                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (vervoer_logsshow)" + ex.Message)
                MessageBox.Show("Database fout: (vervoer_logsshow)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

            vervoerslog_form.WebBrowser1.Navigate("about:blank")
            If vervoerslog_form.WebBrowser1.Document IsNot Nothing Then
                vervoerslog_form.WebBrowser1.Document.Write(String.Empty)
            End If
            vervoerslog_form.WebBrowser1.DocumentText = html

            vervoerslog_form.StartPosition = FormStartPosition.CenterScreen
            vervoerslog_form.Show()
            Application.DoEvents()


        End If
    End Sub

    Private Function MakeHTML(ByVal header_id As Integer) As String
        Dim s0 As String
        Dim s1 As String

        Dim html As String = ""

        Dim htmltab As String

        htmltab = Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160) + Chr(160)

        'Dim html As String = ""
        html = html + "<html>" + vbCrLf
        html = html + "Overzicht verzamelkar<br>" + vbCrLf

        html = html + "<br>" + vbCrLf
        html = html + "<TABLE BORDER>" + vbCrLf
        html = html + "<TR><TH>Aantal Colli</TH> <TH>Koper</TH>" + vbCrLf

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'read time 

                Dim CmdHeaderString As String = "select SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.aanvulling = " + Str(header_id) + " GROUP BY ol.koper_naam"
                Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmdr.ExecuteReader()
                Dim afleverdatum As Date = Now
                Do While Reader.Read()
                    s0 = CHstr(Reader("taantal"))
                    s1 = CHstr(Reader("koper_naam"))

                    Dim koper_ean As String = CHstr(Reader("koper_ean"))
                    Dim admnr As String = ""
                    Dim opmerking As String = ""
                    Dim veiling As Integer = 0
                    Dim bdo As Integer = 3
                    Dim CmdString2 As String = "SELECT * FROM klanten where ean = '" + koper_ean + "'"
                    Dim Reader2 As OdbcDataReader
                    Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        Reader2.Read()
                        bdo = CHint(Reader2("bdo"))

                        veiling = CHint(Reader2("veiling_voorkeur"))
                        If veiling = 2 Then 'vba
                            bdo = 1 'vba brief op vba leveren
                            admnr = CHstr(Reader2("veilingnr_vba"))
                            If admnr = 0 Then
                                admnr = CHstr(Reader2("veilingnr_westland"))
                            End If
                        Else
                            admnr = CHstr(Reader2("veilingnr_westland"))
                        End If
                    End If


                    html = html + " <TR>" + vbCrLf
                    html = html + " <TD align=center>" + s0 + "</TD> <TD align=center>" + s1 + "</TD> <TD align=center>" + admnr + "</TD>" + vbCrLf
                    html = html + " </TR>" + vbCrLf
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Fout opslaan verzamelkar: " + ex.Message)
            MsgBox("Fout opslaan verzamelkar: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        html = html + "</TABLE> <br><br>" + vbCrLf
        html = html + "<br>" + vbCrLf
        html = html + "Overzicht gemaakt op: " + Now + "<br>" + vbCrLf
        html = html + "</html>" + vbCrLf

        Return html
    End Function
    Private Sub OpslaanVerzamelkar(ByVal header_id As Integer)

        Dim html As String = MakeHTML(header_id)

        'make logs
        If Len(html) >= 19999 Then
            html = Mid(html, 1, 19999)
        End If
        Dim cmdstring As String = ""

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand(cmdstring, Conn)
                Cmd.CommandText = "INSERT INTO vervoer_logs(datum,html,vervoerder) VALUES(?,?,?)"
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                Cmd.Parameters.AddWithValue("", html)
                Cmd.Parameters.AddWithValue("", "Verzamelkar")
                Cmd.ExecuteNonQuery()

            End Using
        Catch ex As Exception
            MsgBox("Fout vervoerlog: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

    End Sub
    Private Sub MaakDecorumFijnDistributieA4_OUD(ByVal header_id As Integer)
        Dim html As String = ""

        html = html + "<html>" + vbCrLf
        html = html + "<head><style>"
        html = html + "h1 { font-size:350%; }"
        html = html + "</head></style>"

        html = html + "<br><br><br><br><br><br><br><br><br><br>" + vbCrLf
        html = html + "<center><H1>Decorum Fijndistributie</H1><br>" + vbCrLf
        html = html + "<H1>De Winter</H1><br>"
        Dim verzamelkar_ean As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'read time 

                Dim CmdString As String = "select koper_ean FROM  orderheaders where header_id=" + Str(header_id)
                Dim Cmd5 As New OdbcCommand(CmdString, Conn)
                Dim reader5 As OdbcDataReader
                reader5 = Cmd5.ExecuteReader()
                If reader5.HasRows Then
                    verzamelkar_ean = CHstr(reader5("koper_ean"))
                End If
                '9000000000000  = westland 12:00
                '90000000000001 = westland 12:00
                '90000000000002 = westland 17:00
                '90000000000003 = VBA 9:00
                '90000000000004 = VBA 17:00
                '90000000000005 = plantion

                If verzamelkar_ean = "9000000000000" Or verzamelkar_ean = "90000000000001" Or verzamelkar_ean = "90000000000002" Then
                    html = html + "<H1><B><U>Box Naaldwijk</U></B></H1><br><br>" 'westland
                Else
                    html = html + "<H1><B><U>Box VBA</U></B></H1><br><br>" 'vba
                End If
                If verzamelkar_ean = "9000000000000" Or verzamelkar_ean = "90000000000001" Or verzamelkar_ean = "90000000000003" Then
                    html = html + "<H1>Afleverronde 2</H1><br><br></center>" + vbCrLf 'afleverronde 2
                Else
                    html = html + "<H1>Afleverronde 1</H1><br><br></center>" + vbCrLf 'afleverronde 1
                End If
                If jenptenhave = True Then
                    html = html + "<h3>J&P. ten Have &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Tel:0174-518909</h3>" + vbCrLf
                Else
                    html = html + "<h3>Gebr. ten Have &nbsp;&nbsp;&nbsp; Adm.nr:2086 &nbsp;&nbsp;&nbsp; Tel:0174-627079</h3>" + vbCrLf
                End If

                html = html + "<table border='1'>"
                html = html + "<tr><th>Aantal fust</th><th>Kopernaam</th><th>Admnr.</th></tr>"


                Dim CmdHeaderString As String = "select SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.status<99 and oh.aanvulling = " + Str(header_id) + " GROUP BY ol.koper_naam"
                If TreeviewVestiging = 1 Then
                    CmdHeaderString = "select SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.vestiging = 1 AND oh.status<99 AND oh.aanvulling = " + Str(header_id) + " GROUP BY ol.koper_naam"
                End If

                If TreeviewVestiging = 2 Then
                    CmdHeaderString = "select SUM(ol.aantal) as taantal, ol.koper_naam, oh.koper_ean FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.vestiging = 2 AND oh.status<99 AND oh.aanvulling = " + Str(header_id) + " GROUP BY ol.koper_naam"
                End If

                Dim Cmdr As New OdbcCommand(CmdHeaderString, Conn)
                Dim Reader As OdbcDataReader
                Reader = Cmdr.ExecuteReader()
                Dim afleverdatum As Date = Now
                Do While Reader.Read()
                    Dim aantal As Integer = CHint(Reader("taantal"))
                    Dim koper_naam As String = CHstr(Reader("koper_naam"))
                    Dim koper_ean As String = CHstr(Reader("koper_ean"))
                    Dim admnr As String = ""
                    Dim opmerking As String = ""
                    Dim veiling As Integer = 0
                    Dim bdo As Integer = 3
                    Dim CmdString2 As String = "SELECT * FROM klanten where ean = '" + koper_ean + "'"
                    Dim Reader2 As OdbcDataReader
                    Dim Cmd2 As New OdbcCommand(CmdString2, Conn)
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        Reader2.Read()
                        bdo = CHint(Reader2("bdo"))

                        veiling = CHint(Reader2("veiling_voorkeur"))
                        If veiling = 2 Then 'vba
                            bdo = 1 'vba brief op vba leveren
                            admnr = CHstr(Reader2("veilingnr_vba"))
                            If admnr = 0 Then
                                admnr = CHstr(Reader2("veilingnr_westland"))
                            End If
                        Else
                            admnr = CHstr(Reader2("veilingnr_westland"))
                        End If
                    End If
                    html = html + "<tr><td>" + Str(aantal) + "</td><td>" + koper_naam + "</td><td>" + admnr + "</td></tr>"
                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Fout opslaan verzamelkar: " + ex.Message)
            MsgBox("Fout opslaan verzamelkar: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try
        html = html + "</table>"
        html = html + "</html>"
        If verzamelkar_ean = "90000000000005" Then
            'geen a4 voor plantion
        Else


            vervoerslog_form.WebBrowser1.Navigate("about:blank")
            If vervoerslog_form.WebBrowser1.Document IsNot Nothing Then
                vervoerslog_form.WebBrowser1.Document.Write(String.Empty)
            End If
            vervoerslog_form.WebBrowser1.DocumentText = html

            vervoerslog_form.StartPosition = FormStartPosition.CenterScreen
            vervoerslog_form.Show()
            Application.DoEvents()
            System.Threading.Thread.Sleep(500)

            If Inst_printerselect_chk.Checked = True Then
                vervoerslog_form.WebBrowser1.ShowPrintDialog()
            Else
                vervoerslog_form.WebBrowser1.Print()
            End If

        End If

    End Sub


    Private Sub vervoer_afleverloc_order_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles vervoer_afleverloc_order_but.Click
        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If
        Next Node


        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub

        Dim id As Integer = 0
        Try
            ' Open(Connection)
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For i = 1 To id_counter - 1

                    Dim newafleverloc As Integer = vervoer_omboek_afleverloc_cmb.SelectedIndex
                    Dim header_id As Integer = mark_idlist(i)

                    Dim Cmd2 As New OdbcCommand("UPDATE orderheaders SET afleverloc=? WHERE header_id = ?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", newafleverloc)
                    Cmd2.Parameters.AddWithValue("", header_id)
                    Cmd2.ExecuteNonQuery()

                Next

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag omboeken afleverloc: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        Update_Boek()

    End Sub

    Private Sub vervoer_afleverloc_klant_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles vervoer_afleverloc_klant_but.Click
        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If
        Next Node


        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub

        Dim id As Integer = 0
        Try
            ' Open(Connection)
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For i = 1 To id_counter - 1

                    Dim koper_ean As String = ""
                    Dim header_id As Integer = mark_idlist(i)
                    Dim Cmd As New OdbcCommand("select koper_ean from orderheaders WHERE Header_id = ?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", header_id)
                    Dim reader As OdbcDataReader
                    reader = Cmd.ExecuteReader()
                    Dim mark As Integer = 0
                    If reader.HasRows Then
                        reader.Read()
                        koper_ean = CHstr(reader("koper_ean"))
                    End If
                    reader.Close()

                    Dim newafleverloc As Integer = vervoer_omboek_afleverloc_cmb.SelectedIndex
                    Dim Cmd2 As New OdbcCommand("UPDATE klanten SET bdo=? WHERE ean = ?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", newafleverloc)
                    Cmd2.Parameters.AddWithValue("", koper_ean)
                    Cmd2.ExecuteNonQuery()


                Next

                Dim Cmd5 As New OdbcCommand("UPDATE instellingen SET Koper_Reload = true", Conn)
                Cmd5.ExecuteNonQuery()

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag omboeken afleverloc koper: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try



    End Sub

    Private Sub vervoer_vervoerder_order_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles vervoer_vervoerder_order_but.Click
        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If
        Next Node


        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub

        Dim id As Integer = 0
        Try
            ' Open(Connection)
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For i = 1 To id_counter - 1

                    Dim newvervoerder As Integer = vervoer_omboek_vervoerder_cmb.SelectedIndex
                    Dim header_id As Integer = mark_idlist(i)

                    Dim Cmd2 As New OdbcCommand("UPDATE orderheaders SET vervoerder_id=? WHERE header_id = ?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", newvervoerder)
                    Cmd2.Parameters.AddWithValue("", header_id)
                    Cmd2.ExecuteNonQuery()

                Next

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag omboeken afleverloc: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        Update_Boek()

    End Sub

    Private Sub vervoer_vervoerder_klant_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles vervoer_vervoerder_klant_but.Click
        Dim mark_idlist(101) As Integer
        Dim id_counter As Integer = 1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(Node.Tag, 4))
                id_counter = id_counter + 1
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        mark_idlist(id_counter) = Val(Mid(node2.Tag, 4))
                        id_counter = id_counter + 1
                        Exit For
                    End If
                Next node2
            End If
        Next Node


        If id_counter = 1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                mark_idlist(id_counter) = Val(Mid(TreeView1.SelectedNode.Tag, 4))
                id_counter = id_counter + 1
            End If
        End If

        If id_counter = 1 Then Exit Sub

        Dim id As Integer = 0
        Try
            ' Open(Connection)
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For i = 1 To id_counter - 1

                    Dim koper_ean As String = ""
                    Dim header_id As Integer = mark_idlist(i)
                    Dim Cmd As New OdbcCommand("select koper_ean from orderheaders WHERE Header_id = ?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", header_id)
                    Dim reader As OdbcDataReader
                    reader = Cmd.ExecuteReader()
                    Dim mark As Integer = 0
                    If reader.HasRows Then
                        reader.Read()
                        koper_ean = CHstr(reader("koper_ean"))
                    End If
                    reader.Close()

                    Dim newvervoerder As Integer = vervoer_omboek_vervoerder_cmb.SelectedIndex
                    Dim Cmd2 As New OdbcCommand("UPDATE klanten SET vervoerder=? WHERE ean = ?", Conn)
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", newvervoerder)
                    Cmd2.Parameters.AddWithValue("", koper_ean)
                    Cmd2.ExecuteNonQuery()

                Next

                Dim Cmd5 As New OdbcCommand("UPDATE instellingen SET Koper_Reload = true", Conn)
                Cmd5.ExecuteNonQuery()

            End Using
        Catch ex As Exception
            MsgBox("Fout opslag omboeken afleverloc koper: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try



    End Sub



#End Region

#Region "Wps filters"


    Private Sub WpsFilter_Scrollbar_Scroll(ByVal sender As System.Object, ByVal e As System.Windows.Forms.ScrollEventArgs) Handles WpsFilter_Scrollbar.Scroll
        Dim scrollnummer As Integer = WpsFilter_Scrollbar.Value
        If scrollnummer >= 0 And scrollnummer <= 50 Then
            Fill_WpsFilterListboxes(scrollnummer, True)
        End If
    End Sub
    Private Sub WpsFilter_koperIndelingOphalen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_koperIndelingOphalen_but.Click

        Laad_Namen_filterindelingen()

        Dim i As Integer
        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("klanten")
        Dim CmdString As String = "SELECT klantnaam, ean, wps_indeling,actief FROM klanten ORDER BY klantnaam"
        ReDim klantlist(count, 50)
        For i = 1 To 50
            listcounter(i) = 0
        Next
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim ean As String
                Dim naam As String
                Dim indeling As Integer
                Dim actief As Boolean
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()

                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        ean = CHstr(Reader("ean"))
                        naam = CHstr(Reader("klantnaam"))
                        actief = CHbool(Reader("actief"))
                        indeling = CHint(Reader("wps_indeling"))
                        If actief = True Then
                            klantlist(listcounter(indeling), indeling).naam = naam
                            klantlist(listcounter(indeling), indeling).ean = ean
                            klantlist(listcounter(indeling), indeling).checked = False
                            listcounter(indeling) = listcounter(indeling) + 1
                        End If
                    Next i
                End If
                Reader.Close()

                Fill_WpsFilterListboxes(1, False)


            End Using
            WpsFilter_Add1_but.Enabled = True
            WpsFilter_Add2_but.Enabled = True
            WpsFilter_Add3_but.Enabled = True
            WpsFilter_Add4_but.Enabled = True
            WpsFilter_Add5_but.Enabled = True
            WpsFilter_Instel1_but.Enabled = True
            WpsFilter_Instel2_but.Enabled = True
            WpsFilter_Instel3_but.Enabled = True
            WpsFilter_Instel4_but.Enabled = True
            WpsFilter_Instel5_but.Enabled = True
            WpsFilter_Scrollbar.Enabled = True

        Catch ex As Exception
            ErrorLog("Database fout: (kopersladen wps filters)" + ex.Message)
            MessageBox.Show("Database fout: (koperladen wps filters)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub Laad_Namen_filterindelingen()

        Dim Reader As OdbcDataReader

        Dim CmdString As String = "SELECT * FROM wps_groepnaam ORDER BY id"

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Dim groep As Integer
                Dim naam As String
                Do While Reader.Read
                    groep = CHint(Reader("id"))
                    naam = CHstr(Reader("naam"))
                    wpsgroepnamen(groep) = naam
                Loop

                Reader.Close()
            End Using

        Catch ex As Exception
            ErrorLog("Database fout: (groepnamen laden)" + ex.Message)
            MessageBox.Show("Database fout: groepnamen laden)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub Fill_WpsFilterListboxes(ByVal startbox As Integer, ByVal savechecks As Boolean)

        If savechecks = True Then
            'save checked state
            Dim old_startbox As Integer = Val(WpsFilter_Add1_but.Tag)

            For i = 0 To WpsFilter_ChkList1_lst.Items.Count - 1
                If WpsFilter_ChkList1_lst.GetItemChecked(i) = True Then
                    klantlist(i, old_startbox).checked = True
                Else
                    klantlist(i, old_startbox).checked = False
                End If
            Next
            For i = 0 To WpsFilter_ChkList2_lst.Items.Count - 1
                If WpsFilter_ChkList2_lst.GetItemChecked(i) = True Then
                    klantlist(i, old_startbox + 1).checked = True
                Else
                    klantlist(i, old_startbox + 1).checked = False
                End If
            Next
            For i = 0 To WpsFilter_ChkList3_lst.Items.Count - 1
                If WpsFilter_ChkList3_lst.GetItemChecked(i) = True Then
                    klantlist(i, old_startbox + 2).checked = True
                Else
                    klantlist(i, old_startbox + 2).checked = False
                End If
            Next
            For i = 0 To WpsFilter_ChkList4_lst.Items.Count - 1
                If WpsFilter_ChkList4_lst.GetItemChecked(i) = True Then
                    klantlist(i, old_startbox + 3).checked = True
                Else
                    klantlist(i, old_startbox + 3).checked = False
                End If
            Next
            For i = 0 To WpsFilter_ChkList5_lst.Items.Count - 1
                If WpsFilter_ChkList5_lst.GetItemChecked(i) = True Then
                    klantlist(i, old_startbox + 4).checked = True
                Else
                    klantlist(i, old_startbox + 4).checked = False
                End If
            Next
        End If

        WpsFilter_Instel1_but.Text = Trim(Str(startbox)) + ": " + wpsgroepnamen(startbox)
        WpsFilter_Instel2_but.Text = Trim(Str(startbox + 1)) + ": " + wpsgroepnamen(startbox + 1)
        WpsFilter_Instel3_but.Text = Trim(Str(startbox + 2)) + ": " + wpsgroepnamen(startbox + 2)
        WpsFilter_Instel4_but.Text = Trim(Str(startbox + 3)) + ": " + wpsgroepnamen(startbox + 3)
        WpsFilter_Instel5_but.Text = Trim(Str(startbox + 4)) + ": " + wpsgroepnamen(startbox + 4)
        WpsFilter_Instel1_but.Tag = Trim(Str(startbox))
        WpsFilter_Instel2_but.Tag = Trim(Str(startbox + 1))
        WpsFilter_Instel3_but.Tag = Trim(Str(startbox + 2))
        WpsFilter_Instel4_but.Tag = Trim(Str(startbox + 3))
        WpsFilter_Instel5_but.Tag = Trim(Str(startbox + 4))

        WpsFilter_Add1_but.Tag = Trim(Str(startbox))
        WpsFilter_Add2_but.Tag = Trim(Str(startbox + 1))
        WpsFilter_Add3_but.Tag = Trim(Str(startbox + 2))
        WpsFilter_Add4_but.Tag = Trim(Str(startbox + 3))
        WpsFilter_Add5_but.Tag = Trim(Str(startbox + 4))

        WpsFilter_ChkList1_lst.BeginUpdate()
        WpsFilter_ChkList2_lst.BeginUpdate()
        WpsFilter_ChkList3_lst.BeginUpdate()
        WpsFilter_ChkList4_lst.BeginUpdate()
        WpsFilter_ChkList5_lst.BeginUpdate()

        WpsFilter_ChkList1_lst.Items.Clear()
        WpsFilter_ChkList2_lst.Items.Clear()
        WpsFilter_ChkList3_lst.Items.Clear()
        WpsFilter_ChkList4_lst.Items.Clear()
        WpsFilter_ChkList5_lst.Items.Clear()

        For i = 0 To listcounter(startbox) - 1
            Dim listindex As Integer = WpsFilter_ChkList1_lst.Items.Add(klantlist(i, startbox).naam)
            WpsFilter_ChkList1_lst.SetItemChecked(listindex, klantlist(i, startbox).checked)
        Next i

        For i = 0 To listcounter(startbox + 1) - 1
            Dim listindex As Integer = WpsFilter_ChkList2_lst.Items.Add(klantlist(i, startbox + 1).naam)
            WpsFilter_ChkList2_lst.SetItemChecked(listindex, klantlist(i, startbox + 1).checked)
        Next i

        For i = 0 To listcounter(startbox + 2) - 1
            Dim listindex As Integer = WpsFilter_ChkList3_lst.Items.Add(klantlist(i, startbox + 2).naam)
            WpsFilter_ChkList3_lst.SetItemChecked(listindex, klantlist(i, startbox + 2).checked)
        Next i

        For i = 0 To listcounter(startbox + 3) - 1
            Dim listindex As Integer = WpsFilter_ChkList4_lst.Items.Add(klantlist(i, startbox + 3).naam)
            WpsFilter_ChkList4_lst.SetItemChecked(listindex, klantlist(i, startbox + 3).checked)
        Next i

        For i = 0 To listcounter(startbox + 4) - 1
            Dim listindex As Integer = WpsFilter_ChkList5_lst.Items.Add(klantlist(i, startbox + 4).naam)
            WpsFilter_ChkList5_lst.SetItemChecked(listindex, klantlist(i, startbox + 4).checked)
        Next i

        WpsFilter_ChkList1_lst.EndUpdate()
        WpsFilter_ChkList2_lst.EndUpdate()
        WpsFilter_ChkList3_lst.EndUpdate()
        WpsFilter_ChkList4_lst.EndUpdate()
        WpsFilter_ChkList5_lst.EndUpdate()

    End Sub

    Private Sub WpsFilter_Add(ByVal selectedcol As Integer)

        'save checked state
        For i As Integer = 0 To WpsFilter_ChkList1_lst.Items.Count - 1
            If WpsFilter_ChkList1_lst.GetItemChecked(i) = True Then
                klantlist(i, Val(WpsFilter_Add1_but.Tag)).checked = True
            Else
                klantlist(i, Val(WpsFilter_Add1_but.Tag)).checked = False
            End If
        Next
        For i As Integer = 0 To WpsFilter_ChkList2_lst.Items.Count - 1
            If WpsFilter_ChkList2_lst.GetItemChecked(i) = True Then
                klantlist(i, Val(WpsFilter_Add2_but.Tag)).checked = True
            Else
                klantlist(i, Val(WpsFilter_Add2_but.Tag)).checked = False
            End If
        Next
        For i As Integer = 0 To WpsFilter_ChkList3_lst.Items.Count - 1
            If WpsFilter_ChkList3_lst.GetItemChecked(i) = True Then
                klantlist(i, Val(WpsFilter_Add3_but.Tag)).checked = True
            Else
                klantlist(i, Val(WpsFilter_Add3_but.Tag)).checked = False
            End If
        Next
        For i As Integer = 0 To WpsFilter_ChkList4_lst.Items.Count - 1
            If WpsFilter_ChkList4_lst.GetItemChecked(i) = True Then
                klantlist(i, Val(WpsFilter_Add4_but.Tag)).checked = True
            Else
                klantlist(i, Val(WpsFilter_Add4_but.Tag)).checked = False
            End If
        Next
        For i As Integer = 0 To WpsFilter_ChkList5_lst.Items.Count - 1
            If WpsFilter_ChkList5_lst.GetItemChecked(i) = True Then
                klantlist(i, Val(WpsFilter_Add5_but.Tag)).checked = True
            Else
                klantlist(i, Val(WpsFilter_Add5_but.Tag)).checked = False
            End If
        Next

        Dim CmdString As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                For col = 1 To 50
                    For row = 0 To listcounter(col) - 1
                        If klantlist(row, col).checked = True Then
                            '
                            'save all checked numbers

                            Dim Cmd As New OdbcCommand(CmdString, Conn)
                            With Cmd
                                Cmd.CommandText = "UPDATE klanten SET wps_indeling=? WHERE ean = '" + klantlist(row, col).ean + "'"
                                .Parameters.Clear()
                                .Parameters.AddWithValue("", selectedcol)
                                .ExecuteNonQuery()
                            End With

                        End If
                    Next
                Next

                Conn.Close()

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (kopers indeling opslaan)" + ex.Message)
            MsgBox("Database fout: (kopers indeling opslaan)" + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        'reload
        Laad_Namen_filterindelingen()

        Dim Reader As OdbcDataReader
        Dim count As Integer

        count = GetRowCount("klanten")
        CmdString = "SELECT klantnaam, ean, wps_indeling,actief FROM klanten ORDER BY klantnaam"
        ReDim klantlist(count, 50)
        For i = 1 To 50
            listcounter(i) = 0
        Next
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim ean As String
                Dim naam As String
                Dim indeling As Integer
                Dim actief As Boolean
                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()

                If Reader.HasRows Then
                    For i = 1 To count
                        Reader.Read()
                        ean = CHstr(Reader("ean"))
                        naam = CHstr(Reader("klantnaam"))
                        actief = CHbool(Reader("actief"))
                        indeling = CHint(Reader("wps_indeling"))
                        If actief = True Then
                            klantlist(listcounter(indeling), indeling).naam = naam
                            klantlist(listcounter(indeling), indeling).ean = ean
                            klantlist(listcounter(indeling), indeling).checked = False
                            listcounter(indeling) = listcounter(indeling) + 1
                        End If
                    Next i
                End If
                Reader.Close()
            End Using

        Catch ex As Exception
            ErrorLog("Database fout: (reload wps filters)" + ex.Message)
            MessageBox.Show("Database fout: (reload wps filters)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

        Dim scrollnummer As Integer = WpsFilter_Scrollbar.Value
        If scrollnummer >= 0 And scrollnummer <= 50 Then
            Fill_WpsFilterListboxes(scrollnummer, False)
        End If

    End Sub
    Private Sub WpsFilter_Add1_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Add1_but.Click
        Dim selectedcol As Integer = Val(WpsFilter_Add1_but.Tag)
        WpsFilter_Add(selectedcol)
    End Sub
    Private Sub WpsFilter_Add2_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Add2_but.Click
        Dim selectedcol As Integer = Val(WpsFilter_Add2_but.Tag)
        WpsFilter_Add(selectedcol)
    End Sub
    Private Sub WpsFilter_Add3_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Add3_but.Click
        Dim selectedcol As Integer = Val(WpsFilter_Add3_but.Tag)
        WpsFilter_Add(selectedcol)
    End Sub
    Private Sub WpsFilter_Add4_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Add4_but.Click
        Dim selectedcol As Integer = Val(WpsFilter_Add4_but.Tag)
        WpsFilter_Add(selectedcol)
    End Sub
    Private Sub WpsFilter_Add5_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Add5_but.Click
        Dim selectedcol As Integer = Val(WpsFilter_Add5_but.Tag)
        WpsFilter_Add(selectedcol)
    End Sub

    Private Sub WpsFilter_Instellen(ByVal groepnummer As Integer)

        WpsFilter_FilterOpslaan_but.Enabled = True
        WpsFilter_FilterOpslaan_but.Text = "Wps filter instellingen groep " + Trim(Str(groepnummer)) + " opslaan"
        WpsFilter_filternaam_txt.Text = wpsgroepnamen(groepnummer)
        WpsFilter_FilterOpslaan_but.Tag = Str(groepnummer)

        With WpsFilter_FilterFlex
            .Clear()
            .Cols.Count = 6
            .Rows.Count = 1

            .Cols(0).Caption = "Soort"
            .Cols(0).DataType = System.Type.GetType("System.String")
            .Cols(0).Width = 150
            .Cols(0).AllowEditing = False

            .Cols(1).Caption = "Filter 1"
            .Cols(1).DataType = System.Type.GetType("System.String")
            .Cols(1).Width = 200
            .Cols(1).AllowEditing = False

            .Cols(2).Caption = "Filter 1 ID"
            .Cols(2).DataType = System.Type.GetType("System.Int32")
            .Cols(2).Width = 80
            .Cols(2).Visible = False
            .Cols(2).AllowEditing = False

            .Cols(3).Caption = "Filter 2"
            .Cols(3).DataType = System.Type.GetType("System.String")
            .Cols(3).Width = 200
            .Cols(3).AllowEditing = False

            .Cols(4).Caption = "Filter 2 ID"
            .Cols(4).DataType = System.Type.GetType("System.Int32")
            .Cols(4).Width = 80
            .Cols(4).Visible = False
            .Cols(4).AllowEditing = False

            .Cols(5).Caption = "Soort ID"
            .Cols(5).DataType = System.Type.GetType("System.Int32")
            .Cols(5).Width = 80
            .Cols(5).Visible = False
            .Cols(5).AllowEditing = False
        End With

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim flexgridfill(6) As String
                For i = 0 To UBound(soorten)
                    If soorten(i).actief = True Then

                        'init
                        Dim filter1_naam As String = ""
                        Dim filter2_naam As String = ""
                        Dim filter1_id As Integer = 0
                        Dim filter2_id As Integer = 0
                        Dim wps_soortid As Integer = CInt(Val(soorten(i).wps_code))

                        ' load filterset
                        Dim Reader As OdbcDataReader
                        Dim CmdString As String = "SELECT * FROM wps_groepfilters WHERE groep=" + Str(groepnummer) + " AND soort_id=" + Str(soorten(i).id) + " ORDER BY filter1"

                        'Execute Query
                        Dim Cmd As New OdbcCommand(CmdString, Conn)
                        Reader = Cmd.ExecuteReader()
                        If Reader.HasRows Then
                            Reader.Read()
                            filter1_id = CHint(Reader("filter1"))
                            filter2_id = CHint(Reader("filter2"))
                        End If
                        Reader.Close()

                        'namen erbij zoeken
                        For j = 0 To UBound(wpsfilter)
                            If filter1_id = wpsfilter(j).filternummer And wps_soortid = wpsfilter(j).wps_soortnummer Then
                                filter1_naam = wpsfilter(j).filternaam
                                Exit For
                            End If
                        Next j
                        For j = 0 To UBound(wpsfilter)
                            If filter2_id = wpsfilter(j).filternummer And wps_soortid = wpsfilter(j).wps_soortnummer Then
                                filter2_naam = wpsfilter(j).filternaam
                                Exit For
                            End If
                        Next j
                        If filter1_id = 999999 Then filter1_naam = "Niet via WPS"
                        If filter1_id = 0 Then filter1_naam = "N.V.T."
                        If filter2_id = 999999 Then filter2_naam = "Niet via WPS"
                        If filter2_id = 0 Then filter2_naam = "N.V.T."

                        ' grid vullen
                        flexgridfill(0) = soorten(i).soortnaam
                        flexgridfill(1) = filter1_naam
                        flexgridfill(2) = filter1_id
                        flexgridfill(3) = filter2_naam
                        flexgridfill(4) = filter2_id
                        flexgridfill(5) = soorten(i).id
                        WpsFilter_FilterFlex.AddItem(flexgridfill)

                    End If
                Next
                Conn.Close()
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (groepnamen laden)" + ex.Message)
            MessageBox.Show("Database fout: groepnamen laden)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub
    Private Sub WpsFilter_Instel1_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Instel1_but.Click
        Dim groepnummer = Val(WpsFilter_Instel1_but.Tag)
        WpsFilter_Instellen(groepnummer)
    End Sub
    Private Sub WpsFilter_Instel2_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Instel2_but.Click
        Dim groepnummer = Val(WpsFilter_Instel2_but.Tag)
        WpsFilter_Instellen(groepnummer)
    End Sub
    Private Sub WpsFilter_Instel3_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Instel3_but.Click
        Dim groepnummer = Val(WpsFilter_Instel3_but.Tag)
        WpsFilter_Instellen(groepnummer)
    End Sub
    Private Sub WpsFilter_Instel4_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Instel4_but.Click
        Dim groepnummer = Val(WpsFilter_Instel4_but.Tag)
        WpsFilter_Instellen(groepnummer)
    End Sub
    Private Sub WpsFilter_Instel5_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_Instel5_but.Click
        Dim groepnummer = Val(WpsFilter_Instel5_but.Tag)
        WpsFilter_Instellen(groepnummer)
    End Sub
    Private Sub WpsFilter_FilterFlex_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_FilterFlex.Click

        If WpsFilter_FilterFlex.Rows.Count > 1 Then
            If WpsFilter_FilterFlex.Col = 1 Then

                '***************************************************
                ' COMBO invullen als er op geclicked wordt
                ' Create the custom editor.
                '***************************************************
                Dim style As C1.Win.C1FlexGrid.CellStyle = WpsFilter_FilterFlex.Styles.Add("newGridStyle")
                WpsFilter_flexcombo.DataMode = C1.Win.C1List.DataModeEnum.Normal

                Dim dt_filter As New DataTable
                dt_filter.Columns.Add("Code", GetType(Integer))
                dt_filter.Columns.Add("Naam", GetType(String))

                ' Dim cn() As String = New String() {"Naam", "Code"}
                dt_filter.Clear()

                '*********** LIJST GENEREREN **************************
                Dim soort_id = WpsFilter_FilterFlex.Item(WpsFilter_FilterFlex.Row, 5)
                Dim wps_soort_id = soorten(GID(soorten, soort_id)).wps_code
                Dim potmaat = soorten(GID(soorten, soort_id)).potmaat
                Dim filterfound As Boolean = False
                For i = 0 To UBound(wpsfilter)
                    If potmaat = 190 Then potmaat = 170
                    If wps_soort_id = wpsfilter(i).wps_soortnummer And potmaat = wpsfilter(i).potmaat Then
                        dt_filter.Rows.Add(New String() {wpsfilter(i).filternummer, wpsfilter(i).filternaam})
                        filterfound = True
                    End If
                Next i
                If filterfound = False And soort_id < 10000 Then
                    dt_filter.Rows.Add(New String() {0, "N.V.T."})
                    dt_filter.Rows.Add(New String() {999999, "Niet via WPS"})
                End If


                'dt_soortmix.DefaultView.Sort = String.Format("volgorde", "DESC")
                WpsFilter_flexcombo.DataSource = dt_filter
                WpsFilter_flexcombo.DisplayMember = "Naam"
                WpsFilter_flexcombo.ValueMember = "Code"
                WpsFilter_flexcombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                WpsFilter_flexcombo.ComboStyle = 2  'combo style list

                WpsFilter_flexcombo.MaxDropDownItems = 15

                WpsFilter_flexcombo.DropDownWidth = 200
                WpsFilter_flexcombo.ColumnWidth = 195
                WpsFilter_flexcombo.MaxDropDownItems = 15

                style.Editor = WpsFilter_flexcombo
                WpsFilter_FilterFlex.SetCellStyle(WpsFilter_FilterFlex.Row, 1, style)
                WpsFilter_FilterFlex.StartEditing(WpsFilter_FilterFlex.Row, 1)

                WpsFilter_flexcombo.DroppedDown = True


            End If

            If WpsFilter_FilterFlex.Col = 3 Then

                '***************************************************
                ' COMBO invullen als er op geclicked wordt
                ' Create the custom editor.
                '***************************************************
                Dim style As C1.Win.C1FlexGrid.CellStyle = WpsFilter_FilterFlex.Styles.Add("newGridStyle")
                WpsFilter_flexcombo.DataMode = C1.Win.C1List.DataModeEnum.Normal

                Dim dt_filter As New DataTable
                dt_filter.Columns.Add("Code", GetType(Integer))
                dt_filter.Columns.Add("Naam", GetType(String))

                ' Dim cn() As String = New String() {"Naam", "Code"}
                dt_filter.Clear()

                '*********** LIJST GENEREREN **************************
                Dim soort_id = WpsFilter_FilterFlex.Item(WpsFilter_FilterFlex.Row, 5)
                Dim wps_soort_id = soorten(GID(soorten, soort_id)).wps_code
                Dim potmaat = soorten(GID(soorten, soort_id)).potmaat
                Dim filterfound As Boolean = False
                For i = 0 To UBound(wpsfilter)
                    If potmaat = 190 Then potmaat = 170
                    If wps_soort_id = wpsfilter(i).wps_soortnummer And potmaat = wpsfilter(i).potmaat Then
                        dt_filter.Rows.Add(New String() {wpsfilter(i).filternummer, wpsfilter(i).filternaam})
                        filterfound = True
                    End If
                Next i
                If filterfound = False And soort_id < 10000 Then
                    dt_filter.Rows.Add(New String() {999999, "Niet via WPS"})
                End If
                'dt_soortmix.DefaultView.Sort = String.Format("volgorde", "DESC")
                WpsFilter_flexcombo.DataSource = dt_filter
                WpsFilter_flexcombo.DisplayMember = "Naam"
                WpsFilter_flexcombo.ValueMember = "Code"
                WpsFilter_flexcombo.Splits(0).DisplayColumns(0).Visible = False  ' id
                WpsFilter_flexcombo.ComboStyle = 2  'combo style list

                WpsFilter_flexcombo.MaxDropDownItems = 15

                WpsFilter_flexcombo.DropDownWidth = 200
                WpsFilter_flexcombo.ColumnWidth = 195
                WpsFilter_flexcombo.MaxDropDownItems = 15

                style.Editor = WpsFilter_flexcombo
                WpsFilter_FilterFlex.SetCellStyle(WpsFilter_FilterFlex.Row, 3, style)
                WpsFilter_FilterFlex.StartEditing(WpsFilter_FilterFlex.Row, 3)

                WpsFilter_flexcombo.DroppedDown = True


            End If


        End If

    End Sub
    Private Sub WpsFilter_flexcombo_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles WpsFilter_flexcombo.Validated

        If WpsFilter_FilterFlex.Col = 1 Then
            If WpsFilter_flexcombo.SelectedValue = Nothing Then
                WpsFilter_FilterFlex.Item(WpsFilter_FilterFlex.Row, 2) = 0
            Else
                WpsFilter_FilterFlex.Item(WpsFilter_FilterFlex.Row, 2) = WpsFilter_flexcombo.SelectedValue
            End If

        End If

        If WpsFilter_FilterFlex.Col = 3 Then
            If WpsFilter_flexcombo.SelectedValue = Nothing Then
                WpsFilter_FilterFlex.Item(WpsFilter_FilterFlex.Row, 4) = 0
            Else
                WpsFilter_FilterFlex.Item(WpsFilter_FilterFlex.Row, 4) = WpsFilter_flexcombo.SelectedValue
            End If
        End If
    End Sub

    Private Sub WpsFilter_FilterOpslaan_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles WpsFilter_FilterOpslaan_but.Click

        Dim groepnummer As Integer = Val(WpsFilter_FilterOpslaan_but.Tag)
        If groepnummer > 0 Then

            Dim CmdString As String = ""
            Try
                'Open Connection
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    'Execute Query
                    CmdString = "DELETE FROM wps_groepfilters WHERE groep = " + Str(groepnummer)
                    Dim Cmd2 As New OdbcCommand(CmdString, Conn)
                    Cmd2.ExecuteNonQuery()

                    Dim CmdString8 As String = ""
                    Dim Cmd8 As New OdbcCommand(CmdString, Conn)
                    Cmd8.CommandText = "UPDATE wps_groepnaam SET naam = '" + WpsFilter_filternaam_txt.Text + "' WHERE id =" + Str(groepnummer)
                    Cmd8.ExecuteNonQuery()

                    Dim Cmd As New OdbcCommand(CmdString, Conn)
                    With Cmd
                        For i = 1 To WpsFilter_FilterFlex.Rows.Count - 1
                            .Parameters.Clear()
                            .CommandText = "INSERT INTO wps_groepfilters(soort_id, filter1, filter2, groep) VALUES(?,?,?,?)"
                            Dim soort_id As Integer = WpsFilter_FilterFlex.Item(i, 5)
                            .Parameters.AddWithValue("", soort_id)
                            Dim filter1 As Integer = WpsFilter_FilterFlex.Item(i, 2)
                            .Parameters.AddWithValue("", filter1)
                            Dim filter2 As Integer = WpsFilter_FilterFlex.Item(i, 4)
                            .Parameters.AddWithValue("", filter2)
                            .Parameters.AddWithValue("", groepnummer)
                            .ExecuteNonQuery()
                        Next i

                    End With

                    MsgBox("Filters groep " + Str(groepnummer) + " opgeslagen!", MsgBoxStyle.OkOnly)
                End Using
            Catch ex As Exception
                ErrorLog("Database opslaan: (wps filters)" + ex.Message)
                MsgBox("Database opslaan: (wps filters)" + ex.Message, MsgBoxStyle.OkOnly)
            End Try

            WpsFilter_Instellen(groepnummer)

        End If


    End Sub



#End Region

#Region "Overzicht"


    Private Sub Overzicht_MonthCalendar_DateChanged(ByVal sender As System.Object, ByVal e As System.Windows.Forms.DateRangeEventArgs) Handles Overzicht_MonthCalendar.DateChanged
        overzichtdatum = Overzicht_MonthCalendar.SelectionStart
        Dim weeknr As Integer = DatePart(DateInterval.WeekOfYear, overzichtdatum, FirstDayOfWeek.Monday, FirstWeekOfYear.System)
        overzicht_week_lbl.Text = "Week " + Trim(Str(weeknr))
    End Sub

    Private Sub Overzicht_gegevensophalen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Overzicht_gegevensophalen_but.Click


        'Dim odatum As Date = Overzicht_MonthCalendar.SelectionStart
        Dim odatum As Date = overzichtdatum
        Dim weeknr As Integer = DatePart(DateInterval.WeekOfYear, odatum, FirstDayOfWeek.Monday, FirstWeekOfYear.System)

        GC.Collect()

        Dim jaar As Integer = Year(odatum)

        Dim orderjaar As String = Trim(Str(Year(odatum)))
        If staticyear = True Then orderjaar = ""

        Dim daypair As Tuple(Of DateTime, DateTime)
        daypair = getFirstAndLastDayOfWeek(odatum)
        Dim startdate As Date = daypair.Item1
        Dim enddate As Date = daypair.Item2

        Dim aantal_soorten = UBound(soorten) + UBound(mixen)

        Dim aantal(aantal_soorten, 8) As Long
        Dim soortidlist(aantal_soorten) As Integer
        Dim soortcounter As Integer = 0

        ' dag (0-6) + planning 

        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()


                'load order lines


                For daycount = 0 To 6

                    Dim fetchdate As Date = DateAdd("d", daycount, startdate)
                    Dim daystart As String = Format(fetchdate, "yyyy-MM-dd") + " 00:00:00"
                    Dim dayend As String = Format(fetchdate, "yyyy-MM-dd") + " 23:59:59"
                    Dim cmdstring As String = "SELECT soort_id,aantal,gp,fust_id, oh.status as hstatus FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE oh.status < 99 AND oh.afleverdatum between '" + daystart + "' and '" + dayend + "'"

                    If Overzicht_klantspecifiek_chk.Checked = True Then
                        Dim koper_ean As String = DirectCast(DirectCast(Order_koper_combo.SelectedItem, System.Object), System.Data.DataRowView).Item(0)
                        cmdstring = cmdstring + " AND oh.koper_ean = " + koper_ean
                    End If


                    Dim reader As OdbcDataReader
                    'Execute Query
                    Dim Cmd As New OdbcCommand(cmdstring, Conn)
                    reader = Cmd.ExecuteReader()
                    Do While reader.Read
                        Dim fust_id As Integer = CHint(reader("fust_id"))
                        Dim aantalperfust As Integer = fust(GID(fust, fust_id)).aantal_per_fust
                        Dim soortid As Integer = CHint(reader("soort_id"))
                        Dim status As Integer = CHint(reader("hstatus"))
                        Dim soortinsoortgroep As Boolean = False
                        If Overzicht_soortgroep_chk.Checked = True Then
                            Dim soortgroepid As Integer = DirectCast(DirectCast(Overzicht_Soortgroep_cmb.SelectedItem, System.Object), System.Data.DataRowView).Item(0)
                            For i = 0 To UBound(soortgroepids)
                                If soortgroepids(i).id = soortgroepid Then
                                    If soortgroepids(i).soortmixid = soortid Then
                                        soortinsoortgroep = True
                                        Exit For
                                    End If
                                End If
                            Next
                        End If

                        Dim line_ok As Boolean = True
                        If Overzicht_TotaalNieuw_cmb.Text = "Nieuw" Then
                            If status > 26 Then
                                line_ok = False
                            End If
                            If status = 43 Then line_ok = True
                        End If

                        If (soortinsoortgroep = True Or Overzicht_soortgroep_chk.Checked = False) And line_ok = True Then

                            Dim aantalstuks As Integer = CHint(reader("aantal"))
                            Dim gp As Integer = CHint(reader("gp"))
                            Dim totaantal As Long = gp * aantalstuks * aantalperfust
                            Dim soortfound As Boolean = False
                            If soortid < 10000 Then
                                For i = 0 To aantal_soorten
                                    If soortidlist(i) = soortid Then
                                        aantal(i, daycount) = aantal(i, daycount) + totaantal
                                        soortfound = True
                                        Exit For
                                    End If
                                Next
                                If soortfound = False Then
                                    soortidlist(soortcounter) = soortid
                                    aantal(soortcounter, daycount) = totaantal
                                    soortcounter = soortcounter + 1
                                End If
                            End If
                            If soortid >= 10000 Then  'mixen
                                Dim mix_id As Integer = soortid - 10000
                                Dim vullingfound As Boolean = False
                                Dim cmdstring8 As String = "SELECT soort_id FROM mixen_vulling WHERE mix_id = " + Str(mix_id)
                                Dim reader8 As OdbcDataReader
                                'Execute Query
                                Dim Cmd8 As New OdbcCommand(cmdstring8, Conn)
                                reader8 = Cmd8.ExecuteReader()
                                Do While reader8.Read
                                    vullingfound = True
                                    Dim soortmixid As Integer = CHint(reader8("soort_id"))
                                    soortfound = False
                                    For i = 0 To aantal_soorten
                                        If soortidlist(i) = soortmixid Then
                                            aantal(i, daycount) = aantal(i, daycount) + (gp * aantalstuks)
                                            soortfound = True
                                            Exit For
                                        End If
                                    Next
                                    If soortfound = False Then
                                        soortidlist(soortcounter) = soortmixid
                                        aantal(soortcounter, daycount) = (gp * aantalstuks)
                                        soortcounter = soortcounter + 1
                                    End If

                                Loop

                                If vullingfound = False Then    'mixlagen?

                                    Dim mixlaagstr As String = "select * from mixlagen WHERE mixlaag_id = " + Str(mix_id) + " "
                                    Dim mixcmd As New OdbcCommand(mixlaagstr, Conn)
                                    Dim mlReader As OdbcDataReader

                                    mlReader = mixcmd.ExecuteReader
                                    Dim mixarray(5000) As Integer  'mixarray bevat 5000 soortids op volgorde
                                    Dim mixcounter As Integer = 0
                                    vullingfound = False
                                    Do While mlReader.Read
                                        mixarray(mixcounter) = mlReader("soort_id")
                                        mixcounter = mixcounter + 1
                                        vullingfound = True
                                    Loop
                                    If vullingfound = True Then
                                        Dim copycounter As Integer = 0
                                        For i = mixcounter To 4999
                                            mixarray(i) = mixarray(copycounter)
                                            copycounter = copycounter + 1
                                            If copycounter >= mixcounter Then
                                                copycounter = 0
                                            End If
                                        Next

                                        For j = 0 To totaantal - 1
                                            For i = 0 To aantal_soorten
                                                If soortidlist(i) = mixarray(j) Then
                                                    aantal(i, daycount) = aantal(i, daycount) + gp
                                                    soortfound = True
                                                    Exit For
                                                End If
                                            Next
                                            If soortfound = False Then
                                                soortidlist(soortcounter) = mixarray(j)
                                                aantal(soortcounter, daycount) = gp
                                                soortcounter = soortcounter + 1
                                            End If
                                        Next


                                    End If
                                End If

                            End If
                        End If
                    Loop
                Next

                'sort
                Dim swapsoortid As Integer = 0
                Dim swapaantal(8) As Integer

                For k = 0 To aantal_soorten - 1
                    For i = 0 To aantal_soorten - 1
                        Dim totaalaantal1 As Long = aantal(i, 0) + aantal(i, 1) + aantal(i, 2) + aantal(i, 3) + aantal(i, 4) + aantal(i, 5) + aantal(i, 6)
                        Dim totaalaantal2 As Long = aantal(i + 1, 0) + aantal(i + 1, 1) + aantal(i + 1, 2) + aantal(i + 1, 3) + aantal(i + 1, 4) + aantal(i + 1, 5) + aantal(i + 1, 6)
                        If totaalaantal1 < totaalaantal2 Then
                            'store
                            swapsoortid = soortidlist(i)
                            For j = 0 To 7
                                swapaantal(j) = aantal(i, j)
                            Next j
                            'swap
                            soortidlist(i) = soortidlist(i + 1)
                            For j = 0 To 7
                                aantal(i, j) = aantal(i + 1, j)
                            Next j
                            'restore
                            soortidlist(i + 1) = swapsoortid
                            For j = 0 To 7
                                aantal(i + 1, j) = swapaantal(j)
                            Next j
                        End If

                    Next i
                Next k
                'load plannning
                Dim weekstr As String = Trim(Str(jaar)) + Format(weeknr, "00")
                Dim cmdstring2 As String = "SELECT * from planning WHERE weeknr ='" + weekstr + "'"
                Dim reader2 As OdbcDataReader
                Dim Cmd2 As New OdbcCommand(cmdstring2, Conn)
                reader2 = Cmd2.ExecuteReader()
                If reader2.HasRows Then
                    reader2.Read()
                    For planning = 1 To 25
                        Dim readstring As String = "s" + Trim(Str(planning))
                        Dim planaantal As Long = CHint(reader2(readstring))
                        If planaantal > 0 Then
                            Dim soortfound As Boolean = False
                            For searchidlist = 0 To soortcounter - 1
                                If soortidlist(searchidlist) = planning Then
                                    aantal(searchidlist, 7) = planaantal
                                    soortfound = True
                                End If
                            Next
                            If soortfound = False Then
                                soortidlist(soortcounter) = planning
                                aantal(soortcounter, 7) = planaantal
                                soortcounter = soortcounter + 1
                            End If
                        End If
                    Next

                End If


                'fill flexgrid 

                Dim gridfill1(12) As String
                Overzicht_FlexGrid.Rows.Count = 1
                For i = 0 To soortcounter - 1
                    Dim soortid As Integer = soortidlist(i)
                    Dim soortnaam As String = soorten(GID(soorten, soortid)).soortnaam
                    gridfill1(0) = soortnaam
                    gridfill1(1) = aantal(i, 7)
                    Dim totaalaantal As Long = aantal(i, 0) + aantal(i, 1) + aantal(i, 2) + aantal(i, 3) + aantal(i, 4) + aantal(i, 5) + aantal(i, 6)
                    gridfill1(2) = totaalaantal
                    gridfill1(3) = aantal(i, 7) - totaalaantal
                    gridfill1(4) = soortid

                    gridfill1(5) = aantal(i, 0)
                    gridfill1(6) = aantal(i, 1)
                    gridfill1(7) = aantal(i, 2)
                    gridfill1(8) = aantal(i, 3)

                    gridfill1(9) = aantal(i, 4)
                    gridfill1(10) = aantal(i, 5) + aantal(i, 6)
                    Overzicht_FlexGrid.AddItem(gridfill1)
                Next

                For i = 0 To 11
                    gridfill1(i) = ""
                Next i
                Overzicht_FlexGrid.AddItem(gridfill1)

                gridfill1(0) = "Totaal"

                For i = 1 To 10
                    Dim totcount As Long = 0
                    For Row = 1 To Overzicht_FlexGrid.Rows.Count - 2
                        totcount = totcount + Val(Overzicht_FlexGrid.Item(Row, i))
                    Next
                    gridfill1(i) = Str(totcount)
                Next i
                Overzicht_FlexGrid.AddItem(gridfill1)

            End Using
        Catch ex As Exception
            ErrorLog("Fout inladen overzichtgegevens: " + ex.Message)
            MsgBox("Fout inladen overzichtgegevens: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try

        'draw graph
        If soortcounter > 0 Then



            Dim bh As Integer = Overzicht_PictureBox.Size.Height
            Dim bw As Integer = Overzicht_PictureBox.Size.Width

            Dim DBitmap As New Bitmap(bw, bh)

            bw = bw - 1
            bh = bh - 1

            Dim Brush0 As New SolidBrush(Color.Black)
            Dim Brush1 As New SolidBrush(Color.RoyalBlue)
            Dim Brush2 As New SolidBrush(Color.Cyan)
            Dim Brush3 As New SolidBrush(Color.DarkCyan)

            Dim myPen As Pen = New Pen(Color.Black, 1)

            Dim SelectedFont = New Font(FontFamily.GenericSerif, 10)

            Dim max_height = 0
            Dim tot_height = 0
            For i = 0 To soortcounter - 1

                Dim tot_aantal = aantal(i, 0) + aantal(i, 1) + aantal(i, 2) + aantal(i, 3) + aantal(i, 4) + aantal(i, 5) + aantal(i, 6)
                If tot_aantal > max_height Then
                    max_height = tot_aantal * 1.1
                End If
                If Overzicht_klantspecifiek_chk.Checked = False Then
                    Dim plan_aantal = aantal(i, 7)
                    If plan_aantal > max_height Then
                        max_height = plan_aantal * 1.1
                    End If
                End If
            Next


            Using Graphic = Graphics.FromImage(DBitmap)

                Graphic.Clear(Me.BackColor)

                Graphic.DrawLine(myPen, 0, 0, bw, 0)
                Graphic.DrawLine(myPen, 0, 0, 0, bh)
                Graphic.DrawLine(myPen, bw, 0, bw, bh)
                Graphic.DrawLine(myPen, 0, bh, bw, bh)

                Dim xsoortcounter As Integer = soortcounter
                If xsoortcounter < 10 Then xsoortcounter = 10

                Dim xscale As Double = bw / soortcounter
                Dim yscale As Double = (bh - 100) / max_height
                Dim printhoog As Boolean = False
                For i = 0 To soortcounter - 1
                    Dim soortid As Integer = soortidlist(i)
                    Dim soortnaam As String = soorten(GID(soorten, soortid)).soortnaam

                    Dim calc_height1 As Integer = aantal(i, 7) * yscale
                    Dim soorttot As Integer = 0
                    For j = 0 To 6
                        soorttot = soorttot + aantal(i, j)
                    Next
                    Dim calc_height2 As Integer = soorttot * yscale
                    Dim calc_height3 As Integer = 0
                    If (calc_height2 - calc_height1) > 0 Then
                        calc_height3 = calc_height2 - calc_height1
                        calc_height2 = calc_height1
                    End If
                    'text 
                    If printhoog = False Then
                        Graphic.DrawString(soortnaam, SelectedFont, Brush0, 10 + (xscale * i), bh - 20)
                        printhoog = True
                    Else
                        Graphic.DrawString(soortnaam, SelectedFont, Brush0, 10 + (xscale * i), bh - 40)
                        printhoog = False
                    End If


                    If Overzicht_klantspecifiek_chk.Checked = False Then
                        ' planning rectangle 
                        Dim pbox As Rectangle
                        pbox.X = 10 + (xscale * i) + (xscale / 3)
                        pbox.Y = bh - 40 - calc_height1
                        pbox.Width = xscale / 3
                        pbox.Height = calc_height1
                        Graphic.FillRectangle(Brush1, pbox)

                        ' front ractangle 
                        Dim pbox2 As Rectangle
                        pbox2.X = 10 + (xscale * i)
                        pbox2.Y = bh - 40 - calc_height2
                        pbox2.Width = xscale / 3
                        pbox2.Height = calc_height2
                        Graphic.FillRectangle(Brush2, pbox2)

                        'top ractangle
                        Dim pbox3 As Rectangle
                        pbox3.X = 10 + (xscale * i)
                        pbox3.Y = bh - 40 - calc_height3 - calc_height2
                        pbox3.Width = xscale / 3
                        pbox3.Height = calc_height3
                        Graphic.FillRectangle(Brush3, pbox3)

                        If aantal(i, 7) > 0 Then
                            Graphic.DrawString(aantal(i, 7), SelectedFont, Brush0, 10 + (xscale * i) + (xscale / 3), bh - 40 - calc_height1)
                            Graphic.DrawString(aantal(i, 7) - soorttot, SelectedFont, Brush0, 10 + (xscale * i), bh - 80 - calc_height3 - calc_height2)
                        End If
                        'Graphic.DrawString("10000", SelectedFont, Brush0, 10 + (xscale * i), bh - 40 - calc_height2)
                        Graphic.DrawString(soorttot, SelectedFont, Brush0, 10 + (xscale * i), bh - 40 - calc_height3 - calc_height2)

                    Else
                        ' front ractangle 
                        Dim pbox2 As Rectangle
                        pbox2.X = 10 + (xscale * i)
                        pbox2.Y = bh - 40 - calc_height3 - calc_height2
                        pbox2.Width = xscale / 2
                        pbox2.Height = calc_height2 + calc_height3
                        Graphic.FillRectangle(Brush2, pbox2)

                        'top ractangle
                        'Dim pbox3 As Rectangle
                        'pbox3.X = 10 + (xscale * i)
                        'pbox3.Y = bh - 40 - calc_height3 - calc_height2
                        'pbox3.Width = xscale / 3
                        'pbox3.Height = calc_height3
                        'Graphic.FillRectangle(Brush3, pbox3)

                        'Graphic.DrawString(aantal(i, 7), SelectedFont, Brush0, 10 + (xscale * i) + (xscale / 3), bh - 40 - calc_height1)
                        'Graphic.DrawString("10000", SelectedFont, Brush0, 10 + (xscale * i), bh - 40 - calc_height2)
                        Graphic.DrawString(soorttot, SelectedFont, Brush0, 10 + (xscale * i), bh - 40 - calc_height3 - calc_height2)
                        'Graphic.DrawString(aantal(i, 7) - soorttot, SelectedFont, Brush0, 10 + (xscale * i), bh - 80 - calc_height3 - calc_height2)
                    End If

                Next


            End Using
            Overzicht_PictureBox.Image = DBitmap
        Else
            'clear bitmap
            Dim bh As Integer = Overzicht_PictureBox.Size.Height
            Dim bw As Integer = Overzicht_PictureBox.Size.Width

            Dim DBitmap As New Bitmap(bw, bh)

            bw = bw - 1
            bh = bh - 1

            Using Graphic = Graphics.FromImage(DBitmap)
                Graphic.Clear(Me.BackColor)
            End Using
            Overzicht_PictureBox.Image = DBitmap
        End If

    End Sub

    Private Sub Overzicht_ExcelExport_but_Click(sender As System.Object, e As System.EventArgs) Handles Overzicht_ExcelExport_but.Click
        Dim fd As SaveFileDialog = New SaveFileDialog()
        Dim strFileName As String = ""

        fd.Title = "Save XLSX"
        fd.InitialDirectory = "C:\boek"
        fd.Filter = "Excel file (*.xlsx)|*.xlsx|Excel file (*.xlsx)|*.xlsx"
        fd.FilterIndex = 2
        fd.RestoreDirectory = True

        If fd.ShowDialog() = DialogResult.OK Then
            strFileName = fd.FileName
        End If
        If strFileName <> "" Then
            Overzicht_FlexGrid.SaveExcel(strFileName, C1.Win.C1FlexGrid.FileFlags.IncludeFixedCells)
        End If

    End Sub

#End Region

#Region "Voorraad"

    Private Sub voorraad_nieuw_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles voorraad_nieuw_but.Click

        voorraad_bereken_but.Enabled = False
        voorraad_nieuw_but.Enabled = False
        Voorraad_aanpassen_but.Enabled = False

        GroupBoxVoorraad.Enabled = True

        voorraad_artikelnaam_txt.Text = ""
        voorraad_artikelnaam_txt.Focus()

        voorraad_inkoopstuks_txt.Text = "0"
        voorraad_inkooppallets_txt.Text = "0"
        voorraad_voorraad_txt.Text = "0"
        voorraad_waarschuwing_chk.Checked = True
        voorraad_minimum_txt.Text = "0"
        voorraad_aantalperpallet_txt.Text = "2000"
        voorraad_besteltijd_txt.Text = "2"
        voorraad_koppelingfust_radio.Checked = True
        Voorraad_Besteld_chk.Checked = False
        Voorraad_Besteld_chk.Text = Format(Now, "yyyy-MM-dd")

        Dim bindingsource1 As New BindingSource
        bindingsource1.DataSource = dt_fust
        voorraad_koppelingfust1_cmb.DataSource = bindingsource1
        voorraad_koppelingfust1_cmb.DisplayMember = "desc"
        voorraad_koppelingfust1_cmb.ValueMember = "ID"
        voorraad_koppelingfust1_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        Dim bindingsource2 As New BindingSource
        bindingsource2.DataSource = dt_fust
        voorraad_koppelingfust2_cmb.DataSource = bindingsource2
        voorraad_koppelingfust2_cmb.DisplayMember = "desc"
        voorraad_koppelingfust2_cmb.ValueMember = "ID"
        voorraad_koppelingfust2_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        Dim bindingsource3 As New BindingSource
        bindingsource3.DataSource = dt_fust
        voorraad_koppelingfust3_cmb.DataSource = bindingsource3
        voorraad_koppelingfust3_cmb.DisplayMember = "desc"
        voorraad_koppelingfust3_cmb.ValueMember = "ID"
        voorraad_koppelingfust3_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        Dim bindingsource4 As New BindingSource
        bindingsource4.DataSource = dt_fust
        voorraad_koppelingfust4_cmb.DataSource = bindingsource4
        voorraad_koppelingfust4_cmb.DisplayMember = "desc"
        voorraad_koppelingfust4_cmb.ValueMember = "ID"
        voorraad_koppelingfust4_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        Dim bindingsource5 As New BindingSource
        bindingsource5.DataSource = dt_fust
        voorraad_koppelingfust5_cmb.DataSource = bindingsource5
        voorraad_koppelingfust5_cmb.DisplayMember = "desc"
        voorraad_koppelingfust5_cmb.ValueMember = "ID"
        voorraad_koppelingfust5_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        Dim bindingsource6 As New BindingSource
        bindingsource6.DataSource = dt_accessoire
        voorraad_koppelingacce1_cmb.DataSource = bindingsource6
        voorraad_koppelingacce1_cmb.DisplayMember = "desc"
        voorraad_koppelingacce1_cmb.ValueMember = "ID"
        voorraad_koppelingacce1_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        Dim bindingsource7 As New BindingSource
        bindingsource7.DataSource = dt_accessoire
        voorraad_koppelingacce2_cmb.DataSource = bindingsource7
        voorraad_koppelingacce2_cmb.DisplayMember = "desc"
        voorraad_koppelingacce2_cmb.ValueMember = "ID"
        voorraad_koppelingacce2_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        Dim bindingsource8 As New BindingSource
        bindingsource8.DataSource = dt_accessoire
        voorraad_koppelingacce3_cmb.DataSource = bindingsource8
        voorraad_koppelingacce3_cmb.DisplayMember = "desc"
        voorraad_koppelingacce3_cmb.ValueMember = "ID"
        voorraad_koppelingacce3_cmb.DropDownStyle = ComboBoxStyle.DropDownList

        SetComboIndex(voorraad_koppelingfust1_cmb, 9)
        SetComboIndex(voorraad_koppelingfust2_cmb, 9)
        SetComboIndex(voorraad_koppelingfust3_cmb, 9)
        SetComboIndex(voorraad_koppelingfust4_cmb, 9)
        SetComboIndex(voorraad_koppelingfust5_cmb, 9)

        SetComboIndex(voorraad_koppelingacce1_cmb, 0)
        SetComboIndex(voorraad_koppelingacce2_cmb, 0)
        SetComboIndex(voorraad_koppelingacce3_cmb, 0)

        voorraad_id.Text = "0"
    End Sub

    Private Sub voorraad_opslaan_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles voorraad_opslaan_but.Click

        voorraad_nieuw_but.Enabled = True
        Voorraad_aanpassen_but.Enabled = True
        voorraad_bereken_but.Enabled = True
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                'Execute Query
                Dim Cmd As New OdbcCommand("", Conn)
                With Cmd

                    If Val(voorraad_id.Text) = 0 Then   'nieuwe voorraad
                        .CommandText = "INSERT INTO voorraad(naam,voorraad,waarschuwing,minimale_voorraad,aantal_per_pallet,besteltijd,besteld,besteld_datetime," _
                                       & "fust_id1,fust_id2,fust_id3,fust_id4,fust_id5,accessoire_id1,accessoire_id2,accessoire_id3,radiobutton) " _
                                       & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                    Else   'veranderde voorraad 
                        .CommandText = "UPDATE voorraad SET naam=?,voorraad=?,waarschuwing=?,minimale_voorraad=?,aantal_per_pallet=?,besteltijd=?,besteld=?,besteld_datetime=?," _
                                        & "fust_id1=?,fust_id2=?,fust_id3=?,fust_id4=?,fust_id5=?,accessoire_id1=?,accessoire_id2=?,accessoire_id3=?,radiobutton=? " _
                                        & "WHERE id = " + voorraad_id.Text
                    End If

                    .Parameters.Clear()
                    .Parameters.AddWithValue("", voorraad_artikelnaam_txt.Text)
                    .Parameters.AddWithValue("", Val(voorraad_voorraad_txt.Text))
                    If voorraad_waarschuwing_chk.Checked = True Then
                        .Parameters.AddWithValue("", 1)
                    Else
                        .Parameters.AddWithValue("", 0)
                    End If
                    .Parameters.AddWithValue("", Val(voorraad_minimum_txt.Text))
                    .Parameters.AddWithValue("", Val(voorraad_aantalperpallet_txt.Text))
                    .Parameters.AddWithValue("", Val(voorraad_besteltijd_txt.Text))
                    vr_userchange = False
                    If Voorraad_Besteld_chk.Checked = True Then
                        .Parameters.AddWithValue("", 1)
                    Else
                        .Parameters.AddWithValue("", 0)
                    End If
                    vr_userchange = True
                    .Parameters.AddWithValue("", Voorraad_Besteld_chk.Text)

                    .Parameters.AddWithValue("", Val(voorraad_koppelingfust1_cmb.SelectedValue))
                    .Parameters.AddWithValue("", Val(voorraad_koppelingfust2_cmb.SelectedValue))
                    .Parameters.AddWithValue("", Val(voorraad_koppelingfust3_cmb.SelectedValue))
                    .Parameters.AddWithValue("", Val(voorraad_koppelingfust4_cmb.SelectedValue))
                    .Parameters.AddWithValue("", Val(voorraad_koppelingfust5_cmb.SelectedValue))

                    .Parameters.AddWithValue("", Val(voorraad_koppelingacce1_cmb.SelectedValue))
                    .Parameters.AddWithValue("", Val(voorraad_koppelingacce2_cmb.SelectedValue))
                    .Parameters.AddWithValue("", Val(voorraad_koppelingacce3_cmb.SelectedValue))
                    .Parameters.AddWithValue("", voorraad_koppelingfust_radio.Checked)

                    .ExecuteNonQuery()
                End With

                GroupBoxVoorraad.Enabled = False
            End Using
        Catch ex As Exception
            ErrorLog("Voorraad opslaan fout : " + ex.Message)
            MsgBox(ex.Message, MsgBoxStyle.OkOnly)
        End Try
        voorraad_bereken_but_Click(sender, e)
    End Sub

    Private Sub voorraad_koppelingacce_radio_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles voorraad_koppelingacce_radio.CheckedChanged

    End Sub

    Private Sub voorraad_koppelingfust_radio_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles voorraad_koppelingfust_radio.CheckedChanged
        If voorraad_koppelingfust_radio.Checked = True Then
            voorraad_koppelingfust1_cmb.Enabled = True
            voorraad_koppelingfust2_cmb.Enabled = True
            voorraad_koppelingfust3_cmb.Enabled = True
            voorraad_koppelingfust4_cmb.Enabled = True
            voorraad_koppelingfust5_cmb.Enabled = True
            SetComboIndex(voorraad_koppelingacce1_cmb, 0)
            SetComboIndex(voorraad_koppelingacce2_cmb, 0)
            SetComboIndex(voorraad_koppelingacce3_cmb, 0)
            voorraad_koppelingacce1_cmb.Enabled = False
            voorraad_koppelingacce2_cmb.Enabled = False
            voorraad_koppelingacce3_cmb.Enabled = False
        Else
            voorraad_koppelingacce1_cmb.Enabled = True
            voorraad_koppelingacce2_cmb.Enabled = True
            voorraad_koppelingacce3_cmb.Enabled = True
            SetComboIndex(voorraad_koppelingfust1_cmb, 9)
            SetComboIndex(voorraad_koppelingfust2_cmb, 9)
            SetComboIndex(voorraad_koppelingfust3_cmb, 9)
            SetComboIndex(voorraad_koppelingfust4_cmb, 9)
            SetComboIndex(voorraad_koppelingfust5_cmb, 9)
            voorraad_koppelingfust1_cmb.Enabled = False
            voorraad_koppelingfust2_cmb.Enabled = False
            voorraad_koppelingfust3_cmb.Enabled = False
            voorraad_koppelingfust4_cmb.Enabled = False
            voorraad_koppelingfust5_cmb.Enabled = False
        End If
    End Sub

    Private Sub voorraad_bereken_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles voorraad_bereken_but.Click
        Dim flexgridfill(8) As String
        Dim Reader As OdbcDataReader
        Dim CmdString As String = "select * from voorraad order by radiobutton,naam"

        Dim rs As C1.Win.C1FlexGrid.CellStyle
        rs = Voorraad_Flexgrid.Styles.Add("RedColor")
        rs.BackColor = Color.Red

        Dim rs2 As C1.Win.C1FlexGrid.CellStyle
        rs2 = Voorraad_Flexgrid.Styles.Add("OrangeColor")
        rs2.BackColor = Color.Orange

        Dim rs3 As C1.Win.C1FlexGrid.CellStyle
        rs3 = Voorraad_Flexgrid.Styles.Add("YellowColor")
        rs3.BackColor = Color.YellowGreen

        Try
            'Open Connection
            Voorraad_Flexgrid.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'Execute Query
                Dim Cmd As New OdbcCommand(CmdString, Conn)
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read()

                    Dim voorraad As Integer = CHint(Reader("voorraad"))
                    Dim palletgrootte As Integer = CHint(Reader("aantal_per_pallet"))
                    Dim voorraad_in_pallets As Double = voorraad / palletgrootte
                    Dim fust_id1 As Integer = CHint(Reader("fust_id1"))
                    Dim fust_id2 As Integer = CHint(Reader("fust_id2"))
                    Dim fust_id3 As Integer = CHint(Reader("fust_id3"))
                    Dim fust_id4 As Integer = CHint(Reader("fust_id4"))
                    Dim fust_id5 As Integer = CHint(Reader("fust_id5"))
                    Dim besteld As Boolean = CHbool(Reader("besteld"))
                    Dim besteltijd As Integer = CHint(Reader("besteltijd"))
                    Dim accessoire_id1 As Integer = CHint(Reader("accessoire_id1"))
                    Dim accessoire_id2 As Integer = CHint(Reader("accessoire_id2"))
                    Dim accessoire_id3 As Integer = CHint(Reader("accessoire_id3"))

                    Dim minimale_voorraad As Integer = CHint(Reader("minimale_voorraad"))

                    Dim tot_aantal As Integer = 0
                    Dim tot_aantal2 As Integer = 0
                    Dim accessoireflag As Boolean = False
                    If fust_id1 = 9 And fust_id2 = 9 And fust_id3 = 9 And fust_id4 = 9 And fust_id5 = 9 And accessoire_id1 = 0 And accessoire_id2 = 0 And accessoire_id3 = 0 Then
                        tot_aantal = 0 'geen fust of accessoire gekoppeld.. besteld aantal = 0, geen query nodig
                    Else
                        Dim query As String = "SELECT aantal,fust_id FROM orderlines as ol LEFT JOIN orderheaders as oh ON ol.OrderHeader_id=oh.header_id WHERE ("
                        Dim setOr As Boolean = False
                        'fust query
                        If fust_id1 <> 9 Then
                            query = query + "ol.fust_id=" + Str(fust_id1)
                            setOr = True
                        End If
                        If fust_id2 <> 9 Then
                            If setOr = True Then
                                setOr = False
                                query = query + " OR "
                            End If
                            query = query + "ol.fust_id=" + Str(fust_id2)
                            setOr = True
                        End If
                        If fust_id3 <> 9 Then
                            If setOr = True Then
                                setOr = False
                                query = query + " OR "
                            End If
                            query = query + "ol.fust_id=" + Str(fust_id3)
                            setOr = True
                        End If
                        If fust_id4 <> 9 Then
                            If setOr = True Then
                                setOr = False
                                query = query + " OR "
                            End If
                            query = query + "ol.fust_id=" + Str(fust_id4)
                            setOr = True
                        End If
                        If fust_id5 <> 9 Then
                            If setOr = True Then
                                setOr = False
                                query = query + " OR "
                            End If
                            query = query + "ol.fust_id=" + Str(fust_id5)
                            setOr = True
                        End If
                        'accessoire query


                        If accessoire_id1 <> 0 Then
                            If setOr = True Then
                                setOr = False
                                query = query + " OR "
                            End If
                            query = query + "ol.accessoire1=" + Str(accessoire_id1) + " OR ol.accessoire2=" + Str(accessoire_id1)
                            setOr = True
                            accessoireflag = True
                        End If
                        If accessoire_id2 <> 0 Then
                            If setOr = True Then
                                setOr = False
                                query = query + " OR "
                            End If
                            query = query + "ol.accessoire1=" + Str(accessoire_id2) + " OR ol.accessoire2=" + Str(accessoire_id2)
                            setOr = True
                            accessoireflag = True
                        End If
                        If accessoire_id3 <> 0 Then
                            If setOr = True Then
                                setOr = False
                                query = query + " OR "
                            End If
                            query = query + "ol.accessoire1=" + Str(accessoire_id3) + " OR ol.accessoire2=" + Str(accessoire_id3)
                            setOr = True
                            accessoireflag = True
                        End If

                        Dim query2 As String = query 'save for part 2 
                        '4 weken naar voren kijken + status < 41 (sdf klaar)
                        query = query + ") AND (oh.status<41 OR oh.status=98) "
                        query = query + " AND oh.afleverdatum BETWEEN '" + Format(Now, "yyyy-MM-dd") + " 00:00:00' AND '" + Format(DateAdd("d", 28, Now), "yyyy-MM-dd") + " 23:59:59'"

                        'execut query
                        Dim Cmd2 As New OdbcCommand(query, Conn)
                        Dim Reader2 As OdbcDataReader
                        Reader2 = Cmd2.ExecuteReader()

                        Do While Reader2.Read
                            Dim aantal_per_fust As Integer = 1  'default voor fust
                            If accessoireflag = True Then
                                Dim fust_id As Integer = CHint(Reader2("fust_id"))
                                aantal_per_fust = fust(GID(fust, fust_id)).aantal_per_fust
                            End If
                            Dim aantal As Integer = CHint(Reader2("aantal"))
                            tot_aantal = tot_aantal + (aantal * aantal_per_fust)
                        Loop
                        Reader2.Close()

                        'besteltijd naar voren kijken + status < 41 (sdf klaar)
                        query2 = query2 + ") AND (oh.status<41 OR oh.status=98) "
                        query2 = query2 + " AND oh.afleverdatum BETWEEN '" + Format(Now, "yyyy-MM-dd") + " 00:00:00' AND '" + Format(DateAdd("d", (besteltijd * 7) + 7, Now), "yyyy-MM-dd") + " 23:59:59'"

                        'execut query
                        Dim Cmd4 As New OdbcCommand(query2, Conn)
                        Dim Reader4 As OdbcDataReader
                        Reader4 = Cmd4.ExecuteReader()

                        Do While Reader4.Read
                            Dim aantal_per_fust As Integer = 1  'default voor fust
                            If accessoireflag = True Then
                                Dim fust_id As Integer = CHint(Reader4("fust_id"))
                                aantal_per_fust = fust(GID(fust, fust_id)).aantal_per_fust
                            End If
                            Dim aantal As Integer = CHint(Reader4("aantal"))
                            tot_aantal2 = tot_aantal2 + (aantal * aantal_per_fust)
                        Loop
                        Reader4.Close()

                    End If

                    Dim accessoire_fust As Integer = accessoire(GID(accessoire, accessoire_id1)).fust
                    Dim accessoire_aantalperfust As Integer = fust(GID(fust, accessoire_fust)).aantal_per_fust
                    If accessoire_aantalperfust = 0 Then accessoire_aantalperfust = 1

                    Dim voorraad_in_pallets_vrij As Double = (voorraad - tot_aantal) / palletgrootte
                    Dim voorraad_vrij As Integer = voorraad - tot_aantal
                    Dim voorraad_vrij2 As Integer = voorraad - tot_aantal2
                    Dim voorraad_bakken As Integer = Int(voorraad_vrij / accessoire_aantalperfust)
                    flexgridfill(0) = CHstr(Reader("id"))
                    flexgridfill(1) = CHstr(Reader("naam"))
                    flexgridfill(2) = Format(voorraad_in_pallets, "###.0")
                    flexgridfill(3) = voorraad
                    flexgridfill(4) = Str(tot_aantal)
                    flexgridfill(5) = Format(voorraad_in_pallets_vrij, "###.0")
                    flexgridfill(6) = voorraad_vrij
                    If accessoireflag = False Then
                        flexgridfill(7) = ""
                    Else
                        flexgridfill(7) = Str(voorraad_bakken)
                    End If
                    Voorraad_Flexgrid.AddItem(flexgridfill)

                    If voorraad_vrij < minimale_voorraad Then
                        If besteld = True Then
                            Voorraad_Flexgrid.Rows(Voorraad_Flexgrid.Rows.Count - 1).Style = Voorraad_Flexgrid.Styles("YellowColor")
                        Else
                            If voorraad_vrij2 < minimale_voorraad Then
                                Voorraad_Flexgrid.Rows(Voorraad_Flexgrid.Rows.Count - 1).Style = Voorraad_Flexgrid.Styles("RedColor")
                            Else
                                Voorraad_Flexgrid.Rows(Voorraad_Flexgrid.Rows.Count - 1).Style = Voorraad_Flexgrid.Styles("OrangeColor")
                            End If
                        End If

                    End If


                Loop
            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (voorraad)" + ex.Message)
            MessageBox.Show("Database fout: (voorraad)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Private Sub AftellenVoorraad(ByVal AantalFusten As Integer, ByVal GP As Integer, ByVal fust_id As Integer, ByVal accessoire_id1 As Integer, ByVal accessoire_id2 As Integer)
        'geactiveerd in sdf-versturen->create orderline
        If GP = 0 Then GP = 1
        Try
            'Open Connection
            Voorraad_Flexgrid.Rows.Count = 1
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                'fusten
                If fust_id <> 9 Then  'fust is geen n.v.t.
                    'Execute Query

                    Dim sub_aantal As Integer = AantalFusten * GP

                    Dim Reader As OdbcDataReader
                    Dim Cmd As New OdbcCommand("SELECT * FROM voorraad WHERE fust_id1=? OR fust_id2=? OR fust_id3=? OR fust_id4=? OR fust_id5=?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", fust_id)
                    Cmd.Parameters.AddWithValue("", fust_id)
                    Cmd.Parameters.AddWithValue("", fust_id)
                    Cmd.Parameters.AddWithValue("", fust_id)
                    Cmd.Parameters.AddWithValue("", fust_id)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read()
                        Dim id As Integer = CHint(Reader("id"))
                        Dim voorraad As Integer = CHint(Reader("voorraad"))
                        Dim nieuwe_voorraad As Integer = voorraad - sub_aantal
                        Dim Cmd2 As New OdbcCommand("UPDATE voorraad SET voorraad=? WHERE id =?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", nieuwe_voorraad)
                        Cmd2.Parameters.AddWithValue("", id)
                        Cmd2.ExecuteNonQuery()
                    Loop
                End If

                'accesoire 1

                If accessoire_id1 <> 0 Then
                    'Execute Query

                    Dim aantal_per_fust = fust(GID(fust, fust_id)).aantal_per_fust
                    Dim sub_aantal As Integer = AantalFusten * GP * aantal_per_fust

                    Dim Reader As OdbcDataReader
                    Dim Cmd As New OdbcCommand("SELECT * FROM voorraad WHERE accessoire_id1=? OR accessoire_id2=? OR accessoire_id3=?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", accessoire_id1)
                    Cmd.Parameters.AddWithValue("", accessoire_id1)
                    Cmd.Parameters.AddWithValue("", accessoire_id1)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read()
                        Dim id As Integer = CHint(Reader("id"))
                        Dim voorraad As Integer = CHint(Reader("voorraad"))
                        Dim nieuwe_voorraad As Integer = voorraad - sub_aantal
                        Dim Cmd2 As New OdbcCommand("UPDATE voorraad SET voorraad=? WHERE id =?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", nieuwe_voorraad)
                        Cmd2.Parameters.AddWithValue("", id)
                        Cmd2.ExecuteNonQuery()
                    Loop
                End If


                'accesoire 2

                If accessoire_id2 <> 0 Then
                    'Execute Query

                    Dim aantal_per_fust = fust(GID(fust, fust_id)).aantal_per_fust
                    Dim sub_aantal As Integer = AantalFusten * GP * aantal_per_fust

                    Dim Reader As OdbcDataReader
                    Dim Cmd As New OdbcCommand("SELECT * FROM voorraad WHERE accessoire_id1=? OR accessoire_id2=? OR accessoire_id3=?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", accessoire_id2)
                    Cmd.Parameters.AddWithValue("", accessoire_id2)
                    Cmd.Parameters.AddWithValue("", accessoire_id2)
                    Reader = Cmd.ExecuteReader()
                    Do While Reader.Read()
                        Dim id As Integer = CHint(Reader("id"))
                        Dim voorraad As Integer = CHint(Reader("voorraad"))
                        Dim nieuwe_voorraad As Integer = voorraad - sub_aantal
                        Dim Cmd2 As New OdbcCommand("UPDATE voorraad SET voorraad=? WHERE id =?", Conn)
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", nieuwe_voorraad)
                        Cmd2.Parameters.AddWithValue("", id)
                        Cmd2.ExecuteNonQuery()
                    Loop
                End If

            End Using
        Catch ex As Exception
            ErrorLog("Database fout: (voorraad)" + ex.Message)
            MessageBox.Show("Database fout: (voorraad)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub
    Dim vr_userchange As Boolean = True
    Private Sub Voorraad_Besteld_chk_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Voorraad_Besteld_chk.CheckedChanged
        If vr_userchange = True Then
            Voorraad_Besteld_chk.Text = Format(Now, "yyyy-MM-dd")
        End If
    End Sub

    Private Sub Voorraad_aanpassen_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Voorraad_aanpassen_but.Click


        Dim i As Integer
        Dim id As Integer = -1
        If Voorraad_Flexgrid.Rows.Count > 1 Then
            For i = 1 To Voorraad_Flexgrid.Rows.Count - 1
                If Voorraad_Flexgrid.Rows(i).Selected = True Then
                    id = Voorraad_Flexgrid.Item(i, 0)
                    Exit For
                End If
            Next i
            If id = -1 Then Exit Sub

            voorraad_nieuw_but.Enabled = False
            Voorraad_aanpassen_but.Enabled = False
            voorraad_bereken_but.Enabled = False

            Dim flexgridfill(9) As String
            Dim Reader As OdbcDataReader

            Try
                'Open Connection
                DatabaseFlexGridShow.Rows.Count = 1
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    'Execute Query
                    Dim Cmd As New OdbcCommand("select * from voorraad where id=?", Conn)
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", id)
                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()


                        GroupBoxVoorraad.Enabled = True

                        voorraad_artikelnaam_txt.Text = CHstr(Reader("naam"))
                        voorraad_artikelnaam_txt.Focus()

                        voorraad_inkoopstuks_txt.Text = "0"
                        voorraad_inkooppallets_txt.Text = "0"
                        voorraad_voorraad_txt.Text = CHstr(Reader("voorraad"))
                        voorraad_waarschuwing_chk.Checked = CHbool(Reader("waarschuwing"))
                        voorraad_minimum_txt.Text = CHstr(Reader("minimale_voorraad"))
                        voorraad_aantalperpallet_txt.Text = CHstr(Reader("aantal_per_pallet"))
                        voorraad_besteltijd_txt.Text = CHstr(Reader("besteltijd"))
                        vr_userchange = False
                        Voorraad_Besteld_chk.Checked = CHbool(Reader("besteld"))
                        vr_userchange = True
                        Voorraad_Besteld_chk.Text = Format(CType(Reader("besteld_datetime"), Date), "yyyy-MM-dd")
                        Dim radiobutton As Boolean = CHbool(Reader("radiobutton"))
                        If radiobutton = True Then
                            voorraad_koppelingfust_radio.Checked = True
                            voorraad_koppelingacce_radio.Checked = False
                        Else
                            voorraad_koppelingfust_radio.Checked = False
                            voorraad_koppelingacce_radio.Checked = True
                        End If

                        Dim bindingsource1 As New BindingSource
                        bindingsource1.DataSource = dt_fust
                        voorraad_koppelingfust1_cmb.DataSource = bindingsource1
                        voorraad_koppelingfust1_cmb.DisplayMember = "desc"
                        voorraad_koppelingfust1_cmb.ValueMember = "ID"
                        voorraad_koppelingfust1_cmb.DropDownStyle = ComboBoxStyle.DropDownList

                        Dim bindingsource2 As New BindingSource
                        bindingsource2.DataSource = dt_fust
                        voorraad_koppelingfust2_cmb.DataSource = bindingsource2
                        voorraad_koppelingfust2_cmb.DisplayMember = "desc"
                        voorraad_koppelingfust2_cmb.ValueMember = "ID"
                        voorraad_koppelingfust2_cmb.DropDownStyle = ComboBoxStyle.DropDownList

                        Dim bindingsource3 As New BindingSource
                        bindingsource3.DataSource = dt_fust
                        voorraad_koppelingfust3_cmb.DataSource = bindingsource3
                        voorraad_koppelingfust3_cmb.DisplayMember = "desc"
                        voorraad_koppelingfust3_cmb.ValueMember = "ID"
                        voorraad_koppelingfust3_cmb.DropDownStyle = ComboBoxStyle.DropDownList

                        Dim bindingsource4 As New BindingSource
                        bindingsource4.DataSource = dt_fust
                        voorraad_koppelingfust4_cmb.DataSource = bindingsource4
                        voorraad_koppelingfust4_cmb.DisplayMember = "desc"
                        voorraad_koppelingfust4_cmb.ValueMember = "ID"
                        voorraad_koppelingfust4_cmb.DropDownStyle = ComboBoxStyle.DropDownList

                        Dim bindingsource5 As New BindingSource
                        bindingsource5.DataSource = dt_fust
                        voorraad_koppelingfust5_cmb.DataSource = bindingsource5
                        voorraad_koppelingfust5_cmb.DisplayMember = "desc"
                        voorraad_koppelingfust5_cmb.ValueMember = "ID"
                        voorraad_koppelingfust5_cmb.DropDownStyle = ComboBoxStyle.DropDownList

                        Dim bindingsource6 As New BindingSource
                        bindingsource6.DataSource = dt_accessoire
                        voorraad_koppelingacce1_cmb.DataSource = bindingsource6
                        voorraad_koppelingacce1_cmb.DisplayMember = "desc"
                        voorraad_koppelingacce1_cmb.ValueMember = "ID"
                        voorraad_koppelingacce1_cmb.DropDownStyle = ComboBoxStyle.DropDownList

                        Dim bindingsource7 As New BindingSource
                        bindingsource7.DataSource = dt_accessoire
                        voorraad_koppelingacce2_cmb.DataSource = bindingsource7
                        voorraad_koppelingacce2_cmb.DisplayMember = "desc"
                        voorraad_koppelingacce2_cmb.ValueMember = "ID"
                        voorraad_koppelingacce2_cmb.DropDownStyle = ComboBoxStyle.DropDownList

                        Dim bindingsource8 As New BindingSource
                        bindingsource8.DataSource = dt_accessoire
                        voorraad_koppelingacce3_cmb.DataSource = bindingsource8
                        voorraad_koppelingacce3_cmb.DisplayMember = "desc"
                        voorraad_koppelingacce3_cmb.ValueMember = "ID"
                        voorraad_koppelingacce3_cmb.DropDownStyle = ComboBoxStyle.DropDownList

                        SetComboIndex(voorraad_koppelingfust1_cmb, CHint(Reader("fust_id1")))
                        SetComboIndex(voorraad_koppelingfust2_cmb, CHint(Reader("fust_id2")))
                        SetComboIndex(voorraad_koppelingfust3_cmb, CHint(Reader("fust_id3")))
                        SetComboIndex(voorraad_koppelingfust4_cmb, CHint(Reader("fust_id4")))
                        SetComboIndex(voorraad_koppelingfust5_cmb, CHint(Reader("fust_id5")))

                        SetComboIndex(voorraad_koppelingacce1_cmb, CHint(Reader("accessoire_id1")))
                        SetComboIndex(voorraad_koppelingacce2_cmb, CHint(Reader("accessoire_id2")))
                        SetComboIndex(voorraad_koppelingacce3_cmb, CHint(Reader("accessoire_id3")))

                        voorraad_id.Text = Str(id)

                    End If
                End Using
            Catch ex As Exception
                ErrorLog("Database fout: (voorraad)" + ex.Message)
                MessageBox.Show("Database fout: (voorraad)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try


        End If
    End Sub

    Private Sub voorraad_inkooppallets_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles voorraad_inkooppallets_but.Click
        Dim aantal_pallets = voorraad_inkooppallets_txt.Text
        voorraad_inkooppallets_txt.Text = 0
        Dim aantal_per_pallet As Integer = Val(voorraad_aantalperpallet_txt.Text)
        Dim oude_voorraad As Integer = Val(voorraad_voorraad_txt.Text)
        Dim add_voorraad As Integer = aantal_per_pallet * aantal_pallets
        Dim nieuwe_voorraad = oude_voorraad + add_voorraad
        voorraad_voorraad_txt.Text = Str(nieuwe_voorraad)
    End Sub

    Private Sub voorraad_inkoopstuks_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles voorraad_inkoopstuks_but.Click
        Dim oude_voorraad As Integer = Val(voorraad_voorraad_txt.Text)
        Dim add_voorraad As Integer = Val(voorraad_inkoopstuks_txt.Text)
        voorraad_inkoopstuks_txt.Text = 0
        Dim nieuwe_voorraad = oude_voorraad + add_voorraad
        voorraad_voorraad_txt.Text = Str(nieuwe_voorraad)
    End Sub

    Private Sub voorraad_annuleer_but_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles voorraad_annuleer_but.Click
        GroupBoxVoorraad.Enabled = False
        voorraad_nieuw_but.Enabled = True
        Voorraad_aanpassen_but.Enabled = True
        voorraad_bereken_but.Enabled = True
    End Sub
#End Region

#Region "General subs"
    Public Sub AutoComplete(ByRef cb As ComboBox, ByVal e As System.Windows.Forms.KeyPressEventArgs, Optional ByVal blnLimitToList As Boolean = False)
        Dim strFindStr As String

        If e.KeyChar = Chr(8) Then  'Backspace
            If cb.SelectionStart <= 1 Then
                cb.Text = ""
                Exit Sub
            End If
            : If cb.SelectionLength = 0 Then
                : strFindStr = cb.Text.Substring(0, cb.Text.Length - 1)
                : Else
                : strFindStr = cb.Text.Substring(0, cb.SelectionStart - 1)
                : End If
            : Else
            : If cb.SelectionLength = 0 Then
                : strFindStr = cb.Text & e.KeyChar
            Else
                strFindStr = cb.Text.Substring(0, cb.SelectionStart) & e.KeyChar
            End If
        End If

        Dim intIdx As Integer = -1

        ' Search the string in the Combo Box List.
        intIdx = cb.FindString(strFindStr)

        If intIdx <> -1 Then ' String found in the List.
            cb.SelectedText = ""
            cb.SelectedIndex = intIdx
            cb.SelectionStart = strFindStr.Length
            cb.SelectionLength = cb.Text.Length
            e.Handled = True
        Else
            If blnLimitToList = True Then
                e.Handled = True
            Else
                e.Handled = False
            End If
        End If
    End Sub

    Private Function GetColorString(ByVal colorObj As System.Drawing.Color) As String
        Return "#" & Hex(colorObj.R) & Hex(colorObj.G) & Hex(colorObj.B)
    End Function

    Private Function GetColorValue(ByVal hexstring As String) As System.Drawing.Color
        Dim clr As Color = ColorTranslator.FromHtml(hexstring)
        Return clr
    End Function

    Public Shared Function StrToByteArray(ByVal str As String) As Byte()
        Dim encoding As New System.Text.UTF8Encoding()
        Return encoding.GetBytes(str)
    End Function

    Public Sub ErrorLog(ByVal ErrorStr As String)
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim cmdstring As String = "SELECT * FROM boek_errors where 1=0"
                Dim Cmd2 As New OdbcCommand(cmdstring, Conn)

                Cmd2.CommandText = "INSERT INTO boek_errors(datumtijd,error,inlognaam) VALUES(?,?,?)"
                Cmd2.Parameters.Clear()
                Cmd2.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                Cmd2.Parameters.AddWithValue("", Mid(ErrorStr, 1, 999))
                Cmd2.Parameters.AddWithValue("", Mid(Login_name, 1, 29))
                Cmd2.ExecuteNonQuery()

            End Using
        Catch ex As Exception
            MessageBox.Show("Errorlog :" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Public Function CheckDBNull(ByVal obj As Object, Optional ByVal ObjectType As enumObjectType = enumObjectType.StrType) As Object
        Dim objReturn As Object
        objReturn = obj
        If ObjectType = enumObjectType.StrType And IsDBNull(obj) Then
            objReturn = ""
        ElseIf ObjectType = enumObjectType.IntType And IsDBNull(obj) Then
            objReturn = 0
        ElseIf ObjectType = enumObjectType.DblType And IsDBNull(obj) Then
            objReturn = 0.0
        End If
        Return objReturn
    End Function

    Public Function CVal(ByVal DoubleString As String) As Double
        Dim result As Double = 0
        If InStr(DoubleString, ".") = 0 Then

            If Double.TryParse(DoubleString, Globalization.NumberStyles.Float, New Globalization.CultureInfo("nl-NL"), result) Then
                Return result
            Else
                MsgBox("Could not convert double")
                Return 0
            End If
        Else
            result = Val(DoubleString)
            Return result
        End If

    End Function

    Private Sub _flex_SetupEditor(ByVal sender As System.Object, ByVal e As C1.Win.C1FlexGrid.RowColEventArgs) Handles Order_invoer_FlexGrid.SetupEditor



        Dim cb As ComboBox = TryCast(Order_invoer_FlexGrid.Editor, System.Windows.Forms.ComboBox)
        If cb Is Nothing Then
        Else
            cb.MaxDropDownItems = 25
        End If


    End Sub
#End Region

#Region "FloridayOrders"

    Private Sub FloridayOrders_flx_Click(sender As Object, e As EventArgs) Handles FloridayOrders_flx.Click
        Dim selectedcol As Integer = FloridayOrders_flx.ColSel
        Dim selectedrow As Integer = FloridayOrders_flx.RowSel
        Dim boektijdcol As Integer = FindCol(FloridayOrders_flx, "Boek datum/tijd")

        If selectedrow >= 1 And selectedcol <> boektijdcol Then
            CheckOrderlines(True, selectedrow)
        End If
    End Sub

    Private Sub FloridayOrderLines_flx_Click(sender As Object, e As EventArgs) Handles FloridayOrderLines_flx.Click

        Dim selectedcol As Integer = FloridayOrderLines_flx.ColSel
        Dim selectedrow As Integer = FloridayOrderLines_flx.RowSel


        Dim wpscol As Integer = FindCol(FloridayOrderLines_flx, "wpsfilter")
        If selectedcol = wpscol Then
            FillWpsFilterCombo(selectedrow, selectedcol)

        End If


        If selectedrow >= 1 Then
            ShowOrderInfo(FloridayOrderLines_flx.Item(selectedrow, 0))
        End If
    End Sub

    Private Sub FillWpsFilterCombo(selectedrow As Integer, selectedcol As Integer)
        Dim style As C1.Win.C1FlexGrid.CellStyle = Fc_Flexgrid_LineData.Styles.Add("newGridStyle")
        FDLineCombo.DataMode = C1.Win.C1List.DataModeEnum.Normal

        Dim dt_fd As New DataTable
        dt_fd.Columns.Add("Naam", GetType(String))
        dt_fd.Columns.Add("Code", GetType(String))

        Dim cn() As String = New String() {"Naam", "Code"}
        dt_fd.Clear()

        '*********** LIJST GENEREREN **************************

        Dim soortcol As Integer = FindCol(FloridayOrderLines_flx, "soort")
        Dim soort_id As Integer = CInt(FloridayOrderLines_flx.Item(selectedrow, soortcol))


        If soort_id < 10000 Then   'niet bij mixen
            Dim wps_soort_id = soorten(GID(soorten, soort_id)).wps_code
            Dim potmaat = soorten(GID(soorten, soort_id)).potmaat

            Dim filterfound As Boolean = False
            For i = 0 To UBound(wpsfilter)
                If potmaat = 190 Then potmaat = 170
                If wps_soort_id = wpsfilter(i).wps_soortnummer And potmaat = wpsfilter(i).potmaat Then
                    dt_fd.Rows.Add(New String() {wpsfilter(i).filternaam, wpsfilter(i).filternummer})
                End If
            Next i
            If filterfound = False And soort_id < 10000 Then
                dt_fd.Rows.Add(New String() {999999, "Niet via WPS"})
            End If

            FDLineCombo.DataSource = dt_fd
            FDLineCombo.DisplayMember = "Naam"
            FDLineCombo.ValueMember = "Code"
            FDLineCombo.Splits(0).DisplayColumns(1).Visible = False  ' id
            FDLineCombo.ComboStyle = 2  'combo style list

            FDLineCombo.DropDownWidth = 400
            FDLineCombo.ColumnWidth = 390
            FDLineCombo.MaxDropDownItems = 15

            style.Editor = FDLineCombo
            FloridayOrderLines_flx.SetCellStyle(selectedrow, selectedcol, style)
            '  FloridayOrderLines_flx.StartEditing(selectedrow, 2)

            '' FDLineCombo.DroppedDown = True

            ' CODE OPSLAAN NAAST NAAM
        End If


    End Sub

    Private Function CheckOrderlines(show As Boolean, selectedrow As Integer) As Integer
        Dim warningcode As Integer = 0

        If show = True Then
            FloridayOrderLines_flx.Rows.Count = 1
            fd_orderlinetable = BuildTable("floridayorderlines", FloridayOrderLines_flx)
            ClearStyles(FloridayOrderLines_flx)
        End If

        Dim idlist As String = CStr(FloridayOrders_flx.GetData(selectedrow, FindCol(FloridayOrders_flx, "idlist")))
        Dim ids() As String = idlist.Split(New Char() {";"c})

        Dim query As String = ""
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand(query, Conn)
                Dim Reader As OdbcDataReader

                Dim Cmd2 As New OdbcCommand(query, Conn)
                Dim Reader2 As OdbcDataReader

                Dim Cmd3 As New OdbcCommand(query, Conn)
                Dim Reader3 As OdbcDataReader

                Dim Cmd4 As New OdbcCommand(query, Conn)
                Dim Reader4 As OdbcDataReader

                For idloop = 0 To UBound(ids)                     'Execute Query
                    query = "SELECT * FROM floriday_salesorders WHERE id=?"
                    Cmd.Parameters.Clear()
                    Cmd.Parameters.AddWithValue("", ids(idloop))
                    Cmd.CommandText = query
                    Reader = Cmd.ExecuteReader()
                    If Reader.HasRows Then
                        Reader.Read()
                        Dim parent_id As Integer = CHint(Reader("id"))
                        Dim orderLineId As String = CHstr(Reader("orderLineId"))
                        Dim salesChannelOrderId As String = CHstr(Reader("salesChannelOrderId"))
                        Dim customerOrderId As String = CHstr(Reader("customerOrderId"))
                        Dim customerOrganizationId As String = CHstr(Reader("customerOrganizationId"))
                        Dim supplyLineId As String = CHstr(Reader("supplyLineId"))
                        Dim tradeItemId As String = CHstr(Reader("tradeItemId"))
                        Dim salesChannel As String = CHstr(Reader("salesChannel"))
                        Dim numberOfPieces As Integer = CHint(Reader("numberOfPieces"))
                        Dim tradeInstrument As String = CHstr(Reader("tradeInstrument"))
                        Dim selectedPackingConfiguration_piecesPerPackage As Integer = CHint(Reader("selectedPackingConfiguration_piecesPerPackage"))
                        Dim selectedPackingConfiguration_bunchesPerPackage As Integer = CHint(Reader("selectedPackingConfiguration_bunchesPerPackage"))
                        Dim selectedPackingConfiguration_package_vbnPackageCode As Integer = CHint(Reader("selectedPackingConfiguration_package_vbnPackageCode"))
                        Dim selectedPackingConfiguration_package_customPackageId As String = CHstr(Reader("selectedPackingConfiguration_package_customPackageId"))
                        Dim selectedPackingConfiguration_loadCarrier As String = CHstr(Reader("selectedPackingConfiguration_loadCarrier"))
                        Dim selectedPackingConfiguration_additionalPricePerPiece_currency As String = CHstr(Reader("selectedPackingConfiguration_additionalPricePerPiece_currency"))
                        Dim selectedPackingConfiguration_additionalPricePerPiece_value As Double = CHdouble(Reader("selectedPackingConfiguration_additionalPricePerPiece_value"))
                        Dim selectedPackingConfiguration_photoUrl As String = CHstr(Reader("selectedPackingConfiguration_photoUrl"))
                        Dim orderDateTime As DateTime = CHDate2(Reader("orderDateTime"), Now)
                        Dim pricePerPiece_currency As String = CHstr(Reader("pricePerPiece_currency"))
                        Dim pricePerPiece_value As Double = CHdouble(Reader("pricePerPiece_value"))
                        Dim delivery_deliveryConditionId As String = CHstr(Reader("delivery_deliveryConditionId"))
                        Dim delivery_latestDeliveryDateTime As DateTime = CHDate2(Reader("delivery_latestDeliveryDateTime"), Now)
                        Dim delivery_regionGln As String = CHstr(Reader("delivery_regionGln"))
                        Dim delivery_location_gln As String = CHstr(Reader("delivery_location_gln"))
                        Dim delivery_location_address_addressLine As String = CHstr(Reader("delivery_location_address_addressLine"))
                        Dim delivery_location_address_city As String = CHstr(Reader("delivery_location_address_city"))
                        Dim delivery_location_address_countryCode As String = CHstr(Reader("delivery_location_address_countryCode"))
                        Dim delivery_location_address_postalCode As String = CHstr(Reader("delivery_location_address_postalCode"))
                        Dim delivery_location_address_stateOrProvince As String = CHstr(Reader("delivery_location_address_stateOrProvince"))
                        Dim cancellationDeadline As DateTime = CHDate2(Reader("cancellationDeadline"), Now)
                        Dim deliveryRemarks As String = CHstr(Reader("deliveryRemarks"))

                        Dim contractId As String = CHstr(Reader("contractId"))
                        Dim blanketOrderLineId As String = CHstr(Reader("blanketOrderLineId"))

                        'package prijs erbij optellen
                        If selectedPackingConfiguration_additionalPricePerPiece_value > 0 Then
                            pricePerPiece_value = pricePerPiece_value + selectedPackingConfiguration_additionalPricePerPiece_value
                        End If

                        'additional service ophalen en bij prijs toevoegen
                        query = "SELECT * FROM floriday_salesorders_additionalservices WHERE parent_Id=" + Str(parent_id)
                        Cmd2.CommandText = query
                        Reader2 = Cmd2.ExecuteReader()
                        Do While Reader2.Read()
                            Dim addservice_price_value As Double = CHdouble(Reader2("price_value"))
                            If addservice_price_value > 0 Then
                                pricePerPiece_value = pricePerPiece_value + addservice_price_value
                            End If
                        Loop
                        Reader2.Close()



                        Dim contractTitle As String = "" 'bij contract title ophalen
                        If contractId <> "" Then
                            query = "SELECT * FROM floriday_contracts WHERE contractId='" + contractId + "'"
                            Cmd2.CommandText = query
                            Reader2 = Cmd2.ExecuteReader()
                            If Reader2.HasRows Then
                                Reader2.Read()
                                contractTitle = CHstr(Reader2("title"))
                            End If
                            Reader2.Close()
                        End If

                        If deliveryRemarks <> "" Then  'erase delivery remark if found in filter
                            query = "SELECT * FROM floriday_salesorders_opmerkingfilter WHERE koper_uid='" + customerOrganizationId + "' AND opmerking=?"
                            Cmd2.CommandText = query
                            Cmd2.Parameters.Clear()
                            Cmd2.Parameters.AddWithValue("", deliveryRemarks)
                            Reader2 = Cmd2.ExecuteReader()
                            If Reader2.HasRows Then
                                deliveryRemarks = ""
                            End If
                            Reader2.Close()
                        End If

                        Dim status As String = CHstr(Reader("status"))
                        Dim tradeItemName As String = "Onbekend"
                        query = "SELECT tradeItemName_nl FROM floriday_tradeitem WHERE tradeItemId='" + tradeItemId + "'"
                        Cmd2.CommandText = query
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()
                            tradeItemName = CHstr(Reader2("tradeItemName_nl"))
                        End If
                        Reader2.Close()

                        Dim fd_koper_ean As String = ""
                        Dim niet_accumuleren As Boolean = False
                        query = "SELECT * FROM floriday_organizations WHERE organizationId='" + customerOrganizationId + "'"
                        Cmd2.CommandText = query
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            fd_koper_ean = CHstr(Reader2("companyGln"))
                        End If
                        Reader2.Close()

                        query = "SELECT * FROM klanten where ean = " + fd_koper_ean
                        Cmd2.CommandText = query
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            niet_accumuleren = CHbool(Reader2("nietaccumuleren"))
                        End If
                        Reader2.Close()

                        Dim soort_id As Integer = 0
                        Dim fust_id As Integer = 0
                        Dim hoes_id As Integer = 0
                        Dim accessoire1 As Integer = 0
                        Dim accessoire2 As Integer = 0
                        Dim accessoire3 As Integer = 0
                        Dim accessoire4 As Integer = 0
                        Dim accessoire5 As Integer = 0
                        Dim accessoire6 As Integer = 0
                        Dim accessoire7 As Integer = 0
                        Dim accessoire8 As Integer = 0
                        Dim decorum As Boolean = False


                        Dim soortwarning As Integer = 0
                        Dim fustwarning As Integer = 0
                        Dim hoeswarning As Integer = 0
                        Dim acce1warning As Integer = 0
                        Dim acce2warning As Integer = 0
                        Dim acce3warning As Integer = 0
                        Dim acce4warning As Integer = 0
                        Dim acce5warning As Integer = 0
                        Dim acce6warning As Integer = 0
                        Dim acce7warning As Integer = 0
                        Dim acce8warning As Integer = 0
                        Dim opmerkingwarning As Integer = 0
                        Dim filterstoegepast As String = ""

                        'preset data ophalen voor tradeitem

                        query = "SELECT * FROM floriday_tradeitem_boek WHERE tradeItemId='" + tradeItemId + "'"
                        Cmd2.CommandText = query
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()
                            soort_id = CHint(Reader2("boek_soortcode"))      '<- nog wel omrekenen naar andere mix als er ander fust is gegeven
                            hoes_id = CHint(Reader2("boek_hoes"))
                            accessoire1 = CHint(Reader2("boek_accessoire1"))
                            accessoire2 = CHint(Reader2("boek_accessoire2"))
                            accessoire3 = CHint(Reader2("boek_accessoire3"))
                            accessoire4 = CHint(Reader2("boek_accessoire4"))
                            decorum = CHbool(Reader2("decorum"))
                        Else
                            soortwarning = 1
                            fustwarning = 1
                        End If
                        Reader2.Close()
                        ' soort via interne code (voor mixen)
                        Dim soortfound As Boolean = False
                        Dim fustfound As Boolean = False

                        If soort_id >= 10000 Then
                            Dim interne_code As String = mixen(GID(mixen, soort_id - 10000)).interne_code
                            fust_id = mixen(GID(mixen, soort_id - 10000)).fust
                            If fust(GID(fust, fust_id)).fustcode_florecom <> selectedPackingConfiguration_package_vbnPackageCode Then
                                For i = 0 To UBound(mixen)
                                    Dim mixfustid = mixen(i).fust
                                    If mixen(i).interne_code = interne_code Then
                                        If fust(GID(fust, mixfustid)).fustcode_florecom = selectedPackingConfiguration_package_vbnPackageCode Then
                                            If fust(GID(fust, mixfustid)).aantal_per_fust = selectedPackingConfiguration_piecesPerPackage Then
                                                soort_id = mixen(i).id + 10000
                                                fust_id = mixen(i).fust
                                                soortfound = True
                                                fustfound = True
                                                Exit For
                                            End If
                                        End If
                                    End If
                                Next
                                If soortfound = False Then
                                    soort_id = 0
                                    fust_id = 0
                                End If
                            Else
                                soortfound = True
                                fustfound = True
                            End If
                        Else
                            'soort actief?
                            For i = 0 To UBound(soorten)
                                If soorten(i).actief = True And soorten(i).id = soort_id Then
                                    soortfound = True
                                    Exit For
                                End If
                            Next
                            'gewone soort / fust bepalen
                            If decorum = True Then    'deco fust zoeken
                                For i = 1 To UBound(fust)
                                    If fust(i).decorum = True And fust(i).fustcode = selectedPackingConfiguration_package_vbnPackageCode Then
                                        fustfound = True
                                        fust_id = fust(i).id
                                        Exit For
                                    End If
                                Next
                            End If
                            If fustfound = False Then   'normaal fust zoeken
                                For i = 1 To UBound(fust)
                                    If fust(i).fustcode = selectedPackingConfiguration_package_vbnPackageCode And fust(i).decorum = False Then  'niet decorum fust zoeken
                                        fustfound = True
                                        fust_id = fust(i).id
                                        Exit For
                                    End If
                                Next
                            End If
                            If fustfound = False Then   'nogmaals al het fust zoeken
                                For i = 1 To UBound(fust)
                                    If fust(i).fustcode = selectedPackingConfiguration_package_vbnPackageCode Then  'al het fust doorzoeken, deco of niet deco
                                        fustfound = True
                                        fust_id = fust(i).id
                                        Exit For
                                    End If
                                Next
                            End If


                        End If
                        If fustfound = False Then fustwarning = 1
                        If soortfound = False Then soortwarning = 1

                        If selectedPackingConfiguration_additionalPricePerPiece_value < 0 Then selectedPackingConfiguration_additionalPricePerPiece_value = 0
                        Dim prijs As Double = pricePerPiece_value + selectedPackingConfiguration_additionalPricePerPiece_value


                        ' aanbod lijn ophalen voor referentie
                        Dim agreementReference_code As String = ""
                        Dim agreementReference_description As String = ""
                        query = "SELECT * FROM floriday_supply WHERE supplyLineId='" + supplyLineId + "'"
                        Cmd2.CommandText = query
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()
                            agreementReference_code = CHstr(Reader2("agreementReference_code"))
                            agreementReference_description = CHstr(Reader2("agreementReference_description"))
                        End If
                        Reader2.Close()


                        'additional services
                        Dim stikkerstatus As Integer = 0
                        query = "SELECT * FROM floriday_salesorders_additionalservices WHERE parent_id=?"
                        Cmd3.CommandText = query
                        Cmd3.Parameters.Clear()
                        Cmd3.Parameters.AddWithValue("", ids(idloop))
                        Reader3 = Cmd3.ExecuteReader()
                        Do While Reader3.Read
                            Dim additionalServiceId As String = CHstr(Reader3("additionalServiceId"))
                            Dim price_currency As String = CHstr(Reader3("price_currency"))
                            Dim price_value As Double = CHdouble(Reader3("price_value"))
                            Dim unit As String = CHstr(Reader3("unit"))
                            If unit = "PIECE" Then
                                prijs = prijs + price_value
                            End If

                            query = "SELECT * FROM floriday_additionalservices_boek WHERE additionalServiceId='" + additionalServiceId + "'"
                            Cmd4.CommandText = query
                            Reader4 = Cmd4.ExecuteReader()
                            If Reader4.HasRows Then
                                Reader4.Read()
                                Dim as_accessoire1 As Integer = CHint(Reader4("boek_accessoire1"))
                                Dim as_accessoire2 As Integer = CHint(Reader4("boek_accessoire2"))
                                Dim ordernietverwerken As Boolean = CHbool(Reader4("ordernietverwerken"))
                                Dim labelstatus As Integer = CHint(Reader4("labelstatus"))
                                If labelstatus > 0 Then stikkerstatus = labelstatus
                                If as_accessoire1 > 0 Then
                                    If accessoire1 = 0 Then
                                        accessoire1 = as_accessoire1
                                        If ordernietverwerken = True Then acce1warning = 1
                                    ElseIf accessoire2 = 0 Then
                                        accessoire2 = as_accessoire1
                                        If ordernietverwerken = True Then acce2warning = 1
                                    ElseIf accessoire3 = 0 Then
                                        accessoire3 = as_accessoire1
                                        If ordernietverwerken = True Then acce3warning = 1
                                    ElseIf accessoire4 = 0 Then
                                        accessoire4 = as_accessoire1
                                        If ordernietverwerken = True Then acce4warning = 1
                                    ElseIf accessoire5 = 0 Then
                                        accessoire5 = as_accessoire1
                                        If ordernietverwerken = True Then acce5warning = 1
                                    ElseIf accessoire6 = 0 Then
                                        accessoire6 = as_accessoire1
                                        If ordernietverwerken = True Then acce6warning = 1
                                    ElseIf accessoire7 = 0 Then
                                        accessoire7 = as_accessoire1
                                        If ordernietverwerken = True Then acce7warning = 1
                                    ElseIf accessoire8 = 0 Then
                                        accessoire8 = as_accessoire1
                                        If ordernietverwerken = True Then acce8warning = 1
                                    Else
                                        acce8warning = 1
                                    End If
                                End If
                                If as_accessoire2 > 0 Then
                                    If accessoire1 = 0 Then
                                        accessoire1 = as_accessoire2
                                        If ordernietverwerken = True Then acce1warning = 1
                                    ElseIf accessoire2 = 0 Then
                                        accessoire2 = as_accessoire2
                                        If ordernietverwerken = True Then acce2warning = 1
                                    ElseIf accessoire3 = 0 Then
                                        accessoire3 = as_accessoire2
                                        If ordernietverwerken = True Then acce3warning = 1
                                    ElseIf accessoire4 = 0 Then
                                        accessoire4 = as_accessoire2
                                        If ordernietverwerken = True Then acce4warning = 1
                                    ElseIf accessoire5 = 0 Then
                                        accessoire5 = as_accessoire2
                                        If ordernietverwerken = True Then acce5warning = 1
                                    ElseIf accessoire6 = 0 Then
                                        accessoire6 = as_accessoire2
                                        If ordernietverwerken = True Then acce6warning = 1
                                    ElseIf accessoire7 = 0 Then
                                        accessoire7 = as_accessoire2
                                        If ordernietverwerken = True Then acce7warning = 1
                                    ElseIf accessoire8 = 0 Then
                                        accessoire8 = as_accessoire2
                                        If ordernietverwerken = True Then acce8warning = 1
                                    Else
                                        acce8warning = 1
                                    End If
                                End If
                            End If
                            Reader4.Close()
                        Loop
                        Reader3.Close()

                        Dim Aantal As Integer = CInt(numberOfPieces / selectedPackingConfiguration_piecesPerPackage)
                        Dim xapf As Integer = selectedPackingConfiguration_piecesPerPackage


                        Dim opmerking As String = deliveryRemarks
                        Dim stikkercode As Integer = 0
                        Dim wpsfilter As Integer = 0
                        Dim boekstatus As Integer = 0
                        Dim selectie As Boolean = True
                        'Opslaan orderinfo voor edits.


                        query = "SELECT * FROM floriday_salesorders_boek WHERE orderLineId='" + orderLineId + "'"
                        Cmd2.CommandText = query
                        Reader2 = Cmd2.ExecuteReader()
                        If Reader2.HasRows Then
                            Reader2.Read()  'oude data ophalen
                            Dim testsoort_id As Integer = CHint(Reader2("boek_soortId"))
                            If testsoort_id > 0 Then  'als soort_id = 0 -> kans geven nieuwe definitie aan te maken en de volgende keer wel bekend
                                soort_id = testsoort_id
                                hoes_id = CHint(Reader2("boek_hoesId"))
                                accessoire1 = CHint(Reader2("boek_accessoire1"))
                                accessoire2 = CHint(Reader2("boek_accessoire2"))
                                accessoire3 = CHint(Reader2("boek_accessoire3"))
                                accessoire4 = CHint(Reader2("boek_accessoire4"))
                                accessoire5 = CHint(Reader2("boek_accessoire5"))
                                accessoire6 = CHint(Reader2("boek_accessoire6"))
                                accessoire7 = CHint(Reader2("boek_accessoire7"))
                                accessoire8 = CHint(Reader2("boek_accessoire8"))
                                opmerking = CHstr(Reader2("boek_opmerking"))
                                wpsfilter = CHint(Reader2("boek_wpsfilter"))
                                boekstatus = CHint(Reader2("boek_status"))
                                fust_id = CHint(Reader2("boek_fustid"))
                                stikkercode = CHint(Reader2("boek_stikkercode"))
                                stikkerstatus = CHint(Reader2("boek_stikkerstatus"))
                                filterstoegepast = CHstr(Reader2("filterstoegepast"))
                                selectie = CHbool(Reader2("selectie"))
                                Reader2.Close()
                            Else
                                Reader2.Close()
                                query = "UPDATE floriday_salesorders_boek SET boek_soortId=?,boek_hoesId=?,boek_accessoire1=?," _
                                              & "boek_accessoire2=?,boek_accessoire3=?,boek_accessoire4=?,boek_accessoire5=?,boek_accessoire6=?,boek_accessoire7=?," _
                                              & "boek_accessoire8=?,boek_opmerking=?,boek_wpsfilter=?,boek_status=?,boek_fustid=?,boek_stikkercode=?,selectie=?" _
                                              & " WHERE orderLineId=?"
                                Cmd2.CommandText = query
                                Cmd2.Parameters.Clear()
                                Cmd2.Parameters.AddWithValue("", soort_id)
                                Cmd2.Parameters.AddWithValue("", hoes_id)
                                Cmd2.Parameters.AddWithValue("", accessoire1)
                                Cmd2.Parameters.AddWithValue("", accessoire2)
                                Cmd2.Parameters.AddWithValue("", accessoire3)
                                Cmd2.Parameters.AddWithValue("", accessoire4)
                                Cmd2.Parameters.AddWithValue("", accessoire5)
                                Cmd2.Parameters.AddWithValue("", accessoire6)
                                Cmd2.Parameters.AddWithValue("", accessoire7)
                                Cmd2.Parameters.AddWithValue("", accessoire8)

                                Cmd2.Parameters.AddWithValue("", Mid(opmerking, 1, 79))
                                Cmd2.Parameters.AddWithValue("", wpsfilter)
                                Cmd2.Parameters.AddWithValue("", 0) 'status
                                Cmd2.Parameters.AddWithValue("", fust_id)
                                Cmd2.Parameters.AddWithValue("", stikkercode)
                                Cmd2.Parameters.AddWithValue("", selectie)
                                Cmd2.Parameters.AddWithValue("", orderLineId)
                                Cmd2.ExecuteNonQuery()

                            End If
                        Else
                            Reader2.Close()
                            'save orderlines
                            query = "INSERT INTO floriday_salesorders_boek(orderLineId,boek_soortId,boek_hoesId,boek_accessoire1," _
                                        & "boek_accessoire2,boek_accessoire3,boek_accessoire4,boek_accessoire5,boek_accessoire6,boek_accessoire7," _
                                        & "boek_accessoire8,boek_opmerking,boek_wpsfilter,boek_status,boek_fustid,boek_stikkercode,boek_aantal,customerOrganizationId," _
                                        & "org_soortId,org_hoesId,org_fustId,org_accessoire1,org_accessoire2,org_accessoire3," _
                                        & "org_accessoire4,org_accessoire5,org_accessoire6,org_accessoire7,org_accessoire8,tradeItemName,tradeItemId,selectie," _
                                        & "boek_stikkerstatus,packages_to_fullfill,agreementReference_code)" _
                                        & " VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                            Cmd2.CommandText = query
                            Cmd2.Parameters.Clear()
                            Cmd2.Parameters.AddWithValue("", orderLineId)
                            Cmd2.Parameters.AddWithValue("", soort_id)
                            Cmd2.Parameters.AddWithValue("", hoes_id)
                            Cmd2.Parameters.AddWithValue("", accessoire1)
                            Cmd2.Parameters.AddWithValue("", accessoire2)
                            Cmd2.Parameters.AddWithValue("", accessoire3)
                            Cmd2.Parameters.AddWithValue("", accessoire4)
                            Cmd2.Parameters.AddWithValue("", accessoire5)
                            Cmd2.Parameters.AddWithValue("", accessoire6)
                            Cmd2.Parameters.AddWithValue("", accessoire7)
                            Cmd2.Parameters.AddWithValue("", accessoire8)

                            Cmd2.Parameters.AddWithValue("", Mid(opmerking, 1, 79))
                            Cmd2.Parameters.AddWithValue("", wpsfilter)
                            Cmd2.Parameters.AddWithValue("", 0) 'status
                            Cmd2.Parameters.AddWithValue("", fust_id)
                            Cmd2.Parameters.AddWithValue("", stikkercode)
                            Cmd2.Parameters.AddWithValue("", numberOfPieces)
                            Cmd2.Parameters.AddWithValue("", customerOrganizationId)

                            Cmd2.Parameters.AddWithValue("", soort_id)
                            Cmd2.Parameters.AddWithValue("", hoes_id)
                            Cmd2.Parameters.AddWithValue("", fust_id)
                            Cmd2.Parameters.AddWithValue("", accessoire1)
                            Cmd2.Parameters.AddWithValue("", accessoire2)
                            Cmd2.Parameters.AddWithValue("", accessoire3)
                            Cmd2.Parameters.AddWithValue("", accessoire4)
                            Cmd2.Parameters.AddWithValue("", accessoire5)
                            Cmd2.Parameters.AddWithValue("", accessoire6)
                            Cmd2.Parameters.AddWithValue("", accessoire7)
                            Cmd2.Parameters.AddWithValue("", accessoire8)
                            Cmd2.Parameters.AddWithValue("", tradeItemName)
                            Cmd2.Parameters.AddWithValue("", tradeItemId)
                            Cmd2.Parameters.AddWithValue("", 1)  'selectie aan by default
                            Cmd2.Parameters.AddWithValue("", stikkerstatus)
                            If selectedPackingConfiguration_piecesPerPackage < 1 Then selectedPackingConfiguration_piecesPerPackage = 1
                            Dim aantalfust As Integer = CInt(numberOfPieces / selectedPackingConfiguration_piecesPerPackage)
                            Cmd2.Parameters.AddWithValue("", aantalfust)
                            Cmd2.Parameters.AddWithValue("", agreementReference_code)
                            Cmd2.ExecuteNonQuery()

                            filterstoegepast = CheckFloridayFilter(orderLineId)

                        End If

                        If opmerking <> "" Then opmerkingwarning = opmerkingwarning + 1
                        warningcode = warningcode + soortwarning + fustwarning + hoeswarning + acce1warning + acce2warning + acce3warning + acce4warning + acce5warning + acce6warning + acce7warning + acce8warning + opmerkingwarning

                        If show = True Then

                            Dim flexfill As New Dictionary(Of String, Object)
                            flexfill.Add("Id", ids(idloop))
                            flexfill.Add("selectie", selectie)
                            flexfill.Add("aantal", Aantal)
                            flexfill.Add("xapf", "x " + Tstr(xapf))
                            flexfill.Add("soort", soort_id)
                            flexfill.Add("fust", fust_id)
                            flexfill.Add("hoes", hoes_id)
                            flexfill.Add("accessoire1", accessoire1)
                            flexfill.Add("accessoire2", accessoire2)
                            flexfill.Add("accessoire3", accessoire3)
                            flexfill.Add("accessoire4", accessoire4)
                            flexfill.Add("accessoire5", accessoire5)
                            flexfill.Add("accessoire6", accessoire6)
                            flexfill.Add("accessoire7", accessoire7)
                            flexfill.Add("accessoire8", accessoire8)
                            flexfill.Add("prijs", Format(prijs, "#0.000"))

                            If contractId <> "" Then
                                flexfill.Add("aanbodreferentie", "Contract: " + contractTitle)
                            ElseIf agreementReference_code <> "" Or agreementReference_description <> "" Then
                                flexfill.Add("aanbodreferentie", agreementReference_code + "-" + agreementReference_description)
                            End If

                            flexfill.Add("opmerking", opmerking)
                            flexfill.Add("stikkercode", stikkercode)
                            flexfill.Add("wpsfilter", wpsfilter)
                            flexfill.Add("orderLineId", orderLineId)
                            flexfill.Add("stikkerstatus", stikkerstatus)
                            flexfill.Add("fdfilter", filterstoegepast)


                            Dim flexwarning As New Dictionary(Of String, Object)
                            If soortwarning > 0 Then flexwarning.Add("soort", 1)
                            If fustwarning > 0 Then flexwarning.Add("fust", 1)
                            If hoeswarning > 0 Then flexwarning.Add("hoes", 1)
                            If acce1warning > 0 Then flexwarning.Add("accessoire1", 1)
                            If acce2warning > 0 Then flexwarning.Add("accessoire2", 1)
                            If acce3warning > 0 Then flexwarning.Add("accessoire3", 1)
                            If acce4warning > 0 Then flexwarning.Add("accessoire4", 1)
                            If acce5warning > 0 Then flexwarning.Add("accessoire5", 1)
                            If acce6warning > 0 Then flexwarning.Add("accessoire6", 1)
                            If acce7warning > 0 Then flexwarning.Add("accessoire7", 1)
                            If acce8warning > 0 Then flexwarning.Add("accessoire8", 1)
                            If filterstoegepast <> "" Then flexwarning.Add("fdfilter", 2)
                            If opmerking <> "" Then flexwarning.Add("opmerking", 1)
                            'If agreementReference_code <> "" Then flexwarning.Add("aanbodreferentie", 1)

                            FlexgridAddTree(FloridayOrderLines_flx, fd_orderlinetable, flexfill, flexwarning, niet_accumuleren)
                        End If

                    End If
                    Reader.Close()

                Next


                If show = True Then

                    ' alle accesoires en hoes uitzetten als ze niet gevuld zijn

                    Dim hoesfound As Boolean = False
                    Dim col As Integer = 0

                    col = FindCol(FloridayOrderLines_flx, "Hoes")
                    For i = 1 To FloridayOrderLines_flx.Rows.Count - 1
                        If FloridayOrderLines_flx.Item(i, col) > 0 Then hoesfound = True
                    Next
                    If hoesfound = False Then FloridayOrderLines_flx.Cols(col).Visible = False

                    Dim accefound As Boolean = False
                    Dim firstempty As Boolean = False
                    col = FindCol(FloridayOrderLines_flx, "Accessoire1")
                    For colrun = col To col + 7
                        For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                            If FloridayOrderLines_flx.Item(i, colrun) > 0 Then accefound = True
                        Next
                        If accefound = False And firstempty = True Then FloridayOrderLines_flx.Cols(colrun).Visible = False
                        If firstempty = False And accefound = False Then firstempty = True
                        accefound = False
                    Next

                    For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                        If FloridayOrderLines_flx.Rows(i).IsNode Then
                            FloridayOrderLines_flx.Rows(i).Style = FloridayOrderLines_flx.Styles("EDIT")
                            FloridayOrderLines_flx.Rows(i).Node.Collapsed = True
                        End If
                    Next

                    ' selecties in tree goed zetten

                    ' node selectie -> parent aanpassen?
                    Dim selectiecol As Integer = FindCol(FloridayOrderLines_flx, "Selectie")
                    Dim parentcol As Integer = FindCol(FloridayOrderLines_flx, "parentrow")
                    Dim parentid As Integer = 0
                    For nodeloop = 2 To FloridayOrderLines_flx.Rows.Count - 1
                        If FloridayOrderLines_flx.Rows(nodeloop).IsNode Then
                            parentid = FloridayOrderLines_flx(nodeloop, parentcol)
                        Else
                            Dim childstatus As Boolean = FloridayOrderLines_flx.Item(nodeloop, col)
                            Dim selectedchildfound As Boolean = False
                            Dim notselectedchildfound As Boolean = False
                            For i = 2 To FloridayOrderLines_flx.Rows.Count - 1  'als alle childnodes dezelfde status hebben -> parent aanpassen
                                If FloridayOrderLines_flx(i, parentcol) = parentid And Not FloridayOrderLines_flx.Rows(i).IsNode Then
                                    If FloridayOrderLines_flx(i, selectiecol) = True Then selectedchildfound = True
                                    If FloridayOrderLines_flx(i, selectiecol) = False Then notselectedchildfound = True
                                End If
                            Next
                            'set parent
                            If selectedchildfound = True And notselectedchildfound = False Then
                                For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                                    If FloridayOrderLines_flx(i, parentcol) = parentid And FloridayOrderLines_flx.Rows(i).IsNode Then
                                        FloridayOrderLines_flx(i, selectiecol) = True
                                    End If
                                Next
                            Else
                                For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                                    If FloridayOrderLines_flx(i, parentcol) = parentid And FloridayOrderLines_flx.Rows(i).IsNode Then
                                        FloridayOrderLines_flx(i, selectiecol) = False
                                    End If
                                Next
                            End If
                        End If
                    Next

                End If

            End Using
        Catch ex As Exception

            MessageBox.Show("Fout bij floriday orderlines ophalen " + ex.ToString, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return warningcode
    End Function

    Private Sub FlexgridAddTree(flexgrid As C1FlexGrid, dbtable() As tablelayout, ByRef flexfill As Dictionary(Of String, Object), Optional flexwarning As Dictionary(Of String, Object) = Nothing, Optional DontStack As Boolean = False)
        flexgrid.Tree.Style = TreeStyleFlags.SimpleLeaf
        flexgrid.Tree.LineColor = Color.DarkBlue
        flexgrid.Tree.Column = 2

        'search all existing rows for items with same values 1
        Dim parentline As Integer = -1
        Dim newrow As Integer = -1
        Dim samerowfound As Boolean = False
        If DontStack = False Then
            For row = 2 To flexgrid.Rows.Count - 1
                Dim valuecompare As Object = Nothing
                Dim differencefound As Boolean = False
                If Not flexgrid.Rows(row).IsNode Then
                    For i = 0 To dbtable.Count - 1  'col loop
                        Dim col As String = dbtable(i).columnname
                        If (col <> "") And (Not col = "orderLineId") And (Not col = "selectie") And (Not col = "aantal") Then
                            If (flexfill.TryGetValue(col, valuecompare)) Then
                                If CStr(flexgrid.Item(row, i + 2)) <> CStr(valuecompare) Then
                                    differencefound = True
                                End If
                            End If
                        End If
                        If col = "parentrow" Then parentline = flexgrid.Item(row, i + 2)
                    Next
                    If differencefound = False Then
                        'new node and row
                        flexgrid.Rows.Insert(row)
                        newrow = row
                        samerowfound = True
                        Exit For
                    End If
                End If
            Next row
        End If
        If samerowfound = False Then
            'add new parent node
            flexgrid.Rows.Count = flexgrid.Rows.Count + 1
            newrow = flexgrid.Rows.Count - 1
            flexgrid.Rows(newrow).IsNode = True
            flexgrid.Rows(newrow).Node.Level = 1

            'fill parent row
            Dim pvalue As Object = Nothing
            For i = 0 To dbtable.Count - 1  'make new parent node
                Dim col As String = dbtable(i).columnname
                If col <> "" Then
                    If col = "aantal" Then
                        flexgrid.Item(newrow, i + 2) = 0
                        'ElseIf col = "orderLineId" Then
                        'flexgrid.Item(newrow, i + 2) = ""
                    Else
                        If (flexfill.TryGetValue(col, pvalue)) Then
                            flexgrid.Item(newrow, i + 2) = pvalue
                        End If
                    End If
                    If col = "parentrow" Then
                        flexgrid.Item(newrow, i + 2) = newrow
                        parentline = newrow
                    End If
                    'If col = "selectie" Then
                    'flexgrid.Item(newrow, i + 2) = True
                    'End If
                End If
            Next
            'add empty row
            flexgrid.Rows.Count = flexgrid.Rows.Count + 1
            newrow = flexgrid.Rows.Count - 1
        End If

        'fill row

        Dim value As Object = Nothing
        If (flexfill.TryGetValue("Id", value)) Then 'save id column
            flexgrid.Item(newrow, 0) = value
        End If
        For i = 0 To dbtable.Count - 1  'save other columns
            Dim col As String = dbtable(i).columnname
            If col <> "" Then
                If (flexfill.TryGetValue(col, value)) Then
                    flexgrid.Item(newrow, i + 2) = value
                End If
            End If
            If col = "parentrow" Then
                flexgrid.Item(newrow, i + 2) = parentline
            End If
            'If col = "SELECT" Then
            'flexgrid.Item(newrow, i + 2) = True
            'End If
        Next
        Dim aantalcol As Integer = FindCol(flexgrid, "Aantal")
        Dim parentcol As Integer = FindCol(flexgrid, "parentrow")

        For row = 2 To flexgrid.Rows.Count - 1
            If flexgrid.Rows(row).IsNode Then
                If flexgrid.Item(newrow, parentcol) = flexgrid.Item(row, parentcol) Then
                    flexgrid.Item(row, aantalcol) = flexgrid.Item(row, aantalcol) + flexgrid.Item(newrow, aantalcol)
                End If
            End If
        Next



        If Not IsNothing(flexwarning) Then
            For i = 0 To dbtable.Count - 1
                Dim col As String = dbtable(i).columnname
                If col <> "" Then
                    If (flexwarning.TryGetValue(col, value)) Then
                        If value > 0 Then

                            Dim rs As C1.Win.C1FlexGrid.CellStyle
                            Dim stylename As String = "STYLE" + Tstr(i)
                            rs = flexgrid.Styles.Add(stylename)
                            If value = 1 Then rs.BackColor = Color.LightCoral
                            If value > 1 Then rs.BackColor = Color.Orange

                            Dim celformat() = dbtable(i).type.Split(New Char() {";"c})
                            If Trim(celformat(0)) <> "" Then
                                rs.DataType = System.Type.GetType(celformat(0))
                            End If
                            If UBound(celformat) = 1 Then
                                If Trim(celformat(1)) = "..." Then
                                    rs.ComboList = "..."
                                    rs.Format = ""
                                Else
                                    rs.Format = Trim(celformat(1))
                                End If
                            Else
                                rs.Format = ""
                            End If
                            flexgrid.SetCellStyle(newrow, i + 2, stylename)
                            Dim parentrow As Integer = flexgrid(newrow, parentcol)
                            For j = 1 To flexgrid.Rows.Count - 1
                                If flexgrid.Rows(j).IsNode And flexgrid.Item(j, parentcol) = parentrow Then
                                    flexgrid.SetCellStyle(j, i + 2, stylename)
                                End If
                            Next j
                        End If
                    End If
                End If
            Next
        End If

        flexfill.Clear()


    End Sub

    Private Sub ShowOrderInfo(order_id As Integer)
        Dim query As String = ""
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand(query, Conn)
                Dim Reader As OdbcDataReader

                Dim Cmd2 As New OdbcCommand(query, Conn)
                Dim Reader2 As OdbcDataReader

                Dim Cmd3 As New OdbcCommand(query, Conn)
                Dim Reader3 As OdbcDataReader

                Dim Cmd4 As New OdbcCommand(query, Conn)
                Dim Reader4 As OdbcDataReader

                Dim flexfill As New Dictionary(Of String, Object)

                FloridayOrderInfo_flx.Rows.Count = 1

                Dim orderLineId As String = ""
                Dim salesChannelOrderId As String = ""
                Dim customerOrderId As String = ""
                Dim customerOrganizationId As String = ""
                Dim supplyLineId As String = ""
                Dim tradeItemId As String = ""
                Dim salesChannel As String = ""


                query = "SELECT * FROM floriday_salesorders WHERE id=?"
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", order_id)
                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader()
                If Reader.HasRows Then
                    Reader.Read()

                    orderLineId = CHstr(Reader("orderLineId"))
                    salesChannelOrderId = CHstr(Reader("salesChannelOrderId"))
                    customerOrderId = CHstr(Reader("customerOrderId"))
                    customerOrganizationId = CHstr(Reader("customerOrganizationId"))
                    supplyLineId = CHstr(Reader("supplyLineId"))
                    tradeItemId = CHstr(Reader("tradeItemId"))
                    salesChannel = CHstr(Reader("salesChannel"))
                    Dim numberOfPieces As Integer = CHint(Reader("numberOfPieces"))
                    Dim tradeInstrument As String = CHstr(Reader("tradeInstrument"))
                    Dim selectedPackingConfiguration_piecesPerPackage As Integer = CHint(Reader("selectedPackingConfiguration_piecesPerPackage"))
                    Dim selectedPackingConfiguration_bunchesPerPackage As Integer = CHint(Reader("selectedPackingConfiguration_bunchesPerPackage"))
                    Dim selectedPackingConfiguration_package_vbnPackageCode As Integer = CHint(Reader("selectedPackingConfiguration_package_vbnPackageCode"))
                    Dim selectedPackingConfiguration_package_customPackageId As String = CHstr(Reader("selectedPackingConfiguration_package_customPackageId"))
                    Dim selectedPackingConfiguration_loadCarrier As String = CHstr(Reader("selectedPackingConfiguration_loadCarrier"))
                    Dim selectedPackingConfiguration_additionalPricePerPiece_currency As String = CHstr(Reader("selectedPackingConfiguration_additionalPricePerPiece_currency"))
                    Dim selectedPackingConfiguration_additionalPricePerPiece_value As Double = CHdouble(Reader("selectedPackingConfiguration_additionalPricePerPiece_value"))
                    Dim selectedPackingConfiguration_photoUrl As String = CHstr(Reader("selectedPackingConfiguration_photoUrl"))
                    Dim orderDateTime As DateTime = CHDate2(Reader("orderDateTime"), Now)
                    Dim pricePerPiece_currency As String = CHstr(Reader("pricePerPiece_currency"))
                    Dim pricePerPiece_value As Double = CHdouble(Reader("pricePerPiece_value"))
                    Dim delivery_deliveryConditionId As String = CHstr(Reader("delivery_deliveryConditionId"))
                    Dim delivery_latestDeliveryDateTime As DateTime = CHDate2(Reader("delivery_latestDeliveryDateTime"), Now)
                    Dim delivery_regionGln As String = CHstr(Reader("delivery_regionGln"))
                    Dim delivery_location_gln As String = CHstr(Reader("delivery_location_gln"))
                    Dim delivery_location_address_addressLine As String = CHstr(Reader("delivery_location_address_addressLine"))
                    Dim delivery_location_address_city As String = CHstr(Reader("delivery_location_address_city"))
                    Dim delivery_location_address_countryCode As String = CHstr(Reader("delivery_location_address_countryCode"))
                    Dim delivery_location_address_postalCode As String = CHstr(Reader("delivery_location_address_postalCode"))
                    Dim delivery_location_address_stateOrProvince As String = CHstr(Reader("delivery_location_address_stateOrProvince"))
                    Dim cancellationDeadline As DateTime = CHDate2(Reader("cancellationDeadline"), Now)
                    Dim status As String = CHstr(Reader("status"))


                    query = "SELECT * FROM floriday_tradeitem WHERE tradeItemId='" + tradeItemId + "'"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        Reader2.Read()
                        Dim tr_id As Integer = CHint(Reader2("id"))
                        Dim tradeItemReference As String = CHstr(Reader2("tradeItemReference"))
                        Dim tradeItemVersion As Integer = CHint(Reader2("tradeItemVersion"))
                        Dim isDeleted As Boolean = CHbool(Reader2("isDeleted"))
                        Dim supplierArticleCode As String = CHstr(Reader2("supplierArticleCode"))
                        Dim articleGtin As String = CHstr(Reader2("articleGtin"))
                        Dim vbnProductCode As Integer = CHint(Reader2("vbnProductCode"))
                        Dim tradeItemName_nl As String = CHstr(Reader2("tradeItemName_nl"))
                        Dim tradeItemName_en As String = CHstr(Reader2("tradeItemName_en"))

                        flexfill.Add("naam", "Trade-item naam")
                        flexfill.Add("waarde", tradeItemName_nl)
                        FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                        flexfill.Add("naam", "Trade-item eigen-code")
                        flexfill.Add("waarde", supplierArticleCode)
                        FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                        flexfill.Add("naam", "Trade-item VBN-code")
                        flexfill.Add("waarde", vbnProductCode)
                        FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                    Else
                        flexfill.Add("naam", "FOUT")
                        flexfill.Add("waarde", "Trade-item niet gevonden")
                        FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)
                    End If
                    Reader2.Close()

                    flexfill.Add("naam", "Aantal planten")
                    flexfill.Add("waarde", numberOfPieces)
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                    flexfill.Add("naam", "Basis prijs")
                    flexfill.Add("waarde", pricePerPiece_currency)
                    flexfill.Add("prijs", Format(pricePerPiece_value, "#0.000"))
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                    Dim totaalprijs As Double = pricePerPiece_value

                    query = "SELECT * FROM floriday_salesorders_additionalservices WHERE parent_id=?"
                    Cmd3.CommandText = query
                    Cmd3.Parameters.Clear()
                    Cmd3.Parameters.AddWithValue("", order_id)
                    Reader3 = Cmd3.ExecuteReader()
                    Do While Reader3.Read()
                        Dim additionalServiceId As String = CHstr(Reader3("additionalServiceId"))
                        Dim price_currency As String = CHstr(Reader3("price_currency"))
                        Dim price_value As Double = CHdouble(Reader3("price_value"))
                        Dim unit As String = CHstr(Reader3("unit"))

                        query = "SELECT * FROM floriday_additionalservices WHERE additionalServiceId='" + additionalServiceId + "'"
                        Cmd4.CommandText = query
                        Reader4 = Cmd4.ExecuteReader()
                        If Reader4.HasRows Then
                            Reader4.Read()

                            Dim commercialServiceType_commercialServiceTypeId As String = CHstr(Reader4("commercialServiceType_commercialServiceTypeId"))
                            Dim commercialServiceType_commercialServiceTypeName As String = CHstr(Reader4("commercialServiceType_commercialServiceTypeName"))
                            Dim audience As String = CHstr(Reader4("audience"))
                            Dim name As String = CHstr(Reader4("name"))
                            Dim description As String = CHstr(Reader4("description"))
                            Dim isAvailable As Boolean = CHbool(Reader4("isAvailable"))

                            totaalprijs = totaalprijs + price_value

                            flexfill.Add("naam", "Additional service")
                            flexfill.Add("waarde", name)
                            flexfill.Add("prijs", Format(price_value, "#0.000"))
                            FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)
                        End If
                        Reader4.Close()

                    Loop
                    Reader3.Close()

                    If selectedPackingConfiguration_additionalPricePerPiece_value > 0 Then
                        flexfill.Add("naam", "Extra Fust prijs")
                        flexfill.Add("waarde", pricePerPiece_currency)
                        flexfill.Add("prijs", Format(selectedPackingConfiguration_additionalPricePerPiece_value, "#0.000"))
                        totaalprijs = totaalprijs + selectedPackingConfiguration_additionalPricePerPiece_value
                        FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)
                    End If

                    flexfill.Add("naam", "Totaal prijs")
                    flexfill.Add("waarde", pricePerPiece_currency)
                    flexfill.Add("prijs", Format(totaalprijs, "#0.000"))
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                    flexfill.Add("naam", "")
                    flexfill.Add("waarde", "")
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                    flexfill.Add("naam", "Fust-code")
                    flexfill.Add("waarde", selectedPackingConfiguration_package_vbnPackageCode)
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                    flexfill.Add("naam", "Aantal per fust")
                    flexfill.Add("waarde", selectedPackingConfiguration_piecesPerPackage)
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                    If selectedPackingConfiguration_package_customPackageId <> "" Then
                        flexfill.Add("naam", "Floriday packageID")
                        flexfill.Add("waarde", selectedPackingConfiguration_package_customPackageId)
                        FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)
                    End If

                    flexfill.Add("naam", "Ladingdrager")
                    flexfill.Add("waarde", selectedPackingConfiguration_loadCarrier)
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)
                End If


                flexfill.Add("naam", "")
                flexfill.Add("waarde", "")
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                flexfill.Add("naam", "DBorderId")
                flexfill.Add("waarde", order_id)
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                flexfill.Add("naam", "orderLineId")
                flexfill.Add("waarde", orderLineId)
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                flexfill.Add("naam", "salesChannelOrderId")
                flexfill.Add("waarde", salesChannelOrderId)
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                flexfill.Add("naam", "customerOrderId")
                flexfill.Add("waarde", customerOrderId)
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                flexfill.Add("naam", "customerOrganizationId")
                flexfill.Add("waarde", customerOrganizationId)
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                flexfill.Add("naam", "supplyLineId")
                flexfill.Add("waarde", supplyLineId)
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                flexfill.Add("naam", "tradeItemId")
                flexfill.Add("waarde", tradeItemId)
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                flexfill.Add("naam", "salesChannel")
                flexfill.Add("waarde", salesChannel)
                FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                Dim delivery_parent_id As Integer = 0
                query = "SELECT * FROM floriday_delivery_fulfillmentrequests WHERE orderLineId='" + orderLineId + "'"
                Cmd2.CommandText = query
                Reader2 = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    Reader2.Read()
                    delivery_parent_id = CHint(Reader2("parent_id"))
                    Dim fulfillmentRequestId As String = CHstr(Reader2("fulfillmentRequestId"))

                    flexfill.Add("naam", "Delivery FFReqId")
                    flexfill.Add("waarde", fulfillmentRequestId)
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                Else
                    flexfill.Add("naam", "Delivery status")
                    flexfill.Add("waarde", "GEEN DELIVERY GEVONDEN")
                    FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)
                End If
                Reader2.Close()
                If delivery_parent_id > 0 Then
                    query = "SELECT * FROM floriday_delivery WHERE Id=" + Str(delivery_parent_id)
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        Reader2.Read()
                        Dim deliveryOrderId As String = CHstr(Reader2("deliveryOrderId"))
                        Dim creationDateTime As DateTime = CHDate2(Reader2("creationDateTime"), Now)

                        flexfill.Add("naam", "Delivery ID")
                        flexfill.Add("waarde", deliveryOrderId)
                        FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)

                        flexfill.Add("naam", "Delivery creationtime")
                        flexfill.Add("waarde", Format(creationDateTime, "dd-MM-yyyy HH:mm"))
                        FlexgridAdd(FloridayOrderInfo_flx, fd_orderinfotable, flexfill)
                    End If
                    Reader2.Close()
                End If




                Reader.Close()



            End Using
        Catch ex As Exception
            'ErrorLog("Database niet gevonden")
            MessageBox.Show("Fout bij floriday orderline info ophalen " + ex.ToString, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Dim fd_ordertable() As tablelayout
    Dim fd_orderlinetable() As tablelayout
    Dim fd_orderinfotable() As tablelayout
    Private Sub SetupFloridayGrid()
        fd_ordertable = BuildTable("floridayorders", FloridayOrders_flx)
        fd_orderlinetable = BuildTable("floridayorderlines", FloridayOrderLines_flx)
        fd_orderinfotable = BuildTable("floridayorderinfo", FloridayOrderInfo_flx)
        SetTabPage("Floriday")
    End Sub

    Private Sub FloridayOrdersShow(Optional orderlineid As Integer = 0)
        FloridayOrders_flx.Rows.Count = 1
        Dim query As String = ""
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand(query, Conn)
                Dim Reader As OdbcDataReader

                Dim Cmd2 As New OdbcCommand(query, Conn)
                Dim Reader2 As OdbcDataReader


                FormProgressBar.StartPosition = FormStartPosition.CenterScreen
                FormProgressBar.Show()
                FormProgressBar.DataProgressBar.Value = 5
                Application.DoEvents()


                Dim Start_datum As Date = Floriday_Calendar.SelectionStart.Date
                Dim End_datum As Date = Floriday_Calendar.SelectionEnd.Date
                If Start_datum = Now.Date Then Start_datum = DateAdd("d", -14, Start_datum)
                If End_datum < Start_datum Then
                    End_datum = Start_datum
                End If
                Dim Start_DatumStr As String = Start_datum.ToString("yyyy/MM/dd")
                Dim End_DatumStr As String = End_datum.ToString("yyyy/MM/dd")

                'Execute Query

                'nieuw of archief


                If Fd_nieuweOrders_rb.Checked = True Then
                    query = "SELECT *, SUM(numberOfPieces / selectedPackingConfiguration_piecesPerPackage) As totaalbakken, GROUP_CONCAT(id SEPARATOR ';') AS grouped_ids FROM floriday_salesorders WHERE boekstatus=0 AND status = 'COMMITTED' AND tradeInstrument='DIRECT_SALES' AND DATE(boektijd) >= '" + Start_DatumStr + "' AND DATE(boektijd) <= '" + End_DatumStr + "' GROUP BY customerOrganizationId, contractId ,selectedPackingConfiguration_loadCarrier, delivery_location_gln, boektijd ORDER BY delivery_latestDeliveryDateTime"
                Else

                    Start_DatumStr = Floriday_Calendar.SelectionStart.Date.ToString("yyyy/MM/dd")
                    End_DatumStr = Floriday_Calendar.SelectionEnd.Date.ToString("yyyy/MM/dd")
                    query = "SELECT *, SUM(numberOfPieces / selectedPackingConfiguration_piecesPerPackage) As totaalbakken, GROUP_CONCAT(id SEPARATOR ';') AS grouped_ids FROM floriday_salesorders WHERE boekstatus>0 AND status = 'COMMITTED' AND tradeInstrument='DIRECT_SALES' AND DATE(boektijd) >= '" + Start_DatumStr + "' AND DATE(boektijd) <= '" + End_DatumStr + "' GROUP BY boekstatus ORDER BY boektijd"

                    If FdMenu_Zoek_chk.Checked = True Then
                        'zoeken
                        query = "SELECT *, SUM(numberOfPieces / selectedPackingConfiguration_piecesPerPackage) As totaalbakken, GROUP_CONCAT(FLS.id SEPARATOR ';') AS grouped_ids FROM floriday_salesorders AS FLS LEFT JOIN Floriday_Salesorders_Boek AS FSB ON FLS.OrderLineId=FSB.OrderlineId WHERE boekstatus>0 AND status = 'COMMITTED' AND tradeInstrument='DIRECT_SALES' AND DATE(boektijd) >= '" + Start_DatumStr + "' AND DATE(boektijd) <= '" + End_DatumStr + "' AND kopernaam LIKE '%" + FdMenu_Zoek_txt.Text + "%' GROUP BY boekstatus ORDER BY boektijd"
                    End If

                    If FdMenu_ordernr_chk.Checked = True Then
                        Dim fdnummer As Integer = 0
                        Dim floridaynrstr As String = FdMenu_floridaynr_txt.Text.ToLower
                        If Mid(floridaynrstr, 1, 2) = "fd" Then
                            fdnummer = CInt(Val(Mid(floridaynrstr, 3, 8)))
                        End If
                        If fdnummer > 0 Then
                            query = "SELECT *, SUM(numberOfPieces / selectedPackingConfiguration_piecesPerPackage) As totaalbakken, GROUP_CONCAT(FLS.id SEPARATOR ';') AS grouped_ids FROM floriday_salesorders AS FLS LEFT JOIN Floriday_Salesorders_Boek AS FSB ON FLS.OrderLineId=FSB.OrderlineId WHERE boekstatus>0 AND status = 'COMMITTED' AND tradeInstrument='DIRECT_SALES' AND boek_floridaynr=" + Str(fdnummer) + " GROUP BY boekstatus ORDER BY boektijd"
                        Else
                            MsgBox("Geen valide nummer niet gevonden")
                        End If
                    End If
                End If

                If orderlineid > 0 Then
                    query = "SELECT *, SUM(numberOfPieces / selectedPackingConfiguration_piecesPerPackage) As totaalbakken, GROUP_CONCAT(FLS.id SEPARATOR ';') AS grouped_ids FROM floriday_salesorders AS FLS LEFT JOIN Floriday_Salesorders_Boek AS FSB ON FLS.OrderLineId=FSB.OrderlineId WHERE FSB.boek_orderlineid=" + Str(orderlineid) + " ORDER BY boektijd"
                End If

                Cmd.CommandText = query
                Reader = Cmd.ExecuteReader()
                Do While Reader.Read
                    Dim loadCarrier As String = CHstr(Reader("selectedPackingConfiguration_loadCarrier"))
                    Dim customerOrganizationId As String = CHstr(Reader("customerOrganizationId"))
                    Dim supplyLineId As String = CHstr(Reader("supplyLineId"))
                    Dim numberOfTrays As Integer = CHint(Reader("totaalbakken"))
                    Dim idlist As String = CHstr(Reader("grouped_ids"))
                    Dim delivery_latestDeliveryDateTime As DateTime = CHDate2(Reader("delivery_latestDeliveryDateTime"), Now)
                    Dim delivery_location_gln As String = CHstr(Reader("delivery_location_gln"))
                    Dim orderdatetime As DateTime = CHDate2(Reader("orderdatetime"), Now)
                    Dim databaseboektijd As DateTime = CHDate2(Reader("boektijd"), Now)


                    'kopernaam ophalen
                    Dim kopernaam As String = "Koper onbekend"
                    Dim koper_ean As String = ""
                    query = "SELECT name,companyGln FROM floriday_organizations WHERE organizationId='" + customerOrganizationId + "'"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        kopernaam = CHstr(Reader2("name"))
                        koper_ean = CHstr(Reader2("companyGln"))
                    Else
                        kopernaam = "Koper onbekend"
                        InsertTask(0, 9, "GET", "organizations", customerOrganizationId)
                    End If
                    Reader2.Close()

                    'dim kar info ophalen
                    Dim karvoorkeur As Integer = 1
                    query = "SELECT kar_voorkeur FROM klanten WHERE ean='" + koper_ean + "'"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        karvoorkeur = CHstr(Reader2("kar_voorkeur"))
                    End If
                    Reader2.Close()

                    Dim kartype As Integer = 1
                    Select Case loadCarrier
                        Case "NONE" : kartype = 8
                        Case "AUCTION_TROLLEY" : kartype = 3
                        Case "DANISH_TROLLEY" : kartype = 1
                        Case "EURO_TROLLEY" : kartype = 16
                        Case "PALLET" : kartype = 6
                        Case "EURO_PALLET" : kartype = 7
                    End Select

                    'deen type bepalen
                    If kartype = 1 Then   'deen?
                        If karvoorkeur = 4 Or karvoorkeur = 5 Then   'voorkeur deen zonder slotje
                            kartype = 4
                        End If
                    End If

                    'locatie plaats ophalen
                    Dim plaats As String = "Onbekend"
                    query = "SELECT city_name FROM locatielijst WHERE GLN_location_code=?"
                    Cmd2.CommandText = query
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", delivery_location_gln)
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        plaats = CHstr(Reader2("city_name"))
                    End If
                    Reader2.Close()

                    'bereken boektijd
                    Dim tijdwarning As Boolean = False
                    Dim boektijd As DateTime
                    Dim berekendeboektijd As DateTime

                    If Fd_nieuweOrders_rb.Checked = True Then
                        'nieuw
                        BerekenBoektijdFloriday(Conn, delivery_latestDeliveryDateTime, plaats, berekendeboektijd, tijdwarning)

                        If berekendeboektijd.Date > databaseboektijd.Date Then
                            'upddate database tijd
                            Dim ids() As String = idlist.Split(New Char() {";"c})
                            For idloop = 0 To UBound(ids)
                                Cmd2.CommandText = "UPDATE floriday_salesorders SET boektijd=? WHERE id=?"
                                Cmd2.Parameters.Clear()
                                Cmd2.Parameters.AddWithValue("", Format(berekendeboektijd, "yy-MM-dd HH:mm:ss"))
                                Cmd2.Parameters.AddWithValue("", ids(idloop))
                                Cmd2.ExecuteNonQuery()
                            Next
                            boektijd = berekendeboektijd
                        Else
                            boektijd = databaseboektijd
                        End If
                    Else
                        'archief
                        boektijd = databaseboektijd
                    End If


                    Dim flexfill As New Dictionary(Of String, Object)
                    flexfill.Add("klantnaam", kopernaam)
                    flexfill.Add("boekdt", boektijd)
                    flexfill.Add("leveringsdt", delivery_latestDeliveryDateTime)
                    flexfill.Add("aantalfust", numberOfTrays)
                    flexfill.Add("leveringslocatie", plaats.ToLower)
                    flexfill.Add("idlist", idlist)
                    flexfill.Add("orderdatetime", orderdatetime)
                    flexfill.Add("kartype", kartype)

                    Dim flexwarning As New Dictionary(Of String, Object)
                    If tijdwarning = True Then
                        flexwarning.Add("leveringsdt", 1)
                    End If

                    FlexgridAdd(FloridayOrders_flx, fd_ordertable, flexfill, flexwarning)

                    Dim warning As Integer = CheckOrderlines(False, FloridayOrders_flx.Rows.Count - 1)
                    If warning > 0 Then
                        FloridayOrders_flx.Rows(FloridayOrders_flx.Rows.Count - 1).Style = FloridayOrders_flx.Styles("RED")
                    End If

                    Dim progress As Integer = FormProgressBar.DataProgressBar.Value
                    progress = progress + 5
                    If progress > 95 Then progress = 95
                    FormProgressBar.DataProgressBar.Value = progress

                Loop

                FormProgressBar.DataProgressBar.Value = 95
                FormProgressBar.Close()
                Me.Cursor = Cursors.Default


            End Using
        Catch ex As Exception
            'ErrorLog("Database niet gevonden")
            MessageBox.Show("Fout bij floriday orders ophalen " + ex.ToString, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)

        End Try
    End Sub

    Private Function GenerateNewID() As String
        Dim newid As String = System.Guid.NewGuid().ToString()
        Return newid
    End Function

    Public Function InsertTask(delay As Integer, priority As Integer, command As String, endpoint As String, Optional path As String = "", Optional additionalpath As String = "", Optional queryname1 As String = "", Optional queryvalue1 As String = "", Optional queryname2 As String = "", Optional queryvalue2 As String = "", Optional queryname3 As String = "", Optional queryvalue3 As String = "", Optional reference_id As Integer = 0, Optional runtime As DateTime = Nothing) As Integer
        Dim insert_id As Integer = 0
        Dim query As String = ""

        If IsNothing(path) Then path = ""
        If IsNothing(additionalpath) Then additionalpath = ""
        If IsNothing(queryname1) Then queryname1 = ""
        If IsNothing(queryvalue1) Then queryvalue1 = ""
        If IsNothing(queryname2) Then queryname2 = ""
        If IsNothing(queryvalue2) Then queryvalue2 = ""
        If IsNothing(queryname3) Then queryname3 = ""
        If IsNothing(queryvalue3) Then queryvalue3 = ""
        If IsNothing(runtime) Then runtime = Now

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim success As Boolean = False
                Dim cmd As New OdbcCommand(query, Conn)

                query = "INSERT INTO floriday_tasks(delay,command,endpoint,path,additionalpath," _
                                & "queryname1,queryvalue1,queryname2,queryvalue2,queryname3,queryvalue3," _
                                & "reference_id,responce_code,status,errortext,runtime,priority,errorcount," _
                                & "last_access,sequence,apitime,totaltime) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                cmd.CommandText = query
                cmd.Parameters.Clear()
                cmd.Parameters.AddWithValue("", delay)
                cmd.Parameters.AddWithValue("", command)
                cmd.Parameters.AddWithValue("", endpoint)
                cmd.Parameters.AddWithValue("", path)
                cmd.Parameters.AddWithValue("", additionalpath)
                cmd.Parameters.AddWithValue("", queryname1)
                cmd.Parameters.AddWithValue("", queryvalue1)
                cmd.Parameters.AddWithValue("", queryname2)
                cmd.Parameters.AddWithValue("", queryvalue2)
                cmd.Parameters.AddWithValue("", queryname3)
                cmd.Parameters.AddWithValue("", queryvalue3)
                cmd.Parameters.AddWithValue("", reference_id)
                cmd.Parameters.AddWithValue("", 0)
                cmd.Parameters.AddWithValue("", 0)
                cmd.Parameters.AddWithValue("", "")
                cmd.Parameters.AddWithValue("", Format(runtime, "yy-MM-dd HH:mm:ss"))
                cmd.Parameters.AddWithValue("", priority)
                cmd.Parameters.AddWithValue("", 0)
                cmd.Parameters.AddWithValue("", Format(Now, "yy-MM-dd HH:mm:ss"))
                cmd.Parameters.AddWithValue("", 0)
                cmd.Parameters.AddWithValue("", 0)
                cmd.Parameters.AddWithValue("", 0)
                cmd.ExecuteNonQuery()

                cmd.CommandText = "SELECT LAST_INSERT_ID()"
                insert_id = Convert.ToInt32(cmd.ExecuteScalar())


            End Using
        Catch ex As Exception
            LogSQLErrors("Insert tasks:" + ex.Message, query)
        End Try
        Return insert_id

    End Function

    Private Sub FloridayOrders_flx_AfterEdit(sender As Object, e As RowColEventArgs) Handles FloridayOrders_flx.AfterEdit
        Dim row As Integer = e.Row
        Dim col As Integer = e.Col

        Dim selectedcol As Integer = FloridayOrders_flx.ColSel
        Dim selectedrow As Integer = FloridayOrders_flx.RowSel
        Dim boektijdcol As Integer = FindCol(FloridayOrders_flx, "Boek datum/tijd")
        Dim idlistcol As Integer = FindCol(FloridayOrders_flx, "idlist")
        Dim newtime As DateTime = FloridayOrders_flx.Item(selectedrow, boektijdcol)
        Dim idlist As String = FloridayOrders_flx.Item(selectedrow, idlistcol)

        Dim query As String = ""
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd2 As New OdbcCommand(query, Conn)

                Dim ids() As String = idlist.Split(New Char() {";"c})
                For idloop = 0 To UBound(ids)
                    Cmd2.CommandText = "UPDATE floriday_salesorders SET boektijd=? WHERE id=?"
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", Format(newtime, "yy-MM-dd HH:mm:ss"))
                    Cmd2.Parameters.AddWithValue("", ids(idloop))
                    Cmd2.ExecuteNonQuery()
                Next

            End Using
        Catch ex As Exception
            MessageBox.Show("Fout bij floriday set date" + ex.ToString, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub

    Private Sub BerekenBoektijdFloriday(ByRef conn As OdbcConnection, ByVal deliverydate As Date, ByVal plaats As String, ByRef boektijd As DateTime, ByRef warning As Boolean)

        'Dim datum As String = edi_datum.ToShortDateString
        Dim dag As Integer = deliverydate.DayOfWeek
        If dag = 0 Then dag = 7 'zondag
        Dim uur As Integer = Val(Format(deliverydate, "HH"))
        Dim minuut As Integer = Val(Format(deliverydate, "mm"))
        If minuut > 30 Then uur = uur + 1
        Dim fc_uur As String = "12:00"
        Dim fc_datum As String = ""
        Dim veiling As Integer
        If plaats = "honselersdijk" Or plaats = "naaldwijk" Then
            veiling = 1
        Else
            veiling = 2
        End If

        If deliverydate < Now Then
            warning = True
        End If

        'fetch dag data from database
        Dim checked(8) As Boolean
        Dim check_tijd(8) As Integer
        Dim subdag(8) As Integer
        Dim boek_tijd(8) As String

        checked(1) = True    'defaults
        check_tijd(1) = 24
        subdag(1) = 0
        boek_tijd(1) = "12:00"

        Dim Reader As OdbcDataReader
        Dim Cmd As New OdbcCommand("SELECT * FROM vervoerstijden WHERE weekdag=? AND veiling=?", conn)
        Cmd.Parameters.Clear()
        Cmd.Parameters.AddWithValue("", dag)
        Cmd.Parameters.AddWithValue("", veiling)
        Reader = Cmd.ExecuteReader()
        Dim positie As Integer = 1
        Do While Reader.Read
            checked(positie) = CHbool(Reader("checked"))
            If checked(positie) = True Then
                check_tijd(positie) = CHint(Reader("checktijd"))
                subdag(positie) = CHint(Reader("subdag"))
                boek_tijd(positie) = CHstr(Reader("boektijd"))
            End If
            positie = positie + 1
        Loop
        Reader.Close()

        If checked(1) = True And uur < check_tijd(1) Then
            deliverydate = DateAdd("d", subdag(1), deliverydate)
            fc_uur = boek_tijd(1)
        ElseIf checked(2) = True And uur < check_tijd(2) Then
            deliverydate = DateAdd("d", subdag(2), deliverydate)
            fc_uur = boek_tijd(2)
        ElseIf checked(3) = True And uur < check_tijd(3) Then
            deliverydate = DateAdd("d", subdag(3), deliverydate)
            fc_uur = boek_tijd(3)
        ElseIf checked(4) = True And uur < check_tijd(4) Then
            deliverydate = DateAdd("d", subdag(4), deliverydate)
            fc_uur = boek_tijd(4)
        ElseIf checked(5) = True And uur < check_tijd(5) Then
            deliverydate = DateAdd("d", subdag(5), deliverydate)
            fc_uur = boek_tijd(5)
        ElseIf checked(6) = True And uur < check_tijd(6) Then
            deliverydate = DateAdd("d", subdag(6), deliverydate)
            fc_uur = boek_tijd(6)
        ElseIf checked(7) = True And uur < check_tijd(7) Then
            deliverydate = DateAdd("d", subdag(7), deliverydate)
            fc_uur = boek_tijd(7)
        End If


        fc_datum = deliverydate.ToShortDateString

        boektijd = Date.Parse(fc_datum + " " + fc_uur)

        If boektijd < Now Then
            Dim boekdatum As String = Now.ToShortDateString
            Dim currenttime As Integer = Val(Format(Now, "HH"))
            Dim currentboektime As String = "12:00"
            If currenttime <= 9 Then
                currentboektime = "9:00"
            ElseIf currenttime <= 12 Then
                currentboektime = "12:00"
            ElseIf currenttime <= 15 Then
                If Now.DayOfWeek = 5 Then
                    'warning = True
                End If
                currentboektime = "17:00"
            ElseIf currenttime <= 24 Then
                'warning = True
                currentboektime = "17:00"
            End If

            Dim weekendtest As Integer = Now.DayOfWeek
            If weekendtest = 0 Then 'zondag 
                boekdatum = DateAdd("d", 1, boekdatum)
            End If
            If weekendtest = 6 Then 'zaterdag 
                boekdatum = DateAdd("d", 2, boekdatum)
            End If
            boektijd = Date.Parse(boekdatum + " " + currentboektime)
        End If


    End Sub

    Private Sub FdMenu_Verwerk_but_Click(sender As Object, e As EventArgs) Handles FdMenu_Verwerk_but.Click

        FdMenu_Verwerk_but.Enabled = False
        Application.DoEvents()

        Dim fd_orderLineIdCol As Integer = FindCol(FloridayOrderLines_flx, "orderlineid")
        Dim fd_selectieCol As Integer = FindCol(FloridayOrderLines_flx, "selectie")
        Dim fd_soortCol As Integer = FindCol(FloridayOrderLines_flx, "soort")

        Dim query As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand("", Conn)
                Dim reader As OdbcDataReader
                'is de order nog steeds nieuw ? 


                For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                    If FloridayOrderLines_flx.Item(i, fd_selectieCol) = True Then
                        If FloridayOrderLines_flx.Rows(i).IsNode Then
                            'no check
                        Else
                            Dim orderLineId As String = FloridayOrderLines_flx.Item(i, fd_orderLineIdCol)

                            Cmd.CommandText = "select boekstatus from floriday_salesorders where  orderLineId='" + orderLineId + "'"
                            reader = Cmd.ExecuteReader()
                            If Reader.HasRows Then
                                reader.Read()
                                Dim boekstatus As Integer = CHint(reader("boekstatus"))
                                If boekstatus <> 0 Then
                                    MsgBox("Een gedeelte van deze order is al verwerkt, probeer opnieuw.")
                                    FloridayOrderLines_flx.Rows.Count = 1
                                    FloridayOrdersShow()
                                    Exit Sub
                                End If
                            End If
                            reader.Close()

                            Cmd.CommandText = "SELECT * FROM floriday_salesorders_boek WHERE orderLineId='" + orderLineId + "'"
                            reader = Cmd.ExecuteReader()
                            If reader.HasRows Then
                                reader.Read()
                                Dim soort_id As Integer = CHint(reader("boek_soortId"))
                                If soort_id = 0 Then
                                    MsgBox("Soort niet bekend van een van de orderlines, probeer opnieuw")
                                    FloridayOrderLines_flx.Rows.Count = 1
                                    FloridayOrdersShow()
                                    Exit Sub
                                End If
                            End If
                            reader.Close()

                        End If

                    End If
                Next


            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag fdcheck: " + ex.Message)
            MsgBox("Fout orderopslag fdcheck: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        Dim tweedevestiging As Boolean = False
        Dim vestigingnummer As Integer = 0
        Dim somethingselected As Boolean = False
        For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
            If FloridayOrderLines_flx.Item(i, fd_selectieCol) = True Then
                somethingselected = True
                If FloridayOrderLines_flx.Rows(i).IsNode Then
                    'no check
                Else
                    Dim SoortId As Integer = FloridayOrderLines_flx.Item(i, fd_soortCol)
                    If SoortId < 1 Then
                        MsgBox("Niet alle soorten zijn bekend, probeer opnieuw.")
                        FloridayOrderLines_flx.Rows.Count = 1
                        FloridayOrdersShow()
                        Exit Sub
                    End If

                    Dim vestigingline As Integer = 1  '1 of 2 vestigingen
                    If SoortId < 10000 Then
                        vestigingline = soorten(GID(soorten, SoortId)).vestiging  'vestiging van line
                    Else
                        vestigingline = mixen(GID(mixen, SoortId - 10000)).vestiging
                    End If
                    If vestigingnummer = 0 Then
                        vestigingnummer = vestigingline
                    End If
                    If vestigingline <> vestigingnummer Then
                        'tweede vestiging gevonden
                        tweedevestiging = True
                    End If


                End If
            End If
        Next
        If somethingselected = True Then
            If tweedevestiging = True Then
                OpslaanFloriday(1)
                OpslaanFloriday(2)
            Else
                OpslaanFloriday(vestigingnummer)
            End If
        Else
            MsgBox("Maak eerst een selectie")
        End If
        FdMenu_Verwerk_but.Enabled = True

    End Sub

    Private Sub OpslaanFloriday(vestigingnummer As Integer)

        FormProgressBar.StartPosition = FormStartPosition.CenterScreen
        FormProgressBar.Show()
        FormProgressBar.DataProgressBar.Value = 5
        Dim selectedrow As Integer = FloridayOrders_flx.RowSel


        Dim query As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand("", Conn)
                Dim reader As OdbcDataReader

                Dim Cmd2 As New OdbcCommand("", Conn)
                Dim reader2 As OdbcDataReader

                Dim header_id As Integer = 0

                Dim fd_afleverdatum As DateTime = Now
                Dim fd_koper_ean As String = "0000000000000"
                Dim fd_kopernaam As String = "Koper onbekend"
                Dim fd_afleverloc As String = ""
                Dim fd_veilingbrief_id As Integer = 0
                Dim fd_vervoerder As Integer = 0
                Dim fd_floridaynr As Integer = 0
                Dim fd_opmerking As String = ""
                Dim fd_decorum As Boolean = False
                Dim fd_kar_id As Integer = 0
                Dim fd_locatie_ean As String = ""
                Dim koppelnummer As Integer = 0
                Dim labelcode_header As Integer = 0

                Cmd.CommandText = "SELECT order_counter from floriday_settings"
                reader = Cmd.ExecuteReader()
                If reader.HasRows Then
                    reader.Read()
                    fd_floridaynr = CHint(reader("order_counter"))
                End If
                fd_floridaynr = fd_floridaynr + 1
                reader.Close()
                Cmd.CommandText = "UPDATE floriday_settings SET order_counter=?"
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", fd_floridaynr)
                Cmd.ExecuteNonQuery()

                Cmd.CommandText = "SELECT koppelnummer from instellingen"
                reader = Cmd.ExecuteReader()
                If reader.HasRows Then
                    reader.Read()
                    koppelnummer = CHint(reader("koppelnummer"))
                End If
                koppelnummer = koppelnummer + 1
                reader.Close()
                Cmd.CommandText = "UPDATE instellingen SET koppelnummer=?"
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", koppelnummer)
                Cmd.ExecuteNonQuery()

                Dim idlist As String = CStr(FloridayOrders_flx.GetData(selectedrow, FindCol(FloridayOrders_flx, "idlist")))
                Dim ids() As String = idlist.Split(New Char() {";"c})

                query = "SELECT * FROM floriday_salesorders WHERE id=?"
                Cmd.Parameters.Clear()
                Cmd.Parameters.AddWithValue("", ids(0))
                Cmd.CommandText = query
                reader = Cmd.ExecuteReader()
                If reader.HasRows Then
                    reader.Read()

                    fd_afleverdatum = CHDate2(reader("boektijd"), Now)
                    Dim customerOrganizationId As String = CHstr(reader("customerOrganizationId"))
                    fd_locatie_ean = CHstr(reader("delivery_location_gln"))
                    Dim loadCarrier As String = CHstr(reader("selectedPackingConfiguration_loadCarrier"))
                    reader.Close()

                    'Select Case loadCarrier
                    '    Case "NONE" : fd_kar_id = 8
                    '    Case "AUCTION_TROLLEY" : fd_kar_id = 3
                    '    Case "DANISH_TROLLEY" : fd_kar_id = 1
                    '    Case "EURO_TROLLEY" : fd_kar_id = 16
                    '    Case "PALLET" : fd_kar_id = 6
                    '    Case "EURO_PALLET" : fd_kar_id = 7
                    'End Select

                    fd_kar_id = CInt(FloridayOrders_flx.GetData(selectedrow, FindCol(FloridayOrders_flx, "Kar type")))


                    Dim fd_rfhRelationId As Integer = 0
                    query = "SELECT * FROM floriday_organizations WHERE organizationId='" + customerOrganizationId + "'"
                    Cmd2.CommandText = query
                    reader2 = Cmd2.ExecuteReader()
                    If reader2.HasRows Then
                        fd_kopernaam = CHstr(reader2("name"))
                        fd_koper_ean = CHstr(reader2("companyGln"))
                        fd_rfhRelationId = CHint(reader2("rfhRelationId"))
                    End If
                    reader2.Close()

                    query = "SELECT * FROM klanten where ean = " + fd_koper_ean
                    Cmd2.CommandText = query
                    reader2 = Cmd2.ExecuteReader()
                    If reader2.HasRows Then
                        fd_afleverloc = CHint(reader2("bdo"))
                        If jenptenhave = False Then
                            If fd_locatie_ean = "8714231208761" Then    'EAN locatie AF TUIN => haagkamp
                                fd_afleverloc = 7
                            End If
                        End If
                        fd_veilingbrief_id = CHint(reader2("veiling_voorkeur"))
                        fd_vervoerder = CHint(reader2("vervoerder"))
                        reader2.Close()
                    Else
                        reader2.Close()
                        'afleverlocatie bepalen
                        query = "SELECT city_name FROM locatielijst WHERE GLN_location_code=?"
                        Cmd.Parameters.Clear()
                        Cmd.Parameters.AddWithValue("", fd_afleverloc)
                        Cmd.CommandText = query
                        reader = Cmd.ExecuteReader()
                        If reader.HasRows Then
                            reader.Read()
                            fd_afleverloc = 3  'westland default
                            fd_veilingbrief_id = 1
                            Dim plaats As String = CHstr(reader("city_name"))
                            reader.Close()

                            If plaats = "AALSMEER" Then
                                fd_afleverloc = 1
                                fd_veilingbrief_id = 2
                            End If
                            If plaats = "RIJNSBURG" Then fd_afleverloc = 8
                            If plaats = "BLEIWIJK" Then fd_afleverloc = 2
                            If plaats = "RHEINMAAS" Then fd_afleverloc = 4
                            If plaats = "EELDE" Then fd_afleverloc = 6
                            If plaats = "BOSKOOP" Then fd_afleverloc = 5
                            If jenptenhave = True Then
                                If fd_locatie_ean = "8714231208761" Then fd_afleverloc = 9
                            Else
                                If fd_locatie_ean = "8714231208761" Then fd_afleverloc = 7
                            End If
                        End If

                        query = "INSERT INTO klanten (klantnaam, ean, veilingnr_westland, veilingnr_vba, veiling_voorkeur," _
                                & "kar_voorkeur, opmerking, fust_voorkeur, decorum, stikker, stikkeropslag, veilingnr_von," _
                                & "vervoerder, bdo, mixen, contact, prijsopslag, actief, foto, opmerking_algemeen, opmerking_contacts," _
                                & "transport_opmerking1, transport_opmerking2, transport_opmerking3, transport_opmerking4," _
                                & "transport_opmerking5, wps_indeling, fustcategorie, hoescategorie, bakstikker, floriday_sync)" _
                                & " VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                        Cmd2.CommandText = query
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", fd_kopernaam)
                        Cmd2.Parameters.AddWithValue("", fd_koper_ean)
                        Cmd2.Parameters.AddWithValue("", fd_rfhRelationId)
                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", 1)

                        Cmd2.Parameters.AddWithValue("", 1)
                        Cmd2.Parameters.AddWithValue("", "")
                        Cmd2.Parameters.AddWithValue("", 1)
                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", 0)

                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", fd_afleverloc)
                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", "")
                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", 1)
                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", "")
                        Cmd2.Parameters.AddWithValue("", "")

                        Cmd2.Parameters.AddWithValue("", "")
                        Cmd2.Parameters.AddWithValue("", "")
                        Cmd2.Parameters.AddWithValue("", "")
                        Cmd2.Parameters.AddWithValue("", "")

                        Cmd2.Parameters.AddWithValue("", "")
                        Cmd2.Parameters.AddWithValue("", 1)
                        Cmd2.Parameters.AddWithValue("", 1)
                        Cmd2.Parameters.AddWithValue("", 1)
                        Cmd2.Parameters.AddWithValue("", 0)
                        Cmd2.Parameters.AddWithValue("", 0)

                        Cmd2.ExecuteNonQuery()
                        MsgBox("Koperinfo '" + fd_kopernaam + "'  niet gevonden, nieuwe klant is aangemaakt.")
                        Load_Database_kopers()
                        fd_vervoerder = 0
                    End If
                End If


                'write info to order header database 

                query = "INSERT INTO orderheaders (afleverdatum,invoerdatumtijd,koper_ean,koper_naam,afleverloc,veilingbrief_id," _
                      & "vervoerder_id,contact,opmerking,inlog_naam,prijs_opslag,agenda_mark,decorum,status,kar_id,versie,afleverloc_ean,vestiging,koppelnummer,floridayflag) " _
                      & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                Cmd.CommandText = query
                Cmd.Parameters.Clear()

                Cmd.Parameters.AddWithValue("", Format(fd_afleverdatum, "yyyy-MM-dd HH:mm"))                       ' 1 afleverdatum
                Cmd.Parameters.AddWithValue("", Format(Now, "yyyy-MM-dd HH:mm"))
                Cmd.Parameters.AddWithValue("", fd_koper_ean)                              ' 4 koper_ean
                Cmd.Parameters.AddWithValue("", fd_kopernaam)                    ' 5 koper_naam
                Cmd.Parameters.AddWithValue("", fd_afleverloc)                             ' 6 afleverloc
                Cmd.Parameters.AddWithValue("", fd_veilingbrief_id)                        ' 7 veilingbrief id
                Cmd.Parameters.AddWithValue("", fd_vervoerder)                             ' 8 vervoerder id
                Cmd.Parameters.AddWithValue("", "")                                        ' 9 contact
                Cmd.Parameters.AddWithValue("", "FD" + Trim(Str(fd_floridaynr)))           '10 opmerking
                Cmd.Parameters.AddWithValue("", Login_name)                                '11 inlog_naam
                Cmd.Parameters.AddWithValue("", 0)                                         '12 prijs_opslag
                Cmd.Parameters.AddWithValue("", 1)                                         '13 agenda_mark
                Cmd.Parameters.AddWithValue("", fd_decorum)                                '14 decorum
                Cmd.Parameters.AddWithValue("", 20)                                        '15 status -> stikkers

                Cmd.Parameters.AddWithValue("", fd_kar_id)    'kar_id
                Cmd.Parameters.AddWithValue("", 0) 'versie nr = 0 voor nieuwe orders
                Cmd.Parameters.AddWithValue("", fd_locatie_ean)
                Cmd.Parameters.AddWithValue("", vestigingnummer)
                Cmd.Parameters.AddWithValue("", koppelnummer)
                Cmd.Parameters.AddWithValue("", 1) 'floriday order
                Cmd.ExecuteNonQuery()

                Cmd.CommandText = "SELECT LAST_INSERT_ID()"
                header_id = Convert.ToInt32(Cmd.ExecuteScalar())


                FormProgressBar.DataProgressBar.Value = 30


                Dim selectiecol As Integer = FindCol(FloridayOrderLines_flx, "Selectie")
                Dim parentcol As Integer = FindCol(FloridayOrderLines_flx, "parentrow")
                Dim orderlineidcol As Integer = FindCol(FloridayOrderLines_flx, "orderLineId")
                Dim aantalcol As Integer = FindCol(FloridayOrderLines_flx, "Aantal")
                'OrderLines
                Dim parentcheckid As Integer = -1

                'loop door flexgrid voor selecties, als parent is geselecteerd dan childs skippen
                Dim boek_orderlineId As Integer = 0

                For selectloop = 2 To FloridayOrderLines_flx.Rows.Count - 1
                    Dim orderLineId As String = ""
                    If FloridayOrderLines_flx.Item(selectloop, selectiecol) = True And FloridayOrderLines_flx.Rows(selectloop).IsNode Then
                        'geselecteerde parentnode -> skip childs in next run
                        parentcheckid = FloridayOrderLines_flx.Item(selectloop, parentcol)
                    End If
                    If FloridayOrderLines_flx.Item(selectloop, selectiecol) = False And FloridayOrderLines_flx.Rows(selectloop).IsNode Then
                        'niet geselecteerde parentnode -> skip
                        GoTo skip_verwerkline
                    End If

                    'child van verwerkte parent? -> skip
                    If FloridayOrderLines_flx.Item(selectloop, selectiecol) = True And Not FloridayOrderLines_flx.Rows(selectloop).IsNode Then
                        If FloridayOrderLines_flx.Item(selectloop, parentcol) = parentcheckid Then
                            'skip
                            orderLineId = FloridayOrderLines_flx.Item(selectloop, orderlineidcol)
                            GoTo next_verwerkline
                        End If
                    End If

                    If FloridayOrderLines_flx.Item(selectloop, selectiecol) = False And Not FloridayOrderLines_flx.Rows(selectloop).IsNode Then
                        GoTo skip_verwerkline
                    End If

                    orderLineId = FloridayOrderLines_flx.Item(selectloop, orderlineidcol)


                    query = "SELECT * FROM floriday_salesorders WHERE orderLineId='" + orderLineId + "'"
                    Cmd.CommandText = query
                    reader = Cmd.ExecuteReader()
                    If reader.HasRows Then
                        reader.Read()
                        Dim DBId As Integer = CHint(reader("Id"))
                        Dim customerOrderId As String = CHstr(reader("customerOrderId"))
                        Dim salesChannelOrderId As String = CHstr(reader("salesChannelOrderId"))
                        Dim customerOrganizationId As String = CHstr(reader("customerOrganizationId"))
                        Dim supplyLineId As String = CHstr(reader("supplyLineId"))
                        Dim tradeItemId As String = CHstr(reader("tradeItemId"))
                        Dim salesChannel As String = CHstr(reader("salesChannel"))
                        Dim numberOfPieces As Integer = CHint(reader("numberOfPieces"))
                        Dim piecesPerPackage As Integer = CHint(reader("selectedPackingConfiguration_piecesPerPackage"))
                        Dim pricePerPiece_currency As String = CHstr(reader("pricePerPiece_currency"))
                        Dim pricePerPiece_value As Double = CHdouble(reader("pricePerPiece_value"))
                        reader.Close()


                        ' aanbod lijn ophalen voor referentie
                        Dim agreementReference_code As String = ""
                        Dim agreementReference_description As String = ""
                        query = "SELECT * FROM floriday_supply WHERE supplyLineId='" + supplyLineId + "'"
                        Cmd2.CommandText = query
                        reader2 = Cmd2.ExecuteReader()
                        If reader2.HasRows Then
                            reader2.Read()
                            agreementReference_code = CHstr(reader2("agreementReference_code"))
                            agreementReference_description = CHstr(reader2("agreementReference_description"))
                        End If
                        reader2.Close()

                        'Get new SDF barcode
                        Dim sdfbarcode As Integer = 0
                        Cmd.CommandText = "SELECT sdfbarcode from instellingen"
                        reader = Cmd.ExecuteReader()
                        If reader.HasRows Then
                            reader.Read()
                            sdfbarcode = CHint(reader("sdfbarcode"))
                            sdfbarcode = sdfbarcode + 1
                            If sdfbarcode >= 100000000 Then sdfbarcode = 1
                            reader.Close()
                            Cmd.CommandText = "UPDATE instellingen SET sdfbarcode = ?"
                            Cmd.Parameters.Clear()
                            Cmd.Parameters.AddWithValue("", sdfbarcode)
                            Cmd.ExecuteNonQuery()
                        End If

                        query = "SELECT * FROM floriday_salesorders_boek WHERE orderLineId='" + orderLineId + "'"
                        Cmd2.CommandText = query
                        reader2 = Cmd2.ExecuteReader()
                        If reader2.HasRows Then
                            reader2.Read()  'oude data ophalen
                            Dim soort_id As Integer = CHint(reader2("boek_soortId"))
                            Dim hoes_id As Integer = CHint(reader2("boek_hoesId"))
                            Dim accessoire1 As Integer = CHint(reader2("boek_accessoire1"))
                            Dim accessoire2 As Integer = CHint(reader2("boek_accessoire2"))
                            Dim accessoire3 As Integer = CHint(reader2("boek_accessoire3"))
                            Dim accessoire4 As Integer = CHint(reader2("boek_accessoire4"))
                            Dim accessoire5 As Integer = CHint(reader2("boek_accessoire5"))
                            Dim accessoire6 As Integer = CHint(reader2("boek_accessoire6"))
                            Dim accessoire7 As Integer = CHint(reader2("boek_accessoire7"))
                            Dim accessoire8 As Integer = CHint(reader2("boek_accessoire8"))
                            Dim opmerking As String = CHstr(reader2("boek_opmerking"))
                            Dim wpsfilter As Integer = CHint(reader2("boek_wpsfilter"))
                            Dim BoekStatus As Integer = CHint(reader2("boek_status"))
                            Dim fust_id As Integer = CHint(reader2("boek_fustid"))
                            Dim stikkercode As Integer = CHint(reader2("boek_stikkercode"))
                            Dim filterstoegepast As String = CHstr(reader2("filterstoegepast"))
                            Dim selectie As Boolean = CHbool(reader2("selectie"))
                            Dim stikkerstatus As Integer = CHint(reader2("boek_stikkerstatus"))
                            If labelcode_header < stikkerstatus Then labelcode_header = stikkerstatus
                            reader2.Close()

                            Dim rijpheid As Integer = 0
                            Dim hoogte As Integer = 0
                            Dim diameter As Integer = 0
                            Dim schermen As Integer = 0
                            Dim keurcode As Integer = 0
                            Dim potmaat As Integer = 0
                            Dim transporthoogte As Integer = 0

                            query = "SELECT id FROM floriday_tradeitem WHERE tradeItemId='" + tradeItemId + "'"
                            Cmd2.CommandText = query
                            reader2 = Cmd2.ExecuteReader()
                            If reader2.HasRows Then
                                reader2.Read()  'oude data ophalen
                                Dim parentid As Integer = CHint(reader2("Id"))
                                reader2.Close()

                                query = "SELECT * FROM floriday_tradeitem_characteristics WHERE parent_id=" + Str(parentid)
                                Cmd2.CommandText = query
                                reader2 = Cmd2.ExecuteReader()
                                Do While reader2.Read()  'oude data ophalen
                                    Dim vbnCode As String = CHstr(reader2("vbnCode"))
                                    Dim vbnValueCode As String = CHstr(reader2("vbnValueCode"))
                                    Select Case vbnCode
                                        Case "S05" : rijpheid = CInt(Val(vbnValueCode))
                                        Case "S02" : hoogte = CInt(Val(vbnValueCode))
                                        Case "S08" : diameter = CInt(Val(vbnValueCode))
                                        Case "S09" : schermen = CInt(Val(vbnValueCode))
                                        Case "S01" : potmaat = CInt(Val(vbnValueCode))
                                        Case "S15" : transporthoogte = CInt(Val(vbnValueCode))
                                    End Select
                                Loop
                                reader2.Close()

                            End If


                            'Dim fdl_aantal As Integer = CInt(numberOfPieces / piecesPerPackage)
                            Dim fdl_aantal As Integer = FloridayOrderLines_flx.Item(selectloop, aantalcol)
                            Dim fdl_soortid As Integer = soort_id
                            Dim fdl_fustid As Integer = fust_id
                            Dim fdl_hoesid As Integer = hoes_id
                            Dim fdl_prijs As Double = pricePerPiece_value
                            Dim gp As Integer = 1
                            Dim fdl_rijpheid As Integer = rijpheid
                            Dim fdl_hoogte As Integer = hoogte
                            Dim fdl_diameter As Integer = diameter
                            Dim fdl_schermen As Integer = schermen
                            Dim fdl_keurcode As Integer = keurcode
                            Dim fdl_acce1 As Integer = accessoire1
                            Dim fdl_acce2 As Integer = accessoire2
                            Dim fdl_acce4 As Integer = accessoire3
                            Dim fdl_acce5 As Integer = accessoire4
                            Dim fdl_acce6 As Integer = accessoire5
                            Dim fdl_acce7 As Integer = accessoire6
                            Dim fdl_acce8 As Integer = accessoire7
                            Dim fdl_acce9 As Integer = accessoire8
                            Dim fdl_kopercode As String = salesChannelOrderId
                            Dim fdl_potmaat As Integer = potmaat

                            Select Case stikkercode
                                Case 1 : opmerking = "<Stikker>"

                                Case 3 : opmerking = "<Floraconnect>"

                                Case 6 : opmerking = "<Stikker LB>"

                            End Select


                            Dim fdl_opmerking As String = opmerking
                            Dim fdl_floridaynr As String = "FD" + Trim(Str(fd_floridaynr))
                            Dim fdl_actie_type As Integer = 0
                            Dim fdl_retail_prijs As String = ""
                            Dim fdl_label_ean As String = ""
                            Dim fdl_label_status As Integer = stikkerstatus
                            Dim fdl_labelref As String = ""
                            Dim fdl_labelcode As Integer = stikkercode
                            Dim fdl_vestiging As Integer = vestigingnummer
                            Dim fdl_sdfbarcode As Integer = sdfbarcode
                            Dim fdl_transporthoogte As Integer = transporthoogte
                            Dim fdl_wpsfilternr As Integer = wpsfilter
                            Dim fdl_supplyref As String = Mid(agreementReference_code + ":" + agreementReference_description, 1, 39)


                            Dim vestigingline As Integer = 0
                            If soort_id < 10000 Then
                                vestigingline = soorten(GID(soorten, soort_id)).vestiging  'vestiging van line
                            Else
                                vestigingline = mixen(GID(mixen, soort_id - 10000)).vestiging
                            End If

                            If vestigingline = vestigingnummer Then

                                query = "INSERT INTO orderlines(OrderHeader_id,Koper_naam,Aantal,Soort_id,Fust_id,Prijs,GP,Rijpheid,Hoogte,Diameter," _
                                    & "Accessoire1,Accessoire2,Accessoire3,Accessoire4,Accessoire5,Kopercode,Potmaat,Wps_filternr,Opmerking,Keurcode," _
                                    & "Transporthoogte,Florecom_nr,actie_type,Wps_filternr2,retail_prijs,label_ean,label_status,label_referentie,labelbericht_code,vestiging,sdfbarcode,floridaynr,supplyref) " _
                                    & "VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"
                                Cmd.CommandText = query
                                Cmd.Parameters.Clear()
                                Cmd.Parameters.AddWithValue("", header_id)                              ' 1 orderheader_id 
                                Cmd.Parameters.AddWithValue("", fd_kopernaam)                           ' 2 koper_naam
                                Cmd.Parameters.AddWithValue("", fdl_aantal)                             ' 3 aantal
                                Cmd.Parameters.AddWithValue("", fdl_soortid)                            ' 4 soort_id
                                Cmd.Parameters.AddWithValue("", fdl_fustid)                             ' 5 fust_id
                                Cmd.Parameters.AddWithValue("", fdl_prijs)                              ' 6 prijs
                                Cmd.Parameters.AddWithValue("", 1)                                      ' 7 GP
                                Cmd.Parameters.AddWithValue("", fdl_rijpheid)                           ' 8 Rijpheid
                                Cmd.Parameters.AddWithValue("", fdl_hoogte)                             ' 9 hoogte
                                Cmd.Parameters.AddWithValue("", fdl_diameter)                           '10 Diameter
                                Cmd.Parameters.AddWithValue("", fdl_acce1)                              '11 Accessoire1
                                Cmd.Parameters.AddWithValue("", fdl_acce2)                              '12 Accessoire2
                                Cmd.Parameters.AddWithValue("", fdl_hoesid)                             '13 Hoes
                                Cmd.Parameters.AddWithValue("", fdl_acce4)                              '14 Accessoire4
                                Cmd.Parameters.AddWithValue("", fdl_acce5)                              '15 Accessoire5
                                Cmd.Parameters.AddWithValue("", fdl_kopercode)                          '16 kopercode
                                Cmd.Parameters.AddWithValue("", fdl_potmaat * 10)                            '17 potmaat

                                Dim wpsfilterid As Integer = fdl_wpsfilternr
                                Dim wpsfilterid2 As Integer = 0
                                'GetWPSFilterNr(fc_koper_ean, fcl_soortid, fcl_acces1, wpsfilterid, wpsfilterid2)

                                Cmd.Parameters.AddWithValue("", wpsfilterid)                            '18 wps filternr
                                Cmd.Parameters.AddWithValue("", fdl_opmerking)                          '19 Opmerking
                                Cmd.Parameters.AddWithValue("", 0)                                      '20 Keurcode
                                Cmd.Parameters.AddWithValue("", fdl_transporthoogte)                    '21 Transporthoogte
                                Cmd.Parameters.AddWithValue("", fdl_floridaynr)                         '22 Florecom_nr
                                Cmd.Parameters.AddWithValue("", fdl_actie_type)                         '23 Actie_type
                                Cmd.Parameters.AddWithValue("", wpsfilterid2)
                                Cmd.Parameters.AddWithValue("", fdl_retail_prijs)
                                Cmd.Parameters.AddWithValue("", fdl_label_ean)
                                Cmd.Parameters.AddWithValue("", fdl_label_status)
                                Cmd.Parameters.AddWithValue("", fdl_labelref)
                                Cmd.Parameters.AddWithValue("", fdl_labelcode)
                                Cmd.Parameters.AddWithValue("", vestigingnummer)
                                Cmd.Parameters.AddWithValue("", fdl_sdfbarcode)
                                Cmd.Parameters.AddWithValue("", fdl_floridaynr)
                                Cmd.Parameters.AddWithValue("", fdl_supplyref)
                                Cmd.ExecuteNonQuery()

                                Cmd.CommandText = "SELECT LAST_INSERT_ID()"
                                boek_orderlineId = Convert.ToInt32(Cmd.ExecuteScalar())

                                'fd order bevestigen
next_verwerkline:
                                Cmd.CommandText = "UPDATE floriday_salesorders_boek SET boek_orderlineId=?, boek_floridaynr=? WHERE orderLineId = '" + orderLineId + "'"
                                Cmd.Parameters.Clear()
                                Cmd.Parameters.AddWithValue("", boek_orderlineId)
                                Cmd.Parameters.AddWithValue("", fd_floridaynr)
                                Cmd.ExecuteNonQuery()

                                Cmd.CommandText = "UPDATE floriday_salesorders SET boekstatus=? WHERE orderLineId = '" + orderLineId + "'"
                                Cmd.Parameters.Clear()
                                Cmd.Parameters.AddWithValue("", fd_floridaynr)
                                Cmd.ExecuteNonQuery()
skip_verwerkline:
                            End If

                        End If
                    End If


                Next

                'new status for labelorder
                If labelcode_header = 6 Then   'labelbericht of lemkes
                    Cmd.CommandText = "UPDATE orderheaders SET status=24, sticker=6 WHERE header_id = " + Str(header_id)
                    Cmd.ExecuteNonQuery()
                End If
                If labelcode_header = 3 Or labelcode_header = 1 Then
                    Cmd.CommandText = "UPDATE orderheaders Set status=21, sticker=1 WHERE header_id = " + Str(header_id)
                    Cmd.ExecuteNonQuery()
                End If


                'karindeling of order aanmaken

                ' !!!!!!!!! UPDATE AGENDA
                user_date_change = False
                Order_MonthCalendar.SelectionStart = fd_afleverdatum
                Order_MonthCalendar.SelectionEnd = fd_afleverdatum
                user_date_change = True
                BoekStatus = 8
                Update_Boek(1, fd_koper_ean)

                Maak_Karindeling(False, fd_kar_id, header_id, fd_afleverdatum)

                FloridayOrderLines_flx.Rows.Count = 1
                FloridayOrdersShow()

            End Using
        Catch ex As Exception
            ErrorLog("Fout orderopslag floriday " + ex.Message)
            MsgBox("Fout orderopslag floriday " + ex.Message, MsgBoxStyle.OkOnly)
        End Try


        FormProgressBar.DataProgressBar.Value = 95
        FormProgressBar.Close()
        Me.Cursor = Cursors.Default


    End Sub

    Private Sub FloridayOrderLines_flx_AfterEdit(sender As Object, e As RowColEventArgs) Handles FloridayOrderLines_flx.AfterEdit
        Dim row As Integer = e.Row
        Dim col As Integer = e.Col
        Dim colname As String = CStr(FloridayOrderLines_flx.Item(0, col)).ToLower
        Dim orderlineid As String = ""
        Dim OldSoortId As Integer = 0
        Dim idcol As Integer = 0
        Dim OldFustId As Integer = 0
        Dim selectiecol As Integer = 0
        Dim parentcol As Integer = 0
        Dim lineidcol As Integer = 0
        Try
            'fetch old data to make checks
            idcol = FindCol(FloridayOrderLines_flx, "orderLineId")
            orderlineid = FloridayOrderLines_flx.Item(row, idcol)
            idcol = FindCol(FloridayOrderLines_flx, "Soort")
            OldSoortId = FloridayOrderLines_flx.Item(row, idcol)
            idcol = FindCol(FloridayOrderLines_flx, "Fust")
            OldFustId = FloridayOrderLines_flx.Item(row, idcol)
            selectiecol = FindCol(FloridayOrderLines_flx, "Selectie")
            parentcol = FindCol(FloridayOrderLines_flx, "parentrow")
            lineidcol = FindCol(FloridayOrderLines_flx, "orderLineId")
        Catch ex As Exception
            Exit Sub
        End Try

        Dim query As String = ""
        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd2 As New OdbcCommand(query, Conn)
                Dim Reader2 As OdbcDataReader

                If col = selectiecol Then  'selecties -> parent child
                    Dim parentid As Integer = FloridayOrderLines_flx(row, parentcol)
                    If FloridayOrderLines_flx.Rows(row).IsNode Then
                        'parent node geselecteerd -> childnodes aanpassen
                        If FloridayOrderLines_flx.Item(row, col) = False Then
                            For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                                If FloridayOrderLines_flx(i, parentcol) = parentid And Not FloridayOrderLines_flx.Rows(i).IsNode Then
                                    FloridayOrderLines_flx(i, selectiecol) = False
                                End If
                            Next
                        Else
                            For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                                If FloridayOrderLines_flx(i, parentcol) = parentid And Not FloridayOrderLines_flx.Rows(i).IsNode Then
                                    FloridayOrderLines_flx(i, selectiecol) = True
                                End If
                            Next
                        End If
                    Else
                        'child node selection changed -> parent aanpassen?
                        Dim childstatus As Boolean = FloridayOrderLines_flx.Item(row, col)
                        Dim selectedchildfound As Boolean = False
                        Dim notselectedchildfound As Boolean = False
                        For i = 2 To FloridayOrderLines_flx.Rows.Count - 1  'als alle childnodes dezelfde status hebben -> parent aanpassen
                            If FloridayOrderLines_flx(i, parentcol) = parentid And Not FloridayOrderLines_flx.Rows(i).IsNode Then
                                If FloridayOrderLines_flx(i, selectiecol) = True Then selectedchildfound = True
                                If FloridayOrderLines_flx(i, selectiecol) = False Then notselectedchildfound = True
                            End If
                        Next
                        'set parent
                        If selectedchildfound = True And notselectedchildfound = False Then
                            For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                                If FloridayOrderLines_flx(i, parentcol) = parentid And FloridayOrderLines_flx.Rows(i).IsNode Then
                                    FloridayOrderLines_flx(i, selectiecol) = True
                                End If
                            Next
                        Else
                            For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                                If FloridayOrderLines_flx(i, parentcol) = parentid And FloridayOrderLines_flx.Rows(i).IsNode Then
                                    FloridayOrderLines_flx(i, selectiecol) = False
                                End If
                            Next
                        End If
                    End If

                    For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                        If FloridayOrderLines_flx.Item(i, parentcol) = parentid Then
                            orderlineid = FloridayOrderLines_flx.Item(i, lineidcol)
                            Dim vselectie As Integer = FloridayOrderLines_flx(i, selectiecol)
                            'save all oderlines from this parent

                            query = "UPDATE floriday_salesorders_boek SET selectie=? WHERE orderLineId=?"
                            Cmd2.CommandText = query
                            Cmd2.Parameters.Clear()
                            Cmd2.Parameters.AddWithValue("", vselectie)
                            Cmd2.Parameters.AddWithValue("", orderlineid)
                            Cmd2.ExecuteNonQuery()

                        End If
                    Next


                    Exit Sub
                End If

                Dim selectie As Boolean = True
                Dim soort_id As Integer = 0
                Dim fust_id As Integer = 0
                Dim hoes_id As Integer = 0
                Dim accessoire1 As Integer = 0
                Dim accessoire2 As Integer = 0
                Dim accessoire3 As Integer = 0
                Dim accessoire4 As Integer = 0
                Dim accessoire5 As Integer = 0
                Dim accessoire6 As Integer = 0
                Dim accessoire7 As Integer = 0
                Dim accessoire8 As Integer = 0

                query = "SELECT * FROM floriday_salesorders_boek WHERE orderLineId='" + orderlineid + "'"
                Cmd2.CommandText = query
                Reader2 = Cmd2.ExecuteReader()
                If Reader2.HasRows Then
                    Reader2.Read()  'oude data ophalen
                    soort_id = CHint(Reader2("boek_soortId"))
                    hoes_id = CHint(Reader2("boek_hoesId"))
                    accessoire1 = CHint(Reader2("boek_accessoire1"))
                    accessoire2 = CHint(Reader2("boek_accessoire2"))
                    accessoire3 = CHint(Reader2("boek_accessoire3"))
                    accessoire4 = CHint(Reader2("boek_accessoire4"))
                    accessoire5 = CHint(Reader2("boek_accessoire5"))
                    accessoire6 = CHint(Reader2("boek_accessoire6"))
                    accessoire7 = CHint(Reader2("boek_accessoire7"))
                    accessoire8 = CHint(Reader2("boek_accessoire8"))
                    fust_id = CHint(Reader2("boek_fustid"))
                End If
                Reader2.Close()


                Select Case colname
                    Case "soort"
                        Dim newsoortid As Integer = FloridayOrderLines_flx.Item(row, col)
                        If newsoortid >= 10000 Then
                            Dim newfustid As Integer = mixen(GID(mixen, newsoortid - 10000)).fust
                            Dim newvbnfustcode As Integer = fust(GID(fust, newfustid)).fustcode
                            Dim oldvbnfustcode As Integer = fust(GID(fust, fust_id)).fustcode
                            If newvbnfustcode <> oldvbnfustcode Then
                                MsgBox("De fustcode uit de bestelling komt niet overeen met de fustcode van de geselecteerde mix, de verandering wordt teruggedraaid")
                                FloridayOrderLines_flx.Item(row, col) = soort_id
                            End If

                        End If

                    Case "fust"
                        Dim newfustid As Integer = FloridayOrderLines_flx.Item(row, col)

                        Dim newvbnfustcode As Integer = fust(GID(fust, newfustid)).fustcode
                        Dim oldvbnfustcode As Integer = fust(GID(fust, fust_id)).fustcode
                        If newvbnfustcode <> oldvbnfustcode Then
                            MsgBox("De fustcode uit de bestelling komt niet overeen met de geselecteerde fustcode, de verandering wordt teruggedraaid")
                            FloridayOrderLines_flx.Item(row, col) = fust_id
                        End If

                End Select

                selectie = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "selectie"))
                soort_id = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "soort"))
                hoes_id = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "hoes"))
                accessoire1 = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "accessoire1"))
                accessoire2 = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "accessoire2"))
                accessoire4 = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "accessoire4"))
                accessoire5 = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "accessoire5"))
                accessoire6 = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "accessoire6"))
                accessoire7 = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "accessoire7"))
                accessoire8 = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "accessoire8"))
                Dim opmerking As String = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "opmerking"))
                Dim wpsfilter As String = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "wpsfilter"))
                Dim wpsfiltercode As Integer = 0
                If col = FindCol(FloridayOrderLines_flx, "wpsfilter") Then
                    For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                        FloridayOrderLines_flx.SetCellStyle(i, col, FloridayOrderLines_flx.Styles.Normal)
                    Next
                End If
                If selectedwpsvalue > 0 Then
                    wpsfiltercode = selectedwpsvalue

                    selectedwpsvalue = 0
                End If

                If wpsfilter = "" Then wpsfilter = 0
                fust_id = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "fust"))
                Dim stikkercode As String = FloridayOrderLines_flx.Item(row, FindCol(FloridayOrderLines_flx, "stikkercode"))
                If stikkercode = "" Then stikkercode = 0

                If FloridayOrderLines_flx.Rows(row).IsNode Then

                    Dim parentid As Integer = FloridayOrderLines_flx.Item(row, parentcol)

                    For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                        If FloridayOrderLines_flx.Item(i, parentcol) = parentid Then
                            orderlineid = FloridayOrderLines_flx.Item(i, lineidcol)

                            'save all oderlines from this parent

                            query = "UPDATE floriday_salesorders_boek SET boek_soortId=?,boek_hoesId=?,boek_accessoire1=?," _
                                        & "boek_accessoire2=?,boek_accessoire3=?,boek_accessoire4=?,boek_accessoire5=?,boek_accessoire6=?,boek_accessoire7=?," _
                                        & "boek_accessoire8=?,boek_opmerking=?,boek_wpsfilter=?,boek_status=?,boek_fustid=?,boek_stikkercode=?,selectie=?" _
                                        & " WHERE orderLineId=?"
                            Cmd2.CommandText = query
                            Cmd2.Parameters.Clear()
                            Cmd2.Parameters.AddWithValue("", soort_id)
                            Cmd2.Parameters.AddWithValue("", hoes_id)
                            Cmd2.Parameters.AddWithValue("", accessoire1)
                            Cmd2.Parameters.AddWithValue("", accessoire2)
                            Cmd2.Parameters.AddWithValue("", accessoire3)
                            Cmd2.Parameters.AddWithValue("", accessoire4)
                            Cmd2.Parameters.AddWithValue("", accessoire5)
                            Cmd2.Parameters.AddWithValue("", accessoire6)
                            Cmd2.Parameters.AddWithValue("", accessoire7)
                            Cmd2.Parameters.AddWithValue("", accessoire8)

                            Cmd2.Parameters.AddWithValue("", Mid(opmerking, 1, 79))
                            Cmd2.Parameters.AddWithValue("", wpsfiltercode)
                            Cmd2.Parameters.AddWithValue("", 0) 'status
                            Cmd2.Parameters.AddWithValue("", fust_id)
                            Cmd2.Parameters.AddWithValue("", stikkercode)
                            Cmd2.Parameters.AddWithValue("", selectie)
                            Cmd2.Parameters.AddWithValue("", orderlineid)
                            Cmd2.ExecuteNonQuery()

                        End If
                    Next
                    Dim selectedrow As Integer = FloridayOrders_flx.RowSel
                    If selectedrow >= 1 Then
                        CheckOrderlines(True, selectedrow)
                    End If

                Else
                    'save 1 orderline
                    query = "UPDATE floriday_salesorders_boek SET boek_soortId=?,boek_hoesId=?,boek_accessoire1=?," _
                        & "boek_accessoire2=?,boek_accessoire3=?,boek_accessoire4=?,boek_accessoire5=?,boek_accessoire6=?,boek_accessoire7=?," _
                        & "boek_accessoire8=?,boek_opmerking=?,boek_wpsfilter=?,boek_status=?,boek_fustid=?,boek_stikkercode=?" _
                        & " WHERE orderLineId=?"
                    Cmd2.CommandText = query
                    Cmd2.Parameters.Clear()
                    Cmd2.CommandText = query
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", soort_id)
                    Cmd2.Parameters.AddWithValue("", hoes_id)
                    Cmd2.Parameters.AddWithValue("", accessoire1)
                    Cmd2.Parameters.AddWithValue("", accessoire2)
                    Cmd2.Parameters.AddWithValue("", accessoire3)
                    Cmd2.Parameters.AddWithValue("", accessoire4)
                    Cmd2.Parameters.AddWithValue("", accessoire5)
                    Cmd2.Parameters.AddWithValue("", accessoire6)
                    Cmd2.Parameters.AddWithValue("", accessoire7)
                    Cmd2.Parameters.AddWithValue("", accessoire8)

                    Cmd2.Parameters.AddWithValue("", Mid(opmerking, 1, 79))
                    Cmd2.Parameters.AddWithValue("", wpsfiltercode)
                    Cmd2.Parameters.AddWithValue("", 0) 'status
                    Cmd2.Parameters.AddWithValue("", fust_id)
                    Cmd2.Parameters.AddWithValue("", stikkercode)
                    Cmd2.Parameters.AddWithValue("", orderlineid)
                    Cmd2.ExecuteNonQuery()

                End If
            End Using
        Catch ex As Exception
            MessageBox.Show("Fout bij floriday orderlines ophalen " + ex.ToString, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try

    End Sub

    Private Sub FloridayOrderLines_flx_CellButtonClick(sender As Object, e As RowColEventArgs) Handles FloridayOrderLines_flx.CellButtonClick

        'node met meer als 1 item? alert
        Dim exitnode As Boolean = True
        If FloridayOrderLines_flx.Rows(e.Row).IsNode Then
            If e.Row + 2 < FloridayOrderLines_flx.Rows.Count Then
                If FloridayOrderLines_flx.Rows(e.Row + 2).IsNode Then
                    exitnode = False
                End If
            End If
            If e.Row + 2 = FloridayOrderLines_flx.Rows.Count Then
                exitnode = False
            End If
        Else
            exitnode = False
        End If
        If exitnode = True Then
            MsgBox("Deze line bevat meerdere orders, verwerk de orders afzonderlijk")
            Exit Sub
        End If

        Dim col As Integer = e.Col
        Dim row As Integer = e.Row
        Dim stikkercol As Integer = FindCol(FloridayOrderLines_flx, "stikkercode")
        Dim filtercol As Integer = FindCol(FloridayOrderLines_flx, "Verander filters")
        Dim idcol As Integer = FindCol(FloridayOrderLines_flx, "orderLineId")
        Dim orderlineid As String = FloridayOrderLines_flx.Item(row, idcol)
        Dim aantalcol As Integer = FindCol(FloridayOrderLines_flx, "Aantal")
        Dim correctiecol As Integer = FindCol(FloridayOrderLines_flx, "Correctie")
        Dim wisopmerkingcol As Integer = FindCol(FloridayOrderLines_flx, "XO")
        Dim opmerkingcol As Integer = FindCol(FloridayOrderLines_flx, "Opmerking")

        If col = stikkercol Then
            'generate labels
            Dim aantal_boek As Integer = 0
            Dim labelnummer As Integer = 0
            Dim soort_id As Integer = -1
            Dim fust_id As Integer = -1
            Dim koper_ean As String = ""
            Dim opmerking As String = ""
            Dim accessoire1 As Integer = 0
            Dim query As String = ""
            Dim kopernaam As String = "Koper onbekend"
            Dim customerOrganizationId As String = ""
            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim Cmd2 As New OdbcCommand(query, Conn)
                    Dim Reader2 As OdbcDataReader

                    query = "SELECT * FROM floriday_salesorders_boek WHERE orderLineId='" + orderlineid + "'"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        Reader2.Read()  'oude data ophalen
                        aantal_boek = CHint(Reader2("boek_aantal"))
                        soort_id = CHint(Reader2("boek_soortId"))
                        accessoire1 = CHint(Reader2("boek_accessoire1"))
                        fust_id = CHint(Reader2("boek_fustid"))
                        opmerking = CHstr(Reader2("boek_opmerking"))
                        customerOrganizationId = CHstr(Reader2("customerOrganizationId"))
                    End If
                    Reader2.Close()

                    If FloridayOrderLines_flx.Rows(row).IsNode Then
                        aantal_boek = FloridayOrderLines_flx.Item(row, aantalcol)
                    End If
                    'kopernaam ophalen

                    query = "SELECT * FROM floriday_organizations WHERE organizationId='" + customerOrganizationId + "'"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        kopernaam = CHstr(Reader2("name"))
                        koper_ean = CHstr(Reader2("companyGln"))
                    End If
                    Reader2.Close()

                End Using
            Catch ex As Exception
                MessageBox.Show("Database fout: (floridayorder stikkers)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try

            If aantal_boek <= 0 Then
                MsgBox("Het aantal planten moet bekend zijn")
                Exit Sub
            End If

            Dim soort As String = soorten(GID(soorten, soort_id)).soortnaam
            Dim accessoire1naam As String = ""
            If accessoire(GID(accessoire, accessoire1)).fust > 0 Then
                accessoire1naam = accessoire(GID(accessoire, accessoire1)).naam
            End If

            LabelWindow.Init(labelnummer, soort_id, aantal_boek, fust_id, row, koper_ean, kopernaam, opmerking, accessoire1naam, 2)
            LabelWindow.Show()

        End If

        If col = filtercol Then
            FloridayFilters.Init(orderlineid)
            FloridayFilters.Show()

        End If

        If col = correctiecol Then

            Form14.Init(orderlineid)
            Form14.StartPosition = FormStartPosition.CenterScreen
            Form14.Show()

        End If

        If col = wisopmerkingcol Then
            Dim query As String = ""
            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()
                    Dim Cmd2 As New OdbcCommand(query, Conn)
                    Dim reader2 As OdbcDataReader

                    Dim opmerking As String = ""
                    Dim customerOrganizationId As String = ""
                    Dim kopernaam As String = ""

                    query = "SELECT * FROM floriday_salesorders_boek WHERE orderLineId='" + orderlineid + "'"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        Reader2.Read()  'oude data ophalen                    
                        opmerking = CHstr(Reader2("boek_opmerking"))
                        customerOrganizationId = CHstr(Reader2("customerOrganizationId"))
                    End If
                    Reader2.Close()

                    query = "UPDATE floriday_salesorders_boek SET boek_opmerking=? WHERE orderLineId=?"  'clear opmerking
                    Cmd2.CommandText = query
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", "")
                    Cmd2.Parameters.AddWithValue("", orderlineid)
                    Cmd2.ExecuteNonQuery()

                    query = "SELECT * FROM floriday_organizations WHERE organizationId='" + customerOrganizationId + "'"
                    Cmd2.CommandText = query
                    Reader2 = Cmd2.ExecuteReader()
                    If Reader2.HasRows Then
                        kopernaam = CHstr(reader2("name"))
                    End If
                    Reader2.Close()

                    query = "INSERT INTO floriday_salesorders_opmerkingfilter(koper_uid,koper_naam,opmerking) VALUES (?,?,?)"   'create filter 
                    Cmd2.CommandText = query
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", customerOrganizationId)
                    Cmd2.Parameters.AddWithValue("", kopernaam)
                    Cmd2.Parameters.AddWithValue("", opmerking)
                    Cmd2.ExecuteNonQuery()

                    FloridayOrderLines_flx.Item(row, opmerkingcol) = ""


                End Using
            Catch ex As Exception
                MessageBox.Show("Database fout: (floridayorder wis opmerking)" + ex.Message, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        End If

    End Sub

    Public Sub SaveFloridayLabelData(flexgridrow As Integer, labelnummer As Integer, opmerking As String)
        'called in Form8 -> label generator
        Dim idcol As Integer = FindCol(FloridayOrderLines_flx, "stikkercode")
        FloridayOrderLines_flx.Item(flexgridrow, idcol) = labelnummer

        idcol = FindCol(FloridayOrderLines_flx, "opmerking")
        FloridayOrderLines_flx.Item(flexgridrow, idcol) = opmerking

        idcol = FindCol(FloridayOrderLines_flx, "orderLineId")
        Dim orderlineid As String = FloridayOrderLines_flx.Item(flexgridrow, idcol)
        Dim query As String = ""

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()
                Dim Cmd2 As New OdbcCommand(query, Conn)

                If FloridayOrderLines_flx.Rows(flexgridrow).IsNode Then
                    Dim lineidcol As Integer = FindCol(FloridayOrderLines_flx, "orderLineId")
                    Dim parentcol As Integer = FindCol(FloridayOrderLines_flx, "parentrow")
                    Dim parentid As Integer = FloridayOrderLines_flx.Item(flexgridrow, parentcol)
                    For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                        If FloridayOrderLines_flx.Item(i, parentcol) = parentid Then
                            Dim orderLineIdlp As String = FloridayOrderLines_flx.Item(i, lineidcol)

                            query = "UPDATE floriday_salesorders_boek SET boek_opmerking=?,boek_stikkercode=? WHERE orderLineId=?"
                            Cmd2.CommandText = query
                            Cmd2.Parameters.Clear()
                            Cmd2.Parameters.AddWithValue("", Mid(opmerking, 1, 79))
                            Cmd2.Parameters.AddWithValue("", labelnummer)
                            Cmd2.Parameters.AddWithValue("", orderLineIdlp)
                            Cmd2.ExecuteNonQuery()

                        End If
                    Next
                    Dim selectedrow As Integer = FloridayOrders_flx.RowSel
                    If selectedrow >= 1 Then
                        CheckOrderlines(True, selectedrow)
                    End If
                Else
                    'save orderlines
                    query = "UPDATE floriday_salesorders_boek SET boek_opmerking=?,boek_stikkercode=? WHERE orderLineId=?"
                    Cmd2.CommandText = query
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", Mid(opmerking, 1, 79))
                    Cmd2.Parameters.AddWithValue("", labelnummer)
                    Cmd2.Parameters.AddWithValue("", orderlineid)
                    Cmd2.ExecuteNonQuery()
                End If
            End Using
        Catch ex As Exception
            MessageBox.Show("Fout bij floriday stikkerinfo save " + ex.ToString, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
    End Sub

    Dim selectedwpsvalue As Integer = 0
    Private Sub FDLineCombo_Validated(sender As Object, e As EventArgs) Handles FDLineCombo.Validated
        Try
            selectedwpsvalue = FDLineCombo.SelectedValue
        Catch ex As Exception
        End Try
    End Sub

    Private Sub Floriday_orderlineherstellen_but_Click(sender As Object, e As EventArgs) Handles Floriday_orderlineherstellen_but.Click
        Dim query As String = ""

        Dim selectedrow As Integer = FloridayOrderLines_flx.RowSel
        If selectedrow >= 1 Then
            Try
                Using Conn As New OdbcConnection(ConnString)
                    Conn.Open()

                    Dim Cmd2 As New OdbcCommand(query, Conn)
                    Dim reader2 As OdbcDataReader

                    If FloridayOrderLines_flx.Rows(selectedrow).IsNode Then
                        Dim lineidcol As Integer = FindCol(FloridayOrderLines_flx, "orderLineId")
                        Dim parentcol As Integer = FindCol(FloridayOrderLines_flx, "parentrow")
                        Dim parentid As Integer = FloridayOrderLines_flx.Item(selectedrow, parentcol)
                        For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                            If FloridayOrderLines_flx.Item(i, parentcol) = parentid Then
                                Dim orderLineIdlp As String = FloridayOrderLines_flx.Item(i, lineidcol)

                                query = "UPDATE floriday_salesorders_boek SET boek_soortId=org_soortId,boek_hoesId=org_hoesId,boek_accessoire1=org_accessoire1," _
                               & "boek_accessoire2=org_accessoire2,boek_accessoire3=org_accessoire3,boek_accessoire4=org_accessoire4," _
                               & "boek_accessoire5=org_accessoire5,boek_accessoire6=org_accessoire6,boek_accessoire7=org_accessoire7," _
                               & "boek_accessoire8=org_accessoire8,boek_opmerking='',boek_wpsfilter=0,boek_fustid=org_fustId,boek_stikkercode=0,filterstoegepast=''" _
                               & " WHERE orderLineId=?"
                                Cmd2.CommandText = query
                                Cmd2.Parameters.Clear()
                                Cmd2.Parameters.AddWithValue("", orderLineIdlp)
                                Cmd2.ExecuteNonQuery()

                            End If
                        Next
                        selectedrow = FloridayOrders_flx.RowSel
                        If selectedrow >= 1 Then
                            CheckOrderlines(True, selectedrow)
                        End If
                    Else

                        'normale orderline

                        Dim idcol As Integer = FindCol(FloridayOrderLines_flx, "orderLineId")
                        Dim orderLineId As String = FloridayOrderLines_flx.Item(selectedrow, idcol)

                        query = "UPDATE floriday_salesorders_boek SET boek_soortId=org_soortId,boek_hoesId=org_hoesId,boek_accessoire1=org_accessoire1," _
                               & "boek_accessoire2=org_accessoire2,boek_accessoire3=org_accessoire3,boek_accessoire4=org_accessoire4," _
                               & "boek_accessoire5=org_accessoire5,boek_accessoire6=org_accessoire6,boek_accessoire7=org_accessoire7," _
                               & "boek_accessoire8=org_accessoire8,boek_opmerking='',boek_wpsfilter=0,boek_fustid=org_fustId,boek_stikkercode=0,filterstoegepast=''" _
                               & " WHERE orderLineId=?"
                        Cmd2.CommandText = query
                        Cmd2.Parameters.Clear()
                        Cmd2.Parameters.AddWithValue("", orderLineId)
                        Cmd2.ExecuteNonQuery()

                        query = "SELECT * FROM floriday_salesorders_boek WHERE orderLineId='" + orderLineId + "'"
                        Cmd2.CommandText = query
                        reader2 = Cmd2.ExecuteReader()
                        If reader2.HasRows Then
                            reader2.Read()
                            Dim soort_id As Integer = CHint(reader2("boek_soortId"))
                            Dim hoes_id As Integer = CHint(reader2("boek_hoesId"))
                            Dim accessoire1 As Integer = CHint(reader2("boek_accessoire1"))
                            Dim accessoire2 As Integer = CHint(reader2("boek_accessoire2"))
                            Dim accessoire3 As Integer = CHint(reader2("boek_accessoire3"))
                            Dim accessoire4 As Integer = CHint(reader2("boek_accessoire4"))
                            Dim accessoire5 As Integer = CHint(reader2("boek_accessoire5"))
                            Dim accessoire6 As Integer = CHint(reader2("boek_accessoire6"))
                            Dim accessoire7 As Integer = CHint(reader2("boek_accessoire7"))
                            Dim accessoire8 As Integer = CHint(reader2("boek_accessoire8"))
                            Dim fust_id As Integer = CHint(reader2("boek_fustid"))

                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "Soort")) = soort_id
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "hoes")) = hoes_id
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "fust")) = fust_id
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "accessoire1")) = accessoire1
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "accessoire2")) = accessoire2
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "accessoire4")) = accessoire4
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "accessoire5")) = accessoire5
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "accessoire6")) = accessoire6
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "accessoire7")) = accessoire7
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "accessoire8")) = accessoire8
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "opmerking")) = ""
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "wpsfilter")) = 0
                            FloridayOrderLines_flx.Item(selectedrow, FindCol(FloridayOrderLines_flx, "Verander filters")) = ""
                        End If
                        reader2.Close()
                    End If
                End Using
            Catch ex As Exception
                MessageBox.Show("Fout bij floriday orderline herstellen" + ex.ToString, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
            End Try
        Else
            MsgBox("Selecteer eerst een orderline")
        End If
    End Sub

    Private Sub Floriday_Filterstoepassen_but_Click(sender As Object, e As EventArgs) Handles Floriday_Filterstoepassen_but.Click

        FiltersToepassen()

    End Sub

    Public Sub FiltersToepassen()

        Dim idcol As Integer = FindCol(FloridayOrderLines_flx, "orderLineId")
        If FloridayOrderLines_flx.Rows.Count > 1 Then
            For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                If Not FloridayOrderLines_flx.Rows(i).IsNode Then
                    Dim orderLineId As String = FloridayOrderLines_flx.Item(i, idcol)
                    CheckFloridayFilter(orderLineId)
                End If
            Next i
            Dim selectedrow As Integer = FloridayOrders_flx.RowSel
            If selectedrow >= 1 Then
                CheckOrderlines(True, selectedrow)
            End If
        End If
    End Sub

    Private Function CheckFloridayFilter(orderlineId As String) As String
        'return toegepaste filternummers as string
        Dim filterstoegepast As String = ""

        Dim query As String = ""

        Try
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd2 As New OdbcCommand(query, Conn)
                Dim reader2 As OdbcDataReader

                Dim soort As Integer = 0
                Dim fust As Integer = 0
                Dim hoes As Integer = 0
                Dim accessoire1 As Integer = 0
                Dim accessoire2 As Integer = 0
                Dim accessoire3 As Integer = 0
                Dim accessoire4 As Integer = 0
                Dim accessoire5 As Integer = 0
                Dim accessoire6 As Integer = 0
                Dim accessoire7 As Integer = 0
                Dim accessoire8 As Integer = 0
                Dim opmerking As String = ""
                Dim tradeItemId As String = ""
                Dim customerOrganizationId As String = ""
                Dim agreementReference_code As String = ""
                'laden data
                query = "SELECT * FROM floriday_salesorders_boek WHERE orderLineId='" + orderlineId + "'"
                Cmd2.CommandText = query
                reader2 = Cmd2.ExecuteReader()
                If reader2.HasRows Then
                    reader2.Read()  'oude data ophalen
                    soort = CHint(reader2("boek_soortId"))
                    hoes = CHint(reader2("boek_hoesId"))
                    fust = CHint(reader2("boek_fustid"))
                    tradeItemId = CHstr(reader2("tradeItemId"))
                    accessoire1 = CHint(reader2("boek_accessoire1"))
                    accessoire2 = CHint(reader2("boek_accessoire2"))
                    accessoire3 = CHint(reader2("boek_accessoire3"))
                    accessoire4 = CHint(reader2("boek_accessoire4"))
                    accessoire5 = CHint(reader2("boek_accessoire5"))
                    accessoire6 = CHint(reader2("boek_accessoire6"))
                    accessoire7 = CHint(reader2("boek_accessoire7"))
                    accessoire8 = CHint(reader2("boek_accessoire8"))
                    opmerking = CHstr(reader2("boek_opmerking"))
                    customerOrganizationId = CHstr(reader2("customerOrganizationId"))
                    agreementReference_code = CHstr(reader2("agreementReference_code"))
                End If
                reader2.Close()

                'filters laden
                Dim save_changed_data As Boolean = False

                query = "SELECT * FROM floriday_salesorders_filters WHERE (customer_check=0) OR (customer_check=1 AND customerOrganizationId='" + customerOrganizationId + "')"
                Cmd2.CommandText = query
                reader2 = Cmd2.ExecuteReader()
                Do While reader2.Read

                    Dim filterid As Integer = CHint(reader2("id"))
                    Dim customer_check As Boolean = CHbool(reader2("customer_check"))
                    Dim fcustomerOrganizationId As String = CHstr(reader2("customerOrganizationId"))
                    Dim customerName As String = CHstr(reader2("customerName"))
                    Dim customerEAN As String = CHstr(reader2("customerEAN"))
                    Dim tradeItemCheck As Boolean = CHbool(reader2("tradeItemCheck"))
                    Dim tradeItemName As String = CHstr(reader2("tradeItemName"))
                    Dim ftradeItemId As String = CHstr(reader2("tradeItemId"))
                    Dim fopmerking As String = CHstr(reader2("opmerking"))
                    Dim soortCheck As Boolean = CHbool(reader2("soortCheck"))
                    Dim soortOrg As Integer = CHint(reader2("soortOrg"))
                    Dim soortNew As Integer = CHint(reader2("soortNew"))
                    Dim fustCheck As Boolean = CHbool(reader2("fustCheck"))
                    Dim fustOrg As Integer = CHint(reader2("fustOrg"))
                    Dim fustNew As Integer = CHint(reader2("fustNew"))
                    Dim hoesCheck As Boolean = CHbool(reader2("hoesCheck"))
                    Dim hoesOrg As Integer = CHint(reader2("hoesOrg"))
                    Dim hoesNew As Integer = CHint(reader2("hoesNew"))
                    Dim accessoire1Check As Boolean = CHbool(reader2("accessoire1Check"))
                    Dim accessoire1Org As Integer = CHint(reader2("accessoire1Org"))
                    Dim accessoire1New As Integer = CHint(reader2("accessoire1New"))
                    Dim accessoire2Check As Boolean = CHbool(reader2("accessoire2Check"))
                    Dim accessoire2Org As Integer = CHint(reader2("accessoire2Org"))
                    Dim accessoire2New As Integer = CHint(reader2("accessoire2New"))
                    Dim accessoire3Check As Boolean = CHbool(reader2("accessoire3Check"))
                    Dim accessoire3Org As Integer = CHint(reader2("accessoire3Org"))
                    Dim accessoire3New As Integer = CHint(reader2("accessoire3New"))
                    Dim accessoire4Check As Boolean = CHbool(reader2("accessoire4Check"))
                    Dim accessoire4Org As Integer = CHint(reader2("accessoire4Org"))
                    Dim accessoire4New As Integer = CHint(reader2("accessoire4New"))
                    Dim opmerkingCheck As Boolean = CHbool(reader2("opmerkingCheck"))
                    Dim AanbodRefCheck As Boolean = CHbool(reader2("AanbodRefCheck"))
                    Dim AanbodRef As String = CHstr(reader2("AanbodRef"))

                    If AanbodRefCheck = False Or (AanbodRefCheck = True And AanbodRef = agreementReference_code) Then

                        If (tradeItemCheck = False) Or (tradeItemCheck = True And tradeItemId = ftradeItemId) Then
                            Dim filterdone As Boolean = False
                            If soortCheck = True And soort = soortOrg Then
                                soort = soortNew
                                filterdone = True
                            End If
                            If fustCheck = True And fust = fustOrg Then
                                fust = fustNew
                                filterdone = True
                            End If
                            If hoesCheck = True And hoes = hoesOrg Then
                                hoes = hoesNew
                                filterdone = True
                            End If
                            If accessoire1Check = True Then
                                If accessoire1 = accessoire1Org Then
                                    filterdone = True
                                    accessoire1 = accessoire1New
                                ElseIf accessoire2 = accessoire1Org Then
                                    filterdone = True
                                    accessoire2 = accessoire1New
                                ElseIf accessoire3 = accessoire1Org Then
                                    filterdone = True
                                    accessoire3 = accessoire1New
                                ElseIf accessoire4 = accessoire1Org Then
                                    filterdone = True
                                    accessoire4 = accessoire1New
                                ElseIf accessoire5 = accessoire1Org Then
                                    filterdone = True
                                    accessoire5 = accessoire1New
                                ElseIf accessoire6 = accessoire1Org Then
                                    filterdone = True
                                    accessoire6 = accessoire1New
                                ElseIf accessoire7 = accessoire1Org Then
                                    filterdone = True
                                    accessoire7 = accessoire1New
                                ElseIf accessoire8 = accessoire1Org Then
                                    filterdone = True
                                    accessoire8 = accessoire1New
                                End If
                            End If
                            If accessoire2Check = True Then
                                If accessoire1 = accessoire2Org Then
                                    filterdone = True
                                    accessoire1 = accessoire2New
                                ElseIf accessoire2 = accessoire2Org Then
                                    filterdone = True
                                    accessoire2 = accessoire2New
                                ElseIf accessoire3 = accessoire2Org Then
                                    filterdone = True
                                    accessoire3 = accessoire2New
                                ElseIf accessoire4 = accessoire2Org Then
                                    filterdone = True
                                    accessoire4 = accessoire2New
                                ElseIf accessoire5 = accessoire2Org Then
                                    filterdone = True
                                    accessoire5 = accessoire2New
                                ElseIf accessoire6 = accessoire2Org Then
                                    filterdone = True
                                    accessoire6 = accessoire2New
                                ElseIf accessoire7 = accessoire2Org Then
                                    filterdone = True
                                    accessoire7 = accessoire2New
                                ElseIf accessoire8 = accessoire2Org Then
                                    filterdone = True
                                    accessoire8 = accessoire2New
                                End If
                            End If
                            If accessoire3Check = True Then
                                If accessoire1 = accessoire3Org Then
                                    filterdone = True
                                    accessoire1 = accessoire3New
                                ElseIf accessoire2 = accessoire3Org Then
                                    filterdone = True
                                    accessoire2 = accessoire3New
                                ElseIf accessoire3 = accessoire3Org Then
                                    filterdone = True
                                    accessoire3 = accessoire3New
                                ElseIf accessoire4 = accessoire3Org Then
                                    filterdone = True
                                    accessoire4 = accessoire3New
                                ElseIf accessoire5 = accessoire3Org Then
                                    filterdone = True
                                    accessoire5 = accessoire3New
                                ElseIf accessoire6 = accessoire3Org Then
                                    filterdone = True
                                    accessoire6 = accessoire3New
                                ElseIf accessoire7 = accessoire3Org Then
                                    filterdone = True
                                    accessoire7 = accessoire3New
                                ElseIf accessoire8 = accessoire3Org Then
                                    filterdone = True
                                    accessoire8 = accessoire3New
                                End If
                            End If
                            If accessoire4Check = True Then
                                If accessoire1 = accessoire4Org Then
                                    filterdone = True
                                    accessoire1 = accessoire4New
                                ElseIf accessoire2 = accessoire4Org Then
                                    filterdone = True
                                    accessoire2 = accessoire4New
                                ElseIf accessoire3 = accessoire4Org Then
                                    filterdone = True
                                    accessoire3 = accessoire4New
                                ElseIf accessoire4 = accessoire4Org Then
                                    filterdone = True
                                    accessoire4 = accessoire4New
                                ElseIf accessoire5 = accessoire4Org Then
                                    filterdone = True
                                    accessoire5 = accessoire4New
                                ElseIf accessoire6 = accessoire4Org Then
                                    filterdone = True
                                    accessoire6 = accessoire4New
                                ElseIf accessoire7 = accessoire4Org Then
                                    filterdone = True
                                    accessoire7 = accessoire4New
                                ElseIf accessoire8 = accessoire4Org Then
                                    filterdone = True
                                    accessoire8 = accessoire4New
                                End If
                            End If
                            If filterdone = True Then
                                filterstoegepast = filterstoegepast + Tstr(filterid) + " "
                                save_changed_data = True
                            End If
                        End If
                    End If
                Loop
                reader2.Close()

                If save_changed_data = True Then
                    query = "UPDATE floriday_salesorders_boek SET boek_soortId=?,boek_hoesId=?,boek_accessoire1=?," _
                            & "boek_accessoire2=?,boek_accessoire3=?,boek_accessoire4=?,boek_accessoire5=?,boek_accessoire6=?,boek_accessoire7=?," _
                            & "boek_accessoire8=?,boek_opmerking=?,boek_fustid=?,filterstoegepast=? WHERE orderLineId=?"
                    Cmd2.CommandText = query
                    Cmd2.Parameters.Clear()
                    Cmd2.Parameters.AddWithValue("", soort)
                    Cmd2.Parameters.AddWithValue("", hoes)
                    Cmd2.Parameters.AddWithValue("", accessoire1)
                    Cmd2.Parameters.AddWithValue("", accessoire2)
                    Cmd2.Parameters.AddWithValue("", accessoire3)
                    Cmd2.Parameters.AddWithValue("", accessoire4)
                    Cmd2.Parameters.AddWithValue("", accessoire5)
                    Cmd2.Parameters.AddWithValue("", accessoire6)
                    Cmd2.Parameters.AddWithValue("", accessoire7)
                    Cmd2.Parameters.AddWithValue("", accessoire8)
                    Cmd2.Parameters.AddWithValue("", Mid(opmerking, 1, 79))
                    Cmd2.Parameters.AddWithValue("", fust)
                    Cmd2.Parameters.AddWithValue("", Mid(filterstoegepast, 1, 99))
                    Cmd2.Parameters.AddWithValue("", orderlineId)
                    Cmd2.ExecuteNonQuery()
                End If

            End Using
        Catch ex As Exception
            MessageBox.Show("Fout bij floriday filters toepassen" + ex.ToString, "Fout", MessageBoxButtons.OK, MessageBoxIcon.Error, MessageBoxDefaultButton.Button1)
        End Try
        Return filterstoegepast

    End Function

    Private Sub Floriday_Cal_DateChanged(sender As Object, e As DateRangeEventArgs) Handles Floriday_Calendar.DateChanged
        FloridayOrderLines_flx.Rows.Count = 1
        FloridayOrdersShow()
    End Sub

    Private Sub fd_updatelist_but_Click(sender As Object, e As EventArgs) Handles fd_updatelist_but.Click
        FloridayOrderLines_flx.Rows.Count = 1
        FloridayOrdersShow()
        FdMenu_Verwerk_but.Enabled = True
    End Sub

    Private Sub FdMenu_Nietverwerken_but_Click(sender As Object, e As EventArgs) Handles FdMenu_Nietverwerken_but.Click

        Dim fd_orderLineIdCol As Integer = FindCol(FloridayOrderLines_flx, "orderlineid")
        Dim fd_selectieCol As Integer = FindCol(FloridayOrderLines_flx, "selectie")
        Dim fd_soortCol As Integer = FindCol(FloridayOrderLines_flx, "soort")

        Dim query As String = ""
        Try
            'Open Connection
            Using Conn As New OdbcConnection(ConnString)
                Conn.Open()

                Dim Cmd As New OdbcCommand("", Conn)
                Dim Cmd2 As New OdbcCommand("", Conn)
                Dim reader As OdbcDataReader
                'is de order nog steeds nieuw ? 


                For i = 2 To FloridayOrderLines_flx.Rows.Count - 1
                    If FloridayOrderLines_flx.Item(i, fd_selectieCol) = True Then
                        If FloridayOrderLines_flx.Rows(i).IsNode Then
                            'no check
                        Else
                            Dim orderLineId As String = FloridayOrderLines_flx.Item(i, fd_orderLineIdCol)

                            Cmd.CommandText = "select * from floriday_salesorders where  orderLineId='" + orderLineId + "'"
                            reader = Cmd.ExecuteReader()
                            If reader.HasRows Then
                                reader.Read()
                                Dim boekstatus As Integer = CHint(reader("boekstatus"))
                                Dim id As Integer = CHint(reader("id"))
                                If boekstatus = 0 Then

                                    Cmd2.CommandText = "UPDATE floriday_salesorders SET boekstatus=-1 WHERE id=?"
                                    Cmd2.Parameters.Clear()
                                    Cmd2.Parameters.AddWithValue("", id)
                                    Cmd2.ExecuteNonQuery()

                                End If
                            End If
                            reader.Close()

                        End If

                    End If
                Next

                FloridayOrderLines_flx.Rows.Count = 1
                FloridayOrdersShow()

            End Using
        Catch ex As Exception
            ErrorLog("Fout ordernietverwerken: " + ex.Message)
            MsgBox("Fout ordernietverwerken: " + ex.Message, MsgBoxStyle.OkOnly)
        End Try



    End Sub

    Private Sub FloridayOrderAanpassenToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles FloridayOrderAanpassenToolStripMenuItem.Click

        Dim header_id As Integer = -1
        Dim Nodes As TreeNodeCollection = TreeView1.Nodes
        Dim Node As TreeNode
        For Each Node In Nodes
            If Node.Checked = True And Mid(Node.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(Node.Tag, 4))
            End If

            If Node.Nodes.Count > 0 Then
                Dim node2 As TreeNode
                For Each node2 In Node.Nodes
                    If Mid(node2.Tag, 1, 3) = "ID:" And node2.Checked = True Then
                        header_id = Val(Mid(node2.Tag, 4))
                        Exit For
                    End If
                Next node2
            End If
        Next Node

        If header_id = -1 And Not TreeView1.SelectedNode Is Nothing Then
            If Mid(TreeView1.SelectedNode.Tag, 1, 3) = "ID:" Then
                header_id = Val(Mid(TreeView1.SelectedNode.Tag, 4))
            End If
        End If

        If header_id = -1 Then Exit Sub
        Floriday_OrderAanpassen(header_id, -1)
    End Sub

    Private Sub Floriday_OrderAanpassen(header_id As Integer, kar_id As Integer)

        Dim karrentabel As tablelayout() = BuildTable("floriday_aanpassen", Form16.karren_flx)

        Form16.Init(header_id, kar_id)
        Form16.StartPosition = FormStartPosition.CenterScreen
        Form16.Show()

    End Sub






#End Region


End Class


Class KarLineComparer
    Implements IComparer 'Implement the IComparer Interface 
    Overloads Function Compare(ByVal x As Object, ByVal y As Object) As Integer Implements IComparer.Compare
        Return CType(x, kar_line).sorteren - CType(y, kar_line).sorteren
        'If x.id is bigger than y.id then x.id-y.id will be positive. 
        'And if y.id is bigger, then x.id-y.id will be negative
        'And finally if they are equal then x.id-y.id will equal zero.
    End Function
End Class
Public Class DetectActivity

    Implements IDisposable
    Implements System.Windows.Forms.IMessageFilter


    Public Sub New()
        LastActivity = Date.Now
        System.Windows.Forms.Application.AddMessageFilter(Me)
    End Sub
    'Public Property LastActivity() As Date
    '    Get
    '        Return _lastActivity
    '    End Get
    'End Property
    Public Function PreFilterMessage(ByRef m As System.Windows.Forms.Message) As Boolean Implements System.Windows.Forms.IMessageFilter.PreFilterMessage
        Select Case m.Msg
            Case Win32Message.WM_KEYUP, Win32Message.WM_KEYDOWN
                LastActivity = Date.Now
            Case Win32Message.WM_LBUTTONDOWN, Win32Message.WM_LBUTTONUP, Win32Message.WM_MBUTTONDOWN, Win32Message.WM_MBUTTONUP, Win32Message.WM_RBUTTONDOWN, Win32Message.WM_RBUTTONUP, Win32Message.WM_MOUSEWHEEL
                LastActivity = Date.Now
        End Select

        Return False
    End Function
    Public Sub Dispose() Implements System.IDisposable.Dispose
        System.Windows.Forms.Application.RemoveMessageFilter(Me)
    End Sub
    Enum Win32Message
        WM_KEYFIRST = &H100
        WM_KEYDOWN = &H100
        WM_KEYUP = &H101
        WM_CHAR = &H102
        WM_DEADCHAR = &H103
        WM_SYSKEYDOWN = &H104
        WM_SYSKEYUP = &H105
        WM_SYSCHAR = &H106
        WM_SYSDEADCHAR = &H107

        WM_MOUSEFIRST = &H200
        WM_LBUTTONDOWN = &H201
        WM_LBUTTONUP = &H202
        WM_LBUTTONDBLCLK = &H203
        WM_RBUTTONDOWN = &H204
        WM_RBUTTONUP = &H205
        WM_RBUTTONDBLCLK = &H206
        WM_MBUTTONDOWN = &H207
        WM_MBUTTONUP = &H208
        WM_MBUTTONDBLCLK = &H209
        WM_MOUSEWHEEL = &H20A
    End Enum
End Class
Public Module GlobalVariables

    Friend BoekVersion As String = "Version 5.0.10"


    Friend postgress As Boolean = False
    Friend SQLRUN As Boolean = False                  ' SQL verbinding?
    Friend SQLRUN2 As Boolean = False
    Friend jenptenhave As Boolean = False  ' meer als 1 vestiging dan jenp = true 

    Friend TreeviewVestiging As Integer = 0  'default is totaal overzicht
    Friend LastActivity As Date
    'Friend vestigingcounter As Integer = 1
    'Friend vestigingnum As Integer = 1
    'Friend vestigingSaveFlorecom = False

    Friend overzichtdatum As Date = Now

    Friend header2_aanvulling As Integer = 0
    Friend barcode_tick_active As Boolean = False
    Friend staticyear As Boolean = True

    Friend overgooier As String = ""

    Friend labeledit As Boolean

    Friend klantlist(,) As klantdata
    Friend listcounter(50) As Integer
    Friend wpsgroepnamen(50) As String

    Friend kopers_mail_opmerking As String

    Friend kopertab(8) As TabPage

    Friend user_click As Boolean = True
    Friend user_date_change As Boolean = True


    Friend FC_CurrentEditOrder As Integer = -1
    Friend FC_CurrentEditLine As Integer = -1
    Friend FC_CheckRun As Boolean = False

    Friend MailHost As String = ""
    Friend MailRecipient As String = ""
    Friend ExternalMailHost As String = ""

    Friend lf As String = vbCrLf

    Friend wps_idlist(101) As Integer
    Friend wps_ordernr As Integer
    Friend wps_karnr As Integer
    Friend wps_ordercount As Integer
    Friend wps_karcount(100) As Integer

    Friend order_date As Date
    Friend karindeling_date As Date
    Friend wps_date As Date
    Friend sdf_date As Date
    Friend onze_ean = "8713782568027"

    'Friend onze_ean = "8713782597324"  'test electronisch bericht 

    Friend Max_Kar_Headers = 100
    Friend Max_Kar_Lines = 2000
    Friend KarHeaders(Max_Kar_Headers) As Kar_header
    Friend KarLines(Max_Kar_Lines) As kar_line

    Friend BoekSortering As Integer
    Friend BoekDisplayTijd As Integer
    Friend BoekStatus As Integer

    Friend Database_reload_counter As Integer
    Friend Boek_reload_counter As Integer

    Friend Activity_Timer As Long
    Friend Login_name As String = Nothing
    Friend ConnString As String = Nothing

    Friend order_koper_ean As String = Nothing
    Friend order_koper_naam As String = Nothing
    Friend order_aflevertijd As String = Nothing
    Friend order_afleverdatum As String = Nothing
    Friend order_veiling_id As Integer = Nothing
    Friend order_kar_id As Integer = Nothing
    Friend order_opmerking As String = Nothing
    Friend order_opslag As Integer = Nothing
    Friend order_vervoerder As Integer = Nothing
    Friend order_bdo As Integer = Nothing
    Friend order_invoer_datum As Date = Nothing
    Friend order_inlog_naam As String = Nothing
    Friend order_contact As String = Nothing
    Friend order_order_lines As String = Nothing
    Friend order_kar_lines As String = Nothing
    Friend order_status As Integer = Nothing
    Friend order_veilingnr_fh As Integer = Nothing
    Friend order_veilingnr_vba As Integer = Nothing
    Friend order_veilingnr_von As Integer = Nothing

    Friend aantalcol As Integer = 0   'orderinvoer kolomen
    Friend GPcol As Integer = 0
    Friend labelcol As Integer = 0
    Friend fustcol As Integer = 0
    Friend soortcol As Integer = 0
    Friend hoescol As Integer = 0
    Friend potmaatcol As Integer = 0
    Friend xcol As Integer = 0
    Friend acce1col As Integer = 0
    Friend acce2col As Integer = 0
    Friend acce4col As Integer = 0
    Friend acce5col As Integer = 0
    Friend acce6col As Integer = 0
    Friend acce7col As Integer = 0
    Friend acce8col As Integer = 0
    Friend schermencol As Integer = 0
    Friend vestigingcol As Integer = 0
    Friend aanbodcol As Integer = 0
    Friend prijscol As Integer = 0
    Friend rijpheidcol As Integer = 0
    Friend diametercol As Integer = 0
    Friend hoogtecol As Integer = 0
    Friend wpsfilter1col As Integer = 0
    Friend wpsfilter2col As Integer = 0
    Friend wpsfilter3col As Integer = 0
    Friend pluscol As Integer = 0
    Friend opmerkingcol As Integer = 0
    Friend kopercodecol As Integer = 0
    Friend keurcodecol As Integer = 0
    Friend transporthoogtecol As Integer = 0
    Friend florecomnrcol As Integer = 0
    Friend actiecol As Integer = 0
    Friend oldheadercol As Integer = 0
    Friend fotocol As Integer = 0
    Friend floridaynrcol As Integer = 0
    Friend orderinvoer_idcol As Integer = 0

    Friend kar() As Kar_Data
    Friend brief() As Brief_Data
    Friend veiling() As Veiling_Data
    Friend afleverloc() As Afleverloc_Data
    Friend vervoerder() As Vervoerder_data
    Friend soorten() As Soorten_data
    Friend accessoire() As Accessoire_data
    Friend mixen() As Mixen_data
    Friend kopersgroepen() As kopersgroep_data
    Friend prijzen() As Prijzen_data
    Friend fust() As Fust_Data
    Friend wpsfilter() As wps_filter
    Friend soortvolgorde() As soort_volgorde
    Friend soortgroep() As soortgroepnaam_data
    Friend fotofilters() As FotoFiltersStruct

    Friend dataelementen() As Data_elementen
    Friend sortelementen() As Sort_elementen

    Friend kopergroepEANs() As kopersgroepEAN_data
    Friend soortgroepids() As soortgroep_data
    Friend prijzendatumlijst() As prijzendatumlijst_data
    Friend vestiging() As Vestiging_data
    Friend fustcategorie() As fustcat_data
    Friend hoescategorie() As hoescat_data
    Friend fustcategorieids() As fustcatids_data
    Friend hoescategorieids() As hoescatids_data
    Friend kortingsgroepen() As kortingsgroep_data
    Friend prijslijst() As prijslijst_data
    Friend prijskoppelingen() As prijs_koppelingen

    Friend dt_rijpheid As New DataTable
    Friend dt_hoogte As New DataTable
    Friend dt_diameter As New DataTable
    Friend dt_schermen As New DataTable

    Friend dt_fust As New DataTable
    Friend dt_fusta As New DataTable
    Friend dt_brief As New DataTable
    Friend dt_afleverloc As New DataTable
    Friend dt_kar As New DataTable
    Friend dt_vervoerder As New DataTable
    Friend dt_soorten As New DataTable
    Friend dt_accessoire As New DataTable
    Friend dt_mixen As New DataTable
    Friend dt_mixbakken As New DataTable
    Friend dt_mixlagen As New DataTable
    Friend dt_kopersgroepen As New DataTable
    Friend dt_kopers As New DataTable
    Friend dt_soortmix As New DataTable
    Friend dt_soortmixprijzen As New DataTable
    Friend dt_soortmixlagen As New DataTable
    Friend dt_soortgroepen As New DataTable
    Friend dt_prijzen As New DataTable
    Friend dt_veilingen As New DataTable
    Friend dt_vestiging As New DataTable
    Friend dt_fustcategorie As New DataTable
    Friend dt_hoescategorie As New DataTable
    Friend dt_kwaliteit As New DataTable
    Friend dt_floridayveiling As New DataTable
    Friend dt_floridaywarehouses As New DataTable
    Friend dt_soortgroepveilgroep As New DataTable
    Friend dt_soortmixids As New DataTable
    Friend dt_tradeitem As New DataTable
    Friend dt_tradeitemklok As New DataTable

    Friend dtt_prijsactie As New DataTable
    Friend dtt_keurcode As New DataTable
    Friend dtt_fust As New DataTable
    Friend dtt_brief As New DataTable
    Friend dtt_afleverloc As New DataTable
    Friend dtt_kar As New DataTable
    Friend dtt_karvervoer As New DataTable
    Friend dtt_vervoerder As New DataTable
    Friend dtt_vervoerderloc As New DataTable
    Friend dtt_soorten As New DataTable
    Friend dtt_accessoire As New DataTable
    Friend dtt_mixen As New DataTable
    Friend dtt_kopers As New DataTable
    Friend dtt_kopersXA As New DataTable
    Friend dtt_soortmix As New DataTable
    Friend dtt_soortmixprijzen As New DataTable
    Friend dtt_prijzen As New DataTable
    Friend dtt_gp As New DataTable

    Friend dtt_fc_orderstatus As New DataTable
    Friend dtt_fc_linestatus As New DataTable

    Friend dt_empty As New DataTable
    Friend dt_db_tables As New DataTable
    Friend dt_favorieten_naam As New DataTable
    Friend dt_labelstatus As New DataTable

    Structure FotoFiltersStruct
        Dim tradeItemId As Integer
        Dim rijpheid As Integer
        Dim diameter As Integer
        Dim hoogte As Integer
        Dim schermen As Integer
        Dim fust As Integer
        Dim keurcode As Integer
        Dim fotopath As String
        Dim hoes As Integer
    End Structure

    Structure wps_filter
        Dim filternummer As Integer
        Dim filternaam As String
        Dim wps_soortnummer As Integer
        Dim potmaat As Integer
    End Structure
    Structure klantdata
        Dim ean As String
        Dim naam As String
        Dim checked As Boolean
    End Structure
    Structure Kar_Data
        Dim id As Integer
        Dim karnaam As String
        Dim aantal_lagen As Integer
        Dim fust_per_laag_code As Integer
        Dim vervoer As String
        Dim actief As Boolean
    End Structure
    Structure Fust_Data
        Dim id As Integer
        Dim fustnaam As String
        Dim fustcode As String
        Dim plaats_string As String
        Dim decorum As Boolean
        Dim aantal_per_fust As Integer
        Dim fustcode_florecom As Integer
        Dim fustcode_wps As Integer
        Dim fustcode_sdf As Integer
        Dim fpl_deen As Integer
        Dim fpl_veilingkar As Integer
        Dim fpl_overig As Integer
        Dim fpl_reserve1 As Integer
        Dim fpl_reserve2 As Integer
        Dim actief As Boolean
        Dim kleur As String
    End Structure
    Structure Brief_Data
        Dim id As Integer
        Dim naam As String
        Dim actief As Boolean
    End Structure
    Structure Veiling_Data
        Dim id As Integer
        Dim naam As String
    End Structure
    Structure Afleverloc_Data
        Dim id As Integer
        Dim naam As String
        Dim ean As String
        Dim actief As Boolean
        Dim vervoer As String
    End Structure
    Structure Vervoerder_data
        Dim id As Integer
        Dim vervoerder_naam As String
        Dim EAN As String
        Dim actief As Boolean
        Dim email As String

    End Structure
    Enum enumObjectType
        StrType = 0
        IntType = 1
        DblType = 2
    End Enum
    Structure Soorten_data
        Dim id As Integer
        Dim soortnaam As String
        Dim vbn_code As Integer
        Dim sdf_code As String
        Dim wps_code As String
        Dim interne_code As String
        Dim actief As Boolean
        Dim potmaat As Double
        Dim klokrijpheid As Integer
        Dim klokdiameter As Integer
        Dim klokhoogte As Integer
        Dim bbrijpheid As Integer
        Dim bbhoogte As Integer
        Dim bbdiameter As Integer
        Dim transporthoogte As Integer
        Dim vastefustcode As Integer
        Dim labelnaam As String
        Dim vestiging As Integer
        Dim logiqs_code As String
        Dim tradeitemklok As Integer
    End Structure
    Structure Prijzen_data
        Dim id As Integer
        Dim naam As String
        Dim soort As String
        Dim accessoire As Boolean
        Dim algemeen As Boolean
        Dim klant As String
        Dim klantgroep As Integer
        Dim actie_type As Integer
        Dim actief As Boolean
        Dim actienummer As String
    End Structure
    Structure soort_volgorde
        Dim soortid As Integer
        Dim volgorde As Integer
    End Structure
    Structure Accessoire_data
        Dim id As Integer
        Dim naam As String
        Dim code As String
        Dim prijslijst As Integer
        Dim actief As Boolean
        Dim fust As Integer
        Dim potmaat As Integer
        Dim sdf_code As Integer
        Dim decorum As Boolean
        Dim keten_ean As String
        Dim hoes As Integer
        Dim bakstikker As Boolean
    End Structure
    Structure Mixen_data
        Dim id As Integer
        Dim naam As String
        Dim fust As String
        Dim koperean As String
        Dim kopergroep As Integer
        Dim actief As Boolean
        Dim diameter As Integer
        Dim hoogte As Integer
        Dim rijpheid As Integer
        Dim transporthoogte As Integer
        Dim potmaat As Double
        Dim vbn_code As Integer
        Dim sdf_code As Integer
        Dim interne_code As String
        Dim labelnaam As String
        Dim mixlagen As Boolean
        Dim accessoire As Integer
        Dim vestiging As Integer
        Dim sdf_artcode As String
        Dim tradeitemklok As Integer
    End Structure
    Structure Mixen_vulling
        Dim mix_id As Integer
        Dim plaats As Integer
        Dim soort As Integer
        Dim accessoire1 As Integer
        Dim accessoire2 As Integer
        Dim accessoire3 As Integer
        Dim accessoire4 As Integer
        Dim accessoire5 As Integer
        Dim accessoire6 As Integer
    End Structure
    Structure kopersgroep_data
        Dim id As Integer
        Dim groepnaam As String
        Dim eans As String
    End Structure
    Structure order_header_data
        Dim datum As Date
        Dim tijd As String
        Dim koper_ean As String
        Dim koper_naam As String
        Dim afleverloc As Integer
        Dim brief As Integer
        Dim kar As Integer
        Dim vervoerder As Integer
        Dim prijs_opslag As Double
        Dim opmerking As String
    End Structure
    Structure order_line_data
        Dim aantal As Integer
        Dim soort As Integer
        Dim prijs As Double
        Dim fust As Integer
        Dim gp As Integer
        Dim rijpheid As Integer
        Dim hoogte As Integer
        Dim diameter As Integer
        Dim accessoire1 As Integer
        Dim accessoire2 As Integer
        Dim accessoire3 As Integer
        Dim accessoire4 As Integer
        Dim accessoire5 As Integer
        Dim kopercode As Integer
        Dim opmerking As Integer
        Dim potmaat As Integer
        Dim wpsfilter As Integer
        Dim transporthoogte As Integer
        Dim vestiging As Integer
    End Structure
    Structure Kar_header
        Dim tag As Boolean
        Dim kar_id As Integer
        Dim header_id As Integer
        Dim kar_type As Integer
        Dim aantal_lagen As Integer
        Dim aantal_lagenlock As Boolean
        Dim sdf_flag As Boolean
        Dim wps_status As Integer
        Dim vervoer_flag As Boolean
        Dim barcode As String
        Dim cc_rfid As String
        Dim kar_nummer As Integer
        Dim scan_flag As Boolean
        Dim overgooien_naar As String
        Dim overgooien_hierop As String
        Dim floriday_printflag As Integer
    End Structure
    Structure kar_line
        Dim tag As Boolean
        Dim kar_id As Integer
        Dim aantal As Integer
        Dim Orderline_id As Integer
        Dim wps_flag As Boolean
        Dim header_id As Integer
        Dim kar_nummerref As Integer
        Dim fustlist_id As Integer
        Dim accessoirelist_id As Integer
        Dim soortnaam As String
        Dim soort_id As Integer
        Dim sorteren As Integer
        Dim gp As Integer
        Dim opmerking As String
        Dim wps17_flag As Boolean
        Dim sdfbarcode2 As Integer
        Dim line_id As Integer
    End Structure
    Structure NAD
        Dim id As Integer
        Dim NAD_PartyEAN As String
        Dim CTA1_EAN As String
        Dim CTA1_NAME As String
        Dim COM1_TE As String
        Dim COM1_FX As String
        Dim CTA2_EAN As String
        Dim CTA2_NAME As String
        Dim COM2_TE As String
        Dim COM2_FX As String
        Dim AGENCY_CODE As Integer
    End Structure
    Structure Data_elementen
        Dim code As String
        Dim value As String
        Dim description As String
    End Structure
    Structure Sort_elementen
        Dim code As String
        Dim value As String
        Dim description As String
    End Structure
    Structure kopersgroepEAN_data
        Dim id As Integer
        Dim ean As String
    End Structure
    Structure soortgroep_data
        Dim id As Integer
        Dim soortmixid As Integer
    End Structure
    Structure fustcatids_data
        Dim fustcatid As Integer
        Dim soortgroepid As Integer
        Dim fustid As Integer
    End Structure
    Structure hoescatids_data
        Dim hoescatid As Integer
        Dim soortgroepid As Integer
        Dim accessoireid As Integer
    End Structure
    Structure prijzendatumlijst_data
        Dim id As Integer
        Dim datum As Date
        Dim prijs As Double
    End Structure
    Structure Vestiging_data
        Dim id As Integer
        Dim naam As String
        Dim adres As String
    End Structure
    Structure fustcat_data
        Dim id As Integer
        Dim naam As String
    End Structure
    Structure hoescat_data
        Dim id As Integer
        Dim naam As String
    End Structure
    Structure soortgroepnaam_data
        Dim id As Integer
        Dim naam As String
        Dim prijzen As Boolean
        Dim fusten As Boolean
        Dim hoezen As Boolean
    End Structure
    Structure kortingsgroep_data
        Dim kopergroep As Integer
        Dim korting As Integer
    End Structure
    Structure prijslijst_data
        Dim kwekerscode As String
        Dim soort As Integer
        Dim accessoire1 As Integer
        Dim accessoire2 As Integer
        Dim fust As Integer
        Dim hoes As Integer
        Dim prijs As Integer
        Dim korting As Integer
        Dim kopersgroep As Integer
        Dim omschrijving As String
    End Structure

    Structure tablelayout
        Dim id As Integer
        Dim label As String
        Dim columnname As String
        Dim type As String
        Dim sort As Integer
        Dim columnwidth As Integer
        Dim edit As Boolean
        Dim visible As Boolean
        Dim datatable As String
        Dim defaultvalue As String
        Dim order As Integer
        Dim leftjoin As String
        Dim info As Boolean
        Dim maxcharlength As Integer

    End Structure

    Structure userlayout
        Dim id As Integer
        Dim user_id As Integer
        Dim build_id As Integer
        Dim sort As Integer
        Dim columnwidth As Integer
        Dim visible As Integer
        Dim edit As Integer
    End Structure

    Structure prijs_koppelingen
        Dim soort_id
        Dim koppel_id
    End Structure
End Module
Public Module Sharedfunctions
    Public Function CHstr(ByVal obj As Object) As String
        Dim objReturn As String = ""
        If IsDBNull(obj) Then
            objReturn = ""
        Else
            objReturn = CType(obj, String)
        End If
        Return Trim(objReturn)
    End Function
    Public Function CHint(ByVal obj As Object) As Integer
        Dim objReturn As Integer = 0
        If IsDBNull(obj) Then
            objReturn = 0
        Else
            objReturn = CType(obj, Integer)
        End If
        Return objReturn
    End Function
    Public Function CHdouble(ByVal obj As Object) As Double
        Dim objReturn As Double = 0
        If IsDBNull(obj) Then
            objReturn = 0.0
        Else
            objReturn = CType(obj, Double)
        End If
        Return objReturn
    End Function
    Public Function CHbool(ByVal obj As Object) As Boolean
        Dim objReturn As Boolean = False
        If IsDBNull(obj) Then
            objReturn = False
        Else
            objReturn = CType(obj, Boolean)
        End If
        Return objReturn
    End Function

    Public Function CHDate2(ByVal obj As Object, ByVal datedefault As DateTime) As DateTime
        Dim objReturn As DateTime
        If IsDBNull(obj) Then
            objReturn = datedefault
        Else
            objReturn = CType(obj, DateTime)
        End If
        Return objReturn
    End Function

End Module